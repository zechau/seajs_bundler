;/*! Sea.js 2.3.0 | seajs.org/LICENSE.md */
!function(a,b){function c(a){return function(b){return{}.toString.call(b)=="[object "+a+"]"}}function d(){return z++}function e(a){return a.match(C)[0]}function f(a){for(a=a.replace(D,"/"),a=a.replace(F,"$1/");a.match(E);)a=a.replace(E,"/");return a}function g(a){var b=a.length-1,c=a.charAt(b);return"#"===c?a.substring(0,b):".js"===a.substring(b-2)||a.indexOf("?")>0||"/"===c?a:a+".js"}function h(a){var b=u.alias;return b&&w(b[a])?b[a]:a}function i(a){var b=u.paths,c;return b&&(c=a.match(G))&&w(b[c[1]])&&(a=b[c[1]]+c[2]),a}function j(a){var b=u.vars;return b&&a.indexOf("{")>-1&&(a=a.replace(H,function(a,c){return w(b[c])?b[c]:a})),a}function k(a){var b=u.map,c=a;if(b)for(var d=0,e=b.length;e>d;d++){var f=b[d];if(c=y(f)?f(a)||a:a.replace(f[0],f[1]),c!==a)break}return c}function l(a,b){var c,d=a.charAt(0);if(I.test(a))c=a;else if("."===d)c=f((b?e(b):u.cwd)+a);else if("/"===d){var g=u.cwd.match(J);c=g?g[0]+a.substring(1):a}else c=u.base+a;return 0===c.indexOf("//")&&(c=location.protocol+c),c}function m(a,b){if(!a)return"";a=h(a),a=i(a),a=j(a),a=g(a);var c=l(a,b);return c=k(c)}function n(a){return a.hasAttribute?a.src:a.getAttribute("src",4)}function o(a,b,c){var d=K.createElement("script");if(c){var e=y(c)?c(a):c;e&&(d.charset=e)}p(d,b,a),d.async=!0,d.src=a,R=d,Q?P.insertBefore(d,Q):P.appendChild(d),R=null}function p(a,b,c){function d(){a.onload=a.onerror=a.onreadystatechange=null,u.debug||P.removeChild(a),a=null,b()}var e="onload"in a;e?(a.onload=d,a.onerror=function(){B("error",{uri:c,node:a}),d()}):a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&d()}}function q(){if(R)return R;if(S&&"interactive"===S.readyState)return S;for(var a=P.getElementsByTagName("script"),b=a.length-1;b>=0;b--){var c=a[b];if("interactive"===c.readyState)return S=c}}function r(a){var b=[];return a.replace(U,"").replace(T,function(a,c,d){d&&b.push(d)}),b}function s(a,b){this.uri=a,this.dependencies=b||[],this.exports=null,this.status=0,this._waitings={},this._remain=0}if(!a.seajs){var t=a.seajs={version:"2.3.0"},u=t.data={},v=c("Object"),w=c("String"),x=Array.isArray||c("Array"),y=c("Function"),z=0,A=u.events={};t.on=function(a,b){var c=A[a]||(A[a]=[]);return c.push(b),t},t.off=function(a,b){if(!a&&!b)return A=u.events={},t;var c=A[a];if(c)if(b)for(var d=c.length-1;d>=0;d--)c[d]===b&&c.splice(d,1);else delete A[a];return t};var B=t.emit=function(a,b){var c=A[a],d;if(c){c=c.slice();for(var e=0,f=c.length;f>e;e++)c[e](b)}return t},C=/[^?#]*\//,D=/\/\.\//g,E=/\/[^/]+\/\.\.\//,F=/([^:/])\/+\//g,G=/^([^/:]+)(\/.+)$/,H=/{([^{]+)}/g,I=/^\/\/.|:\//,J=/^.*?\/\/.*?\//,K=document,L=location.href&&0!==location.href.indexOf("about:")?e(location.href):"",M=K.scripts,N=K.getElementById("seajsnode")||M[M.length-1],O=e(n(N)||L);t.resolve=m;var P=K.head||K.getElementsByTagName("head")[0]||K.documentElement,Q=P.getElementsByTagName("base")[0],R,S;t.request=o;var T=/"(?:\\"|[^"])*"|'(?:\\'|[^'])*'|\/\*[\S\s]*?\*\/|\/(?:\\\/|[^\/\r\n])+\/(?=[^\/])|\/\/.*|\.\s*require|(?:^|[^$])\brequire\s*\(\s*(["'])(.+?)\1\s*\)/g,U=/\\\\/g,V=t.cache={},W,X={},Y={},Z={},$=s.STATUS={FETCHING:1,SAVED:2,LOADING:3,LOADED:4,EXECUTING:5,EXECUTED:6};s.prototype.resolve=function(){for(var a=this,b=a.dependencies,c=[],d=0,e=b.length;e>d;d++)c[d]=s.resolve(b[d],a.uri);return c},s.prototype.load=function(){var a=this;if(!(a.status>=$.LOADING)){a.status=$.LOADING;var c=a.resolve();B("load",c);for(var d=a._remain=c.length,e,f=0;d>f;f++)e=s.get(c[f]),e.status<$.LOADED?e._waitings[a.uri]=(e._waitings[a.uri]||0)+1:a._remain--;if(0===a._remain)return a.onload(),b;var g={};for(f=0;d>f;f++)e=V[c[f]],e.status<$.FETCHING?e.fetch(g):e.status===$.SAVED&&e.load();for(var h in g)g.hasOwnProperty(h)&&g[h]()}},s.prototype.onload=function(){var a=this;a.status=$.LOADED,a.callback&&a.callback();var b=a._waitings,c,d;for(c in b)b.hasOwnProperty(c)&&(d=V[c],d._remain-=b[c],0===d._remain&&d.onload());delete a._waitings,delete a._remain},s.prototype.fetch=function(a){function c(){t.request(g.requestUri,g.onRequest,g.charset)}function d(){delete X[h],Y[h]=!0,W&&(s.save(f,W),W=null);var a,b=Z[h];for(delete Z[h];a=b.shift();)a.load()}var e=this,f=e.uri;e.status=$.FETCHING;var g={uri:f};B("fetch",g);var h=g.requestUri||f;return!h||Y[h]?(e.load(),b):X[h]?(Z[h].push(e),b):(X[h]=!0,Z[h]=[e],B("request",g={uri:f,requestUri:h,onRequest:d,charset:u.charset}),g.requested||(a?a[g.requestUri]=c:c()),b)},s.prototype.exec=function(){function a(b){return s.get(a.resolve(b)).exec()}var c=this;if(c.status>=$.EXECUTING)return c.exports;c.status=$.EXECUTING;var e=c.uri;a.resolve=function(a){return s.resolve(a,e)},a.async=function(b,c){return s.use(b,c,e+"_async_"+d()),a};var f=c.factory,g=y(f)?f(a,c.exports={},c):f;return g===b&&(g=c.exports),delete c.factory,c.exports=g,c.status=$.EXECUTED,B("exec",c),g},s.resolve=function(a,b){var c={id:a,refUri:b};return B("resolve",c),c.uri||t.resolve(c.id,b)},s.define=function(a,c,d){var e=arguments.length;1===e?(d=a,a=b):2===e&&(d=c,x(a)?(c=a,a=b):c=b),!x(c)&&y(d)&&(c=r(""+d));var f={id:a,uri:s.resolve(a),deps:c,factory:d};if(!f.uri&&K.attachEvent){var g=q();g&&(f.uri=g.src)}B("define",f),f.uri?s.save(f.uri,f):W=f},s.save=function(a,b){var c=s.get(a);c.status<$.SAVED&&(c.id=b.id||a,c.dependencies=b.deps||[],c.factory=b.factory,c.status=$.SAVED,B("save",c))},s.get=function(a,b){return V[a]||(V[a]=new s(a,b))},s.use=function(b,c,d){var e=s.get(d,x(b)?b:[b]);e.callback=function(){for(var b=[],d=e.resolve(),f=0,g=d.length;g>f;f++)b[f]=V[d[f]].exec();c&&c.apply(a,b),delete e.callback},e.load()},t.use=function(a,b){return s.use(a,b,u.cwd+"_use_"+d()),t},s.define.cmd={},a.define=s.define,t.Module=s,u.fetchedList=Y,u.cid=d,t.require=function(a){var b=s.get(s.resolve(a));return b.status<$.EXECUTING&&(b.onload(),b.exec()),b.exports},u.base=O,u.dir=O,u.cwd=L,u.charset="utf-8",t.config=function(a){for(var b in a){var c=a[b],d=u[b];if(d&&v(d))for(var e in c)d[e]=c[e];else x(d)?c=d.concat(c):"base"===b&&("/"!==c.slice(-1)&&(c+="/"),c=l(c)),u[b]=c}return B("config",a),t}}}(this);
;/*! jQuery v2.1.0 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k="".trim,l={},m=a.document,n="2.1.0",o=function(a,b){return new o.fn.init(a,b)},p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};o.fn=o.prototype={jquery:n,constructor:o,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=o.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return o.each(this,a,b)},map:function(a){return this.pushStack(o.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},o.extend=o.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||o.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(o.isPlainObject(d)||(e=o.isArray(d)))?(e?(e=!1,f=c&&o.isArray(c)?c:[]):f=c&&o.isPlainObject(c)?c:{},g[b]=o.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},o.extend({expando:"jQuery"+(n+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===o.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return a-parseFloat(a)>=0},isPlainObject:function(a){if("object"!==o.type(a)||a.nodeType||o.isWindow(a))return!1;try{if(a.constructor&&!j.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}return!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=o.trim(a),a&&(1===a.indexOf("use strict")?(b=m.createElement("script"),b.text=a,m.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:function(a){return null==a?"":k.call(a)},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?o.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:g.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(c=a[b],b=a,a=c),o.isFunction(a)?(e=d.call(arguments,2),f=function(){return a.apply(b||this,e.concat(d.call(arguments)))},f.guid=a.guid=a.guid||o.guid++,f):void 0},now:Date.now,support:l}),o.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=o.type(a);return"function"===c||o.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="sizzle"+-new Date,t=a.document,u=0,v=0,w=eb(),x=eb(),y=eb(),z=function(a,b){return a===b&&(j=!0),0},A="undefined",B=1<<31,C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=D.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},J="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",K="[\\x20\\t\\r\\n\\f]",L="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",M=L.replace("w","w#"),N="\\["+K+"*("+L+")"+K+"*(?:([*^$|!~]?=)"+K+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+M+")|)|)"+K+"*\\]",O=":("+L+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+N.replace(3,8)+")*)|.*)\\)|)",P=new RegExp("^"+K+"+|((?:^|[^\\\\])(?:\\\\.)*)"+K+"+$","g"),Q=new RegExp("^"+K+"*,"+K+"*"),R=new RegExp("^"+K+"*([>+~]|"+K+")"+K+"*"),S=new RegExp("="+K+"*([^\\]'\"]*?)"+K+"*\\]","g"),T=new RegExp(O),U=new RegExp("^"+M+"$"),V={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L.replace("w","w*")+")"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+K+"*(even|odd|(([+-]|)(\\d*)n|)"+K+"*(?:([+-]|)"+K+"*(\\d+)|))"+K+"*\\)|)","i"),bool:new RegExp("^(?:"+J+")$","i"),needsContext:new RegExp("^"+K+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+K+"*((?:-\\d)?\\d*)"+K+"*\\)|)(?=[^-]|$)","i")},W=/^(?:input|select|textarea|button)$/i,X=/^h\d$/i,Y=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,$=/[+~]/,_=/'|\\/g,ab=new RegExp("\\\\([\\da-f]{1,6}"+K+"?|("+K+")|.)","ig"),bb=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{G.apply(D=H.call(t.childNodes),t.childNodes),D[t.childNodes.length].nodeType}catch(cb){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function db(a,b,d,e){var f,g,h,i,j,m,p,q,u,v;if((b?b.ownerDocument||b:t)!==l&&k(b),b=b||l,d=d||[],!a||"string"!=typeof a)return d;if(1!==(i=b.nodeType)&&9!==i)return[];if(n&&!e){if(f=Z.exec(a))if(h=f[1]){if(9===i){if(g=b.getElementById(h),!g||!g.parentNode)return d;if(g.id===h)return d.push(g),d}else if(b.ownerDocument&&(g=b.ownerDocument.getElementById(h))&&r(b,g)&&g.id===h)return d.push(g),d}else{if(f[2])return G.apply(d,b.getElementsByTagName(a)),d;if((h=f[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(h)),d}if(c.qsa&&(!o||!o.test(a))){if(q=p=s,u=b,v=9===i&&a,1===i&&"object"!==b.nodeName.toLowerCase()){m=ob(a),(p=b.getAttribute("id"))?q=p.replace(_,"\\$&"):b.setAttribute("id",q),q="[id='"+q+"'] ",j=m.length;while(j--)m[j]=q+pb(m[j]);u=$.test(a)&&mb(b.parentNode)||b,v=m.join(",")}if(v)try{return G.apply(d,u.querySelectorAll(v)),d}catch(w){}finally{p||b.removeAttribute("id")}}}return xb(a.replace(P,"$1"),b,d,e)}function eb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function fb(a){return a[s]=!0,a}function gb(a){var b=l.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function hb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function ib(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||B)-(~a.sourceIndex||B);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function jb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function kb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function lb(a){return fb(function(b){return b=+b,fb(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function mb(a){return a&&typeof a.getElementsByTagName!==A&&a}c=db.support={},f=db.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},k=db.setDocument=function(a){var b,e=a?a.ownerDocument||a:t,g=e.defaultView;return e!==l&&9===e.nodeType&&e.documentElement?(l=e,m=e.documentElement,n=!f(e),g&&g!==g.top&&(g.addEventListener?g.addEventListener("unload",function(){k()},!1):g.attachEvent&&g.attachEvent("onunload",function(){k()})),c.attributes=gb(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=gb(function(a){return a.appendChild(e.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Y.test(e.getElementsByClassName)&&gb(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),c.getById=gb(function(a){return m.appendChild(a).id=s,!e.getElementsByName||!e.getElementsByName(s).length}),c.getById?(d.find.ID=function(a,b){if(typeof b.getElementById!==A&&n){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){var c=typeof a.getAttributeNode!==A&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==A?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==A&&n?b.getElementsByClassName(a):void 0},p=[],o=[],(c.qsa=Y.test(e.querySelectorAll))&&(gb(function(a){a.innerHTML="<select t=''><option selected=''></option></select>",a.querySelectorAll("[t^='']").length&&o.push("[*^$]="+K+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||o.push("\\["+K+"*(?:value|"+J+")"),a.querySelectorAll(":checked").length||o.push(":checked")}),gb(function(a){var b=e.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&o.push("name"+K+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||o.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),o.push(",.*:")})),(c.matchesSelector=Y.test(q=m.webkitMatchesSelector||m.mozMatchesSelector||m.oMatchesSelector||m.msMatchesSelector))&&gb(function(a){c.disconnectedMatch=q.call(a,"div"),q.call(a,"[s!='']:x"),p.push("!=",O)}),o=o.length&&new RegExp(o.join("|")),p=p.length&&new RegExp(p.join("|")),b=Y.test(m.compareDocumentPosition),r=b||Y.test(m.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},z=b?function(a,b){if(a===b)return j=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===e||a.ownerDocument===t&&r(t,a)?-1:b===e||b.ownerDocument===t&&r(t,b)?1:i?I.call(i,a)-I.call(i,b):0:4&d?-1:1)}:function(a,b){if(a===b)return j=!0,0;var c,d=0,f=a.parentNode,g=b.parentNode,h=[a],k=[b];if(!f||!g)return a===e?-1:b===e?1:f?-1:g?1:i?I.call(i,a)-I.call(i,b):0;if(f===g)return ib(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)k.unshift(c);while(h[d]===k[d])d++;return d?ib(h[d],k[d]):h[d]===t?-1:k[d]===t?1:0},e):l},db.matches=function(a,b){return db(a,null,null,b)},db.matchesSelector=function(a,b){if((a.ownerDocument||a)!==l&&k(a),b=b.replace(S,"='$1']"),!(!c.matchesSelector||!n||p&&p.test(b)||o&&o.test(b)))try{var d=q.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return db(b,l,null,[a]).length>0},db.contains=function(a,b){return(a.ownerDocument||a)!==l&&k(a),r(a,b)},db.attr=function(a,b){(a.ownerDocument||a)!==l&&k(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!n):void 0;return void 0!==f?f:c.attributes||!n?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},db.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},db.uniqueSort=function(a){var b,d=[],e=0,f=0;if(j=!c.detectDuplicates,i=!c.sortStable&&a.slice(0),a.sort(z),j){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return i=null,a},e=db.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=db.selectors={cacheLength:50,createPseudo:fb,match:V,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ab,bb),a[3]=(a[4]||a[5]||"").replace(ab,bb),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||db.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&db.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return V.CHILD.test(a[0])?null:(a[3]&&void 0!==a[4]?a[2]=a[4]:c&&T.test(c)&&(b=ob(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ab,bb).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=w[a+" "];return b||(b=new RegExp("(^|"+K+")"+a+"("+K+"|$)"))&&w(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==A&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=db.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),t=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&t){k=q[s]||(q[s]={}),j=k[a]||[],n=j[0]===u&&j[1],m=j[0]===u&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[u,n,m];break}}else if(t&&(j=(b[s]||(b[s]={}))[a])&&j[0]===u)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(t&&((l[s]||(l[s]={}))[a]=[u,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||db.error("unsupported pseudo: "+a);return e[s]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?fb(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I.call(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:fb(function(a){var b=[],c=[],d=g(a.replace(P,"$1"));return d[s]?fb(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),!c.pop()}}),has:fb(function(a){return function(b){return db(a,b).length>0}}),contains:fb(function(a){return function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:fb(function(a){return U.test(a||"")||db.error("unsupported lang: "+a),a=a.replace(ab,bb).toLowerCase(),function(b){var c;do if(c=n?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===m},focus:function(a){return a===l.activeElement&&(!l.hasFocus||l.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:lb(function(){return[0]}),last:lb(function(a,b){return[b-1]}),eq:lb(function(a,b,c){return[0>c?c+b:c]}),even:lb(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:lb(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:lb(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:lb(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=jb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=kb(b);function nb(){}nb.prototype=d.filters=d.pseudos,d.setFilters=new nb;function ob(a,b){var c,e,f,g,h,i,j,k=x[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=Q.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P," ")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?db.error(a):x(a,i).slice(0)}function pb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function qb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=v++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[u,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[s]||(b[s]={}),(h=i[d])&&h[0]===u&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function rb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function sb(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function tb(a,b,c,d,e,f){return d&&!d[s]&&(d=tb(d)),e&&!e[s]&&(e=tb(e,f)),fb(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||wb(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:sb(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=sb(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I.call(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=sb(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ub(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],i=g||d.relative[" "],j=g?1:0,k=qb(function(a){return a===b},i,!0),l=qb(function(a){return I.call(b,a)>-1},i,!0),m=[function(a,c,d){return!g&&(d||c!==h)||((b=c).nodeType?k(a,c,d):l(a,c,d))}];f>j;j++)if(c=d.relative[a[j].type])m=[qb(rb(m),c)];else{if(c=d.filter[a[j].type].apply(null,a[j].matches),c[s]){for(e=++j;f>e;e++)if(d.relative[a[e].type])break;return tb(j>1&&rb(m),j>1&&pb(a.slice(0,j-1).concat({value:" "===a[j-2].type?"*":""})).replace(P,"$1"),c,e>j&&ub(a.slice(j,e)),f>e&&ub(a=a.slice(e)),f>e&&pb(a))}m.push(c)}return rb(m)}function vb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,i,j,k){var m,n,o,p=0,q="0",r=f&&[],s=[],t=h,v=f||e&&d.find.TAG("*",k),w=u+=null==t?1:Math.random()||.1,x=v.length;for(k&&(h=g!==l&&g);q!==x&&null!=(m=v[q]);q++){if(e&&m){n=0;while(o=a[n++])if(o(m,g,i)){j.push(m);break}k&&(u=w)}c&&((m=!o&&m)&&p--,f&&r.push(m))}if(p+=q,c&&q!==p){n=0;while(o=b[n++])o(r,s,g,i);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=E.call(j));s=sb(s)}G.apply(j,s),k&&!f&&s.length>0&&p+b.length>1&&db.uniqueSort(j)}return k&&(u=w,h=t),r};return c?fb(f):f}g=db.compile=function(a,b){var c,d=[],e=[],f=y[a+" "];if(!f){b||(b=ob(a)),c=b.length;while(c--)f=ub(b[c]),f[s]?d.push(f):e.push(f);f=y(a,vb(e,d))}return f};function wb(a,b,c){for(var d=0,e=b.length;e>d;d++)db(a,b[d],c);return c}function xb(a,b,e,f){var h,i,j,k,l,m=ob(a);if(!f&&1===m.length){if(i=m[0]=m[0].slice(0),i.length>2&&"ID"===(j=i[0]).type&&c.getById&&9===b.nodeType&&n&&d.relative[i[1].type]){if(b=(d.find.ID(j.matches[0].replace(ab,bb),b)||[])[0],!b)return e;a=a.slice(i.shift().value.length)}h=V.needsContext.test(a)?0:i.length;while(h--){if(j=i[h],d.relative[k=j.type])break;if((l=d.find[k])&&(f=l(j.matches[0].replace(ab,bb),$.test(i[0].type)&&mb(b.parentNode)||b))){if(i.splice(h,1),a=f.length&&pb(i),!a)return G.apply(e,f),e;break}}}return g(a,m)(f,b,!n,e,$.test(a)&&mb(b.parentNode)||b),e}return c.sortStable=s.split("").sort(z).join("")===s,c.detectDuplicates=!!j,k(),c.sortDetached=gb(function(a){return 1&a.compareDocumentPosition(l.createElement("div"))}),gb(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||hb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&gb(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||hb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),gb(function(a){return null==a.getAttribute("disabled")})||hb(J,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),db}(a);o.find=t,o.expr=t.selectors,o.expr[":"]=o.expr.pseudos,o.unique=t.uniqueSort,o.text=t.getText,o.isXMLDoc=t.isXML,o.contains=t.contains;var u=o.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(o.isFunction(b))return o.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return o.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return o.filter(b,a,c);b=o.filter(b,a)}return o.grep(a,function(a){return g.call(b,a)>=0!==c})}o.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?o.find.matchesSelector(d,a)?[d]:[]:o.find.matches(a,o.grep(b,function(a){return 1===a.nodeType}))},o.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(o(a).filter(function(){for(b=0;c>b;b++)if(o.contains(e[b],this))return!0}));for(b=0;c>b;b++)o.find(a,e[b],d);return d=this.pushStack(c>1?o.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?o(a):a||[],!1).length}});var y,z=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,A=o.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof o?b[0]:b,o.merge(this,o.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:m,!0)),v.test(c[1])&&o.isPlainObject(b))for(c in b)o.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}return d=m.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=m,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):o.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(o):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),o.makeArray(a,this))};A.prototype=o.fn,y=o(m);var B=/^(?:parents|prev(?:Until|All))/,C={children:!0,contents:!0,next:!0,prev:!0};o.extend({dir:function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&o(a).is(c))break;d.push(a)}return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),o.fn.extend({has:function(a){var b=o(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(o.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?o(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&o.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?o.unique(f):f)},index:function(a){return a?"string"==typeof a?g.call(o(a),this[0]):g.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(o.unique(o.merge(this.get(),o(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function D(a,b){while((a=a[b])&&1!==a.nodeType);return a}o.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return o.dir(a,"parentNode")},parentsUntil:function(a,b,c){return o.dir(a,"parentNode",c)},next:function(a){return D(a,"nextSibling")},prev:function(a){return D(a,"previousSibling")},nextAll:function(a){return o.dir(a,"nextSibling")},prevAll:function(a){return o.dir(a,"previousSibling")},nextUntil:function(a,b,c){return o.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return o.dir(a,"previousSibling",c)},siblings:function(a){return o.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return o.sibling(a.firstChild)},contents:function(a){return a.contentDocument||o.merge([],a.childNodes)}},function(a,b){o.fn[a]=function(c,d){var e=o.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=o.filter(d,e)),this.length>1&&(C[a]||o.unique(e),B.test(a)&&e.reverse()),this.pushStack(e)}});var E=/\S+/g,F={};function G(a){var b=F[a]={};return o.each(a.match(E)||[],function(a,c){b[c]=!0}),b}o.Callbacks=function(a){a="string"==typeof a?F[a]||G(a):o.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(b=a.memory&&l,c=!0,g=e||0,e=0,f=h.length,d=!0;h&&f>g;g++)if(h[g].apply(l[0],l[1])===!1&&a.stopOnFalse){b=!1;break}d=!1,h&&(i?i.length&&j(i.shift()):b?h=[]:k.disable())},k={add:function(){if(h){var c=h.length;!function g(b){o.each(b,function(b,c){var d=o.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&g(c)})}(arguments),d?f=h.length:b&&(e=c,j(b))}return this},remove:function(){return h&&o.each(arguments,function(a,b){var c;while((c=o.inArray(b,h,c))>-1)h.splice(c,1),d&&(f>=c&&f--,g>=c&&g--)}),this},has:function(a){return a?o.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],f=0,this},disable:function(){return h=i=b=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,b||k.disable(),this},locked:function(){return!i},fireWith:function(a,b){return!h||c&&!i||(b=b||[],b=[a,b.slice?b.slice():b],d?i.push(b):j(b)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!c}};return k},o.extend({Deferred:function(a){var b=[["resolve","done",o.Callbacks("once memory"),"resolved"],["reject","fail",o.Callbacks("once memory"),"rejected"],["notify","progress",o.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return o.Deferred(function(c){o.each(b,function(b,f){var g=o.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&o.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?o.extend(a,d):d}},e={};return d.pipe=d.then,o.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&o.isFunction(a.promise)?e:0,g=1===f?a:o.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&o.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var H;o.fn.ready=function(a){return o.ready.promise().done(a),this},o.extend({isReady:!1,readyWait:1,holdReady:function(a){a?o.readyWait++:o.ready(!0)},ready:function(a){(a===!0?--o.readyWait:o.isReady)||(o.isReady=!0,a!==!0&&--o.readyWait>0||(H.resolveWith(m,[o]),o.fn.trigger&&o(m).trigger("ready").off("ready")))}});function I(){m.removeEventListener("DOMContentLoaded",I,!1),a.removeEventListener("load",I,!1),o.ready()}o.ready.promise=function(b){return H||(H=o.Deferred(),"complete"===m.readyState?setTimeout(o.ready):(m.addEventListener("DOMContentLoaded",I,!1),a.addEventListener("load",I,!1))),H.promise(b)},o.ready.promise();var J=o.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===o.type(c)){e=!0;for(h in c)o.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,o.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(o(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f};o.acceptData=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function K(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=o.expando+Math.random()}K.uid=1,K.accepts=o.acceptData,K.prototype={key:function(a){if(!K.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=K.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(d){b[this.expando]=c,o.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,e=this.key(a),f=this.cache[e];if("string"==typeof b)f[b]=c;else if(o.isEmptyObject(f))o.extend(this.cache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[this.key(a)];return void 0===b?c:c[b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,o.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=this.key(a),g=this.cache[f];if(void 0===b)this.cache[f]={};else{o.isArray(b)?d=b.concat(b.map(o.camelCase)):(e=o.camelCase(b),b in g?d=[b,e]:(d=e,d=d in g?[d]:d.match(E)||[])),c=d.length;while(c--)delete g[d[c]]}},hasData:function(a){return!o.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){a[this.expando]&&delete this.cache[a[this.expando]]}};var L=new K,M=new K,N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(O,"-$1").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?o.parseJSON(c):c}catch(e){}M.set(a,b,c)}else c=void 0;return c}o.extend({hasData:function(a){return M.hasData(a)||L.hasData(a)},data:function(a,b,c){return M.access(a,b,c)},removeData:function(a,b){M.remove(a,b)},_data:function(a,b,c){return L.access(a,b,c)},_removeData:function(a,b){L.remove(a,b)}}),o.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=M.get(f),1===f.nodeType&&!L.get(f,"hasDataAttrs"))){c=g.length;
    while(c--)d=g[c].name,0===d.indexOf("data-")&&(d=o.camelCase(d.slice(5)),P(f,d,e[d]));L.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){M.set(this,a)}):J(this,function(b){var c,d=o.camelCase(a);if(f&&void 0===b){if(c=M.get(f,a),void 0!==c)return c;if(c=M.get(f,d),void 0!==c)return c;if(c=P(f,d,void 0),void 0!==c)return c}else this.each(function(){var c=M.get(this,d);M.set(this,d,b),-1!==a.indexOf("-")&&void 0!==c&&M.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){M.remove(this,a)})}}),o.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=L.get(a,b),c&&(!d||o.isArray(c)?d=L.access(a,b,o.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=o.queue(a,b),d=c.length,e=c.shift(),f=o._queueHooks(a,b),g=function(){o.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return L.get(a,c)||L.access(a,c,{empty:o.Callbacks("once memory").add(function(){L.remove(a,[b+"queue",c])})})}}),o.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?o.queue(this[0],a):void 0===b?this:this.each(function(){var c=o.queue(this,a,b);o._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&o.dequeue(this,a)})},dequeue:function(a){return this.each(function(){o.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=o.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=L.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=["Top","Right","Bottom","Left"],S=function(a,b){return a=b||a,"none"===o.css(a,"display")||!o.contains(a.ownerDocument,a)},T=/^(?:checkbox|radio)$/i;!function(){var a=m.createDocumentFragment(),b=a.appendChild(m.createElement("div"));b.innerHTML="<input type='radio' checked='checked' name='t'/>",l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var U="undefined";l.focusinBubbles="onfocusin"in a;var V=/^key/,W=/^(?:mouse|contextmenu)|click/,X=/^(?:focusinfocus|focusoutblur)$/,Y=/^([^.]*)(?:\.(.+)|)$/;function Z(){return!0}function $(){return!1}function _(){try{return m.activeElement}catch(a){}}o.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,p,q,r=L.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=o.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return typeof o!==U&&o.event.triggered!==b.type?o.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(E)||[""],j=b.length;while(j--)h=Y.exec(b[j])||[],n=q=h[1],p=(h[2]||"").split(".").sort(),n&&(l=o.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=o.event.special[n]||{},k=o.extend({type:n,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&o.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(n,g,!1)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),o.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,p,q,r=L.hasData(a)&&L.get(a);if(r&&(i=r.events)){b=(b||"").match(E)||[""],j=b.length;while(j--)if(h=Y.exec(b[j])||[],n=q=h[1],p=(h[2]||"").split(".").sort(),n){l=o.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||o.removeEvent(a,n,r.handle),delete i[n])}else for(n in i)o.event.remove(a,n+b[j],c,d,!0);o.isEmptyObject(i)&&(delete r.handle,L.remove(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,l,n,p=[d||m],q=j.call(b,"type")?b.type:b,r=j.call(b,"namespace")?b.namespace.split("."):[];if(g=h=d=d||m,3!==d.nodeType&&8!==d.nodeType&&!X.test(q+o.event.triggered)&&(q.indexOf(".")>=0&&(r=q.split("."),q=r.shift(),r.sort()),k=q.indexOf(":")<0&&"on"+q,b=b[o.expando]?b:new o.Event(q,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=r.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:o.makeArray(c,[b]),n=o.event.special[q]||{},e||!n.trigger||n.trigger.apply(d,c)!==!1)){if(!e&&!n.noBubble&&!o.isWindow(d)){for(i=n.delegateType||q,X.test(i+q)||(g=g.parentNode);g;g=g.parentNode)p.push(g),h=g;h===(d.ownerDocument||m)&&p.push(h.defaultView||h.parentWindow||a)}f=0;while((g=p[f++])&&!b.isPropagationStopped())b.type=f>1?i:n.bindType||q,l=(L.get(g,"events")||{})[b.type]&&L.get(g,"handle"),l&&l.apply(g,c),l=k&&g[k],l&&l.apply&&o.acceptData(g)&&(b.result=l.apply(g,c),b.result===!1&&b.preventDefault());return b.type=q,e||b.isDefaultPrevented()||n._default&&n._default.apply(p.pop(),c)!==!1||!o.acceptData(d)||k&&o.isFunction(d[q])&&!o.isWindow(d)&&(h=d[k],h&&(d[k]=null),o.event.triggered=q,d[q](),o.event.triggered=void 0,h&&(d[k]=h)),b.result}},dispatch:function(a){a=o.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(L.get(this,"events")||{})[a.type]||[],k=o.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=o.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(g.namespace))&&(a.handleObj=g,a.data=g.data,e=((o.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(a.result=e)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0||"click"!==a.type){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?o(e,this).index(i)>=0:o.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||m,d=c.documentElement,e=c.body,a.pageX=b.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),a.pageY=b.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},fix:function(a){if(a[o.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=W.test(e)?this.mouseHooks:V.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new o.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=m),3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,f):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==_()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===_()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&o.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return o.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=o.extend(new o.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?o.event.trigger(e,null,b):o.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},o.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)},o.Event=function(a,b){return this instanceof o.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.getPreventDefault&&a.getPreventDefault()?Z:$):this.type=a,b&&o.extend(this,b),this.timeStamp=a&&a.timeStamp||o.now(),void(this[o.expando]=!0)):new o.Event(a,b)},o.Event.prototype={isDefaultPrevented:$,isPropagationStopped:$,isImmediatePropagationStopped:$,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=Z,a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=Z,a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=Z,this.stopPropagation()}},o.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){o.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!o.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.focusinBubbles||o.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){o.event.simulate(b,a.target,o.event.fix(a),!0)};o.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=L.access(d,b);e||d.addEventListener(a,c,!0),L.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=L.access(d,b)-1;e?L.access(d,b,e):(d.removeEventListener(a,c,!0),L.remove(d,b))}}}),o.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(g in a)this.on(g,b,c,a[g],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=$;else if(!d)return this;return 1===e&&(f=d,d=function(a){return o().off(a),f.apply(this,arguments)},d.guid=f.guid||(f.guid=o.guid++)),this.each(function(){o.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,o(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=$),this.each(function(){o.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){o.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?o.event.trigger(a,b,c,!0):void 0}});var ab=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bb=/<([\w:]+)/,cb=/<|&#?\w+;/,db=/<(?:script|style|link)/i,eb=/checked\s*(?:[^=]|=\s*.checked.)/i,fb=/^$|\/(?:java|ecma)script/i,gb=/^true\/(.*)/,hb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ib={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ib.optgroup=ib.option,ib.tbody=ib.tfoot=ib.colgroup=ib.caption=ib.thead,ib.th=ib.td;function jb(a,b){return o.nodeName(a,"table")&&o.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function kb(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function lb(a){var b=gb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function mb(a,b){for(var c=0,d=a.length;d>c;c++)L.set(a[c],"globalEval",!b||L.get(b[c],"globalEval"))}function nb(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(L.hasData(a)&&(f=L.access(a),g=L.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)o.event.add(b,e,j[e][c])}M.hasData(a)&&(h=M.access(a),i=o.extend({},h),M.set(b,i))}}function ob(a,b){var c=a.getElementsByTagName?a.getElementsByTagName(b||"*"):a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&o.nodeName(a,b)?o.merge([a],c):c}function pb(a,b){var c=b.nodeName.toLowerCase();"input"===c&&T.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}o.extend({clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=o.contains(a.ownerDocument,a);if(!(l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||o.isXMLDoc(a)))for(g=ob(h),f=ob(a),d=0,e=f.length;e>d;d++)pb(f[d],g[d]);if(b)if(c)for(f=f||ob(a),g=g||ob(h),d=0,e=f.length;e>d;d++)nb(f[d],g[d]);else nb(a,h);return g=ob(h,"script"),g.length>0&&mb(g,!i&&ob(a,"script")),h},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k=b.createDocumentFragment(),l=[],m=0,n=a.length;n>m;m++)if(e=a[m],e||0===e)if("object"===o.type(e))o.merge(l,e.nodeType?[e]:e);else if(cb.test(e)){f=f||k.appendChild(b.createElement("div")),g=(bb.exec(e)||["",""])[1].toLowerCase(),h=ib[g]||ib._default,f.innerHTML=h[1]+e.replace(ab,"<$1></$2>")+h[2],j=h[0];while(j--)f=f.lastChild;o.merge(l,f.childNodes),f=k.firstChild,f.textContent=""}else l.push(b.createTextNode(e));k.textContent="",m=0;while(e=l[m++])if((!d||-1===o.inArray(e,d))&&(i=o.contains(e.ownerDocument,e),f=ob(k.appendChild(e),"script"),i&&mb(f),c)){j=0;while(e=f[j++])fb.test(e.type||"")&&c.push(e)}return k},cleanData:function(a){for(var b,c,d,e,f,g,h=o.event.special,i=0;void 0!==(c=a[i]);i++){if(o.acceptData(c)&&(f=c[L.expando],f&&(b=L.cache[f]))){if(d=Object.keys(b.events||{}),d.length)for(g=0;void 0!==(e=d[g]);g++)h[e]?o.event.remove(c,e):o.removeEvent(c,e,b.handle);L.cache[f]&&delete L.cache[f]}delete M.cache[c[M.expando]]}}}),o.fn.extend({text:function(a){return J(this,function(a){return void 0===a?o.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?o.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||o.cleanData(ob(c)),c.parentNode&&(b&&o.contains(c.ownerDocument,c)&&mb(ob(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(o.cleanData(ob(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return o.clone(this,a,b)})},html:function(a){return J(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!db.test(a)&&!ib[(bb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(ab,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(o.cleanData(ob(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,o.cleanData(ob(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,k=this.length,m=this,n=k-1,p=a[0],q=o.isFunction(p);if(q||k>1&&"string"==typeof p&&!l.checkClone&&eb.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(k&&(c=o.buildFragment(a,this[0].ownerDocument,!1,this),d=c.firstChild,1===c.childNodes.length&&(c=d),d)){for(f=o.map(ob(c,"script"),kb),g=f.length;k>j;j++)h=c,j!==n&&(h=o.clone(h,!0,!0),g&&o.merge(f,ob(h,"script"))),b.call(this[j],h,j);if(g)for(i=f[f.length-1].ownerDocument,o.map(f,lb),j=0;g>j;j++)h=f[j],fb.test(h.type||"")&&!L.access(h,"globalEval")&&o.contains(i,h)&&(h.src?o._evalUrl&&o._evalUrl(h.src):o.globalEval(h.textContent.replace(hb,"")))}return this}}),o.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){o.fn[a]=function(a){for(var c,d=[],e=o(a),g=e.length-1,h=0;g>=h;h++)c=h===g?this:this.clone(!0),o(e[h])[b](c),f.apply(d,c.get());return this.pushStack(d)}});var qb,rb={};function sb(b,c){var d=o(c.createElement(b)).appendTo(c.body),e=a.getDefaultComputedStyle?a.getDefaultComputedStyle(d[0]).display:o.css(d[0],"display");return d.detach(),e}function tb(a){var b=m,c=rb[a];return c||(c=sb(a,b),"none"!==c&&c||(qb=(qb||o("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=qb[0].contentDocument,b.write(),b.close(),c=sb(a,b),qb.detach()),rb[a]=c),c}var ub=/^margin/,vb=new RegExp("^("+Q+")(?!px)[a-z%]+$","i"),wb=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)};function xb(a,b,c){var d,e,f,g,h=a.style;return c=c||wb(a),c&&(g=c.getPropertyValue(b)||c[b]),c&&(""!==g||o.contains(a.ownerDocument,a)||(g=o.style(a,b)),vb.test(g)&&ub.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+"":g}function yb(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",e=m.documentElement,f=m.createElement("div"),g=m.createElement("div");g.style.backgroundClip="content-box",g.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===g.style.backgroundClip,f.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",f.appendChild(g);function h(){g.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",e.appendChild(f);var d=a.getComputedStyle(g,null);b="1%"!==d.top,c="4px"===d.width,e.removeChild(f)}a.getComputedStyle&&o.extend(l,{pixelPosition:function(){return h(),b},boxSizingReliable:function(){return null==c&&h(),c},reliableMarginRight:function(){var b,c=g.appendChild(m.createElement("div"));return c.style.cssText=g.style.cssText=d,c.style.marginRight=c.style.width="0",g.style.width="1px",e.appendChild(f),b=!parseFloat(a.getComputedStyle(c,null).marginRight),e.removeChild(f),g.innerHTML="",b}})}(),o.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var zb=/^(none|table(?!-c[ea]).+)/,Ab=new RegExp("^("+Q+")(.*)$","i"),Bb=new RegExp("^([+-])=("+Q+")","i"),Cb={position:"absolute",visibility:"hidden",display:"block"},Db={letterSpacing:0,fontWeight:400},Eb=["Webkit","O","Moz","ms"];function Fb(a,b){if(b in a)return b;var c=b[0].toUpperCase()+b.slice(1),d=b,e=Eb.length;while(e--)if(b=Eb[e]+c,b in a)return b;return d}function Gb(a,b,c){var d=Ab.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Hb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=o.css(a,c+R[f],!0,e)),d?("content"===c&&(g-=o.css(a,"padding"+R[f],!0,e)),"margin"!==c&&(g-=o.css(a,"border"+R[f]+"Width",!0,e))):(g+=o.css(a,"padding"+R[f],!0,e),"padding"!==c&&(g+=o.css(a,"border"+R[f]+"Width",!0,e)));return g}function Ib(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=wb(a),g="border-box"===o.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=xb(a,b,f),(0>e||null==e)&&(e=a.style[b]),vb.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Hb(a,b,c||(g?"border":"content"),d,f)+"px"}function Jb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=L.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&S(d)&&(f[g]=L.access(d,"olddisplay",tb(d.nodeName)))):f[g]||(e=S(d),(c&&"none"!==c||!e)&&L.set(d,"olddisplay",e?c:o.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}o.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=xb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=o.camelCase(b),i=a.style;return b=o.cssProps[h]||(o.cssProps[h]=Fb(i,h)),g=o.cssHooks[b]||o.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=Bb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(o.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||o.cssNumber[h]||(c+="px"),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]="",i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=o.camelCase(b);return b=o.cssProps[h]||(o.cssProps[h]=Fb(a.style,h)),g=o.cssHooks[b]||o.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=xb(a,b,d)),"normal"===e&&b in Db&&(e=Db[b]),""===c||c?(f=parseFloat(e),c===!0||o.isNumeric(f)?f||0:e):e}}),o.each(["height","width"],function(a,b){o.cssHooks[b]={get:function(a,c,d){return c?0===a.offsetWidth&&zb.test(o.css(a,"display"))?o.swap(a,Cb,function(){return Ib(a,b,d)}):Ib(a,b,d):void 0},set:function(a,c,d){var e=d&&wb(a);return Gb(a,c,d?Hb(a,b,d,"border-box"===o.css(a,"boxSizing",!1,e),e):0)}}}),o.cssHooks.marginRight=yb(l.reliableMarginRight,function(a,b){return b?o.swap(a,{display:"inline-block"},xb,[a,"marginRight"]):void 0}),o.each({margin:"",padding:"",border:"Width"},function(a,b){o.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+R[d]+b]=f[d]||f[d-2]||f[0];return e}},ub.test(a)||(o.cssHooks[a+b].set=Gb)}),o.fn.extend({css:function(a,b){return J(this,function(a,b,c){var d,e,f={},g=0;if(o.isArray(b)){for(d=wb(a),e=b.length;e>g;g++)f[b[g]]=o.css(a,b[g],!1,d);return f}return void 0!==c?o.style(a,b,c):o.css(a,b)},a,b,arguments.length>1)},show:function(){return Jb(this,!0)},hide:function(){return Jb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){S(this)?o(this).show():o(this).hide()})}});function Kb(a,b,c,d,e){return new Kb.prototype.init(a,b,c,d,e)}o.Tween=Kb,Kb.prototype={constructor:Kb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(o.cssNumber[c]?"":"px")},cur:function(){var a=Kb.propHooks[this.prop];return a&&a.get?a.get(this):Kb.propHooks._default.get(this)},run:function(a){var b,c=Kb.propHooks[this.prop];return this.pos=b=this.options.duration?o.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Kb.propHooks._default.set(this),this}},Kb.prototype.init.prototype=Kb.prototype,Kb.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=o.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){o.fx.step[a.prop]?o.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[o.cssProps[a.prop]]||o.cssHooks[a.prop])?o.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},Kb.propHooks.scrollTop=Kb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},o.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},o.fx=Kb.prototype.init,o.fx.step={};var Lb,Mb,Nb=/^(?:toggle|show|hide)$/,Ob=new RegExp("^(?:([+-])=|)("+Q+")([a-z%]*)$","i"),Pb=/queueHooks$/,Qb=[Vb],Rb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=Ob.exec(b),f=e&&e[3]||(o.cssNumber[a]?"":"px"),g=(o.cssNumber[a]||"px"!==f&&+d)&&Ob.exec(o.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,o.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function Sb(){return setTimeout(function(){Lb=void 0}),Lb=o.now()}function Tb(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=R[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ub(a,b,c){for(var d,e=(Rb[b]||[]).concat(Rb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Vb(a,b,c){var d,e,f,g,h,i,j,k=this,l={},m=a.style,n=a.nodeType&&S(a),p=L.get(a,"fxshow");c.queue||(h=o._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,k.always(function(){k.always(function(){h.unqueued--,o.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[m.overflow,m.overflowX,m.overflowY],j=o.css(a,"display"),"none"===j&&(j=tb(a.nodeName)),"inline"===j&&"none"===o.css(a,"float")&&(m.display="inline-block")),c.overflow&&(m.overflow="hidden",k.always(function(){m.overflow=c.overflow[0],m.overflowX=c.overflow[1],m.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Nb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(n?"hide":"show")){if("show"!==e||!p||void 0===p[d])continue;n=!0}l[d]=p&&p[d]||o.style(a,d)}if(!o.isEmptyObject(l)){p?"hidden"in p&&(n=p.hidden):p=L.access(a,"fxshow",{}),f&&(p.hidden=!n),n?o(a).show():k.done(function(){o(a).hide()}),k.done(function(){var b;L.remove(a,"fxshow");for(b in l)o.style(a,b,l[b])});for(d in l)g=Ub(n?p[d]:0,d,k),d in p||(p[d]=g.start,n&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function Wb(a,b){var c,d,e,f,g;for(c in a)if(d=o.camelCase(c),e=b[d],f=a[c],o.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=o.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function Xb(a,b,c){var d,e,f=0,g=Qb.length,h=o.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Lb||Sb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:o.extend({},b),opts:o.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:Lb||Sb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=o.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(Wb(k,j.opts.specialEasing);g>f;f++)if(d=Qb[f].call(j,a,k,j.opts))return d;return o.map(k,Ub,j),o.isFunction(j.opts.start)&&j.opts.start.call(a,j),o.fx.timer(o.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}o.Animation=o.extend(Xb,{tweener:function(a,b){o.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],Rb[c]=Rb[c]||[],Rb[c].unshift(b)},prefilter:function(a,b){b?Qb.unshift(a):Qb.push(a)}}),o.speed=function(a,b,c){var d=a&&"object"==typeof a?o.extend({},a):{complete:c||!c&&b||o.isFunction(a)&&a,duration:a,easing:c&&b||b&&!o.isFunction(b)&&b};return d.duration=o.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in o.fx.speeds?o.fx.speeds[d.duration]:o.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){o.isFunction(d.old)&&d.old.call(this),d.queue&&o.dequeue(this,d.queue)},d},o.fn.extend({fadeTo:function(a,b,c,d){return this.filter(S).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=o.isEmptyObject(a),f=o.speed(b,c,d),g=function(){var b=Xb(this,o.extend({},a),f);(e||L.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=o.timers,g=L.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Pb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&o.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=L.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=o.timers,g=d?d.length:0;for(c.finish=!0,o.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),o.each(["toggle","show","hide"],function(a,b){var c=o.fn[b];o.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Tb(b,!0),a,d,e)}}),o.each({slideDown:Tb("show"),slideUp:Tb("hide"),slideToggle:Tb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){o.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),o.timers=[],o.fx.tick=function(){var a,b=0,c=o.timers;for(Lb=o.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||o.fx.stop(),Lb=void 0},o.fx.timer=function(a){o.timers.push(a),a()?o.fx.start():o.timers.pop()},o.fx.interval=13,o.fx.start=function(){Mb||(Mb=setInterval(o.fx.tick,o.fx.interval))},o.fx.stop=function(){clearInterval(Mb),Mb=null},o.fx.speeds={slow:600,fast:200,_default:400},o.fn.delay=function(a,b){return a=o.fx?o.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a=m.createElement("input"),b=m.createElement("select"),c=b.appendChild(m.createElement("option"));a.type="checkbox",l.checkOn=""!==a.value,l.optSelected=c.selected,b.disabled=!0,l.optDisabled=!c.disabled,a=m.createElement("input"),a.value="t",a.type="radio",l.radioValue="t"===a.value}();var Yb,Zb,$b=o.expr.attrHandle;o.fn.extend({attr:function(a,b){return J(this,o.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){o.removeAttr(this,a)})}}),o.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===U?o.prop(a,b,c):(1===f&&o.isXMLDoc(a)||(b=b.toLowerCase(),d=o.attrHooks[b]||(o.expr.match.bool.test(b)?Zb:Yb)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=o.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void o.removeAttr(a,b))},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(E);if(f&&1===a.nodeType)while(c=f[e++])d=o.propFix[c]||c,o.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&o.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),Zb={set:function(a,b,c){return b===!1?o.removeAttr(a,c):a.setAttribute(c,c),c}},o.each(o.expr.match.bool.source.match(/\w+/g),function(a,b){var c=$b[b]||o.find.attr;$b[b]=function(a,b,d){var e,f;
    return d||(f=$b[b],$b[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,$b[b]=f),e}});var _b=/^(?:input|select|textarea|button)$/i;o.fn.extend({prop:function(a,b){return J(this,o.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[o.propFix[a]||a]})}}),o.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!o.isXMLDoc(a),f&&(b=o.propFix[b]||b,e=o.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||_b.test(a.nodeName)||a.href?a.tabIndex:-1}}}}),l.optSelected||(o.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),o.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){o.propFix[this.toLowerCase()]=this});var ac=/[\t\r\n\f]/g;o.fn.extend({addClass:function(a){var b,c,d,e,f,g,h="string"==typeof a&&a,i=0,j=this.length;if(o.isFunction(a))return this.each(function(b){o(this).addClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=o.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0===arguments.length||"string"==typeof a&&a,i=0,j=this.length;if(o.isFunction(a))return this.each(function(b){o(this).removeClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?o.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(o.isFunction(a)?function(c){o(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=o(this),f=a.match(E)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===U||"boolean"===c)&&(this.className&&L.set(this,"__className__",this.className),this.className=this.className||a===!1?"":L.get(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(ac," ").indexOf(b)>=0)return!0;return!1}});var bc=/\r/g;o.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=o.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,o(this).val()):a,null==e?e="":"number"==typeof e?e+="":o.isArray(e)&&(e=o.map(e,function(a){return null==a?"":a+""})),b=o.valHooks[this.type]||o.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=o.valHooks[e.type]||o.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(bc,""):null==c?"":c)}}}),o.extend({valHooks:{select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(l.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&o.nodeName(c.parentNode,"optgroup"))){if(b=o(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=o.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=o.inArray(o(d).val(),f)>=0)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),o.each(["radio","checkbox"],function(){o.valHooks[this]={set:function(a,b){return o.isArray(b)?a.checked=o.inArray(o(a).val(),b)>=0:void 0}},l.checkOn||(o.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})}),o.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){o.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),o.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var cc=o.now(),dc=/\?/;o.parseJSON=function(a){return JSON.parse(a+"")},o.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&o.error("Invalid XML: "+a),b};var ec,fc,gc=/#.*$/,hc=/([?&])_=[^&]*/,ic=/^(.*?):[ \t]*([^\r\n]*)$/gm,jc=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,kc=/^(?:GET|HEAD)$/,lc=/^\/\//,mc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,nc={},oc={},pc="*/".concat("*");try{fc=location.href}catch(qc){fc=m.createElement("a"),fc.href="",fc=fc.href}ec=mc.exec(fc.toLowerCase())||[];function rc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(E)||[];if(o.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function sc(a,b,c,d){var e={},f=a===oc;function g(h){var i;return e[h]=!0,o.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function tc(a,b){var c,d,e=o.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&o.extend(!0,a,d),a}function uc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function vc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}o.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:fc,type:"GET",isLocal:jc.test(ec[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":pc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":o.parseJSON,"text xml":o.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?tc(tc(a,o.ajaxSettings),b):tc(o.ajaxSettings,a)},ajaxPrefilter:rc(nc),ajaxTransport:rc(oc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=o.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?o(l):o.event,n=o.Deferred(),p=o.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!f){f={};while(b=ic.exec(e))f[b[1].toLowerCase()]=b[2]}b=f[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?e:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return c&&c.abort(b),x(0,b),this}};if(n.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||fc)+"").replace(gc,"").replace(lc,ec[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=o.trim(k.dataType||"*").toLowerCase().match(E)||[""],null==k.crossDomain&&(h=mc.exec(k.url.toLowerCase()),k.crossDomain=!(!h||h[1]===ec[1]&&h[2]===ec[2]&&(h[3]||("http:"===h[1]?"80":"443"))===(ec[3]||("http:"===ec[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=o.param(k.data,k.traditional)),sc(nc,k,b,v),2===t)return v;i=k.global,i&&0===o.active++&&o.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!kc.test(k.type),d=k.url,k.hasContent||(k.data&&(d=k.url+=(dc.test(d)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=hc.test(d)?d.replace(hc,"$1_="+cc++):d+(dc.test(d)?"&":"?")+"_="+cc++)),k.ifModified&&(o.lastModified[d]&&v.setRequestHeader("If-Modified-Since",o.lastModified[d]),o.etag[d]&&v.setRequestHeader("If-None-Match",o.etag[d])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+pc+"; q=0.01":""):k.accepts["*"]);for(j in k.headers)v.setRequestHeader(j,k.headers[j]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(j in{success:1,error:1,complete:1})v[j](k[j]);if(c=sc(oc,k,b,v)){v.readyState=1,i&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,c.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,f,h){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),c=void 0,e=h||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,f&&(u=uc(k,v,f)),u=vc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(o.lastModified[d]=w),w=v.getResponseHeader("etag"),w&&(o.etag[d]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?n.resolveWith(l,[r,x,v]):n.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,i&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),i&&(m.trigger("ajaxComplete",[v,k]),--o.active||o.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return o.get(a,b,c,"json")},getScript:function(a,b){return o.get(a,void 0,b,"script")}}),o.each(["get","post"],function(a,b){o[b]=function(a,c,d,e){return o.isFunction(c)&&(e=e||d,d=c,c=void 0),o.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),o.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){o.fn[b]=function(a){return this.on(b,a)}}),o._evalUrl=function(a){return o.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},o.fn.extend({wrapAll:function(a){var b;return o.isFunction(a)?this.each(function(b){o(this).wrapAll(a.call(this,b))}):(this[0]&&(b=o(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return this.each(o.isFunction(a)?function(b){o(this).wrapInner(a.call(this,b))}:function(){var b=o(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=o.isFunction(a);return this.each(function(c){o(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){o.nodeName(this,"body")||o(this).replaceWith(this.childNodes)}).end()}}),o.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0},o.expr.filters.visible=function(a){return!o.expr.filters.hidden(a)};var wc=/%20/g,xc=/\[\]$/,yc=/\r?\n/g,zc=/^(?:submit|button|image|reset|file)$/i,Ac=/^(?:input|select|textarea|keygen)/i;function Bc(a,b,c,d){var e;if(o.isArray(b))o.each(b,function(b,e){c||xc.test(a)?d(a,e):Bc(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==o.type(b))d(a,b);else for(e in b)Bc(a+"["+e+"]",b[e],c,d)}o.param=function(a,b){var c,d=[],e=function(a,b){b=o.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=o.ajaxSettings&&o.ajaxSettings.traditional),o.isArray(a)||a.jquery&&!o.isPlainObject(a))o.each(a,function(){e(this.name,this.value)});else for(c in a)Bc(c,a[c],b,e);return d.join("&").replace(wc,"+")},o.fn.extend({serialize:function(){return o.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=o.prop(this,"elements");return a?o.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!o(this).is(":disabled")&&Ac.test(this.nodeName)&&!zc.test(a)&&(this.checked||!T.test(a))}).map(function(a,b){var c=o(this).val();return null==c?null:o.isArray(c)?o.map(c,function(a){return{name:b.name,value:a.replace(yc,"\r\n")}}):{name:b.name,value:c.replace(yc,"\r\n")}}).get()}}),o.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var Cc=0,Dc={},Ec={0:200,1223:204},Fc=o.ajaxSettings.xhr();a.ActiveXObject&&o(a).on("unload",function(){for(var a in Dc)Dc[a]()}),l.cors=!!Fc&&"withCredentials"in Fc,l.ajax=Fc=!!Fc,o.ajaxTransport(function(a){var b;return l.cors||Fc&&!a.crossDomain?{send:function(c,d){var e,f=a.xhr(),g=++Cc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)f.setRequestHeader(e,c[e]);b=function(a){return function(){b&&(delete Dc[g],b=f.onload=f.onerror=null,"abort"===a?f.abort():"error"===a?d(f.status,f.statusText):d(Ec[f.status]||f.status,f.statusText,"string"==typeof f.responseText?{text:f.responseText}:void 0,f.getAllResponseHeaders()))}},f.onload=b(),f.onerror=b("error"),b=Dc[g]=b("abort"),f.send(a.hasContent&&a.data||null)},abort:function(){b&&b()}}:void 0}),o.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return o.globalEval(a),a}}}),o.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),o.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=o("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&e("error"===a.type?404:200,a.type)}),m.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Gc=[],Hc=/(=)\?(?=&|$)|\?\?/;o.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Gc.pop()||o.expando+"_"+cc++;return this[a]=!0,a}}),o.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Hc.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Hc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=o.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Hc,"$1"+e):b.jsonp!==!1&&(b.url+=(dc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||o.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Gc.push(e)),g&&o.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),o.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||m;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=o.buildFragment([a],b,e),e&&e.length&&o(e).remove(),o.merge([],d.childNodes))};var Ic=o.fn.load;o.fn.load=function(a,b,c){if("string"!=typeof a&&Ic)return Ic.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=a.slice(h),a=a.slice(0,h)),o.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&o.ajax({url:a,type:e,dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?o("<div>").append(o.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,f||[a.responseText,b,a])}),this},o.expr.filters.animated=function(a){return o.grep(o.timers,function(b){return a===b.elem}).length};var Jc=a.document.documentElement;function Kc(a){return o.isWindow(a)?a:9===a.nodeType&&a.defaultView}o.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=o.css(a,"position"),l=o(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=o.css(a,"top"),i=o.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),o.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},o.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){o.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,o.contains(b,d)?(typeof d.getBoundingClientRect!==U&&(e=d.getBoundingClientRect()),c=Kc(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===o.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),o.nodeName(a[0],"html")||(d=a.offset()),d.top+=o.css(a[0],"borderTopWidth",!0),d.left+=o.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-o.css(c,"marginTop",!0),left:b.left-d.left-o.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||Jc;while(a&&!o.nodeName(a,"html")&&"static"===o.css(a,"position"))a=a.offsetParent;return a||Jc})}}),o.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(b,c){var d="pageYOffset"===c;o.fn[b]=function(e){return J(this,function(b,e,f){var g=Kc(b);return void 0===f?g?g[c]:b[e]:void(g?g.scrollTo(d?a.pageXOffset:f,d?f:a.pageYOffset):b[e]=f)},b,e,arguments.length,null)}}),o.each(["top","left"],function(a,b){o.cssHooks[b]=yb(l.pixelPosition,function(a,c){return c?(c=xb(a,b),vb.test(c)?o(a).position()[b]+"px":c):void 0})}),o.each({Height:"height",Width:"width"},function(a,b){o.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){o.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return J(this,function(b,c,d){var e;return o.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?o.css(b,c,g):o.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),o.fn.size=function(){return this.length},o.fn.andSelf=o.fn.addBack,"function"==typeof define&&define("jquery",[],function(){return o});var Lc=a.jQuery,Mc=a.$;return o.noConflict=function(b){return a.$===o&&(a.$=Mc),b&&a.jQuery===o&&(a.jQuery=Lc),o},typeof b===U&&(a.jQuery=a.$=o),o});
$.noConflict();;define("mmrp.config.user",function(){
	var host = window.location.host;
	var config= {}
	if(host == 'wqs.jd.com'){
		config['root'] = "//wqs.jd.com/wdpat/";
		config['upload_files'] = "/data/wdpat_preview/project/new/";
		config['preview_root'] = "//wqs.jd.com/wdpat_preview/project/new/";
	}else if(host == 'wdpatdev.jd.com'){
		config['root'] = "//wdpatdev.jd.com/wdpat/";
		config['upload_files'] = "/data/wdpat_preview/project/new/";
		config['preview_root'] = "//wdpatdev.jd.com/wdpat_preview/project/new/";
	}else if(host == 'localhost'){
		config['root'] = "//localhost/wdpat/";
		config['upload_files'] = "/Applications/XAMPP/xamppfiles/htdocs/wdpat_preview/";
		config['preview_root'] = "//localhost/wdpat_preview/";
	}else if(host == 'wq.jd.com'){
		config['root'] = "//wq.jd.com/wdpat2/";
		config['upload_files'] = "/data/wdpat_preview/project/new/";
		config['preview_root'] = "//wq.jd.com/wdpat_preview/project/new/";
	}else{
		console.error('  mmrp.config.user.js');
	}
	config['synHtml'] = function(data){
		console.info(data,'synHtml');
		return "//mmrp.oa.com/cgi-bin/mmrp_release/mmrp_release_file?filetype=";
	};
	config['synImg'] = function(data){
		console.info(data,'synimg');
        var path = '../' + data.directory + data.filename;
		return "//ppms.wq.jd.com/wxpat/inc/ppsync.php?act=syncImg&pageid="+ data.page_id +"&path=" + path;
	};
	config['debug'] = true
	return config;
})  ;define("jquery.cookie",[], function() { return function(jQuery) {
  
/**code start**/

 /*!
 * jQuery Cookie Plugin
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($) {
    $.cookie = function(key, value, options) {

        // key and at least value given, set cookie...
        if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value === null || value === undefined)) {
            options = $.extend({}, options);

            if (value === null || value === undefined) {
                options.expires = -1;
            }

            if (typeof options.expires === 'number') {
                var days = options.expires, t = options.expires = new Date();
                t.setDate(t.getDate() + days);
            }

            value = String(value);

            return (document.cookie = [
                encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
                options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
                options.path    ? '; path=' + options.path : '',
                options.domain  ? '; domain=' + options.domain : '',
                options.secure  ? '; secure' : ''
            ].join(''));
        }

        // key and possibly options given, get cookie...
        options = value || {};
        var decode = options.raw ? function(s) { return s; } : decodeURIComponent;

        var pairs = document.cookie.split('; ');
        for (var i = 0, pair; pair = pairs[i] && pairs[i].split('='); i++) {
            if (decode(pair[0]) === key) return decode(pair[1] || ''); // IE saves cookies with empty string as "c; ", e.g. without "=" as opposed to EOMB, thus pair[1] may be undefined
        }
        return null;
    };
})(jQuery);

/**code end**/
  
  
}});


;define("localStore",function(require, exports, module) {  

/***
 * Module based on jquery plugin from http://www.stoimen.com/blog/2010/02/26/jquery-localstorage-plugin-alpha
 * localStorageobjectnumber
 */
	
	var ls = null,
		hasJSON = (typeof JSON !== 'undefined');

	if (typeof localStorage !== 'undefined') {
		ls = localStorage;
	}

	exports.setItem = function(key, value, lifetime) {
		if (!ls || !exports.canStoreItem(value)) return false;
		
		var time = new Date();
		if (typeof lifetime === 'undefined') lifetime = 24*60*60*1000;//1
		lifetime = lifetime * 24 * 60 * 60 * 1000;
		ls.setItem(key, JSON.stringify(value));
		ls.setItem('meta_ct_'+ key, time.getTime());
		ls.setItem('meta_lt_'+ key, lifetime);
		return true;
	};

	exports.getItem  = function(key) {
	     if (!ls) return false;
	     var time = new Date();
	     if (time.getTime() - ls.getItem('meta_ct_'+key) > ls.getItem('meta_lt_'+key)) {
	        exports.removeItem(key);
	        return null;
	     }
	     return JSON.parse(ls.getItem(key));
	};

	exports.removeItem  = function(key) {
	     if (!ls) return false;

	     ls.removeItem(key);
	     ls.removeItem('meta_ct_'+key);
	     ls.removeItem('meta_lt_'+key);
	     return true;
	};
	
	exports.canStoreItem  = function(value) {
		switch (typeof value) {
			case 'string':
			case 'number':
				return true;
		}
		if (!hasJSON) {
			console && console.warn('localStore cannot serialise object data.');
		}
		return hasJSON;
	};
	
	exports.clear = function(){
		ls.clear();
	}
	

}) ;;/***
 * hugohua
 */
define("mmrp.rest",function (require, exports, module) {
    var $ = require('jquery'),
        c = require('mmrp.config.user');
    require('jquery.cookie')($);
    var localStore = require('localStore');
    var venderid = $.cookie("wq_uin") - 10000000000;
    var defaults = {
        dataType: "json"
    };
    var baimingdan = ["48697","38624","98820","24799","97154","43866","33911","68873","53430","18439","75308","54735","29097","11468", "113630", "117964", "86348", "112158", "84629", "88952", "76427", "73015", "44269", "20588", "70277","62710","14393","62629","35345"];
    var ajaxDom = '<div id="J_loading" class="ui_tips ui_tips_show"><div class="J_txt">...</div></div>';
    $('body').append(ajaxDom);
    var $ajax = $('#J_loading');

    $(document).ajaxStart(function () {
        $ajax.show();
    }).ajaxComplete(function () {
        $ajax.hide();
    });
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }

    function $getToken() {
        var skey = getCookie('skey');
        token = skey == null ? "" : $time33(skey);
        return token;
    };


    function $time33(str) {
        //time33
        for (var i = 0, len = str.length, hash = 5381; i < len; ++i) {
            hash += (hash << 5) + str.charAt(i).charCodeAt();
        }
        ;
        return hash & 0x7fffffff;
    }


    /***
     * api url
     * @param {Object} api_name
     */
    var getUrl = function (api_path) {
        if (api_path.indexOf('?') > -1) {
            api_path += '&g_tk=' + $getToken();
        } else {
            api_path += '?g_tk=' + $getToken();
        }
        var url = c.root + api_path;
        return url;
    };
    /***
     *
     * @param {Object} params
     * @param {Object} type GET/POST/PUT/DELETE
     */
    var baseRest = function (params, type) {
        $.extend(params, defaults);
        params.type = type || "GET";
        var jxhr = $.ajax(params);
        return jxhr;
    };
    //MMRP

    /**
     * 
     * @param {Object} params
     */
    exports.getModListByCate = function (cate_id, params) {
        params = params || {};
        //			params.url = getUrl("json_data/tb_mod.txt");
        params.url = getUrl("php/hander.php?act=getModByCategory&category=" + cate_id);
        return baseRest(params);
    };
    /**
     * ID
     * @param {Object} mod_id
     * @param {Object} params
     */
    exports.getBaseModDataById = function (mod_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getBaseStyleById&id=" + mod_id);
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getBaseModData = function (params) {
        params = params || {};

        params.url = getUrl("php/hander.php?act=getBaseStyleList");
        //			params.url = getUrl("json_data/tb_mod_base_style.txt");
        return baseRest(params);
    };
    /**
     * ID
     * @param {Object} id
     */
    exports.getModDataById = function (id, params) {
        console.trace()
        params = params || {};
        params.url = getUrl("php/hander.php?act=getModById&id=" + id);
        //			params.url = getUrl("json_data/tb_mod_by_id_"+ id +".txt");
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.delModById = function (mod_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delModById&id=" + mod_id);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.delLayoutById = function (layout_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delLayoutById&id=" + layout_id);
        return baseRest(params);
    };
    /**
     * IDtheme
     * @param {Object} theme_id
     * @param {Object} params
     */
    exports.getThemeById = function (theme_id, params) {
        params = params || {};
        //			params.url = getUrl("json_data/tb_theme_by_id_"+ theme_id +".txt");
        params.url = getUrl("php/hander.php?act=getThemeById&id=" + theme_id);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.getPageList = function (start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageList" + "&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.getPageListPage = function (start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListPage" + "&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * IDpage
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.getPageById = function (page_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageById&id=" + page_id);
        //			params.url = getUrl("json_data/tb_page_by_id_"+ page_id +".txt");
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_id
     * @param {Object} params
     */
    exports.delPageById = function (page_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delPageById&id=" + page_id);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_user
     * @param {Object} params
     */
    exports.getPageListByNotUser = function (page_user, start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListByNotUser&user=" + page_user + "&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_user
     * @param {Object} params
     */
    exports.getPageListByAuthorize = function (page_user, start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListByAuthorize&user=" + page_user + "&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * page
     * @param {Object} page_user
     * @param {Object} params
     */
    exports.getPageByUser = function (page_user, start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageByUser&user=" + page_user + "&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * page
     */
    exports.getPageListByState = function (state, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListByState&state=" + state);
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getPageListByWeek = function (start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListByWeek&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getPageListByMonth = function (start, num, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageListByMonth&start=" + start + "&num=" + num);
        return baseRest(params);
    };
    /**
     * page  
     * @param {Object} page_user
     * @param {Object} params
     */
    exports.getPageByDraft = function (page_user, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageByDraft&user=" + page_user);
        return baseRest(params);
    };
    /**
     *  
     * @param {Object} user_name
     * @param {Object} params
     */
    exports.getUserByName = function (user_name, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUserByName&user=" + user_name);
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getUserList = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUserList");
        return baseRest(params);
    };


    /**
     * 
     */
    exports.insertUser = function (user_name, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=insertUser&user=" + user_name);
        return baseRest(params);
    };


    /**
     * 
     @ @param {int} power
     * @param {Object} params
     */
    exports.getUserListByPower = function (power, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUserListByPower&power=" + power);
        return baseRest(params);
    };

    /**
     * 
     * @param {string} user_id
     * @param {string} power
     * @param {Object} params
     */
    exports.setUserPower = function (user_id, power, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=setUserPower&user_id=" + user_id + "&power=" + power);
        return baseRest(params);
    };

    /**
     *   
     * @param {string} type
     * @param {string} user
     * @param {Object} params
     */
    exports.getPageCountByType = function (type, user, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageCountByType&type=" + type + "&user=" + user);
        return baseRest(params);
    };
    /**
     * IDTmplate
     * @param {Object} Tmplate_id
     * @param {Object} params
     */
    exports.getTemplateById = function (tmplate_id, params) {
        params = params || {};
        //			params.url = getUrl("json_data/tb_tmplate_by_id_"+ tmplate_id +".txt");
        params.url = getUrl("php/hander.php?act=getTemplateById&id=" + tmplate_id);
        return baseRest(params);
    };
    /**
     * 5
     * @param {Object} tmplate_id
     * @param {Object} params
     */
    exports.delTemplateDraft = function (tmplate_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delTemplateDraft&id=" + tmplate_id);
        return baseRest(params);
    };
    /**
     * JSON
     * @param {Object} url
     */
    exports.getJson = function (url, data) {
        data = data || {};
        var req = $.getJSON(url, data);
        return req;
    };
    /**
     * 
     * @param {Object} data
     */
    exports.postAddData = function (data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=insert"),
            success: function (t_data) {
                if (t_data.error) {
                    alert(t_data.message);
                }
            }
        };
        return baseRest(params, "POST");
    };
    /**
     * 
     * @param {Object} data
     */
    exports.postUpdata = function (data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=update"),
            success: function (t_data) {
                if (t_data.errorCode) {
                    alert(t_data.errorMsg);
                }
            }
        };
        return baseRest(params, "POST");
    };
    /**
     * 
     * @param {Object} them    url
     * @param {Object} page_id Id
     */
    exports.updatePageThumbnailById = function (thum, page_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=updatePageThumbnail&id=" + page_id + "&thum=" + thum);
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getUserPower = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUserPower");
        return baseRest(params);
    };
    /**
     * $mod_id : Id
     *  -1   11
     *
     */
    exports.updateModFrequency = function (mod_id, state, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=modFrequency&mod_id=" + mod_id + "&state=" + state);
        return baseRest(params);
    };
    /***
     * RTX
     * data = {
	 *		title:"RTX",
	 *		receiver:"",
	 *		msginfo:""
	 *	}
     */
    exports.sendRtxMsg = function (data) {
        var params = {
            data: {
                data: data
            },
            url: getUrl("inc/send_msg.php?act=sendrtx")
        };
        return baseRest(params, "POST");
    };
    /***
     * Email
     * data = {
	 *		subject:"subject",
	 *		receiver:"receiver",
	 *		msg:"msg"
	 *	}
     */
    exports.sendEmail = function (data) {
        var params = {
            data: {
                data: data
            },
            url: getUrl("inc/send_msg.php?act=sendemail")
        };
        return baseRest(params, "POST");
    };
    /**
     * 
     */
    exports.getUserCountPage = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUserCountPage");
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getPageCountByData = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getPageCountByData");
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getModFrequency = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getModFrequency");
        return baseRest(params);
    };
    /**
     * 
     */
    exports.checkLoginUser = function (data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=checkLoginUser")
        };
        return baseRest(params, "POST");
    };

    /**
     * 
     */
    exports.createPage = function (data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=createPage")
        };
        return baseRest(params, "POST");
    };

    /**
     * 
     */
    exports.clonePage = function (data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=clonePage")
        };
        return baseRest(params, "POST");
    };

    /**
     * layout id 
     */
    exports.getLayoutById = function (layout_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getLayoutById&id=" + layout_id);
        return baseRest(params);
    };

    /**
     * 
     * @param {Object} page_id
     * @param {Object} data
     */
    exports.saveDraft = function (page_id, data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=saveDraft&id=" + page_id)
        };
        return baseRest(params, "POST");
    };

    /**
     * 
     * @param {Object} page_id
     * @param {Object} template_id
     * @param {Object} data
     */
    exports.publishPage = function (page_id, template_id, data) {
        var params = {
            data: data,
            url: getUrl("php/hander.php?act=publishPage&page_id=" + page_id + "&template_id=" + template_id)
        };
        return baseRest(params, "POST");
    };

    /**
     * layout id 
     */
    exports.getLayout = function (params) {
        params = params || {};
        if ($.inArray(venderid + "", baimingdan) >= 0) {
            params.url = getUrl("php/hander.php?act=getLayout&cc=1");
        } else {
            params.url = getUrl("php/hander.php?act=getLayout");
        }
        return baseRest(params);
    };

    /**
     * 
     */
    exports.getCateList = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getCateList");
        return baseRest(params);
    };

    /**
     * 
     */
    exports.getUrlList = function (params) {
        params = params || {};
        if ($.inArray(venderid + "", baimingdan) >= 0) {
            params.url = getUrl("php/hander.php?act=getUrlList&cc=1");
        } else {
            params.url = getUrl("php/hander.php?act=getUrlList");
        }
        return baseRest(params);
    };

    /**
     * 
     */
    exports.getUrlListForAdmin = function(params){
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUrlListForAdmin");
        return baseRest(params);
    }
    /**
     * 
     */
    exports.getGoodModelPages = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getGoodModelPages");
        return baseRest(params);
    };
    /**
     * 
     */
    exports.getUrlLimitList = function (params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=getUrlLimitList");
        return baseRest(params);
    };
    /**
     * 
     */
    exports.delCateById = function (cate_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delCateById&id=" + cate_id)
        return baseRest(params);
    };

    /**
     * 
     */
    exports.delUrlById = function (url_id, params) {
        params = params || {};
        params.url = getUrl("php/hander.php?act=delUrlById&id=" + url_id)
        return baseRest(params);
    };

    /**
     * 
     */
    exports.updateLocalStore = function (key, params) {
        params = params || {};
        params.url = getUrl("php/edit_config.php?act=localstore&key=" + key)
        return baseRest(params);
    };

    /* ============= import ================= */
    exports.unzip = function (zipFile, params) {
        params = params || {};
        params.url = getUrl("unzip/" + zipFile);
        return baseRest(params);
    };

    exports.getPat = function (params) {
        params = params || {};
        params.url = getUrl("jdpat");
        return baseRest(params);
    };

    exports.getPatById = function (id, params) {
        params = params || {};
        params.url = getUrl("jdpat/" + id);
        return baseRest(params);
    };

    exports.getPatByUser = function (user, params) {
        params = params || {};
        params.url = getUrl("jdpat/user/" + user);
        return baseRest(params);
    };

    exports.putPatById = function (data) {
        var params = {
            data: data,
            url: getUrl("jdpat/" + data.jdpat.jdpat_id)
        };
        return baseRest(params, 'PUT');
    };

    exports.delPatById = function (id, params) {
        params = params || {};
        params.url = getUrl("jdpat/" + id);
        return baseRest(params, 'DELETE');
    };

    exports.getUrl = function (params) {
        params = params || {};
        params.url = getUrl("url");
        return baseRest(params);
    };
    /**
     * 
     * @param pageid
     */
    exports.copyActivityById = function(pageid){
        var params = {};
        params.url = getUrl("php/copy_activity.php?pageid="+pageid);
        return baseRest(params);
    }
    /**/
    exports.countComponent = function (id, data) {
        params = {};
        params.data = data;
        params.url = getUrl("php/hander.php?act=updateComponentStatistics&id=" + id);
        return baseRest(params, "POST");
    };

    exports.getPageCount = function (str) {
        str = str || '';
        var params = {};
        params.url = getUrl("php/hander.php?act=getPageCount&" + str);
        return baseRest(params);
    };
    exports.getModCount = function () {
        var params = {};
        params.url = getUrl("php/hander.php?act=getModCount");
        return baseRest(params);
    };
    exports.getSysAllCount = function (str) {
        str = str || '';
        var params = {};
        params.url = getUrl("php/hander.php?act=getSysAllCount&" + str);
        return baseRest(params);
    };
    exports.getUserCount = function (str) {//
        str = str || '';
        var params = {};
        params.url = getUrl("php/hander.php?act=getUserCount&" + str);
        return baseRest(params);
    };
    exports.getUserCount2 = function (str) {//
        str = str || '';
        var params = {};
        params.url = getUrl("php/hander.php?act=getUserCount2&" + str);
        return baseRest(params);
    };

    exports.geterpName = function () {//
        var params = {};
        params.url = getUrl("php/hander.php?act=erpuser");
        return baseRest(params);
    };

    /**
     * 
     * @param data
     */
    exports.getProjectListByBid = function (key, local_key) {
        var params = {};
        params.dataType = "jsonp";
        var user = localStore.getItem('weidianpat_user');
        if (local_key == "_p") {//
            params.data = {bid: key};
            params.url = "//wq.jd.com/martweb/mcoss/remoteSearchProjectListByBid.jsonp?g_tk=" + $getToken();
        } else if (local_key == "_a") {//
            params.data = {projectid: key, venderid: user.venderid};
            params.url = "//wq.jd.com/martweb/mcoss/remoteSearchActiveListByProjectId.jsonp?g_tk=" + $getToken();
        } else if (local_key == "_q") {//
            params.data = {activeid: key, venderid: user.venderid};
            params.url = "//wq.jd.com/martweb/mcoss/remoteSearchAreaListByActiveId.jsonp?g_tk=" + $getToken();
        }
        return $.ajax(params);
    }
});;/**
 * jQuery
 * author: aronhuang
 * require: jquery
 * version: 1.0
 * example: $.popup({...}) or new Popup({...})
 * ie6
 */
define("mmrp.popup",function(require, exports, module) {

    var $ = require('jquery');

    /**
	 * Class Slider
	 */
	var Popup = function(options){
		this.options = $.extend({}, Popup.defaults, options);
		this._init();
	}

	/*
	 * Popup
	 * @private
	 */
	Popup._list = {};


	/**
	 * prototype
	 */
	Popup.prototype = {
		constructor: Popup,

		/*
		 * 
		 * @private
		 * @return {string}
		 */
		_getTemplate: function(){
			var opts = this.options, tpl, cls = opts.className;
			//TODO 
			tpl = [
				'<div class="{container}">',
					'<div class="{hd}">',
						'<h3 class="{title}"></h3>',
					'</div>',
					'<div class="{bd}"></div>',
					'<div class="{ft}"></div>',
					'<a class="{close}" href="javascript:void(0);"></a>',
				'</div>'
			].join('');
			return tpl.replace(/\{([\w]+)\}/g, function(match, key){
				return cls[key] || '';
			}); 
		},

		/*
		 * 
		 * @private
		 */
		_init: function(){
			var opts = this.options, tpl, cls = opts.className, self = this;
			this.id = opts.id || 'Popup' + new Date().getTime();
			//id
			if (Popup._list[this.id]) {
				return ;
			}
			Popup._list[this.id] = this;
			tpl = this._getTemplate();
			this.container = $(tpl).appendTo('body');
			this.hd = this.container.find('.' + cls.hd);
			this.title = this.container.find('.' + cls.title);
			this.bd = this.container.find('.' + cls.bd);
			this.ft = this.container.find('.' + cls.ft);
			this.closeBtn = this.container.find('.' + cls.close);
			this.container.attr('id', this.id);
			this.hasMask = opts.mask;
			this.zIndex = opts.zIndex;
			this.onShow = opts.onShow;
			this.onClose = opts.onClose;
			this._render();
			this._bindEvent();
			this.show();
			if (opts.autoClose) {
				window.setTimeout(function(){
					self.close();
				}, opts.autoClose);
			}
		},

		/*
		 *   
		 * @private
		 */
		_render: function(){
			var opts = this.options;
			this._setTitle();
			this._setContent();
			this._setButtons();
			this._setSize();
			this._setPosition();
			this.setZIndex(this.zIndex);
			if (!opts.closeable) {
				this.closeBtn.hide();
			}
		},

		/*
		 * 
		 * @private
		 */
		_setTitle: function(){
			var title = this.options.title;
			if (title === false) {
				this.hd.hide();
			} else {
				this.title.text(title);
			}
		},

		/*
		 * 
		 * @private
		 */
		_setContent: function(){
			var opts = this.options, content = opts.content, type = opts.contentType;
			switch(type){
				case 'html': 
					this.bd.append(content);
					break ;
				case 'selector':
					this._addDomContent();
					break ;
				case 'iframe':
					this._addIframeContent();
					break ;
				default:
					this.bd.append(content);
			}
			
		},

		/*
		 * 
		 * this._restoreContent()destroy
		 * @private
		 */
		_addDomContent: function(){
			var content = $(this.options.content),
				display = content.css('display'),
				prev = content.prev(),
				next = content.next(),
				parent = content.parent(); 
			this._restoreContent = function(){
				if (prev.length !== 0) {
					content.insertAfter(prev);
				} else if (next.length !== 0) {
					content.insertBefore(next);
				} else {
					content.appendTo(parent);
				}
				content.css('display', display);
				this._restoreContent = null;
			};
			content.show().appendTo(this.bd);
		},

		/*
		 * iframe
		 * @private
		 */
		_addIframeContent: function(){
			var opts = this.options, content = opts.content, type = opts.contentType, self = this;
			this.bd.addClass(opts.className.loading);
			content = $('<iframe src="' + content + '" allowtransparency="true" height="100%" width="100%" frameborder="0"></iframe')
			.hide()
			.appendTo(this.bd)
			.on('load', function(e){
				content.show();
				self.bd.removeClass(opts.className.loading);
			});
		},


		/*
		 * 
		 * @private
		 */
		_setButtons: function(){
			var opts = this.options, btns = this.options.buttons, self = this;
			if (!$.isArray(btns) || btns.length == 0) {
				this.ft.hide();
				return ;
			}
			$.each(btns, function(idx, row){
				var cls = opts.className.btn + (row.className ? ' ' + row.className : ''); 
				var btn = $('<a href="javascript:void(0);"></a>').text(row.text).addClass(cls).appendTo(self.ft);
				if (row.focus) {
					btn.focus();
				}
			});
			this.ft.css('text-align', opts.buttonsAlign);
			this.buttons = this.ft.find('.' + opts.className.btn);
		},

		/*
		 * 
		 * @private
		 */
		_setSize: function(){
			var opts = this.options, height = parseInt(opts.height), width = parseInt(opts.width);
			if(!isNaN(height)){
				this.bd.height(height);
			}
			if(!isNaN(width)){
				this.bd.width(width);
			}
		},

		/*
		 * 
		 * @private
		 */
		_setPosition: function(){
			var opts = this.options,
				isFixed = opts.fixed, 
				left = parseInt(opts.left, 10),
				top = parseInt(opts.top, 10),
				win = $(window), 
				viewWidth = win.width(),
				viewHeight = win.height(),
				width = this.container.outerWidth(),
				height = this.container.outerHeight(),
				scrollLeft = win.scrollLeft(),
				scrollTop = win.scrollTop();

			if(isNaN(left)){
				left = (viewWidth - width)/2 + (isFixed ? 0 : scrollLeft);
				left - left < 0 ? 0 : left;
			}
			if(isNaN(top)){
				top = (viewHeight - height)/2 + (isFixed ? 0 : scrollTop);
				top = top < 0 ? 0 : top;
			}
			this.container.css({
				position: isFixed ? 'fixed' : 'absolute',
				left: left,
				top: top
			});
		},

		/*
		 * 
		 * @public
		 */
		top: function(){
			var zIndex = this.zIndex;
			for( id in Popup._list){
				var instance = Popup._list[id];
				if (!instance.isShow || instance === this) {
					continue ;
				}
				if (instance.zIndex >= zIndex) {
					zIndex = instance.zIndex + 1;
				}
			}
			if (zIndex !== this.zIndex) {
				this.setZIndex(zIndex);
			}
		},

		/*
		 * zIndex
		 * @public
		 */
		setZIndex: function(zIndex){
			this.zIndex = zIndex;
			this.container.css('z-index', zIndex);
		},

		/*
		 * 
		 * @private
		 */
		_bindEvent: function(){
			var opts = this.options, self = this;
			//
			if (opts.closeable) {
				this.closeBtn.on('click', function(e){
					e.preventDefault();
					self.close();
				});
			}

			//
			if (this.buttons) {
				$.each(this.buttons, function(idx){
					var handler = opts.buttons[idx].handler;
					$(this).on('click', function(e){
						e.preventDefault();
						if (typeof handler !== 'function') {
							self.close()
						} else {
							handler() === true ?  self.close() : null;
						}
					});
				});
			}
			

			//
			if (opts.dragable) {
				this.hd.css('cursor', 'move');
				this.hd.on('mousedown', function(e){
					self._dragStart(e);
				});
			}

			//
			this.container.on('mousedown', function(){
				self.top();
			});

		},

		/*
		 *  start
		 * @private
		 */
		_dragStart: function(e){
			var self = this;
			this.startX = e.pageX;
			this.startY = e.pageY;
			$(document).on('mousemove.' + this.id, function(e){
				self._dragMove(e);
			}).on('mouseup.' + this.id, function(e){
				self._dragEnd(e);
			});
			//iframe
			if (this.options.contentType === 'iframe') {
				if (this.dragMask) {
					this.dragMask.show();
				} else {
					var bd = this.bd,
					height = bd.outerHeight(),
					width = bd.outerWidth(),
					position = bd.position(),
					left = position.left,
					top = position.top;
					this.dragMask = $('<div />').css({
						height: height,
						width: width,
						position: 'absolute',
						left: left,
						top: top
					}).appendTo(this.container);
				}
			}
		},

		/*
		 *  move
		 * @private
		 */
		_dragMove: function(e){
			var position = this.container.position(), 
			left, top,
			isFixed =this.options.fixed,
			deltaX = e.pageX - this.startX,
			deltaY = e.pageY - this.startY,
			maxLeft = $(window).width() - this.container.outerWidth() + (isFixed ? 0 : $(window).scrollLeft()),
			maxTop = $(window).height() - this.container.outerHeight() + (isFixed ? 0 : $(window).scrollTop());
			left = position.left + deltaX;
			top = position.top + deltaY;

			//
			left = left < 0 ? 0 : left > maxLeft ? maxLeft : left;
			top = top < 0 ? 0 : top > maxTop ? maxTop : top;

			this.container.css({
				left: left,
				top: top
			});
			this.startX = e.pageX;
			this.startY = e.pageY;
		},

		/*
		 *  end
		 * @private
		 */
		_dragEnd: function(e){
			$(document).off('mousemove.' + this.id).off('mouseup.' + this.id);
			//
			if (this.dragMask) {
				this.dragMask.hide();
			}
		},

		/*
		 * 
		 * @public
		 */
		show: function(){
			if (this.isShow) {
				return ;
			}
			if (typeof this.onShow === 'function') {
				this.onShow();
			}
			this.container.show();
			if (this.hasMask) {
				Popup.mask.show();	
			}
			this.isShow = true;
		},

		/*
		 * 
		 * @public
		*/
		hide: function(){
			if (!this.isShow) {
				return ;
			}
			var closeMask = true;
			this.container.hide();
			if (this.hasMask) {
				//
				for(id in Popup._list){
					var instance = Popup._list[id];
					if (instance !== this && instance.hasMask && instance.isShow) {
						closeMask = false;
						break ;
					}
				}
				if (closeMask) {
					closeMask && Popup.mask.hide();
				}
			}
			this.isShow = false;
		},

		/*
		 * 
		 * destroyAfterClose
		 * @public
		*/
		close: function(){
			if (typeof this.onClose ==='function') {
				this.onClose();
			}
			if (this.options.destroyAfterClose) {
				this.destory();
			} else {
				this.hide();
			}
		},

		/*
		 * 
		*/
		destory: function(){
			this.hide();
			//
			if (this._restoreContent) {
				this._restoreContent();
			}
			this.container.remove();
			delete Popup._list[this.id];
		}

	}


	/*
	 * Popup	
	 */
	Popup.mask = {

		isShow: false,

		layer: null,

		show: function(){
			if (this.isShow) {
				return ;
			}
			if(!this.layer){
				this.layer = $('<div />').css({
					position: 'fixed',
					left: 0,
					top: 0,
					height: '100%',
					width: '100%',
					background: '#000',
					opacity: '0.2',
					zIndex: 999
				}).appendTo('body');
			}
			this.layer.show();
			this.isShow = true;
		},

		hide: function(){
			if (!this.isShow || !this.layer) {
				return ;
			}
			this.layer.hide();
			this.isShow = false;
		},

		setStyle: function(background, opacity){
			this.layer.css({
				background: background,
				opacity: opacity
			});
		},

		setZIndex: function(zIndex){
			this.layer.css('z-Index', zIndex);
		}
	}





	/**
	 * default options
	 */
	Popup.defaults = {
		id: '',
		className: {
			container: 'ui_popup',
			hd: 'ui_popup_hd',
			title: 'ui_popup_tit',
			bd: 'ui_popup_bd',
			ft: 'ui_popup_ft',
			close: 'ui_popup_close',
			btn: 'ui_btn',
			loading: 'loading'
		},
		title: '',
		content: '',
		contentType: 'html',
		width: '',
		height: '',
		left: '',
		top: '',
		mask: true,
		dragable: true,
		closeable: true,
		zIndex: 1001,
		fixed: true,
		buttons: null, //[{text:'', handler: function(){}, focus: true, className: 'popup_btn_xx'}]
		buttonsAlign: 'right',
		destroyAfterClose: true,
		autoClose: false 
	};

    module.exports = Popup;
	
});


	

;define("jquery.field",[], function() { return function(jQuery) {
  
/**code start**/
/*
 * jQuery Field Plug-in
 *
 * Copyright (c) 2007 Dan G. Switzer, II
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function($) {
	var defaults = {
		delimiter: ","
	};
	     
	$.fn.getValue = function(){
		// return the values as a comma-delimited string
		return getValue(this).join(defaults.delimiter);
	};	
	
	/**
	 * 
	 */
	$.fn.clearForm = function() {
	 return this.each(function() {
	  var type = this.type, tag = this.tagName.toLowerCase();
	  if (tag == 'form')
	   return $(':input',this).clearForm();
	  if (type == 'text' || type == 'password' || type == 'hidden' || type == 'number' || tag == 'textarea' || type == 'color')
	   this.value = '';
//	  else if (type == 'checkbox' || type == 'radio'){
//			this.checked = false;
////			ulog.info($(this).closest("label"),'$(this).closest("label")')
////			$(this).closest("label").removeClass("bg_input_current");
//		}
//	  else if (tag == 'select')
//	   this.selectedIndex = 0;
	 });
	};

	var getValue = function(jq){
		var v = [];

		jq.each(
			function (lc){
				// get the current type
				var t = getType(this);

				switch( t ){
					case "checkbox": case "radio":
						// if the checkbox or radio element is checked
						if( this.checked ) v.push(this.value);
					break;

					case "select":
						if( this.type == "select-one" ){
							v.push( (this.selectedIndex == -1) ? "" : getOptionVal(this[this.selectedIndex]) );
						} else {
							// loop through all element in the array for this field
							for( var i=0; i < this.length; i++ ){
								// if the element is selected, get the selected values
								if( this[i].selected ){
									// append the selected value, if the value property doesn't exist, use the text
									v.push(getOptionVal(this[i]));
								}
							}
						}
					break;

					case "text":
						v.push(this.value);
					break;
				}
			}
		);

		// return the values as an array
		return v;
	};

	$.fn.setValue = function(v){
		// f no value, set to empty string
		return setValue(this, ((!v && (v !== 0)) ? [""] : v.toString().split(defaults.delimiter)));
	};

	var setValue = function(jq, v){
		jq.each(
			function (lc){
				var t = getType(this), x;

				switch( t ){
					case "checkbox": case "radio":
						if( valueExists(v, this.value) ) this.checked = true;
						else this.checked = false;
					break;

					case "select":
						var bSelectOne = (this.type == "select-one");
						var bKeepLooking = true; // if select-one type, then only select the first value found
						// loop through all element in the array for this field
						for( var i=0; i < this.length; i++ ){
							x = getOptionVal(this[i]);
							bSelectItem = valueExists(v, x);
							if( bSelectItem ){
								this[i].selected = true;
								// if a select-one element
								if( bSelectOne ){
									// no need to look farther
									bKeepLooking = false;
									// stop the loop
									break;
								}
							} else if( !bSelectOne ) this[i].selected = false;
						}
						// if a select-one box and nothing selected, then try to select the default value
						if( bSelectOne && bKeepLooking && !!this[0] ){
							this[0].selected = true;
						}
					break;

					case "text":
						this.value = v.join(defaults.delimiter);
					break;
				}

			}
		);

		return jq;
	};
	
	// determines how to process a field
	var getType = function (el){
		var t = el.type;

		switch( t ){
			case "select": case "select-one": case "select-multiple":
				t = "select";
				break;
			case "text": case "hidden": case "textarea": case "password": case "button": case "submit": case "submit": case "number": case "color":
				t = "text";
				break;
			case "checkbox": case "radio":
				t = t;
				break;
		}
		return t;
	};
	
	// gets the value of a select element
	var getOptionVal = function (el){
		 return el.value;
	};
	
	// checks to see if a value exists in an array
	var valueExists = function (a, v){
		return ($.inArray(v, a) > -1);
	};

})(jQuery);   
/**code end**/
  
  
}});


;define("mmrp.func",function(require, exports, module) {
    
    var $ = require('jquery'),
    	RestApi = require('mmrp.rest'),
    	localStore = require('localStore'),
    	c = require('mmrp.config.user'),
        PopUp = require('mmrp.popup');

    require('jquery.cookie')($);
    require('jquery.field')($);

	//
	exports.MOD_FILTER = {
		'TEST': [],
		'POP-ZZ': ['goods_list', 'goods_link'],//pop
		'ZY': ['goods_list', 'goods_link'],//
		'POP-FZZ': ['goodcg_list', 'mod_collocation'],//pop
		'1212': ["mod_share_mask", "mod_fixedtab", "store_entrance"],//12
		'618': ["mod_share_mask", "mod_fixedtab", "store_entrance", "mod_fixedtoptabs", "mod_countdown", "mod_actAppointment"]//618
	};
	exports.filterArray=[];
	exports.toWeidianArray=[];
	exports.toWDTab5 = [];
	exports.toWDTab3 = [];
	exports.isFeiZiZhu = true;
	exports.init = function(){
		window.$_ajax = exports.ajax;
		return RestApi.getUrlLimitList().done(function(data){
			if(data != null && data.length > 0){
				data.filter(function(item){
					if(!item) return false;
					if(item.url_status == 2){
						exports.filterArray.push(item);
					}else if(item.url_status == 3){
						exports.toWeidianArray.push(item.url_name);
						exports.toWDTab3.push(item.url_name);
					} else if(item.url_status == 4){
						exports.toWeidianArray.push(item.url_name);
						exports.toWDTab5.push(item.url_name);
					}
				})
			}
		});
	}
	exports.ajax =  function(options){
		if(!options||!options.url)return false;
		if(options.url.indexOf("g_tk")<0&&(!options.data||!options.data.g_tk)){
			options.url =options.url+ (options.url.indexOf("?")>0?"&":"?")+"g_tk="+exports.$getToken();
		}
		return $.ajax(options);
	}
   	/**
	 * 
	 */
	exports.getUserName  = function(){
		//var userName = $.cookie("userName");

		var userName = localStore.getItem('weidianpat_user')['shop_name'];
		if(!userName){
			console.warn('userName is empty');	
		}
		return userName;
	};
	exports.useGoodModel=function(pageid){
		RestApi.copyActivityById(pageid).done(function(data2){
			if(!data2||data2.errorCode!=0||!data2.page_id){
				exports.alertLoading("");
				return;
			}
			var url = "//"+window.location.host+window.location.pathname+"?id="+data2.page_id;
			window.open(url,"_self");
		});
	}
	/**
	 * pop
	 */
	exports.is_pop_shop  = function(){
		//var userName = $.cookie("userName");

		var is_pop_shop = localStore.getItem('weidianpat_user')['shop_type'];
		if(is_pop_shop==4) return true;
		if(is_pop_shop==1){
			if(exports.getUserName()=="youxiumoban"){
				return true;
			}
		}
		return !is_pop_shop;
	};

	/**
	 * 
	 * flag=true   false
	 */
	exports.is_JD_QQ_url  = function(url){
		url = url && url.replace(/^http:/, '') || '';
		if(exports.isFeiZiZhu){
			if(exports.filterArray.length==0){
				exports.init();
				var	reg = /^\/\/((wq|wqs|mkt\.baitiao|s\.jr)\.jd\.com|([0-9 a-z A-Z]*\.weixin\.qq\.com)).*$/i;
				if(reg.test(url)){
					return 1;
				}else{
					return 0;
				}
				return;
			}
			var a = exports.filterArray.filter(function(item){if(url.indexOf(item.url_link.replace('http://', '//'))==0){return true;}});
			return a.length;
		}else{
			var reg = /^\/\/([0-9 a-z A-Z]*\.)*(jd\.com|qq\.com)(\/.*|)$/i;
			if(reg.test(url)){
				return 1;
			}else{
				if(url.indexOf("//wx.fiyta.com.cn/ccns/christmas/christmas_startGame.action")==0){
					return 1;
				}
				return 0;
			}
		}
	};

	/**
	 * 
	 */
	exports.setInfo = function(data){
		localStore.setItem('weidianpat_user', data);
	}

	/**
	 * uin
	 */
	exports.getUserUin = function(){
		var uin = $.cookie("wq_uin");
		return uin;
	};

	exports.getVenderId = function(){
		var uin = exports.getUserUin();
		if(uin==""||uin==null){
			this.alert("");
			return null;
		}
		return uin - 10000000000;
	};
	//
	exports.addMKJCHeadStyle= function(){
		if($("#mod_pub_mkjc").text()==""){
			var css=".twoGoodsList{margin:20px 20px 0;padding:0;width:600px;height:auto;list-style:none}.twoGoodsList li{display:block;position:relative;width:290px;height:430px;margin-bottom:20px;background-color:#fff;float:left}.twoGoodsList li:nth-child(even){float:right}.twoGoodsLI498PX li{height:548px}.twoGoodsLI568Px li{height:568px}.twoGoodImg,.twoGoodImg:active,.twoGoodImg:visited{display:block;width:290px;height:290px;position:relative}.twoGoodImg img{border:0 none;width:100%;height:100%}.twoGoodInfo{margin:20px auto 0;width:250px;display:block;padding:0}.twoGoodInfo h2{font-weight:400;font-size:24px;line-height:1.5;height:72px;padding:0;margin:20px 0 0;color:#333;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis}.twoGoodInfo h3{font-weight:400;font-size:20px;line-height:30px;padding:0;margin:15px auto;color:#999;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis;height:60px}.twoGoodsList::after{content:'';display:block;clear:both}.label{position:absolute;width:170px;height:40px;line-height:32px;text-align:center;color:#fff;left:-9px;top:20px;background:url(//wq.360buyimg.com/fd/promote/2015/plugin/images/label.png) 0 0 no-repeat;background-size:100% 100%}.oneGoodPrice{font-size:24px;color:#e4393c;display:block;line-height:24px;margin-top:10px}.oneGoodPriceMT38px{margin-top:38px}.oneGoodChk{-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;outline:0 none;display:block;width:60px;height:60px;position:absolute;margin:0;padding:0;right:0;bottom:0;border:0 none;background-color:transparent;-webkit-tap-highlight-color:transparent}.oneGoodChk::before{content:'';display:block;width:0;height:0;border:30px solid transparent;border-right-color:#ddd;border-bottom-color:#ddd;position:absolute;right:0;bottom:0}.oneGoodChk::after{content:'';display:block;width:20px;height:12px;border:2px solid transparent;border-left-color:#fff;border-bottom-color:#fff;position:absolute;left:50%;top:50%;-webkit-transform:rotate(-45deg)}.oneGoodChk:checked::before{content:'';border-right-color:#e43a3d;border-bottom-color:#e43a3d}.goodsFooter{position:relative;background-color:#eee;padding:14px 20px;margin:20px auto;border-top:1px solid #dedede;font-size:20px;line-height:1.5;color:#999}.goodsFL{display:inline-block;vertical-align:middle;width:410px;height:110px;overflow:hidden}.goodsFL2{display:inline-block;vertical-align:middle;width:460px;height:auto}.goodsFPrice{font-size:28px;color:#333;display:block;margin:0 0 16px;line-height:28px}.goodsFPrice b{color:#e4393c}.goodsFB,.goodsFB:active,.goodsFB:visited{display:inline-block;width:190px;height:80px;line-height:80px;color:#fff;background-color:#e4393c;border-radius:4px;text-align:center;text-decoration:none;font-size:28px}.add_cart_tip{font-size:28px;margin-left:-90px;padding:5px 10px;background:rgba(0,0,0,.7);display:none;color:#fff;text-align:center;position:fixed;top:50%;left:50%;z-index:25;border-radius:4px;-webkit-box-shadow:0 0 3px 3px rgba(150,150,150,.7);box-shadow:0 0 3px 3px rgba(150,150,150,.7)}.oneGoodCart{display:block;width:62px;height:62px;border-radius:4px;background:#e4393c url(//wq.360buyimg.com/fd/promote/2015/plugin/images/cart.png) center no-repeat;background-size:32px 32px;margin:-43px 0 0 0;float:right}.goodsFB2,.goodsFB2:active,.goodsFB2:visited{display:inline-block;width:140px;height:80px;line-height:80px;color:#fff;background-color:#e4393c;border-radius:4px;text-align:center;text-decoration:none;font-size:28px}.goodsFB2 em{font-size:20px;font-style:normal}.saleoutMsk{position:absolute;width:100%;height:100%;left:0;top:0;background-color:rgba(0,0,0,.6)}.saleoutIco{position:absolute;width:250px;height:250px;background:url(//img11.360buyimg.com/jdphoto/jfs/t2431/363/991833008/5678/fa7c1007/563879bcNe1f01f49.png) 0 0 no-repeat;background-size:100% 100%;left:50%;top:50%;margin:-125px 0 0 -125px}.saleoutText{position:relative;width:144px;height:88px;padding:10px 0 0 0;margin:75px auto 0;font-size:30px;line-height:1.4;text-align:center;color:#fff;white-space:nowrap}.saleoutText::before{content:'';position:absolute;width:100%;height:200%;left:0;top:0;border-top:1px solid #fff;border-bottom:1px solid #fff;-webkit-transform-origin:left top;-moz-transform-origin:left top;-ms-transform-origin:left top;transform-origin:left top;-webkit-transform:translate3d(0,0,0) scale(1,.5);-moz-transform:translate3d(0,0,0) scale(1,.5);-ms-transform:translate3d(0,0,0) scale(1,.5);transform:translate3d(0,0,0) scale(1,.5)}";
			$("<style />", {
				id: "mod_pub_mkjc",
				"class": 'js_mod_style'
			}).append(css).appendTo("head");
		}
	};
	//
	exports.addJCMJHeadStyle=function(){
		if($("#mod_pub_jcmj").text()!=""){
			$("#mod_pub_jcmj").attr("data-num",+$("#mod_pub_jcmj").attr("data-num")+1);
			return;
		}
		var css = ".twoGoodsList{margin:20px 20px 0;padding:0;width:600px;height:auto;list-style:none}.twoGoodsList li{display:block;position:relative;width:290px;height:430px;margin-bottom:20px;background-color:#fff;float:left}.twoGoodsList li:nth-child(even){float:right}.twoGoodsLI498PX li{height:548px}.twoGoodsLI568Px li{height:568px}.twoGoodImg,.twoGoodImg:active,.twoGoodImg:visited{display:block;width:290px;height:290px;position:relative}.twoGoodImg img{border:0 none;width:100%;height:100%}.twoGoodInfo{margin:20px auto 0;width:250px;display:block;padding:0}.twoGoodInfo h2{font-weight:400;font-size:24px;line-height:1.5;height:72px;padding:0;margin:20px 0 0;color:#333;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis}.twoGoodInfo h3{font-weight:400;font-size:20px;line-height:30px;padding:0;margin:15px auto;color:#999;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis;height:60px}.twoGoodsList::after{content:'';display:block;clear:both}.label{position:absolute;width:170px;height:40px;line-height:32px;text-align:center;color:#fff;left:-9px;top:20px;background:url(//wq.360buyimg.com/fd/promote/2015/plugin/images/label.png) 0 0 no-repeat;background-size:100% 100%}.oneGoodPrice{font-size:24px;color:#e4393c;display:block;line-height:24px;margin-top:10px}.oneGoodPriceMT38px{margin-top:38px}.oneGoodChk{-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;outline:0 none;display:block;width:60px;height:60px;position:absolute;margin:0;padding:0;right:0;bottom:0;border:0 none;background-color:transparent;-webkit-tap-highlight-color:transparent}.oneGoodChk::before{content:'';display:block;width:0;height:0;border:30px solid transparent;border-right-color:#ddd;border-bottom-color:#ddd;position:absolute;right:0;bottom:0}.oneGoodChk::after{content:'';display:block;width:20px;height:12px;border:2px solid transparent;border-left-color:#fff;border-bottom-color:#fff;position:absolute;left:50%;top:50%;-webkit-transform:rotate(-45deg)}.oneGoodChk:checked::before{content:'';border-right-color:#e43a3d;border-bottom-color:#e43a3d}.goodsFooter{position:relative;background-color:#eee;padding:14px 20px;margin:20px auto;border-top:1px solid #dedede;font-size:20px;line-height:1.5;color:#999}.goodsFL{display:inline-block;vertical-align:middle;width:410px;height:110px;overflow:hidden}.goodsFL2{display:inline-block;vertical-align:middle;width:460px;height:auto}.goodsFPrice{font-size:28px;color:#333;display:block;margin:0 0 16px;line-height:28px}.goodsFPrice b{color:#e4393c}.goodsFB,.goodsFB:active,.goodsFB:visited{display:inline-block;width:190px;height:80px;line-height:80px;color:#fff;background-color:#e4393c;border-radius:4px;text-align:center;text-decoration:none;font-size:28px}.add_cart_tip{font-size:28px;margin-left:-90px;padding:5px 10px;background:rgba(0,0,0,.7);display:none;color:#fff;text-align:center;position:fixed;top:50%;left:50%;z-index:25;border-radius:4px;-webkit-box-shadow:0 0 3px 3px rgba(150,150,150,.7);box-shadow:0 0 3px 3px rgba(150,150,150,.7)}.saleoutMsk{position:absolute;width:100%;height:100%;left:0;top:0;background-color:rgba(0,0,0,.6)}.saleoutIco{position:absolute;width:250px;height:250px;background:url(//img11.360buyimg.com/jdphoto/jfs/t2431/363/991833008/5678/fa7c1007/563879bcNe1f01f49.png) 0 0 no-repeat;background-size:100% 100%;left:50%;top:50%;margin:-125px 0 0 -125px}.saleoutText{position:relative;width:144px;height:88px;padding:10px 0 0 0;margin:75px auto 0;font-size:30px;line-height:1.4;text-align:center;color:#fff;white-space:nowrap}.saleoutText::before{content:'';position:absolute;width:100%;height:200%;left:0;top:0;border-top:1px solid #fff;border-bottom:1px solid #fff;-webkit-transform-origin:left top;-moz-transform-origin:left top;-ms-transform-origin:left top;transform-origin:left top;-webkit-transform:translate3d(0,0,0) scale(1,.5);-moz-transform:translate3d(0,0,0) scale(1,.5);-ms-transform:translate3d(0,0,0) scale(1,.5);transform:translate3d(0,0,0) scale(1,.5)}";
		$("<style />", {
			id: "mod_pub_jcmj",
			"class": 'js_mod_style',
			"data-num": 1
		}).append(css).appendTo("head");
	};
	//LOGO
	exports.addStoreLogo = function(){
		if($("#mod_pub_storelogo").text()==""){
			var css = ".entry_h{position: relative; padding:0 20px;width:600px; height: 140px; margin: 0 auto; background-color: #fff; display: -webkit-box; display: -moz-box; display: -ms-flexbox; display: box; -webkit-box-orient:horizontal; -webkit-box-align:center;box-align:center;}.entry_logo{position: relative; width: 124px; height: 60px; overflow: hidden;}.entry_logo::before{content: ''; display: inline-block; width: 0px; height: 100%; vertical-align: middle;}.entry_logo img{width: 100%; border: 0 none;}.entry_slogan{position: relative; -webkit-box-flex:1; -moz-box-flex:1; -ms-flex:1; flex:1; font-size:28px; color: #333; margin: 0 20px; line-height: 40px;}.entry_sub_slogan{font-size: 24px;}.entry_slogan strong{color: #e4393c; font-weight: normal;}.entry_btn,.entry_btn:active,.entry_btn:visited{display: block; width: 136px; height: 46px; overflow: hidden; border: 2px solid #ACACAC; border-radius: 5px; font-size: 24px; color: #7F7F7F; line-height: 46px; text-align: center; text-decoration: none;}";
			$("<style />", {
				id: "mod_pub_storelogo",
				"class": 'js_mod_style'
			}).append(css).appendTo("head");
		}
	};
	//
	exports.addFixedTabLeft = function(){
		if($("#mod_pub_fixedtableft").text()==""){
			var css = ".temp_side_fix{z-index:99;}.temp_side_fix.fixed{position:fixed;left:0;max-width:50%;}.temp_side_fix .nav_btn_panel{height:60px;line-height:60px;min-width:125px;font-size:24px;text-align:center;border:1px solid #eee;width:100%;float:left;background:rgba(0,0,0,0.1);}.temp_side_fix .temp_nav_inner .item{height:60px;line-height:60px;font-size:22px;text-align:center;border-bottom:1px solid #eee;width:100%;float:left;overflow:hidden;}.temp_side_fix .temp_nav_inner .item.on{color:red !important}.temp_side_fix .nav_btn_panel span{vertical-align:middle;position:relative;width:100%;display:block;overflow:hidden;height:100%;word-break:break-all;}.temp_side_fix .nav_btn_panel span:after{position:absolute;top:50%;width:12px;height:12px;right:2px;margin-top:-8px;transition:.2s linear;border-top:4px solid #7d7d7d;border-left:4px solid #7d7d7d;background:none;content:'\20';display:block;-webkit-transform:rotate(45deg);border-color:#ccc;}.temp_side_fix .nav_btn_panel span.down:after{-webkit-transform:rotate(-135deg);}";
			//css+=".temp_side_fix.two span,.temp_side_fix.two a{color:#fff;}.temp_side_fix.two .nav_btn_panel{background:rgba(0,0,0,0.3);}.temp_side_fix.two .item{background:rgba(0,0,0,0.2);}";
			$("<style />", {
				id: "mod_pub_fixedtableft",
				"class": 'js_mod_style'
			}).append(css).appendTo("head");
		}
	}
	/**
	 * skey
	 */
	exports.getUserSkey  = function(){
		var skey = $.cookie("wq_skey");
		return skey;
	};

	/**
	 * skey
	 */
	 exports.isLocal = function(){
	 	return window.location.href.indexOf('localhost') > -1 || window.location.href.indexOf('wdpatdev') ? true : false;
	 }

	 /**
	 * 
	 */
	 src = {
	 	img : function(){
	 		var venderid = exports.getUserUin() - 10000000000;
	 		var saleid = exports.getUrlParam("id");
	 		return c.upload_files + (venderid%1000) + '/' + venderid + '/' + saleid + '/img/';
	 	},
	 	previewimg : function(){
	 		var venderid = exports.getUserUin() - 10000000000;
	 		var saleid = exports.getUrlParam("id");
	 		return c.preview_root + (venderid%1000) + '/' + venderid + '/' + saleid + '/img/';
	 	},
	 	index : function(){
	 		var venderid = exports.getUserUin() - 10000000000;
	 		var saleid = exports.getUrlParam("id");
	 		return c.upload_files + (venderid%1000) + '/' + venderid + '/' + saleid;
	 	},
	 	previewindex : function(){
	 		var venderid = exports.getUserUin() - 10000000000;
	 		var saleid = exports.getUrlParam("id");
	 		return c.preview_root + (venderid%1000) + '/' + venderid + '/' + saleid;
	 	},
	 	root : function(){
	 		return c.root + this.index();
	 	}
	}
	 exports.getUoloadsrc = function(name){
	 	return src[name]();
	 }
	function getCookie(c_name) {
	    if (document.cookie.length > 0) {
	        c_start = document.cookie.indexOf(c_name + "=");
	        if (c_start != -1) {
	            c_start = c_start + c_name.length + 1;
	            c_end = document.cookie.indexOf(";", c_start);
	            if (c_end == -1) c_end = document.cookie.length;
	            return unescape(document.cookie.substring(c_start, c_end));
	        }
	    }
	    return "";
	}

    exports.$getToken = function(){
    	var skey=getCookie('skey');
    		token=skey==null?"":$time33(skey);
    	return token;
    };


    function $time33(str){
        //time33
        for(var i = 0, len = str.length,hash = 5381; i < len; ++i){
           hash += (hash << 5) + str.charAt(i).charCodeAt();
        };
        return hash & 0x7fffffff;
    }

	/** 
	 * transform the Date to String according the format pattern
	 * eg: 
	 * (new Date()).format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
	 * (new Date()).format("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18 
	 */  
	exports.dateFormat = function(date,fmt) {
		var o = {
		"M+" : date.getMonth() + 1, 
		"d+" : date.getDate(), 
		"h+" : date.getHours() % 12 == 0 ? 12 : date.getHours()%12, 
		"H+" : date.getHours(), 
		"m+" : date.getMinutes(), 
		"s+" : date.getSeconds(), 
		"q+" : Math.floor((date.getMonth()+3)/3), 
		"S" : date.getMilliseconds() 
		};
		var week = {
		"0" : "\u65e5",
		"1" : "\u4e00",
		"2" : "\u4e8c",
		"3" : "\u4e09",
		"4" : "\u56db",
		"5" : "\u4e94",
		"6" : "\u516d"
		};
		if(/(y+)/.test(fmt)){
			fmt=fmt.replace(RegExp.$1, (date.getFullYear()+"").substr(4 - RegExp.$1.length));
		}
		if(/(E+)/.test(fmt)){
			fmt=fmt.replace(RegExp.$1, ((RegExp.$1.length>1) ? (RegExp.$1.length>2 ? "\u661f\u671f" : "\u5468") : "")+week[date.getDay()+""]);
		}
		for(var k in o){
			if(new RegExp("("+ k +")").test(fmt)){
				fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
			}
		}
		return fmt;
	};
	
	/**
	 * 
	 */
	exports.getNowTime = function(){
		 return exports.dateFormat(new Date(),"yyyy-MM-dd HH:mm:ss");
	};

	exports.randomString = function(length) {
	    var chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz'.split('');
	    
	    if (! length) {
	        length = Math.floor(Math.random() * chars.length);
	    }
	    
	    var str = '';
	    for (var i = 0; i < length; i++) {
	        str += chars[Math.floor(Math.random() * chars.length)];
	    }
	    return str;
	}

	/*
	 *
	 *
	 */
	exports.getPageHeight = function(s){
		var s_wraper = s || '#js_act_content';
		var _nh = 0,_maxh = _nh, _top, _h, _temph;
		var _bg = $('#js_act_bg').height();
		var hasfixedtab = 0;
		$(s_wraper + ' .edit_area').each(function(idx, el){
			if($(el).find('.fixed_tabs').length <= 0){
				_top = parseInt($(el).css('top'));
				_h = parseInt($(el).css('height'));				
				/*if( $(el).find('.mod_tab').length > 0 ){
					_h = $($(el).find('.mod_tab .hproduct').get(0)).height();
				}*/
				_temph = _top + _h;
				if(_maxh < _temph) {
					_maxh = _temph;
				}
			}else{
				hasfixedtab = parseInt($(el).css('height'));
			}
		});
		_maxh = _maxh > _bg ? _maxh : _bg;
		if(hasfixedtab){
			_maxh = _maxh + hasfixedtab;
		}
		return _maxh;
	}


	/**
	 * URL
	 * //example getUrlParam('id') or getUrlParam('id','#')
	 */
	exports.getUrlParam = function(){
		var url = top.window.location.href;
		var u, params, StrBack = '', gg;
		if (arguments[arguments.length - 1] == "#") 
			u = url.split("#");
		else 
			u = url.split("?");
		if (u.length == 1) 
			params = '';
		else 
			params = u[1];
		
		if (params != '') {
			gg = params.split("&");
			var MaxI = gg.length,
			str = arguments[0] + "=";
			for (i = 0; i < MaxI; i++) {
				if (gg[i].indexOf(str) == 0) {
					StrBack = gg[i].replace(str, "");
					break;
				}
			}
		}
		return StrBack;
	};
	
	/**
	 * URL
	 * //example getUrlParam('id') or getUrlParam('id','#')
	 */
	exports.getParam = function(url,key){
		var u, params, StrBack = '', gg;
		u = url.split("?");
		if (u.length == 1) 
			params = '';
		else 
			params = u[1];
		
		if (params != '') {
			gg = params.split("&");
			var MaxI = gg.length,
			str = key + "=";
			for (i = 0; i < MaxI; i++) {
				if (gg[i].indexOf(str) == 0) {
					StrBack = gg[i].replace(str, "");
					break;
				}
			}
		}
		return StrBack;
	};

	/**
	 * URL 
	 * html5 history.pushState
	 */
	exports.setUrlParam = function(param,value,title){
		var search = location.search,
			pathname = location.pathname || '',
			title = title || '';

		if(search && search!="?" ){
			var p_val = exports.getUrlParam(param);
			//
			if(p_val){
				search = search.replace( param+"="+p_val, param+"="+value );
				history.pushState('', '', pathname + search);
			}else{
				search = search + "&" + param+"="+value;
				history.pushState('', '', pathname + search);
			}
		}else{
			history.pushState(title, '', pathname + "?" +param+"="+value);
		}
	};
	
	/***
	 * radio checkbox 
	 * @param {Object} $input
	 */
	exports.setInputClass = function($input){
		var $tgt = $input;
			if ($tgt.attr("type") == "radio") {
				var name = $tgt.attr("name");
				$('input[type="radio"][name="' + name + '"]').closest("label").removeClass("btn-success");
				$tgt.closest("label").addClass("btn-success");
			}
			else 
				if ($tgt.attr("type") == "checkbox") {
//					ulog.info("$tgt",$tgt,$tgt.attr('checked'))
					if ($tgt.attr('checked')) {
						$tgt.closest("label").addClass("btn-success");
					}
					else {
						$tgt.closest("label").removeClass("btn-success");
					}
				}
	};
	
	/**
	 * 
	 * @param {Object} reallyDo
	 * @param {Object} replaceWith
	 * @param {Object} ignoreCase
	 */
	exports.replaceAll = function(str ,reallyDo, replaceWith, ignoreCase) {   
        if (!RegExp.prototype.isPrototypeOf(reallyDo)) {
	        return str.replace(new RegExp(reallyDo, (ignoreCase ? "gi": "g")), replaceWith);   
	    } else {   
	        return str.replace(reallyDo, replaceWith);   
	    }   
	};
	
	/**
	 * 
	 */
	exports.clearSort = function(arr){  
	    var temp={},result=[];  
	    for(var i=0;i<arr.length;i++){  
	        if(!temp[arr[i]]){  
	            result.push(arr[i]);  
	            temp[arr[i]]=true;  
	        }  
	    }  
	    return result;  
	};
	
	/**
	 *  
	 */
	exports.checkPower = function(){
		var req = RestApi.getUserPower();
		req.success(function(data){
			var power = parseInt(data.user_power,10); 
			if(power>=20){
				$("#js_power_statistics").show();
				$("#js_admin").show();
			};
		});
		return req;
	};
	
	/**
	 *  
 * @param {Object} authorizer
	 */
	exports.checkAuthorizer = function(authorizer){
		var user_name = exports.getUserName(),
			check = false,
			authorizer = authorizer || false;
		if(authorizer && authorizer.indexOf(user_name) !== -1){
			//	
			check = true;
		};
		
		return check;
	};
	
	/**
	 * 
	 */
	exports.validate = function(container){
		var _validate = true,
				error = 0;
		$(":input[data-validate]",container).each(function(){
			//
			!$(this).val() && error++;
		});
		
		error && (_validate = false);
		
		return _validate;
	};
	
	/**
	 * 
	 */
	exports.validateEvent = function(container){
		
		var rules = {
			required:{
				regex:/^\s*$/,
				error:''
			}
		};
		
		$('.control-group',container).on({
			'focusin':function(){
				var $this = $(this);
				$this.addClass('warning').find('.help-inline').show();
			},
			'focusout':function(){
				var $this = $(this),
					$input = $this.find(':input:not(select)'),
					val = $input.val(),
					rule = $input.attr('data-validate');
				$this.removeClass('warning');
				if(rule){
					var regex = new RegExp(rules[rule]['regex']);
					//
					if(!regex.test(val)){
						$this.removeClass('error').addClass('success').find('.help-inline').text('');
					}else{
						$this.addClass('error').find('.help-inline').text(rules[rule]['error'])
					}
				}else if(val){
					$this.removeClass('error').addClass('success').find('.help-inline').text('');
				}else{
					$this.find('.help-inline').hide();
				}
			}
		});
	};
	
	exports.insertUser = function(callback){
		var uin = exports.getVenderId();
		RestApi.insertUser(uin).done(function(data){
			callback&&callback(data);
        });
	}
	var delete_cookie = function(name) {
	    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
	};
	exports.checklogin = function(cb){
		//
		var islocal = false;//exports.isLocal();

		if(islocal){
			data = {"is_wx_regis":1,"is_pop_shop":0,"shop_name":"","shopid":66498,"venderid":21157,"shop_type":0,"appid":"wx9dab6f76c80d6cdf","qrcode":"https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=gQGG7zoAAAAAAAAAASxodHRwOi8vd2VpeGluLnFxLmNvbS9xL3BVd3lxUEhsU2Ywd09JdnQzbUNuAAIEICsKVQMEAAAAAA%3D%3D","home_page_url":"//wq.jd.com/mshop/gethomepage?venderid=70277","nick_name":"jdwd","head_pic":"","service_type":1,"verify_type":1,"user_name":"gh_4ffa8c1cf814","alias":""};
			$.cookie("wq_uin", '10000021157');
			exports.setInfo(data);
			cb && cb(data);
		}else{
			//var url = 'http://wq.jd.com/weidian/weixin/GetShopInfo?mode=1' + new Date().getTime();
			//$.get(url, function(data){
			//	data = JSON.parse(data);
			//	if(data.ret == 0 && data.shop_info.venderid > 0){
			//		exports.setInfo(data.shop_info);
			//		cb && cb(data.shop_info);
			//	}else{
			//		delete_cookie('wq_uin');
			//		delete_cookie('wq_skey');
			//		window.location.href = 'http://wqs.jd.com/weidian/login.shtml';//http://wq.jd.com/wdpat/asdfghjkl/wx_tp.htm
			//		return;
			//	}
			//});
			window.checkLoginJsonp = function(data){
				if(data!=null&&data.ret == 0 && data.shop_info.venderid > 0){
					exports.setInfo(data.shop_info);
					cb && cb(data.shop_info);
				}else{
					delete_cookie('wq_uin');
					delete_cookie('wq_skey');
					window.location.href = '//wqs.jd.com/weidian/login.shtml';//http://wq.jd.com/wdpat/asdfghjkl/wx_tp.htm
					return;
				}
			}
			var params = {};
			params.dataType = "jsonp";
			params.url = '//wq.jd.com/weidian/weixin/GetShopInfo?mode=1';
			params.jsonpCallback= 'checkLoginJsonp';
			$.ajax(params);
		}
		
		//
		// $("#js_login_user_name").text(user_name);

	}
	
	/**
	 *  
	 */
	exports.logout = function(){
		$('header').on("click.func",'#js_logout',function(){
			event.preventDefault();
			$.cookie("userName",null,{path: '/'})
			$.cookie("last_login_page",window.location.href,{path: '/'});

			top.location.href = '//ppms.wq.jd.com/php/user_login.php?refer=wxpat/';
			return false;
		});
	};
	
	/**
	 *   
	 */
	exports.getDbData = function(form_id){
		var obj = {};
		$(':input[data-db-name]',form_id).each(function(){
			var $this = $(this),
				key = $this.attr('data-db-name'),
				val = $.trim($this.getValue());
			obj[key] = val;	
		});
		return obj;
	};
	
	exports.setDbData = function(data){
		for(var i in data){
			$(':input[data-db-name="'+ i +'"]').setValue(data[i]);
			//
			if(i=="page_url_name"){
				$.each($("#js_page_type option"),function(k,n){
						if($(n).text()==data[i]){
							$(n).attr("selected",true);
						}}
				);
			}else if(i=="page_layout"){
				exports.setUrlParam('layout_id', data[i]);
				$("#js_item_list_filename").val(data[i]);
			}else if(i=="redirection_time"&&data[i]!=""&&data[i]!=null){
				$("#J_redirectionConfig_flag").html("");
				$("#J_redirection_settings").show();
			}
		}

		//
		if(window.__materiaid){
			$('#js_item_list').prop('disabled', true);
			$("#js_page_type").prop('disabled', true);
		}

	};

    exports.formatData = function(text){
        var data = text;
        if($.type(text) === 'string'){
            //
            text = text.match(/{.*\}/)[0];
            data = $.parseJSON(text);
        }
        return data;
    };
	
	exports.unix_to_datetime = function(unix,isMs) {
		var mseconds = !!isMs?1:1000;
	    var now = new Date(parseInt(unix) * mseconds);
	    return now.toLocaleString().replace(/|/g, "-").replace(//g, " ");
	}
	/**
	 *  
	 */
	exports.initGlobal = function(){
		// exports.checkLogin();
		exports.checklogin();
		// exports.logout();
		// exports.checkPower();
	};


    /**
     * 
     * @type {*|HTMLElement}
     */
    var $alert = $('#J_tips'),
        $confirm = $('#J_confirm'),
        timeId;

    var popMod = function($dom,txt,autoClose,eventname,data){
        eventname = '.' + eventname || '';
        var check = false;
        $dom.addClass('ui_tips_show')
            .find('.J_txt').text(txt).end()
            .find('.J_close').off('click').on('click',function(){
                exports.popClose($dom);
            }).end()
            .find('.J_confirm').off('click').on('click',function(){
                exports.popClose($dom);
                $('body').trigger('confirm' + eventname,data);
                check = true;
            });
        if(autoClose){
            timeId && clearTimeout(timeId);
            timeId = setTimeout(function(){
                exports.popClose($dom);
            },1500)
        }
        return check;
    };

    exports.popClose = function($dom){
        $dom.removeClass('ui_tips_show');
        $dom.trigger('close');
    };

    /**
     * alert
     * @param txt 
     * @param autoClose  
     */
    exports.alert = function(txt,autoClose,eventname){
        if(typeof autoClose === "undefined") autoClose = true;
        popMod($alert,txt,autoClose,eventname)
    };

    /**
     * confim 
     * @param txt
     */
    exports.confirm = function(txt,callback,ops){
        var obj = {
            title: '',
            content: txt,
            width: 300,
            mask: true,
            buttons: [
                {
                    text: '',
                    className:'ui_btn_c',
                    handler: function(){
                        callback && callback();
                        return true;
                    },
                    focus: true
                },{
                    text:'',
                    className:'ui_btn_a'
                }
            ]
        };
        $.extend(obj,ops);
        new PopUp(obj)
    };
	/**
	 * confim 
	 * @param txt
	 */
	exports.confirm2 = function(txt,callback,ops){
		var obj = {
			title: '',
			content: txt,
			width: 300,
			mask: true,
			buttons: [
				{
					text: '',
					className:'ui_btn_c',
					handler: function(){
						callback && callback.ok&&callback.ok();
						return true;
					},
					focus: true
				},{
					text:'',
					className:'ui_btn_a',
					handler: function(){
						callback && callback.cancel&&callback.cancel();
						return true;
					},
				}
			]
		};
		$.extend(obj,ops);
		new PopUp(obj)
	};
    /**
     * 
     */   
    exports.getArrNum = function(arr){
    	var rs = {}, temp, count;
    	for (var i = arr.length - 1; i >= 0; i--) {
    		temp = arr[i];
    		if(rs[temp]){
    			rs[temp] = rs[temp] + 1;
    		}else{
    			rs[temp] = 1;
    		}
    	};
    	return rs;
    };
	/**
	 * 
	 */
	exports.testHeight = function(){
		var _H = $('#js_height_input').val();
		var _h = exports.getPageHeight();
		var updateThemeHeight = function(){
			$('#js_height_input').val(_h);
			$('#J_bgedit').removeClass('on');
			$("#js_mod_container").css({height: _h + 'px'});
			var theme_id = exports.getUrlParam("theme_id");
			if (theme_id && !isNaN(theme_id) && theme_id != 0) {
				var obj = {
					data: {
						table: "tb_theme",
						value: {
							theme_height: _h
						},
						where: "theme_id=" + theme_id
					}
				};
				//theme
				RestApi.postUpdata(obj);
			}
		};

		if(_H > _h){
			exports.confirm2('' + _h + '', {
				ok:function(){
					updateThemeHeight();
			}});
		}else if(_H<_h){//
			updateThemeHeight();
		}
	};
	/**
	 * 
	 * @param text 
	 * @param time 
	 */
	exports.alertLoading = function(text,time){
		$("#J_loading > .J_txt").text(text);
		$("#J_loading").show();
		setTimeout(function () {
			$("#J_loading").hide();
			$("#J_loading > .J_txt").text("...");
		}, time==null?1000:time);
	};

	/**
	 * 
	 * @param tpl 
	 * @param data 
	 *
	 */
	exports.template = function(tpl, data){
		var fn = new Function("obj",
			"var p=[];" +
			"with(obj){p.push('" + tpl
				.replace(/[\r\t\n]/g, " ")
				.split("<%").join("\t")
				.replace(/((^|%>)[^\t]*)'/g, "$1\r")
				.replace(/\t=(.*?)%>/g, "',$1,'")
				.split("\t").join("');")
				.split("%>").join("p.push('")
				.split("\r").join("\\'") + "');} return p.join('');");

		return data ? fn(data) : fn;
	}

});;/**
 * local Stroe
 */
define("mmrp.config.localstore",{
	
	page_info_pre		:"_page_info_pre_2015",									// 
	
	layout_pre			:"_layout_pre_222",										//
	
	layouts				:'_layouts_125',										//layout
	
	mod_list			:'_mod_list_1394',										//
	
	mod_base_list		:'_mod_base_list_1234',									//
	
	mod_cate			:'_mod_cate_12243',										//
	
	page_urls			:'_page_urls_1012',									//

	activity_project    :'_activity_pro_2015'								//

});/**
 *  localStore 
 */
define("mmrp.localstore",function(require, exports, module) {  
    
    var localStore = require('localStore'),
        Fun = require('mmrp.func'),
    	ls = require('mmrp.config.localstore');

    /**
     * tb_layout 
     * @returns {*}
     */
    exports.getLayoutData = function(){
    	return localStore.getItem(ls.layouts);
    };
    
    exports.setLayoutData = function(data){
    	localStore.setItem(ls.layouts,data,30);
    };
    
    /***
     * layout
 	 * @param {Object} layout_id
     */
    exports.getLayoutDataById = function(layout_id){
    	var data = exports.getLayoutData();
    	if(!data) return;
    	var data = data.data.value;
        if(!data.length){
            data = [data];
        }
    	for(var i =0; i < data.length; i++){
    		if(data[i]['layout_id'] == layout_id){
    			return data[i];
    		}
    	}
    };
    
    
    exports.setLayoutDataById = function(layout_id,data){
    	localStore.setItem(ls.layout_pre + layout_id,data,15);
    };

    exports.getPageDataById = function(page_id){
        return window[ls.page_info_pre + page_id];
    };
    
    
    exports.setPageDataById = function(page_id,data){
        //localStorage
        window[ls.page_info_pre + page_id] = data;
        var pageUrlName = data.data.value.page_url_name;
        try{
            Fun.isFeiZiZhu = pageUrlName =="" || Fun.toWDTab5.indexOf(pageUrlName) !== -1 ? false:true;
        }catch(e){}
    };


    /**
     * 
     * @param fromCache
     * @returns {promise}
     */
    exports.getModData = function(fromCache){
        return localStore.getItem(ls.mod_list);
    };

    /**
     * 
     * @param data
     */
    exports.setModData = function(data){
    	//value object array
    	localStore.setItem(ls.mod_list,data,15);
    };

    /**
     * 
     * @param mod_id
     * @returns {*}
     */
    exports.getModDataById = function(mod_id){
//        console.trace();
        var data = exports.getModData();
        if(!data) return;
        data = data.data.value;
        for(var i in data){
            if(data[i]['mod_id'] == mod_id){
                return data[i];
            }
        }
    };

    /**
     * 
     * @returns {*}
     */
    exports.getModBaseData = function(){
    	return localStore.getItem(ls.mod_base_list);
    };
    
    exports.setModBaseData = function(data){
    	//value object array
    	localStore.setItem(ls.mod_base_list,data,15);
    };

    /**
     * 
     * @param mod_id
     * @returns {*}
     */
    exports.getModBaseDataById = function(mod_id){
    	var data = exports.getModBaseData();
    	if(!data) return;
    	for(var i in data){
    		if(data[i]['id'] == mod_id){
    			return data[i];
    		}
    	}
    };
    
    /**
     *  
     */
    exports.getModCateList = function(){
    	return localStore.getItem(ls.mod_cate);
    };
    
    /**
     *  
 * @param {Object} data
     */
    exports.setModCateList = function(data){
    	//value object array
    	localStore.setItem(ls.mod_cate,data,15);
    }
    
   	/**
     *  
     */
    exports.getPageUrls = function(){
    	return localStore.getItem(ls.page_urls);
    };
    
    /**
     *  
 * @param {Object} data
     */
    exports.setPageUrls = function(data){
    	//value object array
    	localStore.setItem(ls.page_urls,data,15);
    }

    /**
     * 
     * @param key key
     */
    exports.getProjectListByBid = function(key){
       return localStore.getItem(key+ls.activity_project);
    }
    /**
     * 
     * @param data
     */
    exports.setProjectListByBid = function(key,data){
        localStore.setItem(key+ls.activity_project,data,1);
    }

    
})  ;define("mustache",[],function(a,b){!function(a,c){if("object"==typeof b&&b)c(b);else{var d={};c(d),"function"==typeof define&&define.amd?define(d):a.Mustache=d}}(this,function(a){function b(a,b){return t.call(a,b)}function c(a){return!b(p,a)}function d(a){return"function"==typeof a}function e(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function f(a){return String(a).replace(/[&<>"'\/]/g,function(a){return w[a]})}function g(a){if(!v(a)||2!==a.length)throw new Error("Invalid tags: "+a);return[new RegExp(e(a[0])+"\\s*"),new RegExp("\\s*"+e(a[1]))]}function h(b,d){function f(){if(A&&!B)for(;z.length;)delete y[z.pop()];else z=[];A=!1,B=!1}d=d||a.tags,b=b||"","string"==typeof d&&(d=d.split(o));for(var h,l,m,p,t,u,v=g(d),w=new k(b),x=[],y=[],z=[],A=!1,B=!1;!w.eos();){if(h=w.pos,m=w.scanUntil(v[0]))for(var C=0,D=m.length;D>C;++C)p=m.charAt(C),c(p)?z.push(y.length):B=!0,y.push(["text",p,h,h+1]),h+=1,"\n"===p&&f();if(!w.scan(v[0]))break;if(A=!0,l=w.scan(s)||"name",w.scan(n),"="===l?(m=w.scanUntil(q),w.scan(q),w.scanUntil(v[1])):"{"===l?(m=w.scanUntil(new RegExp("\\s*"+e("}"+d[1]))),w.scan(r),w.scanUntil(v[1]),l="&"):m=w.scanUntil(v[1]),!w.scan(v[1]))throw new Error("Unclosed tag at "+w.pos);if(t=[l,m,h,w.pos],y.push(t),"#"===l||"^"===l)x.push(t);else if("/"===l){if(u=x.pop(),!u)throw new Error('Unopened section "'+m+'" at '+h);if(u[1]!==m)throw new Error('Unclosed section "'+u[1]+'" at '+h)}else"name"===l||"{"===l||"&"===l?B=!0:"="===l&&(v=g(d=m.split(o)))}if(u=x.pop())throw new Error('Unclosed section "'+u[1]+'" at '+w.pos);return j(i(y))}function i(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a[e],b&&("text"===b[0]&&c&&"text"===c[0]?(c[1]+=b[1],c[3]=b[3]):(d.push(b),c=b));return d}function j(a){for(var b,c,d=[],e=d,f=[],g=0,h=a.length;h>g;++g)switch(b=a[g],b[0]){case"#":case"^":e.push(b),f.push(b),e=b[4]=[];break;case"/":c=f.pop(),c[5]=b[2],e=f.length>0?f[f.length-1][4]:d;break;default:e.push(b)}return d}function k(a){this.string=a,this.tail=a,this.pos=0}function l(a,b){this.view=null==a?{}:a,this.cache={".":this.view},this.parent=b}function m(){this.cache={}}var n=/\s*/,o=/\s+/,p=/\S/,q=/\s*=/,r=/\s*\}/,s=/#|\^|\/|>|\{|&|=|!/,t=RegExp.prototype.test,u=Object.prototype.toString,v=Array.isArray||function(a){return"[object Array]"===u.call(a)},w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};k.prototype.eos=function(){return""===this.tail},k.prototype.scan=function(a){var b=this.tail.match(a);if(b&&0===b.index){var c=b[0];return this.tail=this.tail.substring(c.length),this.pos+=c.length,c}return""},k.prototype.scanUntil=function(a){var b,c=this.tail.search(a);switch(c){case-1:b=this.tail,this.tail="";break;case 0:b="";break;default:b=this.tail.substring(0,c),this.tail=this.tail.substring(c)}return this.pos+=b.length,b},l.prototype.push=function(a){return new l(a,this)},l.prototype.lookup=function(a){var b;if(a in this.cache)b=this.cache[a];else{for(var c=this;c;){if(a.indexOf(".")>0){b=c.view;for(var e=a.split("."),f=0;null!=b&&f<e.length;)b=b[e[f++]]}else b=c.view[a];if(null!=b)break;c=c.parent}this.cache[a]=b}return d(b)&&(b=b.call(this.view)),b},m.prototype.clearCache=function(){this.cache={}},m.prototype.parse=function(a,b){var c=this.cache,d=c[a];return null==d&&(d=c[a]=h(a,b)),d},m.prototype.render=function(a,b,c){var d=this.parse(a),e=b instanceof l?b:new l(b);return this.renderTokens(d,e,c,a)},m.prototype.renderTokens=function(b,c,e,f){function g(a){return k.render(a,c,e)}for(var h,i,j="",k=this,l=0,m=b.length;m>l;++l)switch(h=b[l],h[0]){case"#":if(i=c.lookup(h[1]),!i)continue;if(v(i))for(var n=0,o=i.length;o>n;++n)j+=this.renderTokens(h[4],c.push(i[n]),e,f);else if("object"==typeof i||"string"==typeof i)j+=this.renderTokens(h[4],c.push(i),e,f);else if(d(i)){if("string"!=typeof f)throw new Error("Cannot use higher-order sections without the original template");i=i.call(c.view,f.slice(h[3],h[5]),g),null!=i&&(j+=i)}else j+=this.renderTokens(h[4],c,e,f);break;case"^":i=c.lookup(h[1]),(!i||v(i)&&0===i.length)&&(j+=this.renderTokens(h[4],c,e,f));break;case">":if(!e)continue;i=d(e)?e(h[1]):e[h[1]],null!=i&&(j+=this.renderTokens(this.parse(i),c,e,i));break;case"&":i=c.lookup(h[1]),null!=i&&(j+=i);break;case"name":i=c.lookup(h[1]),null!=i&&(j+=a.escape(i));break;case"text":j+=h[1]}return j},a.name="mustache.js",a.version="0.8.1",a.tags=["{{","}}"];var x=new m;a.clearCache=function(){return x.clearCache()},a.parse=function(a,b){return x.parse(a,b)},a.render=function(a,b,c){return x.render(a,b,c)},a.to_html=function(b,c,e,f){var g=a.render(b,c,e);return d(f)?(f(g),void 0):g},a.escape=f,a.Scanner=k,a.Context=l,a.Writer=m})});
;define("mmrp.mod.box.attr",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	RestApi = require('mmrp.rest');
    
   	
	/***
	 * 
	 * @param {Object} str_obj
	 * @param {Object} units
	 */
	var removeUnite = function(str_obj,units){
		var units = (typeof(units) != 'undefined') ? units : "px";
		var str_obj = str_obj;
		
		for (var s in str_obj) {
			var str = str_obj[s] , len = str.length;
			if (str.substring(len - 2, len) == units) {
				str_obj[s] = str.substring(0, len - 2);
			}
		}
		return str_obj;
	};
	
	/***
	 * style ,object
	 * @param {Object} style_str
	 */
	var formatAttr = function(style_str){
		var styles = style_str.split(';'), i = styles.length, style, k, v,json = {};
			//set style
			while (i--) {
				style = styles[i].split(':');
				k = $.trim(style[0]);
				v = $.trim(style[1]);
				if (k.length > 0 && v.length > 0) {
					json[k] = v;
				}
			};
			return json;
	};
	
	/**
	 * 
	 */
	var setModInnerAttr = function($box,data){
		var dom_type = data.type;
		// 
		switch(dom_type) {
			case "mod_title":
				$box.find(".mod_title_l").css("font-size",data.style['font-size']+"px");
				$box.find(".mod_title_r").css("font-size",data.style['font-size']*2/3+"px");
				break;
			// 
			case "base_link":
				var $a = $box.find("a");
				$a.attr({
					title: data.title,
					href:data.url || "javascript:;",
					target:data.link_target
				}).text(data.link_text).css("color",data.style.color || '');
				
				if (!data.link_text) {
					$a.addClass("base_link");
				}
				else {
					$a.removeClass("base_link");
				}
				break;
				
			// 
			case "base_img":
				$box.children("img").attr({
					src:data.img_url
				});
				var width = $("#js_img_width").val(),
					height = $("#js_img_height").val();
					
				if( width == "" || height == "" ){
					//Box==
					$("<img />").attr("src", data.img_url).load(function(){
						var $dom = $box.parent();
						$dom.width(this.width).height(this.height);
						$("#js_width").val(this.width);
						$("#js_height").val(this.height);
						$('#js_img_width').val(this.width);
						$('#js_img_height').val(this.height);
					});
				};
				break;
				
			// Flash
			case "base_video":
					
				$box.find("object param[name='movie']").attr({
					value:data.img_url
				});
				
				//,Flash url embed
				$box.find("object embed").attr({
					src:data.img_url
				}).clone().appendTo($box.find("object")).end().remove();
					
				break;
			
			//	
			case "base_poster":
				var $a = $box.find("a");
					//img_src = data.img_url || "http://tacs.oa.com/img.php?145x82";
				$a.attr({
					title: data.title,
					href:data.url || "javascript:;",
					target:data.link_target
				});
				
				
				/*$box.find("img").attr({
					src:img_src
				});*/
				
				var width = $("#js_img_width").val(),
					height = $("#js_img_height").val();
					
				if( width == "" || height == "" ){
					//Box==
					$("<img />").attr("src", data.img_url).load(function(){
						var $dom = $box.parent();
						$dom.width(this.width).height(this.height);
						$("#js_width").val(this.width);
						$("#js_height").val(this.height);
						$('#js_img_width').val(this.width);
						$('#js_img_height').val(this.height);
					});
				}else{
					$("#js_width").val(width);
					$("#js_height").val(height);//.trigger('input');
				}
				break;
			
			case "base_iframe":
				data.iframe_url && $box.children("iframe").attr({
					src:data.iframe_url,
					width:data.style.width,
					height:data.style.height
				});
				break;
		}
	};//setModAttr
	
	
	/***
	 * $dom
	 * @param {Object} $dom
	 * @param {Object} data
	 */
	exports.getAttr = function($dom){
		var style = $dom.attr("style"), 
			$box = $dom.children(".js_box:first");
		//ulog.info("style",style);
		var json = {
			class_name		: 	$dom.attr("id"),						//id
			type			:	$dom.data("type"),						//
			mod_name		: 	$dom.data("mod_name"),					//
			style			: 	removeUnite(formatAttr(style)),			//
			style_unite		: 	formatAttr(style),						//
			url				: 	$box.attr("data-url"),					//
			title			: 	$box.attr("data-title"),				//title
			link_text		:	$box.attr("data-link_text"),			//
			img_url			:	$box.attr("data-img_url"),
			iframe_url		:	$box.attr("data-iframe_url"),			//iframe url
			link_target		:	$box.attr("data-link_target"),
			ismask			:   $box.attr("data-mask")
		};
		
		//colorcolorrgb
		json.style.color = $box.attr("data-color");
		json.style_unite.color = $box.attr("data-color");
		return json;
	};
	
	/***
	 * $dom
	 * @param {Object} $dom
	 * @param {Object} data
	 */
	exports.setAttr =  function($dom,data){
		var $dom = $dom,
			data = data,
			dom_type = data.type,
			style = JSON.stringify(data.style_unite).replace('{','').replace('}','').replace(/(\")/g, "").replace(/(\,)/g, ";"),//TODO:
			$box = $dom.children(".js_box:first"); 

		$dom.attr({
			"style":style,
			"id":data.class_name,
			"type":dom_type
		});
			
		$box.attr({
			"data-url":data.url,
			"data-title":data.title,
			"data-color": data.style.color,
			"data-img_url":data.img_url,
			"data-iframe_url":data.iframe_url,
			"data-link_text":data.link_text,
			"data-link_target":data.link_target
		});
		
		//   
		setModInnerAttr($box,data);
	};
   	
    
    
})  ;define("shortcut",{
/**
* http://www.openjs.com/scripts/events/keyboard_shortcuts/
* Version : 2.01.B
* By Binny V A
* License : BSD
*/
	'all_shortcuts': {}, //All the shortcuts are stored in this array
	'add': function (shortcut_combination, callback, opt) {
		//Provide a set of default options
		var default_options = {
			'type': 'keydown',
			'propagate': false,
			'disable_in_input': false,
			'target': document,
			'keycode': false
		};
		if (!opt) {
			opt = default_options;
		}
		else {
			var dfo;
			for (dfo in default_options) {
				if (typeof opt[dfo] == 'undefined') opt[dfo] = default_options[dfo];
			}
		}

		var ele = opt.target;
		if (typeof opt.target == 'string') ele = document.getElementById(opt.target);
		var ths = this;
		shortcut_combination = shortcut_combination.toLowerCase();

		//The function to be called at keypress
		var func = function (e) {
			e = e || window.event;

			if (opt['disable_in_input']) { //Don't enable shortcut keys in Input, Textarea fields
				var element;
				if (e.target) element = e.target;
				else if (e.srcElement) element = e.srcElement;
				if (element.nodeType == 3) element = element.parentNode;

				if (element.tagName == 'INPUT' || element.tagName == 'TEXTAREA') return;
			}

			//Find Which key is pressed
			if (e.keyCode) code = e.keyCode;
			else if (e.which) code = e.which;
			var character = String.fromCharCode(code).toLowerCase();

			if (code == 188) character = ","; //If the user presses , when the type is onkeydown
			if (code == 190) character = "."; //If the user presses , when the type is onkeydown

			var keys = shortcut_combination.split("+");
			//Key Pressed - counts the number of valid keypresses - if it is same as the number of keys, the shortcut function is invoked
			var kp = 0;

			//Work around for stupid Shift key bug created by using lowercase - as a result the shift+num combination was broken
			var shift_nums = {
				"`": "~",
				"1": "!",
				"2": "@",
				"3": "#",
				"4": "$",
				"5": "%",
				"6": "^",
				"7": "&",
				"8": "*",
				"9": "(",
				"0": ")",
				"-": "_",
				"=": "+",
				";": ":",
				"'": "\"",
				",": "<",
				".": ">",
				"/": "?",
				"\\": "|"
			}
			//Special Keys - and their codes
			var special_keys = {
				'esc': 27,
				'escape': 27,
				'tab': 9,
				'space': 32,
				'return': 13,
				'enter': 13,
				'backspace': 8,

				'scrolllock': 145,
				'scroll_lock': 145,
				'scroll': 145,
				'capslock': 20,
				'caps_lock': 20,
				'caps': 20,
				'numlock': 144,
				'num_lock': 144,
				'num': 144,

				'pause': 19,
				'break': 19,

				'insert': 45,
				'home': 36,
				'delete': 46,
				'end': 35,

				'pageup': 33,
				'page_up': 33,
				'pu': 33,

				'pagedown': 34,
				'page_down': 34,
				'pd': 34,

				'left': 37,
				'up': 38,
				'right': 39,
				'down': 40,

				'f1': 112,
				'f2': 113,
				'f3': 114,
				'f4': 115,
				'f5': 116,
				'f6': 117,
				'f7': 118,
				'f8': 119,
				'f9': 120,
				'f10': 121,
				'f11': 122,
				'f12': 123
			}

			var modifiers = {
				shift: { wanted: false, pressed: false },
				ctrl: { wanted: false, pressed: false },
				alt: { wanted: false, pressed: false },
				meta: { wanted: false, pressed: false}	//Meta is Mac specific
			};

			if (e.ctrlKey) modifiers.ctrl.pressed = true;
			if (e.shiftKey) modifiers.shift.pressed = true;
			if (e.altKey) modifiers.alt.pressed = true;
			if (e.metaKey) modifiers.meta.pressed = true;

			for (var i = 0; k = keys[i], i < keys.length; i++) {
				//Modifiers
				if (k == 'ctrl' || k == 'control') {
					kp++;
					modifiers.ctrl.wanted = true;

				} else if (k == 'shift') {
					kp++;
					modifiers.shift.wanted = true;

				} else if (k == 'alt') {
					kp++;
					modifiers.alt.wanted = true;
				} else if (k == 'meta') {
					kp++;
					modifiers.meta.wanted = true;
				} else if (k.length > 1) { //If it is a special key
					if (special_keys[k] == code) kp++;

				} else if (opt['keycode']) {
					if (opt['keycode'] == code) kp++;

				} else { //The special keys did not match
					if (character == k) kp++;
					else {
						if (shift_nums[character] && e.shiftKey) { //Stupid Shift key bug created by using lowercase
							character = shift_nums[character];
							if (character == k) kp++;
						}
					}
				}
			}

			if (kp == keys.length &&
						modifiers.ctrl.pressed == modifiers.ctrl.wanted &&
						modifiers.shift.pressed == modifiers.shift.wanted &&
						modifiers.alt.pressed == modifiers.alt.wanted &&
						modifiers.meta.pressed == modifiers.meta.wanted) {
				callback(e);

				if (!opt['propagate']) { //Stop the event
					//e.cancelBubble is supported by IE - this will kill the bubbling process.
					e.cancelBubble = true;
					e.returnValue = false;

					//e.stopPropagation works in Firefox.
					if (e.stopPropagation) {
						e.stopPropagation();
						e.preventDefault();
					}
					return false;
				}
			}
		}
		this.all_shortcuts[shortcut_combination] = {
			'callback': func,
			'target': ele,
			'event': opt['type']
		};
		//Attach the function with the event
		if (ele.addEventListener) ele.addEventListener(opt['type'], func, false);
		else if (ele.attachEvent) ele.attachEvent('on' + opt['type'], func);
		else ele['on' + opt['type']] = func;
	},

	//Remove the shortcut - just specify the shortcut and I will remove the binding
	'remove': function (shortcut_combination) {
		shortcut_combination = shortcut_combination.toLowerCase();
		var binding = this.all_shortcuts[shortcut_combination];
		delete (this.all_shortcuts[shortcut_combination])
		if (!binding) return;
		var type = binding['event'];
		var ele = binding['target'];
		var callback = binding['callback'];

		if (ele.detachEvent) ele.detachEvent('on' + type, callback);
		else if (ele.removeEventListener) ele.removeEventListener(type, callback, false);
		else ele['on' + type] = false;
	}

}) ;;define("jquery.contenteditable",[], function() { return function(jQuery) {
  
/**code start**/



/* jQuery.contentEditable Plugin
Copyright  2011 FreshCode
http://www.freshcode.co.za/

DHTML text editor jQuery plugin that uses contentEditable attribute in modern browsers for in-place editing.

Dependencies
------------
 - jQuery core
 - shortcut.js for keyboard hotkeys
 
Issues
------
 - no image support
 - no <code> or <blockquote> buttons (use Tab key for quotes)
 - no text alignment support
 
To Do
-----
 - let plugin build the toolbar
 - moves hard-coded IDs to options

License
-------
Let's keep it simple:
 1. You may use this code however you wish, including for commercial projects.
 2. You may not sell it or charge for it without my written permission.
 3. You muse retain the license information in this file.
 4. You are encouraged to contribute to the plugin on bitbucket (https://bitbucket.org/freshcode/jquery.contenteditable)
 5. You are encouraged to link back to www.freshcode.co.za if you publish something about it so everyone can benefit from future updates.

Best regards
Petrus Theron
contenteditable@freshcode.co.za
FreshCode Software Development
 
*/
(function ($) {

	var methods = {
		edit: function (isEditing) {
			return this.each(function () {
				$(this).attr("contentEditable", (isEditing === true) ? true : false);
			});
		},
		bold: function () {
			document.execCommand("bold", false, null);
		},
		italicize: function () {
			document.execCommand("italic", false, null);
		},
		underline: function () {
			document.execCommand("underline", false, null);
		},
		orderedList: function () {
			document.execCommand("InsertOrderedList", false, null);
		},
		unorderedList: function () {
			document.execCommand("InsertUnorderedList", false, null);
		},
		indent: function () {
			document.execCommand("indent", false, null);
		},
		outdent: function () {
			document.execCommand("outdent", false, null);
		},
		superscript: function () {
			document.execCommand("superscript", false, null);
		},
		subscript: function () {
			document.execCommand("subscript", false, null);
		},
		createLink: function () { /* This can be improved */
			var urlPrompt = prompt("Enter URL():", "http://");
			document.execCommand("createLink", false, urlPrompt);
		},
		createLinkTarget: function () { /* This can be improved */
			var urlPrompt = prompt("Enter URL():", "http://");
			var hyperlink = "javascript:window.open('" + urlPrompt + "')";
			document.execCommand("createLink", false, hyperlink);
		},
		insertImage: function () { /* This can be improved */
			var urlPrompt = prompt("Enter Image URL:", "http://");
			document.execCommand("InsertImage", false, urlPrompt);
		},
		formatBlock: function (block) {
			document.execCommand("FormatBlock", null, block);
		},
		forecolor: function(){
			var urlPrompt = prompt("Enter color (eg:#000):", "#");
			document.execCommand("forecolor", false, urlPrompt);	
		},
		removeFormat: function () {
			document.execCommand("removeFormat", false, null);
		},
		copy: function () {
			document.execCommand("Copy", false, null);
		},
		paste: function () {
			document.execCommand("Paste", false, null);
		},
		undo: function () {
			document.execCommand("undo", false, null);
		},
		
		save: function (callback) {
			return this.each(function () {
				(callback)($(this).attr("id"), $(this).html());
			});
		},
		init: function (options) {

			var $toolbar = $("#editor-toolbar"); // put in options

			/*$(window).scroll(function () {
				var docTop = $(window).scrollTop();

				var toolbarTop = $toolbar.offset().top;
				if (docTop > toolbarTop) {
					$("div.buttons", $toolbar).css({ "position": "fixed", "top": "0" });
				} else {
					$("div.buttons", $toolbar).css("position", "relative");
				}
			});*/

			/* Bind Toolbar Clicks */

			$("a.toolbar_bold", $toolbar).click(function () { methods.bold.apply(this); return false; });
			$("a.toolbar_italic", $toolbar).click(function () { methods.italicize.apply(this); return false; });
			$("a.toolbar_underline", $toolbar).click(function () { methods.underline.apply(this); return false; });
			$("a.toolbar_remove", $toolbar).click(function () { methods.removeFormat.apply(this); return false; });

			$("a.toolbar_link", $toolbar).click(function () { methods.createLink.apply(this); return false; });
			$("a.toolbar_link_target", $toolbar).click(function () { methods.createLinkTarget.apply(this); return false; });
			$("a.toolbar_image", $toolbar).click(function () { methods.insertImage.apply(this); return false; });
			$("a.toolbar_blockquote", $toolbar).click(function () { methods.formatBlock.apply(this, ["<BLOCKQUOTE>"]); return false; });
			$("a.toolbar_code", $toolbar).click(function () { methods.formatBlock.apply(this, ["<PRE>"]); return false; });

			$("a.toolbar_ol", $toolbar).click(function () { methods.orderedList.apply(this); return false; });
			$("a.toolbar_ul", $toolbar).click(function () { methods.unorderedList.apply(this); return false; });
			$("a.toolbar_sup", $toolbar).click(function () { methods.superscript.apply(this); return false; });
			$("a.toolbar_sub", $toolbar).click(function () { methods.subscript.apply(this); return false; });

			$("a.toolbar_p", $toolbar).click(function () { methods.formatBlock.apply(this, ["<P>"]); return false; });
			$("a.toolbar_h1", $toolbar).click(function () { methods.formatBlock.apply(this, ["<H1>"]); return false; });
			$("a.toolbar_h2", $toolbar).click(function () { methods.formatBlock.apply(this, ["<H2>"]); return false; });
			$("a.toolbar_h3", $toolbar).click(function () { methods.formatBlock.apply(this, ["<H3>"]); return false; });
			$("a.toolbar_h4", $toolbar).click(function () { methods.formatBlock.apply(this, ["<H4>"]); return false; });
			$("a.toolbar_h5", $toolbar).click(function () { methods.formatBlock.apply(this, ["<H5>"]); return false; });
			$("a.toolbar_fg", $toolbar).click(function () { methods.forecolor.apply(this); return false; });
			$("a.toolbar_undo", $toolbar).click(function () { methods.undo.apply(this); return false; });
			
			

			// var shortcuts = [
				// // { keys: 'Ctrl+l', method: function () { methods.createLink.apply(this); } },
// //				{ keys: 'Ctrl+g', method: function () { methods.insertImage.apply(this); } },
				// // { keys: 'Ctrl+Alt+U', method: function () { methods.unorderedList.apply(this); } },
				// // { keys: 'Ctrl+Alt+O', method: function () { methods.orderedList.apply(this); } },
// //				{ keys: 'Ctrl+q', method: function () { methods.formatBlock.apply(this, ["<BLOCKQUOTE>"]); } },
// //				{ keys: 'Ctrl+Alt+k', method: function () { methods.formatBlock.apply(this, ["<PRE>"]); } },
				// { keys: 'Ctrl+.', method: function () { methods.superscript.apply(this); } },
				// { keys: 'Ctrl+Shift+.', method: function () { methods.subscript.apply(this); } },
				// { keys: 'Ctrl+Alt+0', method: function () { methods.formatBlock.apply(this, ["p"]); } },
				// // { keys: 'Ctrl+b', method: function () { methods.bold.apply(this); } },
				// // { keys: 'Ctrl+i', method: function () { methods.italicize.apply(this); } },
				// { keys: 'Ctrl+Alt+1', method: function () { methods.formatBlock.apply(this, ["h1"]); } },
				// { keys: 'Ctrl+Alt+2', method: function () { methods.formatBlock.apply(this, ["h2"]); } },
				// { keys: 'Ctrl+Alt+3', method: function () { methods.formatBlock.apply(this, ["h3"]); } },
				// { keys: 'Ctrl+Alt+4', method: function () { methods.formatBlock.apply(this, ["h4"]); } },
				// { keys: 'Ctrl+Alt+4', method: function () { methods.formatBlock.apply(this, ["h4"]); } },
				// // { keys: 'Ctrl+m', method: function () { methods.removeFormat.apply(this); } },
				// // { keys: 'Ctrl+u', method: function () { methods.underline.apply(this); } }
// //				{ keys: 'tab', method: function () { methods.indent.apply(this); } },
// //				{ keys: 'Ctrl+tab', method: function () { methods.indent.apply(this); } },
// //				{ keys: 'Shift+tab', method: function () { methods.outdent.apply(this); } }
			// ];
// 
			// $.each(shortcuts, function (index, elem) {
				// shortcut.add(elem.keys, function () {
					// elem.method();
					// return false;
				// }, { 'type': 'keydown', 'propagate': false });
			// });

			return this.each(function () {

				var $this = $(this), data = $this.data('fresheditor'),
					tooltip = $('<div />', {
						text: $this.attr('title')
					});

				// If the plugin hasn't been initialized yet
				if (!data) {
					/* Do more setup stuff here */

					$(this).data('fresheditor', {
						target: $this,
						tooltip: tooltip
					});
				}
			});
		}
	};

	$.fn.fresheditor = function (method) {

		// Method calling logic
		if (methods[method]) {
			return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
		} else if (typeof method === 'object' || !method) {
			return methods.init.apply(this, arguments);
		} else {
			$.error('Method ' + method + ' does not exist on jQuery.contentEditable');
		}

		return;
	};

})(jQuery);

/**code end**/
  
  
}});


;define("jquery.pubsub",[], function() { return function(jQuery) {
  
/**code start**/
/*!
 * JZ Publish/Subscribe
 * Version: 1.4
 * License: http://www.opensource.org/licenses/gpl-3.0.html
 * Docs: http://www.joezimjs.com/projects/publish-subscribe-jquery-plugin/
 * Repo: https://github.com/joezimjs/JZ-Publish-Subscribe-jQuery-Plugin
 */

;(function ($) {
	'use strict';

	var subscriptions = {},
		ctx = {},
		publishing = false,

		clone = function(arr) {
			return arr.slice(0);
		};

	/**
     * jQuery.subscribe( topics, callback[, context] )
     * - topics (String): 1 or more topic names, separated by a space, to subscribe to
     * - callback (Function): function to be called when the given topic(s) is published to
     * - context (Object): an object to call the function on
     * returns: { "topics": topics, "callback": callback } or null if invalid arguments
     */
	$.subscribe = function (topics, callback, context) {
		var topicArr,
			usedTopics = {};

		// If no context was set, assign an empty object to the context
		context = context || ctx;

		// Make sure that each argument is valid
		if ($.type(topics) !== "string" || !$.isFunction(callback)) {
			// If anything is invalid, return null
			return null;
		}

		// Split space-separated topics into an array of topics
		topicArr = topics.split(" ");

		// Iterate over each topic and individually subscribe the callback function to them
		$.each(topicArr, function (i, topic) {
			// If the topic is an empty string, skip it. This may happen if there is more than one space between topics
			// Also skip if this is a repeat topic (e.g. someone entered "topic1 topic1"). Otherwise mark it as used.
			if (topic === "" || usedTopics[topic]) {
				return true; // continue
			} else {
				// Mark the topic as used
				usedTopics[topic] = true;
			}

			// If the topic does not exist, create it
			if (!subscriptions[topic]) {
				subscriptions[topic] = [];
			}

			// Add the callback function to the end of the array of callbacks assigned to the specified topic
			subscriptions[topic].push([callback,context]);
		});

		// Return a handle that can be used to unsubscribe
		return { topics: topics, callback: callback, context:context };
	};

	/**
     * jQuery.unsubscribe( topics[, callback[, context]] )
     * - topics (String): 1 or more topic names, separated by a space, to unsubscribe from
     * - callback (Function): function to be removed from the topic's subscription list. If none is supplied, all functions are removed from given topic(s)
     * - context (Object): object that was used as the context in the jQuery.subscribe() call.
     */
	$.unsubscribe = function (topics, callback, context) {
		var topicArr,
			usedTopics = {};

		// topics must either be a string, or have a property named topics that is a string
		if (!topics || ($.type(topics) !== "string" && (!topics.topics || $.type(topics.topics) !== "string"))) {
			// If it isn't valid, return null
			return $;
		}

		// If the handler was used, then split the handle object into the two arguments
		if (topics.topics) {
			callback = callback || topics.callback;
			context = context || topics.context;
			topics = topics.topics;
		}

		// If no context was provided, then use the default context
		context = context || ctx;

		// Split space-separated topics into an array of topics
		topicArr = topics.split(" ");

		// Iterate over each topic and individually unsubscribe the callback function from them
		$.each(topicArr, function (i, topic) {
			var currTopic = subscriptions[topic];

			// If the topic is an empty string or doesn't exist in subscriptions, or is a repeat topic, skip it.
			// Otherwise mark the topic as used
			if (topic === "" || !currTopic || usedTopics[topic]) {
				return true; // continue
			} else {
				usedTopics[topic] = true;
			}

			// If no callback is given, then remove all subscriptions to this topic
			if (!callback || !$.isFunction(callback)) {
				delete subscriptions[topic];
			} else {
				// Otherwise a callback is specified; iterate through this topic to find the correct callback
				$.each(currTopic, function (i, subscription) {
					if (subscription[0] === callback && subscription[1] === context) {
						currTopic.splice(i, 1);
						return false; // break
					}
				});
			}
		});

		return $;
	};

	/**
     * jQuery.publish( topics[, data] )
     * - topics (String): the subscription topic(s) to publish to
     * - data: any data (in any format) you wish to give to the subscribers
     */
	$.publish = function (topics, data) {
		// Return null if topics isn't a string
		if (!topics || $.type(topics) !== "string") {
			return $;
		}

		// Split the topics up into an array of topics
		var topicArr = topics.split(" ");

		// Iterate over the topics and publish to each one
		$.each(topicArr, function (i, topic) {
			// If the topic is blank, skip to the next one
			if (topic === "") {
				return true; // continue
			}

			if (subscriptions[topic]) {
				// Clone the subscriptions we're publishing to so that we don't run into any errors if someone (un)subscribes during the publishing.
				var subs = clone(subscriptions[topic]);

				// Iterate over each subscriber and call the callback function
				$.each(subs, function (i, subscription) {
					subscription[0].call(subscription[1], topic, data);
				});
			}
		});

		return $;
	};

}(jQuery));
/**code end**/
  
  
}});


;define("jquery.clickout",[], function() { return function(jQuery) {

    /**code start**/
    /*!
     * jQuery outside events - v1.1 - 3/16/2010
     * http://benalman.com/projects/jquery-outside-events-plugin/
     *
     * Copyright (c) 2010 "Cowboy" Ben Alman
     * Dual licensed under the MIT and GPL licenses.
     * http://benalman.com/about/license/
     */

// Script: jQuery outside events
//
// *Version: 1.1, Last updated: 3/16/2010*
//
// Project Home - http://benalman.com/projects/jquery-outside-events-plugin/
// GitHub       - http://github.com/cowboy/jquery-outside-events/
// Source       - http://github.com/cowboy/jquery-outside-events/raw/master/jquery.ba-outside-events.js
// (Minified)   - http://github.com/cowboy/jquery-outside-events/raw/master/jquery.ba-outside-events.min.js (0.9kb)
//
// About: License
//
// Copyright (c) 2010 "Cowboy" Ben Alman,
// Dual licensed under the MIT and GPL licenses.
// http://benalman.com/about/license/
//
// About: Examples
//
// These working examples, complete with fully commented code, illustrate a few
// ways in which this plugin can be used.
//
// clickoutside - http://benalman.com/code/projects/jquery-outside-events/examples/clickoutside/
// dblclickoutside - http://benalman.com/code/projects/jquery-outside-events/examples/dblclickoutside/
// mouseoveroutside - http://benalman.com/code/projects/jquery-outside-events/examples/mouseoveroutside/
// focusoutside - http://benalman.com/code/projects/jquery-outside-events/examples/focusoutside/
//
// About: Support and Testing
//
// Information about what version or versions of jQuery this plugin has been
// tested with, what browsers it has been tested in, and where the unit tests
// reside (so you can test it yourself).
//
// jQuery Versions - 1.4.2
// Browsers Tested - Internet Explorer 6-8, Firefox 2-3.6, Safari 3-4, Chrome, Opera 9.6-10.1.
// Unit Tests      - http://benalman.com/code/projects/jquery-outside-events/unit/
//
// About: Release History
//
// 1.1 - (3/16/2010) Made "clickoutside" plugin more general, resulting in a
//       whole new plugin with more than a dozen default "outside" events and
//       a method that can be used to add new ones.
// 1.0 - (2/27/2010) Initial release
//
// Topic: Default "outside" events
//
// Note that each "outside" event is powered by an "originating" event. Only
// when the originating event is triggered on an element outside the element
// to which that outside event is bound will the bound event be triggered.
//
// Because each outside event is powered by a separate originating event,
// stopping propagation of that originating event will prevent its related
// outside event from triggering.
//
//  OUTSIDE EVENT     - ORIGINATING EVENT
//  clickoutside      - click
//  dblclickoutside   - dblclick
//  focusoutside      - focusin
//  bluroutside       - focusout
//  mousemoveoutside  - mousemove
//  mousedownoutside  - mousedown
//  mouseupoutside    - mouseup
//  mouseoveroutside  - mouseover
//  mouseoutoutside   - mouseout
//  keydownoutside    - keydown
//  keypressoutside   - keypress
//  keyupoutside      - keyup
//  changeoutside     - change
//  selectoutside     - select
//  submitoutside     - submit

    (function($,doc,outside){
        '$:nomunge'; // Used by YUI compressor.

        $.map(
            // All these events will get an "outside" event counterpart by default.
            'click dblclick mousemove mousedown mouseup mouseover mouseout change select submit keydown keypress keyup'.split(' '),
            function( event_name ) { jq_addOutsideEvent( event_name ); }
        );

        // The focus and blur events are really focusin and focusout when it comes
        // to delegation, so they are a special case.
        jq_addOutsideEvent( 'focusin',  'focus' + outside );
        jq_addOutsideEvent( 'focusout', 'blur' + outside );

        // Method: jQuery.addOutsideEvent
        //
        // Register a new "outside" event to be with this method. Adding an outside
        // event that already exists will probably blow things up, so check the
        // <Default "outside" events> list before trying to add a new one.
        //
        // Usage:
        //
        // > jQuery.addOutsideEvent( event_name [, outside_event_name ] );
        //
        // Arguments:
        //
        //  event_name - (String) The name of the originating event that the new
        //    "outside" event will be powered by. This event can be a native or
        //    custom event, as long as it bubbles up the DOM tree.
        //  outside_event_name - (String) An optional name for the new "outside"
        //    event. If omitted, the outside event will be named whatever the
        //    value of `event_name` is plus the "outside" suffix.
        //
        // Returns:
        //
        //  Nothing.

        $.addOutsideEvent = jq_addOutsideEvent;

        function jq_addOutsideEvent( event_name, outside_event_name ) {

            // The "outside" event name.
            outside_event_name = outside_event_name || event_name + outside;

            // A jQuery object containing all elements to which the "outside" event is
            // bound.
            var elems = $(),

            // The "originating" event, namespaced for easy unbinding.
                event_namespaced = event_name + '.' + outside_event_name + '-special-event';

            // Event: outside events
            //
            // An "outside" event is triggered on an element when its corresponding
            // "originating" event is triggered on an element outside the element in
            // question. See the <Default "outside" events> list for more information.
            //
            // Usage:
            //
            // > jQuery('selector').bind( 'clickoutside', function(event) {
            // >   var clicked_elem = $(event.target);
            // >   ...
            // > });
            //
            // > jQuery('selector').bind( 'dblclickoutside', function(event) {
            // >   var double_clicked_elem = $(event.target);
            // >   ...
            // > });
            //
            // > jQuery('selector').bind( 'mouseoveroutside', function(event) {
            // >   var moused_over_elem = $(event.target);
            // >   ...
            // > });
            //
            // > jQuery('selector').bind( 'focusoutside', function(event) {
            // >   var focused_elem = $(event.target);
            // >   ...
            // > });
            //
            // You get the idea, right?

            $.event.special[ outside_event_name ] = {

                // Called only when the first "outside" event callback is bound per
                // element.
                setup: function(){

                    // Add this element to the list of elements to which this "outside"
                    // event is bound.
                    elems = elems.add( this );

                    // If this is the first element getting the event bound, bind a handler
                    // to document to catch all corresponding "originating" events.
                    if ( elems.length === 1 ) {
                        $(doc).bind( event_namespaced, handle_event );
                    }
                },

                // Called only when the last "outside" event callback is unbound per
                // element.
                teardown: function(){

                    // Remove this element from the list of elements to which this
                    // "outside" event is bound.
                    elems = elems.not( this );

                    // If this is the last element removed, remove the "originating" event
                    // handler on document that powers this "outside" event.
                    if ( elems.length === 0 ) {
                        $(doc).unbind( event_namespaced );
                    }
                },

                // Called every time a "outside" event callback is bound to an element.
                add: function( handleObj ) {
                    var old_handler = handleObj.handler;

                    // This function is executed every time the event is triggered. This is
                    // used to override the default event.target reference with one that is
                    // more useful.
                    handleObj.handler = function( event, elem ) {

                        // Set the event object's .target property to the element that the
                        // user interacted with, not the element that the "outside" event was
                        // was triggered on.
                        event.target = elem;

                        // Execute the actual bound handler.
                        old_handler.apply( this, arguments );
                    };
                }
            };

            // When the "originating" event is triggered..
            function handle_event( event ) {

                // Iterate over all elements to which this "outside" event is bound.
                $(elems).each(function(){
                    var elem = $(this);

                    // If this element isn't the element on which the event was triggered,
                    // and this element doesn't contain said element, then said element is
                    // considered to be outside, and the "outside" event will be triggered!
                    if ( this !== event.target && !elem.has(event.target).length ) {

                        // Use triggerHandler instead of trigger so that the "outside" event
                        // doesn't bubble. Pass in the "originating" event's .target so that
                        // the "outside" event.target can be overridden with something more
                        // meaningful.
                        elem.triggerHandler( outside_event_name, [ event.target ] );
                    }
                });
            };

        };

    })(jQuery,document,"outside");

    /**code end**/

}});;define("mmrp.mod.box.func",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	shortcut = require('shortcut'),
		Fun = require('mmrp.func');
    
   	require('jquery.contenteditable')($);
   	require('jquery.pubsub')($);
    require('jquery.clickout')($);

    var $doc = $(document);

   	var model = {
   		box_container : "#js_act_content",		//Box
   		box:'.js_box',//box 
   		drag_element:'.js_drag_element',//dom box
   		

   		mod_base_pub:'mod_base_pub_',//
   		mod_pub:'mod_pub_',//
   		
   		box_panel:"#js_pop_guide",		//
   		style_pre	:"m_"									//
   	};
   	
   	var count = 0,
   		count_arr = [];
   		
   	/**
	 * ctrl+V 
	 */
	var addCtrlVEvent = function(){
		shortcut.remove("ctrl+v");
		shortcut.add("ctrl+v",function(){
			var $dom = exports.hasSelect();
			exports.multiClone($dom);
			return false;
		}, { 'type': 'keydown', 'propagate': false,'disable_in_input':true });
	};	
	
	/**
	 *  
	 */
	exports.addCount = function(num){
		count_arr.push(num);
	};
   	
   	
	/***
	 * 
	 */
	exports.setParentOffset = function(reset){
		reset = reset || false;
		var $container = $(model.box_container);
		
		//
		reset && delete $container[0].opos;
		
		//pos
		if( typeof($container[0].opos) == "undefined"){
			var parent_offset = $container.offset();
			$container[0].opos = [parent_offset.left, parent_offset.top];
		}
	};//setParentOffset
   	
   	/**
	 * 
	 */
	exports.setCount = function(){
		count++
		var num_arr = count_arr;
		for(var i in num_arr){
			if(num_arr[i] === count){
				exports.setCount();
			}
		};
	};
	
	
	/***
	 * BoxID
	 */
	exports.getCount = function(){
		return count;
	};
	

	/***
	 * 
	 */
	exports.hasSelect = function(){
		//   editing_area_cls 
		var $dom = $('.editing_area',model.box_container).first();
		if($dom.length === 1){
			return $dom;
		}
		return $();
	};
	
	/**
	 *   
	 * num 1
	 */
	exports.updateStyleNum = function(id,num){
		var num = num || 1,
			$style = $('#'+id),
			real_num = $style.attr('data-num');//
		// 1
		if( (num<0) && (real_num<=1) ){
			$style.remove();
		};
//		console.info(num,real_num,id,$style)
		$style.attr('data-num',function(index,attr){
			
			return parseInt(num,10) + parseInt(attr,10);
		})
	};
	
	/***
	 * Box
	 * @param {Object} $dom : dom
	 */
	exports.clone = function($dom){
		var $container = $(model.box_container),
			$dom_clone = $dom.clone(true),
			OFFSET = 10;
		
		// 1 	
		exports.setCount();
		//ID
		var	new_id = model.style_pre + exports.getCount();
		//
		$dom.removeClass("editing_area").removeClass("ui-multidraggable");
		//id 
		$dom_clone.attr("id",new_id).css({
			left: function(index, value){
				//ulog.info(index,value,"left")
				return parseFloat(value) + OFFSET;
			},
			top: function(index, value){
				return parseFloat(value);
			},
			position:"absolute"
			
		}).addClass("editing_area");
		
		//TODO jquery func
		//juqery ui 
		$dom_clone.children(".ui-resizable-handle").remove();
		$dom_clone.removeData("draggable").removeData("multidraggable").removeData("resizable").unbind();
		
		//
		var $box = $dom_clone.children(model.box),
			mod_base_ids = $box.attr("data-mod-base-ids"),//id
			mod_id = $box.attr("data-mod-id");//id
		
		$('input[type="hidden"],style',$box).remove();	
		
		//
		if(mod_base_ids){
			var mod_base_arr = mod_base_ids.split(',');
			for(var m in mod_base_arr){
				exports.updateStyleNum(model.mod_base_pub+mod_base_arr[m])
			}
			
		};
		//
		mod_id && exports.updateStyleNum(model.mod_pub+mod_id);
		
		// exports.addEvents($dom_clone);
		//
		$dom_clone.appendTo($container);
		
		//box(  seajs require require box.events )
		$.publish('mod/addevent',$dom_clone);
		
	};
	
	/**
	 * 
	 */
	exports.multiClone = function($dom){
		if(!$dom.length) return;
		//
		if ($dom.hasClass("ui-multidraggable")) {
			console.info($dom.siblings(".ui-multidraggable"))
			$dom.siblings(".ui-multidraggable").each(function(){
				exports.clone($(this));
			});
		}
		//Box
		exports.clone($dom);
	};
		
	/***
	 * Box
	 * @param {Object} $dom
	 */
	exports.remove = function($dom){
		var $box = $dom.children(model.box),
			mod_id = model.mod_pub + $box.attr("data-mod-id"),
			mod_base_ids = $box.attr("data-mod-base-ids");
		
		//
		exports.updateStyleNum(mod_id,-1);
		//
		if (mod_base_ids && mod_base_ids !== "0" && mod_base_ids !== "") {
			var mod_base_arr = mod_base_ids.split(",");
			for(var m in mod_base_arr){
				exports.updateStyleNum(model.mod_base_pub + mod_base_arr[m],-1);
				//BoxStyle.removeModStyleToHead(model.mod_base_pub_ + mod_base_arr[m]);
			}
			
		}
        $doc.trigger('remove.box',$dom);
		//dom
		$dom.remove();
		//
		//RestApi.updateModFrequency($box.attr("data-mod-id"),-1);
	};
	
	/**
	 * 
	 */
	exports.multiRemove = function($dom){
		var $target;
		if(!$dom.length) return;

		if(window.__materiaid){
			$target = $dom.find('.mod_goods_link');

			if(!$target.length) {
				$target = $dom.find('.mod_goods_list');
			}
			//
			if($target.length && parseInt($target.data('areaid')) && parseInt($target.data('actid'))){
				Fun.alert('');
                return;
			}
		}

		//
		if ($dom.hasClass("ui-multidraggable")) {
			$dom.siblings(".ui-multidraggable").each(function(){
				exports.remove($(this));
			});
		}
		//Box
		exports.remove($dom);
	};
	
	/**
	 * box box 
	 */
	exports.multiSelect = function($dom){
		$dom.addClass('ui-multidraggable');
	};
	
	/**
	 * box box 
	 */
	exports.cancelMultiSelect = function($dom){
		$dom.removeClass('ui-multidraggable');
	};
	
	/**
	 * 
	 */
	exports.cancelMultidraggable = function(){
		$(model.drag_element,model.box_container).removeClass('ui-multidraggable');
	};

	/**
	 * 
	 */
	exports.enableEdit = function($dom){
		//2draggablefresheditor
		$dom.draggable('disable').addClass("content_editable").find(model.box).fresheditor("edit",true);
        $dom.on('clickoutside',function(){
            exports.disabledEdit($dom);
        })
		// 
		shortcut.remove("ctrl+v");
	};
	
	/**
	 *  
	 */
	exports.disabledEdit = function($dom){
		$dom.draggable("enable").removeClass("content_editable").find(model.box).fresheditor("edit",false);
        $dom.off('clickoutside');
		addCtrlVEvent();
	};
	
	
	/**
	 * 
	 * posotion : 
	 */
	exports.alignmentEvent = function(position){
		var $alignBox = $(model.box_container).find(".ui-multidraggable"),
			firstPos = $alignBox.first().position(),
			_position;
			
		switch(position){
			case "left":
				_position = firstPos.left;
				$alignBox.css('left',_position)
			break;
			
			case "top":
				_position = firstPos.top;
				$alignBox.css('top',_position)
			break;
			
		}
	};
    
    
})  ;define("mmrp.mod.loadjs",function(require, exports, module) {  
    
    var $ = require('jquery');
    
    var model = {
   		mod_container		:"#js_mod_container",							//
   		upload_list			:"#js_upload_list"
   	};	
    	
    /**
	 * js
	 */
	exports.loadApiJs = function($dom){
		var $mod = $dom.children(".js_box").children(),
			mod_js = $mod.attr("data-js"),
			$container =  $(model.mod_container);
		//console.info($mod)	
		//js	
		if(mod_js){
			//js 
			if (!$("#js_mod_js").length) {
				$("<div id='js_mod_js' class='js_config_page' style='display:none' />").appendTo($container);
			};
			
			var page_js = $("#js_mod_js").html();
			//js
			if(page_js.indexOf(mod_js) === -1){
				$("#js_mod_js").append(mod_js);
			};
			$mod.removeAttr("data-js");
		};
	};
	
	/**
	 * JS 
	 */
	exports.getModsJs = function(){
		var data = $('#js_mod_js').html();
		return data;
	};
    
	/**
	 * commjs 
	 */
	exports.getCommJs = function(pageinfo){
		var $_img = $("img",model.upload_list);
		$_img = $_img.filter(':lt(2)');
		var loader_imgs = [], temp_data = '';
		$_img.each(function(){
			temp_data = $(this).data('idc-url');
			if(!temp_data)
				temp_data = $(this).attr('src');
			loader_imgs.push('"' + temp_data + '"');			
		});
		var _str_date = pageinfo['redirection_time'] || '2100/10/22 17:30';
		/*var arr_date = _str_date.split('/');
		var _y = arr_date[0],_m = arr_date[1];
		if(_m > 12){
          _m = 12
        }else if(_m <= 12 && _m > 1){
          _m = _m - 1;
        }else if(_m = 1){
          _m = 12;
          _y = _y - 1;
        }else{
          _m = 1;
        }
        _str_date = _y + '/' + _m + '/' + arr_date[2];*/
		var _endDate = new Date(_str_date).getTime();
		var _endUrl = pageinfo['redirection_url'] || '';
		var data = '';
		data = ['setTimeout(function(){_redirection(' + _endDate + ', "' + _endUrl + '");},100);',
		'var J_precent = document.getElementById("J_precent"),J_loading = document.getElementById("J_loading"),J_wrapper = document.getElementById("J_wrapper");',
		'halo.use("util","loader","lazyloader",function(m){',
	      'util = m.util;',
	       'var loader = new m.loader([' + loader_imgs.join(',') + ']).loadend(function(percent){',
	          'if(J_precent)J_precent.innerHTML = this.percent;',
	       '}).complete(function(){',
	          'if(J_loading)m.util.addClass(J_loading, "hide");', 
	          'if(J_wrapper)m.util.removeClass(J_wrapper, "hide");',
	          'var _zoom = _zoom || 0.5;',
	          'new m.lazyloader({"zoom":  _zoom });',
	          //'setTimeout(function(){if(window.history.length > 1 || window.history == undefined || window.history.length == undefined){reset_pos();}},100);',
	      	  'setTimeout(function(){reset_pos();},100);',
	      	  'if(window.halo_ready){window.halo_ready(m)}',
	      '});});'].join('');
		
		/*data = ['var J_precent = document.getElementById("J_precent"),J_loading = document.getElementById("J_loading"),J_wrapper = document.getElementById("J_wrapper");',
		'halo.use("util","loader","lazyloader",function(m){',
	      'util = m.util;',
	       'var loader = m.loadermsk([' + loader_imgs.join(',') + '],function(){',
	          'new m.lazyloader();',
	      '});});'].join('');*/
		
		return data;
	};

	/**
	 * commjs loading
	 */
	exports.getCommJs2 = function(){
		var data = '';
		data = ['var J_precent = document.getElementById("J_precent"),J_loading = document.getElementById("J_loading"),J_wrapper = document.getElementById("J_wrapper");',
		'if(J_loading)m.util.addClass(J_loading, "hide");', 
	    'if(J_wrapper)m.util.removeClass(J_wrapper, "hide");',
		'halo.use("util","lazyloader",function(m){',
	      'util = m.util;',
	      'new m.lazyloader({"zoom": ' + _zoom + ' });',
	    '});});'].join('');
		
		/*data = ['var J_precent = document.getElementById("J_precent"),J_loading = document.getElementById("J_loading"),J_wrapper = document.getElementById("J_wrapper");',
		'halo.use("util","loader","lazyloader",function(m){',
	      'util = m.util;',
	       'var loader = m.loadermsk([' + loader_imgs.join(',') + '],function(){',
	          'new m.lazyloader();',
	      '});});'].join('');*/

		return data;
	}; 
})  ;define("jquery.ui",[], function() { return function(jQuery) {
  
/**code start**/

/*!
 * jQuery UI 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI
 */
(function( $, undefined ) {

// prevent duplicate loading
// this is only a problem because we proxy existing functions
// and we don't want to double proxy them
$.ui = $.ui || {};
if ( $.ui.version ) {
	return;
}

$.extend( $.ui, {
	version: "1.8.22",

	keyCode: {
		ALT: 18,
		BACKSPACE: 8,
		CAPS_LOCK: 20,
		COMMA: 188,
		COMMAND: 91,
		COMMAND_LEFT: 91, // COMMAND
		COMMAND_RIGHT: 93,
		CONTROL: 17,
		DELETE: 46,
		DOWN: 40,
		END: 35,
		ENTER: 13,
		ESCAPE: 27,
		HOME: 36,
		INSERT: 45,
		LEFT: 37,
		MENU: 93, // COMMAND_RIGHT
		NUMPAD_ADD: 107,
		NUMPAD_DECIMAL: 110,
		NUMPAD_DIVIDE: 111,
		NUMPAD_ENTER: 108,
		NUMPAD_MULTIPLY: 106,
		NUMPAD_SUBTRACT: 109,
		PAGE_DOWN: 34,
		PAGE_UP: 33,
		PERIOD: 190,
		RIGHT: 39,
		SHIFT: 16,
		SPACE: 32,
		TAB: 9,
		UP: 38,
		WINDOWS: 91 // COMMAND
	}
});

// plugins
$.fn.extend({
	propAttr: $.fn.prop || $.fn.attr,

	_focus: $.fn.focus,
	focus: function( delay, fn ) {
		return typeof delay === "number" ?
			this.each(function() {
				var elem = this;
				setTimeout(function() {
					$( elem ).focus();
					if ( fn ) {
						fn.call( elem );
					}
				}, delay );
			}) :
			this._focus.apply( this, arguments );
	},

	scrollParent: function() {
		var scrollParent;
		if (($.browser.msie && (/(static|relative)/).test(this.css('position'))) || (/absolute/).test(this.css('position'))) {
			scrollParent = this.parents().filter(function() {
				return (/(relative|absolute|fixed)/).test($.curCSS(this,'position',1)) && (/(auto|scroll)/).test($.curCSS(this,'overflow',1)+$.curCSS(this,'overflow-y',1)+$.curCSS(this,'overflow-x',1));
			}).eq(0);
		} else {
			scrollParent = this.parents().filter(function() {
				return (/(auto|scroll)/).test($.curCSS(this,'overflow',1)+$.curCSS(this,'overflow-y',1)+$.curCSS(this,'overflow-x',1));
			}).eq(0);
		}

		return (/fixed/).test(this.css('position')) || !scrollParent.length ? $(document) : scrollParent;
	},

	zIndex: function( zIndex ) {
		if ( zIndex !== undefined ) {
			return this.css( "zIndex", zIndex );
		}

		if ( this.length ) {
			var elem = $( this[ 0 ] ), position, value;
			while ( elem.length && elem[ 0 ] !== document ) {
				// Ignore z-index if position is set to a value where z-index is ignored by the browser
				// This makes behavior of this function consistent across browsers
				// WebKit always returns auto if the element is positioned
				position = elem.css( "position" );
				if ( position === "absolute" || position === "relative" || position === "fixed" ) {
					// IE returns 0 when zIndex is not specified
					// other browsers return a string
					// we ignore the case of nested elements with an explicit value of 0
					// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
					value = parseInt( elem.css( "zIndex" ), 10 );
					if ( !isNaN( value ) && value !== 0 ) {
						return value;
					}
				}
				elem = elem.parent();
			}
		}

		return 0;
	},

	disableSelection: function() {
		return this.bind( ( $.support.selectstart ? "selectstart" : "mousedown" ) +
			".ui-disableSelection", function( event ) {
				event.preventDefault();
			});
	},

	enableSelection: function() {
		return this.unbind( ".ui-disableSelection" );
	}
});

// support: jQuery <1.8
if ( !$( "<a>" ).outerWidth( 1 ).jquery ) {
	$.each( [ "Width", "Height" ], function( i, name ) {
		var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ],
			type = name.toLowerCase(),
			orig = {
				innerWidth: $.fn.innerWidth,
				innerHeight: $.fn.innerHeight,
				outerWidth: $.fn.outerWidth,
				outerHeight: $.fn.outerHeight
			};

		function reduce( elem, size, border, margin ) {
			$.each( side, function() {
				size -= parseFloat( $.curCSS( elem, "padding" + this, true) ) || 0;
				if ( border ) {
					size -= parseFloat( $.curCSS( elem, "border" + this + "Width", true) ) || 0;
				}
				if ( margin ) {
					size -= parseFloat( $.curCSS( elem, "margin" + this, true) ) || 0;
				}
			});
			return size;
		}

		$.fn[ "inner" + name ] = function( size ) {
			if ( size === undefined ) {
				return orig[ "inner" + name ].call( this );
			}

			return this.each(function() {
				$( this ).css( type, reduce( this, size ) + "px" );
			});
		};

		$.fn[ "outer" + name] = function( size, margin ) {
			if ( typeof size !== "number" ) {
				return orig[ "outer" + name ].call( this, size );
			}

			return this.each(function() {
				$( this).css( type, reduce( this, size, true, margin ) + "px" );
			});
		};
	});
}

// selectors
function focusable( element, isTabIndexNotNaN ) {
	var nodeName = element.nodeName.toLowerCase();
	if ( "area" === nodeName ) {
		var map = element.parentNode,
			mapName = map.name,
			img;
		if ( !element.href || !mapName || map.nodeName.toLowerCase() !== "map" ) {
			return false;
		}
		img = $( "img[usemap=#" + mapName + "]" )[0];
		return !!img && visible( img );
	}
	return ( /input|select|textarea|button|object/.test( nodeName )
		? !element.disabled
		: "a" == nodeName
			? element.href || isTabIndexNotNaN
			: isTabIndexNotNaN)
		// the element and all of its ancestors must be visible
		&& visible( element );
}

function visible( element ) {
	return !$( element ).parents().andSelf().filter(function() {
		return $.curCSS( this, "visibility" ) === "hidden" ||
			$.expr.filters.hidden( this );
	}).length;
}

$.extend( $.expr[ ":" ], {
	data: $.expr.createPseudo ?
		$.expr.createPseudo(function( dataName ) {
			return function( elem ) {
				return !!$.data( elem, dataName );
			};
		}) :
		// support: jQuery <1.8
		function( elem, i, match ) {
			return !!$.data( elem, match[ 3 ] );
		},

	focusable: function( element ) {
		return focusable( element, !isNaN( $.attr( element, "tabindex" ) ) );
	},

	tabbable: function( element ) {
		var tabIndex = $.attr( element, "tabindex" ),
			isTabIndexNaN = isNaN( tabIndex );
		return ( isTabIndexNaN || tabIndex >= 0 ) && focusable( element, !isTabIndexNaN );
	}
});

// support
$(function() {
	var body = document.body,
		div = body.appendChild( div = document.createElement( "div" ) );

	// access offsetHeight before setting the style to prevent a layout bug
	// in IE 9 which causes the elemnt to continue to take up space even
	// after it is removed from the DOM (#8026)
	div.offsetHeight;

	$.extend( div.style, {
		minHeight: "100px",
		height: "auto",
		padding: 0,
		borderWidth: 0
	});

	$.support.minHeight = div.offsetHeight === 100;
	$.support.selectstart = "onselectstart" in div;

	// set display to none to avoid a layout bug in IE
	// http://dev.jquery.com/ticket/4014
	body.removeChild( div ).style.display = "none";
});

// jQuery <1.4.3 uses curCSS, in 1.4.3 - 1.7.2 curCSS = css, 1.8+ only has css
if ( !$.curCSS ) {
	$.curCSS = $.css;
}





// deprecated
$.extend( $.ui, {
	// $.ui.plugin is deprecated.  Use the proxy pattern instead.
	plugin: {
		add: function( module, option, set ) {
			var proto = $.ui[ module ].prototype;
			for ( var i in set ) {
				proto.plugins[ i ] = proto.plugins[ i ] || [];
				proto.plugins[ i ].push( [ option, set[ i ] ] );
			}
		},
		call: function( instance, name, args ) {
			var set = instance.plugins[ name ];
			if ( !set || !instance.element[ 0 ].parentNode ) {
				return;
			}
	
			for ( var i = 0; i < set.length; i++ ) {
				if ( instance.options[ set[ i ][ 0 ] ] ) {
					set[ i ][ 1 ].apply( instance.element, args );
				}
			}
		}
	},
	
	// will be deprecated when we switch to jQuery 1.4 - use jQuery.contains()
	contains: function( a, b ) {
		return document.compareDocumentPosition ?
			a.compareDocumentPosition( b ) & 16 :
			a !== b && a.contains( b );
	},
	
	// only used by resizable
	hasScroll: function( el, a ) {
	
		//If overflow is hidden, the element might have extra content, but the user wants to hide it
		if ( $( el ).css( "overflow" ) === "hidden") {
			return false;
		}
	
		var scroll = ( a && a === "left" ) ? "scrollLeft" : "scrollTop",
			has = false;
	
		if ( el[ scroll ] > 0 ) {
			return true;
		}
	
		// TODO: determine which cases actually cause this to happen
		// if the element doesn't have the scroll set, see if it's possible to
		// set the scroll
		el[ scroll ] = 1;
		has = ( el[ scroll ] > 0 );
		el[ scroll ] = 0;
		return has;
	},
	
	// these are odd functions, fix the API or move into individual plugins
	isOverAxis: function( x, reference, size ) {
		//Determines when x coordinate is over "b" element axis
		return ( x > reference ) && ( x < ( reference + size ) );
	},
	isOver: function( y, x, top, left, height, width ) {
		//Determines when x, y coordinates is over "b" element
		return $.ui.isOverAxis( y, top, height ) && $.ui.isOverAxis( x, left, width );
	}
});

})( jQuery );
/*!
 * jQuery UI Widget 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Widget
 */
(function( $, undefined ) {

// jQuery 1.4+
if ( $.cleanData ) {
	var _cleanData = $.cleanData;
	$.cleanData = function( elems ) {
		for ( var i = 0, elem; (elem = elems[i]) != null; i++ ) {
			try {
				$( elem ).triggerHandler( "remove" );
			// http://bugs.jquery.com/ticket/8235
			} catch( e ) {}
		}
		_cleanData( elems );
	};
} else {
	var _remove = $.fn.remove;
	$.fn.remove = function( selector, keepData ) {
		return this.each(function() {
			if ( !keepData ) {
				if ( !selector || $.filter( selector, [ this ] ).length ) {
					$( "*", this ).add( [ this ] ).each(function() {
						try {
							$( this ).triggerHandler( "remove" );
						// http://bugs.jquery.com/ticket/8235
						} catch( e ) {}
					});
				}
			}
			return _remove.call( $(this), selector, keepData );
		});
	};
}

$.widget = function( name, base, prototype ) {
	var namespace = name.split( "." )[ 0 ],
		fullName;
	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName ] = function( elem ) {
		return !!$.data( elem, name );
	};

	$[ namespace ] = $[ namespace ] || {};
	$[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without initializing for simple inheritance
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};

	var basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
//	$.each( basePrototype, function( key, val ) {
//		if ( $.isPlainObject(val) ) {
//			basePrototype[ key ] = $.extend( {}, val );
//		}
//	});
	basePrototype.options = $.extend( true, {}, basePrototype.options );
	$[ namespace ][ name ].prototype = $.extend( true, basePrototype, {
		namespace: namespace,
		widgetName: name,
		widgetEventPrefix: $[ namespace ][ name ].prototype.widgetEventPrefix || name,
		widgetBaseClass: fullName
	}, prototype );

	$.widget.bridge( name, $[ namespace ][ name ] );
};

$.widget.bridge = function( name, object ) {
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = Array.prototype.slice.call( arguments, 1 ),
			returnValue = this;

		// allow multiple hashes to be passed on init
		options = !isMethodCall && args.length ?
			$.extend.apply( null, [ true, options ].concat(args) ) :
			options;

		// prevent calls to internal methods
		if ( isMethodCall && options.charAt( 0 ) === "_" ) {
			return returnValue;
		}

		if ( isMethodCall ) {
			this.each(function() {
				var instance = $.data( this, name ),
					methodValue = instance && $.isFunction( instance[options] ) ?
						instance[ options ].apply( instance, args ) :
						instance;
				// TODO: add this back in 1.9 and use $.error() (see #5972)
//				if ( !instance ) {
//					throw "cannot call methods on " + name + " prior to initialization; " +
//						"attempted to call method '" + options + "'";
//				}
//				if ( !$.isFunction( instance[options] ) ) {
//					throw "no such method '" + options + "' for " + name + " widget instance";
//				}
//				var methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue;
					return false;
				}
			});
		} else {
			this.each(function() {
				var instance = $.data( this, name );
				if ( instance ) {
					instance.option( options || {} )._init();
				} else {
					$.data( this, name, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( options, element ) {
	// allow instantiation without initializing for simple inheritance
	if ( arguments.length ) {
		this._createWidget( options, element );
	}
};

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	options: {
		disabled: false
	},
	_createWidget: function( options, element ) {
		// $.widget.bridge stores the plugin instance, but we do it anyway
		// so that it's stored even before the _create function runs
		$.data( element, this.widgetName, this );
		this.element = $( element );
		this.options = $.extend( true, {},
			this.options,
			this._getCreateOptions(),
			options );

		var self = this;
		this.element.bind( "remove." + this.widgetName, function() {
			self.destroy();
		});

		this._create();
		this._trigger( "create" );
		this._init();
	},
	_getCreateOptions: function() {
		return $.metadata && $.metadata.get( this.element[0] )[ this.widgetName ];
	},
	_create: function() {},
	_init: function() {},

	destroy: function() {
		this.element
			.unbind( "." + this.widgetName )
			.removeData( this.widgetName );
		this.widget()
			.unbind( "." + this.widgetName )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetBaseClass + "-disabled " +
				"ui-state-disabled" );
	},

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.extend( {}, this.options );
		}

		if  (typeof key === "string" ) {
			if ( value === undefined ) {
				return this.options[ key ];
			}
			options = {};
			options[ key ] = value;
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var self = this;
		$.each( options, function( key, value ) {
			self._setOption( key, value );
		});

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				[ value ? "addClass" : "removeClass"](
					this.widgetBaseClass + "-disabled" + " " +
					"ui-state-disabled" )
				.attr( "aria-disabled", value );
		}

		return this;
	},

	enable: function() {
		return this._setOption( "disabled", false );
	},
	disable: function() {
		return this._setOption( "disabled", true );
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );

		return !( $.isFunction(callback) &&
			callback.call( this.element[0], event, data ) === false ||
			event.isDefaultPrevented() );
	}
};

})( jQuery );
/*!
 * jQuery UI Mouse 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Mouse
 *
 * Depends:
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

var mouseHandled = false;
$( document ).mouseup( function( e ) {
	mouseHandled = false;
});

$.widget("ui.mouse", {
	options: {
		cancel: ':input,option',
		distance: 1,
		delay: 0
	},
	_mouseInit: function() {
		var self = this;

		this.element
			.bind('mousedown.'+this.widgetName, function(event) {
				return self._mouseDown(event);
			})
			.bind('click.'+this.widgetName, function(event) {
				if (true === $.data(event.target, self.widgetName + '.preventClickEvent')) {
				    $.removeData(event.target, self.widgetName + '.preventClickEvent');
					event.stopImmediatePropagation();
					return false;
				}
			});

		this.started = false;
	},

	// TODO: make sure destroying one instance of mouse doesn't mess with
	// other instances of mouse
	_mouseDestroy: function() {
		this.element.unbind('.'+this.widgetName);
		$(document)
			.unbind('mousemove.'+this.widgetName, this._mouseMoveDelegate)
			.unbind('mouseup.'+this.widgetName, this._mouseUpDelegate);
	},

	_mouseDown: function(event) {
		// don't let more than one widget handle mouseStart
		if( mouseHandled ) { return };

		// we may have missed mouseup (out of window)
		(this._mouseStarted && this._mouseUp(event));

		this._mouseDownEvent = event;

		var self = this,
			btnIsLeft = (event.which == 1),
			// event.target.nodeName works around a bug in IE 8 with
			// disabled inputs (#7620)
			elIsCancel = (typeof this.options.cancel == "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false);
		if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
			return true;
		}

		this.mouseDelayMet = !this.options.delay;
		if (!this.mouseDelayMet) {
			this._mouseDelayTimer = setTimeout(function() {
				self.mouseDelayMet = true;
			}, this.options.delay);
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted = (this._mouseStart(event) !== false);
			if (!this._mouseStarted) {
				event.preventDefault();
				return true;
			}
		}

		// Click event may never have fired (Gecko & Opera)
		if (true === $.data(event.target, this.widgetName + '.preventClickEvent')) {
			$.removeData(event.target, this.widgetName + '.preventClickEvent');
		}

		// these delegates are required to keep context
		this._mouseMoveDelegate = function(event) {
			return self._mouseMove(event);
		};
		this._mouseUpDelegate = function(event) {
			return self._mouseUp(event);
		};
		$(document)
			.bind('mousemove.'+this.widgetName, this._mouseMoveDelegate)
			.bind('mouseup.'+this.widgetName, this._mouseUpDelegate);

		event.preventDefault();
		
		mouseHandled = true;
		return true;
	},

	_mouseMove: function(event) {
		// IE mouseup check - mouseup happened when mouse was out of window
		if ($.browser.msie && !(document.documentMode >= 9) && !event.button) {
			return this._mouseUp(event);
		}

		if (this._mouseStarted) {
			this._mouseDrag(event);
			return event.preventDefault();
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted =
				(this._mouseStart(this._mouseDownEvent, event) !== false);
			(this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event));
		}

		return !this._mouseStarted;
	},

	_mouseUp: function(event) {
		$(document)
			.unbind('mousemove.'+this.widgetName, this._mouseMoveDelegate)
			.unbind('mouseup.'+this.widgetName, this._mouseUpDelegate);

		if (this._mouseStarted) {
			this._mouseStarted = false;

			if (event.target == this._mouseDownEvent.target) {
			    $.data(event.target, this.widgetName + '.preventClickEvent', true);
			}

			this._mouseStop(event);
		}

		return false;
	},

	_mouseDistanceMet: function(event) {
		return (Math.max(
				Math.abs(this._mouseDownEvent.pageX - event.pageX),
				Math.abs(this._mouseDownEvent.pageY - event.pageY)
			) >= this.options.distance
		);
	},

	_mouseDelayMet: function(event) {
		return this.mouseDelayMet;
	},

	// These are placeholder methods, to be overriden by extending plugin
	_mouseStart: function(event) {},
	_mouseDrag: function(event) {},
	_mouseStop: function(event) {},
	_mouseCapture: function(event) { return true; }
});

})(jQuery);
/*!
 * jQuery UI Position 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Position
 */
(function( $, undefined ) {

$.ui = $.ui || {};

var horizontalPositions = /left|center|right/,
	verticalPositions = /top|center|bottom/,
	center = "center",
	support = {},
	_position = $.fn.position,
	_offset = $.fn.offset;

$.fn.position = function( options ) {
	if ( !options || !options.of ) {
		return _position.apply( this, arguments );
	}

	// make a copy, we don't want to modify arguments
	options = $.extend( {}, options );

	var target = $( options.of ),
		targetElem = target[0],
		collision = ( options.collision || "flip" ).split( " " ),
		offset = options.offset ? options.offset.split( " " ) : [ 0, 0 ],
		targetWidth,
		targetHeight,
		basePosition;

	if ( targetElem.nodeType === 9 ) {
		targetWidth = target.width();
		targetHeight = target.height();
		basePosition = { top: 0, left: 0 };
	// TODO: use $.isWindow() in 1.9
	} else if ( targetElem.setTimeout ) {
		targetWidth = target.width();
		targetHeight = target.height();
		basePosition = { top: target.scrollTop(), left: target.scrollLeft() };
	} else if ( targetElem.preventDefault ) {
		// force left top to allow flipping
		options.at = "left top";
		targetWidth = targetHeight = 0;
		basePosition = { top: options.of.pageY, left: options.of.pageX };
	} else {
		targetWidth = target.outerWidth();
		targetHeight = target.outerHeight();
		basePosition = target.offset();
	}

	// force my and at to have valid horizontal and veritcal positions
	// if a value is missing or invalid, it will be converted to center 
	$.each( [ "my", "at" ], function() {
		var pos = ( options[this] || "" ).split( " " );
		if ( pos.length === 1) {
			pos = horizontalPositions.test( pos[0] ) ?
				pos.concat( [center] ) :
				verticalPositions.test( pos[0] ) ?
					[ center ].concat( pos ) :
					[ center, center ];
		}
		pos[ 0 ] = horizontalPositions.test( pos[0] ) ? pos[ 0 ] : center;
		pos[ 1 ] = verticalPositions.test( pos[1] ) ? pos[ 1 ] : center;
		options[ this ] = pos;
	});

	// normalize collision option
	if ( collision.length === 1 ) {
		collision[ 1 ] = collision[ 0 ];
	}

	// normalize offset option
	offset[ 0 ] = parseInt( offset[0], 10 ) || 0;
	if ( offset.length === 1 ) {
		offset[ 1 ] = offset[ 0 ];
	}
	offset[ 1 ] = parseInt( offset[1], 10 ) || 0;

	if ( options.at[0] === "right" ) {
		basePosition.left += targetWidth;
	} else if ( options.at[0] === center ) {
		basePosition.left += targetWidth / 2;
	}

	if ( options.at[1] === "bottom" ) {
		basePosition.top += targetHeight;
	} else if ( options.at[1] === center ) {
		basePosition.top += targetHeight / 2;
	}

	basePosition.left += offset[ 0 ];
	basePosition.top += offset[ 1 ];

	return this.each(function() {
		var elem = $( this ),
			elemWidth = elem.outerWidth(),
			elemHeight = elem.outerHeight(),
			marginLeft = parseInt( $.curCSS( this, "marginLeft", true ) ) || 0,
			marginTop = parseInt( $.curCSS( this, "marginTop", true ) ) || 0,
			collisionWidth = elemWidth + marginLeft +
				( parseInt( $.curCSS( this, "marginRight", true ) ) || 0 ),
			collisionHeight = elemHeight + marginTop +
				( parseInt( $.curCSS( this, "marginBottom", true ) ) || 0 ),
			position = $.extend( {}, basePosition ),
			collisionPosition;

		if ( options.my[0] === "right" ) {
			position.left -= elemWidth;
		} else if ( options.my[0] === center ) {
			position.left -= elemWidth / 2;
		}

		if ( options.my[1] === "bottom" ) {
			position.top -= elemHeight;
		} else if ( options.my[1] === center ) {
			position.top -= elemHeight / 2;
		}

		// prevent fractions if jQuery version doesn't support them (see #5280)
		if ( !support.fractions ) {
			position.left = Math.round( position.left );
			position.top = Math.round( position.top );
		}

		collisionPosition = {
			left: position.left - marginLeft,
			top: position.top - marginTop
		};

		$.each( [ "left", "top" ], function( i, dir ) {
			if ( $.ui.position[ collision[i] ] ) {
				$.ui.position[ collision[i] ][ dir ]( position, {
					targetWidth: targetWidth,
					targetHeight: targetHeight,
					elemWidth: elemWidth,
					elemHeight: elemHeight,
					collisionPosition: collisionPosition,
					collisionWidth: collisionWidth,
					collisionHeight: collisionHeight,
					offset: offset,
					my: options.my,
					at: options.at
				});
			}
		});

		if ( $.fn.bgiframe ) {
			elem.bgiframe();
		}
		elem.offset( $.extend( position, { using: options.using } ) );
	});
};

$.ui.position = {
	fit: {
		left: function( position, data ) {
			var win = $( window ),
				over = data.collisionPosition.left + data.collisionWidth - win.width() - win.scrollLeft();
			position.left = over > 0 ? position.left - over : Math.max( position.left - data.collisionPosition.left, position.left );
		},
		top: function( position, data ) {
			var win = $( window ),
				over = data.collisionPosition.top + data.collisionHeight - win.height() - win.scrollTop();
			position.top = over > 0 ? position.top - over : Math.max( position.top - data.collisionPosition.top, position.top );
		}
	},

	flip: {
		left: function( position, data ) {
			if ( data.at[0] === center ) {
				return;
			}
			var win = $( window ),
				over = data.collisionPosition.left + data.collisionWidth - win.width() - win.scrollLeft(),
				myOffset = data.my[ 0 ] === "left" ?
					-data.elemWidth :
					data.my[ 0 ] === "right" ?
						data.elemWidth :
						0,
				atOffset = data.at[ 0 ] === "left" ?
					data.targetWidth :
					-data.targetWidth,
				offset = -2 * data.offset[ 0 ];
			position.left += data.collisionPosition.left < 0 ?
				myOffset + atOffset + offset :
				over > 0 ?
					myOffset + atOffset + offset :
					0;
		},
		top: function( position, data ) {
			if ( data.at[1] === center ) {
				return;
			}
			var win = $( window ),
				over = data.collisionPosition.top + data.collisionHeight - win.height() - win.scrollTop(),
				myOffset = data.my[ 1 ] === "top" ?
					-data.elemHeight :
					data.my[ 1 ] === "bottom" ?
						data.elemHeight :
						0,
				atOffset = data.at[ 1 ] === "top" ?
					data.targetHeight :
					-data.targetHeight,
				offset = -2 * data.offset[ 1 ];
			position.top += data.collisionPosition.top < 0 ?
				myOffset + atOffset + offset :
				over > 0 ?
					myOffset + atOffset + offset :
					0;
		}
	}
};

// offset setter from jQuery 1.4
if ( !$.offset.setOffset ) {
	$.offset.setOffset = function( elem, options ) {
		// set position first, in-case top/left are set even on static elem
		if ( /static/.test( $.curCSS( elem, "position" ) ) ) {
			elem.style.position = "relative";
		}
		var curElem   = $( elem ),
			curOffset = curElem.offset(),
			curTop    = parseInt( $.curCSS( elem, "top",  true ), 10 ) || 0,
			curLeft   = parseInt( $.curCSS( elem, "left", true ), 10)  || 0,
			props     = {
				top:  (options.top  - curOffset.top)  + curTop,
				left: (options.left - curOffset.left) + curLeft
			};
		
		if ( 'using' in options ) {
			options.using.call( elem, props );
		} else {
			curElem.css( props );
		}
	};

	$.fn.offset = function( options ) {
		var elem = this[ 0 ];
		if ( !elem || !elem.ownerDocument ) { return null; }
		if ( options ) {
			if ( $.isFunction( options ) ) {
				return this.each(function( i ) {
					$( this ).offset( options.call( this, i, $( this ).offset() ) );
				});
			}
			return this.each(function() {
				$.offset.setOffset( this, options );
			});
		}
		return _offset.call( this );
	};
}

// fraction support test (older versions of jQuery don't support fractions)
(function () {
	var body = document.getElementsByTagName( "body" )[ 0 ], 
		div = document.createElement( "div" ),
		testElement, testElementParent, testElementStyle, offset, offsetTotal;

	//Create a "fake body" for testing based on method used in jQuery.support
	testElement = document.createElement( body ? "div" : "body" );
	testElementStyle = {
		visibility: "hidden",
		width: 0,
		height: 0,
		border: 0,
		margin: 0,
		background: "none"
	};
	if ( body ) {
		$.extend( testElementStyle, {
			position: "absolute",
			left: "-1000px",
			top: "-1000px"
		});
	}
	for ( var i in testElementStyle ) {
		testElement.style[ i ] = testElementStyle[ i ];
	}
	testElement.appendChild( div );
	testElementParent = body || document.documentElement;
	testElementParent.insertBefore( testElement, testElementParent.firstChild );

	div.style.cssText = "position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;";

	offset = $( div ).offset( function( _, offset ) {
		return offset;
	}).offset();

	testElement.innerHTML = "";
	testElementParent.removeChild( testElement );

	offsetTotal = offset.top + offset.left + ( body ? 2000 : 0 );
	support.fractions = offsetTotal > 21 && offsetTotal < 22;
})();

}( jQuery ));
/*!
 * jQuery UI Draggable 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Draggables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget("ui.draggable", $.ui.mouse, {
	widgetEventPrefix: "drag",
	options: {
		addClasses: true,
		appendTo: "parent",
		axis: false,
		connectToSortable: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		grid: false,
		handle: false,
		helper: "original",
		iframeFix: false,
		opacity: false,
		refreshPositions: false,
		revert: false,
		revertDuration: 500,
		scope: "default",
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		snap: false,
		snapMode: "both",
		snapTolerance: 20,
		stack: false,
		zIndex: false
	},
	_create: function() {

		if (this.options.helper == 'original' && !(/^(?:r|a|f)/).test(this.element.css("position")))
			this.element[0].style.position = 'relative';

		(this.options.addClasses && this.element.addClass("ui-draggable"));
		(this.options.disabled && this.element.addClass("ui-draggable-disabled"));

		this._mouseInit();

	},

	destroy: function() {
		if(!this.element.data('draggable')) return;
		this.element
			.removeData("draggable")
			.unbind(".draggable")
			.removeClass("ui-draggable"
				+ " ui-draggable-dragging"
				+ " ui-draggable-disabled");
		this._mouseDestroy();

		return this;
	},

	_mouseCapture: function(event) {

		var o = this.options;

		// among others, prevent a drag on a resizable-handle
		if (this.helper || o.disabled || $(event.target).is('.ui-resizable-handle'))
			return false;

		//Quit if we're not on a valid handle
		this.handle = this._getHandle(event);
		if (!this.handle)
			return false;
		
		if ( o.iframeFix ) {
			$(o.iframeFix === true ? "iframe" : o.iframeFix).each(function() {
				$('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>')
				.css({
					width: this.offsetWidth+"px", height: this.offsetHeight+"px",
					position: "absolute", opacity: "0.001", zIndex: 1000
				})
				.css($(this).offset())
				.appendTo("body");
			});
		}

		return true;

	},

	_mouseStart: function(event) {

		var o = this.options;

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		this.helper.addClass("ui-draggable-dragging");

		//Cache the helper size
		this._cacheHelperProportions();

		//If ddmanager is used for droppables, set the global draggable
		if($.ui.ddmanager)
			$.ui.ddmanager.current = this;

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Store the helper's css position
		this.cssPosition = this.helper.css("position");
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.positionAbs = this.element.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		//Generate the original position
		this.originalPosition = this.position = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if 'cursorAt' is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Set a containment if given in the options
		if(o.containment)
			this._setContainment();

		//Trigger event + callbacks
		if(this._trigger("start", event) === false) {
			this._clear();
			return false;
		}

		//Recache the helper size
		this._cacheHelperProportions();

		//Prepare the droppable offsets
		if ($.ui.ddmanager && !o.dropBehaviour)
			$.ui.ddmanager.prepareOffsets(this, event);

		
		this._mouseDrag(event, true); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		
		//If the ddmanager is used for droppables, inform the manager that dragging has started (see #5003)
		if ( $.ui.ddmanager ) $.ui.ddmanager.dragStart(this, event);
		
		return true;
	},

	_mouseDrag: function(event, noPropagation) {

		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		//Call plugins and callbacks and use the resulting position if something is returned
		if (!noPropagation) {
			var ui = this._uiHash();
			if(this._trigger('drag', event, ui) === false) {
				this._mouseUp({});
				return false;
			}
			this.position = ui.position;
		}

		if(!this.options.axis || this.options.axis != "y") this.helper[0].style.left = this.position.left+'px';
		if(!this.options.axis || this.options.axis != "x") this.helper[0].style.top = this.position.top+'px';
		if($.ui.ddmanager) $.ui.ddmanager.drag(this, event);

		return false;
	},

	_mouseStop: function(event) {

		//If we are using droppables, inform the manager about the drop
		var dropped = false;
		if ($.ui.ddmanager && !this.options.dropBehaviour)
			dropped = $.ui.ddmanager.drop(this, event);

		//if a drop comes from outside (a sortable)
		if(this.dropped) {
			dropped = this.dropped;
			this.dropped = false;
		}
		
		//if the original element is no longer in the DOM don't bother to continue (see #8269)
		var element = this.element[0], elementInDom = false;
		while ( element && (element = element.parentNode) ) {
			if (element == document ) {
				elementInDom = true;
			}
		}
		if ( !elementInDom && this.options.helper === "original" )
			return false;

		if((this.options.revert == "invalid" && !dropped) || (this.options.revert == "valid" && dropped) || this.options.revert === true || ($.isFunction(this.options.revert) && this.options.revert.call(this.element, dropped))) {
			var self = this;
			$(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function() {
				if(self._trigger("stop", event) !== false) {
					self._clear();
				}
			});
		} else {
			if(this._trigger("stop", event) !== false) {
				this._clear();
			}
		}

		return false;
	},
	
	_mouseUp: function(event) {
		if (this.options.iframeFix === true) {
			$("div.ui-draggable-iframeFix").each(function() { 
				this.parentNode.removeChild(this); 
			}); //Remove frame helpers
		}
		
		//If the ddmanager is used for droppables, inform the manager that dragging has stopped (see #5003)
		if( $.ui.ddmanager ) $.ui.ddmanager.dragStop(this, event);
		
		return $.ui.mouse.prototype._mouseUp.call(this, event);
	},
	
	cancel: function() {
		
		if(this.helper.is(".ui-draggable-dragging")) {
			this._mouseUp({});
		} else {
			this._clear();
		}
		
		return this;
		
	},

	_getHandle: function(event) {

		var handle = !this.options.handle || !$(this.options.handle, this.element).length ? true : false;
		$(this.options.handle, this.element)
			.find("*")
			.andSelf()
			.each(function() {
				if(this == event.target) handle = true;
			});

		return handle;

	},

	_createHelper: function(event) {

		var o = this.options;
		var helper = $.isFunction(o.helper) ? $(o.helper.apply(this.element[0], [event])) : (o.helper == 'clone' ? this.element.clone().removeAttr('id') : this.element);

		if(!helper.parents('body').length)
			helper.appendTo((o.appendTo == 'parent' ? this.element[0].parentNode : o.appendTo));

		if(helper[0] != this.element[0] && !(/(fixed|absolute)/).test(helper.css("position")))
			helper.css("position", "absolute");

		return helper;

	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj == 'string') {
			obj = obj.split(' ');
		}
		if ($.isArray(obj)) {
			obj = {left: +obj[0], top: +obj[1] || 0};
		}
		if ('left' in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ('right' in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ('top' in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ('bottom' in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {

		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if(this.cssPosition == 'absolute' && this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		if((this.offsetParent[0] == document.body) //This needs to be actually done for all browsers, since pageX/pageY includes this information
		|| (this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() == 'html' && $.browser.msie)) //Ugly IE fix
			po = { top: 0, left: 0 };

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"),10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"),10) || 0)
		};

	},

	_getRelativeOffset: function() {

		if(this.cssPosition == "relative") {
			var p = this.element.position();
			return {
				top: p.top - (parseInt(this.helper.css("top"),10) || 0) + this.scrollParent.scrollTop(),
				left: p.left - (parseInt(this.helper.css("left"),10) || 0) + this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.element.css("marginLeft"),10) || 0),
			top: (parseInt(this.element.css("marginTop"),10) || 0),
			right: (parseInt(this.element.css("marginRight"),10) || 0),
			bottom: (parseInt(this.element.css("marginBottom"),10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var o = this.options;
		if(o.containment == 'parent') o.containment = this.helper[0].parentNode;
		if(o.containment == 'document' || o.containment == 'window') this.containment = [
			o.containment == 'document' ? 0 : $(window).scrollLeft() - this.offset.relative.left - this.offset.parent.left,
			o.containment == 'document' ? 0 : $(window).scrollTop() - this.offset.relative.top - this.offset.parent.top,
			(o.containment == 'document' ? 0 : $(window).scrollLeft()) + $(o.containment == 'document' ? document : window).width() - this.helperProportions.width - this.margins.left,
			(o.containment == 'document' ? 0 : $(window).scrollTop()) + ($(o.containment == 'document' ? document : window).height() || document.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top
		];

		if(!(/^(document|window|parent)$/).test(o.containment) && o.containment.constructor != Array) {
		        var c = $(o.containment);
			var ce = c[0]; if(!ce) return;
			var co = c.offset();
			var over = ($(ce).css("overflow") != 'hidden');

			this.containment = [
				(parseInt($(ce).css("borderLeftWidth"),10) || 0) + (parseInt($(ce).css("paddingLeft"),10) || 0),
				(parseInt($(ce).css("borderTopWidth"),10) || 0) + (parseInt($(ce).css("paddingTop"),10) || 0),
				(over ? Math.max(ce.scrollWidth,ce.offsetWidth) : ce.offsetWidth) - (parseInt($(ce).css("borderLeftWidth"),10) || 0) - (parseInt($(ce).css("paddingRight"),10) || 0) - this.helperProportions.width - this.margins.left - this.margins.right,
				(over ? Math.max(ce.scrollHeight,ce.offsetHeight) : ce.offsetHeight) - (parseInt($(ce).css("borderTopWidth"),10) || 0) - (parseInt($(ce).css("paddingBottom"),10) || 0) - this.helperProportions.height - this.margins.top  - this.margins.bottom
			];
			this.relative_container = c;

		} else if(o.containment.constructor == Array) {
			this.containment = o.containment;
		}

	},

	_convertPositionTo: function(d, pos) {

		if(!pos) pos = this.position;
		var mod = d == "absolute" ? 1 : -1;
		var o = this.options, scroll = this.cssPosition == 'absolute' && !(this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		return {
			top: (
				pos.top																	// The absolute mouse position
				+ this.offset.relative.top * mod										// Only for relative positioned nodes: Relative offset from element to offset parent
				+ this.offset.parent.top * mod											// The offsetParent's offset without borders (offset + border)
				- ($.browser.safari && $.browser.version < 526 && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod)
			),
			left: (
				pos.left																// The absolute mouse position
				+ this.offset.relative.left * mod										// Only for relative positioned nodes: Relative offset from element to offset parent
				+ this.offset.parent.left * mod											// The offsetParent's offset without borders (offset + border)
				- ($.browser.safari && $.browser.version < 526 && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ) * mod)
			)
		};

	},

	_generatePosition: function(event) {

		var o = this.options, scroll = this.cssPosition == 'absolute' && !(this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);
		var pageX = event.pageX;
		var pageY = event.pageY;

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if(this.originalPosition) { //If we are not dragging yet, we won't check for options
		         var containment;
		         if(this.containment) {
				 if (this.relative_container){
				     var co = this.relative_container.offset();
				     containment = [ this.containment[0] + co.left,
						     this.containment[1] + co.top,
						     this.containment[2] + co.left,
						     this.containment[3] + co.top ];
				 }
				 else {
				     containment = this.containment;
				 }

				if(event.pageX - this.offset.click.left < containment[0]) pageX = containment[0] + this.offset.click.left;
				if(event.pageY - this.offset.click.top < containment[1]) pageY = containment[1] + this.offset.click.top;
				if(event.pageX - this.offset.click.left > containment[2]) pageX = containment[2] + this.offset.click.left;
				if(event.pageY - this.offset.click.top > containment[3]) pageY = containment[3] + this.offset.click.top;
			}

			if(o.grid) {
				//Check for grid elements set to 0 to prevent divide by 0 error causing invalid argument errors in IE (see ticket #6950)
				var top = o.grid[1] ? this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1] : this.originalPageY;
				pageY = containment ? (!(top - this.offset.click.top < containment[1] || top - this.offset.click.top > containment[3]) ? top : (!(top - this.offset.click.top < containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				var left = o.grid[0] ? this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0] : this.originalPageX;
				pageX = containment ? (!(left - this.offset.click.left < containment[0] || left - this.offset.click.left > containment[2]) ? left : (!(left - this.offset.click.left < containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

		}

		return {
			top: (
				pageY																// The absolute mouse position
				- this.offset.click.top													// Click offset (relative to the element)
				- this.offset.relative.top												// Only for relative positioned nodes: Relative offset from element to offset parent
				- this.offset.parent.top												// The offsetParent's offset without borders (offset + border)
				+ ($.browser.safari && $.browser.version < 526 && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ))
			),
			left: (
				pageX																// The absolute mouse position
				- this.offset.click.left												// Click offset (relative to the element)
				- this.offset.relative.left												// Only for relative positioned nodes: Relative offset from element to offset parent
				- this.offset.parent.left												// The offsetParent's offset without borders (offset + border)
				+ ($.browser.safari && $.browser.version < 526 && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ))
			)
		};

	},

	_clear: function() {
		this.helper.removeClass("ui-draggable-dragging");
		if(this.helper[0] != this.element[0] && !this.cancelHelperRemoval) this.helper.remove();
		//if($.ui.ddmanager) $.ui.ddmanager.current = null;
		this.helper = null;
		this.cancelHelperRemoval = false;
	},

	// From now on bulk stuff - mainly helpers

	_trigger: function(type, event, ui) {
		ui = ui || this._uiHash();
		$.ui.plugin.call(this, type, [event, ui]);
		if(type == "drag") this.positionAbs = this._convertPositionTo("absolute"); //The absolute position has to be recalculated after plugins
		return $.Widget.prototype._trigger.call(this, type, event, ui);
	},

	plugins: {},

	_uiHash: function(event) {
		return {
			helper: this.helper,
			position: this.position,
			originalPosition: this.originalPosition,
			offset: this.positionAbs
		};
	}

});

$.extend($.ui.draggable, {
	version: "1.8.22"
});

$.ui.plugin.add("draggable", "connectToSortable", {
	start: function(event, ui) {

		var inst = $(this).data("draggable"), o = inst.options,
			uiSortable = $.extend({}, ui, { item: inst.element });
		inst.sortables = [];
		$(o.connectToSortable).each(function() {
			var sortable = $.data(this, 'sortable');
			if (sortable && !sortable.options.disabled) {
				inst.sortables.push({
					instance: sortable,
					shouldRevert: sortable.options.revert
				});
				sortable.refreshPositions();	// Call the sortable's refreshPositions at drag start to refresh the containerCache since the sortable container cache is used in drag and needs to be up to date (this will ensure it's initialised as well as being kept in step with any changes that might have happened on the page).
				sortable._trigger("activate", event, uiSortable);
			}
		});

	},
	stop: function(event, ui) {

		//If we are still over the sortable, we fake the stop event of the sortable, but also remove helper
		var inst = $(this).data("draggable"),
			uiSortable = $.extend({}, ui, { item: inst.element });

		$.each(inst.sortables, function() {
			if(this.instance.isOver) {

				this.instance.isOver = 0;

				inst.cancelHelperRemoval = true; //Don't remove the helper in the draggable instance
				this.instance.cancelHelperRemoval = false; //Remove it in the sortable instance (so sortable plugins like revert still work)

				//The sortable revert is supported, and we have to set a temporary dropped variable on the draggable to support revert: 'valid/invalid'
				if(this.shouldRevert) this.instance.options.revert = true;

				//Trigger the stop of the sortable
				this.instance._mouseStop(event);

				this.instance.options.helper = this.instance.options._helper;

				//If the helper has been the original item, restore properties in the sortable
				if(inst.options.helper == 'original')
					this.instance.currentItem.css({ top: 'auto', left: 'auto' });

			} else {
				this.instance.cancelHelperRemoval = false; //Remove the helper in the sortable instance
				this.instance._trigger("deactivate", event, uiSortable);
			}

		});

	},
	drag: function(event, ui) {

		var inst = $(this).data("draggable"), self = this;

		var checkPos = function(o) {
			var dyClick = this.offset.click.top, dxClick = this.offset.click.left;
			var helperTop = this.positionAbs.top, helperLeft = this.positionAbs.left;
			var itemHeight = o.height, itemWidth = o.width;
			var itemTop = o.top, itemLeft = o.left;

			return $.ui.isOver(helperTop + dyClick, helperLeft + dxClick, itemTop, itemLeft, itemHeight, itemWidth);
		};

		$.each(inst.sortables, function(i) {
			
			//Copy over some variables to allow calling the sortable's native _intersectsWith
			this.instance.positionAbs = inst.positionAbs;
			this.instance.helperProportions = inst.helperProportions;
			this.instance.offset.click = inst.offset.click;
			
			if(this.instance._intersectsWith(this.instance.containerCache)) {

				//If it intersects, we use a little isOver variable and set it once, so our move-in stuff gets fired only once
				if(!this.instance.isOver) {

					this.instance.isOver = 1;
					//Now we fake the start of dragging for the sortable instance,
					//by cloning the list group item, appending it to the sortable and using it as inst.currentItem
					//We can then fire the start event of the sortable with our passed browser event, and our own helper (so it doesn't create a new one)
					this.instance.currentItem = $(self).clone().removeAttr('id').appendTo(this.instance.element).data("sortable-item", true);
					this.instance.options._helper = this.instance.options.helper; //Store helper option to later restore it
					this.instance.options.helper = function() { return ui.helper[0]; };

					event.target = this.instance.currentItem[0];
					this.instance._mouseCapture(event, true);
					this.instance._mouseStart(event, true, true);

					//Because the browser event is way off the new appended portlet, we modify a couple of variables to reflect the changes
					this.instance.offset.click.top = inst.offset.click.top;
					this.instance.offset.click.left = inst.offset.click.left;
					this.instance.offset.parent.left -= inst.offset.parent.left - this.instance.offset.parent.left;
					this.instance.offset.parent.top -= inst.offset.parent.top - this.instance.offset.parent.top;

					inst._trigger("toSortable", event);
					inst.dropped = this.instance.element; //draggable revert needs that
					//hack so receive/update callbacks work (mostly)
					inst.currentItem = inst.element;
					this.instance.fromOutside = inst;

				}

				//Provided we did all the previous steps, we can fire the drag event of the sortable on every draggable drag, when it intersects with the sortable
				if(this.instance.currentItem) this.instance._mouseDrag(event);

			} else {

				//If it doesn't intersect with the sortable, and it intersected before,
				//we fake the drag stop of the sortable, but make sure it doesn't remove the helper by using cancelHelperRemoval
				if(this.instance.isOver) {

					this.instance.isOver = 0;
					this.instance.cancelHelperRemoval = true;
					
					//Prevent reverting on this forced stop
					this.instance.options.revert = false;
					
					// The out event needs to be triggered independently
					this.instance._trigger('out', event, this.instance._uiHash(this.instance));
					
					this.instance._mouseStop(event, true);
					this.instance.options.helper = this.instance.options._helper;

					//Now we remove our currentItem, the list group clone again, and the placeholder, and animate the helper back to it's original size
					this.instance.currentItem.remove();
					if(this.instance.placeholder) this.instance.placeholder.remove();

					inst._trigger("fromSortable", event);
					inst.dropped = false; //draggable revert needs that
				}

			};

		});

	}
});

$.ui.plugin.add("draggable", "cursor", {
	start: function(event, ui) {
		var t = $('body'), o = $(this).data('draggable').options;
		if (t.css("cursor")) o._cursor = t.css("cursor");
		t.css("cursor", o.cursor);
	},
	stop: function(event, ui) {
		var o = $(this).data('draggable').options;
		if (o._cursor) $('body').css("cursor", o._cursor);
	}
});

$.ui.plugin.add("draggable", "opacity", {
	start: function(event, ui) {
		var t = $(ui.helper), o = $(this).data('draggable').options;
		if(t.css("opacity")) o._opacity = t.css("opacity");
		t.css('opacity', o.opacity);
	},
	stop: function(event, ui) {
		var o = $(this).data('draggable').options;
		if(o._opacity) $(ui.helper).css('opacity', o._opacity);
	}
});

$.ui.plugin.add("draggable", "scroll", {
	start: function(event, ui) {
		var i = $(this).data("draggable");
		if(i.scrollParent[0] != document && i.scrollParent[0].tagName != 'HTML') i.overflowOffset = i.scrollParent.offset();
	},
	drag: function(event, ui) {

		var i = $(this).data("draggable"), o = i.options, scrolled = false;

		if(i.scrollParent[0] != document && i.scrollParent[0].tagName != 'HTML') {

			if(!o.axis || o.axis != 'x') {
				if((i.overflowOffset.top + i.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity)
					i.scrollParent[0].scrollTop = scrolled = i.scrollParent[0].scrollTop + o.scrollSpeed;
				else if(event.pageY - i.overflowOffset.top < o.scrollSensitivity)
					i.scrollParent[0].scrollTop = scrolled = i.scrollParent[0].scrollTop - o.scrollSpeed;
			}

			if(!o.axis || o.axis != 'y') {
				if((i.overflowOffset.left + i.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity)
					i.scrollParent[0].scrollLeft = scrolled = i.scrollParent[0].scrollLeft + o.scrollSpeed;
				else if(event.pageX - i.overflowOffset.left < o.scrollSensitivity)
					i.scrollParent[0].scrollLeft = scrolled = i.scrollParent[0].scrollLeft - o.scrollSpeed;
			}

		} else {

			if(!o.axis || o.axis != 'x') {
				if(event.pageY - $(document).scrollTop() < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() - o.scrollSpeed);
				else if($(window).height() - (event.pageY - $(document).scrollTop()) < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() + o.scrollSpeed);
			}

			if(!o.axis || o.axis != 'y') {
				if(event.pageX - $(document).scrollLeft() < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() - o.scrollSpeed);
				else if($(window).width() - (event.pageX - $(document).scrollLeft()) < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() + o.scrollSpeed);
			}

		}

		if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour)
			$.ui.ddmanager.prepareOffsets(i, event);

	}
});

$.ui.plugin.add("draggable", "snap", {
	start: function(event, ui) {

		var i = $(this).data("draggable"), o = i.options;
		i.snapElements = [];

		$(o.snap.constructor != String ? ( o.snap.items || ':data(draggable)' ) : o.snap).each(function() {
			var $t = $(this); var $o = $t.offset();
			if(this != i.element[0]) i.snapElements.push({
				item: this,
				width: $t.outerWidth(), height: $t.outerHeight(),
				top: $o.top, left: $o.left
			});
		});

	},
	drag: function(event, ui) {

		var inst = $(this).data("draggable"), o = inst.options;
		var d = o.snapTolerance;

		var x1 = ui.offset.left, x2 = x1 + inst.helperProportions.width,
			y1 = ui.offset.top, y2 = y1 + inst.helperProportions.height;

		for (var i = inst.snapElements.length - 1; i >= 0; i--){

			var l = inst.snapElements[i].left, r = l + inst.snapElements[i].width,
				t = inst.snapElements[i].top, b = t + inst.snapElements[i].height;

			//Yes, I know, this is insane ;)
			if(!((l-d < x1 && x1 < r+d && t-d < y1 && y1 < b+d) || (l-d < x1 && x1 < r+d && t-d < y2 && y2 < b+d) || (l-d < x2 && x2 < r+d && t-d < y1 && y1 < b+d) || (l-d < x2 && x2 < r+d && t-d < y2 && y2 < b+d))) {
				if(inst.snapElements[i].snapping) (inst.options.snap.release && inst.options.snap.release.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
				inst.snapElements[i].snapping = false;
				continue;
			}

			if(o.snapMode != 'inner') {
				var ts = Math.abs(t - y2) <= d;
				var bs = Math.abs(b - y1) <= d;
				var ls = Math.abs(l - x2) <= d;
				var rs = Math.abs(r - x1) <= d;
				if(ts) ui.position.top = inst._convertPositionTo("relative", { top: t - inst.helperProportions.height, left: 0 }).top - inst.margins.top;
				if(bs) ui.position.top = inst._convertPositionTo("relative", { top: b, left: 0 }).top - inst.margins.top;
				if(ls) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l - inst.helperProportions.width }).left - inst.margins.left;
				if(rs) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r }).left - inst.margins.left;
			}

			var first = (ts || bs || ls || rs);

			if(o.snapMode != 'outer') {
				var ts = Math.abs(t - y1) <= d;
				var bs = Math.abs(b - y2) <= d;
				var ls = Math.abs(l - x1) <= d;
				var rs = Math.abs(r - x2) <= d;
				if(ts) ui.position.top = inst._convertPositionTo("relative", { top: t, left: 0 }).top - inst.margins.top;
				if(bs) ui.position.top = inst._convertPositionTo("relative", { top: b - inst.helperProportions.height, left: 0 }).top - inst.margins.top;
				if(ls) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l }).left - inst.margins.left;
				if(rs) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r - inst.helperProportions.width }).left - inst.margins.left;
			}

			if(!inst.snapElements[i].snapping && (ts || bs || ls || rs || first))
				(inst.options.snap.snap && inst.options.snap.snap.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
			inst.snapElements[i].snapping = (ts || bs || ls || rs || first);

		};

	}
});

$.ui.plugin.add("draggable", "stack", {
	start: function(event, ui) {

		var o = $(this).data("draggable").options;

		var group = $.makeArray($(o.stack)).sort(function(a,b) {
			return (parseInt($(a).css("zIndex"),10) || 0) - (parseInt($(b).css("zIndex"),10) || 0);
		});
		if (!group.length) { return; }
		
		var min = parseInt(group[0].style.zIndex) || 0;
		$(group).each(function(i) {
			this.style.zIndex = min + i;
		});

		this[0].style.zIndex = min + group.length;

	}
});

$.ui.plugin.add("draggable", "zIndex", {
	start: function(event, ui) {
		var t = $(ui.helper), o = $(this).data("draggable").options;
		if(t.css("zIndex")) o._zIndex = t.css("zIndex");
		t.css('zIndex', o.zIndex);
	},
	stop: function(event, ui) {
		var o = $(this).data("draggable").options;
		if(o._zIndex) $(ui.helper).css('zIndex', o._zIndex);
	}
});

})(jQuery);
/*!
 * jQuery UI Droppable 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Droppables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *	jquery.ui.mouse.js
 *	jquery.ui.draggable.js
 */
(function( $, undefined ) {

$.widget("ui.droppable", {
	widgetEventPrefix: "drop",
	options: {
		accept: '*',
		activeClass: false,
		addClasses: true,
		greedy: false,
		hoverClass: false,
		scope: 'default',
		tolerance: 'intersect'
	},
	_create: function() {

		var o = this.options, accept = o.accept;
		this.isover = 0; this.isout = 1;

		this.accept = $.isFunction(accept) ? accept : function(d) {
			return d.is(accept);
		};

		//Store the droppable's proportions
		this.proportions = { width: this.element[0].offsetWidth, height: this.element[0].offsetHeight };

		// Add the reference and positions to the manager
		$.ui.ddmanager.droppables[o.scope] = $.ui.ddmanager.droppables[o.scope] || [];
		$.ui.ddmanager.droppables[o.scope].push(this);

		(o.addClasses && this.element.addClass("ui-droppable"));

	},

	destroy: function() {
		var drop = $.ui.ddmanager.droppables[this.options.scope];
		for ( var i = 0; i < drop.length; i++ )
			if ( drop[i] == this )
				drop.splice(i, 1);

		this.element
			.removeClass("ui-droppable ui-droppable-disabled")
			.removeData("droppable")
			.unbind(".droppable");

		return this;
	},

	_setOption: function(key, value) {

		if(key == 'accept') {
			this.accept = $.isFunction(value) ? value : function(d) {
				return d.is(value);
			};
		}
		$.Widget.prototype._setOption.apply(this, arguments);
	},

	_activate: function(event) {
		var draggable = $.ui.ddmanager.current;
		if(this.options.activeClass) this.element.addClass(this.options.activeClass);
		(draggable && this._trigger('activate', event, this.ui(draggable)));
	},

	_deactivate: function(event) {
		var draggable = $.ui.ddmanager.current;
		if(this.options.activeClass) this.element.removeClass(this.options.activeClass);
		(draggable && this._trigger('deactivate', event, this.ui(draggable)));
	},

	_over: function(event) {

		var draggable = $.ui.ddmanager.current;
		if (!draggable || (draggable.currentItem || draggable.element)[0] == this.element[0]) return; // Bail if draggable and droppable are same element
		if (this.accept.call(this.element[0],(draggable.currentItem || draggable.element))) {
			if(this.options.hoverClass) this.element.addClass(this.options.hoverClass);
			this._trigger('over', event, this.ui(draggable));
		}

	},

	_out: function(event) {

		var draggable = $.ui.ddmanager.current;
		if (!draggable || (draggable.currentItem || draggable.element)[0] == this.element[0]) return; // Bail if draggable and droppable are same element

		if (this.accept.call(this.element[0],(draggable.currentItem || draggable.element))) {
			if(this.options.hoverClass) this.element.removeClass(this.options.hoverClass);
			this._trigger('out', event, this.ui(draggable));
		}

	},

	_drop: function(event,custom) {

		var draggable = custom || $.ui.ddmanager.current;
		if (!draggable || (draggable.currentItem || draggable.element)[0] == this.element[0]) return false; // Bail if draggable and droppable are same element

		var childrenIntersection = false;
		this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function() {
			var inst = $.data(this, 'droppable');
			if(
				inst.options.greedy
				&& !inst.options.disabled
				&& inst.options.scope == draggable.options.scope
				&& inst.accept.call(inst.element[0], (draggable.currentItem || draggable.element))
				&& $.ui.intersect(draggable, $.extend(inst, { offset: inst.element.offset() }), inst.options.tolerance)
			) { childrenIntersection = true; return false; }
		});
		if(childrenIntersection) return false;

		if(this.accept.call(this.element[0],(draggable.currentItem || draggable.element))) {
			if(this.options.activeClass) this.element.removeClass(this.options.activeClass);
			if(this.options.hoverClass) this.element.removeClass(this.options.hoverClass);
			this._trigger('drop', event, this.ui(draggable));
			return this.element;
		}

		return false;

	},
    //hugo
	ui: function(c) {
		return {
			draggable: (c.currentItem || c.element),
			helper: c.helper,
			position: c.position,
			offset: c.positionAbs
		};
	}

});

$.extend($.ui.droppable, {
	version: "1.8.22"
});

$.ui.intersect = function(draggable, droppable, toleranceMode) {

	if (!droppable.offset) return false;

	var x1 = (draggable.positionAbs || draggable.position.absolute).left, x2 = x1 + draggable.helperProportions.width,
		y1 = (draggable.positionAbs || draggable.position.absolute).top, y2 = y1 + draggable.helperProportions.height;
	var l = droppable.offset.left, r = l + droppable.proportions.width,
		t = droppable.offset.top, b = t + droppable.proportions.height;

	switch (toleranceMode) {
		case 'fit':
			return (l <= x1 && x2 <= r
				&& t <= y1 && y2 <= b);
			break;
		case 'intersect':
			return (l < x1 + (draggable.helperProportions.width / 2) // Right Half
				&& x2 - (draggable.helperProportions.width / 2) < r // Left Half
				&& t < y1 + (draggable.helperProportions.height / 2) // Bottom Half
				&& y2 - (draggable.helperProportions.height / 2) < b ); // Top Half
			break;
		case 'pointer':
			var draggableLeft = ((draggable.positionAbs || draggable.position.absolute).left + (draggable.clickOffset || draggable.offset.click).left),
				draggableTop = ((draggable.positionAbs || draggable.position.absolute).top + (draggable.clickOffset || draggable.offset.click).top),
				isOver = $.ui.isOver(draggableTop, draggableLeft, t, l, droppable.proportions.height, droppable.proportions.width);
			return isOver;
			break;
		case 'touch':
			return (
					(y1 >= t && y1 <= b) ||	// Top edge touching
					(y2 >= t && y2 <= b) ||	// Bottom edge touching
					(y1 < t && y2 > b)		// Surrounded vertically
				) && (
					(x1 >= l && x1 <= r) ||	// Left edge touching
					(x2 >= l && x2 <= r) ||	// Right edge touching
					(x1 < l && x2 > r)		// Surrounded horizontally
				);
			break;
		default:
			return false;
			break;
		}

};

/*
	This manager tracks offsets of draggables and droppables
*/
$.ui.ddmanager = {
	current: null,
	droppables: { 'default': [] },
	prepareOffsets: function(t, event) {

		var m = $.ui.ddmanager.droppables[t.options.scope] || [];
		var type = event ? event.type : null; // workaround for #2317
		var list = (t.currentItem || t.element).find(":data(droppable)").andSelf();

		droppablesLoop: for (var i = 0; i < m.length; i++) {

			if(m[i].options.disabled || (t && !m[i].accept.call(m[i].element[0],(t.currentItem || t.element)))) continue;	//No disabled and non-accepted
			for (var j=0; j < list.length; j++) { if(list[j] == m[i].element[0]) { m[i].proportions.height = 0; continue droppablesLoop; } }; //Filter out elements in the current dragged item
			m[i].visible = m[i].element.css("display") != "none"; if(!m[i].visible) continue; 									//If the element is not visible, continue

			if(type == "mousedown") m[i]._activate.call(m[i], event); //Activate the droppable if used directly from draggables

			m[i].offset = m[i].element.offset();
			m[i].proportions = { width: m[i].element[0].offsetWidth, height: m[i].element[0].offsetHeight };

		}

	},
	drop: function(draggable, event) {

		var dropped = false;
		$.each($.ui.ddmanager.droppables[draggable.options.scope] || [], function() {

			if(!this.options) return;
			if (!this.options.disabled && this.visible && $.ui.intersect(draggable, this, this.options.tolerance))
				dropped = this._drop.call(this, event) || dropped;

			if (!this.options.disabled && this.visible && this.accept.call(this.element[0],(draggable.currentItem || draggable.element))) {
				this.isout = 1; this.isover = 0;
				this._deactivate.call(this, event);
			}

		});
		return dropped;

	},
	dragStart: function( draggable, event ) {
		//Listen for scrolling so that if the dragging causes scrolling the position of the droppables can be recalculated (see #5003)
		draggable.element.parents( ":not(body,html)" ).bind( "scroll.droppable", function() {
			if( !draggable.options.refreshPositions ) $.ui.ddmanager.prepareOffsets( draggable, event );
		});
	},
	drag: function(draggable, event) {

		//If you have a highly dynamic page, you might try this option. It renders positions every time you move the mouse.
		if(draggable.options.refreshPositions) $.ui.ddmanager.prepareOffsets(draggable, event);

		//Run through all droppables and check their positions based on specific tolerance options
		$.each($.ui.ddmanager.droppables[draggable.options.scope] || [], function() {

			if(this.options.disabled || this.greedyChild || !this.visible) return;
			var intersects = $.ui.intersect(draggable, this, this.options.tolerance);

			var c = !intersects && this.isover == 1 ? 'isout' : (intersects && this.isover == 0 ? 'isover' : null);
			if(!c) return;

			var parentInstance;
			if (this.options.greedy) {
				var parent = this.element.parents(':data(droppable):eq(0)');
				if (parent.length) {
					parentInstance = $.data(parent[0], 'droppable');
					parentInstance.greedyChild = (c == 'isover' ? 1 : 0);
				}
			}

			// we just moved into a greedy child
			if (parentInstance && c == 'isover') {
				parentInstance['isover'] = 0;
				parentInstance['isout'] = 1;
				parentInstance._out.call(parentInstance, event);
			}

			this[c] = 1; this[c == 'isout' ? 'isover' : 'isout'] = 0;
			this[c == "isover" ? "_over" : "_out"].call(this, event);

			// we just moved out of a greedy child
			if (parentInstance && c == 'isout') {
				parentInstance['isout'] = 0;
				parentInstance['isover'] = 1;
				parentInstance._over.call(parentInstance, event);
			}
		});

	},
	dragStop: function( draggable, event ) {
		draggable.element.parents( ":not(body,html)" ).unbind( "scroll.droppable" );
		//Call prepareOffsets one final time since IE does not fire return scroll events when overflow was caused by drag (see #5003)
		if( !draggable.options.refreshPositions ) $.ui.ddmanager.prepareOffsets( draggable, event );
	}
};

})(jQuery);
/*!
 * jQuery UI Resizable 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Resizables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget("ui.resizable", $.ui.mouse, {
	widgetEventPrefix: "resize",
	options: {
		alsoResize: false,
		animate: false,
		animateDuration: "slow",
		animateEasing: "swing",
		aspectRatio: false,
		autoHide: false,
		containment: false,
		ghost: false,
		grid: false,
		handles: "e,s,se",
		helper: false,
		maxHeight: null,
		maxWidth: null,
		minHeight: 10,
		minWidth: 10,
		zIndex: 1000
	},
	_create: function() {

		var self = this, o = this.options;
		this.element.addClass("ui-resizable");

		$.extend(this, {
			_aspectRatio: !!(o.aspectRatio),
			aspectRatio: o.aspectRatio,
			originalElement: this.element,
			_proportionallyResizeElements: [],
			_helper: o.helper || o.ghost || o.animate ? o.helper || 'ui-resizable-helper' : null
		});

		//Wrap the element if it cannot hold child nodes
		if(this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)) {

			//Create a wrapper element and set the wrapper to the new current internal element
			this.element.wrap(
				$('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({
					position: this.element.css('position'),
					width: this.element.outerWidth(),
					height: this.element.outerHeight(),
					top: this.element.css('top'),
					left: this.element.css('left')
				})
			);

			//Overwrite the original this.element
			this.element = this.element.parent().data(
				"resizable", this.element.data('resizable')
			);

			this.elementIsWrapper = true;

			//Move margins to the wrapper
			this.element.css({ marginLeft: this.originalElement.css("marginLeft"), marginTop: this.originalElement.css("marginTop"), marginRight: this.originalElement.css("marginRight"), marginBottom: this.originalElement.css("marginBottom") });
			this.originalElement.css({ marginLeft: 0, marginTop: 0, marginRight: 0, marginBottom: 0});

			//Prevent Safari textarea resize
			this.originalResizeStyle = this.originalElement.css('resize');
			this.originalElement.css('resize', 'none');

			//Push the actual element to our proportionallyResize internal array
			this._proportionallyResizeElements.push(this.originalElement.css({ position: 'static', zoom: 1, display: 'block' }));

			// avoid IE jump (hard set the margin)
			this.originalElement.css({ margin: this.originalElement.css('margin') });

			// fix handlers offset
			this._proportionallyResize();

		}

		this.handles = o.handles || (!$('.ui-resizable-handle', this.element).length ? "e,s,se" : { n: '.ui-resizable-n', e: '.ui-resizable-e', s: '.ui-resizable-s', w: '.ui-resizable-w', se: '.ui-resizable-se', sw: '.ui-resizable-sw', ne: '.ui-resizable-ne', nw: '.ui-resizable-nw' });
		if(this.handles.constructor == String) {

			if(this.handles == 'all') this.handles = 'n,e,s,w,se,sw,ne,nw';
			var n = this.handles.split(","); this.handles = {};

			for(var i = 0; i < n.length; i++) {

				var handle = $.trim(n[i]), hname = 'ui-resizable-'+handle;
				var axis = $('<div class="ui-resizable-handle ' + hname + '"></div>');

				// Apply zIndex to all handles - see #7960
				axis.css({ zIndex: o.zIndex });

				//TODO : What's going on here?
				if ('se' == handle) {
					axis.addClass('ui-icon ui-icon-gripsmall-diagonal-se');
				};

				//Insert into internal handles object and append to element
				this.handles[handle] = '.ui-resizable-'+handle;
				this.element.append(axis);
			}

		}

		this._renderAxis = function(target) {

			target = target || this.element;

			for(var i in this.handles) {

				if(this.handles[i].constructor == String)
					this.handles[i] = $(this.handles[i], this.element).show();

				//Apply pad to wrapper element, needed to fix axis position (textarea, inputs, scrolls)
				if (this.elementIsWrapper && this.originalElement[0].nodeName.match(/textarea|input|select|button/i)) {

					var axis = $(this.handles[i], this.element), padWrapper = 0;

					//Checking the correct pad and border
					padWrapper = /sw|ne|nw|se|n|s/.test(i) ? axis.outerHeight() : axis.outerWidth();

					//The padding type i have to apply...
					var padPos = [ 'padding',
						/ne|nw|n/.test(i) ? 'Top' :
						/se|sw|s/.test(i) ? 'Bottom' :
						/^e$/.test(i) ? 'Right' : 'Left' ].join("");

					target.css(padPos, padWrapper);

					this._proportionallyResize();

				}

				//TODO: What's that good for? There's not anything to be executed left
				if(!$(this.handles[i]).length)
					continue;

			}
		};

		//TODO: make renderAxis a prototype function
		this._renderAxis(this.element);

		this._handles = $('.ui-resizable-handle', this.element)
			.disableSelection();

		//Matching axis name
		this._handles.mouseover(function() {
			if (!self.resizing) {
				if (this.className)
					var axis = this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);
				//Axis, default = se
				self.axis = axis && axis[1] ? axis[1] : 'se';
			}
		});

		//If we want to auto hide the elements
		if (o.autoHide) {
			this._handles.hide();
			$(this.element)
				.addClass("ui-resizable-autohide")
				.hover(function() {
					if (o.disabled) return;
					$(this).removeClass("ui-resizable-autohide");
					self._handles.show();
				},
				function(){
					if (o.disabled) return;
					if (!self.resizing) {
						$(this).addClass("ui-resizable-autohide");
						self._handles.hide();
					}
				});
		}

		//Initialize the mouse interaction
		this._mouseInit();

	},

	destroy: function() {

		this._mouseDestroy();

		var _destroy = function(exp) {
			$(exp).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing")
				.removeData("resizable").unbind(".resizable").find('.ui-resizable-handle').remove();
		};

		//TODO: Unwrap at same DOM position
		if (this.elementIsWrapper) {
			_destroy(this.element);
			var wrapper = this.element;
			wrapper.after(
				this.originalElement.css({
					position: wrapper.css('position'),
					width: wrapper.outerWidth(),
					height: wrapper.outerHeight(),
					top: wrapper.css('top'),
					left: wrapper.css('left')
				})
			).remove();
		}

		this.originalElement.css('resize', this.originalResizeStyle);
		_destroy(this.originalElement);

		return this;
	},

	_mouseCapture: function(event) {
		var handle = false;
		for (var i in this.handles) {
			if ($(this.handles[i])[0] == event.target) {
				handle = true;
			}
		}

		return !this.options.disabled && handle;
	},

	_mouseStart: function(event) {

		var o = this.options, iniPos = this.element.position(), el = this.element;

		this.resizing = true;
		this.documentScroll = { top: $(document).scrollTop(), left: $(document).scrollLeft() };

		// bugfix for http://dev.jquery.com/ticket/1749
		if (el.is('.ui-draggable') || (/absolute/).test(el.css('position'))) {
			el.css({ position: 'absolute', top: iniPos.top, left: iniPos.left });
		}

		this._renderProxy();

		var curleft = num(this.helper.css('left')), curtop = num(this.helper.css('top'));

		if (o.containment) {
			curleft += $(o.containment).scrollLeft() || 0;
			curtop += $(o.containment).scrollTop() || 0;
		}

		//Store needed variables
		this.offset = this.helper.offset();
		this.position = { left: curleft, top: curtop };
		this.size = this._helper ? { width: el.outerWidth(), height: el.outerHeight() } : { width: el.width(), height: el.height() };
		this.originalSize = this._helper ? { width: el.outerWidth(), height: el.outerHeight() } : { width: el.width(), height: el.height() };
		this.originalPosition = { left: curleft, top: curtop };
		this.sizeDiff = { width: el.outerWidth() - el.width(), height: el.outerHeight() - el.height() };
		this.originalMousePosition = { left: event.pageX, top: event.pageY };

		//Aspect Ratio
		this.aspectRatio = (typeof o.aspectRatio == 'number') ? o.aspectRatio : ((this.originalSize.width / this.originalSize.height) || 1);

	    var cursor = $('.ui-resizable-' + this.axis).css('cursor');
	    $('body').css('cursor', cursor == 'auto' ? this.axis + '-resize' : cursor);

		el.addClass("ui-resizable-resizing");
		this._propagate("start", event);
		return true;
	},

	_mouseDrag: function(event) {

		//Increase performance, avoid regex
		var el = this.helper, o = this.options, props = {},
			self = this, smp = this.originalMousePosition, a = this.axis;

		var dx = (event.pageX-smp.left)||0, dy = (event.pageY-smp.top)||0;
		var trigger = this._change[a];
		if (!trigger) return false;

		// Calculate the attrs that will be change
		var data = trigger.apply(this, [event, dx, dy]), ie6 = $.browser.msie && $.browser.version < 7, csdif = this.sizeDiff;

		// Put this in the mouseDrag handler since the user can start pressing shift while resizing
		this._updateVirtualBoundaries(event.shiftKey);
		if (this._aspectRatio || event.shiftKey)
			data = this._updateRatio(data, event);

		data = this._respectSize(data, event);

		// plugins callbacks need to be called first
		this._propagate("resize", event);

		el.css({
			top: this.position.top + "px", left: this.position.left + "px",
			width: this.size.width + "px", height: this.size.height + "px"
		});

		if (!this._helper && this._proportionallyResizeElements.length)
			this._proportionallyResize();

		this._updateCache(data);

		// calling the user callback at the end
		this._trigger('resize', event, this.ui());

		return false;
	},

	_mouseStop: function(event) {

		this.resizing = false;
		var o = this.options, self = this;

		if(this._helper) {
			var pr = this._proportionallyResizeElements, ista = pr.length && (/textarea/i).test(pr[0].nodeName),
				soffseth = ista && $.ui.hasScroll(pr[0], 'left') /* TODO - jump height */ ? 0 : self.sizeDiff.height,
				soffsetw = ista ? 0 : self.sizeDiff.width;

			var s = { width: (self.helper.width()  - soffsetw), height: (self.helper.height() - soffseth) },
				left = (parseInt(self.element.css('left'), 10) + (self.position.left - self.originalPosition.left)) || null,
				top = (parseInt(self.element.css('top'), 10) + (self.position.top - self.originalPosition.top)) || null;

			if (!o.animate)
				this.element.css($.extend(s, { top: top, left: left }));

			self.helper.height(self.size.height);
			self.helper.width(self.size.width);

			if (this._helper && !o.animate) this._proportionallyResize();
		}

		$('body').css('cursor', 'auto');

		this.element.removeClass("ui-resizable-resizing");

		this._propagate("stop", event);

		if (this._helper) this.helper.remove();
		return false;

	},

    _updateVirtualBoundaries: function(forceAspectRatio) {
        var o = this.options, pMinWidth, pMaxWidth, pMinHeight, pMaxHeight, b;

        b = {
            minWidth: isNumber(o.minWidth) ? o.minWidth : 0,
            maxWidth: isNumber(o.maxWidth) ? o.maxWidth : Infinity,
            minHeight: isNumber(o.minHeight) ? o.minHeight : 0,
            maxHeight: isNumber(o.maxHeight) ? o.maxHeight : Infinity
        };

        if(this._aspectRatio || forceAspectRatio) {
            // We want to create an enclosing box whose aspect ration is the requested one
            // First, compute the "projected" size for each dimension based on the aspect ratio and other dimension
            pMinWidth = b.minHeight * this.aspectRatio;
            pMinHeight = b.minWidth / this.aspectRatio;
            pMaxWidth = b.maxHeight * this.aspectRatio;
            pMaxHeight = b.maxWidth / this.aspectRatio;

            if(pMinWidth > b.minWidth) b.minWidth = pMinWidth;
            if(pMinHeight > b.minHeight) b.minHeight = pMinHeight;
            if(pMaxWidth < b.maxWidth) b.maxWidth = pMaxWidth;
            if(pMaxHeight < b.maxHeight) b.maxHeight = pMaxHeight;
        }
        this._vBoundaries = b;
    },

	_updateCache: function(data) {
		var o = this.options;
		this.offset = this.helper.offset();
		if (isNumber(data.left)) this.position.left = data.left;
		if (isNumber(data.top)) this.position.top = data.top;
		if (isNumber(data.height)) this.size.height = data.height;
		if (isNumber(data.width)) this.size.width = data.width;
	},

	_updateRatio: function(data, event) {

		var o = this.options, cpos = this.position, csize = this.size, a = this.axis;

		if (isNumber(data.height)) data.width = (data.height * this.aspectRatio);
		else if (isNumber(data.width)) data.height = (data.width / this.aspectRatio);

		if (a == 'sw') {
			data.left = cpos.left + (csize.width - data.width);
			data.top = null;
		}
		if (a == 'nw') {
			data.top = cpos.top + (csize.height - data.height);
			data.left = cpos.left + (csize.width - data.width);
		}

		return data;
	},

	_respectSize: function(data, event) {

		var el = this.helper, o = this._vBoundaries, pRatio = this._aspectRatio || event.shiftKey, a = this.axis,
				ismaxw = isNumber(data.width) && o.maxWidth && (o.maxWidth < data.width), ismaxh = isNumber(data.height) && o.maxHeight && (o.maxHeight < data.height),
					isminw = isNumber(data.width) && o.minWidth && (o.minWidth > data.width), isminh = isNumber(data.height) && o.minHeight && (o.minHeight > data.height);

		if (isminw) data.width = o.minWidth;
		if (isminh) data.height = o.minHeight;
		if (ismaxw) data.width = o.maxWidth;
		if (ismaxh) data.height = o.maxHeight;

		var dw = this.originalPosition.left + this.originalSize.width, dh = this.position.top + this.size.height;
		var cw = /sw|nw|w/.test(a), ch = /nw|ne|n/.test(a);

		if (isminw && cw) data.left = dw - o.minWidth;
		if (ismaxw && cw) data.left = dw - o.maxWidth;
		if (isminh && ch)	data.top = dh - o.minHeight;
		if (ismaxh && ch)	data.top = dh - o.maxHeight;

		// fixing jump error on top/left - bug #2330
		var isNotwh = !data.width && !data.height;
		if (isNotwh && !data.left && data.top) data.top = null;
		else if (isNotwh && !data.top && data.left) data.left = null;

		return data;
	},

	_proportionallyResize: function() {

		var o = this.options;
		if (!this._proportionallyResizeElements.length) return;
		var element = this.helper || this.element;

		for (var i=0; i < this._proportionallyResizeElements.length; i++) {

			var prel = this._proportionallyResizeElements[i];

			if (!this.borderDif) {
				var b = [prel.css('borderTopWidth'), prel.css('borderRightWidth'), prel.css('borderBottomWidth'), prel.css('borderLeftWidth')],
					p = [prel.css('paddingTop'), prel.css('paddingRight'), prel.css('paddingBottom'), prel.css('paddingLeft')];

				this.borderDif = $.map(b, function(v, i) {
					var border = parseInt(v,10)||0, padding = parseInt(p[i],10)||0;
					return border + padding;
				});
			}

			if ($.browser.msie && !(!($(element).is(':hidden') || $(element).parents(':hidden').length)))
				continue;

			prel.css({
				height: (element.height() - this.borderDif[0] - this.borderDif[2]) || 0,
				width: (element.width() - this.borderDif[1] - this.borderDif[3]) || 0
			});

		};

	},

	_renderProxy: function() {

		var el = this.element, o = this.options;
		this.elementOffset = el.offset();

		if(this._helper) {

			this.helper = this.helper || $('<div style="overflow:hidden;"></div>');

			// fix ie6 offset TODO: This seems broken
			var ie6 = $.browser.msie && $.browser.version < 7, ie6offset = (ie6 ? 1 : 0),
			pxyoffset = ( ie6 ? 2 : -1 );

			this.helper.addClass(this._helper).css({
				width: this.element.outerWidth() + pxyoffset,
				height: this.element.outerHeight() + pxyoffset,
				position: 'absolute',
				left: this.elementOffset.left - ie6offset +'px',
				top: this.elementOffset.top - ie6offset +'px',
				zIndex: ++o.zIndex //TODO: Don't modify option
			});

			this.helper
				.appendTo("body")
				.disableSelection();

		} else {
			this.helper = this.element;
		}

	},

	_change: {
		e: function(event, dx, dy) {
			return { width: this.originalSize.width + dx };
		},
		w: function(event, dx, dy) {
			var o = this.options, cs = this.originalSize, sp = this.originalPosition;
			return { left: sp.left + dx, width: cs.width - dx };
		},
		n: function(event, dx, dy) {
			var o = this.options, cs = this.originalSize, sp = this.originalPosition;
			return { top: sp.top + dy, height: cs.height - dy };
		},
		s: function(event, dx, dy) {
			return { height: this.originalSize.height + dy };
		},
		se: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments), this._change.e.apply(this, [event, dx, dy]));
		},
		sw: function(event, dx, dy) {
			return $.extend(this._change.s.apply(this, arguments), this._change.w.apply(this, [event, dx, dy]));
		},
		ne: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments), this._change.e.apply(this, [event, dx, dy]));
		},
		nw: function(event, dx, dy) {
			return $.extend(this._change.n.apply(this, arguments), this._change.w.apply(this, [event, dx, dy]));
		}
	},

	_propagate: function(n, event) {
		$.ui.plugin.call(this, n, [event, this.ui()]);
		(n != "resize" && this._trigger(n, event, this.ui()));
	},

	plugins: {},

	ui: function() {
		return {
			originalElement: this.originalElement,
			element: this.element,
			helper: this.helper,
			position: this.position,
			size: this.size,
			originalSize: this.originalSize,
			originalPosition: this.originalPosition
		};
	}

});

$.extend($.ui.resizable, {
	version: "1.8.22"
});

/*
 * Resizable Extensions
 */

$.ui.plugin.add("resizable", "alsoResize", {

	start: function (event, ui) {
		var self = $(this).data("resizable"), o = self.options;

		var _store = function (exp) {
			$(exp).each(function() {
				var el = $(this);
				el.data("resizable-alsoresize", {
					width: parseInt(el.width(), 10), height: parseInt(el.height(), 10),
					left: parseInt(el.css('left'), 10), top: parseInt(el.css('top'), 10)
				});
			});
		};

		if (typeof(o.alsoResize) == 'object' && !o.alsoResize.parentNode) {
			if (o.alsoResize.length) { o.alsoResize = o.alsoResize[0]; _store(o.alsoResize); }
			else { $.each(o.alsoResize, function (exp) { _store(exp); }); }
		}else{
			_store(o.alsoResize);
		}
	},

	resize: function (event, ui) {
		var self = $(this).data("resizable"), o = self.options, os = self.originalSize, op = self.originalPosition;

		var delta = {
			height: (self.size.height - os.height) || 0, width: (self.size.width - os.width) || 0,
			top: (self.position.top - op.top) || 0, left: (self.position.left - op.left) || 0
		},

		_alsoResize = function (exp, c) {
			$(exp).each(function() {
				var el = $(this), start = $(this).data("resizable-alsoresize"), style = {}, 
					css = c && c.length ? c : el.parents(ui.originalElement[0]).length ? ['width', 'height'] : ['width', 'height', 'top', 'left'];

				$.each(css, function (i, prop) {
					var sum = (start[prop]||0) + (delta[prop]||0);
					if (sum && sum >= 0)
						style[prop] = sum || null;
				});

				el.css(style);
			});
		};

		if (typeof(o.alsoResize) == 'object' && !o.alsoResize.nodeType) {
			$.each(o.alsoResize, function (exp, c) { _alsoResize(exp, c); });
		}else{
			_alsoResize(o.alsoResize);
		}
	},

	stop: function (event, ui) {
		$(this).removeData("resizable-alsoresize");
	}
});

$.ui.plugin.add("resizable", "animate", {

	stop: function(event, ui) {
		var self = $(this).data("resizable"), o = self.options;

		var pr = self._proportionallyResizeElements, ista = pr.length && (/textarea/i).test(pr[0].nodeName),
					soffseth = ista && $.ui.hasScroll(pr[0], 'left') /* TODO - jump height */ ? 0 : self.sizeDiff.height,
						soffsetw = ista ? 0 : self.sizeDiff.width;

		var style = { width: (self.size.width - soffsetw), height: (self.size.height - soffseth) },
					left = (parseInt(self.element.css('left'), 10) + (self.position.left - self.originalPosition.left)) || null,
						top = (parseInt(self.element.css('top'), 10) + (self.position.top - self.originalPosition.top)) || null;

		self.element.animate(
			$.extend(style, top && left ? { top: top, left: left } : {}), {
				duration: o.animateDuration,
				easing: o.animateEasing,
				step: function() {

					var data = {
						width: parseInt(self.element.css('width'), 10),
						height: parseInt(self.element.css('height'), 10),
						top: parseInt(self.element.css('top'), 10),
						left: parseInt(self.element.css('left'), 10)
					};

					if (pr && pr.length) $(pr[0]).css({ width: data.width, height: data.height });

					// propagating resize, and updating values for each animation step
					self._updateCache(data);
					self._propagate("resize", event);

				}
			}
		);
	}

});

$.ui.plugin.add("resizable", "containment", {

	start: function(event, ui) {
		var self = $(this).data("resizable"), o = self.options, el = self.element;
		var oc = o.containment,	ce = (oc instanceof $) ? oc.get(0) : (/parent/.test(oc)) ? el.parent().get(0) : oc;
		if (!ce) return;

		self.containerElement = $(ce);

		if (/document/.test(oc) || oc == document) {
			self.containerOffset = { left: 0, top: 0 };
			self.containerPosition = { left: 0, top: 0 };

			self.parentData = {
				element: $(document), left: 0, top: 0,
				width: $(document).width(), height: $(document).height() || document.body.parentNode.scrollHeight
			};
		}

		// i'm a node, so compute top, left, right, bottom
		else {
			var element = $(ce), p = [];
			$([ "Top", "Right", "Left", "Bottom" ]).each(function(i, name) { p[i] = num(element.css("padding" + name)); });

			self.containerOffset = element.offset();
			self.containerPosition = element.position();
			self.containerSize = { height: (element.innerHeight() - p[3]), width: (element.innerWidth() - p[1]) };

			var co = self.containerOffset, ch = self.containerSize.height,	cw = self.containerSize.width,
						width = ($.ui.hasScroll(ce, "left") ? ce.scrollWidth : cw ), height = ($.ui.hasScroll(ce) ? ce.scrollHeight : ch);

			self.parentData = {
				element: ce, left: co.left, top: co.top, width: width, height: height
			};
		}
	},

	resize: function(event, ui) {
		var self = $(this).data("resizable"), o = self.options,
				ps = self.containerSize, co = self.containerOffset, cs = self.size, cp = self.position,
				pRatio = self._aspectRatio || event.shiftKey, cop = { top:0, left:0 }, ce = self.containerElement;

		if (ce[0] != document && (/static/).test(ce.css('position'))) cop = co;

		if (cp.left < (self._helper ? co.left : 0)) {
			self.size.width = self.size.width + (self._helper ? (self.position.left - co.left) : (self.position.left - cop.left));
			if (pRatio) self.size.height = self.size.width / self.aspectRatio;
			self.position.left = o.helper ? co.left : 0;
		}

		if (cp.top < (self._helper ? co.top : 0)) {
			self.size.height = self.size.height + (self._helper ? (self.position.top - co.top) : self.position.top);
			if (pRatio) self.size.width = self.size.height * self.aspectRatio;
			self.position.top = self._helper ? co.top : 0;
		}

		self.offset.left = self.parentData.left+self.position.left;
		self.offset.top = self.parentData.top+self.position.top;

		var woset = Math.abs( (self._helper ? self.offset.left - cop.left : (self.offset.left - cop.left)) + self.sizeDiff.width ),
					hoset = Math.abs( (self._helper ? self.offset.top - cop.top : (self.offset.top - co.top)) + self.sizeDiff.height );

		var isParent = self.containerElement.get(0) == self.element.parent().get(0),
		    isOffsetRelative = /relative|absolute/.test(self.containerElement.css('position'));

		if(isParent && isOffsetRelative) woset -= self.parentData.left;

		if (woset + self.size.width >= self.parentData.width) {
			self.size.width = self.parentData.width - woset;
			if (pRatio) self.size.height = self.size.width / self.aspectRatio;
		}

		if (hoset + self.size.height >= self.parentData.height) {
			self.size.height = self.parentData.height - hoset;
			if (pRatio) self.size.width = self.size.height * self.aspectRatio;
		}
	},

	stop: function(event, ui){
		var self = $(this).data("resizable"), o = self.options, cp = self.position,
				co = self.containerOffset, cop = self.containerPosition, ce = self.containerElement;

		var helper = $(self.helper), ho = helper.offset(), w = helper.outerWidth() - self.sizeDiff.width, h = helper.outerHeight() - self.sizeDiff.height;

		if (self._helper && !o.animate && (/relative/).test(ce.css('position')))
			$(this).css({ left: ho.left - cop.left - co.left, width: w, height: h });

		if (self._helper && !o.animate && (/static/).test(ce.css('position')))
			$(this).css({ left: ho.left - cop.left - co.left, width: w, height: h });

	}
});

$.ui.plugin.add("resizable", "ghost", {

	start: function(event, ui) {

		var self = $(this).data("resizable"), o = self.options, cs = self.size;

		self.ghost = self.originalElement.clone();
		self.ghost
			.css({ opacity: .25, display: 'block', position: 'relative', height: cs.height, width: cs.width, margin: 0, left: 0, top: 0 })
			.addClass('ui-resizable-ghost')
			.addClass(typeof o.ghost == 'string' ? o.ghost : '');

		self.ghost.appendTo(self.helper);

	},

	resize: function(event, ui){
		var self = $(this).data("resizable"), o = self.options;
		if (self.ghost) self.ghost.css({ position: 'relative', height: self.size.height, width: self.size.width });
	},

	stop: function(event, ui){
		var self = $(this).data("resizable"), o = self.options;
		if (self.ghost && self.helper) self.helper.get(0).removeChild(self.ghost.get(0));
	}

});

$.ui.plugin.add("resizable", "grid", {

	resize: function(event, ui) {
		var self = $(this).data("resizable"), o = self.options, cs = self.size, os = self.originalSize, op = self.originalPosition, a = self.axis, ratio = o._aspectRatio || event.shiftKey;
		o.grid = typeof o.grid == "number" ? [o.grid, o.grid] : o.grid;
		var ox = Math.round((cs.width - os.width) / (o.grid[0]||1)) * (o.grid[0]||1), oy = Math.round((cs.height - os.height) / (o.grid[1]||1)) * (o.grid[1]||1);

		if (/^(se|s|e)$/.test(a)) {
			self.size.width = os.width + ox;
			self.size.height = os.height + oy;
		}
		else if (/^(ne)$/.test(a)) {
			self.size.width = os.width + ox;
			self.size.height = os.height + oy;
			self.position.top = op.top - oy;
		}
		else if (/^(sw)$/.test(a)) {
			self.size.width = os.width + ox;
			self.size.height = os.height + oy;
			self.position.left = op.left - ox;
		}
		else {
			self.size.width = os.width + ox;
			self.size.height = os.height + oy;
			self.position.top = op.top - oy;
			self.position.left = op.left - ox;
		}
	}

});

var num = function(v) {
	return parseInt(v, 10) || 0;
};

var isNumber = function(value) {
	return !isNaN(parseInt(value, 10));
};

})(jQuery);
/*!
 * jQuery UI Selectable 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Selectables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget("ui.selectable", $.ui.mouse, {
	options: {
		appendTo: 'body',
		autoRefresh: true,
		distance: 0,
		filter: '*',
		tolerance: 'touch'
	},
	_create: function() {
		var self = this;

		this.element.addClass("ui-selectable");

		this.dragged = false;

		// cache selectee children based on filter
		var selectees;
		this.refresh = function() {
			selectees = $(self.options.filter, self.element[0]);
			selectees.addClass("ui-selectee");
			selectees.each(function() {
				var $this = $(this);
				var pos = $this.offset();
				$.data(this, "selectable-item", {
					element: this,
					$element: $this,
					left: pos.left,
					top: pos.top,
					right: pos.left + $this.outerWidth(),
					bottom: pos.top + $this.outerHeight(),
					startselected: false,
					selected: $this.hasClass('ui-selected'),
					selecting: $this.hasClass('ui-selecting'),
					unselecting: $this.hasClass('ui-unselecting')
				});
			});
		};
		this.refresh();

		this.selectees = selectees.addClass("ui-selectee");

		this._mouseInit();

		this.helper = $("<div class='ui-selectable-helper'></div>");
	},

	destroy: function() {
		this.selectees
			.removeClass("ui-selectee")
			.removeData("selectable-item");
		this.element
			.removeClass("ui-selectable ui-selectable-disabled")
			.removeData("selectable")
			.unbind(".selectable");
		this._mouseDestroy();

		return this;
	},

	_mouseStart: function(event) {
		var self = this;

		this.opos = [event.pageX, event.pageY];

		if (this.options.disabled)
			return;

		var options = this.options;

		this.selectees = $(options.filter, this.element[0]);

		this._trigger("start", event);

		$(options.appendTo).append(this.helper);
		// position helper (lasso)
		this.helper.css({
			"left": event.clientX,
			"top": event.clientY,
			"width": 0,
			"height": 0
		});

		if (options.autoRefresh) {
			this.refresh();
		}

		this.selectees.filter('.ui-selected').each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.startselected = true;
			if (!event.metaKey && !event.ctrlKey) {
				selectee.$element.removeClass('ui-selected');
				selectee.selected = false;
				selectee.$element.addClass('ui-unselecting');
				selectee.unselecting = true;
				// selectable UNSELECTING callback
				self._trigger("unselecting", event, {
					unselecting: selectee.element
				});
			}
		});

		$(event.target).parents().andSelf().each(function() {
			var selectee = $.data(this, "selectable-item");
			if (selectee) {
				var doSelect = (!event.metaKey && !event.ctrlKey) || !selectee.$element.hasClass('ui-selected');
				selectee.$element
					.removeClass(doSelect ? "ui-unselecting" : "ui-selected")
					.addClass(doSelect ? "ui-selecting" : "ui-unselecting");
				selectee.unselecting = !doSelect;
				selectee.selecting = doSelect;
				selectee.selected = doSelect;
				// selectable (UN)SELECTING callback
				if (doSelect) {
					self._trigger("selecting", event, {
						selecting: selectee.element
					});
				} else {
					self._trigger("unselecting", event, {
						unselecting: selectee.element
					});
				}
				return false;
			}
		});

	},

	_mouseDrag: function(event) {
		var self = this;
		this.dragged = true;

		if (this.options.disabled)
			return;

		var options = this.options;

		var x1 = this.opos[0], y1 = this.opos[1], x2 = event.pageX, y2 = event.pageY;
		if (x1 > x2) { var tmp = x2; x2 = x1; x1 = tmp; }
		if (y1 > y2) { var tmp = y2; y2 = y1; y1 = tmp; }
		this.helper.css({left: x1, top: y1, width: x2-x1, height: y2-y1});

		this.selectees.each(function() {
			var selectee = $.data(this, "selectable-item");
			//prevent helper from being selected if appendTo: selectable
			if (!selectee || selectee.element == self.element[0])
				return;
			var hit = false;
			if (options.tolerance == 'touch') {
				hit = ( !(selectee.left > x2 || selectee.right < x1 || selectee.top > y2 || selectee.bottom < y1) );
			} else if (options.tolerance == 'fit') {
				hit = (selectee.left > x1 && selectee.right < x2 && selectee.top > y1 && selectee.bottom < y2);
			}

			if (hit) {
				// SELECT
				if (selectee.selected) {
					selectee.$element.removeClass('ui-selected');
					selectee.selected = false;
				}
				if (selectee.unselecting) {
					selectee.$element.removeClass('ui-unselecting');
					selectee.unselecting = false;
				}
				if (!selectee.selecting) {
					selectee.$element.addClass('ui-selecting');
					selectee.selecting = true;
					// selectable SELECTING callback
					self._trigger("selecting", event, {
						selecting: selectee.element
					});
				}
			} else {
				// UNSELECT
				if (selectee.selecting) {
					if ((event.metaKey || event.ctrlKey) && selectee.startselected) {
						selectee.$element.removeClass('ui-selecting');
						selectee.selecting = false;
						selectee.$element.addClass('ui-selected');
						selectee.selected = true;
					} else {
						selectee.$element.removeClass('ui-selecting');
						selectee.selecting = false;
						if (selectee.startselected) {
							selectee.$element.addClass('ui-unselecting');
							selectee.unselecting = true;
						}
						// selectable UNSELECTING callback
						self._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
				if (selectee.selected) {
					if (!event.metaKey && !event.ctrlKey && !selectee.startselected) {
						selectee.$element.removeClass('ui-selected');
						selectee.selected = false;

						selectee.$element.addClass('ui-unselecting');
						selectee.unselecting = true;
						// selectable UNSELECTING callback
						self._trigger("unselecting", event, {
							unselecting: selectee.element
						});
					}
				}
			}
		});

		return false;
	},

	_mouseStop: function(event) {
		var self = this;

		this.dragged = false;

		var options = this.options;

		$('.ui-unselecting', this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass('ui-unselecting');
			selectee.unselecting = false;
			selectee.startselected = false;
			self._trigger("unselected", event, {
				unselected: selectee.element
			});
		});
		$('.ui-selecting', this.element[0]).each(function() {
			var selectee = $.data(this, "selectable-item");
			selectee.$element.removeClass('ui-selecting').addClass('ui-selected');
			selectee.selecting = false;
			selectee.selected = true;
			selectee.startselected = true;
			self._trigger("selected", event, {
				selected: selectee.element
			});
		});
		this._trigger("stop", event);

		this.helper.remove();

		return false;
	}

});

$.extend($.ui.selectable, {
	version: "1.8.22"
});

})(jQuery);
/*!
 * jQuery UI Sortable 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Sortables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget("ui.sortable", $.ui.mouse, {
	widgetEventPrefix: "sort",
	ready: false,
	options: {
		appendTo: "parent",
		axis: false,
		connectWith: false,
		containment: false,
		cursor: 'auto',
		cursorAt: false,
		dropOnEmpty: true,
		forcePlaceholderSize: false,
		forceHelperSize: false,
		grid: false,
		handle: false,
		helper: "original",
		items: '> *',
		opacity: false,
		placeholder: false,
		revert: false,
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		scope: "default",
		tolerance: "intersect",
		zIndex: 1000
	},
	_create: function() {

		var o = this.options;
		this.containerCache = {};
		this.element.addClass("ui-sortable");

		//Get the items
		this.refresh();

		//Let's determine if the items are being displayed horizontally
		this.floating = this.items.length ? o.axis === 'x' || (/left|right/).test(this.items[0].item.css('float')) || (/inline|table-cell/).test(this.items[0].item.css('display')) : false;

		//Let's determine the parent's offset
		this.offset = this.element.offset();

		//Initialize mouse events for interaction
		this._mouseInit();
		
		//We're ready to go
		this.ready = true

	},

	destroy: function() {
		$.Widget.prototype.destroy.call( this );
		this.element
			.removeClass("ui-sortable ui-sortable-disabled");
		this._mouseDestroy();

		for ( var i = this.items.length - 1; i >= 0; i-- )
			this.items[i].item.removeData(this.widgetName + "-item");

		return this;
	},

	_setOption: function(key, value){
		if ( key === "disabled" ) {
			this.options[ key ] = value;
	
			this.widget()
				[ value ? "addClass" : "removeClass"]( "ui-sortable-disabled" );
		} else {
			// Don't call widget base _setOption for disable as it adds ui-state-disabled class
			$.Widget.prototype._setOption.apply(this, arguments);
		}
	},

	_mouseCapture: function(event, overrideHandle) {
		var that = this;

		if (this.reverting) {
			return false;
		}

		if(this.options.disabled || this.options.type == 'static') return false;

		//We have to refresh the items data once first
		this._refreshItems(event);

		//Find out if the clicked node (or one of its parents) is a actual item in this.items
		var currentItem = null, self = this, nodes = $(event.target).parents().each(function() {
			if($.data(this, that.widgetName + '-item') == self) {
				currentItem = $(this);
				return false;
			}
		});
		if($.data(event.target, that.widgetName + '-item') == self) currentItem = $(event.target);

		if(!currentItem) return false;
		if(this.options.handle && !overrideHandle) {
			var validHandle = false;

			$(this.options.handle, currentItem).find("*").andSelf().each(function() { if(this == event.target) validHandle = true; });
			if(!validHandle) return false;
		}

		this.currentItem = currentItem;
		this._removeCurrentsFromItems();
		return true;

	},

	_mouseStart: function(event, overrideHandle, noActivation) {

		var o = this.options, self = this;
		this.currentContainer = this;

		//We only need to call refreshPositions, because the refreshItems call has been moved to mouseCapture
		this.refreshPositions();

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		//Cache the helper size
		this._cacheHelperProportions();

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Get the next scrolling parent
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.currentItem.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		// Only after we got the offset, we can change the helper's position to absolute
		// TODO: Still need to figure out a way to make relative sorting possible
		this.helper.css("position", "absolute");
		this.cssPosition = this.helper.css("position");
		
		//Generate the original position
		this.originalPosition = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if 'cursorAt' is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Cache the former DOM position
		this.domPosition = { prev: this.currentItem.prev()[0], parent: this.currentItem.parent()[0] };

		//If the helper is not the original, hide the original so it's not playing any role during the drag, won't cause anything bad this way
		if(this.helper[0] != this.currentItem[0]) {
			this.currentItem.hide();
		}

		//Create the placeholder
		this._createPlaceholder();

		//Set a containment if given in the options
		if(o.containment)
			this._setContainment();

		if(o.cursor) { // cursor option
			if ($('body').css("cursor")) this._storedCursor = $('body').css("cursor");
			$('body').css("cursor", o.cursor);
		}

		if(o.opacity) { // opacity option
			if (this.helper.css("opacity")) this._storedOpacity = this.helper.css("opacity");
			this.helper.css("opacity", o.opacity);
		}

		if(o.zIndex) { // zIndex option
			if (this.helper.css("zIndex")) this._storedZIndex = this.helper.css("zIndex");
			this.helper.css("zIndex", o.zIndex);
		}

		//Prepare scrolling
		if(this.scrollParent[0] != document && this.scrollParent[0].tagName != 'HTML')
			this.overflowOffset = this.scrollParent.offset();

		//Call callbacks
		this._trigger("start", event, this._uiHash());

		//Recache the helper size
		if(!this._preserveHelperProportions)
			this._cacheHelperProportions();


		//Post 'activate' events to possible containers
		if(!noActivation) {
			 for (var i = this.containers.length - 1; i >= 0; i--) { this.containers[i]._trigger("activate", event, self._uiHash(this)); }
		}

		//Prepare possible droppables
		if($.ui.ddmanager)
			$.ui.ddmanager.current = this;

		if ($.ui.ddmanager && !o.dropBehaviour)
			$.ui.ddmanager.prepareOffsets(this, event);

		this.dragging = true;

		this.helper.addClass("ui-sortable-helper");
		this._mouseDrag(event); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		return true;

	},

	_mouseDrag: function(event) {

		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		if (!this.lastPositionAbs) {
			this.lastPositionAbs = this.positionAbs;
		}

		//Do scrolling
		if(this.options.scroll) {
			var o = this.options, scrolled = false;
			if(this.scrollParent[0] != document && this.scrollParent[0].tagName != 'HTML') {

				if((this.overflowOffset.top + this.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity)
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop + o.scrollSpeed;
				else if(event.pageY - this.overflowOffset.top < o.scrollSensitivity)
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop - o.scrollSpeed;

				if((this.overflowOffset.left + this.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity)
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft + o.scrollSpeed;
				else if(event.pageX - this.overflowOffset.left < o.scrollSensitivity)
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft - o.scrollSpeed;

			} else {

				if(event.pageY - $(document).scrollTop() < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() - o.scrollSpeed);
				else if($(window).height() - (event.pageY - $(document).scrollTop()) < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() + o.scrollSpeed);

				if(event.pageX - $(document).scrollLeft() < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() - o.scrollSpeed);
				else if($(window).width() - (event.pageX - $(document).scrollLeft()) < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() + o.scrollSpeed);

			}

			if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour)
				$.ui.ddmanager.prepareOffsets(this, event);
		}

		//Regenerate the absolute position used for position checks
		this.positionAbs = this._convertPositionTo("absolute");

		//Set the helper position
		if(!this.options.axis || this.options.axis != "y") this.helper[0].style.left = this.position.left+'px';
		if(!this.options.axis || this.options.axis != "x") this.helper[0].style.top = this.position.top+'px';

		//Rearrange
		for (var i = this.items.length - 1; i >= 0; i--) {

			//Cache variables and intersection, continue if no intersection
			var item = this.items[i], itemElement = item.item[0], intersection = this._intersectsWithPointer(item);
			if (!intersection) continue;

			if(itemElement != this.currentItem[0] //cannot intersect with itself
				&&	this.placeholder[intersection == 1 ? "next" : "prev"]()[0] != itemElement //no useless actions that have been done before
				&&	!$.ui.contains(this.placeholder[0], itemElement) //no action if the item moved is the parent of the item checked
				&& (this.options.type == 'semi-dynamic' ? !$.ui.contains(this.element[0], itemElement) : true)
				//&& itemElement.parentNode == this.placeholder[0].parentNode // only rearrange items within the same container
			) {

				this.direction = intersection == 1 ? "down" : "up";

				if (this.options.tolerance == "pointer" || this._intersectsWithSides(item)) {
					this._rearrange(event, item);
				} else {
					break;
				}

				this._trigger("change", event, this._uiHash());
				break;
			}
		}

		//Post events to containers
		this._contactContainers(event);

		//Interconnect with droppables
		if($.ui.ddmanager) $.ui.ddmanager.drag(this, event);

		//Call callbacks
		this._trigger('sort', event, this._uiHash());

		this.lastPositionAbs = this.positionAbs;
		return false;

	},

	_mouseStop: function(event, noPropagation) {

		if(!event) return;

		//If we are using droppables, inform the manager about the drop
		if ($.ui.ddmanager && !this.options.dropBehaviour)
			$.ui.ddmanager.drop(this, event);

		if(this.options.revert) {
			var self = this;
			var cur = self.placeholder.offset();

			self.reverting = true;

			$(this.helper).animate({
				left: cur.left - this.offset.parent.left - self.margins.left + (this.offsetParent[0] == document.body ? 0 : this.offsetParent[0].scrollLeft),
				top: cur.top - this.offset.parent.top - self.margins.top + (this.offsetParent[0] == document.body ? 0 : this.offsetParent[0].scrollTop)
			}, parseInt(this.options.revert, 10) || 500, function() {
				self._clear(event);
			});
		} else {
			this._clear(event, noPropagation);
		}

		return false;

	},

	cancel: function() {

		var self = this;

		if(this.dragging) {

			this._mouseUp({ target: null });

			if(this.options.helper == "original")
				this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
			else
				this.currentItem.show();

			//Post deactivating events to containers
			for (var i = this.containers.length - 1; i >= 0; i--){
				this.containers[i]._trigger("deactivate", null, self._uiHash(this));
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", null, self._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		if (this.placeholder) {
			//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
			if(this.placeholder[0].parentNode) this.placeholder[0].parentNode.removeChild(this.placeholder[0]);
			if(this.options.helper != "original" && this.helper && this.helper[0].parentNode) this.helper.remove();

			$.extend(this, {
				helper: null,
				dragging: false,
				reverting: false,
				_noFinalSort: null
			});

			if(this.domPosition.prev) {
				$(this.domPosition.prev).after(this.currentItem);
			} else {
				$(this.domPosition.parent).prepend(this.currentItem);
			}
		}

		return this;

	},

	serialize: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected);
		var str = []; o = o || {};

		$(items).each(function() {
			var res = ($(o.item || this).attr(o.attribute || 'id') || '').match(o.expression || (/(.+)[-=_](.+)/));
			if(res) str.push((o.key || res[1]+'[]')+'='+(o.key && o.expression ? res[1] : res[2]));
		});

		if(!str.length && o.key) {
			str.push(o.key + '=');
		}

		return str.join('&');

	},

	toArray: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected);
		var ret = []; o = o || {};

		items.each(function() { ret.push($(o.item || this).attr(o.attribute || 'id') || ''); });
		return ret;

	},

	/* Be careful with the following core functions */
	_intersectsWith: function(item) {

		var x1 = this.positionAbs.left,
			x2 = x1 + this.helperProportions.width,
			y1 = this.positionAbs.top,
			y2 = y1 + this.helperProportions.height;

		var l = item.left,
			r = l + item.width,
			t = item.top,
			b = t + item.height;

		var dyClick = this.offset.click.top,
			dxClick = this.offset.click.left;

		var isOverElement = (y1 + dyClick) > t && (y1 + dyClick) < b && (x1 + dxClick) > l && (x1 + dxClick) < r;

		if(	   this.options.tolerance == "pointer"
			|| this.options.forcePointerForContainers
			|| (this.options.tolerance != "pointer" && this.helperProportions[this.floating ? 'width' : 'height'] > item[this.floating ? 'width' : 'height'])
		) {
			return isOverElement;
		} else {

			return (l < x1 + (this.helperProportions.width / 2) // Right Half
				&& x2 - (this.helperProportions.width / 2) < r // Left Half
				&& t < y1 + (this.helperProportions.height / 2) // Bottom Half
				&& y2 - (this.helperProportions.height / 2) < b ); // Top Half

		}
	},

	_intersectsWithPointer: function(item) {

		var isOverElementHeight = (this.options.axis === 'x') || $.ui.isOverAxis(this.positionAbs.top + this.offset.click.top, item.top, item.height),
			isOverElementWidth = (this.options.axis === 'y') || $.ui.isOverAxis(this.positionAbs.left + this.offset.click.left, item.left, item.width),
			isOverElement = isOverElementHeight && isOverElementWidth,
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (!isOverElement)
			return false;

		return this.floating ?
			( ((horizontalDirection && horizontalDirection == "right") || verticalDirection == "down") ? 2 : 1 )
			: ( verticalDirection && (verticalDirection == "down" ? 2 : 1) );

	},

	_intersectsWithSides: function(item) {

		var isOverBottomHalf = $.ui.isOverAxis(this.positionAbs.top + this.offset.click.top, item.top + (item.height/2), item.height),
			isOverRightHalf = $.ui.isOverAxis(this.positionAbs.left + this.offset.click.left, item.left + (item.width/2), item.width),
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (this.floating && horizontalDirection) {
			return ((horizontalDirection == "right" && isOverRightHalf) || (horizontalDirection == "left" && !isOverRightHalf));
		} else {
			return verticalDirection && ((verticalDirection == "down" && isOverBottomHalf) || (verticalDirection == "up" && !isOverBottomHalf));
		}

	},

	_getDragVerticalDirection: function() {
		var delta = this.positionAbs.top - this.lastPositionAbs.top;
		return delta != 0 && (delta > 0 ? "down" : "up");
	},

	_getDragHorizontalDirection: function() {
		var delta = this.positionAbs.left - this.lastPositionAbs.left;
		return delta != 0 && (delta > 0 ? "right" : "left");
	},

	refresh: function(event) {
		this._refreshItems(event);
		this.refreshPositions();
		return this;
	},

	_connectWith: function() {
		var options = this.options;
		return options.connectWith.constructor == String
			? [options.connectWith]
			: options.connectWith;
	},
	
	_getItemsAsjQuery: function(connected) {

		var self = this;
		var items = [];
		var queries = [];
		var connectWith = this._connectWith();

		if(connectWith && connected) {
			for (var i = connectWith.length - 1; i >= 0; i--){
				var cur = $(connectWith[i]);
				for (var j = cur.length - 1; j >= 0; j--){
					var inst = $.data(cur[j], this.widgetName);
					if(inst && inst != this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element) : $(inst.options.items, inst.element).not(".ui-sortable-helper").not('.ui-sortable-placeholder'), inst]);
					}
				};
			};
		}

		queries.push([$.isFunction(this.options.items) ? this.options.items.call(this.element, null, { options: this.options, item: this.currentItem }) : $(this.options.items, this.element).not(".ui-sortable-helper").not('.ui-sortable-placeholder'), this]);

		for (var i = queries.length - 1; i >= 0; i--){
			queries[i][0].each(function() {
				items.push(this);
			});
		};

		return $(items);

	},

	_removeCurrentsFromItems: function() {

		var list = this.currentItem.find(":data(" + this.widgetName + "-item)");

		for (var i=0; i < this.items.length; i++) {

			for (var j=0; j < list.length; j++) {
				if(list[j] == this.items[i].item[0])
					this.items.splice(i,1);
			};

		};

	},

	_refreshItems: function(event) {

		this.items = [];
		this.containers = [this];
		var items = this.items;
		var self = this;
		var queries = [[$.isFunction(this.options.items) ? this.options.items.call(this.element[0], event, { item: this.currentItem }) : $(this.options.items, this.element), this]];
		var connectWith = this._connectWith();

		if(connectWith && this.ready) { //Shouldn't be run the first time through due to massive slow-down
			for (var i = connectWith.length - 1; i >= 0; i--){
				var cur = $(connectWith[i]);
				for (var j = cur.length - 1; j >= 0; j--){
					var inst = $.data(cur[j], this.widgetName);
					if(inst && inst != this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element[0], event, { item: this.currentItem }) : $(inst.options.items, inst.element), inst]);
						this.containers.push(inst);
					}
				};
			};
		}

		for (var i = queries.length - 1; i >= 0; i--) {
			var targetData = queries[i][1];
			var _queries = queries[i][0];

			for (var j=0, queriesLength = _queries.length; j < queriesLength; j++) {
				var item = $(_queries[j]);

				item.data(this.widgetName + '-item', targetData); // Data for target checking (mouse manager)

				items.push({
					item: item,
					instance: targetData,
					width: 0, height: 0,
					left: 0, top: 0
				});
			};
		};

	},

	refreshPositions: function(fast) {

		//This has to be redone because due to the item being moved out/into the offsetParent, the offsetParent's position will change
		if(this.offsetParent && this.helper) {
			this.offset.parent = this._getParentOffset();
		}

		for (var i = this.items.length - 1; i >= 0; i--){
			var item = this.items[i];

			//We ignore calculating positions of all connected containers when we're not over them
			if(item.instance != this.currentContainer && this.currentContainer && item.item[0] != this.currentItem[0])
				continue;

			var t = this.options.toleranceElement ? $(this.options.toleranceElement, item.item) : item.item;

			if (!fast) {
				item.width = t.outerWidth();
				item.height = t.outerHeight();
			}

			var p = t.offset();
			item.left = p.left;
			item.top = p.top;
		};

		if(this.options.custom && this.options.custom.refreshContainers) {
			this.options.custom.refreshContainers.call(this);
		} else {
			for (var i = this.containers.length - 1; i >= 0; i--){
				var p = this.containers[i].element.offset();
				this.containers[i].containerCache.left = p.left;
				this.containers[i].containerCache.top = p.top;
				this.containers[i].containerCache.width	= this.containers[i].element.outerWidth();
				this.containers[i].containerCache.height = this.containers[i].element.outerHeight();
			};
		}

		return this;
	},

	_createPlaceholder: function(that) {

		var self = that || this, o = self.options;

		if(!o.placeholder || o.placeholder.constructor == String) {
			var className = o.placeholder;
			o.placeholder = {
				element: function() {

					var el = $(document.createElement(self.currentItem[0].nodeName))
						.addClass(className || self.currentItem[0].className+" ui-sortable-placeholder")
						.removeClass("ui-sortable-helper")[0];

					if(!className)
						el.style.visibility = "hidden";

					return el;
				},
				update: function(container, p) {

					// 1. If a className is set as 'placeholder option, we don't force sizes - the class is responsible for that
					// 2. The option 'forcePlaceholderSize can be enabled to force it even if a class name is specified
					if(className && !o.forcePlaceholderSize) return;

					//If the element doesn't have a actual height by itself (without styles coming from a stylesheet), it receives the inline height from the dragged item
					if(!p.height()) { p.height(self.currentItem.innerHeight() - parseInt(self.currentItem.css('paddingTop')||0, 10) - parseInt(self.currentItem.css('paddingBottom')||0, 10)); };
					if(!p.width()) { p.width(self.currentItem.innerWidth() - parseInt(self.currentItem.css('paddingLeft')||0, 10) - parseInt(self.currentItem.css('paddingRight')||0, 10)); };
				}
			};
		}

		//Create the placeholder
		self.placeholder = $(o.placeholder.element.call(self.element, self.currentItem));

		//Append it after the actual current item
		self.currentItem.after(self.placeholder);

		//Update the size of the placeholder (TODO: Logic to fuzzy, see line 316/317)
		o.placeholder.update(self, self.placeholder);

	},

	_contactContainers: function(event) {
		
		// get innermost container that intersects with item 
		var innermostContainer = null, innermostIndex = null;		
		
		
		for (var i = this.containers.length - 1; i >= 0; i--){

			// never consider a container that's located within the item itself 
			if($.ui.contains(this.currentItem[0], this.containers[i].element[0]))
				continue;

			if(this._intersectsWith(this.containers[i].containerCache)) {

				// if we've already found a container and it's more "inner" than this, then continue 
				if(innermostContainer && $.ui.contains(this.containers[i].element[0], innermostContainer.element[0]))
					continue;

				innermostContainer = this.containers[i]; 
				innermostIndex = i;
					
			} else {
				// container doesn't intersect. trigger "out" event if necessary 
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", event, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}
		
		// if no intersecting containers found, return 
		if(!innermostContainer) return; 

		// move the item into the container if it's not there already
		if(this.containers.length === 1) {
			this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
			this.containers[innermostIndex].containerCache.over = 1;
		} else if(this.currentContainer != this.containers[innermostIndex]) {

			//When entering a new container, we will find the item with the least distance and append our item near it
			var dist = 10000; var itemWithLeastDistance = null; var base = this.positionAbs[this.containers[innermostIndex].floating ? 'left' : 'top'];
			for (var j = this.items.length - 1; j >= 0; j--) {
				if(!$.ui.contains(this.containers[innermostIndex].element[0], this.items[j].item[0])) continue;
				var cur = this.containers[innermostIndex].floating ? this.items[j].item.offset().left : this.items[j].item.offset().top;
				if(Math.abs(cur - base) < dist) {
					dist = Math.abs(cur - base); itemWithLeastDistance = this.items[j];
					this.direction = (cur - base > 0) ? 'down' : 'up';
				}
			}

			if(!itemWithLeastDistance && !this.options.dropOnEmpty) //Check if dropOnEmpty is enabled
				return;

			this.currentContainer = this.containers[innermostIndex];
			itemWithLeastDistance ? this._rearrange(event, itemWithLeastDistance, null, true) : this._rearrange(event, null, this.containers[innermostIndex].element, true);
			this._trigger("change", event, this._uiHash());
			this.containers[innermostIndex]._trigger("change", event, this._uiHash(this));

			//Update the placeholder
			this.options.placeholder.update(this.currentContainer, this.placeholder);

			this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
			this.containers[innermostIndex].containerCache.over = 1;
		} 
	
		
	},

	_createHelper: function(event) {

		var o = this.options;
		var helper = $.isFunction(o.helper) ? $(o.helper.apply(this.element[0], [event, this.currentItem])) : (o.helper == 'clone' ? this.currentItem.clone() : this.currentItem);

		if(!helper.parents('body').length) //Add the helper to the DOM if that didn't happen already
			$(o.appendTo != 'parent' ? o.appendTo : this.currentItem[0].parentNode)[0].appendChild(helper[0]);

		if(helper[0] == this.currentItem[0])
			this._storedCSS = { width: this.currentItem[0].style.width, height: this.currentItem[0].style.height, position: this.currentItem.css("position"), top: this.currentItem.css("top"), left: this.currentItem.css("left") };

		if(helper[0].style.width == '' || o.forceHelperSize) helper.width(this.currentItem.width());
		if(helper[0].style.height == '' || o.forceHelperSize) helper.height(this.currentItem.height());

		return helper;

	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj == 'string') {
			obj = obj.split(' ');
		}
		if ($.isArray(obj)) {
			obj = {left: +obj[0], top: +obj[1] || 0};
		}
		if ('left' in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ('right' in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ('top' in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ('bottom' in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {


		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if(this.cssPosition == 'absolute' && this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		if((this.offsetParent[0] == document.body) //This needs to be actually done for all browsers, since pageX/pageY includes this information
		|| (this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() == 'html' && $.browser.msie)) //Ugly IE fix
			po = { top: 0, left: 0 };

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"),10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"),10) || 0)
		};

	},

	_getRelativeOffset: function() {

		if(this.cssPosition == "relative") {
			var p = this.currentItem.position();
			return {
				top: p.top - (parseInt(this.helper.css("top"),10) || 0) + this.scrollParent.scrollTop(),
				left: p.left - (parseInt(this.helper.css("left"),10) || 0) + this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.currentItem.css("marginLeft"),10) || 0),
			top: (parseInt(this.currentItem.css("marginTop"),10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var o = this.options;
		if(o.containment == 'parent') o.containment = this.helper[0].parentNode;
		if(o.containment == 'document' || o.containment == 'window') this.containment = [
			0 - this.offset.relative.left - this.offset.parent.left,
			0 - this.offset.relative.top - this.offset.parent.top,
			$(o.containment == 'document' ? document : window).width() - this.helperProportions.width - this.margins.left,
			($(o.containment == 'document' ? document : window).height() || document.body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top
		];

		if(!(/^(document|window|parent)$/).test(o.containment)) {
			var ce = $(o.containment)[0];
			var co = $(o.containment).offset();
			var over = ($(ce).css("overflow") != 'hidden');

			this.containment = [
				co.left + (parseInt($(ce).css("borderLeftWidth"),10) || 0) + (parseInt($(ce).css("paddingLeft"),10) || 0) - this.margins.left,
				co.top + (parseInt($(ce).css("borderTopWidth"),10) || 0) + (parseInt($(ce).css("paddingTop"),10) || 0) - this.margins.top,
				co.left+(over ? Math.max(ce.scrollWidth,ce.offsetWidth) : ce.offsetWidth) - (parseInt($(ce).css("borderLeftWidth"),10) || 0) - (parseInt($(ce).css("paddingRight"),10) || 0) - this.helperProportions.width - this.margins.left,
				co.top+(over ? Math.max(ce.scrollHeight,ce.offsetHeight) : ce.offsetHeight) - (parseInt($(ce).css("borderTopWidth"),10) || 0) - (parseInt($(ce).css("paddingBottom"),10) || 0) - this.helperProportions.height - this.margins.top
			];
		}

	},

	_convertPositionTo: function(d, pos) {

		if(!pos) pos = this.position;
		var mod = d == "absolute" ? 1 : -1;
		var o = this.options, scroll = this.cssPosition == 'absolute' && !(this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		return {
			top: (
				pos.top																	// The absolute mouse position
				+ this.offset.relative.top * mod										// Only for relative positioned nodes: Relative offset from element to offset parent
				+ this.offset.parent.top * mod											// The offsetParent's offset without borders (offset + border)
				- ($.browser.safari && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod)
			),
			left: (
				pos.left																// The absolute mouse position
				+ this.offset.relative.left * mod										// Only for relative positioned nodes: Relative offset from element to offset parent
				+ this.offset.parent.left * mod											// The offsetParent's offset without borders (offset + border)
				- ($.browser.safari && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ) * mod)
			)
		};

	},

	_generatePosition: function(event) {

		var o = this.options, scroll = this.cssPosition == 'absolute' && !(this.scrollParent[0] != document && $.ui.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		// This is another very weird special case that only happens for relative elements:
		// 1. If the css position is relative
		// 2. and the scroll parent is the document or similar to the offset parent
		// we have to refresh the relative offset during the scroll so there are no jumps
		if(this.cssPosition == 'relative' && !(this.scrollParent[0] != document && this.scrollParent[0] != this.offsetParent[0])) {
			this.offset.relative = this._getRelativeOffset();
		}

		var pageX = event.pageX;
		var pageY = event.pageY;

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if(this.originalPosition) { //If we are not dragging yet, we won't check for options

			if(this.containment) {
				if(event.pageX - this.offset.click.left < this.containment[0]) pageX = this.containment[0] + this.offset.click.left;
				if(event.pageY - this.offset.click.top < this.containment[1]) pageY = this.containment[1] + this.offset.click.top;
				if(event.pageX - this.offset.click.left > this.containment[2]) pageX = this.containment[2] + this.offset.click.left;
				if(event.pageY - this.offset.click.top > this.containment[3]) pageY = this.containment[3] + this.offset.click.top;
			}

			if(o.grid) {
				var top = this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1];
				pageY = this.containment ? (!(top - this.offset.click.top < this.containment[1] || top - this.offset.click.top > this.containment[3]) ? top : (!(top - this.offset.click.top < this.containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				var left = this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0];
				pageX = this.containment ? (!(left - this.offset.click.left < this.containment[0] || left - this.offset.click.left > this.containment[2]) ? left : (!(left - this.offset.click.left < this.containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

		}

		return {
			top: (
				pageY																// The absolute mouse position
				- this.offset.click.top													// Click offset (relative to the element)
				- this.offset.relative.top												// Only for relative positioned nodes: Relative offset from element to offset parent
				- this.offset.parent.top												// The offsetParent's offset without borders (offset + border)
				+ ($.browser.safari && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ))
			),
			left: (
				pageX																// The absolute mouse position
				- this.offset.click.left												// Click offset (relative to the element)
				- this.offset.relative.left												// Only for relative positioned nodes: Relative offset from element to offset parent
				- this.offset.parent.left												// The offsetParent's offset without borders (offset + border)
				+ ($.browser.safari && this.cssPosition == 'fixed' ? 0 : ( this.cssPosition == 'fixed' ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ))
			)
		};

	},

	_rearrange: function(event, i, a, hardRefresh) {

		a ? a[0].appendChild(this.placeholder[0]) : i.item[0].parentNode.insertBefore(this.placeholder[0], (this.direction == 'down' ? i.item[0] : i.item[0].nextSibling));

		//Various things done here to improve the performance:
		// 1. we create a setTimeout, that calls refreshPositions
		// 2. on the instance, we have a counter variable, that get's higher after every append
		// 3. on the local scope, we copy the counter variable, and check in the timeout, if it's still the same
		// 4. this lets only the last addition to the timeout stack through
		this.counter = this.counter ? ++this.counter : 1;
		var self = this, counter = this.counter;

		window.setTimeout(function() {
			if(counter == self.counter) self.refreshPositions(!hardRefresh); //Precompute after each DOM insertion, NOT on mousemove
		},0);

	},

	_clear: function(event, noPropagation) {

		this.reverting = false;
		// We delay all events that have to be triggered to after the point where the placeholder has been removed and
		// everything else normalized again
		var delayedTriggers = [], self = this;

		// We first have to update the dom position of the actual currentItem
		// Note: don't do it if the current item is already removed (by a user), or it gets reappended (see #4088)
		if(!this._noFinalSort && this.currentItem.parent().length) this.placeholder.before(this.currentItem);
		this._noFinalSort = null;

		if(this.helper[0] == this.currentItem[0]) {
			for(var i in this._storedCSS) {
				if(this._storedCSS[i] == 'auto' || this._storedCSS[i] == 'static') this._storedCSS[i] = '';
			}
			this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
		} else {
			this.currentItem.show();
		}

		if(this.fromOutside && !noPropagation) delayedTriggers.push(function(event) { this._trigger("receive", event, this._uiHash(this.fromOutside)); });
		if((this.fromOutside || this.domPosition.prev != this.currentItem.prev().not(".ui-sortable-helper")[0] || this.domPosition.parent != this.currentItem.parent()[0]) && !noPropagation) delayedTriggers.push(function(event) { this._trigger("update", event, this._uiHash()); }); //Trigger update callback if the DOM position has changed
		if(!$.ui.contains(this.element[0], this.currentItem[0])) { //Node was moved out of the current element
			if(!noPropagation) delayedTriggers.push(function(event) { this._trigger("remove", event, this._uiHash()); });
			for (var i = this.containers.length - 1; i >= 0; i--){
				if($.ui.contains(this.containers[i].element[0], this.currentItem[0]) && !noPropagation) {
					delayedTriggers.push((function(c) { return function(event) { c._trigger("receive", event, this._uiHash(this)); };  }).call(this, this.containers[i]));
					delayedTriggers.push((function(c) { return function(event) { c._trigger("update", event, this._uiHash(this));  }; }).call(this, this.containers[i]));
				}
			};
		};

		//Post events to containers
		for (var i = this.containers.length - 1; i >= 0; i--){
			if(!noPropagation) delayedTriggers.push((function(c) { return function(event) { c._trigger("deactivate", event, this._uiHash(this)); };  }).call(this, this.containers[i]));
			if(this.containers[i].containerCache.over) {
				delayedTriggers.push((function(c) { return function(event) { c._trigger("out", event, this._uiHash(this)); };  }).call(this, this.containers[i]));
				this.containers[i].containerCache.over = 0;
			}
		}

		//Do what was originally in plugins
		if(this._storedCursor) $('body').css("cursor", this._storedCursor); //Reset cursor
		if(this._storedOpacity) this.helper.css("opacity", this._storedOpacity); //Reset opacity
		if(this._storedZIndex) this.helper.css("zIndex", this._storedZIndex == 'auto' ? '' : this._storedZIndex); //Reset z-index

		this.dragging = false;
		if(this.cancelHelperRemoval) {
			if(!noPropagation) {
				this._trigger("beforeStop", event, this._uiHash());
				for (var i=0; i < delayedTriggers.length; i++) { delayedTriggers[i].call(this, event); }; //Trigger all delayed events
				this._trigger("stop", event, this._uiHash());
			}

			this.fromOutside = false;
			return false;
		}

		if(!noPropagation) this._trigger("beforeStop", event, this._uiHash());

		//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
		this.placeholder[0].parentNode.removeChild(this.placeholder[0]);

		if(this.helper[0] != this.currentItem[0]) this.helper.remove(); this.helper = null;

		if(!noPropagation) {
			for (var i=0; i < delayedTriggers.length; i++) { delayedTriggers[i].call(this, event); }; //Trigger all delayed events
			this._trigger("stop", event, this._uiHash());
		}

		this.fromOutside = false;
		return true;

	},

	_trigger: function() {
		if ($.Widget.prototype._trigger.apply(this, arguments) === false) {
			this.cancel();
		}
	},

	_uiHash: function(inst) {
		var self = inst || this;
		return {
			helper: self.helper,
			placeholder: self.placeholder || $([]),
			position: self.position,
			originalPosition: self.originalPosition,
			offset: self.positionAbs,
			item: self.currentItem,
			sender: inst ? inst.element : null
		};
	}

});

$.extend($.ui.sortable, {
	version: "1.8.22"
});

})(jQuery);
/*!
 * jQuery UI Accordion 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Accordion
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget( "ui.accordion", {
	options: {
		active: 0,
		animated: "slide",
		autoHeight: true,
		clearStyle: false,
		collapsible: false,
		event: "click",
		fillSpace: false,
		header: "> li > :first-child,> :not(li):even",
		icons: {
			header: "ui-icon-triangle-1-e",
			headerSelected: "ui-icon-triangle-1-s"
		},
		navigation: false,
		navigationFilter: function() {
			return this.href.toLowerCase() === location.href.toLowerCase();
		}
	},

	_create: function() {
		var self = this,
			options = self.options;

		self.running = 0;

		self.element
			.addClass( "ui-accordion ui-widget ui-helper-reset" )
			// in lack of child-selectors in CSS
			// we need to mark top-LIs in a UL-accordion for some IE-fix
			.children( "li" )
				.addClass( "ui-accordion-li-fix" );

		self.headers = self.element.find( options.header )
			.addClass( "ui-accordion-header ui-helper-reset ui-state-default ui-corner-all" )
			.bind( "mouseenter.accordion", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).addClass( "ui-state-hover" );
			})
			.bind( "mouseleave.accordion", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).removeClass( "ui-state-hover" );
			})
			.bind( "focus.accordion", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).addClass( "ui-state-focus" );
			})
			.bind( "blur.accordion", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).removeClass( "ui-state-focus" );
			});

		self.headers.next()
			.addClass( "ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom" );

		if ( options.navigation ) {
			var current = self.element.find( "a" ).filter( options.navigationFilter ).eq( 0 );
			if ( current.length ) {
				var header = current.closest( ".ui-accordion-header" );
				if ( header.length ) {
					// anchor within header
					self.active = header;
				} else {
					// anchor within content
					self.active = current.closest( ".ui-accordion-content" ).prev();
				}
			}
		}

		self.active = self._findActive( self.active || options.active )
			.addClass( "ui-state-default ui-state-active" )
			.toggleClass( "ui-corner-all" )
			.toggleClass( "ui-corner-top" );
		self.active.next().addClass( "ui-accordion-content-active" );

		self._createIcons();
		self.resize();
		
		// ARIA
		self.element.attr( "role", "tablist" );

		self.headers
			.attr( "role", "tab" )
			.bind( "keydown.accordion", function( event ) {
				return self._keydown( event );
			})
			.next()
				.attr( "role", "tabpanel" );

		self.headers
			.not( self.active || "" )
			.attr({
				"aria-expanded": "false",
				"aria-selected": "false",
				tabIndex: -1
			})
			.next()
				.hide();

		// make sure at least one header is in the tab order
		if ( !self.active.length ) {
			self.headers.eq( 0 ).attr( "tabIndex", 0 );
		} else {
			self.active
				.attr({
					"aria-expanded": "true",
					"aria-selected": "true",
					tabIndex: 0
				});
		}

		// only need links in tab order for Safari
		if ( !$.browser.safari ) {
			self.headers.find( "a" ).attr( "tabIndex", -1 );
		}

		if ( options.event ) {
			self.headers.bind( options.event.split(" ").join(".accordion ") + ".accordion", function(event) {
				self._clickHandler.call( self, event, this );
				event.preventDefault();
			});
		}
	},

	_createIcons: function() {
		var options = this.options;
		if ( options.icons ) {
			$( "<span></span>" )
				.addClass( "ui-icon " + options.icons.header )
				.prependTo( this.headers );
			this.active.children( ".ui-icon" )
				.toggleClass(options.icons.header)
				.toggleClass(options.icons.headerSelected);
			this.element.addClass( "ui-accordion-icons" );
		}
	},

	_destroyIcons: function() {
		this.headers.children( ".ui-icon" ).remove();
		this.element.removeClass( "ui-accordion-icons" );
	},

	destroy: function() {
		var options = this.options;

		this.element
			.removeClass( "ui-accordion ui-widget ui-helper-reset" )
			.removeAttr( "role" );

		this.headers
			.unbind( ".accordion" )
			.removeClass( "ui-accordion-header ui-accordion-disabled ui-helper-reset ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top" )
			.removeAttr( "role" )
			.removeAttr( "aria-expanded" )
			.removeAttr( "aria-selected" )
			.removeAttr( "tabIndex" );

		this.headers.find( "a" ).removeAttr( "tabIndex" );
		this._destroyIcons();
		var contents = this.headers.next()
			.css( "display", "" )
			.removeAttr( "role" )
			.removeClass( "ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-accordion-disabled ui-state-disabled" );
		if ( options.autoHeight || options.fillHeight ) {
			contents.css( "height", "" );
		}

		return $.Widget.prototype.destroy.call( this );
	},

	_setOption: function( key, value ) {
		$.Widget.prototype._setOption.apply( this, arguments );
			
		if ( key == "active" ) {
			this.activate( value );
		}
		if ( key == "icons" ) {
			this._destroyIcons();
			if ( value ) {
				this._createIcons();
			}
		}
		// #5332 - opacity doesn't cascade to positioned elements in IE
		// so we need to add the disabled class to the headers and panels
		if ( key == "disabled" ) {
			this.headers.add(this.headers.next())
				[ value ? "addClass" : "removeClass" ](
					"ui-accordion-disabled ui-state-disabled" );
		}
	},

	_keydown: function( event ) {
		if ( this.options.disabled || event.altKey || event.ctrlKey ) {
			return;
		}

		var keyCode = $.ui.keyCode,
			length = this.headers.length,
			currentIndex = this.headers.index( event.target ),
			toFocus = false;

		switch ( event.keyCode ) {
			case keyCode.RIGHT:
			case keyCode.DOWN:
				toFocus = this.headers[ ( currentIndex + 1 ) % length ];
				break;
			case keyCode.LEFT:
			case keyCode.UP:
				toFocus = this.headers[ ( currentIndex - 1 + length ) % length ];
				break;
			case keyCode.SPACE:
			case keyCode.ENTER:
				this._clickHandler( { target: event.target }, event.target );
				event.preventDefault();
		}

		if ( toFocus ) {
			$( event.target ).attr( "tabIndex", -1 );
			$( toFocus ).attr( "tabIndex", 0 );
			toFocus.focus();
			return false;
		}

		return true;
	},

	resize: function() {
		var options = this.options,
			maxHeight;

		if ( options.fillSpace ) {
			if ( $.browser.msie ) {
				var defOverflow = this.element.parent().css( "overflow" );
				this.element.parent().css( "overflow", "hidden");
			}
			maxHeight = this.element.parent().height();
			if ($.browser.msie) {
				this.element.parent().css( "overflow", defOverflow );
			}

			this.headers.each(function() {
				maxHeight -= $( this ).outerHeight( true );
			});

			this.headers.next()
				.each(function() {
					$( this ).height( Math.max( 0, maxHeight -
						$( this ).innerHeight() + $( this ).height() ) );
				})
				.css( "overflow", "auto" );
		} else if ( options.autoHeight ) {
			maxHeight = 0;
			this.headers.next()
				.each(function() {
					maxHeight = Math.max( maxHeight, $( this ).height( "" ).height() );
				})
				.height( maxHeight );
		}

		return this;
	},

	activate: function( index ) {
		// TODO this gets called on init, changing the option without an explicit call for that
		this.options.active = index;
		// call clickHandler with custom event
		var active = this._findActive( index )[ 0 ];
		this._clickHandler( { target: active }, active );

		return this;
	},

	_findActive: function( selector ) {
		return selector
			? typeof selector === "number"
				? this.headers.filter( ":eq(" + selector + ")" )
				: this.headers.not( this.headers.not( selector ) )
			: selector === false
				? $( [] )
				: this.headers.filter( ":eq(0)" );
	},

	// TODO isn't event.target enough? why the separate target argument?
	_clickHandler: function( event, target ) {
		var options = this.options;
		if ( options.disabled ) {
			return;
		}

		// called only when using activate(false) to close all parts programmatically
		if ( !event.target ) {
			if ( !options.collapsible ) {
				return;
			}
			this.active
				.removeClass( "ui-state-active ui-corner-top" )
				.addClass( "ui-state-default ui-corner-all" )
				.children( ".ui-icon" )
					.removeClass( options.icons.headerSelected )
					.addClass( options.icons.header );
			this.active.next().addClass( "ui-accordion-content-active" );
			var toHide = this.active.next(),
				data = {
					options: options,
					newHeader: $( [] ),
					oldHeader: options.active,
					newContent: $( [] ),
					oldContent: toHide
				},
				toShow = ( this.active = $( [] ) );
			this._toggle( toShow, toHide, data );
			return;
		}

		// get the click target
		var clicked = $( event.currentTarget || target ),
			clickedIsActive = clicked[0] === this.active[0];

		// TODO the option is changed, is that correct?
		// TODO if it is correct, shouldn't that happen after determining that the click is valid?
		options.active = options.collapsible && clickedIsActive ?
			false :
			this.headers.index( clicked );

		// if animations are still active, or the active header is the target, ignore click
		if ( this.running || ( !options.collapsible && clickedIsActive ) ) {
			return;
		}

		// find elements to show and hide
		var active = this.active,
			toShow = clicked.next(),
			toHide = this.active.next(),
			data = {
				options: options,
				newHeader: clickedIsActive && options.collapsible ? $([]) : clicked,
				oldHeader: this.active,
				newContent: clickedIsActive && options.collapsible ? $([]) : toShow,
				oldContent: toHide
			},
			down = this.headers.index( this.active[0] ) > this.headers.index( clicked[0] );

		// when the call to ._toggle() comes after the class changes
		// it causes a very odd bug in IE 8 (see #6720)
		this.active = clickedIsActive ? $([]) : clicked;
		this._toggle( toShow, toHide, data, clickedIsActive, down );

		// switch classes
		active
			.removeClass( "ui-state-active ui-corner-top" )
			.addClass( "ui-state-default ui-corner-all" )
			.children( ".ui-icon" )
				.removeClass( options.icons.headerSelected )
				.addClass( options.icons.header );
		if ( !clickedIsActive ) {
			clicked
				.removeClass( "ui-state-default ui-corner-all" )
				.addClass( "ui-state-active ui-corner-top" )
				.children( ".ui-icon" )
					.removeClass( options.icons.header )
					.addClass( options.icons.headerSelected );
			clicked
				.next()
				.addClass( "ui-accordion-content-active" );
		}

		return;
	},

	_toggle: function( toShow, toHide, data, clickedIsActive, down ) {
		var self = this,
			options = self.options;

		self.toShow = toShow;
		self.toHide = toHide;
		self.data = data;

		var complete = function() {
			if ( !self ) {
				return;
			}
			return self._completed.apply( self, arguments );
		};

		// trigger changestart event
		self._trigger( "changestart", null, self.data );

		// count elements to animate
		self.running = toHide.size() === 0 ? toShow.size() : toHide.size();

		if ( options.animated ) {
			var animOptions = {};

			if ( options.collapsible && clickedIsActive ) {
				animOptions = {
					toShow: $( [] ),
					toHide: toHide,
					complete: complete,
					down: down,
					autoHeight: options.autoHeight || options.fillSpace
				};
			} else {
				animOptions = {
					toShow: toShow,
					toHide: toHide,
					complete: complete,
					down: down,
					autoHeight: options.autoHeight || options.fillSpace
				};
			}

			if ( !options.proxied ) {
				options.proxied = options.animated;
			}

			if ( !options.proxiedDuration ) {
				options.proxiedDuration = options.duration;
			}

			options.animated = $.isFunction( options.proxied ) ?
				options.proxied( animOptions ) :
				options.proxied;

			options.duration = $.isFunction( options.proxiedDuration ) ?
				options.proxiedDuration( animOptions ) :
				options.proxiedDuration;

			var animations = $.ui.accordion.animations,
				duration = options.duration,
				easing = options.animated;

			if ( easing && !animations[ easing ] && !$.easing[ easing ] ) {
				easing = "slide";
			}
			if ( !animations[ easing ] ) {
				animations[ easing ] = function( options ) {
					this.slide( options, {
						easing: easing,
						duration: duration || 700
					});
				};
			}

			animations[ easing ]( animOptions );
		} else {
			if ( options.collapsible && clickedIsActive ) {
				toShow.toggle();
			} else {
				toHide.hide();
				toShow.show();
			}

			complete( true );
		}

		// TODO assert that the blur and focus triggers are really necessary, remove otherwise
		toHide.prev()
			.attr({
				"aria-expanded": "false",
				"aria-selected": "false",
				tabIndex: -1
			})
			.blur();
		toShow.prev()
			.attr({
				"aria-expanded": "true",
				"aria-selected": "true",
				tabIndex: 0
			})
			.focus();
	},

	_completed: function( cancel ) {
		this.running = cancel ? 0 : --this.running;
		if ( this.running ) {
			return;
		}

		if ( this.options.clearStyle ) {
			this.toShow.add( this.toHide ).css({
				height: "",
				overflow: ""
			});
		}

		// other classes are removed before the animation; this one needs to stay until completed
		this.toHide.removeClass( "ui-accordion-content-active" );
		// Work around for rendering bug in IE (#5421)
		if ( this.toHide.length ) {
			this.toHide.parent()[0].className = this.toHide.parent()[0].className;
		}

		this._trigger( "change", null, this.data );
	}
});

$.extend( $.ui.accordion, {
	version: "1.8.22",
	animations: {
		slide: function( options, additions ) {
			options = $.extend({
				easing: "swing",
				duration: 300
			}, options, additions );
			if ( !options.toHide.size() ) {
				options.toShow.animate({
					height: "show",
					paddingTop: "show",
					paddingBottom: "show"
				}, options );
				return;
			}
			if ( !options.toShow.size() ) {
				options.toHide.animate({
					height: "hide",
					paddingTop: "hide",
					paddingBottom: "hide"
				}, options );
				return;
			}
			var overflow = options.toShow.css( "overflow" ),
				percentDone = 0,
				showProps = {},
				hideProps = {},
				fxAttrs = [ "height", "paddingTop", "paddingBottom" ],
				originalWidth;
			// fix width before calculating height of hidden element
			var s = options.toShow;
			originalWidth = s[0].style.width;
			s.width( s.parent().width()
				- parseFloat( s.css( "paddingLeft" ) )
				- parseFloat( s.css( "paddingRight" ) )
				- ( parseFloat( s.css( "borderLeftWidth" ) ) || 0 )
				- ( parseFloat( s.css( "borderRightWidth" ) ) || 0 ) );

			$.each( fxAttrs, function( i, prop ) {
				hideProps[ prop ] = "hide";

				var parts = ( "" + $.css( options.toShow[0], prop ) ).match( /^([\d+-.]+)(.*)$/ );
				showProps[ prop ] = {
					value: parts[ 1 ],
					unit: parts[ 2 ] || "px"
				};
			});
			options.toShow.css({ height: 0, overflow: "hidden" }).show();
			options.toHide
				.filter( ":hidden" )
					.each( options.complete )
				.end()
				.filter( ":visible" )
				.animate( hideProps, {
				step: function( now, settings ) {
					// only calculate the percent when animating height
					// IE gets very inconsistent results when animating elements
					// with small values, which is common for padding
					if ( settings.prop == "height" ) {
						percentDone = ( settings.end - settings.start === 0 ) ? 0 :
							( settings.now - settings.start ) / ( settings.end - settings.start );
					}

					options.toShow[ 0 ].style[ settings.prop ] =
						( percentDone * showProps[ settings.prop ].value )
						+ showProps[ settings.prop ].unit;
				},
				duration: options.duration,
				easing: options.easing,
				complete: function() {
					if ( !options.autoHeight ) {
						options.toShow.css( "height", "" );
					}
					options.toShow.css({
						width: originalWidth,
						overflow: overflow
					});
					options.complete();
				}
			});
		},
		bounceslide: function( options ) {
			this.slide( options, {
				easing: options.down ? "easeOutBounce" : "swing",
				duration: options.down ? 1000 : 200
			});
		}
	}
});

})( jQuery );
/*!
 * jQuery UI Autocomplete 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Autocomplete
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *	jquery.ui.position.js
 */
(function( $, undefined ) {

// used to prevent race conditions with remote data sources
var requestIndex = 0;

$.widget( "ui.autocomplete", {
	options: {
		appendTo: "body",
		autoFocus: false,
		delay: 300,
		minLength: 1,
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		source: null
	},

	pending: 0,

	_create: function() {
		var self = this,
			doc = this.element[ 0 ].ownerDocument,
			suppressKeyPress;
		this.isMultiLine = this.element.is( "textarea" );

		this.element
			.addClass( "ui-autocomplete-input" )
			.attr( "autocomplete", "off" )
			// TODO verify these actually work as intended
			.attr({
				role: "textbox",
				"aria-autocomplete": "list",
				"aria-haspopup": "true"
			})
			.bind( "keydown.autocomplete", function( event ) {
				if ( self.options.disabled || self.element.propAttr( "readOnly" ) ) {
					return;
				}

				suppressKeyPress = false;
				var keyCode = $.ui.keyCode;
				switch( event.keyCode ) {
				case keyCode.PAGE_UP:
					self._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					self._move( "nextPage", event );
					break;
				case keyCode.UP:
					self._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					self._keyEvent( "next", event );
					break;
				case keyCode.ENTER:
				case keyCode.NUMPAD_ENTER:
					// when menu is open and has focus
					if ( self.menu.active ) {
						// #6055 - Opera still allows the keypress to occur
						// which causes forms to submit
						suppressKeyPress = true;
						event.preventDefault();
					}
					//passthrough - ENTER and TAB both select the current element
				case keyCode.TAB:
					if ( !self.menu.active ) {
						return;
					}
					self.menu.select( event );
					break;
				case keyCode.ESCAPE:
					self.element.val( self.term );
					self.close( event );
					break;
				default:
					// keypress is triggered before the input value is changed
					clearTimeout( self.searching );
					self.searching = setTimeout(function() {
						// only search if the value has changed
						if ( self.term != self.element.val() ) {
							self.selectedItem = null;
							self.search( null, event );
						}
					}, self.options.delay );
					break;
				}
			})
			.bind( "keypress.autocomplete", function( event ) {
				if ( suppressKeyPress ) {
					suppressKeyPress = false;
					event.preventDefault();
				}
			})
			.bind( "focus.autocomplete", function() {
				if ( self.options.disabled ) {
					return;
				}

				self.selectedItem = null;
				self.previous = self.element.val();
			})
			.bind( "blur.autocomplete", function( event ) {
				if ( self.options.disabled ) {
					return;
				}

				clearTimeout( self.searching );
				// clicks on the menu (or a button to trigger a search) will cause a blur event
				self.closing = setTimeout(function() {
					self.close( event );
					self._change( event );
				}, 150 );
			});
		this._initSource();
		this.menu = $( "<ul></ul>" )
			.addClass( "ui-autocomplete" )
			.appendTo( $( this.options.appendTo || "body", doc )[0] )
			// prevent the close-on-blur in case of a "slow" click on the menu (long mousedown)
			.mousedown(function( event ) {
				// clicking on the scrollbar causes focus to shift to the body
				// but we can't detect a mouseup or a click immediately afterward
				// so we have to track the next mousedown and close the menu if
				// the user clicks somewhere outside of the autocomplete
				var menuElement = self.menu.element[ 0 ];
				if ( !$( event.target ).closest( ".ui-menu-item" ).length ) {
					setTimeout(function() {
						$( document ).one( 'mousedown', function( event ) {
							if ( event.target !== self.element[ 0 ] &&
								event.target !== menuElement &&
								!$.ui.contains( menuElement, event.target ) ) {
								self.close();
							}
						});
					}, 1 );
				}

				// use another timeout to make sure the blur-event-handler on the input was already triggered
				setTimeout(function() {
					clearTimeout( self.closing );
				}, 13);
			})
			.menu({
				focus: function( event, ui ) {
					var item = ui.item.data( "item.autocomplete" );
					if ( false !== self._trigger( "focus", event, { item: item } ) ) {
						// use value to match what will end up in the input, if it was a key event
						if ( /^key/.test(event.originalEvent.type) ) {
							self.element.val( item.value );
						}
					}
				},
				selected: function( event, ui ) {
					var item = ui.item.data( "item.autocomplete" ),
						previous = self.previous;

					// only trigger when focus was lost (click on menu)
					if ( self.element[0] !== doc.activeElement ) {
						self.element.focus();
						self.previous = previous;
						// #6109 - IE triggers two focus events and the second
						// is asynchronous, so we need to reset the previous
						// term synchronously and asynchronously :-(
						setTimeout(function() {
							self.previous = previous;
							self.selectedItem = item;
						}, 1);
					}

					if ( false !== self._trigger( "select", event, { item: item } ) ) {
						self.element.val( item.value );
					}
					// reset the term after the select event
					// this allows custom select handling to work properly
					self.term = self.element.val();

					self.close( event );
					self.selectedItem = item;
				},
				blur: function( event, ui ) {
					// don't set the value of the text field if it's already correct
					// this prevents moving the cursor unnecessarily
					if ( self.menu.element.is(":visible") &&
						( self.element.val() !== self.term ) ) {
						self.element.val( self.term );
					}
				}
			})
			.zIndex( this.element.zIndex() + 1 )
			// workaround for jQuery bug #5781 http://dev.jquery.com/ticket/5781
			.css({ top: 0, left: 0 })
			.hide()
			.data( "menu" );
		if ( $.fn.bgiframe ) {
			 this.menu.element.bgiframe();
		}
		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		self.beforeunloadHandler = function() {
			self.element.removeAttr( "autocomplete" );
		};
		$( window ).bind( "beforeunload", self.beforeunloadHandler );
	},

	destroy: function() {
		this.element
			.removeClass( "ui-autocomplete-input" )
			.removeAttr( "autocomplete" )
			.removeAttr( "role" )
			.removeAttr( "aria-autocomplete" )
			.removeAttr( "aria-haspopup" );
		this.menu.element.remove();
		$( window ).unbind( "beforeunload", this.beforeunloadHandler );
		$.Widget.prototype.destroy.call( this );
	},

	_setOption: function( key, value ) {
		$.Widget.prototype._setOption.apply( this, arguments );
		if ( key === "source" ) {
			this._initSource();
		}
		if ( key === "appendTo" ) {
			this.menu.element.appendTo( $( value || "body", this.element[0].ownerDocument )[0] )
		}
		if ( key === "disabled" && value && this.xhr ) {
			this.xhr.abort();
		}
	},

	_initSource: function() {
		var self = this,
			array,
			url;
		if ( $.isArray(this.options.source) ) {
			array = this.options.source;
			this.source = function( request, response ) {
				response( $.ui.autocomplete.filter(array, request.term) );
			};
		} else if ( typeof this.options.source === "string" ) {
			url = this.options.source;
			this.source = function( request, response ) {
				if ( self.xhr ) {
					self.xhr.abort();
				}
				self.xhr = $.ajax({
					url: url,
					data: request,
					dataType: "json",
					success: function( data, status ) {
						response( data );
					},
					error: function() {
						response( [] );
					}
				});
			};
		} else {
			this.source = this.options.source;
		}
	},

	search: function( value, event ) {
		value = value != null ? value : this.element.val();

		// always save the actual value, not the one passed as an argument
		this.term = this.element.val();

		if ( value.length < this.options.minLength ) {
			return this.close( event );
		}

		clearTimeout( this.closing );
		if ( this._trigger( "search", event ) === false ) {
			return;
		}

		return this._search( value );
	},

	_search: function( value ) {
		this.pending++;
		this.element.addClass( "ui-autocomplete-loading" );

		this.source( { term: value }, this._response() );
	},

	_response: function() {
		var that = this,
			index = ++requestIndex;

		return function( content ) {
			if ( index === requestIndex ) {
				that.__response( content );
			}

			that.pending--;
			if ( !that.pending ) {
				that.element.removeClass( "ui-autocomplete-loading" );
			}
		};
	},

	__response: function( content ) {
		if ( !this.options.disabled && content && content.length ) {
			content = this._normalize( content );
			this._suggest( content );
			this._trigger( "open" );
		} else {
			this.close();
		}
	},

	close: function( event ) {
		clearTimeout( this.closing );
		if ( this.menu.element.is(":visible") ) {
			this.menu.element.hide();
			this.menu.deactivate();
			this._trigger( "close", event );
		}
	},
	
	_change: function( event ) {
		if ( this.previous !== this.element.val() ) {
			this._trigger( "change", event, { item: this.selectedItem } );
		}
	},

	_normalize: function( items ) {
		// assume all items have the right format when the first item is complete
		if ( items.length && items[0].label && items[0].value ) {
			return items;
		}
		return $.map( items, function(item) {
			if ( typeof item === "string" ) {
				return {
					label: item,
					value: item
				};
			}
			return $.extend({
				label: item.label || item.value,
				value: item.value || item.label
			}, item );
		});
	},

	_suggest: function( items ) {
		var ul = this.menu.element
			.empty()
			.zIndex( this.element.zIndex() + 1 );
		this._renderMenu( ul, items );
		// TODO refresh should check if the active item is still in the dom, removing the need for a manual deactivate
		this.menu.deactivate();
		this.menu.refresh();

		// size and position menu
		ul.show();
		this._resizeMenu();
		ul.position( $.extend({
			of: this.element
		}, this.options.position ));

		if ( this.options.autoFocus ) {
			this.menu.next( new $.Event("mouseover") );
		}
	},

	_resizeMenu: function() {
		var ul = this.menu.element;
		ul.outerWidth( Math.max(
			// Firefox wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping (#7513)
			ul.width( "" ).outerWidth() + 1,
			this.element.outerWidth()
		) );
	},

	_renderMenu: function( ul, items ) {
		var self = this;
		$.each( items, function( index, item ) {
			self._renderItem( ul, item );
		});
	},

	_renderItem: function( ul, item) {
		return $( "<li></li>" )
			.data( "item.autocomplete", item )
			.append( $( "<a></a>" ).text( item.label ) )
			.appendTo( ul );
	},

	_move: function( direction, event ) {
		if ( !this.menu.element.is(":visible") ) {
			this.search( null, event );
			return;
		}
		if ( this.menu.first() && /^previous/.test(direction) ||
				this.menu.last() && /^next/.test(direction) ) {
			this.element.val( this.term );
			this.menu.deactivate();
			return;
		}
		this.menu[ direction ]( event );
	},

	widget: function() {
		return this.menu.element;
	},
	_keyEvent: function( keyEvent, event ) {
		if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
			this._move( keyEvent, event );

			// prevents moving cursor to beginning/end of the text field in some browsers
			event.preventDefault();
		}
	}
});

$.extend( $.ui.autocomplete, {
	escapeRegex: function( value ) {
		return value.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
	},
	filter: function(array, term) {
		var matcher = new RegExp( $.ui.autocomplete.escapeRegex(term), "i" );
		return $.grep( array, function(value) {
			return matcher.test( value.label || value.value || value );
		});
	}
});

}( jQuery ));

/*
 * jQuery UI Menu (not officially released)
 * 
 * This widget isn't yet finished and the API is subject to change. We plan to finish
 * it for the next release. You're welcome to give it a try anyway and give us feedback,
 * as long as you're okay with migrating your code later on. We can help with that, too.
 *
 * Copyright 2010, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Menu
 *
 * Depends:
 *	jquery.ui.core.js
 *  jquery.ui.widget.js
 */
(function($) {

$.widget("ui.menu", {
	_create: function() {
		var self = this;
		this.element
			.addClass("ui-menu ui-widget ui-widget-content ui-corner-all")
			.attr({
				role: "listbox",
				"aria-activedescendant": "ui-active-menuitem"
			})
			.click(function( event ) {
				if ( !$( event.target ).closest( ".ui-menu-item a" ).length ) {
					return;
				}
				// temporary
				event.preventDefault();
				self.select( event );
			});
		this.refresh();
	},
	
	refresh: function() {
		var self = this;

		// don't refresh list items that are already adapted
		var items = this.element.children("li:not(.ui-menu-item):has(a)")
			.addClass("ui-menu-item")
			.attr("role", "menuitem");
		
		items.children("a")
			.addClass("ui-corner-all")
			.attr("tabindex", -1)
			// mouseenter doesn't work with event delegation
			.mouseenter(function( event ) {
				self.activate( event, $(this).parent() );
			})
			.mouseleave(function() {
				self.deactivate();
			});
	},

	activate: function( event, item ) {
		this.deactivate();
		if (this.hasScroll()) {
			var offset = item.offset().top - this.element.offset().top,
				scroll = this.element.scrollTop(),
				elementHeight = this.element.height();
			if (offset < 0) {
				this.element.scrollTop( scroll + offset);
			} else if (offset >= elementHeight) {
				this.element.scrollTop( scroll + offset - elementHeight + item.height());
			}
		}
		this.active = item.eq(0)
			.children("a")
				.addClass("ui-state-hover")
				.attr("id", "ui-active-menuitem")
			.end();
		this._trigger("focus", event, { item: item });
	},

	deactivate: function() {
		if (!this.active) { return; }

		this.active.children("a")
			.removeClass("ui-state-hover")
			.removeAttr("id");
		this._trigger("blur");
		this.active = null;
	},

	next: function(event) {
		this.move("next", ".ui-menu-item:first", event);
	},

	previous: function(event) {
		this.move("prev", ".ui-menu-item:last", event);
	},

	first: function() {
		return this.active && !this.active.prevAll(".ui-menu-item").length;
	},

	last: function() {
		return this.active && !this.active.nextAll(".ui-menu-item").length;
	},

	move: function(direction, edge, event) {
		if (!this.active) {
			this.activate(event, this.element.children(edge));
			return;
		}
		var next = this.active[direction + "All"](".ui-menu-item").eq(0);
		if (next.length) {
			this.activate(event, next);
		} else {
			this.activate(event, this.element.children(edge));
		}
	},

	// TODO merge with previousPage
	nextPage: function(event) {
		if (this.hasScroll()) {
			// TODO merge with no-scroll-else
			if (!this.active || this.last()) {
				this.activate(event, this.element.children(".ui-menu-item:first"));
				return;
			}
			var base = this.active.offset().top,
				height = this.element.height(),
				result = this.element.children(".ui-menu-item").filter(function() {
					var close = $(this).offset().top - base - height + $(this).height();
					// TODO improve approximation
					return close < 10 && close > -10;
				});

			// TODO try to catch this earlier when scrollTop indicates the last page anyway
			if (!result.length) {
				result = this.element.children(".ui-menu-item:last");
			}
			this.activate(event, result);
		} else {
			this.activate(event, this.element.children(".ui-menu-item")
				.filter(!this.active || this.last() ? ":first" : ":last"));
		}
	},

	// TODO merge with nextPage
	previousPage: function(event) {
		if (this.hasScroll()) {
			// TODO merge with no-scroll-else
			if (!this.active || this.first()) {
				this.activate(event, this.element.children(".ui-menu-item:last"));
				return;
			}

			var base = this.active.offset().top,
				height = this.element.height(),
				result = this.element.children(".ui-menu-item").filter(function() {
					var close = $(this).offset().top - base + height - $(this).height();
					// TODO improve approximation
					return close < 10 && close > -10;
				});

			// TODO try to catch this earlier when scrollTop indicates the last page anyway
			if (!result.length) {
				result = this.element.children(".ui-menu-item:first");
			}
			this.activate(event, result);
		} else {
			this.activate(event, this.element.children(".ui-menu-item")
				.filter(!this.active || this.first() ? ":last" : ":first"));
		}
	},

	hasScroll: function() {
		return this.element.height() < this.element[ $.fn.prop ? "prop" : "attr" ]("scrollHeight");
	},

	select: function( event ) {
		this._trigger("selected", event, { item: this.active });
	}
});

}(jQuery));
/*!
 * jQuery UI Button 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Button
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

var lastActive, startXPos, startYPos, clickDragged,
	baseClasses = "ui-button ui-widget ui-state-default ui-corner-all",
	stateClasses = "ui-state-hover ui-state-active ",
	typeClasses = "ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",
	formResetHandler = function() {
		var buttons = $( this ).find( ":ui-button" );
		setTimeout(function() {
			buttons.button( "refresh" );
		}, 1 );
	},
	radioGroup = function( radio ) {
		var name = radio.name,
			form = radio.form,
			radios = $( [] );
		if ( name ) {
			if ( form ) {
				radios = $( form ).find( "[name='" + name + "']" );
			} else {
				radios = $( "[name='" + name + "']", radio.ownerDocument )
					.filter(function() {
						return !this.form;
					});
			}
		}
		return radios;
	};

$.widget( "ui.button", {
	options: {
		disabled: null,
		text: true,
		label: null,
		icons: {
			primary: null,
			secondary: null
		}
	},
	_create: function() {
		this.element.closest( "form" )
			.unbind( "reset.button" )
			.bind( "reset.button", formResetHandler );

		if ( typeof this.options.disabled !== "boolean" ) {
			this.options.disabled = !!this.element.propAttr( "disabled" );
		} else {
			this.element.propAttr( "disabled", this.options.disabled );
		}

		this._determineButtonType();
		this.hasTitle = !!this.buttonElement.attr( "title" );

		var self = this,
			options = this.options,
			toggleButton = this.type === "checkbox" || this.type === "radio",
			hoverClass = "ui-state-hover" + ( !toggleButton ? " ui-state-active" : "" ),
			focusClass = "ui-state-focus";

		if ( options.label === null ) {
			options.label = this.buttonElement.html();
		}

		this.buttonElement
			.addClass( baseClasses )
			.attr( "role", "button" )
			.bind( "mouseenter.button", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).addClass( "ui-state-hover" );
				if ( this === lastActive ) {
					$( this ).addClass( "ui-state-active" );
				}
			})
			.bind( "mouseleave.button", function() {
				if ( options.disabled ) {
					return;
				}
				$( this ).removeClass( hoverClass );
			})
			.bind( "click.button", function( event ) {
				if ( options.disabled ) {
					event.preventDefault();
					event.stopImmediatePropagation();
				}
			});

		this.element
			.bind( "focus.button", function() {
				// no need to check disabled, focus won't be triggered anyway
				self.buttonElement.addClass( focusClass );
			})
			.bind( "blur.button", function() {
				self.buttonElement.removeClass( focusClass );
			});

		if ( toggleButton ) {
			this.element.bind( "change.button", function() {
				if ( clickDragged ) {
					return;
				}
				self.refresh();
			});
			// if mouse moves between mousedown and mouseup (drag) set clickDragged flag
			// prevents issue where button state changes but checkbox/radio checked state
			// does not in Firefox (see ticket #6970)
			this.buttonElement
				.bind( "mousedown.button", function( event ) {
					if ( options.disabled ) {
						return;
					}
					clickDragged = false;
					startXPos = event.pageX;
					startYPos = event.pageY;
				})
				.bind( "mouseup.button", function( event ) {
					if ( options.disabled ) {
						return;
					}
					if ( startXPos !== event.pageX || startYPos !== event.pageY ) {
						clickDragged = true;
					}
			});
		}

		if ( this.type === "checkbox" ) {
			this.buttonElement.bind( "click.button", function() {
				if ( options.disabled || clickDragged ) {
					return false;
				}
				$( this ).toggleClass( "ui-state-active" );
				self.buttonElement.attr( "aria-pressed", self.element[0].checked );
			});
		} else if ( this.type === "radio" ) {
			this.buttonElement.bind( "click.button", function() {
				if ( options.disabled || clickDragged ) {
					return false;
				}
				$( this ).addClass( "ui-state-active" );
				self.buttonElement.attr( "aria-pressed", "true" );

				var radio = self.element[ 0 ];
				radioGroup( radio )
					.not( radio )
					.map(function() {
						return $( this ).button( "widget" )[ 0 ];
					})
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			});
		} else {
			this.buttonElement
				.bind( "mousedown.button", function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).addClass( "ui-state-active" );
					lastActive = this;
					$( document ).one( "mouseup", function() {
						lastActive = null;
					});
				})
				.bind( "mouseup.button", function() {
					if ( options.disabled ) {
						return false;
					}
					$( this ).removeClass( "ui-state-active" );
				})
				.bind( "keydown.button", function(event) {
					if ( options.disabled ) {
						return false;
					}
					if ( event.keyCode == $.ui.keyCode.SPACE || event.keyCode == $.ui.keyCode.ENTER ) {
						$( this ).addClass( "ui-state-active" );
					}
				})
				.bind( "keyup.button", function() {
					$( this ).removeClass( "ui-state-active" );
				});

			if ( this.buttonElement.is("a") ) {
				this.buttonElement.keyup(function(event) {
					if ( event.keyCode === $.ui.keyCode.SPACE ) {
						// TODO pass through original event correctly (just as 2nd argument doesn't work)
						$( this ).click();
					}
				});
			}
		}

		// TODO: pull out $.Widget's handling for the disabled option into
		// $.Widget.prototype._setOptionDisabled so it's easy to proxy and can
		// be overridden by individual plugins
		this._setOption( "disabled", options.disabled );
		this._resetButton();
	},

	_determineButtonType: function() {

		if ( this.element.is(":checkbox") ) {
			this.type = "checkbox";
		} else if ( this.element.is(":radio") ) {
			this.type = "radio";
		} else if ( this.element.is("input") ) {
			this.type = "input";
		} else {
			this.type = "button";
		}

		if ( this.type === "checkbox" || this.type === "radio" ) {
			// we don't search against the document in case the element
			// is disconnected from the DOM
			var ancestor = this.element.parents().filter(":last"),
				labelSelector = "label[for='" + this.element.attr("id") + "']";
			this.buttonElement = ancestor.find( labelSelector );
			if ( !this.buttonElement.length ) {
				ancestor = ancestor.length ? ancestor.siblings() : this.element.siblings();
				this.buttonElement = ancestor.filter( labelSelector );
				if ( !this.buttonElement.length ) {
					this.buttonElement = ancestor.find( labelSelector );
				}
			}
			this.element.addClass( "ui-helper-hidden-accessible" );

			var checked = this.element.is( ":checked" );
			if ( checked ) {
				this.buttonElement.addClass( "ui-state-active" );
			}
			this.buttonElement.attr( "aria-pressed", checked );
		} else {
			this.buttonElement = this.element;
		}
	},

	widget: function() {
		return this.buttonElement;
	},

	destroy: function() {
		this.element
			.removeClass( "ui-helper-hidden-accessible" );
		this.buttonElement
			.removeClass( baseClasses + " " + stateClasses + " " + typeClasses )
			.removeAttr( "role" )
			.removeAttr( "aria-pressed" )
			.html( this.buttonElement.find(".ui-button-text").html() );

		if ( !this.hasTitle ) {
			this.buttonElement.removeAttr( "title" );
		}

		$.Widget.prototype.destroy.call( this );
	},

	_setOption: function( key, value ) {
		$.Widget.prototype._setOption.apply( this, arguments );
		if ( key === "disabled" ) {
			if ( value ) {
				this.element.propAttr( "disabled", true );
			} else {
				this.element.propAttr( "disabled", false );
			}
			return;
		}
		this._resetButton();
	},

	refresh: function() {
		var isDisabled = this.element.is( ":disabled" );
		if ( isDisabled !== this.options.disabled ) {
			this._setOption( "disabled", isDisabled );
		}
		if ( this.type === "radio" ) {
			radioGroup( this.element[0] ).each(function() {
				if ( $( this ).is( ":checked" ) ) {
					$( this ).button( "widget" )
						.addClass( "ui-state-active" )
						.attr( "aria-pressed", "true" );
				} else {
					$( this ).button( "widget" )
						.removeClass( "ui-state-active" )
						.attr( "aria-pressed", "false" );
				}
			});
		} else if ( this.type === "checkbox" ) {
			if ( this.element.is( ":checked" ) ) {
				this.buttonElement
					.addClass( "ui-state-active" )
					.attr( "aria-pressed", "true" );
			} else {
				this.buttonElement
					.removeClass( "ui-state-active" )
					.attr( "aria-pressed", "false" );
			}
		}
	},

	_resetButton: function() {
		if ( this.type === "input" ) {
			if ( this.options.label ) {
				this.element.val( this.options.label );
			}
			return;
		}
		var buttonElement = this.buttonElement.removeClass( typeClasses ),
			buttonText = $( "<span></span>", this.element[0].ownerDocument )
				.addClass( "ui-button-text" )
				.html( this.options.label )
				.appendTo( buttonElement.empty() )
				.text(),
			icons = this.options.icons,
			multipleIcons = icons.primary && icons.secondary,
			buttonClasses = [];  

		if ( icons.primary || icons.secondary ) {
			if ( this.options.text ) {
				buttonClasses.push( "ui-button-text-icon" + ( multipleIcons ? "s" : ( icons.primary ? "-primary" : "-secondary" ) ) );
			}

			if ( icons.primary ) {
				buttonElement.prepend( "<span class='ui-button-icon-primary ui-icon " + icons.primary + "'></span>" );
			}

			if ( icons.secondary ) {
				buttonElement.append( "<span class='ui-button-icon-secondary ui-icon " + icons.secondary + "'></span>" );
			}

			if ( !this.options.text ) {
				buttonClasses.push( multipleIcons ? "ui-button-icons-only" : "ui-button-icon-only" );

				if ( !this.hasTitle ) {
					buttonElement.attr( "title", buttonText );
				}
			}
		} else {
			buttonClasses.push( "ui-button-text-only" );
		}
		buttonElement.addClass( buttonClasses.join( " " ) );
	}
});

$.widget( "ui.buttonset", {
	options: {
		items: ":button, :submit, :reset, :checkbox, :radio, a, :data(button)"
	},

	_create: function() {
		this.element.addClass( "ui-buttonset" );
	},
	
	_init: function() {
		this.refresh();
	},

	_setOption: function( key, value ) {
		if ( key === "disabled" ) {
			this.buttons.button( "option", key, value );
		}

		$.Widget.prototype._setOption.apply( this, arguments );
	},
	
	refresh: function() {
		var rtl = this.element.css( "direction" ) === "rtl";
		
		this.buttons = this.element.find( this.options.items )
			.filter( ":ui-button" )
				.button( "refresh" )
			.end()
			.not( ":ui-button" )
				.button()
			.end()
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-all ui-corner-left ui-corner-right" )
				.filter( ":first" )
					.addClass( rtl ? "ui-corner-right" : "ui-corner-left" )
				.end()
				.filter( ":last" )
					.addClass( rtl ? "ui-corner-left" : "ui-corner-right" )
				.end()
			.end();
	},

	destroy: function() {
		this.element.removeClass( "ui-buttonset" );
		this.buttons
			.map(function() {
				return $( this ).button( "widget" )[ 0 ];
			})
				.removeClass( "ui-corner-left ui-corner-right" )
			.end()
			.button( "destroy" );

		$.Widget.prototype.destroy.call( this );
	}
});

}( jQuery ) );
/*!
 * jQuery UI Dialog 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Dialog
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *  jquery.ui.button.js
 *	jquery.ui.draggable.js
 *	jquery.ui.mouse.js
 *	jquery.ui.position.js
 *	jquery.ui.resizable.js
 */
(function( $, undefined ) {

var uiDialogClasses =
		'ui-dialog ' +
		'ui-widget ' +
		'ui-widget-content ' +
		'ui-corner-all ',
	sizeRelatedOptions = {
		buttons: true,
		height: true,
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true,
		width: true
	},
	resizableRelatedOptions = {
		maxHeight: true,
		maxWidth: true,
		minHeight: true,
		minWidth: true
	},
	// support for jQuery 1.3.2 - handle common attrFn methods for dialog
	attrFn = $.attrFn || {
		val: true,
		css: true,
		html: true,
		text: true,
		data: true,
		width: true,
		height: true,
		offset: true,
		click: true
	};

$.widget("ui.dialog", {
	options: {
		autoOpen: true,
		buttons: {},
		closeOnEscape: true,
		closeText: 'close',
		dialogClass: '',
		draggable: true,
		hide: null,
		height: 'auto',
		maxHeight: false,
		maxWidth: false,
		minHeight: 150,
		minWidth: 150,
		modal: false,
		position: {
			my: 'center',
			at: 'center',
			collision: 'fit',
			// ensure that the titlebar is never outside the document
			using: function(pos) {
				var topOffset = $(this).css(pos).offset().top;
				if (topOffset < 0) {
					$(this).css('top', pos.top - topOffset);
				}
			}
		},
		resizable: true,
		show: null,
		stack: true,
		title: '',
		width: 300,
		zIndex: 1000
	},

	_create: function() {
		this.originalTitle = this.element.attr('title');
		// #5742 - .attr() might return a DOMElement
		if ( typeof this.originalTitle !== "string" ) {
			this.originalTitle = "";
		}

		this.options.title = this.options.title || this.originalTitle;
		var self = this,
			options = self.options,

			title = options.title || '&#160;',
			titleId = $.ui.dialog.getTitleId(self.element),

			uiDialog = (self.uiDialog = $('<div></div>'))
				.appendTo(document.body)
				.hide()
				.addClass(uiDialogClasses + options.dialogClass)
				.css({
					zIndex: options.zIndex
				})
				// setting tabIndex makes the div focusable
				// setting outline to 0 prevents a border on focus in Mozilla
				.attr('tabIndex', -1).css('outline', 0).keydown(function(event) {
					if (options.closeOnEscape && !event.isDefaultPrevented() && event.keyCode &&
						event.keyCode === $.ui.keyCode.ESCAPE) {
						
						self.close(event);
						event.preventDefault();
					}
				})
				.attr({
					role: 'dialog',
					'aria-labelledby': titleId
				})
				.mousedown(function(event) {
					self.moveToTop(false, event);
				}),

			uiDialogContent = self.element
				.show()
				.removeAttr('title')
				.addClass(
					'ui-dialog-content ' +
					'ui-widget-content')
				.appendTo(uiDialog),

			uiDialogTitlebar = (self.uiDialogTitlebar = $('<div></div>'))
				.addClass(
					'ui-dialog-titlebar ' +
					'ui-widget-header ' +
					'ui-corner-all ' +
					'ui-helper-clearfix'
				)
				.prependTo(uiDialog),

			uiDialogTitlebarClose = $('<a href="#"></a>')
				.addClass(
					'ui-dialog-titlebar-close ' +
					'ui-corner-all'
				)
				.attr('role', 'button')
				.hover(
					function() {
						uiDialogTitlebarClose.addClass('ui-state-hover');
					},
					function() {
						uiDialogTitlebarClose.removeClass('ui-state-hover');
					}
				)
				.focus(function() {
					uiDialogTitlebarClose.addClass('ui-state-focus');
				})
				.blur(function() {
					uiDialogTitlebarClose.removeClass('ui-state-focus');
				})
				.click(function(event) {
					self.close(event);
					return false;
				})
				.appendTo(uiDialogTitlebar),

			uiDialogTitlebarCloseText = (self.uiDialogTitlebarCloseText = $('<span></span>'))
				.addClass(
					'ui-icon ' +
					'ui-icon-closethick'
				)
				.text(options.closeText)
				.appendTo(uiDialogTitlebarClose),

			uiDialogTitle = $('<span></span>')
				.addClass('ui-dialog-title')
				.attr('id', titleId)
				.html(title)
				.prependTo(uiDialogTitlebar);

		//handling of deprecated beforeclose (vs beforeClose) option
		//Ticket #4669 http://dev.jqueryui.com/ticket/4669
		//TODO: remove in 1.9pre
		if ($.isFunction(options.beforeclose) && !$.isFunction(options.beforeClose)) {
			options.beforeClose = options.beforeclose;
		}

		uiDialogTitlebar.find("*").add(uiDialogTitlebar).disableSelection();

		if (options.draggable && $.fn.draggable) {
			self._makeDraggable();
		}
		if (options.resizable && $.fn.resizable) {
			self._makeResizable();
		}

		self._createButtons(options.buttons);
		self._isOpen = false;

		if ($.fn.bgiframe) {
			uiDialog.bgiframe();
		}
	},

	_init: function() {
		if ( this.options.autoOpen ) {
			this.open();
		}
	},

	destroy: function() {
		var self = this;
		
		if (self.overlay) {
			self.overlay.destroy();
		}
		self.uiDialog.hide();
		self.element
			.unbind('.dialog')
			.removeData('dialog')
			.removeClass('ui-dialog-content ui-widget-content')
			.hide().appendTo('body');
		self.uiDialog.remove();

		if (self.originalTitle) {
			self.element.attr('title', self.originalTitle);
		}

		return self;
	},

	widget: function() {
		return this.uiDialog;
	},

	close: function(event) {
		var self = this,
			maxZ, thisZ;
		
		if (false === self._trigger('beforeClose', event)) {
			return;
		}

		if (self.overlay) {
			self.overlay.destroy();
		}
		self.uiDialog.unbind('keypress.ui-dialog');

		self._isOpen = false;

		if (self.options.hide) {
			self.uiDialog.hide(self.options.hide, function() {
				self._trigger('close', event);
			});
		} else {
			self.uiDialog.hide();
			self._trigger('close', event);
		}

		$.ui.dialog.overlay.resize();

		// adjust the maxZ to allow other modal dialogs to continue to work (see #4309)
		if (self.options.modal) {
			maxZ = 0;
			$('.ui-dialog').each(function() {
				if (this !== self.uiDialog[0]) {
					thisZ = $(this).css('z-index');
					if(!isNaN(thisZ)) {
						maxZ = Math.max(maxZ, thisZ);
					}
				}
			});
			$.ui.dialog.maxZ = maxZ;
		}

		return self;
	},

	isOpen: function() {
		return this._isOpen;
	},

	// the force parameter allows us to move modal dialogs to their correct
	// position on open
	moveToTop: function(force, event) {
		var self = this,
			options = self.options,
			saveScroll;

		if ((options.modal && !force) ||
			(!options.stack && !options.modal)) {
			return self._trigger('focus', event);
		}

		if (options.zIndex > $.ui.dialog.maxZ) {
			$.ui.dialog.maxZ = options.zIndex;
		}
		if (self.overlay) {
			$.ui.dialog.maxZ += 1;
			self.overlay.$el.css('z-index', $.ui.dialog.overlay.maxZ = $.ui.dialog.maxZ);
		}

		//Save and then restore scroll since Opera 9.5+ resets when parent z-Index is changed.
		//  http://ui.jquery.com/bugs/ticket/3193
		saveScroll = { scrollTop: self.element.scrollTop(), scrollLeft: self.element.scrollLeft() };
		$.ui.dialog.maxZ += 1;
		self.uiDialog.css('z-index', $.ui.dialog.maxZ);
		self.element.attr(saveScroll);
		self._trigger('focus', event);

		return self;
	},

	open: function() {
		if (this._isOpen) { return; }

		var self = this,
			options = self.options,
			uiDialog = self.uiDialog;

		self.overlay = options.modal ? new $.ui.dialog.overlay(self) : null;
		self._size();
		self._position(options.position);
		uiDialog.show(options.show);
		self.moveToTop(true);

		// prevent tabbing out of modal dialogs
		if ( options.modal ) {
			uiDialog.bind( "keydown.ui-dialog", function( event ) {
				if ( event.keyCode !== $.ui.keyCode.TAB ) {
					return;
				}

				var tabbables = $(':tabbable', this),
					first = tabbables.filter(':first'),
					last  = tabbables.filter(':last');

				if (event.target === last[0] && !event.shiftKey) {
					first.focus(1);
					return false;
				} else if (event.target === first[0] && event.shiftKey) {
					last.focus(1);
					return false;
				}
			});
		}

		// set focus to the first tabbable element in the content area or the first button
		// if there are no tabbable elements, set focus on the dialog itself
		$(self.element.find(':tabbable').get().concat(
			uiDialog.find('.ui-dialog-buttonpane :tabbable').get().concat(
				uiDialog.get()))).eq(0).focus();

		self._isOpen = true;
		self._trigger('open');

		return self;
	},

	_createButtons: function(buttons) {
		var self = this,
			hasButtons = false,
			uiDialogButtonPane = $('<div></div>')
				.addClass(
					'ui-dialog-buttonpane ' +
					'ui-widget-content ' +
					'ui-helper-clearfix'
				),
			uiButtonSet = $( "<div></div>" )
				.addClass( "ui-dialog-buttonset" )
				.appendTo( uiDialogButtonPane );

		// if we already have a button pane, remove it
		self.uiDialog.find('.ui-dialog-buttonpane').remove();

		if (typeof buttons === 'object' && buttons !== null) {
			$.each(buttons, function() {
				return !(hasButtons = true);
			});
		}
		if (hasButtons) {
			$.each(buttons, function(name, props) {
				props = $.isFunction( props ) ?
					{ click: props, text: name } :
					props;
				var button = $('<button type="button"></button>')
					.click(function() {
						props.click.apply(self.element[0], arguments);
					})
					.appendTo(uiButtonSet);
				// can't use .attr( props, true ) with jQuery 1.3.2.
				$.each( props, function( key, value ) {
					if ( key === "click" ) {
						return;
					}
					if ( key in attrFn ) {
						button[ key ]( value );
					} else {
						button.attr( key, value );
					}
				});
				if ($.fn.button) {
					button.button();
				}
			});
			uiDialogButtonPane.appendTo(self.uiDialog);
		}
	},

	_makeDraggable: function() {
		var self = this,
			options = self.options,
			doc = $(document),
			heightBeforeDrag;

		function filteredUi(ui) {
			return {
				position: ui.position,
				offset: ui.offset
			};
		}

		self.uiDialog.draggable({
			cancel: '.ui-dialog-content, .ui-dialog-titlebar-close',
			handle: '.ui-dialog-titlebar',
			containment: 'document',
			start: function(event, ui) {
				heightBeforeDrag = options.height === "auto" ? "auto" : $(this).height();
				$(this).height($(this).height()).addClass("ui-dialog-dragging");
				self._trigger('dragStart', event, filteredUi(ui));
			},
			drag: function(event, ui) {
				self._trigger('drag', event, filteredUi(ui));
			},
			stop: function(event, ui) {
				options.position = [ui.position.left - doc.scrollLeft(),
					ui.position.top - doc.scrollTop()];
				$(this).removeClass("ui-dialog-dragging").height(heightBeforeDrag);
				self._trigger('dragStop', event, filteredUi(ui));
				$.ui.dialog.overlay.resize();
			}
		});
	},

	_makeResizable: function(handles) {
		handles = (handles === undefined ? this.options.resizable : handles);
		var self = this,
			options = self.options,
			// .ui-resizable has position: relative defined in the stylesheet
			// but dialogs have to use absolute or fixed positioning
			position = self.uiDialog.css('position'),
			resizeHandles = (typeof handles === 'string' ?
				handles	:
				'n,e,s,w,se,sw,ne,nw'
			);

		function filteredUi(ui) {
			return {
				originalPosition: ui.originalPosition,
				originalSize: ui.originalSize,
				position: ui.position,
				size: ui.size
			};
		}

		self.uiDialog.resizable({
			cancel: '.ui-dialog-content',
			containment: 'document',
			alsoResize: self.element,
			maxWidth: options.maxWidth,
			maxHeight: options.maxHeight,
			minWidth: options.minWidth,
			minHeight: self._minHeight(),
			handles: resizeHandles,
			start: function(event, ui) {
				$(this).addClass("ui-dialog-resizing");
				self._trigger('resizeStart', event, filteredUi(ui));
			},
			resize: function(event, ui) {
				self._trigger('resize', event, filteredUi(ui));
			},
			stop: function(event, ui) {
				$(this).removeClass("ui-dialog-resizing");
				options.height = $(this).height();
				options.width = $(this).width();
				self._trigger('resizeStop', event, filteredUi(ui));
				$.ui.dialog.overlay.resize();
			}
		})
		.css('position', position)
		.find('.ui-resizable-se').addClass('ui-icon ui-icon-grip-diagonal-se');
	},

	_minHeight: function() {
		var options = this.options;

		if (options.height === 'auto') {
			return options.minHeight;
		} else {
			return Math.min(options.minHeight, options.height);
		}
	},

	_position: function(position) {
		var myAt = [],
			offset = [0, 0],
			isVisible;

		if (position) {
			// deep extending converts arrays to objects in jQuery <= 1.3.2 :-(
	//		if (typeof position == 'string' || $.isArray(position)) {
	//			myAt = $.isArray(position) ? position : position.split(' ');

			if (typeof position === 'string' || (typeof position === 'object' && '0' in position)) {
				myAt = position.split ? position.split(' ') : [position[0], position[1]];
				if (myAt.length === 1) {
					myAt[1] = myAt[0];
				}

				$.each(['left', 'top'], function(i, offsetPosition) {
					if (+myAt[i] === myAt[i]) {
						offset[i] = myAt[i];
						myAt[i] = offsetPosition;
					}
				});

				position = {
					my: myAt.join(" "),
					at: myAt.join(" "),
					offset: offset.join(" ")
				};
			} 

			position = $.extend({}, $.ui.dialog.prototype.options.position, position);
		} else {
			position = $.ui.dialog.prototype.options.position;
		}

		// need to show the dialog to get the actual offset in the position plugin
		isVisible = this.uiDialog.is(':visible');
		if (!isVisible) {
			this.uiDialog.show();
		}
		this.uiDialog
			// workaround for jQuery bug #5781 http://dev.jquery.com/ticket/5781
			.css({ top: 0, left: 0 })
			.position($.extend({ of: window }, position));
		if (!isVisible) {
			this.uiDialog.hide();
		}
	},

	_setOptions: function( options ) {
		var self = this,
			resizableOptions = {},
			resize = false;

		$.each( options, function( key, value ) {
			self._setOption( key, value );
			
			if ( key in sizeRelatedOptions ) {
				resize = true;
			}
			if ( key in resizableRelatedOptions ) {
				resizableOptions[ key ] = value;
			}
		});

		if ( resize ) {
			this._size();
		}
		if ( this.uiDialog.is( ":data(resizable)" ) ) {
			this.uiDialog.resizable( "option", resizableOptions );
		}
	},

	_setOption: function(key, value){
		var self = this,
			uiDialog = self.uiDialog;

		switch (key) {
			//handling of deprecated beforeclose (vs beforeClose) option
			//Ticket #4669 http://dev.jqueryui.com/ticket/4669
			//TODO: remove in 1.9pre
			case "beforeclose":
				key = "beforeClose";
				break;
			case "buttons":
				self._createButtons(value);
				break;
			case "closeText":
				// ensure that we always pass a string
				self.uiDialogTitlebarCloseText.text("" + value);
				break;
			case "dialogClass":
				uiDialog
					.removeClass(self.options.dialogClass)
					.addClass(uiDialogClasses + value);
				break;
			case "disabled":
				if (value) {
					uiDialog.addClass('ui-dialog-disabled');
				} else {
					uiDialog.removeClass('ui-dialog-disabled');
				}
				break;
			case "draggable":
				var isDraggable = uiDialog.is( ":data(draggable)" );
				if ( isDraggable && !value ) {
					uiDialog.draggable( "destroy" );
				}
				
				if ( !isDraggable && value ) {
					self._makeDraggable();
				}
				break;
			case "position":
				self._position(value);
				break;
			case "resizable":
				// currently resizable, becoming non-resizable
				var isResizable = uiDialog.is( ":data(resizable)" );
				if (isResizable && !value) {
					uiDialog.resizable('destroy');
				}

				// currently resizable, changing handles
				if (isResizable && typeof value === 'string') {
					uiDialog.resizable('option', 'handles', value);
				}

				// currently non-resizable, becoming resizable
				if (!isResizable && value !== false) {
					self._makeResizable(value);
				}
				break;
			case "title":
				// convert whatever was passed in o a string, for html() to not throw up
				$(".ui-dialog-title", self.uiDialogTitlebar).html("" + (value || '&#160;'));
				break;
		}

		$.Widget.prototype._setOption.apply(self, arguments);
	},

	_size: function() {
		/* If the user has resized the dialog, the .ui-dialog and .ui-dialog-content
		 * divs will both have width and height set, so we need to reset them
		 */
		var options = this.options,
			nonContentHeight,
			minContentHeight,
			isVisible = this.uiDialog.is( ":visible" );

		// reset content sizing
		this.element.show().css({
			width: 'auto',
			minHeight: 0,
			height: 0
		});

		if (options.minWidth > options.width) {
			options.width = options.minWidth;
		}

		// reset wrapper sizing
		// determine the height of all the non-content elements
		nonContentHeight = this.uiDialog.css({
				height: 'auto',
				width: options.width
			})
			.height();
		minContentHeight = Math.max( 0, options.minHeight - nonContentHeight );
		
		if ( options.height === "auto" ) {
			// only needed for IE6 support
			if ( $.support.minHeight ) {
				this.element.css({
					minHeight: minContentHeight,
					height: "auto"
				});
			} else {
				this.uiDialog.show();
				var autoHeight = this.element.css( "height", "auto" ).height();
				if ( !isVisible ) {
					this.uiDialog.hide();
				}
				this.element.height( Math.max( autoHeight, minContentHeight ) );
			}
		} else {
			this.element.height( Math.max( options.height - nonContentHeight, 0 ) );
		}

		if (this.uiDialog.is(':data(resizable)')) {
			this.uiDialog.resizable('option', 'minHeight', this._minHeight());
		}
	}
});

$.extend($.ui.dialog, {
	version: "1.8.22",

	uuid: 0,
	maxZ: 0,

	getTitleId: function($el) {
		var id = $el.attr('id');
		if (!id) {
			this.uuid += 1;
			id = this.uuid;
		}
		return 'ui-dialog-title-' + id;
	},

	overlay: function(dialog) {
		this.$el = $.ui.dialog.overlay.create(dialog);
	}
});

$.extend($.ui.dialog.overlay, {
	instances: [],
	// reuse old instances due to IE memory leak with alpha transparency (see #5185)
	oldInstances: [],
	maxZ: 0,
	events: $.map('focus,mousedown,mouseup,keydown,keypress,click'.split(','),
		function(event) { return event + '.dialog-overlay'; }).join(' '),
	create: function(dialog) {
		if (this.instances.length === 0) {
			// prevent use of anchors and inputs
			// we use a setTimeout in case the overlay is created from an
			// event that we're going to be cancelling (see #2804)
			setTimeout(function() {
				// handle $(el).dialog().dialog('close') (see #4065)
				if ($.ui.dialog.overlay.instances.length) {
					$(document).bind($.ui.dialog.overlay.events, function(event) {
						// stop events if the z-index of the target is < the z-index of the overlay
						// we cannot return true when we don't want to cancel the event (#3523)
						if ($(event.target).zIndex() < $.ui.dialog.overlay.maxZ) {
							return false;
						}
					});
				}
			}, 1);

			// allow closing by pressing the escape key
			$(document).bind('keydown.dialog-overlay', function(event) {
				if (dialog.options.closeOnEscape && !event.isDefaultPrevented() && event.keyCode &&
					event.keyCode === $.ui.keyCode.ESCAPE) {
					
					dialog.close(event);
					event.preventDefault();
				}
			});

			// handle window resize
			$(window).bind('resize.dialog-overlay', $.ui.dialog.overlay.resize);
		}

		var $el = (this.oldInstances.pop() || $('<div></div>').addClass('ui-widget-overlay'))
			.appendTo(document.body)
			.css({
				width: this.width(),
				height: this.height()
			});

		if ($.fn.bgiframe) {
			$el.bgiframe();
		}

		this.instances.push($el);
		return $el;
	},

	destroy: function($el) {
		var indexOf = $.inArray($el, this.instances);
		if (indexOf != -1){
			this.oldInstances.push(this.instances.splice(indexOf, 1)[0]);
		}

		if (this.instances.length === 0) {
			$([document, window]).unbind('.dialog-overlay');
		}

		$el.remove();
		
		// adjust the maxZ to allow other modal dialogs to continue to work (see #4309)
		var maxZ = 0;
		$.each(this.instances, function() {
			maxZ = Math.max(maxZ, this.css('z-index'));
		});
		this.maxZ = maxZ;
	},

	height: function() {
		var scrollHeight,
			offsetHeight;
		// handle IE 6
		if ($.browser.msie && $.browser.version < 7) {
			scrollHeight = Math.max(
				document.documentElement.scrollHeight,
				document.body.scrollHeight
			);
			offsetHeight = Math.max(
				document.documentElement.offsetHeight,
				document.body.offsetHeight
			);

			if (scrollHeight < offsetHeight) {
				return $(window).height() + 'px';
			} else {
				return scrollHeight + 'px';
			}
		// handle "good" browsers
		} else {
			return $(document).height() + 'px';
		}
	},

	width: function() {
		var scrollWidth,
			offsetWidth;
		// handle IE
		if ( $.browser.msie ) {
			scrollWidth = Math.max(
				document.documentElement.scrollWidth,
				document.body.scrollWidth
			);
			offsetWidth = Math.max(
				document.documentElement.offsetWidth,
				document.body.offsetWidth
			);

			if (scrollWidth < offsetWidth) {
				return $(window).width() + 'px';
			} else {
				return scrollWidth + 'px';
			}
		// handle "good" browsers
		} else {
			return $(document).width() + 'px';
		}
	},

	resize: function() {
		/* If the dialog is draggable and the user drags it past the
		 * right edge of the window, the document becomes wider so we
		 * need to stretch the overlay. If the user then drags the
		 * dialog back to the left, the document will become narrower,
		 * so we need to shrink the overlay to the appropriate size.
		 * This is handled by shrinking the overlay before setting it
		 * to the full document size.
		 */
		var $overlays = $([]);
		$.each($.ui.dialog.overlay.instances, function() {
			$overlays = $overlays.add(this);
		});

		$overlays.css({
			width: 0,
			height: 0
		}).css({
			width: $.ui.dialog.overlay.width(),
			height: $.ui.dialog.overlay.height()
		});
	}
});

$.extend($.ui.dialog.overlay.prototype, {
	destroy: function() {
		$.ui.dialog.overlay.destroy(this.$el);
	}
});

}(jQuery));
/*!
 * jQuery UI Slider 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Slider
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

// number of pages in a slider
// (how many times can you page up/down to go through the whole range)
var numPages = 5;

$.widget( "ui.slider", $.ui.mouse, {

	widgetEventPrefix: "slide",

	options: {
		animate: false,
		distance: 0,
		max: 100,
		min: 0,
		orientation: "horizontal",
		range: false,
		step: 1,
		value: 0,
		values: null
	},

	_create: function() {
		var self = this,
			o = this.options,
			existingHandles = this.element.find( ".ui-slider-handle" ).addClass( "ui-state-default ui-corner-all" ),
			handle = "<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",
			handleCount = ( o.values && o.values.length ) || 1,
			handles = [];

		this._keySliding = false;
		this._mouseSliding = false;
		this._animateOff = true;
		this._handleIndex = null;
		this._detectOrientation();
		this._mouseInit();

		this.element
			.addClass( "ui-slider" +
				" ui-slider-" + this.orientation +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all" +
				( o.disabled ? " ui-slider-disabled ui-disabled" : "" ) );

		this.range = $([]);

		if ( o.range ) {
			if ( o.range === true ) {
				if ( !o.values ) {
					o.values = [ this._valueMin(), this._valueMin() ];
				}
				if ( o.values.length && o.values.length !== 2 ) {
					o.values = [ o.values[0], o.values[0] ];
				}
			}

			this.range = $( "<div></div>" )
				.appendTo( this.element )
				.addClass( "ui-slider-range" +
				// note: this isn't the most fittingly semantic framework class for this element,
				// but worked best visually with a variety of themes
				" ui-widget-header" + 
				( ( o.range === "min" || o.range === "max" ) ? " ui-slider-range-" + o.range : "" ) );
		}

		for ( var i = existingHandles.length; i < handleCount; i += 1 ) {
			handles.push( handle );
		}

		this.handles = existingHandles.add( $( handles.join( "" ) ).appendTo( self.element ) );

		this.handle = this.handles.eq( 0 );

		this.handles.add( this.range ).filter( "a" )
			.click(function( event ) {
				event.preventDefault();
			})
			.hover(function() {
				if ( !o.disabled ) {
					$( this ).addClass( "ui-state-hover" );
				}
			}, function() {
				$( this ).removeClass( "ui-state-hover" );
			})
			.focus(function() {
				if ( !o.disabled ) {
					$( ".ui-slider .ui-state-focus" ).removeClass( "ui-state-focus" );
					$( this ).addClass( "ui-state-focus" );
				} else {
					$( this ).blur();
				}
			})
			.blur(function() {
				$( this ).removeClass( "ui-state-focus" );
			});

		this.handles.each(function( i ) {
			$( this ).data( "index.ui-slider-handle", i );
		});

		this.handles
			.keydown(function( event ) {
				var index = $( this ).data( "index.ui-slider-handle" ),
					allowed,
					curVal,
					newVal,
					step;
	
				if ( self.options.disabled ) {
					return;
				}
	
				switch ( event.keyCode ) {
					case $.ui.keyCode.HOME:
					case $.ui.keyCode.END:
					case $.ui.keyCode.PAGE_UP:
					case $.ui.keyCode.PAGE_DOWN:
					case $.ui.keyCode.UP:
					case $.ui.keyCode.RIGHT:
					case $.ui.keyCode.DOWN:
					case $.ui.keyCode.LEFT:
						event.preventDefault();
						if ( !self._keySliding ) {
							self._keySliding = true;
							$( this ).addClass( "ui-state-active" );
							allowed = self._start( event, index );
							if ( allowed === false ) {
								return;
							}
						}
						break;
				}
	
				step = self.options.step;
				if ( self.options.values && self.options.values.length ) {
					curVal = newVal = self.values( index );
				} else {
					curVal = newVal = self.value();
				}
	
				switch ( event.keyCode ) {
					case $.ui.keyCode.HOME:
						newVal = self._valueMin();
						break;
					case $.ui.keyCode.END:
						newVal = self._valueMax();
						break;
					case $.ui.keyCode.PAGE_UP:
						newVal = self._trimAlignValue( curVal + ( (self._valueMax() - self._valueMin()) / numPages ) );
						break;
					case $.ui.keyCode.PAGE_DOWN:
						newVal = self._trimAlignValue( curVal - ( (self._valueMax() - self._valueMin()) / numPages ) );
						break;
					case $.ui.keyCode.UP:
					case $.ui.keyCode.RIGHT:
						if ( curVal === self._valueMax() ) {
							return;
						}
						newVal = self._trimAlignValue( curVal + step );
						break;
					case $.ui.keyCode.DOWN:
					case $.ui.keyCode.LEFT:
						if ( curVal === self._valueMin() ) {
							return;
						}
						newVal = self._trimAlignValue( curVal - step );
						break;
				}
	
				self._slide( event, index, newVal );
			})
			.keyup(function( event ) {
				var index = $( this ).data( "index.ui-slider-handle" );
	
				if ( self._keySliding ) {
					self._keySliding = false;
					self._stop( event, index );
					self._change( event, index );
					$( this ).removeClass( "ui-state-active" );
				}
	
			});

		this._refreshValue();

		this._animateOff = false;
	},

	destroy: function() {
		this.handles.remove();
		this.range.remove();

		this.element
			.removeClass( "ui-slider" +
				" ui-slider-horizontal" +
				" ui-slider-vertical" +
				" ui-slider-disabled" +
				" ui-widget" +
				" ui-widget-content" +
				" ui-corner-all" )
			.removeData( "slider" )
			.unbind( ".slider" );

		this._mouseDestroy();

		return this;
	},

	_mouseCapture: function( event ) {
		var o = this.options,
			position,
			normValue,
			distance,
			closestHandle,
			self,
			index,
			allowed,
			offset,
			mouseOverHandle;

		if ( o.disabled ) {
			return false;
		}

		this.elementSize = {
			width: this.element.outerWidth(),
			height: this.element.outerHeight()
		};
		this.elementOffset = this.element.offset();

		position = { x: event.pageX, y: event.pageY };
		normValue = this._normValueFromMouse( position );
		distance = this._valueMax() - this._valueMin() + 1;
		self = this;
		this.handles.each(function( i ) {
			var thisDistance = Math.abs( normValue - self.values(i) );
			if ( distance > thisDistance ) {
				distance = thisDistance;
				closestHandle = $( this );
				index = i;
			}
		});

		// workaround for bug #3736 (if both handles of a range are at 0,
		// the first is always used as the one with least distance,
		// and moving it is obviously prevented by preventing negative ranges)
		if( o.range === true && this.values(1) === o.min ) {
			index += 1;
			closestHandle = $( this.handles[index] );
		}

		allowed = this._start( event, index );
		if ( allowed === false ) {
			return false;
		}
		this._mouseSliding = true;

		self._handleIndex = index;

		closestHandle
			.addClass( "ui-state-active" )
			.focus();
		
		offset = closestHandle.offset();
		mouseOverHandle = !$( event.target ).parents().andSelf().is( ".ui-slider-handle" );
		this._clickOffset = mouseOverHandle ? { left: 0, top: 0 } : {
			left: event.pageX - offset.left - ( closestHandle.width() / 2 ),
			top: event.pageY - offset.top -
				( closestHandle.height() / 2 ) -
				( parseInt( closestHandle.css("borderTopWidth"), 10 ) || 0 ) -
				( parseInt( closestHandle.css("borderBottomWidth"), 10 ) || 0) +
				( parseInt( closestHandle.css("marginTop"), 10 ) || 0)
		};

		if ( !this.handles.hasClass( "ui-state-hover" ) ) {
			this._slide( event, index, normValue );
		}
		this._animateOff = true;
		return true;
	},

	_mouseStart: function( event ) {
		return true;
	},

	_mouseDrag: function( event ) {
		var position = { x: event.pageX, y: event.pageY },
			normValue = this._normValueFromMouse( position );
		
		this._slide( event, this._handleIndex, normValue );

		return false;
	},

	_mouseStop: function( event ) {
		this.handles.removeClass( "ui-state-active" );
		this._mouseSliding = false;

		this._stop( event, this._handleIndex );
		this._change( event, this._handleIndex );

		this._handleIndex = null;
		this._clickOffset = null;
		this._animateOff = false;

		return false;
	},
	
	_detectOrientation: function() {
		this.orientation = ( this.options.orientation === "vertical" ) ? "vertical" : "horizontal";
	},

	_normValueFromMouse: function( position ) {
		var pixelTotal,
			pixelMouse,
			percentMouse,
			valueTotal,
			valueMouse;

		if ( this.orientation === "horizontal" ) {
			pixelTotal = this.elementSize.width;
			pixelMouse = position.x - this.elementOffset.left - ( this._clickOffset ? this._clickOffset.left : 0 );
		} else {
			pixelTotal = this.elementSize.height;
			pixelMouse = position.y - this.elementOffset.top - ( this._clickOffset ? this._clickOffset.top : 0 );
		}

		percentMouse = ( pixelMouse / pixelTotal );
		if ( percentMouse > 1 ) {
			percentMouse = 1;
		}
		if ( percentMouse < 0 ) {
			percentMouse = 0;
		}
		if ( this.orientation === "vertical" ) {
			percentMouse = 1 - percentMouse;
		}

		valueTotal = this._valueMax() - this._valueMin();
		valueMouse = this._valueMin() + percentMouse * valueTotal;

		return this._trimAlignValue( valueMouse );
	},

	_start: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}
		return this._trigger( "start", event, uiHash );
	},

	_slide: function( event, index, newVal ) {
		var otherVal,
			newValues,
			allowed;

		if ( this.options.values && this.options.values.length ) {
			otherVal = this.values( index ? 0 : 1 );

			if ( ( this.options.values.length === 2 && this.options.range === true ) && 
					( ( index === 0 && newVal > otherVal) || ( index === 1 && newVal < otherVal ) )
				) {
				newVal = otherVal;
			}

			if ( newVal !== this.values( index ) ) {
				newValues = this.values();
				newValues[ index ] = newVal;
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal,
					values: newValues
				} );
				otherVal = this.values( index ? 0 : 1 );
				if ( allowed !== false ) {
					this.values( index, newVal, true );
				}
			}
		} else {
			if ( newVal !== this.value() ) {
				// A slide can be canceled by returning false from the slide callback
				allowed = this._trigger( "slide", event, {
					handle: this.handles[ index ],
					value: newVal
				} );
				if ( allowed !== false ) {
					this.value( newVal );
				}
			}
		}
	},

	_stop: function( event, index ) {
		var uiHash = {
			handle: this.handles[ index ],
			value: this.value()
		};
		if ( this.options.values && this.options.values.length ) {
			uiHash.value = this.values( index );
			uiHash.values = this.values();
		}

		this._trigger( "stop", event, uiHash );
	},

	_change: function( event, index ) {
		if ( !this._keySliding && !this._mouseSliding ) {
			var uiHash = {
				handle: this.handles[ index ],
				value: this.value()
			};
			if ( this.options.values && this.options.values.length ) {
				uiHash.value = this.values( index );
				uiHash.values = this.values();
			}

			this._trigger( "change", event, uiHash );
		}
	},

	value: function( newValue ) {
		if ( arguments.length ) {
			this.options.value = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, 0 );
			return;
		}

		return this._value();
	},

	values: function( index, newValue ) {
		var vals,
			newValues,
			i;

		if ( arguments.length > 1 ) {
			this.options.values[ index ] = this._trimAlignValue( newValue );
			this._refreshValue();
			this._change( null, index );
			return;
		}

		if ( arguments.length ) {
			if ( $.isArray( arguments[ 0 ] ) ) {
				vals = this.options.values;
				newValues = arguments[ 0 ];
				for ( i = 0; i < vals.length; i += 1 ) {
					vals[ i ] = this._trimAlignValue( newValues[ i ] );
					this._change( null, i );
				}
				this._refreshValue();
			} else {
				if ( this.options.values && this.options.values.length ) {
					return this._values( index );
				} else {
					return this.value();
				}
			}
		} else {
			return this._values();
		}
	},

	_setOption: function( key, value ) {
		var i,
			valsLength = 0;

		if ( $.isArray( this.options.values ) ) {
			valsLength = this.options.values.length;
		}

		$.Widget.prototype._setOption.apply( this, arguments );

		switch ( key ) {
			case "disabled":
				if ( value ) {
					this.handles.filter( ".ui-state-focus" ).blur();
					this.handles.removeClass( "ui-state-hover" );
					this.handles.propAttr( "disabled", true );
					this.element.addClass( "ui-disabled" );
				} else {
					this.handles.propAttr( "disabled", false );
					this.element.removeClass( "ui-disabled" );
				}
				break;
			case "orientation":
				this._detectOrientation();
				this.element
					.removeClass( "ui-slider-horizontal ui-slider-vertical" )
					.addClass( "ui-slider-" + this.orientation );
				this._refreshValue();
				break;
			case "value":
				this._animateOff = true;
				this._refreshValue();
				this._change( null, 0 );
				this._animateOff = false;
				break;
			case "values":
				this._animateOff = true;
				this._refreshValue();
				for ( i = 0; i < valsLength; i += 1 ) {
					this._change( null, i );
				}
				this._animateOff = false;
				break;
		}
	},

	//internal value getter
	// _value() returns value trimmed by min and max, aligned by step
	_value: function() {
		var val = this.options.value;
		val = this._trimAlignValue( val );

		return val;
	},

	//internal values getter
	// _values() returns array of values trimmed by min and max, aligned by step
	// _values( index ) returns single value trimmed by min and max, aligned by step
	_values: function( index ) {
		var val,
			vals,
			i;

		if ( arguments.length ) {
			val = this.options.values[ index ];
			val = this._trimAlignValue( val );

			return val;
		} else {
			// .slice() creates a copy of the array
			// this copy gets trimmed by min and max and then returned
			vals = this.options.values.slice();
			for ( i = 0; i < vals.length; i+= 1) {
				vals[ i ] = this._trimAlignValue( vals[ i ] );
			}

			return vals;
		}
	},
	
	// returns the step-aligned value that val is closest to, between (inclusive) min and max
	_trimAlignValue: function( val ) {
		if ( val <= this._valueMin() ) {
			return this._valueMin();
		}
		if ( val >= this._valueMax() ) {
			return this._valueMax();
		}
		var step = ( this.options.step > 0 ) ? this.options.step : 1,
			valModStep = (val - this._valueMin()) % step,
			alignValue = val - valModStep;

		if ( Math.abs(valModStep) * 2 >= step ) {
			alignValue += ( valModStep > 0 ) ? step : ( -step );
		}

		// Since JavaScript has problems with large floats, round
		// the final value to 5 digits after the decimal point (see #4124)
		return parseFloat( alignValue.toFixed(5) );
	},

	_valueMin: function() {
		return this.options.min;
	},

	_valueMax: function() {
		return this.options.max;
	},
	
	_refreshValue: function() {
		var oRange = this.options.range,
			o = this.options,
			self = this,
			animate = ( !this._animateOff ) ? o.animate : false,
			valPercent,
			_set = {},
			lastValPercent,
			value,
			valueMin,
			valueMax;

		if ( this.options.values && this.options.values.length ) {
			this.handles.each(function( i, j ) {
				valPercent = ( self.values(i) - self._valueMin() ) / ( self._valueMax() - self._valueMin() ) * 100;
				_set[ self.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
				$( this ).stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );
				if ( self.options.range === true ) {
					if ( self.orientation === "horizontal" ) {
						if ( i === 0 ) {
							self.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { left: valPercent + "%" }, o.animate );
						}
						if ( i === 1 ) {
							self.range[ animate ? "animate" : "css" ]( { width: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					} else {
						if ( i === 0 ) {
							self.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { bottom: ( valPercent ) + "%" }, o.animate );
						}
						if ( i === 1 ) {
							self.range[ animate ? "animate" : "css" ]( { height: ( valPercent - lastValPercent ) + "%" }, { queue: false, duration: o.animate } );
						}
					}
				}
				lastValPercent = valPercent;
			});
		} else {
			value = this.value();
			valueMin = this._valueMin();
			valueMax = this._valueMax();
			valPercent = ( valueMax !== valueMin ) ?
					( value - valueMin ) / ( valueMax - valueMin ) * 100 :
					0;
			_set[ self.orientation === "horizontal" ? "left" : "bottom" ] = valPercent + "%";
			this.handle.stop( 1, 1 )[ animate ? "animate" : "css" ]( _set, o.animate );

			if ( oRange === "min" && this.orientation === "horizontal" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { width: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "horizontal" ) {
				this.range[ animate ? "animate" : "css" ]( { width: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
			if ( oRange === "min" && this.orientation === "vertical" ) {
				this.range.stop( 1, 1 )[ animate ? "animate" : "css" ]( { height: valPercent + "%" }, o.animate );
			}
			if ( oRange === "max" && this.orientation === "vertical" ) {
				this.range[ animate ? "animate" : "css" ]( { height: ( 100 - valPercent ) + "%" }, { queue: false, duration: o.animate } );
			}
		}
	}

});

$.extend( $.ui.slider, {
	version: "1.8.22"
});

}(jQuery));
/*!
 * jQuery UI Tabs 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Tabs
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 */
(function( $, undefined ) {

var tabId = 0,
	listId = 0;

function getNextTabId() {
	return ++tabId;
}

function getNextListId() {
	return ++listId;
}

$.widget( "ui.tabs", {
	options: {
		add: null,
		ajaxOptions: null,
		cache: false,
		cookie: null, // e.g. { expires: 7, path: '/', domain: 'jquery.com', secure: true }
		collapsible: false,
		disable: null,
		disabled: [],
		enable: null,
		event: "click",
		fx: null, // e.g. { height: 'toggle', opacity: 'toggle', duration: 200 }
		idPrefix: "ui-tabs-",
		load: null,
		panelTemplate: "<div></div>",
		remove: null,
		select: null,
		show: null,
		spinner: "<em>Loading&#8230;</em>",
		tabTemplate: "<li><a href='#{href}'><span>#{label}</span></a></li>"
	},

	_create: function() {
		this._tabify( true );
	},

	_setOption: function( key, value ) {
		if ( key == "selected" ) {
			if (this.options.collapsible && value == this.options.selected ) {
				return;
			}
			this.select( value );
		} else {
			this.options[ key ] = value;
			this._tabify();
		}
	},

	_tabId: function( a ) {
		return a.title && a.title.replace( /\s/g, "_" ).replace( /[^\w\u00c0-\uFFFF-]/g, "" ) ||
			this.options.idPrefix + getNextTabId();
	},

	_sanitizeSelector: function( hash ) {
		// we need this because an id may contain a ":"
		return hash.replace( /:/g, "\\:" );
	},

	_cookie: function() {
		var cookie = this.cookie ||
			( this.cookie = this.options.cookie.name || "ui-tabs-" + getNextListId() );
		return $.cookie.apply( null, [ cookie ].concat( $.makeArray( arguments ) ) );
	},

	_ui: function( tab, panel ) {
		return {
			tab: tab,
			panel: panel,
			index: this.anchors.index( tab )
		};
	},

	_cleanup: function() {
		// restore all former loading tabs labels
		this.lis.filter( ".ui-state-processing" )
			.removeClass( "ui-state-processing" )
			.find( "span:data(label.tabs)" )
				.each(function() {
					var el = $( this );
					el.html( el.data( "label.tabs" ) ).removeData( "label.tabs" );
				});
	},

	_tabify: function( init ) {
		var self = this,
			o = this.options,
			fragmentId = /^#.+/; // Safari 2 reports '#' for an empty hash

		this.list = this.element.find( "ol,ul" ).eq( 0 );
		this.lis = $( " > li:has(a[href])", this.list );
		this.anchors = this.lis.map(function() {
			return $( "a", this )[ 0 ];
		});
		this.panels = $( [] );

		this.anchors.each(function( i, a ) {
			var href = $( a ).attr( "href" );
			// For dynamically created HTML that contains a hash as href IE < 8 expands
			// such href to the full page url with hash and then misinterprets tab as ajax.
			// Same consideration applies for an added tab with a fragment identifier
			// since a[href=#fragment-identifier] does unexpectedly not match.
			// Thus normalize href attribute...
			var hrefBase = href.split( "#" )[ 0 ],
				baseEl;
			if ( hrefBase && ( hrefBase === location.toString().split( "#" )[ 0 ] ||
					( baseEl = $( "base" )[ 0 ]) && hrefBase === baseEl.href ) ) {
				href = a.hash;
				a.href = href;
			}

			// inline tab
			if ( fragmentId.test( href ) ) {
				self.panels = self.panels.add( self.element.find( self._sanitizeSelector( href ) ) );
			// remote tab
			// prevent loading the page itself if href is just "#"
			} else if ( href && href !== "#" ) {
				// required for restore on destroy
				$.data( a, "href.tabs", href );

				// TODO until #3808 is fixed strip fragment identifier from url
				// (IE fails to load from such url)
				$.data( a, "load.tabs", href.replace( /#.*$/, "" ) );

				var id = self._tabId( a );
				a.href = "#" + id;
				var $panel = self.element.find( "#" + id );
				if ( !$panel.length ) {
					$panel = $( o.panelTemplate )
						.attr( "id", id )
						.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" )
						.insertAfter( self.panels[ i - 1 ] || self.list );
					$panel.data( "destroy.tabs", true );
				}
				self.panels = self.panels.add( $panel );
			// invalid tab href
			} else {
				o.disabled.push( i );
			}
		});

		// initialization from scratch
		if ( init ) {
			// attach necessary classes for styling
			this.element.addClass( "ui-tabs ui-widget ui-widget-content ui-corner-all" );
			this.list.addClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" );
			this.lis.addClass( "ui-state-default ui-corner-top" );
			this.panels.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom" );

			// Selected tab
			// use "selected" option or try to retrieve:
			// 1. from fragment identifier in url
			// 2. from cookie
			// 3. from selected class attribute on <li>
			if ( o.selected === undefined ) {
				if ( location.hash ) {
					this.anchors.each(function( i, a ) {
						if ( a.hash == location.hash ) {
							o.selected = i;
							return false;
						}
					});
				}
				if ( typeof o.selected !== "number" && o.cookie ) {
					o.selected = parseInt( self._cookie(), 10 );
				}
				if ( typeof o.selected !== "number" && this.lis.filter( ".ui-tabs-selected" ).length ) {
					o.selected = this.lis.index( this.lis.filter( ".ui-tabs-selected" ) );
				}
				o.selected = o.selected || ( this.lis.length ? 0 : -1 );
			} else if ( o.selected === null ) { // usage of null is deprecated, TODO remove in next release
				o.selected = -1;
			}

			// sanity check - default to first tab...
			o.selected = ( ( o.selected >= 0 && this.anchors[ o.selected ] ) || o.selected < 0 )
				? o.selected
				: 0;

			// Take disabling tabs via class attribute from HTML
			// into account and update option properly.
			// A selected tab cannot become disabled.
			o.disabled = $.unique( o.disabled.concat(
				$.map( this.lis.filter( ".ui-state-disabled" ), function( n, i ) {
					return self.lis.index( n );
				})
			) ).sort();

			if ( $.inArray( o.selected, o.disabled ) != -1 ) {
				o.disabled.splice( $.inArray( o.selected, o.disabled ), 1 );
			}

			// highlight selected tab
			this.panels.addClass( "ui-tabs-hide" );
			this.lis.removeClass( "ui-tabs-selected ui-state-active" );
			// check for length avoids error when initializing empty list
			if ( o.selected >= 0 && this.anchors.length ) {
				self.element.find( self._sanitizeSelector( self.anchors[ o.selected ].hash ) ).removeClass( "ui-tabs-hide" );
				this.lis.eq( o.selected ).addClass( "ui-tabs-selected ui-state-active" );

				// seems to be expected behavior that the show callback is fired
				self.element.queue( "tabs", function() {
					self._trigger( "show", null,
						self._ui( self.anchors[ o.selected ], self.element.find( self._sanitizeSelector( self.anchors[ o.selected ].hash ) )[ 0 ] ) );
				});

				this.load( o.selected );
			}

			// clean up to avoid memory leaks in certain versions of IE 6
			// TODO: namespace this event
			$( window ).bind( "unload", function() {
				self.lis.add( self.anchors ).unbind( ".tabs" );
				self.lis = self.anchors = self.panels = null;
			});
		// update selected after add/remove
		} else {
			o.selected = this.lis.index( this.lis.filter( ".ui-tabs-selected" ) );
		}

		// update collapsible
		// TODO: use .toggleClass()
		this.element[ o.collapsible ? "addClass" : "removeClass" ]( "ui-tabs-collapsible" );

		// set or update cookie after init and add/remove respectively
		if ( o.cookie ) {
			this._cookie( o.selected, o.cookie );
		}

		// disable tabs
		for ( var i = 0, li; ( li = this.lis[ i ] ); i++ ) {
			$( li )[ $.inArray( i, o.disabled ) != -1 &&
				// TODO: use .toggleClass()
				!$( li ).hasClass( "ui-tabs-selected" ) ? "addClass" : "removeClass" ]( "ui-state-disabled" );
		}

		// reset cache if switching from cached to not cached
		if ( o.cache === false ) {
			this.anchors.removeData( "cache.tabs" );
		}

		// remove all handlers before, tabify may run on existing tabs after add or option change
		this.lis.add( this.anchors ).unbind( ".tabs" );

		if ( o.event !== "mouseover" ) {
			var addState = function( state, el ) {
				if ( el.is( ":not(.ui-state-disabled)" ) ) {
					el.addClass( "ui-state-" + state );
				}
			};
			var removeState = function( state, el ) {
				el.removeClass( "ui-state-" + state );
			};
			this.lis.bind( "mouseover.tabs" , function() {
				addState( "hover", $( this ) );
			});
			this.lis.bind( "mouseout.tabs", function() {
				removeState( "hover", $( this ) );
			});
			this.anchors.bind( "focus.tabs", function() {
				addState( "focus", $( this ).closest( "li" ) );
			});
			this.anchors.bind( "blur.tabs", function() {
				removeState( "focus", $( this ).closest( "li" ) );
			});
		}

		// set up animations
		var hideFx, showFx;
		if ( o.fx ) {
			if ( $.isArray( o.fx ) ) {
				hideFx = o.fx[ 0 ];
				showFx = o.fx[ 1 ];
			} else {
				hideFx = showFx = o.fx;
			}
		}

		// Reset certain styles left over from animation
		// and prevent IE's ClearType bug...
		function resetStyle( $el, fx ) {
			$el.css( "display", "" );
			if ( !$.support.opacity && fx.opacity ) {
				$el[ 0 ].style.removeAttribute( "filter" );
			}
		}

		// Show a tab...
		var showTab = showFx
			? function( clicked, $show ) {
				$( clicked ).closest( "li" ).addClass( "ui-tabs-selected ui-state-active" );
				$show.hide().removeClass( "ui-tabs-hide" ) // avoid flicker that way
					.animate( showFx, showFx.duration || "normal", function() {
						resetStyle( $show, showFx );
						self._trigger( "show", null, self._ui( clicked, $show[ 0 ] ) );
					});
			}
			: function( clicked, $show ) {
				$( clicked ).closest( "li" ).addClass( "ui-tabs-selected ui-state-active" );
				$show.removeClass( "ui-tabs-hide" );
				self._trigger( "show", null, self._ui( clicked, $show[ 0 ] ) );
			};

		// Hide a tab, $show is optional...
		var hideTab = hideFx
			? function( clicked, $hide ) {
				$hide.animate( hideFx, hideFx.duration || "normal", function() {
					self.lis.removeClass( "ui-tabs-selected ui-state-active" );
					$hide.addClass( "ui-tabs-hide" );
					resetStyle( $hide, hideFx );
					self.element.dequeue( "tabs" );
				});
			}
			: function( clicked, $hide, $show ) {
				self.lis.removeClass( "ui-tabs-selected ui-state-active" );
				$hide.addClass( "ui-tabs-hide" );
				self.element.dequeue( "tabs" );
			};

		// attach tab event handler, unbind to avoid duplicates from former tabifying...
		this.anchors.bind( o.event + ".tabs", function() {
			var el = this,
				$li = $(el).closest( "li" ),
				$hide = self.panels.filter( ":not(.ui-tabs-hide)" ),
				$show = self.element.find( self._sanitizeSelector( el.hash ) );

			// If tab is already selected and not collapsible or tab disabled or
			// or is already loading or click callback returns false stop here.
			// Check if click handler returns false last so that it is not executed
			// for a disabled or loading tab!
			if ( ( $li.hasClass( "ui-tabs-selected" ) && !o.collapsible) ||
				$li.hasClass( "ui-state-disabled" ) ||
				$li.hasClass( "ui-state-processing" ) ||
				self.panels.filter( ":animated" ).length ||
				self._trigger( "select", null, self._ui( this, $show[ 0 ] ) ) === false ) {
				this.blur();
				return false;
			}

			o.selected = self.anchors.index( this );

			self.abort();

			// if tab may be closed
			if ( o.collapsible ) {
				if ( $li.hasClass( "ui-tabs-selected" ) ) {
					o.selected = -1;

					if ( o.cookie ) {
						self._cookie( o.selected, o.cookie );
					}

					self.element.queue( "tabs", function() {
						hideTab( el, $hide );
					}).dequeue( "tabs" );

					this.blur();
					return false;
				} else if ( !$hide.length ) {
					if ( o.cookie ) {
						self._cookie( o.selected, o.cookie );
					}

					self.element.queue( "tabs", function() {
						showTab( el, $show );
					});

					// TODO make passing in node possible, see also http://dev.jqueryui.com/ticket/3171
					self.load( self.anchors.index( this ) );

					this.blur();
					return false;
				}
			}

			if ( o.cookie ) {
				self._cookie( o.selected, o.cookie );
			}

			// show new tab
			if ( $show.length ) {
				if ( $hide.length ) {
					self.element.queue( "tabs", function() {
						hideTab( el, $hide );
					});
				}
				self.element.queue( "tabs", function() {
					showTab( el, $show );
				});

				self.load( self.anchors.index( this ) );
			} else {
				throw "jQuery UI Tabs: Mismatching fragment identifier.";
			}

			// Prevent IE from keeping other link focussed when using the back button
			// and remove dotted border from clicked link. This is controlled via CSS
			// in modern browsers; blur() removes focus from address bar in Firefox
			// which can become a usability and annoying problem with tabs('rotate').
			if ( $.browser.msie ) {
				this.blur();
			}
		});

		// disable click in any case
		this.anchors.bind( "click.tabs", function(){
			return false;
		});
	},

    _getIndex: function( index ) {
		// meta-function to give users option to provide a href string instead of a numerical index.
		// also sanitizes numerical indexes to valid values.
		if ( typeof index == "string" ) {
			index = this.anchors.index( this.anchors.filter( "[href$='" + index + "']" ) );
		}

		return index;
	},

	destroy: function() {
		var o = this.options;

		this.abort();

		this.element
			.unbind( ".tabs" )
			.removeClass( "ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible" )
			.removeData( "tabs" );

		this.list.removeClass( "ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" );

		this.anchors.each(function() {
			var href = $.data( this, "href.tabs" );
			if ( href ) {
				this.href = href;
			}
			var $this = $( this ).unbind( ".tabs" );
			$.each( [ "href", "load", "cache" ], function( i, prefix ) {
				$this.removeData( prefix + ".tabs" );
			});
		});

		this.lis.unbind( ".tabs" ).add( this.panels ).each(function() {
			if ( $.data( this, "destroy.tabs" ) ) {
				$( this ).remove();
			} else {
				$( this ).removeClass([
					"ui-state-default",
					"ui-corner-top",
					"ui-tabs-selected",
					"ui-state-active",
					"ui-state-hover",
					"ui-state-focus",
					"ui-state-disabled",
					"ui-tabs-panel",
					"ui-widget-content",
					"ui-corner-bottom",
					"ui-tabs-hide"
				].join( " " ) );
			}
		});

		if ( o.cookie ) {
			this._cookie( null, o.cookie );
		}

		return this;
	},

	add: function( url, label, index ) {
		if ( index === undefined ) {
			index = this.anchors.length;
		}

		var self = this,
			o = this.options,
			$li = $( o.tabTemplate.replace( /#\{href\}/g, url ).replace( /#\{label\}/g, label ) ),
			id = !url.indexOf( "#" ) ? url.replace( "#", "" ) : this._tabId( $( "a", $li )[ 0 ] );

		$li.addClass( "ui-state-default ui-corner-top" ).data( "destroy.tabs", true );

		// try to find an existing element before creating a new one
		var $panel = self.element.find( "#" + id );
		if ( !$panel.length ) {
			$panel = $( o.panelTemplate )
				.attr( "id", id )
				.data( "destroy.tabs", true );
		}
		$panel.addClass( "ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide" );

		if ( index >= this.lis.length ) {
			$li.appendTo( this.list );
			$panel.appendTo( this.list[ 0 ].parentNode );
		} else {
			$li.insertBefore( this.lis[ index ] );
			$panel.insertBefore( this.panels[ index ] );
		}

		o.disabled = $.map( o.disabled, function( n, i ) {
			return n >= index ? ++n : n;
		});

		this._tabify();

		if ( this.anchors.length == 1 ) {
			o.selected = 0;
			$li.addClass( "ui-tabs-selected ui-state-active" );
			$panel.removeClass( "ui-tabs-hide" );
			this.element.queue( "tabs", function() {
				self._trigger( "show", null, self._ui( self.anchors[ 0 ], self.panels[ 0 ] ) );
			});

			this.load( 0 );
		}

		this._trigger( "add", null, this._ui( this.anchors[ index ], this.panels[ index ] ) );
		return this;
	},

	remove: function( index ) {
		index = this._getIndex( index );
		var o = this.options,
			$li = this.lis.eq( index ).remove(),
			$panel = this.panels.eq( index ).remove();

		// If selected tab was removed focus tab to the right or
		// in case the last tab was removed the tab to the left.
		if ( $li.hasClass( "ui-tabs-selected" ) && this.anchors.length > 1) {
			this.select( index + ( index + 1 < this.anchors.length ? 1 : -1 ) );
		}

		o.disabled = $.map(
			$.grep( o.disabled, function(n, i) {
				return n != index;
			}),
			function( n, i ) {
				return n >= index ? --n : n;
			});

		this._tabify();

		this._trigger( "remove", null, this._ui( $li.find( "a" )[ 0 ], $panel[ 0 ] ) );
		return this;
	},

	enable: function( index ) {
		index = this._getIndex( index );
		var o = this.options;
		if ( $.inArray( index, o.disabled ) == -1 ) {
			return;
		}

		this.lis.eq( index ).removeClass( "ui-state-disabled" );
		o.disabled = $.grep( o.disabled, function( n, i ) {
			return n != index;
		});

		this._trigger( "enable", null, this._ui( this.anchors[ index ], this.panels[ index ] ) );
		return this;
	},

	disable: function( index ) {
		index = this._getIndex( index );
		var self = this, o = this.options;
		// cannot disable already selected tab
		if ( index != o.selected ) {
			this.lis.eq( index ).addClass( "ui-state-disabled" );

			o.disabled.push( index );
			o.disabled.sort();

			this._trigger( "disable", null, this._ui( this.anchors[ index ], this.panels[ index ] ) );
		}

		return this;
	},

	select: function( index ) {
		index = this._getIndex( index );
		if ( index == -1 ) {
			if ( this.options.collapsible && this.options.selected != -1 ) {
				index = this.options.selected;
			} else {
				return this;
			}
		}
		this.anchors.eq( index ).trigger( this.options.event + ".tabs" );
		return this;
	},

	load: function( index ) {
		index = this._getIndex( index );
		var self = this,
			o = this.options,
			a = this.anchors.eq( index )[ 0 ],
			url = $.data( a, "load.tabs" );

		this.abort();

		// not remote or from cache
		if ( !url || this.element.queue( "tabs" ).length !== 0 && $.data( a, "cache.tabs" ) ) {
			this.element.dequeue( "tabs" );
			return;
		}

		// load remote from here on
		this.lis.eq( index ).addClass( "ui-state-processing" );

		if ( o.spinner ) {
			var span = $( "span", a );
			span.data( "label.tabs", span.html() ).html( o.spinner );
		}

		this.xhr = $.ajax( $.extend( {}, o.ajaxOptions, {
			url: url,
			success: function( r, s ) {
				self.element.find( self._sanitizeSelector( a.hash ) ).html( r );

				// take care of tab labels
				self._cleanup();

				if ( o.cache ) {
					$.data( a, "cache.tabs", true );
				}

				self._trigger( "load", null, self._ui( self.anchors[ index ], self.panels[ index ] ) );
				try {
					o.ajaxOptions.success( r, s );
				}
				catch ( e ) {}
			},
			error: function( xhr, s, e ) {
				// take care of tab labels
				self._cleanup();

				self._trigger( "load", null, self._ui( self.anchors[ index ], self.panels[ index ] ) );
				try {
					// Passing index avoid a race condition when this method is
					// called after the user has selected another tab.
					// Pass the anchor that initiated this request allows
					// loadError to manipulate the tab content panel via $(a.hash)
					o.ajaxOptions.error( xhr, s, index, a );
				}
				catch ( e ) {}
			}
		} ) );

		// last, so that load event is fired before show...
		self.element.dequeue( "tabs" );

		return this;
	},

	abort: function() {
		// stop possibly running animations
		this.element.queue( [] );
		this.panels.stop( false, true );

		// "tabs" queue must not contain more than two elements,
		// which are the callbacks for the latest clicked tab...
		this.element.queue( "tabs", this.element.queue( "tabs" ).splice( -2, 2 ) );

		// terminate pending requests from other tabs
		if ( this.xhr ) {
			this.xhr.abort();
			delete this.xhr;
		}

		// take care of tab labels
		this._cleanup();
		return this;
	},

	url: function( index, url ) {
		this.anchors.eq( index ).removeData( "cache.tabs" ).data( "load.tabs", url );
		return this;
	},

	length: function() {
		return this.anchors.length;
	}
});

$.extend( $.ui.tabs, {
	version: "1.8.22"
});

/*
 * Tabs Extensions
 */

/*
 * Rotate
 */
$.extend( $.ui.tabs.prototype, {
	rotation: null,
	rotate: function( ms, continuing ) {
		var self = this,
			o = this.options;

		var rotate = self._rotate || ( self._rotate = function( e ) {
			clearTimeout( self.rotation );
			self.rotation = setTimeout(function() {
				var t = o.selected;
				self.select( ++t < self.anchors.length ? t : 0 );
			}, ms );
			
			if ( e ) {
				e.stopPropagation();
			}
		});

		var stop = self._unrotate || ( self._unrotate = !continuing
			? function(e) {
				if (e.clientX) { // in case of a true click
					self.rotate(null);
				}
			}
			: function( e ) {
				rotate();
			});

		// start rotation
		if ( ms ) {
			this.element.bind( "tabsshow", rotate );
			this.anchors.bind( o.event + ".tabs", stop );
			rotate();
		// stop rotation
		} else {
			clearTimeout( self.rotation );
			this.element.unbind( "tabsshow", rotate );
			this.anchors.unbind( o.event + ".tabs", stop );
			delete this._rotate;
			delete this._unrotate;
		}

		return this;
	}
});

})( jQuery );
/*!
 * jQuery UI Datepicker 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Datepicker
 *
 * Depends:
 *	jquery.ui.core.js
 */
(function( $, undefined ) {

$.extend($.ui, { datepicker: { version: "1.8.22" } });

var PROP_NAME = 'datepicker';
var dpuuid = new Date().getTime();
var instActive;

/* Date picker manager.
   Use the singleton instance of this class, $.datepicker, to interact with the date picker.
   Settings for (groups of) date pickers are maintained in an instance object,
   allowing multiple different settings on the same page. */

function Datepicker() {
	this.debug = false; // Change this to true to start debugging
	this._curInst = null; // The current instance in use
	this._keyEvent = false; // If the last event was a key event
	this._disabledInputs = []; // List of date picker inputs that have been disabled
	this._datepickerShowing = false; // True if the popup picker is showing , false if not
	this._inDialog = false; // True if showing within a "dialog", false if not
	this._mainDivId = 'ui-datepicker-div'; // The ID of the main datepicker division
	this._inlineClass = 'ui-datepicker-inline'; // The name of the inline marker class
	this._appendClass = 'ui-datepicker-append'; // The name of the append marker class
	this._triggerClass = 'ui-datepicker-trigger'; // The name of the trigger marker class
	this._dialogClass = 'ui-datepicker-dialog'; // The name of the dialog marker class
	this._disableClass = 'ui-datepicker-disabled'; // The name of the disabled covering marker class
	this._unselectableClass = 'ui-datepicker-unselectable'; // The name of the unselectable cell marker class
	this._currentClass = 'ui-datepicker-current-day'; // The name of the current day marker class
	this._dayOverClass = 'ui-datepicker-days-cell-over'; // The name of the day hover marker class
	this.regional = []; // Available regional settings, indexed by language code
	this.regional[''] = { // Default regional settings
		closeText: 'Done', // Display text for close link
		prevText: 'Prev', // Display text for previous month link
		nextText: 'Next', // Display text for next month link
		currentText: 'Today', // Display text for current month link
		monthNames: ['January','February','March','April','May','June',
			'July','August','September','October','November','December'], // Names of months for drop-down and formatting
		monthNamesShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], // For formatting
		dayNames: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], // For formatting
		dayNamesShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], // For formatting
		dayNamesMin: ['Su','Mo','Tu','We','Th','Fr','Sa'], // Column headings for days starting at Sunday
		weekHeader: 'Wk', // Column header for week of the year
		dateFormat: 'mm/dd/yy', // See format options on parseDate
		firstDay: 0, // The first day of the week, Sun = 0, Mon = 1, ...
		isRTL: false, // True if right-to-left language, false if left-to-right
		showMonthAfterYear: false, // True if the year select precedes month, false for month then year
		yearSuffix: '' // Additional text to append to the year in the month headers
	};
	this._defaults = { // Global defaults for all the date picker instances
		showOn: 'focus', // 'focus' for popup on focus,
			// 'button' for trigger button, or 'both' for either
		showAnim: 'fadeIn', // Name of jQuery animation for popup
		showOptions: {}, // Options for enhanced animations
		defaultDate: null, // Used when field is blank: actual date,
			// +/-number for offset from today, null for today
		appendText: '', // Display text following the input box, e.g. showing the format
		buttonText: '...', // Text for trigger button
		buttonImage: '', // URL for trigger button image
		buttonImageOnly: false, // True if the image appears alone, false if it appears on a button
		hideIfNoPrevNext: false, // True to hide next/previous month links
			// if not applicable, false to just disable them
		navigationAsDateFormat: false, // True if date formatting applied to prev/today/next links
		gotoCurrent: false, // True if today link goes back to current selection instead
		changeMonth: false, // True if month can be selected directly, false if only prev/next
		changeYear: false, // True if year can be selected directly, false if only prev/next
		yearRange: 'c-10:c+10', // Range of years to display in drop-down,
			// either relative to today's year (-nn:+nn), relative to currently displayed year
			// (c-nn:c+nn), absolute (nnnn:nnnn), or a combination of the above (nnnn:-n)
		showOtherMonths: false, // True to show dates in other months, false to leave blank
		selectOtherMonths: false, // True to allow selection of dates in other months, false for unselectable
		showWeek: false, // True to show week of the year, false to not show it
		calculateWeek: this.iso8601Week, // How to calculate the week of the year,
			// takes a Date and returns the number of the week for it
		shortYearCutoff: '+10', // Short year values < this are in the current century,
			// > this are in the previous century,
			// string value starting with '+' for current year + value
		minDate: null, // The earliest selectable date, or null for no limit
		maxDate: null, // The latest selectable date, or null for no limit
		duration: 'fast', // Duration of display/closure
		beforeShowDay: null, // Function that takes a date and returns an array with
			// [0] = true if selectable, false if not, [1] = custom CSS class name(s) or '',
			// [2] = cell title (optional), e.g. $.datepicker.noWeekends
		beforeShow: null, // Function that takes an input field and
			// returns a set of custom settings for the date picker
		onSelect: null, // Define a callback function when a date is selected
		onChangeMonthYear: null, // Define a callback function when the month or year is changed
		onClose: null, // Define a callback function when the datepicker is closed
		numberOfMonths: 1, // Number of months to show at a time
		showCurrentAtPos: 0, // The position in multipe months at which to show the current month (starting at 0)
		stepMonths: 1, // Number of months to step back/forward
		stepBigMonths: 12, // Number of months to step back/forward for the big links
		altField: '', // Selector for an alternate field to store selected dates into
		altFormat: '', // The date format to use for the alternate field
		constrainInput: true, // The input is constrained by the current date format
		showButtonPanel: false, // True to show button panel, false to not show it
		autoSize: false, // True to size the input for the date format, false to leave as is
		disabled: false // The initial disabled state
	};
	$.extend(this._defaults, this.regional['']);
	this.dpDiv = bindHover($('<div id="' + this._mainDivId + '" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>'));
}

$.extend(Datepicker.prototype, {
	/* Class name added to elements to indicate already configured with a date picker. */
	markerClassName: 'hasDatepicker',
	
	//Keep track of the maximum number of rows displayed (see #7043)
	maxRows: 4,

	/* Debug logging (if enabled). */
	log: function () {
		if (this.debug)
			console.log.apply('', arguments);
	},
	
	// TODO rename to "widget" when switching to widget factory
	_widgetDatepicker: function() {
		return this.dpDiv;
	},

	/* Override the default settings for all instances of the date picker.
	   @param  settings  object - the new settings to use as defaults (anonymous object)
	   @return the manager object */
	setDefaults: function(settings) {
		extendRemove(this._defaults, settings || {});
		return this;
	},

	/* Attach the date picker to a jQuery selection.
	   @param  target    element - the target input field or division or span
	   @param  settings  object - the new settings to use for this date picker instance (anonymous) */
	_attachDatepicker: function(target, settings) {
		// check for settings on the control itself - in namespace 'date:'
		var inlineSettings = null;
		for (var attrName in this._defaults) {
			var attrValue = target.getAttribute('date:' + attrName);
			if (attrValue) {
				inlineSettings = inlineSettings || {};
				try {
					inlineSettings[attrName] = eval(attrValue);
				} catch (err) {
					inlineSettings[attrName] = attrValue;
				}
			}
		}
		var nodeName = target.nodeName.toLowerCase();
		var inline = (nodeName == 'div' || nodeName == 'span');
		if (!target.id) {
			this.uuid += 1;
			target.id = 'dp' + this.uuid;
		}
		var inst = this._newInst($(target), inline);
		inst.settings = $.extend({}, settings || {}, inlineSettings || {});
		if (nodeName == 'input') {
			this._connectDatepicker(target, inst);
		} else if (inline) {
			this._inlineDatepicker(target, inst);
		}
	},

	/* Create a new instance object. */
	_newInst: function(target, inline) {
		var id = target[0].id.replace(/([^A-Za-z0-9_-])/g, '\\\\$1'); // escape jQuery meta chars
		return {id: id, input: target, // associated target
			selectedDay: 0, selectedMonth: 0, selectedYear: 0, // current selection
			drawMonth: 0, drawYear: 0, // month being drawn
			inline: inline, // is datepicker inline or not
			dpDiv: (!inline ? this.dpDiv : // presentation div
			bindHover($('<div class="' + this._inlineClass + ' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>')))};
	},

	/* Attach the date picker to an input field. */
	_connectDatepicker: function(target, inst) {
		var input = $(target);
		inst.append = $([]);
		inst.trigger = $([]);
		if (input.hasClass(this.markerClassName))
			return;
		this._attachments(input, inst);
		input.addClass(this.markerClassName).keydown(this._doKeyDown).
			keypress(this._doKeyPress).keyup(this._doKeyUp).
			bind("setData.datepicker", function(event, key, value) {
				inst.settings[key] = value;
			}).bind("getData.datepicker", function(event, key) {
				return this._get(inst, key);
			});
		this._autoSize(inst);
		$.data(target, PROP_NAME, inst);
		//If disabled option is true, disable the datepicker once it has been attached to the input (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
	},

	/* Make attachments based on settings. */
	_attachments: function(input, inst) {
		var appendText = this._get(inst, 'appendText');
		var isRTL = this._get(inst, 'isRTL');
		if (inst.append)
			inst.append.remove();
		if (appendText) {
			inst.append = $('<span class="' + this._appendClass + '">' + appendText + '</span>');
			input[isRTL ? 'before' : 'after'](inst.append);
		}
		input.unbind('focus', this._showDatepicker);
		if (inst.trigger)
			inst.trigger.remove();
		var showOn = this._get(inst, 'showOn');
		if (showOn == 'focus' || showOn == 'both') // pop-up date picker when in the marked field
			input.focus(this._showDatepicker);
		if (showOn == 'button' || showOn == 'both') { // pop-up date picker when button clicked
			var buttonText = this._get(inst, 'buttonText');
			var buttonImage = this._get(inst, 'buttonImage');
			inst.trigger = $(this._get(inst, 'buttonImageOnly') ?
				$('<img/>').addClass(this._triggerClass).
					attr({ src: buttonImage, alt: buttonText, title: buttonText }) :
				$('<button type="button"></button>').addClass(this._triggerClass).
					html(buttonImage == '' ? buttonText : $('<img/>').attr(
					{ src:buttonImage, alt:buttonText, title:buttonText })));
			input[isRTL ? 'before' : 'after'](inst.trigger);
			inst.trigger.click(function() {
				if ($.datepicker._datepickerShowing && $.datepicker._lastInput == input[0])
					$.datepicker._hideDatepicker();
				else if ($.datepicker._datepickerShowing && $.datepicker._lastInput != input[0]) {
					$.datepicker._hideDatepicker(); 
					$.datepicker._showDatepicker(input[0]);
				} else
					$.datepicker._showDatepicker(input[0]);
				return false;
			});
		}
	},

	/* Apply the maximum length for the date format. */
	_autoSize: function(inst) {
		if (this._get(inst, 'autoSize') && !inst.inline) {
			var date = new Date(2009, 12 - 1, 20); // Ensure double digits
			var dateFormat = this._get(inst, 'dateFormat');
			if (dateFormat.match(/[DM]/)) {
				var findMax = function(names) {
					var max = 0;
					var maxI = 0;
					for (var i = 0; i < names.length; i++) {
						if (names[i].length > max) {
							max = names[i].length;
							maxI = i;
						}
					}
					return maxI;
				};
				date.setMonth(findMax(this._get(inst, (dateFormat.match(/MM/) ?
					'monthNames' : 'monthNamesShort'))));
				date.setDate(findMax(this._get(inst, (dateFormat.match(/DD/) ?
					'dayNames' : 'dayNamesShort'))) + 20 - date.getDay());
			}
			inst.input.attr('size', this._formatDate(inst, date).length);
		}
	},

	/* Attach an inline date picker to a div. */
	_inlineDatepicker: function(target, inst) {
		var divSpan = $(target);
		if (divSpan.hasClass(this.markerClassName))
			return;
		divSpan.addClass(this.markerClassName).append(inst.dpDiv).
			bind("setData.datepicker", function(event, key, value){
				inst.settings[key] = value;
			}).bind("getData.datepicker", function(event, key){
				return this._get(inst, key);
			});
		$.data(target, PROP_NAME, inst);
		this._setDate(inst, this._getDefaultDate(inst), true);
		this._updateDatepicker(inst);
		this._updateAlternate(inst);
		//If disabled option is true, disable the datepicker before showing it (see ticket #5665)
		if( inst.settings.disabled ) {
			this._disableDatepicker( target );
		}
		// Set display:block in place of inst.dpDiv.show() which won't work on disconnected elements
		// http://bugs.jqueryui.com/ticket/7552 - A Datepicker created on a detached div has zero height
		inst.dpDiv.css( "display", "block" );
	},

	/* Pop-up the date picker in a "dialog" box.
	   @param  input     element - ignored
	   @param  date      string or Date - the initial date to display
	   @param  onSelect  function - the function to call when a date is selected
	   @param  settings  object - update the dialog date picker instance's settings (anonymous object)
	   @param  pos       int[2] - coordinates for the dialog's position within the screen or
	                     event - with x/y coordinates or
	                     leave empty for default (screen centre)
	   @return the manager object */
	_dialogDatepicker: function(input, date, onSelect, settings, pos) {
		var inst = this._dialogInst; // internal instance
		if (!inst) {
			this.uuid += 1;
			var id = 'dp' + this.uuid;
			this._dialogInput = $('<input type="text" id="' + id +
				'" style="position: absolute; top: -100px; width: 0px;"/>');
			this._dialogInput.keydown(this._doKeyDown);
			$('body').append(this._dialogInput);
			inst = this._dialogInst = this._newInst(this._dialogInput, false);
			inst.settings = {};
			$.data(this._dialogInput[0], PROP_NAME, inst);
		}
		extendRemove(inst.settings, settings || {});
		date = (date && date.constructor == Date ? this._formatDate(inst, date) : date);
		this._dialogInput.val(date);

		this._pos = (pos ? (pos.length ? pos : [pos.pageX, pos.pageY]) : null);
		if (!this._pos) {
			var browserWidth = document.documentElement.clientWidth;
			var browserHeight = document.documentElement.clientHeight;
			var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
			var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
			this._pos = // should use actual width/height below
				[(browserWidth / 2) - 100 + scrollX, (browserHeight / 2) - 150 + scrollY];
		}

		// move input on screen for focus, but hidden behind dialog
		this._dialogInput.css('left', (this._pos[0] + 20) + 'px').css('top', this._pos[1] + 'px');
		inst.settings.onSelect = onSelect;
		this._inDialog = true;
		this.dpDiv.addClass(this._dialogClass);
		this._showDatepicker(this._dialogInput[0]);
		if ($.blockUI)
			$.blockUI(this.dpDiv);
		$.data(this._dialogInput[0], PROP_NAME, inst);
		return this;
	},

	/* Detach a datepicker from its control.
	   @param  target    element - the target input field or division or span */
	_destroyDatepicker: function(target) {
		var $target = $(target);
		var inst = $.data(target, PROP_NAME);
		if (!$target.hasClass(this.markerClassName)) {
			return;
		}
		var nodeName = target.nodeName.toLowerCase();
		$.removeData(target, PROP_NAME);
		if (nodeName == 'input') {
			inst.append.remove();
			inst.trigger.remove();
			$target.removeClass(this.markerClassName).
				unbind('focus', this._showDatepicker).
				unbind('keydown', this._doKeyDown).
				unbind('keypress', this._doKeyPress).
				unbind('keyup', this._doKeyUp);
		} else if (nodeName == 'div' || nodeName == 'span')
			$target.removeClass(this.markerClassName).empty();
	},

	/* Enable the date picker to a jQuery selection.
	   @param  target    element - the target input field or division or span */
	_enableDatepicker: function(target) {
		var $target = $(target);
		var inst = $.data(target, PROP_NAME);
		if (!$target.hasClass(this.markerClassName)) {
			return;
		}
		var nodeName = target.nodeName.toLowerCase();
		if (nodeName == 'input') {
			target.disabled = false;
			inst.trigger.filter('button').
				each(function() { this.disabled = false; }).end().
				filter('img').css({opacity: '1.0', cursor: ''});
		}
		else if (nodeName == 'div' || nodeName == 'span') {
			var inline = $target.children('.' + this._inlineClass);
			inline.children().removeClass('ui-state-disabled');
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				removeAttr("disabled");
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value == target ? null : value); }); // delete entry
	},

	/* Disable the date picker to a jQuery selection.
	   @param  target    element - the target input field or division or span */
	_disableDatepicker: function(target) {
		var $target = $(target);
		var inst = $.data(target, PROP_NAME);
		if (!$target.hasClass(this.markerClassName)) {
			return;
		}
		var nodeName = target.nodeName.toLowerCase();
		if (nodeName == 'input') {
			target.disabled = true;
			inst.trigger.filter('button').
				each(function() { this.disabled = true; }).end().
				filter('img').css({opacity: '0.5', cursor: 'default'});
		}
		else if (nodeName == 'div' || nodeName == 'span') {
			var inline = $target.children('.' + this._inlineClass);
			inline.children().addClass('ui-state-disabled');
			inline.find("select.ui-datepicker-month, select.ui-datepicker-year").
				attr("disabled", "disabled");
		}
		this._disabledInputs = $.map(this._disabledInputs,
			function(value) { return (value == target ? null : value); }); // delete entry
		this._disabledInputs[this._disabledInputs.length] = target;
	},

	/* Is the first field in a jQuery collection disabled as a datepicker?
	   @param  target    element - the target input field or division or span
	   @return boolean - true if disabled, false if enabled */
	_isDisabledDatepicker: function(target) {
		if (!target) {
			return false;
		}
		for (var i = 0; i < this._disabledInputs.length; i++) {
			if (this._disabledInputs[i] == target)
				return true;
		}
		return false;
	},

	/* Retrieve the instance data for the target control.
	   @param  target  element - the target input field or division or span
	   @return  object - the associated instance data
	   @throws  error if a jQuery problem getting data */
	_getInst: function(target) {
		try {
			return $.data(target, PROP_NAME);
		}
		catch (err) {
			throw 'Missing instance data for this datepicker';
		}
	},

	/* Update or retrieve the settings for a date picker attached to an input field or division.
	   @param  target  element - the target input field or division or span
	   @param  name    object - the new settings to update or
	                   string - the name of the setting to change or retrieve,
	                   when retrieving also 'all' for all instance settings or
	                   'defaults' for all global defaults
	   @param  value   any - the new value for the setting
	                   (omit if above is an object or to retrieve a value) */
	_optionDatepicker: function(target, name, value) {
		var inst = this._getInst(target);
		if (arguments.length == 2 && typeof name == 'string') {
			return (name == 'defaults' ? $.extend({}, $.datepicker._defaults) :
				(inst ? (name == 'all' ? $.extend({}, inst.settings) :
				this._get(inst, name)) : null));
		}
		var settings = name || {};
		if (typeof name == 'string') {
			settings = {};
			settings[name] = value;
		}
		if (inst) {
			if (this._curInst == inst) {
				this._hideDatepicker();
			}
			var date = this._getDateDatepicker(target, true);
			var minDate = this._getMinMaxDate(inst, 'min');
			var maxDate = this._getMinMaxDate(inst, 'max');
			extendRemove(inst.settings, settings);
			// reformat the old minDate/maxDate values if dateFormat changes and a new minDate/maxDate isn't provided
			if (minDate !== null && settings['dateFormat'] !== undefined && settings['minDate'] === undefined)
				inst.settings.minDate = this._formatDate(inst, minDate);
			if (maxDate !== null && settings['dateFormat'] !== undefined && settings['maxDate'] === undefined)
				inst.settings.maxDate = this._formatDate(inst, maxDate);
			this._attachments($(target), inst);
			this._autoSize(inst);
			this._setDate(inst, date);
			this._updateAlternate(inst);
			this._updateDatepicker(inst);
		}
	},

	// change method deprecated
	_changeDatepicker: function(target, name, value) {
		this._optionDatepicker(target, name, value);
	},

	/* Redraw the date picker attached to an input field or division.
	   @param  target  element - the target input field or division or span */
	_refreshDatepicker: function(target) {
		var inst = this._getInst(target);
		if (inst) {
			this._updateDatepicker(inst);
		}
	},

	/* Set the dates for a jQuery selection.
	   @param  target   element - the target input field or division or span
	   @param  date     Date - the new date */
	_setDateDatepicker: function(target, date) {
		var inst = this._getInst(target);
		if (inst) {
			this._setDate(inst, date);
			this._updateDatepicker(inst);
			this._updateAlternate(inst);
		}
	},

	/* Get the date(s) for the first entry in a jQuery selection.
	   @param  target     element - the target input field or division or span
	   @param  noDefault  boolean - true if no default date is to be used
	   @return Date - the current date */
	_getDateDatepicker: function(target, noDefault) {
		var inst = this._getInst(target);
		if (inst && !inst.inline)
			this._setDateFromField(inst, noDefault);
		return (inst ? this._getDate(inst) : null);
	},

	/* Handle keystrokes. */
	_doKeyDown: function(event) {
		var inst = $.datepicker._getInst(event.target);
		var handled = true;
		var isRTL = inst.dpDiv.is('.ui-datepicker-rtl');
		inst._keyEvent = true;
		if ($.datepicker._datepickerShowing)
			switch (event.keyCode) {
				case 9: $.datepicker._hideDatepicker();
						handled = false;
						break; // hide on tab out
				case 13: var sel = $('td.' + $.datepicker._dayOverClass + ':not(.' + 
									$.datepicker._currentClass + ')', inst.dpDiv);
						if (sel[0])
							$.datepicker._selectDay(event.target, inst.selectedMonth, inst.selectedYear, sel[0]);
							var onSelect = $.datepicker._get(inst, 'onSelect');
							if (onSelect) {
								var dateStr = $.datepicker._formatDate(inst);

								// trigger custom callback
								onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);
							}
						else
							$.datepicker._hideDatepicker();
						return false; // don't submit the form
						break; // select the value on enter
				case 27: $.datepicker._hideDatepicker();
						break; // hide on escape
				case 33: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							-$.datepicker._get(inst, 'stepBigMonths') :
							-$.datepicker._get(inst, 'stepMonths')), 'M');
						break; // previous month/year on page up/+ ctrl
				case 34: $.datepicker._adjustDate(event.target, (event.ctrlKey ?
							+$.datepicker._get(inst, 'stepBigMonths') :
							+$.datepicker._get(inst, 'stepMonths')), 'M');
						break; // next month/year on page down/+ ctrl
				case 35: if (event.ctrlKey || event.metaKey) $.datepicker._clearDate(event.target);
						handled = event.ctrlKey || event.metaKey;
						break; // clear on ctrl or command +end
				case 36: if (event.ctrlKey || event.metaKey) $.datepicker._gotoToday(event.target);
						handled = event.ctrlKey || event.metaKey;
						break; // current on ctrl or command +home
				case 37: if (event.ctrlKey || event.metaKey) $.datepicker._adjustDate(event.target, (isRTL ? +1 : -1), 'D');
						handled = event.ctrlKey || event.metaKey;
						// -1 day on ctrl or command +left
						if (event.originalEvent.altKey) $.datepicker._adjustDate(event.target, (event.ctrlKey ?
									-$.datepicker._get(inst, 'stepBigMonths') :
									-$.datepicker._get(inst, 'stepMonths')), 'M');
						// next month/year on alt +left on Mac
						break;
				case 38: if (event.ctrlKey || event.metaKey) $.datepicker._adjustDate(event.target, -7, 'D');
						handled = event.ctrlKey || event.metaKey;
						break; // -1 week on ctrl or command +up
				case 39: if (event.ctrlKey || event.metaKey) $.datepicker._adjustDate(event.target, (isRTL ? -1 : +1), 'D');
						handled = event.ctrlKey || event.metaKey;
						// +1 day on ctrl or command +right
						if (event.originalEvent.altKey) $.datepicker._adjustDate(event.target, (event.ctrlKey ?
									+$.datepicker._get(inst, 'stepBigMonths') :
									+$.datepicker._get(inst, 'stepMonths')), 'M');
						// next month/year on alt +right
						break;
				case 40: if (event.ctrlKey || event.metaKey) $.datepicker._adjustDate(event.target, +7, 'D');
						handled = event.ctrlKey || event.metaKey;
						break; // +1 week on ctrl or command +down
				default: handled = false;
			}
		else if (event.keyCode == 36 && event.ctrlKey) // display the date picker on ctrl+home
			$.datepicker._showDatepicker(this);
		else {
			handled = false;
		}
		if (handled) {
			event.preventDefault();
			event.stopPropagation();
		}
	},

	/* Filter entered characters - based on date format. */
	_doKeyPress: function(event) {
		var inst = $.datepicker._getInst(event.target);
		if ($.datepicker._get(inst, 'constrainInput')) {
			var chars = $.datepicker._possibleChars($.datepicker._get(inst, 'dateFormat'));
			var chr = String.fromCharCode(event.charCode == undefined ? event.keyCode : event.charCode);
			return event.ctrlKey || event.metaKey || (chr < ' ' || !chars || chars.indexOf(chr) > -1);
		}
	},

	/* Synchronise manual entry and field/alternate field. */
	_doKeyUp: function(event) {
		var inst = $.datepicker._getInst(event.target);
		if (inst.input.val() != inst.lastVal) {
			try {
				var date = $.datepicker.parseDate($.datepicker._get(inst, 'dateFormat'),
					(inst.input ? inst.input.val() : null),
					$.datepicker._getFormatConfig(inst));
				if (date) { // only if valid
					$.datepicker._setDateFromField(inst);
					$.datepicker._updateAlternate(inst);
					$.datepicker._updateDatepicker(inst);
				}
			}
			catch (err) {
				$.datepicker.log(err);
			}
		}
		return true;
	},

	/* Pop-up the date picker for a given input field.
       If false returned from beforeShow event handler do not show. 
	   @param  input  element - the input field attached to the date picker or
	                  event - if triggered by focus */
	_showDatepicker: function(input) {
		input = input.target || input;
		if (input.nodeName.toLowerCase() != 'input') // find from button/image trigger
			input = $('input', input.parentNode)[0];
		if ($.datepicker._isDisabledDatepicker(input) || $.datepicker._lastInput == input) // already here
			return;
		var inst = $.datepicker._getInst(input);
		if ($.datepicker._curInst && $.datepicker._curInst != inst) {
			$.datepicker._curInst.dpDiv.stop(true, true);
			if ( inst && $.datepicker._datepickerShowing ) {
				$.datepicker._hideDatepicker( $.datepicker._curInst.input[0] );
			}
		}
		var beforeShow = $.datepicker._get(inst, 'beforeShow');
		var beforeShowSettings = beforeShow ? beforeShow.apply(input, [input, inst]) : {};
		if(beforeShowSettings === false){
            //false
			return;
		}
		extendRemove(inst.settings, beforeShowSettings);
		inst.lastVal = null;
		$.datepicker._lastInput = input;
		$.datepicker._setDateFromField(inst);
		if ($.datepicker._inDialog) // hide cursor
			input.value = '';
		if (!$.datepicker._pos) { // position below input
			$.datepicker._pos = $.datepicker._findPos(input);
			$.datepicker._pos[1] += input.offsetHeight; // add the height
		}
		var isFixed = false;
		$(input).parents().each(function() {
			isFixed |= $(this).css('position') == 'fixed';
			return !isFixed;
		});
		if (isFixed && $.browser.opera) { // correction for Opera when fixed and scrolled
			$.datepicker._pos[0] -= document.documentElement.scrollLeft;
			$.datepicker._pos[1] -= document.documentElement.scrollTop;
		}
		var offset = {left: $.datepicker._pos[0], top: $.datepicker._pos[1]};
		$.datepicker._pos = null;
		//to avoid flashes on Firefox
		inst.dpDiv.empty();
		// determine sizing offscreen
		inst.dpDiv.css({position: 'absolute', display: 'block', top: '-1000px'});
		$.datepicker._updateDatepicker(inst);
		// fix width for dynamic number of date pickers
		// and adjust position before showing
		offset = $.datepicker._checkOffset(inst, offset, isFixed);
		inst.dpDiv.css({position: ($.datepicker._inDialog && $.blockUI ?
			'static' : (isFixed ? 'fixed' : 'absolute')), display: 'none',
			left: offset.left + 'px', top: offset.top + 'px'});
		if (!inst.inline) {
			var showAnim = $.datepicker._get(inst, 'showAnim');
			var duration = $.datepicker._get(inst, 'duration');
			var postProcess = function() {
				var cover = inst.dpDiv.find('iframe.ui-datepicker-cover'); // IE6- only
				if( !! cover.length ){
					var borders = $.datepicker._getBorders(inst.dpDiv);
					cover.css({left: -borders[0], top: -borders[1],
						width: inst.dpDiv.outerWidth(), height: inst.dpDiv.outerHeight()});
				}
			};
			inst.dpDiv.zIndex($(input).zIndex()+1);
			$.datepicker._datepickerShowing = true;
			if ($.effects && $.effects[showAnim])
				inst.dpDiv.show(showAnim, $.datepicker._get(inst, 'showOptions'), duration, postProcess);
			else
				inst.dpDiv[showAnim || 'show']((showAnim ? duration : null), postProcess);
			if (!showAnim || !duration)
				postProcess();
			if (inst.input.is(':visible') && !inst.input.is(':disabled'))
				inst.input.focus();
			$.datepicker._curInst = inst;
		}
	},

	/* Generate the date picker content. */
	_updateDatepicker: function(inst) {
		var self = this;
		self.maxRows = 4; //Reset the max number of rows being displayed (see #7043)
		var borders = $.datepicker._getBorders(inst.dpDiv);
		instActive = inst; // for delegate hover events
		inst.dpDiv.empty().append(this._generateHTML(inst));
		this._attachHandlers(inst);
		var cover = inst.dpDiv.find('iframe.ui-datepicker-cover'); // IE6- only
		if( !!cover.length ){ //avoid call to outerXXXX() when not in IE6
			cover.css({left: -borders[0], top: -borders[1], width: inst.dpDiv.outerWidth(), height: inst.dpDiv.outerHeight()})
		}
		inst.dpDiv.find('.' + this._dayOverClass + ' a').mouseover();
		var numMonths = this._getNumberOfMonths(inst);
		var cols = numMonths[1];
		var width = 17;
		inst.dpDiv.removeClass('ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4').width('');
		if (cols > 1)
			inst.dpDiv.addClass('ui-datepicker-multi-' + cols).css('width', (width * cols) + 'em');
		inst.dpDiv[(numMonths[0] != 1 || numMonths[1] != 1 ? 'add' : 'remove') +
			'Class']('ui-datepicker-multi');
		inst.dpDiv[(this._get(inst, 'isRTL') ? 'add' : 'remove') +
			'Class']('ui-datepicker-rtl');
		if (inst == $.datepicker._curInst && $.datepicker._datepickerShowing && inst.input &&
				// #6694 - don't focus the input if it's already focused
				// this breaks the change event in IE
				inst.input.is(':visible') && !inst.input.is(':disabled') && inst.input[0] != document.activeElement)
			inst.input.focus();
		// deffered render of the years select (to avoid flashes on Firefox) 
		if( inst.yearshtml ){
			var origyearshtml = inst.yearshtml;
			setTimeout(function(){
				//assure that inst.yearshtml didn't change.
				if( origyearshtml === inst.yearshtml && inst.yearshtml ){
					inst.dpDiv.find('select.ui-datepicker-year:first').replaceWith(inst.yearshtml);
				}
				origyearshtml = inst.yearshtml = null;
			}, 0);
		}
	},

	/* Retrieve the size of left and top borders for an element.
	   @param  elem  (jQuery object) the element of interest
	   @return  (number[2]) the left and top borders */
	_getBorders: function(elem) {
		var convert = function(value) {
			return {thin: 1, medium: 2, thick: 3}[value] || value;
		};
		return [parseFloat(convert(elem.css('border-left-width'))),
			parseFloat(convert(elem.css('border-top-width')))];
	},

	/* Check positioning to remain on screen. */
	_checkOffset: function(inst, offset, isFixed) {
		var dpWidth = inst.dpDiv.outerWidth();
		var dpHeight = inst.dpDiv.outerHeight();
		var inputWidth = inst.input ? inst.input.outerWidth() : 0;
		var inputHeight = inst.input ? inst.input.outerHeight() : 0;
		var viewWidth = document.documentElement.clientWidth + (isFixed ? 0 : $(document).scrollLeft());
		var viewHeight = document.documentElement.clientHeight + (isFixed ? 0 : $(document).scrollTop());

		offset.left -= (this._get(inst, 'isRTL') ? (dpWidth - inputWidth) : 0);
		offset.left -= (isFixed && offset.left == inst.input.offset().left) ? $(document).scrollLeft() : 0;
		offset.top -= (isFixed && offset.top == (inst.input.offset().top + inputHeight)) ? $(document).scrollTop() : 0;

		// now check if datepicker is showing outside window viewport - move to a better place if so.
		offset.left -= Math.min(offset.left, (offset.left + dpWidth > viewWidth && viewWidth > dpWidth) ?
			Math.abs(offset.left + dpWidth - viewWidth) : 0);
		offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
			Math.abs(dpHeight + inputHeight) : 0);

		return offset;
	},

	/* Find an object's position on the screen. */
	_findPos: function(obj) {
		var inst = this._getInst(obj);
		var isRTL = this._get(inst, 'isRTL');
        while (obj && (obj.type == 'hidden' || obj.nodeType != 1 || $.expr.filters.hidden(obj))) {
            obj = obj[isRTL ? 'previousSibling' : 'nextSibling'];
        }
        var position = $(obj).offset();
	    return [position.left, position.top];
	},

	/* Hide the date picker from view.
	   @param  input  element - the input field attached to the date picker */
	_hideDatepicker: function(input) {
		var inst = this._curInst;
		if (!inst || (input && inst != $.data(input, PROP_NAME)))
			return;
		if (this._datepickerShowing) {
			var showAnim = this._get(inst, 'showAnim');
			var duration = this._get(inst, 'duration');
			var postProcess = function() {
				$.datepicker._tidyDialog(inst);
			};
			if ($.effects && $.effects[showAnim])
				inst.dpDiv.hide(showAnim, $.datepicker._get(inst, 'showOptions'), duration, postProcess);
			else
				inst.dpDiv[(showAnim == 'slideDown' ? 'slideUp' :
					(showAnim == 'fadeIn' ? 'fadeOut' : 'hide'))]((showAnim ? duration : null), postProcess);
			if (!showAnim)
				postProcess();
			this._datepickerShowing = false;
			var onClose = this._get(inst, 'onClose');
			if (onClose)
				onClose.apply((inst.input ? inst.input[0] : null),
					[(inst.input ? inst.input.val() : ''), inst]);
			this._lastInput = null;
			if (this._inDialog) {
				this._dialogInput.css({ position: 'absolute', left: '0', top: '-100px' });
				if ($.blockUI) {
					$.unblockUI();
					$('body').append(this.dpDiv);
				}
			}
			this._inDialog = false;
		}
	},

	/* Tidy up after a dialog display. */
	_tidyDialog: function(inst) {
		inst.dpDiv.removeClass(this._dialogClass).unbind('.ui-datepicker-calendar');
	},

	/* Close date picker if clicked elsewhere. */
	_checkExternalClick: function(event) {
		if (!$.datepicker._curInst)
			return;

		var $target = $(event.target),
			inst = $.datepicker._getInst($target[0]);

		if ( ( ( $target[0].id != $.datepicker._mainDivId &&
				$target.parents('#' + $.datepicker._mainDivId).length == 0 &&
				!$target.hasClass($.datepicker.markerClassName) &&
				!$target.closest("." + $.datepicker._triggerClass).length &&
				$.datepicker._datepickerShowing && !($.datepicker._inDialog && $.blockUI) ) ) ||
			( $target.hasClass($.datepicker.markerClassName) && $.datepicker._curInst != inst ) )
			$.datepicker._hideDatepicker();
	},

	/* Adjust one of the date sub-fields. */
	_adjustDate: function(id, offset, period) {
		var target = $(id);
		var inst = this._getInst(target[0]);
		if (this._isDisabledDatepicker(target[0])) {
			return;
		}
		this._adjustInstDate(inst, offset +
			(period == 'M' ? this._get(inst, 'showCurrentAtPos') : 0), // undo positioning
			period);
		this._updateDatepicker(inst);
	},

	/* Action for current link. */
	_gotoToday: function(id) {
		var target = $(id);
		var inst = this._getInst(target[0]);
		if (this._get(inst, 'gotoCurrent') && inst.currentDay) {
			inst.selectedDay = inst.currentDay;
			inst.drawMonth = inst.selectedMonth = inst.currentMonth;
			inst.drawYear = inst.selectedYear = inst.currentYear;
		}
		else {
			var date = new Date();
			inst.selectedDay = date.getDate();
			inst.drawMonth = inst.selectedMonth = date.getMonth();
			inst.drawYear = inst.selectedYear = date.getFullYear();
		}
		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a new month/year. */
	_selectMonthYear: function(id, select, period) {
		var target = $(id);
		var inst = this._getInst(target[0]);
		inst['selected' + (period == 'M' ? 'Month' : 'Year')] =
		inst['draw' + (period == 'M' ? 'Month' : 'Year')] =
			parseInt(select.options[select.selectedIndex].value,10);
		this._notifyChange(inst);
		this._adjustDate(target);
	},

	/* Action for selecting a day. */
	_selectDay: function(id, month, year, td) {
		var target = $(id);
		if ($(td).hasClass(this._unselectableClass) || this._isDisabledDatepicker(target[0])) {
			return;
		}
		var inst = this._getInst(target[0]);
		inst.selectedDay = inst.currentDay = $('a', td).html();
		inst.selectedMonth = inst.currentMonth = month;
		inst.selectedYear = inst.currentYear = year;
		this._selectDate(id, this._formatDate(inst,
			inst.currentDay, inst.currentMonth, inst.currentYear));
	},

	/* Erase the input field and hide the date picker. */
	_clearDate: function(id) {
		var target = $(id);
		var inst = this._getInst(target[0]);
		this._selectDate(target, '');
	},

	/* Update the input field with the selected date. */
	_selectDate: function(id, dateStr) {
		var target = $(id);
		var inst = this._getInst(target[0]);
		dateStr = (dateStr != null ? dateStr : this._formatDate(inst));
		if (inst.input)
			inst.input.val(dateStr);
		this._updateAlternate(inst);
		var onSelect = this._get(inst, 'onSelect');
		if (onSelect)
			onSelect.apply((inst.input ? inst.input[0] : null), [dateStr, inst]);  // trigger custom callback
		else if (inst.input)
			inst.input.trigger('change'); // fire the change event
		if (inst.inline)
			this._updateDatepicker(inst);
		else {
			this._hideDatepicker();
			this._lastInput = inst.input[0];
			if (typeof(inst.input[0]) != 'object')
				inst.input.focus(); // restore focus
			this._lastInput = null;
		}
	},

	/* Update any alternate field to synchronise with the main field. */
	_updateAlternate: function(inst) {
		var altField = this._get(inst, 'altField');
		if (altField) { // update alternate field too
			var altFormat = this._get(inst, 'altFormat') || this._get(inst, 'dateFormat');
			var date = this._getDate(inst);
			var dateStr = this.formatDate(altFormat, date, this._getFormatConfig(inst));
			$(altField).each(function() { $(this).val(dateStr); });
		}
	},

	/* Set as beforeShowDay function to prevent selection of weekends.
	   @param  date  Date - the date to customise
	   @return [boolean, string] - is this date selectable?, what is its CSS class? */
	noWeekends: function(date) {
		var day = date.getDay();
		return [(day > 0 && day < 6), ''];
	},

	/* Set as calculateWeek to determine the week of the year based on the ISO 8601 definition.
	   @param  date  Date - the date to get the week for
	   @return  number - the number of the week within the year that contains this date */
	iso8601Week: function(date) {
		var checkDate = new Date(date.getTime());
		// Find Thursday of this week starting on Monday
		checkDate.setDate(checkDate.getDate() + 4 - (checkDate.getDay() || 7));
		var time = checkDate.getTime();
		checkDate.setMonth(0); // Compare with Jan 1
		checkDate.setDate(1);
		return Math.floor(Math.round((time - checkDate) / 86400000) / 7) + 1;
	},

	/* Parse a string value into a date object.
	   See formatDate below for the possible formats.

	   @param  format    string - the expected format of the date
	   @param  value     string - the date in the above format
	   @param  settings  Object - attributes include:
	                     shortYearCutoff  number - the cutoff year for determining the century (optional)
	                     dayNamesShort    string[7] - abbreviated names of the days from Sunday (optional)
	                     dayNames         string[7] - names of the days from Sunday (optional)
	                     monthNamesShort  string[12] - abbreviated names of the months (optional)
	                     monthNames       string[12] - names of the months (optional)
	   @return  Date - the extracted date value or null if value is blank */
	parseDate: function (format, value, settings) {
		if (format == null || value == null)
			throw 'Invalid arguments';
		value = (typeof value == 'object' ? value.toString() : value + '');
		if (value == '')
			return null;
		var shortYearCutoff = (settings ? settings.shortYearCutoff : null) || this._defaults.shortYearCutoff;
		shortYearCutoff = (typeof shortYearCutoff != 'string' ? shortYearCutoff :
				new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10));
		var dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort;
		var dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames;
		var monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort;
		var monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames;
		var year = -1;
		var month = -1;
		var day = -1;
		var doy = -1;
		var literal = false;
		// Check whether a format character is doubled
		var lookAhead = function(match) {
			var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) == match);
			if (matches)
				iFormat++;
			return matches;
		};
		// Extract a number from the string value
		var getNumber = function(match) {
			var isDoubled = lookAhead(match);
			var size = (match == '@' ? 14 : (match == '!' ? 20 :
				(match == 'y' && isDoubled ? 4 : (match == 'o' ? 3 : 2))));
			var digits = new RegExp('^\\d{1,' + size + '}');
			var num = value.substring(iValue).match(digits);
			if (!num)
				throw 'Missing number at position ' + iValue;
			iValue += num[0].length;
			return parseInt(num[0], 10);
		};
		// Extract a name from the string value and convert to an index
		var getName = function(match, shortNames, longNames) {
			var names = $.map(lookAhead(match) ? longNames : shortNames, function (v, k) {
				return [ [k, v] ];
			}).sort(function (a, b) {
				return -(a[1].length - b[1].length);
			});
			var index = -1;
			$.each(names, function (i, pair) {
				var name = pair[1];
				if (value.substr(iValue, name.length).toLowerCase() == name.toLowerCase()) {
					index = pair[0];
					iValue += name.length;
					return false;
				}
			});
			if (index != -1)
				return index + 1;
			else
				throw 'Unknown name at position ' + iValue;
		};
		// Confirm that a literal character matches the string value
		var checkLiteral = function() {
			if (value.charAt(iValue) != format.charAt(iFormat))
				throw 'Unexpected literal at position ' + iValue;
			iValue++;
		};
		var iValue = 0;
		for (var iFormat = 0; iFormat < format.length; iFormat++) {
			if (literal)
				if (format.charAt(iFormat) == "'" && !lookAhead("'"))
					literal = false;
				else
					checkLiteral();
			else
				switch (format.charAt(iFormat)) {
					case 'd':
						day = getNumber('d');
						break;
					case 'D':
						getName('D', dayNamesShort, dayNames);
						break;
					case 'o':
						doy = getNumber('o');
						break;
					case 'm':
						month = getNumber('m');
						break;
					case 'M':
						month = getName('M', monthNamesShort, monthNames);
						break;
					case 'y':
						year = getNumber('y');
						break;
					case '@':
						var date = new Date(getNumber('@'));
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case '!':
						var date = new Date((getNumber('!') - this._ticksTo1970) / 10000);
						year = date.getFullYear();
						month = date.getMonth() + 1;
						day = date.getDate();
						break;
					case "'":
						if (lookAhead("'"))
							checkLiteral();
						else
							literal = true;
						break;
					default:
						checkLiteral();
				}
		}
		if (iValue < value.length){
			throw "Extra/unparsed characters found in date: " + value.substring(iValue);
		}
		if (year == -1)
			year = new Date().getFullYear();
		else if (year < 100)
			year += new Date().getFullYear() - new Date().getFullYear() % 100 +
				(year <= shortYearCutoff ? 0 : -100);
		if (doy > -1) {
			month = 1;
			day = doy;
			do {
				var dim = this._getDaysInMonth(year, month - 1);
				if (day <= dim)
					break;
				month++;
				day -= dim;
			} while (true);
		}
		var date = this._daylightSavingAdjust(new Date(year, month - 1, day));
		if (date.getFullYear() != year || date.getMonth() + 1 != month || date.getDate() != day)
			throw 'Invalid date'; // E.g. 31/02/00
		return date;
	},

	/* Standard date formats. */
	ATOM: 'yy-mm-dd', // RFC 3339 (ISO 8601)
	COOKIE: 'D, dd M yy',
	ISO_8601: 'yy-mm-dd',
	RFC_822: 'D, d M y',
	RFC_850: 'DD, dd-M-y',
	RFC_1036: 'D, d M y',
	RFC_1123: 'D, d M yy',
	RFC_2822: 'D, d M yy',
	RSS: 'D, d M y', // RFC 822
	TICKS: '!',
	TIMESTAMP: '@',
	W3C: 'yy-mm-dd', // ISO 8601

	_ticksTo1970: (((1970 - 1) * 365 + Math.floor(1970 / 4) - Math.floor(1970 / 100) +
		Math.floor(1970 / 400)) * 24 * 60 * 60 * 10000000),

	/* Format a date object into a string value.
	   The format can be combinations of the following:
	   d  - day of month (no leading zero)
	   dd - day of month (two digit)
	   o  - day of year (no leading zeros)
	   oo - day of year (three digit)
	   D  - day name short
	   DD - day name long
	   m  - month of year (no leading zero)
	   mm - month of year (two digit)
	   M  - month name short
	   MM - month name long
	   y  - year (two digit)
	   yy - year (four digit)
	   @ - Unix timestamp (ms since 01/01/1970)
	   ! - Windows ticks (100ns since 01/01/0001)
	   '...' - literal text
	   '' - single quote

	   @param  format    string - the desired format of the date
	   @param  date      Date - the date value to format
	   @param  settings  Object - attributes include:
	                     dayNamesShort    string[7] - abbreviated names of the days from Sunday (optional)
	                     dayNames         string[7] - names of the days from Sunday (optional)
	                     monthNamesShort  string[12] - abbreviated names of the months (optional)
	                     monthNames       string[12] - names of the months (optional)
	   @return  string - the date in the above format */
	formatDate: function (format, date, settings) {
		if (!date)
			return '';
		var dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort;
		var dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames;
		var monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort;
		var monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames;
		// Check whether a format character is doubled
		var lookAhead = function(match) {
			var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) == match);
			if (matches)
				iFormat++;
			return matches;
		};
		// Format a number, with leading zero if necessary
		var formatNumber = function(match, value, len) {
			var num = '' + value;
			if (lookAhead(match))
				while (num.length < len)
					num = '0' + num;
			return num;
		};
		// Format a name, short or long as requested
		var formatName = function(match, value, shortNames, longNames) {
			return (lookAhead(match) ? longNames[value] : shortNames[value]);
		};
		var output = '';
		var literal = false;
		if (date)
			for (var iFormat = 0; iFormat < format.length; iFormat++) {
				if (literal)
					if (format.charAt(iFormat) == "'" && !lookAhead("'"))
						literal = false;
					else
						output += format.charAt(iFormat);
				else
					switch (format.charAt(iFormat)) {
						case 'd':
							output += formatNumber('d', date.getDate(), 2);
							break;
						case 'D':
							output += formatName('D', date.getDay(), dayNamesShort, dayNames);
							break;
						case 'o':
							output += formatNumber('o',
								Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 86400000), 3);
							break;
						case 'm':
							output += formatNumber('m', date.getMonth() + 1, 2);
							break;
						case 'M':
							output += formatName('M', date.getMonth(), monthNamesShort, monthNames);
							break;
						case 'y':
							output += (lookAhead('y') ? date.getFullYear() :
								(date.getYear() % 100 < 10 ? '0' : '') + date.getYear() % 100);
							break;
						case '@':
							output += date.getTime();
							break;
						case '!':
							output += date.getTime() * 10000 + this._ticksTo1970;
							break;
						case "'":
							if (lookAhead("'"))
								output += "'";
							else
								literal = true;
							break;
						default:
							output += format.charAt(iFormat);
					}
			}
		return output;
	},

	/* Extract all possible characters from the date format. */
	_possibleChars: function (format) {
		var chars = '';
		var literal = false;
		// Check whether a format character is doubled
		var lookAhead = function(match) {
			var matches = (iFormat + 1 < format.length && format.charAt(iFormat + 1) == match);
			if (matches)
				iFormat++;
			return matches;
		};
		for (var iFormat = 0; iFormat < format.length; iFormat++)
			if (literal)
				if (format.charAt(iFormat) == "'" && !lookAhead("'"))
					literal = false;
				else
					chars += format.charAt(iFormat);
			else
				switch (format.charAt(iFormat)) {
					case 'd': case 'm': case 'y': case '@':
						chars += '0123456789';
						break;
					case 'D': case 'M':
						return null; // Accept anything
					case "'":
						if (lookAhead("'"))
							chars += "'";
						else
							literal = true;
						break;
					default:
						chars += format.charAt(iFormat);
				}
		return chars;
	},

	/* Get a setting value, defaulting if necessary. */
	_get: function(inst, name) {
		return inst.settings[name] !== undefined ?
			inst.settings[name] : this._defaults[name];
	},

	/* Parse existing date and initialise date picker. */
	_setDateFromField: function(inst, noDefault) {
		if (inst.input.val() == inst.lastVal) {
			return;
		}
		var dateFormat = this._get(inst, 'dateFormat');
		var dates = inst.lastVal = inst.input ? inst.input.val() : null;
		var date, defaultDate;
		date = defaultDate = this._getDefaultDate(inst);
		var settings = this._getFormatConfig(inst);
		try {
			date = this.parseDate(dateFormat, dates, settings) || defaultDate;
		} catch (event) {
			this.log(event);
			dates = (noDefault ? '' : dates);
		}
		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		inst.currentDay = (dates ? date.getDate() : 0);
		inst.currentMonth = (dates ? date.getMonth() : 0);
		inst.currentYear = (dates ? date.getFullYear() : 0);
		this._adjustInstDate(inst);
	},

	/* Retrieve the default date shown on opening. */
	_getDefaultDate: function(inst) {
		return this._restrictMinMax(inst,
			this._determineDate(inst, this._get(inst, 'defaultDate'), new Date()));
	},

	/* A date may be specified as an exact value or a relative one. */
	_determineDate: function(inst, date, defaultDate) {
		var offsetNumeric = function(offset) {
			var date = new Date();
			date.setDate(date.getDate() + offset);
			return date;
		};
		var offsetString = function(offset) {
			try {
				return $.datepicker.parseDate($.datepicker._get(inst, 'dateFormat'),
					offset, $.datepicker._getFormatConfig(inst));
			}
			catch (e) {
				// Ignore
			}
			var date = (offset.toLowerCase().match(/^c/) ?
				$.datepicker._getDate(inst) : null) || new Date();
			var year = date.getFullYear();
			var month = date.getMonth();
			var day = date.getDate();
			var pattern = /([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g;
			var matches = pattern.exec(offset);
			while (matches) {
				switch (matches[2] || 'd') {
					case 'd' : case 'D' :
						day += parseInt(matches[1],10); break;
					case 'w' : case 'W' :
						day += parseInt(matches[1],10) * 7; break;
					case 'm' : case 'M' :
						month += parseInt(matches[1],10);
						day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
						break;
					case 'y': case 'Y' :
						year += parseInt(matches[1],10);
						day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
						break;
				}
				matches = pattern.exec(offset);
			}
			return new Date(year, month, day);
		};
		var newDate = (date == null || date === '' ? defaultDate : (typeof date == 'string' ? offsetString(date) :
			(typeof date == 'number' ? (isNaN(date) ? defaultDate : offsetNumeric(date)) : new Date(date.getTime()))));
		newDate = (newDate && newDate.toString() == 'Invalid Date' ? defaultDate : newDate);
		if (newDate) {
			newDate.setHours(0);
			newDate.setMinutes(0);
			newDate.setSeconds(0);
			newDate.setMilliseconds(0);
		}
		return this._daylightSavingAdjust(newDate);
	},

	/* Handle switch to/from daylight saving.
	   Hours may be non-zero on daylight saving cut-over:
	   > 12 when midnight changeover, but then cannot generate
	   midnight datetime, so jump to 1AM, otherwise reset.
	   @param  date  (Date) the date to check
	   @return  (Date) the corrected date */
	_daylightSavingAdjust: function(date) {
		if (!date) return null;
		date.setHours(date.getHours() > 12 ? date.getHours() + 2 : 0);
		return date;
	},

	/* Set the date(s) directly. */
	_setDate: function(inst, date, noChange) {
		var clear = !date;
		var origMonth = inst.selectedMonth;
		var origYear = inst.selectedYear;
		var newDate = this._restrictMinMax(inst, this._determineDate(inst, date, new Date()));
		inst.selectedDay = inst.currentDay = newDate.getDate();
		inst.drawMonth = inst.selectedMonth = inst.currentMonth = newDate.getMonth();
		inst.drawYear = inst.selectedYear = inst.currentYear = newDate.getFullYear();
		if ((origMonth != inst.selectedMonth || origYear != inst.selectedYear) && !noChange)
			this._notifyChange(inst);
		this._adjustInstDate(inst);
		if (inst.input) {
			inst.input.val(clear ? '' : this._formatDate(inst));
		}
	},

	/* Retrieve the date(s) directly. */
	_getDate: function(inst) {
		var startDate = (!inst.currentYear || (inst.input && inst.input.val() == '') ? null :
			this._daylightSavingAdjust(new Date(
			inst.currentYear, inst.currentMonth, inst.currentDay)));
			return startDate;
	},

	/* Attach the onxxx handlers.  These are declared statically so
	 * they work with static code transformers like Caja.
	 */
	_attachHandlers: function(inst) {
		var stepMonths = this._get(inst, 'stepMonths');
		var id = '#' + inst.id;
		inst.dpDiv.find('[data-handler]').map(function () {
			var handler = {
				prev: function () {
					window['DP_jQuery_' + dpuuid].datepicker._adjustDate(id, -stepMonths, 'M');
				},
				next: function () {
					window['DP_jQuery_' + dpuuid].datepicker._adjustDate(id, +stepMonths, 'M');
				},
				hide: function () {
					window['DP_jQuery_' + dpuuid].datepicker._hideDatepicker();
				},
				today: function () {
					window['DP_jQuery_' + dpuuid].datepicker._gotoToday(id);
				},
				selectDay: function () {
					window['DP_jQuery_' + dpuuid].datepicker._selectDay(id, +this.getAttribute('data-month'), +this.getAttribute('data-year'), this);
					return false;
				},
				selectMonth: function () {
					window['DP_jQuery_' + dpuuid].datepicker._selectMonthYear(id, this, 'M');
					return false;
				},
				selectYear: function () {
					window['DP_jQuery_' + dpuuid].datepicker._selectMonthYear(id, this, 'Y');
					return false;
				}
			};
			$(this).bind(this.getAttribute('data-event'), handler[this.getAttribute('data-handler')]);
		});
	},
	
	/* Generate the HTML for the current state of the date picker. */
	_generateHTML: function(inst) {
		var today = new Date();
		today = this._daylightSavingAdjust(
			new Date(today.getFullYear(), today.getMonth(), today.getDate())); // clear time
		var isRTL = this._get(inst, 'isRTL');
		var showButtonPanel = this._get(inst, 'showButtonPanel');
		var hideIfNoPrevNext = this._get(inst, 'hideIfNoPrevNext');
		var navigationAsDateFormat = this._get(inst, 'navigationAsDateFormat');
		var numMonths = this._getNumberOfMonths(inst);
		var showCurrentAtPos = this._get(inst, 'showCurrentAtPos');
		var stepMonths = this._get(inst, 'stepMonths');
		var isMultiMonth = (numMonths[0] != 1 || numMonths[1] != 1);
		var currentDate = this._daylightSavingAdjust((!inst.currentDay ? new Date(9999, 9, 9) :
			new Date(inst.currentYear, inst.currentMonth, inst.currentDay)));
		var minDate = this._getMinMaxDate(inst, 'min');
		var maxDate = this._getMinMaxDate(inst, 'max');
		var drawMonth = inst.drawMonth - showCurrentAtPos;
		var drawYear = inst.drawYear;
		if (drawMonth < 0) {
			drawMonth += 12;
			drawYear--;
		}
		if (maxDate) {
			var maxDraw = this._daylightSavingAdjust(new Date(maxDate.getFullYear(),
				maxDate.getMonth() - (numMonths[0] * numMonths[1]) + 1, maxDate.getDate()));
			maxDraw = (minDate && maxDraw < minDate ? minDate : maxDraw);
			while (this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1)) > maxDraw) {
				drawMonth--;
				if (drawMonth < 0) {
					drawMonth = 11;
					drawYear--;
				}
			}
		}
		inst.drawMonth = drawMonth;
		inst.drawYear = drawYear;
		var prevText = this._get(inst, 'prevText');
		prevText = (!navigationAsDateFormat ? prevText : this.formatDate(prevText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth - stepMonths, 1)),
			this._getFormatConfig(inst)));
		var prev = (this._canAdjustMonth(inst, -1, drawYear, drawMonth) ?
			'<a class="ui-datepicker-prev ui-corner-all" data-handler="prev" data-event="click"' +
			' title="' + prevText + '"><span class="ui-icon ui-icon-circle-triangle-' + ( isRTL ? 'e' : 'w') + '">' + prevText + '</span></a>' :
			(hideIfNoPrevNext ? '' : '<a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'+ prevText +'"><span class="ui-icon ui-icon-circle-triangle-' + ( isRTL ? 'e' : 'w') + '">' + prevText + '</span></a>'));
		var nextText = this._get(inst, 'nextText');
		nextText = (!navigationAsDateFormat ? nextText : this.formatDate(nextText,
			this._daylightSavingAdjust(new Date(drawYear, drawMonth + stepMonths, 1)),
			this._getFormatConfig(inst)));
		var next = (this._canAdjustMonth(inst, +1, drawYear, drawMonth) ?
			'<a class="ui-datepicker-next ui-corner-all" data-handler="next" data-event="click"' +
			' title="' + nextText + '"><span class="ui-icon ui-icon-circle-triangle-' + ( isRTL ? 'w' : 'e') + '">' + nextText + '</span></a>' :
			(hideIfNoPrevNext ? '' : '<a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'+ nextText + '"><span class="ui-icon ui-icon-circle-triangle-' + ( isRTL ? 'w' : 'e') + '">' + nextText + '</span></a>'));
		var currentText = this._get(inst, 'currentText');
		var gotoDate = (this._get(inst, 'gotoCurrent') && inst.currentDay ? currentDate : today);
		currentText = (!navigationAsDateFormat ? currentText :
			this.formatDate(currentText, gotoDate, this._getFormatConfig(inst)));
		var controls = (!inst.inline ? '<button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" data-handler="hide" data-event="click">' +
			this._get(inst, 'closeText') + '</button>' : '');
		var buttonPanel = (showButtonPanel) ? '<div class="ui-datepicker-buttonpane ui-widget-content">' + (isRTL ? controls : '') +
			(this._isInRange(inst, gotoDate) ? '<button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" data-handler="today" data-event="click"' +
			'>' + currentText + '</button>' : '') + (isRTL ? '' : controls) + '</div>' : '';
		var firstDay = parseInt(this._get(inst, 'firstDay'),10);
		firstDay = (isNaN(firstDay) ? 0 : firstDay);
		var showWeek = this._get(inst, 'showWeek');
		var dayNames = this._get(inst, 'dayNames');
		var dayNamesShort = this._get(inst, 'dayNamesShort');
		var dayNamesMin = this._get(inst, 'dayNamesMin');
		var monthNames = this._get(inst, 'monthNames');
		var monthNamesShort = this._get(inst, 'monthNamesShort');
		var beforeShowDay = this._get(inst, 'beforeShowDay');
		var showOtherMonths = this._get(inst, 'showOtherMonths');
		var selectOtherMonths = this._get(inst, 'selectOtherMonths');
		var calculateWeek = this._get(inst, 'calculateWeek') || this.iso8601Week;
		var defaultDate = this._getDefaultDate(inst);
		var html = '';
		for (var row = 0; row < numMonths[0]; row++) {
			var group = '';
			this.maxRows = 4;
			for (var col = 0; col < numMonths[1]; col++) {
				var selectedDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, inst.selectedDay));
				var cornerClass = ' ui-corner-all';
				var calender = '';
				if (isMultiMonth) {
					calender += '<div class="ui-datepicker-group';
					if (numMonths[1] > 1)
						switch (col) {
							case 0: calender += ' ui-datepicker-group-first';
								cornerClass = ' ui-corner-' + (isRTL ? 'right' : 'left'); break;
							case numMonths[1]-1: calender += ' ui-datepicker-group-last';
								cornerClass = ' ui-corner-' + (isRTL ? 'left' : 'right'); break;
							default: calender += ' ui-datepicker-group-middle'; cornerClass = ''; break;
						}
					calender += '">';
				}
				calender += '<div class="ui-datepicker-header ui-widget-header ui-helper-clearfix' + cornerClass + '">' +
					(/all|left/.test(cornerClass) && row == 0 ? (isRTL ? next : prev) : '') +
					(/all|right/.test(cornerClass) && row == 0 ? (isRTL ? prev : next) : '') +
					this._generateMonthYearHeader(inst, drawMonth, drawYear, minDate, maxDate,
					row > 0 || col > 0, monthNames, monthNamesShort) + // draw month headers
					'</div><table class="ui-datepicker-calendar"><thead>' +
					'<tr>';
				var thead = (showWeek ? '<th class="ui-datepicker-week-col">' + this._get(inst, 'weekHeader') + '</th>' : '');
				for (var dow = 0; dow < 7; dow++) { // days of the week
					var day = (dow + firstDay) % 7;
					thead += '<th' + ((dow + firstDay + 6) % 7 >= 5 ? ' class="ui-datepicker-week-end"' : '') + '>' +
						'<span title="' + dayNames[day] + '">' + dayNamesMin[day] + '</span></th>';
				}
				calender += thead + '</tr></thead><tbody>';
				var daysInMonth = this._getDaysInMonth(drawYear, drawMonth);
				if (drawYear == inst.selectedYear && drawMonth == inst.selectedMonth)
					inst.selectedDay = Math.min(inst.selectedDay, daysInMonth);
				var leadDays = (this._getFirstDayOfMonth(drawYear, drawMonth) - firstDay + 7) % 7;
				var curRows = Math.ceil((leadDays + daysInMonth) / 7); // calculate the number of rows to generate
				var numRows = (isMultiMonth ? this.maxRows > curRows ? this.maxRows : curRows : curRows); //If multiple months, use the higher number of rows (see #7043)
				this.maxRows = numRows;
				var printDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1 - leadDays));
				for (var dRow = 0; dRow < numRows; dRow++) { // create date picker rows
					calender += '<tr>';
					var tbody = (!showWeek ? '' : '<td class="ui-datepicker-week-col">' +
						this._get(inst, 'calculateWeek')(printDate) + '</td>');
					for (var dow = 0; dow < 7; dow++) { // create date picker days
						var daySettings = (beforeShowDay ?
							beforeShowDay.apply((inst.input ? inst.input[0] : null), [printDate]) : [true, '']);
						var otherMonth = (printDate.getMonth() != drawMonth);
						var unselectable = (otherMonth && !selectOtherMonths) || !daySettings[0] ||
							(minDate && printDate < minDate) || (maxDate && printDate > maxDate);
						tbody += '<td class="' +
							((dow + firstDay + 6) % 7 >= 5 ? ' ui-datepicker-week-end' : '') + // highlight weekends
							(otherMonth ? ' ui-datepicker-other-month' : '') + // highlight days from other months
							((printDate.getTime() == selectedDate.getTime() && drawMonth == inst.selectedMonth && inst._keyEvent) || // user pressed key
							(defaultDate.getTime() == printDate.getTime() && defaultDate.getTime() == selectedDate.getTime()) ?
							// or defaultDate is current printedDate and defaultDate is selectedDate
							' ' + this._dayOverClass : '') + // highlight selected day
							(unselectable ? ' ' + this._unselectableClass + ' ui-state-disabled': '') +  // highlight unselectable days
							(otherMonth && !showOtherMonths ? '' : ' ' + daySettings[1] + // highlight custom dates
							(printDate.getTime() == currentDate.getTime() ? ' ' + this._currentClass : '') + // highlight selected day
							(printDate.getTime() == today.getTime() ? ' ui-datepicker-today' : '')) + '"' + // highlight today (if different)
							((!otherMonth || showOtherMonths) && daySettings[2] ? ' title="' + daySettings[2] + '"' : '') + // cell title
							(unselectable ? '' : ' data-handler="selectDay" data-event="click" data-month="' + printDate.getMonth() + '" data-year="' + printDate.getFullYear() + '"') + '>' + // actions
							(otherMonth && !showOtherMonths ? '&#xa0;' : // display for other months
							(unselectable ? '<span class="ui-state-default">' + printDate.getDate() + '</span>' : '<a class="ui-state-default' +
							(printDate.getTime() == today.getTime() ? ' ui-state-highlight' : '') +
							(printDate.getTime() == currentDate.getTime() ? ' ui-state-active' : '') + // highlight selected day
							(otherMonth ? ' ui-priority-secondary' : '') + // distinguish dates from other months
							'" href="#">' + printDate.getDate() + '</a>')) + '</td>'; // display selectable date
						printDate.setDate(printDate.getDate() + 1);
						printDate = this._daylightSavingAdjust(printDate);
					}
					calender += tbody + '</tr>';
				}
				drawMonth++;
				if (drawMonth > 11) {
					drawMonth = 0;
					drawYear++;
				}
				calender += '</tbody></table>' + (isMultiMonth ? '</div>' + 
							((numMonths[0] > 0 && col == numMonths[1]-1) ? '<div class="ui-datepicker-row-break"></div>' : '') : '');
				group += calender;
			}
			html += group;
		}
		html += buttonPanel + ($.browser.msie && parseInt($.browser.version,10) < 7 && !inst.inline ?
			'<iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"></iframe>' : '');
		inst._keyEvent = false;
		return html;
	},

	/* Generate the month and year header. */
	_generateMonthYearHeader: function(inst, drawMonth, drawYear, minDate, maxDate,
			secondary, monthNames, monthNamesShort) {
		var changeMonth = this._get(inst, 'changeMonth');
		var changeYear = this._get(inst, 'changeYear');
		var showMonthAfterYear = this._get(inst, 'showMonthAfterYear');
		var html = '<div class="ui-datepicker-title">';
		var monthHtml = '';
		// month selection
		if (secondary || !changeMonth)
			monthHtml += '<span class="ui-datepicker-month">' + monthNames[drawMonth] + '</span>';
		else {
			var inMinYear = (minDate && minDate.getFullYear() == drawYear);
			var inMaxYear = (maxDate && maxDate.getFullYear() == drawYear);
			monthHtml += '<select class="ui-datepicker-month" data-handler="selectMonth" data-event="change">';
			for (var month = 0; month < 12; month++) {
				if ((!inMinYear || month >= minDate.getMonth()) &&
						(!inMaxYear || month <= maxDate.getMonth()))
					monthHtml += '<option value="' + month + '"' +
						(month == drawMonth ? ' selected="selected"' : '') +
						'>' + monthNamesShort[month] + '</option>';
			}
			monthHtml += '</select>';
		}
		if (!showMonthAfterYear)
			html += monthHtml + (secondary || !(changeMonth && changeYear) ? '&#xa0;' : '');
		// year selection
		if ( !inst.yearshtml ) {
			inst.yearshtml = '';
			if (secondary || !changeYear)
				html += '<span class="ui-datepicker-year">' + drawYear + '</span>';
			else {
				// determine range of years to display
				var years = this._get(inst, 'yearRange').split(':');
				var thisYear = new Date().getFullYear();
				var determineYear = function(value) {
					var year = (value.match(/c[+-].*/) ? drawYear + parseInt(value.substring(1), 10) :
						(value.match(/[+-].*/) ? thisYear + parseInt(value, 10) :
						parseInt(value, 10)));
					return (isNaN(year) ? thisYear : year);
				};
				var year = determineYear(years[0]);
				var endYear = Math.max(year, determineYear(years[1] || ''));
				year = (minDate ? Math.max(year, minDate.getFullYear()) : year);
				endYear = (maxDate ? Math.min(endYear, maxDate.getFullYear()) : endYear);
				inst.yearshtml += '<select class="ui-datepicker-year" data-handler="selectYear" data-event="change">';
				for (; year <= endYear; year++) {
					inst.yearshtml += '<option value="' + year + '"' +
						(year == drawYear ? ' selected="selected"' : '') +
						'>' + year + '</option>';
				}
				inst.yearshtml += '</select>';
				
				html += inst.yearshtml;
				inst.yearshtml = null;
			}
		}
		html += this._get(inst, 'yearSuffix');
		if (showMonthAfterYear)
			html += (secondary || !(changeMonth && changeYear) ? '&#xa0;' : '') + monthHtml;
		html += '</div>'; // Close datepicker_header
		return html;
	},

	/* Adjust one of the date sub-fields. */
	_adjustInstDate: function(inst, offset, period) {
		var year = inst.drawYear + (period == 'Y' ? offset : 0);
		var month = inst.drawMonth + (period == 'M' ? offset : 0);
		var day = Math.min(inst.selectedDay, this._getDaysInMonth(year, month)) +
			(period == 'D' ? offset : 0);
		var date = this._restrictMinMax(inst,
			this._daylightSavingAdjust(new Date(year, month, day)));
		inst.selectedDay = date.getDate();
		inst.drawMonth = inst.selectedMonth = date.getMonth();
		inst.drawYear = inst.selectedYear = date.getFullYear();
		if (period == 'M' || period == 'Y')
			this._notifyChange(inst);
	},

	/* Ensure a date is within any min/max bounds. */
	_restrictMinMax: function(inst, date) {
		var minDate = this._getMinMaxDate(inst, 'min');
		var maxDate = this._getMinMaxDate(inst, 'max');
		var newDate = (minDate && date < minDate ? minDate : date);
		newDate = (maxDate && newDate > maxDate ? maxDate : newDate);
		return newDate;
	},

	/* Notify change of month/year. */
	_notifyChange: function(inst) {
		var onChange = this._get(inst, 'onChangeMonthYear');
		if (onChange)
			onChange.apply((inst.input ? inst.input[0] : null),
				[inst.selectedYear, inst.selectedMonth + 1, inst]);
	},

	/* Determine the number of months to show. */
	_getNumberOfMonths: function(inst) {
		var numMonths = this._get(inst, 'numberOfMonths');
		return (numMonths == null ? [1, 1] : (typeof numMonths == 'number' ? [1, numMonths] : numMonths));
	},

	/* Determine the current maximum date - ensure no time components are set. */
	_getMinMaxDate: function(inst, minMax) {
		return this._determineDate(inst, this._get(inst, minMax + 'Date'), null);
	},

	/* Find the number of days in a given month. */
	_getDaysInMonth: function(year, month) {
		return 32 - this._daylightSavingAdjust(new Date(year, month, 32)).getDate();
	},

	/* Find the day of the week of the first of a month. */
	_getFirstDayOfMonth: function(year, month) {
		return new Date(year, month, 1).getDay();
	},

	/* Determines if we should allow a "next/prev" month display change. */
	_canAdjustMonth: function(inst, offset, curYear, curMonth) {
		var numMonths = this._getNumberOfMonths(inst);
		var date = this._daylightSavingAdjust(new Date(curYear,
			curMonth + (offset < 0 ? offset : numMonths[0] * numMonths[1]), 1));
		if (offset < 0)
			date.setDate(this._getDaysInMonth(date.getFullYear(), date.getMonth()));
		return this._isInRange(inst, date);
	},

	/* Is the given date in the accepted range? */
	_isInRange: function(inst, date) {
		var minDate = this._getMinMaxDate(inst, 'min');
		var maxDate = this._getMinMaxDate(inst, 'max');
		return ((!minDate || date.getTime() >= minDate.getTime()) &&
			(!maxDate || date.getTime() <= maxDate.getTime()));
	},

	/* Provide the configuration settings for formatting/parsing. */
	_getFormatConfig: function(inst) {
		var shortYearCutoff = this._get(inst, 'shortYearCutoff');
		shortYearCutoff = (typeof shortYearCutoff != 'string' ? shortYearCutoff :
			new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10));
		return {shortYearCutoff: shortYearCutoff,
			dayNamesShort: this._get(inst, 'dayNamesShort'), dayNames: this._get(inst, 'dayNames'),
			monthNamesShort: this._get(inst, 'monthNamesShort'), monthNames: this._get(inst, 'monthNames')};
	},

	/* Format the given date for display. */
	_formatDate: function(inst, day, month, year) {
		if (!day) {
			inst.currentDay = inst.selectedDay;
			inst.currentMonth = inst.selectedMonth;
			inst.currentYear = inst.selectedYear;
		}
		var date = (day ? (typeof day == 'object' ? day :
			this._daylightSavingAdjust(new Date(year, month, day))) :
			this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay)));
		return this.formatDate(this._get(inst, 'dateFormat'), date, this._getFormatConfig(inst));
	}
});

/*
 * Bind hover events for datepicker elements.
 * Done via delegate so the binding only occurs once in the lifetime of the parent div.
 * Global instActive, set by _updateDatepicker allows the handlers to find their way back to the active picker.
 */ 
function bindHover(dpDiv) {
	var selector = 'button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a';
	return dpDiv.bind('mouseout', function(event) {
			var elem = $( event.target ).closest( selector );
			if ( !elem.length ) {
				return;
			}
			elem.removeClass( "ui-state-hover ui-datepicker-prev-hover ui-datepicker-next-hover" );
		})
		.bind('mouseover', function(event) {
			var elem = $( event.target ).closest( selector );
			if ($.datepicker._isDisabledDatepicker( instActive.inline ? dpDiv.parent()[0] : instActive.input[0]) ||
					!elem.length ) {
				return;
			}
			elem.parents('.ui-datepicker-calendar').find('a').removeClass('ui-state-hover');
			elem.addClass('ui-state-hover');
			if (elem.hasClass('ui-datepicker-prev')) elem.addClass('ui-datepicker-prev-hover');
			if (elem.hasClass('ui-datepicker-next')) elem.addClass('ui-datepicker-next-hover');
		});
}

/* jQuery extend now ignores nulls! */
function extendRemove(target, props) {
	$.extend(target, props);
	for (var name in props)
		if (props[name] == null || props[name] == undefined)
			target[name] = props[name];
	return target;
};

/* Determine whether an object is an array. */
function isArray(a) {
	return (a && (($.browser.safari && typeof a == 'object' && a.length) ||
		(a.constructor && a.constructor.toString().match(/\Array\(\)/))));
};

/* Invoke the datepicker functionality.
   @param  options  string - a command, optionally followed by additional parameters or
                    Object - settings for attaching new datepicker functionality
   @return  jQuery object */
$.fn.datepicker = function(options){
	
	/* Verify an empty collection wasn't passed - Fixes #6976 */
	if ( !this.length ) {
		return this;
	}
	
	/* Initialise the date picker. */
	if (!$.datepicker.initialized) {
		$(document).mousedown($.datepicker._checkExternalClick).
			find('body').append($.datepicker.dpDiv);
		$.datepicker.initialized = true;
	}

	var otherArgs = Array.prototype.slice.call(arguments, 1);
	if (typeof options == 'string' && (options == 'isDisabled' || options == 'getDate' || options == 'widget'))
		return $.datepicker['_' + options + 'Datepicker'].
			apply($.datepicker, [this[0]].concat(otherArgs));
	if (options == 'option' && arguments.length == 2 && typeof arguments[1] == 'string')
		return $.datepicker['_' + options + 'Datepicker'].
			apply($.datepicker, [this[0]].concat(otherArgs));
	return this.each(function() {
		typeof options == 'string' ?
			$.datepicker['_' + options + 'Datepicker'].
				apply($.datepicker, [this].concat(otherArgs)) :
			$.datepicker._attachDatepicker(this, options);
	});
};

$.datepicker = new Datepicker(); // singleton instance
$.datepicker.initialized = false;
$.datepicker.uuid = new Date().getTime();
$.datepicker.version = "1.8.22";

// Workaround for #4055
// Add another global to avoid noConflict issues with inline event handlers
window['DP_jQuery_' + dpuuid] = $;

})(jQuery);
/*!
 * jQuery UI Progressbar 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Progressbar
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 */
(function( $, undefined ) {

$.widget( "ui.progressbar", {
	options: {
		value: 0,
		max: 100
	},

	min: 0,

	_create: function() {
		this.element
			.addClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.attr({
				role: "progressbar",
				"aria-valuemin": this.min,
				"aria-valuemax": this.options.max,
				"aria-valuenow": this._value()
			});

		this.valueDiv = $( "<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>" )
			.appendTo( this.element );

		this.oldValue = this._value();
		this._refreshValue();
	},

	destroy: function() {
		this.element
			.removeClass( "ui-progressbar ui-widget ui-widget-content ui-corner-all" )
			.removeAttr( "role" )
			.removeAttr( "aria-valuemin" )
			.removeAttr( "aria-valuemax" )
			.removeAttr( "aria-valuenow" );

		this.valueDiv.remove();

		$.Widget.prototype.destroy.apply( this, arguments );
	},

	value: function( newValue ) {
		if ( newValue === undefined ) {
			return this._value();
		}

		this._setOption( "value", newValue );
		return this;
	},

	_setOption: function( key, value ) {
		if ( key === "value" ) {
			this.options.value = value;
			this._refreshValue();
			if ( this._value() === this.options.max ) {
				this._trigger( "complete" );
			}
		}

		$.Widget.prototype._setOption.apply( this, arguments );
	},

	_value: function() {
		var val = this.options.value;
		// normalize invalid value
		if ( typeof val !== "number" ) {
			val = 0;
		}
		return Math.min( this.options.max, Math.max( this.min, val ) );
	},

	_percentage: function() {
		return 100 * this._value() / this.options.max;
	},

	_refreshValue: function() {
		var value = this.value();
		var percentage = this._percentage();

		if ( this.oldValue !== value ) {
			this.oldValue = value;
			this._trigger( "change" );
		}

		this.valueDiv
			.toggle( value > this.min )
			.toggleClass( "ui-corner-right", value === this.options.max )
			.width( percentage.toFixed(0) + "%" );
		this.element.attr( "aria-valuenow", value );
	}
});

$.extend( $.ui.progressbar, {
	version: "1.8.22"
});

})( jQuery );
/*!
 * jQuery UI Effects 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/
 */
;jQuery.effects || (function($, undefined) {

$.effects = {};



/******************************************************************************/
/****************************** COLOR ANIMATIONS ******************************/
/******************************************************************************/

// override the animation for color styles
$.each(['backgroundColor', 'borderBottomColor', 'borderLeftColor',
	'borderRightColor', 'borderTopColor', 'borderColor', 'color', 'outlineColor'],
function(i, attr) {
	$.fx.step[attr] = function(fx) {
		if (!fx.colorInit) {
			fx.start = getColor(fx.elem, attr);
			fx.end = getRGB(fx.end);
			fx.colorInit = true;
		}

		fx.elem.style[attr] = 'rgb(' +
			Math.max(Math.min(parseInt((fx.pos * (fx.end[0] - fx.start[0])) + fx.start[0], 10), 255), 0) + ',' +
			Math.max(Math.min(parseInt((fx.pos * (fx.end[1] - fx.start[1])) + fx.start[1], 10), 255), 0) + ',' +
			Math.max(Math.min(parseInt((fx.pos * (fx.end[2] - fx.start[2])) + fx.start[2], 10), 255), 0) + ')';
	};
});

// Color Conversion functions from highlightFade
// By Blair Mitchelmore
// http://jquery.offput.ca/highlightFade/

// Parse strings looking for color tuples [255,255,255]
function getRGB(color) {
		var result;

		// Check if we're already dealing with an array of colors
		if ( color && color.constructor == Array && color.length == 3 )
				return color;

		// Look for rgb(num,num,num)
		if (result = /rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(color))
				return [parseInt(result[1],10), parseInt(result[2],10), parseInt(result[3],10)];

		// Look for rgb(num%,num%,num%)
		if (result = /rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(color))
				return [parseFloat(result[1])*2.55, parseFloat(result[2])*2.55, parseFloat(result[3])*2.55];

		// Look for #a0b1c2
		if (result = /#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(color))
				return [parseInt(result[1],16), parseInt(result[2],16), parseInt(result[3],16)];

		// Look for #fff
		if (result = /#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(color))
				return [parseInt(result[1]+result[1],16), parseInt(result[2]+result[2],16), parseInt(result[3]+result[3],16)];

		// Look for rgba(0, 0, 0, 0) == transparent in Safari 3
		if (result = /rgba\(0, 0, 0, 0\)/.exec(color))
				return colors['transparent'];

		// Otherwise, we're most likely dealing with a named color
		return colors[$.trim(color).toLowerCase()];
}

function getColor(elem, attr) {
		var color;

		do {
				// jQuery <1.4.3 uses curCSS, in 1.4.3 - 1.7.2 curCSS = css, 1.8+ only has css
				color = ($.curCSS || $.css)(elem, attr);

				// Keep going until we find an element that has color, or we hit the body
				if ( color != '' && color != 'transparent' || $.nodeName(elem, "body") )
						break;

				attr = "backgroundColor";
		} while ( elem = elem.parentNode );

		return getRGB(color);
};

// Some named colors to work with
// From Interface by Stefan Petre
// http://interface.eyecon.ro/

var colors = {
	aqua:[0,255,255],
	azure:[240,255,255],
	beige:[245,245,220],
	black:[0,0,0],
	blue:[0,0,255],
	brown:[165,42,42],
	cyan:[0,255,255],
	darkblue:[0,0,139],
	darkcyan:[0,139,139],
	darkgrey:[169,169,169],
	darkgreen:[0,100,0],
	darkkhaki:[189,183,107],
	darkmagenta:[139,0,139],
	darkolivegreen:[85,107,47],
	darkorange:[255,140,0],
	darkorchid:[153,50,204],
	darkred:[139,0,0],
	darksalmon:[233,150,122],
	darkviolet:[148,0,211],
	fuchsia:[255,0,255],
	gold:[255,215,0],
	green:[0,128,0],
	indigo:[75,0,130],
	khaki:[240,230,140],
	lightblue:[173,216,230],
	lightcyan:[224,255,255],
	lightgreen:[144,238,144],
	lightgrey:[211,211,211],
	lightpink:[255,182,193],
	lightyellow:[255,255,224],
	lime:[0,255,0],
	magenta:[255,0,255],
	maroon:[128,0,0],
	navy:[0,0,128],
	olive:[128,128,0],
	orange:[255,165,0],
	pink:[255,192,203],
	purple:[128,0,128],
	violet:[128,0,128],
	red:[255,0,0],
	silver:[192,192,192],
	white:[255,255,255],
	yellow:[255,255,0],
	transparent: [255,255,255]
};



/******************************************************************************/
/****************************** CLASS ANIMATIONS ******************************/
/******************************************************************************/

var classAnimationActions = ['add', 'remove', 'toggle'],
	shorthandStyles = {
		border: 1,
		borderBottom: 1,
		borderColor: 1,
		borderLeft: 1,
		borderRight: 1,
		borderTop: 1,
		borderWidth: 1,
		margin: 1,
		padding: 1
	};

function getElementStyles() {
	var style = document.defaultView
			? document.defaultView.getComputedStyle(this, null)
			: this.currentStyle,
		newStyle = {},
		key,
		camelCase;

	// webkit enumerates style porperties
	if (style && style.length && style[0] && style[style[0]]) {
		var len = style.length;
		while (len--) {
			key = style[len];
			if (typeof style[key] == 'string') {
				camelCase = key.replace(/\-(\w)/g, function(all, letter){
					return letter.toUpperCase();
				});
				newStyle[camelCase] = style[key];
			}
		}
	} else {
		for (key in style) {
			if (typeof style[key] === 'string') {
				newStyle[key] = style[key];
			}
		}
	}
	
	return newStyle;
}

function filterStyles(styles) {
	var name, value;
	for (name in styles) {
		value = styles[name];
		if (
			// ignore null and undefined values
			value == null ||
			// ignore functions (when does this occur?)
			$.isFunction(value) ||
			// shorthand styles that need to be expanded
			name in shorthandStyles ||
			// ignore scrollbars (break in IE)
			(/scrollbar/).test(name) ||

			// only colors or values that can be converted to numbers
			(!(/color/i).test(name) && isNaN(parseFloat(value)))
		) {
			delete styles[name];
		}
	}
	
	return styles;
}

function styleDifference(oldStyle, newStyle) {
	var diff = { _: 0 }, // http://dev.jquery.com/ticket/5459
		name;

	for (name in newStyle) {
		if (oldStyle[name] != newStyle[name]) {
			diff[name] = newStyle[name];
		}
	}

	return diff;
}

$.effects.animateClass = function(value, duration, easing, callback) {
	if ($.isFunction(easing)) {
		callback = easing;
		easing = null;
	}

	return this.queue(function() {
		var that = $(this),
			originalStyleAttr = that.attr('style') || ' ',
			originalStyle = filterStyles(getElementStyles.call(this)),
			newStyle,
			className = that.attr('class') || "";

		$.each(classAnimationActions, function(i, action) {
			if (value[action]) {
				that[action + 'Class'](value[action]);
			}
		});
		newStyle = filterStyles(getElementStyles.call(this));
		that.attr('class', className);

		that.animate(styleDifference(originalStyle, newStyle), {
			queue: false,
			duration: duration,
			easing: easing,
			complete: function() {
				$.each(classAnimationActions, function(i, action) {
					if (value[action]) { that[action + 'Class'](value[action]); }
				});
				// work around bug in IE by clearing the cssText before setting it
				if (typeof that.attr('style') == 'object') {
					that.attr('style').cssText = '';
					that.attr('style').cssText = originalStyleAttr;
				} else {
					that.attr('style', originalStyleAttr);
				}
				if (callback) { callback.apply(this, arguments); }
				$.dequeue( this );
			}
		});
	});
};

$.fn.extend({
	_addClass: $.fn.addClass,
	addClass: function(classNames, speed, easing, callback) {
		return speed ? $.effects.animateClass.apply(this, [{ add: classNames },speed,easing,callback]) : this._addClass(classNames);
	},

	_removeClass: $.fn.removeClass,
	removeClass: function(classNames,speed,easing,callback) {
		return speed ? $.effects.animateClass.apply(this, [{ remove: classNames },speed,easing,callback]) : this._removeClass(classNames);
	},

	_toggleClass: $.fn.toggleClass,
	toggleClass: function(classNames, force, speed, easing, callback) {
		if ( typeof force == "boolean" || force === undefined ) {
			if ( !speed ) {
				// without speed parameter;
				return this._toggleClass(classNames, force);
			} else {
				return $.effects.animateClass.apply(this, [(force?{add:classNames}:{remove:classNames}),speed,easing,callback]);
			}
		} else {
			// without switch parameter;
			return $.effects.animateClass.apply(this, [{ toggle: classNames },force,speed,easing]);
		}
	},

	switchClass: function(remove,add,speed,easing,callback) {
		return $.effects.animateClass.apply(this, [{ add: add, remove: remove },speed,easing,callback]);
	}
});



/******************************************************************************/
/*********************************** EFFECTS **********************************/
/******************************************************************************/

$.extend($.effects, {
	version: "1.8.22",

	// Saves a set of properties in a data storage
	save: function(element, set) {
		for(var i=0; i < set.length; i++) {
			if(set[i] !== null) element.data("ec.storage."+set[i], element[0].style[set[i]]);
		}
	},

	// Restores a set of previously saved properties from a data storage
	restore: function(element, set) {
		for(var i=0; i < set.length; i++) {
			if(set[i] !== null) element.css(set[i], element.data("ec.storage."+set[i]));
		}
	},

	setMode: function(el, mode) {
		if (mode == 'toggle') mode = el.is(':hidden') ? 'show' : 'hide'; // Set for toggle
		return mode;
	},

	getBaseline: function(origin, original) { // Translates a [top,left] array into a baseline value
		// this should be a little more flexible in the future to handle a string & hash
		var y, x;
		switch (origin[0]) {
			case 'top': y = 0; break;
			case 'middle': y = 0.5; break;
			case 'bottom': y = 1; break;
			default: y = origin[0] / original.height;
		};
		switch (origin[1]) {
			case 'left': x = 0; break;
			case 'center': x = 0.5; break;
			case 'right': x = 1; break;
			default: x = origin[1] / original.width;
		};
		return {x: x, y: y};
	},

	// Wraps the element around a wrapper that copies position properties
	createWrapper: function(element) {

		// if the element is already wrapped, return it
		if (element.parent().is('.ui-effects-wrapper')) {
			return element.parent();
		}

		// wrap the element
		var props = {
				width: element.outerWidth(true),
				height: element.outerHeight(true),
				'float': element.css('float')
			},
			wrapper = $('<div></div>')
				.addClass('ui-effects-wrapper')
				.css({
					fontSize: '100%',
					background: 'transparent',
					border: 'none',
					margin: 0,
					padding: 0
				}),
			active = document.activeElement;

		// support: Firefox
		// Firefox incorrectly exposes anonymous content
		// https://bugzilla.mozilla.org/show_bug.cgi?id=561664
		try {
			active.id;
		} catch( e ) {
			active = document.body;
		}

		element.wrap( wrapper );

		// Fixes #7595 - Elements lose focus when wrapped.
		if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
			$( active ).focus();
		}
		
		wrapper = element.parent(); //Hotfix for jQuery 1.4 since some change in wrap() seems to actually loose the reference to the wrapped element

		// transfer positioning properties to the wrapper
		if (element.css('position') == 'static') {
			wrapper.css({ position: 'relative' });
			element.css({ position: 'relative' });
		} else {
			$.extend(props, {
				position: element.css('position'),
				zIndex: element.css('z-index')
			});
			$.each(['top', 'left', 'bottom', 'right'], function(i, pos) {
				props[pos] = element.css(pos);
				if (isNaN(parseInt(props[pos], 10))) {
					props[pos] = 'auto';
				}
			});
			element.css({position: 'relative', top: 0, left: 0, right: 'auto', bottom: 'auto' });
		}

		return wrapper.css(props).show();
	},

	removeWrapper: function(element) {
		var parent,
			active = document.activeElement;
		
		if (element.parent().is('.ui-effects-wrapper')) {
			parent = element.parent().replaceWith(element);
			// Fixes #7595 - Elements lose focus when wrapped.
			if ( element[ 0 ] === active || $.contains( element[ 0 ], active ) ) {
				$( active ).focus();
			}
			return parent;
		}
			
		return element;
	},

	setTransition: function(element, list, factor, value) {
		value = value || {};
		$.each(list, function(i, x){
			var unit = element.cssUnit(x);
			if (unit[0] > 0) value[x] = unit[0] * factor + unit[1];
		});
		return value;
	}
});


function _normalizeArguments(effect, options, speed, callback) {
	// shift params for method overloading
	if (typeof effect == 'object') {
		callback = options;
		speed = null;
		options = effect;
		effect = options.effect;
	}
	if ($.isFunction(options)) {
		callback = options;
		speed = null;
		options = {};
	}
        if (typeof options == 'number' || $.fx.speeds[options]) {
		callback = speed;
		speed = options;
		options = {};
	}
	if ($.isFunction(speed)) {
		callback = speed;
		speed = null;
	}

	options = options || {};

	speed = speed || options.duration;
	speed = $.fx.off ? 0 : typeof speed == 'number'
		? speed : speed in $.fx.speeds ? $.fx.speeds[speed] : $.fx.speeds._default;

	callback = callback || options.complete;

	return [effect, options, speed, callback];
}

function standardSpeed( speed ) {
	// valid standard speeds
	if ( !speed || typeof speed === "number" || $.fx.speeds[ speed ] ) {
		return true;
	}
	
	// invalid strings - treat as "normal" speed
	if ( typeof speed === "string" && !$.effects[ speed ] ) {
		return true;
	}
	
	return false;
}

$.fn.extend({
	effect: function(effect, options, speed, callback) {
		var args = _normalizeArguments.apply(this, arguments),
			// TODO: make effects take actual parameters instead of a hash
			args2 = {
				options: args[1],
				duration: args[2],
				callback: args[3]
			},
			mode = args2.options.mode,
			effectMethod = $.effects[effect];
		
		if ( $.fx.off || !effectMethod ) {
			// delegate to the original method (e.g., .show()) if possible
			if ( mode ) {
				return this[ mode ]( args2.duration, args2.callback );
			} else {
				return this.each(function() {
					if ( args2.callback ) {
						args2.callback.call( this );
					}
				});
			}
		}
		
		return effectMethod.call(this, args2);
	},

	_show: $.fn.show,
	show: function(speed) {
		if ( standardSpeed( speed ) ) {
			return this._show.apply(this, arguments);
		} else {
			var args = _normalizeArguments.apply(this, arguments);
			args[1].mode = 'show';
			return this.effect.apply(this, args);
		}
	},

	_hide: $.fn.hide,
	hide: function(speed) {
		if ( standardSpeed( speed ) ) {
			return this._hide.apply(this, arguments);
		} else {
			var args = _normalizeArguments.apply(this, arguments);
			args[1].mode = 'hide';
			return this.effect.apply(this, args);
		}
	},

	// jQuery core overloads toggle and creates _toggle
	__toggle: $.fn.toggle,
	toggle: function(speed) {
		if ( standardSpeed( speed ) || typeof speed === "boolean" || $.isFunction( speed ) ) {
			return this.__toggle.apply(this, arguments);
		} else {
			var args = _normalizeArguments.apply(this, arguments);
			args[1].mode = 'toggle';
			return this.effect.apply(this, args);
		}
	},

	// helper functions
	cssUnit: function(key) {
		var style = this.css(key), val = [];
		$.each( ['em','px','%','pt'], function(i, unit){
			if(style.indexOf(unit) > 0)
				val = [parseFloat(style), unit];
		});
		return val;
	}
});



/******************************************************************************/
/*********************************** EASING ***********************************/
/******************************************************************************/

/*
 * jQuery Easing v1.3 - http://gsgd.co.uk/sandbox/jquery/easing/
 *
 * Uses the built in easing capabilities added In jQuery 1.1
 * to offer multiple easing options
 *
 * TERMS OF USE - jQuery Easing
 *
 * Open source under the BSD License.
 *
 * Copyright 2008 George McGinley Smith
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this list of
 * conditions and the following disclaimer.
 * Redistributions in binary form must reproduce the above copyright notice, this list
 * of conditions and the following disclaimer in the documentation and/or other materials
 * provided with the distribution.
 *
 * Neither the name of the author nor the names of contributors may be used to endorse
 * or promote products derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
 * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
*/

// t: current time, b: begInnIng value, c: change In value, d: duration
$.easing.jswing = $.easing.swing;

$.extend($.easing,
{
	def: 'easeOutQuad',
	swing: function (x, t, b, c, d) {
		//alert($.easing.default);
		return $.easing[$.easing.def](x, t, b, c, d);
	},
	easeInQuad: function (x, t, b, c, d) {
		return c*(t/=d)*t + b;
	},
	easeOutQuad: function (x, t, b, c, d) {
		return -c *(t/=d)*(t-2) + b;
	},
	easeInOutQuad: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t + b;
		return -c/2 * ((--t)*(t-2) - 1) + b;
	},
	easeInCubic: function (x, t, b, c, d) {
		return c*(t/=d)*t*t + b;
	},
	easeOutCubic: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t + 1) + b;
	},
	easeInOutCubic: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t + b;
		return c/2*((t-=2)*t*t + 2) + b;
	},
	easeInQuart: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t + b;
	},
	easeOutQuart: function (x, t, b, c, d) {
		return -c * ((t=t/d-1)*t*t*t - 1) + b;
	},
	easeInOutQuart: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
		return -c/2 * ((t-=2)*t*t*t - 2) + b;
	},
	easeInQuint: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t*t + b;
	},
	easeOutQuint: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t*t*t + 1) + b;
	},
	easeInOutQuint: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
		return c/2*((t-=2)*t*t*t*t + 2) + b;
	},
	easeInSine: function (x, t, b, c, d) {
		return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
	},
	easeOutSine: function (x, t, b, c, d) {
		return c * Math.sin(t/d * (Math.PI/2)) + b;
	},
	easeInOutSine: function (x, t, b, c, d) {
		return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
	},
	easeInExpo: function (x, t, b, c, d) {
		return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
	},
	easeOutExpo: function (x, t, b, c, d) {
		return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
	},
	easeInOutExpo: function (x, t, b, c, d) {
		if (t==0) return b;
		if (t==d) return b+c;
		if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
		return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
	},
	easeInCirc: function (x, t, b, c, d) {
		return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
	},
	easeOutCirc: function (x, t, b, c, d) {
		return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
	},
	easeInOutCirc: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
		return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
	},
	easeInElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
	},
	easeOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
	},
	easeInOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
		return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
	},
	easeInBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*(t/=d)*t*((s+1)*t - s) + b;
	},
	easeOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
	},
	easeInOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
		return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
	},
	easeInBounce: function (x, t, b, c, d) {
		return c - $.easing.easeOutBounce (x, d-t, 0, c, d) + b;
	},
	easeOutBounce: function (x, t, b, c, d) {
		if ((t/=d) < (1/2.75)) {
			return c*(7.5625*t*t) + b;
		} else if (t < (2/2.75)) {
			return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
		} else if (t < (2.5/2.75)) {
			return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
		} else {
			return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
		}
	},
	easeInOutBounce: function (x, t, b, c, d) {
		if (t < d/2) return $.easing.easeInBounce (x, t*2, 0, c, d) * .5 + b;
		return $.easing.easeOutBounce (x, t*2-d, 0, c, d) * .5 + c*.5 + b;
	}
});

/*
 *
 * TERMS OF USE - EASING EQUATIONS
 *
 * Open source under the BSD License.
 *
 * Copyright 2001 Robert Penner
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this list of
 * conditions and the following disclaimer.
 * Redistributions in binary form must reproduce the above copyright notice, this list
 * of conditions and the following disclaimer in the documentation and/or other materials
 * provided with the distribution.
 *
 * Neither the name of the author nor the names of contributors may be used to endorse
 * or promote products derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
 * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */

})(jQuery);
/*!
 * jQuery UI Effects Blind 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Blind
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.blind = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'hide'); // Set Mode
		var direction = o.options.direction || 'vertical'; // Default direction

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		var wrapper = $.effects.createWrapper(el).css({overflow:'hidden'}); // Create Wrapper
		var ref = (direction == 'vertical') ? 'height' : 'width';
		var distance = (direction == 'vertical') ? wrapper.height() : wrapper.width();
		if(mode == 'show') wrapper.css(ref, 0); // Shift

		// Animation
		var animation = {};
		animation[ref] = mode == 'show' ? distance : 0;

		// Animate
		wrapper.animate(animation, o.duration, o.options.easing, function() {
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(el[0], arguments); // Callback
			el.dequeue();
		});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Bounce 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Bounce
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.bounce = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'effect'); // Set Mode
		var direction = o.options.direction || 'up'; // Default direction
		var distance = o.options.distance || 20; // Default distance
		var times = o.options.times || 5; // Default # of times
		var speed = o.duration || 250; // Default speed per bounce
		if (/show|hide/.test(mode)) props.push('opacity'); // Avoid touching opacity to prevent clearType and PNG issues in IE

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		$.effects.createWrapper(el); // Create Wrapper
		var ref = (direction == 'up' || direction == 'down') ? 'top' : 'left';
		var motion = (direction == 'up' || direction == 'left') ? 'pos' : 'neg';
		var distance = o.options.distance || (ref == 'top' ? el.outerHeight(true) / 3 : el.outerWidth(true) / 3);
		if (mode == 'show') el.css('opacity', 0).css(ref, motion == 'pos' ? -distance : distance); // Shift
		if (mode == 'hide') distance = distance / (times * 2);
		if (mode != 'hide') times--;

		// Animate
		if (mode == 'show') { // Show Bounce
			var animation = {opacity: 1};
			animation[ref] = (motion == 'pos' ? '+=' : '-=') + distance;
			el.animate(animation, speed / 2, o.options.easing);
			distance = distance / 2;
			times--;
		};
		for (var i = 0; i < times; i++) { // Bounces
			var animation1 = {}, animation2 = {};
			animation1[ref] = (motion == 'pos' ? '-=' : '+=') + distance;
			animation2[ref] = (motion == 'pos' ? '+=' : '-=') + distance;
			el.animate(animation1, speed / 2, o.options.easing).animate(animation2, speed / 2, o.options.easing);
			distance = (mode == 'hide') ? distance * 2 : distance / 2;
		};
		if (mode == 'hide') { // Last Bounce
			var animation = {opacity: 0};
			animation[ref] = (motion == 'pos' ? '-=' : '+=')  + distance;
			el.animate(animation, speed / 2, o.options.easing, function(){
				el.hide(); // Hide
				$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
				if(o.callback) o.callback.apply(this, arguments); // Callback
			});
		} else {
			var animation1 = {}, animation2 = {};
			animation1[ref] = (motion == 'pos' ? '-=' : '+=') + distance;
			animation2[ref] = (motion == 'pos' ? '+=' : '-=') + distance;
			el.animate(animation1, speed / 2, o.options.easing).animate(animation2, speed / 2, o.options.easing, function(){
				$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
				if(o.callback) o.callback.apply(this, arguments); // Callback
			});
		};
		el.queue('fx', function() { el.dequeue(); });
		el.dequeue();
	});

};

})(jQuery);
/*!
 * jQuery UI Effects Clip 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Clip
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.clip = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right','height','width'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'hide'); // Set Mode
		var direction = o.options.direction || 'vertical'; // Default direction

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		var wrapper = $.effects.createWrapper(el).css({overflow:'hidden'}); // Create Wrapper
		var animate = el[0].tagName == 'IMG' ? wrapper : el;
		var ref = {
			size: (direction == 'vertical') ? 'height' : 'width',
			position: (direction == 'vertical') ? 'top' : 'left'
		};
		var distance = (direction == 'vertical') ? animate.height() : animate.width();
		if(mode == 'show') { animate.css(ref.size, 0); animate.css(ref.position, distance / 2); } // Shift

		// Animation
		var animation = {};
		animation[ref.size] = mode == 'show' ? distance : 0;
		animation[ref.position] = mode == 'show' ? 0 : distance / 2;

		// Animate
		animate.animate(animation, { queue: false, duration: o.duration, easing: o.options.easing, complete: function() {
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(el[0], arguments); // Callback
			el.dequeue();
		}});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Drop 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Drop
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.drop = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right','opacity'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'hide'); // Set Mode
		var direction = o.options.direction || 'left'; // Default Direction

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		$.effects.createWrapper(el); // Create Wrapper
		var ref = (direction == 'up' || direction == 'down') ? 'top' : 'left';
		var motion = (direction == 'up' || direction == 'left') ? 'pos' : 'neg';
		var distance = o.options.distance || (ref == 'top' ? el.outerHeight( true ) / 2 : el.outerWidth( true ) / 2);
		if (mode == 'show') el.css('opacity', 0).css(ref, motion == 'pos' ? -distance : distance); // Shift

		// Animation
		var animation = {opacity: mode == 'show' ? 1 : 0};
		animation[ref] = (mode == 'show' ? (motion == 'pos' ? '+=' : '-=') : (motion == 'pos' ? '-=' : '+=')) + distance;

		// Animate
		el.animate(animation, { queue: false, duration: o.duration, easing: o.options.easing, complete: function() {
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(this, arguments); // Callback
			el.dequeue();
		}});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Explode 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Explode
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.explode = function(o) {

	return this.queue(function() {

	var rows = o.options.pieces ? Math.round(Math.sqrt(o.options.pieces)) : 3;
	var cells = o.options.pieces ? Math.round(Math.sqrt(o.options.pieces)) : 3;

	o.options.mode = o.options.mode == 'toggle' ? ($(this).is(':visible') ? 'hide' : 'show') : o.options.mode;
	var el = $(this).show().css('visibility', 'hidden');
	var offset = el.offset();

	//Substract the margins - not fixing the problem yet.
	offset.top -= parseInt(el.css("marginTop"),10) || 0;
	offset.left -= parseInt(el.css("marginLeft"),10) || 0;

	var width = el.outerWidth(true);
	var height = el.outerHeight(true);

	for(var i=0;i<rows;i++) { // =
		for(var j=0;j<cells;j++) { // ||
			el
				.clone()
				.appendTo('body')
				.wrap('<div></div>')
				.css({
					position: 'absolute',
					visibility: 'visible',
					left: -j*(width/cells),
					top: -i*(height/rows)
				})
				.parent()
				.addClass('ui-effects-explode')
				.css({
					position: 'absolute',
					overflow: 'hidden',
					width: width/cells,
					height: height/rows,
					left: offset.left + j*(width/cells) + (o.options.mode == 'show' ? (j-Math.floor(cells/2))*(width/cells) : 0),
					top: offset.top + i*(height/rows) + (o.options.mode == 'show' ? (i-Math.floor(rows/2))*(height/rows) : 0),
					opacity: o.options.mode == 'show' ? 0 : 1
				}).animate({
					left: offset.left + j*(width/cells) + (o.options.mode == 'show' ? 0 : (j-Math.floor(cells/2))*(width/cells)),
					top: offset.top + i*(height/rows) + (o.options.mode == 'show' ? 0 : (i-Math.floor(rows/2))*(height/rows)),
					opacity: o.options.mode == 'show' ? 1 : 0
				}, o.duration || 500);
		}
	}

	// Set a timeout, to call the callback approx. when the other animations have finished
	setTimeout(function() {

		o.options.mode == 'show' ? el.css({ visibility: 'visible' }) : el.css({ visibility: 'visible' }).hide();
				if(o.callback) o.callback.apply(el[0]); // Callback
				el.dequeue();

				$('div.ui-effects-explode').remove();

	}, o.duration || 500);


	});

};

})(jQuery);
/*!
 * jQuery UI Effects Fade 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Fade
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.fade = function(o) {
	return this.queue(function() {
		var elem = $(this),
			mode = $.effects.setMode(elem, o.options.mode || 'hide');

		elem.animate({ opacity: mode }, {
			queue: false,
			duration: o.duration,
			easing: o.options.easing,
			complete: function() {
				(o.callback && o.callback.apply(this, arguments));
				elem.dequeue();
			}
		});
	});
};

})(jQuery);
/*!
 * jQuery UI Effects Fold 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Fold
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.fold = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'hide'); // Set Mode
		var size = o.options.size || 15; // Default fold size
		var horizFirst = !(!o.options.horizFirst); // Ensure a boolean value
		var duration = o.duration ? o.duration / 2 : $.fx.speeds._default / 2;

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		var wrapper = $.effects.createWrapper(el).css({overflow:'hidden'}); // Create Wrapper
		var widthFirst = ((mode == 'show') != horizFirst);
		var ref = widthFirst ? ['width', 'height'] : ['height', 'width'];
		var distance = widthFirst ? [wrapper.width(), wrapper.height()] : [wrapper.height(), wrapper.width()];
		var percent = /([0-9]+)%/.exec(size);
		if(percent) size = parseInt(percent[1],10) / 100 * distance[mode == 'hide' ? 0 : 1];
		if(mode == 'show') wrapper.css(horizFirst ? {height: 0, width: size} : {height: size, width: 0}); // Shift

		// Animation
		var animation1 = {}, animation2 = {};
		animation1[ref[0]] = mode == 'show' ? distance[0] : size;
		animation2[ref[1]] = mode == 'show' ? distance[1] : 0;

		// Animate
		wrapper.animate(animation1, duration, o.options.easing)
		.animate(animation2, duration, o.options.easing, function() {
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(el[0], arguments); // Callback
			el.dequeue();
		});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Highlight 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Highlight
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.highlight = function(o) {
	return this.queue(function() {
		var elem = $(this),
			props = ['backgroundImage', 'backgroundColor', 'opacity'],
			mode = $.effects.setMode(elem, o.options.mode || 'show'),
			animation = {
				backgroundColor: elem.css('backgroundColor')
			};

		if (mode == 'hide') {
			animation.opacity = 0;
		}

		$.effects.save(elem, props);
		elem
			.show()
			.css({
				backgroundImage: 'none',
				backgroundColor: o.options.color || '#ffff99'
			})
			.animate(animation, {
				queue: false,
				duration: o.duration,
				easing: o.options.easing,
				complete: function() {
					(mode == 'hide' && elem.hide());
					$.effects.restore(elem, props);
					(mode == 'show' && !$.support.opacity && this.style.removeAttribute('filter'));
					(o.callback && o.callback.apply(this, arguments));
					elem.dequeue();
				}
			});
	});
};

})(jQuery);
/*!
 * jQuery UI Effects Pulsate 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Pulsate
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.pulsate = function(o) {
	return this.queue(function() {
		var elem = $(this),
			mode = $.effects.setMode(elem, o.options.mode || 'show'),
			times = ((o.options.times || 5) * 2) - 1,
			duration = o.duration ? o.duration / 2 : $.fx.speeds._default / 2,
			isVisible = elem.is(':visible'),
			animateTo = 0;

		if (!isVisible) {
			elem.css('opacity', 0).show();
			animateTo = 1;
		}

		if ((mode == 'hide' && isVisible) || (mode == 'show' && !isVisible)) {
			times--;
		}

		for (var i = 0; i < times; i++) {
			elem.animate({ opacity: animateTo }, duration, o.options.easing);
			animateTo = (animateTo + 1) % 2;
		}

		elem.animate({ opacity: animateTo }, duration, o.options.easing, function() {
			if (animateTo == 0) {
				elem.hide();
			}
			(o.callback && o.callback.apply(this, arguments));
		});

		elem
			.queue('fx', function() { elem.dequeue(); })
			.dequeue();
	});
};

})(jQuery);
/*!
 * jQuery UI Effects Scale 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Scale
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.puff = function(o) {
	return this.queue(function() {
		var elem = $(this),
			mode = $.effects.setMode(elem, o.options.mode || 'hide'),
			percent = parseInt(o.options.percent, 10) || 150,
			factor = percent / 100,
			original = { height: elem.height(), width: elem.width() };

		$.extend(o.options, {
			fade: true,
			mode: mode,
			percent: mode == 'hide' ? percent : 100,
			from: mode == 'hide'
				? original
				: {
					height: original.height * factor,
					width: original.width * factor
				}
		});

		elem.effect('scale', o.options, o.duration, o.callback);
		elem.dequeue();
	});
};

$.effects.scale = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this);

		// Set options
		var options = $.extend(true, {}, o.options);
		var mode = $.effects.setMode(el, o.options.mode || 'effect'); // Set Mode
		var percent = parseInt(o.options.percent,10) || (parseInt(o.options.percent,10) == 0 ? 0 : (mode == 'hide' ? 0 : 100)); // Set default scaling percent
		var direction = o.options.direction || 'both'; // Set default axis
		var origin = o.options.origin; // The origin of the scaling
		if (mode != 'effect') { // Set default origin and restore for show/hide
			options.origin = origin || ['middle','center'];
			options.restore = true;
		}
		var original = {height: el.height(), width: el.width()}; // Save original
		el.from = o.options.from || (mode == 'show' ? {height: 0, width: 0} : original); // Default from state

		// Adjust
		var factor = { // Set scaling factor
			y: direction != 'horizontal' ? (percent / 100) : 1,
			x: direction != 'vertical' ? (percent / 100) : 1
		};
		el.to = {height: original.height * factor.y, width: original.width * factor.x}; // Set to state

		if (o.options.fade) { // Fade option to support puff
			if (mode == 'show') {el.from.opacity = 0; el.to.opacity = 1;};
			if (mode == 'hide') {el.from.opacity = 1; el.to.opacity = 0;};
		};

		// Animation
		options.from = el.from; options.to = el.to; options.mode = mode;

		// Animate
		el.effect('size', options, o.duration, o.callback);
		el.dequeue();
	});

};

$.effects.size = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right','width','height','overflow','opacity'];
		var props1 = ['position','top','bottom','left','right','overflow','opacity']; // Always restore
		var props2 = ['width','height','overflow']; // Copy for children
		var cProps = ['fontSize'];
		var vProps = ['borderTopWidth', 'borderBottomWidth', 'paddingTop', 'paddingBottom'];
		var hProps = ['borderLeftWidth', 'borderRightWidth', 'paddingLeft', 'paddingRight'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'effect'); // Set Mode
		var restore = o.options.restore || false; // Default restore
		var scale = o.options.scale || 'both'; // Default scale mode
		var origin = o.options.origin; // The origin of the sizing
		var original = {height: el.height(), width: el.width()}; // Save original
		el.from = o.options.from || original; // Default from state
		el.to = o.options.to || original; // Default to state
		// Adjust
		if (origin) { // Calculate baseline shifts
			var baseline = $.effects.getBaseline(origin, original);
			el.from.top = (original.height - el.from.height) * baseline.y;
			el.from.left = (original.width - el.from.width) * baseline.x;
			el.to.top = (original.height - el.to.height) * baseline.y;
			el.to.left = (original.width - el.to.width) * baseline.x;
		};
		var factor = { // Set scaling factor
			from: {y: el.from.height / original.height, x: el.from.width / original.width},
			to: {y: el.to.height / original.height, x: el.to.width / original.width}
		};
		if (scale == 'box' || scale == 'both') { // Scale the css box
			if (factor.from.y != factor.to.y) { // Vertical props scaling
				props = props.concat(vProps);
				el.from = $.effects.setTransition(el, vProps, factor.from.y, el.from);
				el.to = $.effects.setTransition(el, vProps, factor.to.y, el.to);
			};
			if (factor.from.x != factor.to.x) { // Horizontal props scaling
				props = props.concat(hProps);
				el.from = $.effects.setTransition(el, hProps, factor.from.x, el.from);
				el.to = $.effects.setTransition(el, hProps, factor.to.x, el.to);
			};
		};
		if (scale == 'content' || scale == 'both') { // Scale the content
			if (factor.from.y != factor.to.y) { // Vertical props scaling
				props = props.concat(cProps);
				el.from = $.effects.setTransition(el, cProps, factor.from.y, el.from);
				el.to = $.effects.setTransition(el, cProps, factor.to.y, el.to);
			};
		};
		$.effects.save(el, restore ? props : props1); el.show(); // Save & Show
		$.effects.createWrapper(el); // Create Wrapper
		el.css('overflow','hidden').css(el.from); // Shift

		// Animate
		if (scale == 'content' || scale == 'both') { // Scale the children
			vProps = vProps.concat(['marginTop','marginBottom']).concat(cProps); // Add margins/font-size
			hProps = hProps.concat(['marginLeft','marginRight']); // Add margins
			props2 = props.concat(vProps).concat(hProps); // Concat
			el.find("*[width]").each(function(){
				var child = $(this);
				if (restore) $.effects.save(child, props2);
				var c_original = {height: child.height(), width: child.width()}; // Save original
				child.from = {height: c_original.height * factor.from.y, width: c_original.width * factor.from.x};
				child.to = {height: c_original.height * factor.to.y, width: c_original.width * factor.to.x};
				if (factor.from.y != factor.to.y) { // Vertical props scaling
					child.from = $.effects.setTransition(child, vProps, factor.from.y, child.from);
					child.to = $.effects.setTransition(child, vProps, factor.to.y, child.to);
				};
				if (factor.from.x != factor.to.x) { // Horizontal props scaling
					child.from = $.effects.setTransition(child, hProps, factor.from.x, child.from);
					child.to = $.effects.setTransition(child, hProps, factor.to.x, child.to);
				};
				child.css(child.from); // Shift children
				child.animate(child.to, o.duration, o.options.easing, function(){
					if (restore) $.effects.restore(child, props2); // Restore children
				}); // Animate children
			});
		};

		// Animate
		el.animate(el.to, { queue: false, duration: o.duration, easing: o.options.easing, complete: function() {
			if (el.to.opacity === 0) {
				el.css('opacity', el.from.opacity);
			}
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, restore ? props : props1); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(this, arguments); // Callback
			el.dequeue();
		}});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Shake 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Shake
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.shake = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'effect'); // Set Mode
		var direction = o.options.direction || 'left'; // Default direction
		var distance = o.options.distance || 20; // Default distance
		var times = o.options.times || 3; // Default # of times
		var speed = o.duration || o.options.duration || 140; // Default speed per shake

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		$.effects.createWrapper(el); // Create Wrapper
		var ref = (direction == 'up' || direction == 'down') ? 'top' : 'left';
		var motion = (direction == 'up' || direction == 'left') ? 'pos' : 'neg';

		// Animation
		var animation = {}, animation1 = {}, animation2 = {};
		animation[ref] = (motion == 'pos' ? '-=' : '+=')  + distance;
		animation1[ref] = (motion == 'pos' ? '+=' : '-=')  + distance * 2;
		animation2[ref] = (motion == 'pos' ? '-=' : '+=')  + distance * 2;

		// Animate
		el.animate(animation, speed, o.options.easing);
		for (var i = 1; i < times; i++) { // Shakes
			el.animate(animation1, speed, o.options.easing).animate(animation2, speed, o.options.easing);
		};
		el.animate(animation1, speed, o.options.easing).
		animate(animation, speed / 2, o.options.easing, function(){ // Last shake
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(this, arguments); // Callback
		});
		el.queue('fx', function() { el.dequeue(); });
		el.dequeue();
	});

};

})(jQuery);
/*!
 * jQuery UI Effects Slide 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Slide
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.slide = function(o) {

	return this.queue(function() {

		// Create element
		var el = $(this), props = ['position','top','bottom','left','right'];

		// Set options
		var mode = $.effects.setMode(el, o.options.mode || 'show'); // Set Mode
		var direction = o.options.direction || 'left'; // Default Direction

		// Adjust
		$.effects.save(el, props); el.show(); // Save & Show
		$.effects.createWrapper(el).css({overflow:'hidden'}); // Create Wrapper
		var ref = (direction == 'up' || direction == 'down') ? 'top' : 'left';
		var motion = (direction == 'up' || direction == 'left') ? 'pos' : 'neg';
		var distance = o.options.distance || (ref == 'top' ? el.outerHeight( true ) : el.outerWidth( true ));
		if (mode == 'show') el.css(ref, motion == 'pos' ? (isNaN(distance) ? "-" + distance : -distance) : distance); // Shift

		// Animation
		var animation = {};
		animation[ref] = (mode == 'show' ? (motion == 'pos' ? '+=' : '-=') : (motion == 'pos' ? '-=' : '+=')) + distance;

		// Animate
		el.animate(animation, { queue: false, duration: o.duration, easing: o.options.easing, complete: function() {
			if(mode == 'hide') el.hide(); // Hide
			$.effects.restore(el, props); $.effects.removeWrapper(el); // Restore
			if(o.callback) o.callback.apply(this, arguments); // Callback
			el.dequeue();
		}});

	});

};

})(jQuery);
/*!
 * jQuery UI Effects Transfer 1.8.22
 *
 * Copyright 2012, AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * http://docs.jquery.com/UI/Effects/Transfer
 *
 * Depends:
 *	jquery.effects.core.js
 */
(function( $, undefined ) {

$.effects.transfer = function(o) {
	return this.queue(function() {
		var elem = $(this),
			target = $(o.options.to),
			endPosition = target.offset(),
			animation = {
				top: endPosition.top,
				left: endPosition.left,
				height: target.innerHeight(),
				width: target.innerWidth()
			},
			startPosition = elem.offset(),
			transfer = $('<div class="ui-effects-transfer"></div>')
				.appendTo(document.body)
				.addClass(o.options.className)
				.css({
					top: startPosition.top,
					left: startPosition.left,
					height: elem.innerHeight(),
					width: elem.innerWidth(),
					position: 'absolute'
				})
				.animate(animation, o.duration, o.options.easing, function() {
					transfer.remove();
					(o.callback && o.callback.apply(elem[0], arguments));
					elem.dequeue();
				});
	});
};

})(jQuery);



/*
 * jQuery UI Multidraggable 1.8.8

 * Copyright (c) 2009 Tim Radnidge (xiaohouzi79 at gmail)
 * Tim's changes have been copied to jQuery UI Draggable 1.8.8
 * by Pulse Energy (support at pulseenergy.com)
 *
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * This code is based largely on and extends the jQuery UI Draggable 1.8.8  Copyright (c) 2010 jQuery UI authors(http://jqueryui.com/about)
 * Depends:
 *	ui.draggable.js
 *	ui.core.js
 */
(function($) {

$.widget("ui.multidraggable", $.extend({}, $.ui.draggable.prototype, {
	_create: function() {

		if (this.options.helper == 'original' && !(/^(?:r|a|f)/).test(this.element.css("position")))
			this.element[0].style.position = 'relative';

		(this.options.addClasses && this.element.addClass("ui-draggable"));
		(this.options.disabled && this.element.addClass("ui-draggable-disabled"));

		this._mouseInit();
		
        this.options.isMain = false;
	},

	destroy: function() {
		if(!this.element.data('multidraggable')) return;
		this.element
			.removeData("multidraggable")
			.unbind(".draggable")
			.removeClass("ui-draggable"
				+ " ui-draggable-dragging"
				+ " ui-draggable-disabled");
		this._mouseDestroy();

		return this;
	},

	_mouseCapture: function(event) {
		if (event.ctrlKey) {
			// Class for marking a multidraggable as being part of the group
			this.element.toggleClass('ui-multidraggable');
		}
		
		var o = this.options;

		// among others, prevent a drag on a resizable-handle
		if (this.helper || o.disabled || $(event.target).is('.ui-resizable-handle'))
			return false;

		//Quit if we're not on a valid handle
		this.handle = this._getHandle(event);
		if (!this.handle)
			return false;

		return true;

	},

	mouseStart: function(event, draggedOptions) {

		var o = this.options;
		if (this.element.hasClass('ui-multidraggable')) {
			this.options.draggedOptions = draggedOptions;
		}

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		//Cache the helper size
		this._cacheHelperProportions();

		//If ddmanager is used for droppables, set the global draggable
		if ($.ui.ddmanager)
			$.ui.ddmanager.current = this;

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Store the helper's css position
		this.cssPosition = this.helper.css("position");
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.positionAbs = this.element.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		//Generate the original position
		this.originalPosition = this.position = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if 'cursorAt' is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));
			
		//Set a containment if given in the options
		if (o.containment) {
			this._setContainment();
		}

		//Trigger event + callbacks
		if (this._trigger("start", event) === false) {
			this._clear();
			return false;
		}

		//Recache the helper size
		this._cacheHelperProportions();

		//Prepare the droppable offsets
		if ($.ui.ddmanager && !o.dropBehaviour)
			$.ui.ddmanager.prepareOffsets(this, event);

		this.helper.addClass("ui-draggable-dragging");
		this.mouseDrag(event, true); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		return true;
	},

	_mouseStart: function(event) {
		var o = this.options;
	
		if (this.element.hasClass('ui-multidraggable')) {
			this.options.isMain = true;
			$(".ui-multidraggable").each(function () { $(this).multidraggable("mouseStart", event, o); });
			return true;
		} else {
			this.mouseStart(event, o);
		}
	},
	
	mouseDrag: function(event, noPropagation) {
		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		//Call plugins and callbacks and use the resulting position if something is returned
		if (!noPropagation) {
			var ui = this._uiHash();
			if (this._trigger('drag', event, ui) === false) {
				this._mouseUp({});
				return false;
			}
			this.position = ui.position;
		}

		if (this.element.hasClass('ui-multidraggable')) {
			if (!this.options.axis && !this.options.draggedOptions.axis || this.options.axis != "y" && this.options.draggedOptions.axis != "y") {
				this.helper[0].style.left = this.position.left + 'px';
			}
			if (!this.options.axis && !this.options.draggedOptions.axis || this.options.axis != "x" && this.options.draggedOptions.axis != "x") {
				this.helper[0].style.top = this.position.top + 'px';
			}
		} else {
			if (!this.options.axis || this.options.axis != "y") {
				this.helper[0].style.left = this.position.left + 'px';
			}
			if (!this.options.axis || this.options.axis != "x") {
				this.helper[0].style.top = this.position.top + 'px';
			}
		}
		if ($.ui.ddmanager) $.ui.ddmanager.drag(this, event);

		return false;
	},

	_mouseDrag: function(event, noPropagation) {
		if (this.element.hasClass('ui-multidraggable')) {
			$(".ui-multidraggable").each(function () { $(this).multidraggable("mouseDrag", event, noPropagation); });
			return false;
		} else {
			this.mouseDrag(event, noPropagation, this.options);
			return false;
		}
	},

	mouseStop: function(event) {

		//If we are using droppables, inform the manager about the drop
		var dropped = false;
		if ($.ui.ddmanager && !this.options.dropBehaviour)
			dropped = $.ui.ddmanager.drop(this, event);

		//if a drop comes from outside (a sortable)
		if(this.dropped) {
			dropped = this.dropped;
			this.dropped = false;
		}
		
		//if the original element is removed, don't bother to continue
		if(!this.element[0] || !this.element[0].parentNode)
			return false;

		if((this.options.revert == "invalid" && !dropped) || (this.options.revert == "valid" && dropped) || this.options.revert === true || ($.isFunction(this.options.revert) && this.options.revert.call(this.element, dropped))) {
			var self = this;
			$(this.helper).animate(this.originalPosition, parseInt(this.options.revertDuration, 10), function() {
				if(self._trigger("stop", event) !== false) {
					self._clear();
				}
			});
		} else {
			if(this._trigger("stop", event) !== false) {
				this._clear();
			}
		}

		return false;
	},
	
	_mouseStop: function(event) {
		if (this.element.hasClass('ui-multidraggable')) {
			$(".ui-multidraggable").each(function () { $(this).multidraggable("mouseStop", event); });
			return false;
		} else {
			this.mouseStop(event);
			return false;
		}
	},

	cancel: function() {
		
		if(this.helper.is(".ui-draggable-dragging")) {
			this._mouseUp({});
		} else {
			this._clear();
		}
		
		return this;
		
	},

	_clear: function() {
		this.helper.removeClass("ui-draggable-dragging");
		if(this.helper[0] != this.element[0] && !this.cancelHelperRemoval) this.helper.remove();
		//if($.ui.ddmanager) $.ui.ddmanager.current = null;
		this.options.isMain = false;
		this.helper = null;
		this.cancelHelperRemoval = false;
	},

	plugins: {}

}));

$.extend($.ui.multidraggable, {
	version: "1.8.8",
	widgetEventPrefix: "drag",
	options: {
		addClasses: true,
		appendTo: "parent",
		axis: false,
		cancel: ":input,option",
		connectToSortable: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		delay: 0,
		distance: 1,
		grid: false,
		handle: false,
		helper: "original",
		iframeFix: false,
		opacity: false,
		refreshPositions: false,
		revert: false,
		revertDuration: 500,
		scope: "default",
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		snap: false,
		snapMode: "both",
		snapTolerance: 20,
		stack: false,
		zIndex: false
	}
});

$.ui.plugin.add("multidraggable", "connectToSortable", {
	start: function(event, ui) {

		var inst = $(this).data("multidraggable"), o = inst.options,
			uiSortable = $.extend({}, ui, { item: inst.element });
		inst.sortables = [];
		$(o.connectToSortable).each(function() {
			var sortable = $.data(this, 'sortable');
			if (sortable && !sortable.options.disabled) {
				inst.sortables.push({
					instance: sortable,
					shouldRevert: sortable.options.revert
				});
				sortable._refreshItems();	//Do a one-time refresh at start to refresh the containerCache
				sortable._trigger("activate", event, uiSortable);
			}
		});

	},
	stop: function(event, ui) {

		//If we are still over the sortable, we fake the stop event of the sortable, but also remove helper
		var inst = $(this).data("multidraggable"),
			uiSortable = $.extend({}, ui, { item: inst.element });

		$.each(inst.sortables, function() {
			if(this.instance.isOver) {

				this.instance.isOver = 0;

				inst.cancelHelperRemoval = true; //Don't remove the helper in the draggable instance
				this.instance.cancelHelperRemoval = false; //Remove it in the sortable instance (so sortable plugins like revert still work)

				//The sortable revert is supported, and we have to set a temporary dropped variable on the draggable to support revert: 'valid/invalid'
				if(this.shouldRevert) this.instance.options.revert = true;

				//Trigger the stop of the sortable
				this.instance._mouseStop(event);

				this.instance.options.helper = this.instance.options._helper;

				//If the helper has been the original item, restore properties in the sortable
				if(inst.options.helper == 'original')
					this.instance.currentItem.css({ top: 'auto', left: 'auto' });

			} else {
				this.instance.cancelHelperRemoval = false; //Remove the helper in the sortable instance
				this.instance._trigger("deactivate", event, uiSortable);
			}

		});

	},
	drag: function(event, ui) {

		var inst = $(this).data("multidraggable"), self = this;

		var checkPos = function(o) {
			var dyClick = this.offset.click.top, dxClick = this.offset.click.left;
			var helperTop = this.positionAbs.top, helperLeft = this.positionAbs.left;
			var itemHeight = o.height, itemWidth = o.width;
			var itemTop = o.top, itemLeft = o.left;

			return $.ui.isOver(helperTop + dyClick, helperLeft + dxClick, itemTop, itemLeft, itemHeight, itemWidth);
		};

		$.each(inst.sortables, function(i) {
			
			//Copy over some variables to allow calling the sortable's native _intersectsWith
			this.instance.positionAbs = inst.positionAbs;
			this.instance.helperProportions = inst.helperProportions;
			this.instance.offset.click = inst.offset.click;
			
			if(this.instance._intersectsWith(this.instance.containerCache)) {

				//If it intersects, we use a little isOver variable and set it once, so our move-in stuff gets fired only once
				if(!this.instance.isOver) {

					this.instance.isOver = 1;
					//Now we fake the start of dragging for the sortable instance,
					//by cloning the list group item, appending it to the sortable and using it as inst.currentItem
					//We can then fire the start event of the sortable with our passed browser event, and our own helper (so it doesn't create a new one)
					this.instance.currentItem = $(self).clone().appendTo(this.instance.element).data("sortable-item", true);
					this.instance.options._helper = this.instance.options.helper; //Store helper option to later restore it
					this.instance.options.helper = function() { return ui.helper[0]; };

					event.target = this.instance.currentItem[0];
					this.instance._mouseCapture(event, true);
					this.instance._mouseStart(event, true, true);

					//Because the browser event is way off the new appended portlet, we modify a couple of variables to reflect the changes
					this.instance.offset.click.top = inst.offset.click.top;
					this.instance.offset.click.left = inst.offset.click.left;
					this.instance.offset.parent.left -= inst.offset.parent.left - this.instance.offset.parent.left;
					this.instance.offset.parent.top -= inst.offset.parent.top - this.instance.offset.parent.top;

					inst._trigger("toSortable", event);
					inst.dropped = this.instance.element; //draggable revert needs that
					//hack so receive/update callbacks work (mostly)
					inst.currentItem = inst.element;
					this.instance.fromOutside = inst;

				}

				//Provided we did all the previous steps, we can fire the drag event of the sortable on every draggable drag, when it intersects with the sortable
				if(this.instance.currentItem) this.instance._mouseDrag(event);

			} else {

				//If it doesn't intersect with the sortable, and it intersected before,
				//we fake the drag stop of the sortable, but make sure it doesn't remove the helper by using cancelHelperRemoval
				if(this.instance.isOver) {

					this.instance.isOver = 0;
					this.instance.cancelHelperRemoval = true;
					
					//Prevent reverting on this forced stop
					this.instance.options.revert = false;
					
					// The out event needs to be triggered independently
					this.instance._trigger('out', event, this.instance._uiHash(this.instance));
					
					this.instance._mouseStop(event, true);
					this.instance.options.helper = this.instance.options._helper;

					//Now we remove our currentItem, the list group clone again, and the placeholder, and animate the helper back to it's original size
					this.instance.currentItem.remove();
					if(this.instance.placeholder) this.instance.placeholder.remove();

					inst._trigger("fromSortable", event);
					inst.dropped = false; //draggable revert needs that
				}

			};

		});

	}
});

$.ui.plugin.add("multidraggable", "cursor", {
	start: function(event, ui) {
		if ($(this).hasClass('ui-multidraggable')) {
			if ($(this).data('multidraggable').options.isMain == false) {
				return;
			}
		}
		var t = $('body'), o = $(this).data('multidraggable').options;
		if (t.css("cursor")) o._cursor = t.css("cursor");
		t.css("cursor", o.cursor);
	},
	stop: function(event, ui) {
		if ($(this).hasClass('ui-multidraggable')) {
			if ($(this).data('multidraggable').options.isMain == false) {
				return;
			}
		}
		var o = $(this).data('multidraggable').options;
		if (o._cursor) $('body').css("cursor", o._cursor);
	}
});

$.ui.plugin.add("multidraggable", "iframeFix", {
	start: function(event, ui) {
		var o = $(this).data('multidraggable').options;
		$(o.iframeFix === true ? "iframe" : o.iframeFix).each(function() {
			$('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>')
			.css({
				width: this.offsetWidth+"px", height: this.offsetHeight+"px",
				position: "absolute", opacity: "0.001", zIndex: 1000
			})
			.css($(this).offset())
			.appendTo("body");
		});
	},
	stop: function(event, ui) {
		$("div.ui-draggable-iframeFix").each(function() { this.parentNode.removeChild(this); }); //Remove frame helpers
	}
});

$.ui.plugin.add("multidraggable", "opacity", {
	start: function(event, ui) {
		var t = $(ui.helper), o = $(this).data('multidraggable').options;
		if(t.css("opacity")) o._opacity = t.css("opacity");
		t.css('opacity', o.opacity);
	},
	stop: function(event, ui) {
		var o = $(this).data('multidraggable').options;
		if(o._opacity) $(ui.helper).css('opacity', o._opacity);
	}
});

$.ui.plugin.add("multidraggable", "scroll", {
	start: function(event, ui) {
		var i = $(this).data("multidraggable");
		if(i.scrollParent[0] != document && i.scrollParent[0].tagName != 'HTML') i.overflowOffset = i.scrollParent.offset();
	},
	drag: function(event, ui) {

		var i = $(this).data("multidraggable"), o = i.options, scrolled = false;

		if(i.scrollParent[0] != document && i.scrollParent[0].tagName != 'HTML') {

			if(!o.axis || o.axis != 'x') {
				if((i.overflowOffset.top + i.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity)
					i.scrollParent[0].scrollTop = scrolled = i.scrollParent[0].scrollTop + o.scrollSpeed;
				else if(event.pageY - i.overflowOffset.top < o.scrollSensitivity)
					i.scrollParent[0].scrollTop = scrolled = i.scrollParent[0].scrollTop - o.scrollSpeed;
			}

			if(!o.axis || o.axis != 'y') {
				if((i.overflowOffset.left + i.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity)
					i.scrollParent[0].scrollLeft = scrolled = i.scrollParent[0].scrollLeft + o.scrollSpeed;
				else if(event.pageX - i.overflowOffset.left < o.scrollSensitivity)
					i.scrollParent[0].scrollLeft = scrolled = i.scrollParent[0].scrollLeft - o.scrollSpeed;
			}

		} else {

			if(!o.axis || o.axis != 'x') {
				if(event.pageY - $(document).scrollTop() < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() - o.scrollSpeed);
				else if($(window).height() - (event.pageY - $(document).scrollTop()) < o.scrollSensitivity)
					scrolled = $(document).scrollTop($(document).scrollTop() + o.scrollSpeed);
			}

			if(!o.axis || o.axis != 'y') {
				if(event.pageX - $(document).scrollLeft() < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() - o.scrollSpeed);
				else if($(window).width() - (event.pageX - $(document).scrollLeft()) < o.scrollSensitivity)
					scrolled = $(document).scrollLeft($(document).scrollLeft() + o.scrollSpeed);
			}

		}

		if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour)
			$.ui.ddmanager.prepareOffsets(i, event);

	}
});

$.ui.plugin.add("multidraggable", "snap", {
	start: function(event, ui) {

		var i = $(this).data("multidraggable"), o = i.options;
		i.snapElements = [];

		$(o.snap.constructor != String ? ( o.snap.items || ':data(draggable)' ) : o.snap).each(function() {
			var $t = $(this); var $o = $t.offset();
			if(this != i.element[0]) i.snapElements.push({
				item: this,
				width: $t.outerWidth(), height: $t.outerHeight(),
				top: $o.top, left: $o.left
			});
		});

	},
	drag: function(event, ui) {

		var inst = $(this).data("multidraggable"), o = inst.options;
		var d = o.snapTolerance;

		var x1 = ui.offset.left, x2 = x1 + inst.helperProportions.width,
			y1 = ui.offset.top, y2 = y1 + inst.helperProportions.height;

		for (var i = inst.snapElements.length - 1; i >= 0; i--){

			var l = inst.snapElements[i].left, r = l + inst.snapElements[i].width,
				t = inst.snapElements[i].top, b = t + inst.snapElements[i].height;

			//Yes, I know, this is insane ;)
			if(!((l-d < x1 && x1 < r+d && t-d < y1 && y1 < b+d) || (l-d < x1 && x1 < r+d && t-d < y2 && y2 < b+d) || (l-d < x2 && x2 < r+d && t-d < y1 && y1 < b+d) || (l-d < x2 && x2 < r+d && t-d < y2 && y2 < b+d))) {
				if(inst.snapElements[i].snapping) (inst.options.snap.release && inst.options.snap.release.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
				inst.snapElements[i].snapping = false;
				continue;
			}

			if(o.snapMode != 'inner') {
				var ts = Math.abs(t - y2) <= d;
				var bs = Math.abs(b - y1) <= d;
				var ls = Math.abs(l - x2) <= d;
				var rs = Math.abs(r - x1) <= d;
				if(ts) ui.position.top = inst._convertPositionTo("relative", { top: t - inst.helperProportions.height, left: 0 }).top - inst.margins.top;
				if(bs) ui.position.top = inst._convertPositionTo("relative", { top: b, left: 0 }).top - inst.margins.top;
				if(ls) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l - inst.helperProportions.width }).left - inst.margins.left;
				if(rs) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r }).left - inst.margins.left;
			}

			var first = (ts || bs || ls || rs);

			if(o.snapMode != 'outer') {
				var ts = Math.abs(t - y1) <= d;
				var bs = Math.abs(b - y2) <= d;
				var ls = Math.abs(l - x1) <= d;
				var rs = Math.abs(r - x2) <= d;
				if(ts) ui.position.top = inst._convertPositionTo("relative", { top: t, left: 0 }).top - inst.margins.top;
				if(bs) ui.position.top = inst._convertPositionTo("relative", { top: b - inst.helperProportions.height, left: 0 }).top - inst.margins.top;
				if(ls) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: l }).left - inst.margins.left;
				if(rs) ui.position.left = inst._convertPositionTo("relative", { top: 0, left: r - inst.helperProportions.width }).left - inst.margins.left;
			}

			if(!inst.snapElements[i].snapping && (ts || bs || ls || rs || first))
				(inst.options.snap.snap && inst.options.snap.snap.call(inst.element, event, $.extend(inst._uiHash(), { snapItem: inst.snapElements[i].item })));
			inst.snapElements[i].snapping = (ts || bs || ls || rs || first);

		};

	}
});

$.ui.plugin.add("multidraggable", "stack", {
	start: function(event, ui) {

		var o = $(this).data("multidraggable").options;

		var group = $.makeArray($(o.stack)).sort(function(a,b) {
			return (parseInt($(a).css("zIndex"),10) || 0) - (parseInt($(b).css("zIndex"),10) || 0);
		});
		if (!group.length) { return; }
		
		var min = parseInt(group[0].style.zIndex) || 0;
		$(group).each(function(i) {
			this.style.zIndex = min + i;
		});

		if ($(this).hasClass('ui-multidraggable')) {
			if ($(this).data('multidraggable').options.isMain == true) {
				this[0].style.zIndex = o.stack.min + group.length;
			}
		} else {		
			this[0].style.zIndex = o.stack.min + group.length;
		}
	}
});

$.ui.plugin.add("multidraggable", "zIndex", {
	start: function(event, ui) {
		var t = $(ui.helper), o = $(this).data("multidraggable").options;
		if(t.css("zIndex")) o._zIndex = t.css("zIndex");
		t.css('zIndex', o.zIndex);
	},
	stop: function(event, ui) {
		var o = $(this).data("multidraggable").options;
		if(o._zIndex) $(ui.helper).css('zIndex', o._zIndex);
	}
});

})(jQuery);

/**code end**/
  
  
}});
;define("jquery.pp.loadpi",[], function() { return function(jQuery) {
  
/**code start**/


(function ($) {
    function LoadPI(element, options) {
        this.ver = 1.0;
        this.$element = $(element);
        this.options = $.extend({}, $.fn.loadPI.defaults,options);
        this.init();
    }
    
    LoadPI.prototype = {
        piOptions : null,
        piData : null,
        piHtml : '',

        /*
         * data-loadpi
         */        
        _setOptions : function(){

            var piSource = this.$element.attr('data-loadpi-url');
            console.log();
            var piId = piSource.substring(piSource.lastIndexOf('/') + 1,piSource.indexOf('.js'));

            this.piOptions = {
                piSource : piSource,
                piId : piId,
                template : this.$element.data('loadpi-tpl')
            }
        },

        /*
         * 
         */
        resetPPimgSize: function(i){
            this.piData[i].img60x60 = this.piData[i].image.replace('200x200','60x60');
            this.piData[i].img80x80 = this.piData[i].image.replace('200x200','80x80');
            this.piData[i].img120x120 = this.piData[i].image.replace('200x200','120x120');
            this.piData[i].img160x160 = this.piData[i].image.replace('200x200','160x160');
            this.piData[i].img300x300 = this.piData[i].image.replace('200x200','300x300');
        },

        /*
         * 
         */
        renderTpl : function (tpl, data) {
            tpl = tpl.replace(/{#([\w\-]+)\#}/g, function(match, key){
                return typeof data[key] !== undefined ? data[key] : '';
            });
            return tpl;
        },

        /*
         * HTML
         */
        replaceTpl : function(i){
            var template = this.piOptions.template;
            this.piHtml  += this.renderTpl(this.piOptions.template,this.piData[i]);

        },

        /*
         * html
         */
        fill : function(){
            //console.log(this.options.fillMode);
            if(this.options.fillMode == 'append'){
                console.log('a');
                this.$element.append('<!--PAT:item-->' + this.piHtml + '<!--/PAT:item-->' );
            }else if(this.options.fillMode == 'fill'){
                //console.log(this.$element,this.piHtml);
                this.$element.html('<!--PAT:item-->' + this.piHtml + '<!--/PAT:item-->' );
                 
            }
            if(this.options.renderedCallback !== null  &&  typeof this.options.renderedCallback === 'function'){
                this.options.renderedCallback();
            }
        },

        /*
         * 
         */
        loopData : function(){
            for(var i in this.piData){
                if(this.piData[i] !== ''){
                    this.resetPPimgSize(i);
                    this.replaceTpl(i);
                }else{
                    this.piData.splice(i,1);
                    continue;                    
                }
            }
            //console.log(this.piData);
            this.fill(this.piData);
        },


        /*
         * 
         */
        getPiData : function(){
            var that = this;
            $.ajax({  
                type : "GET", 
                url : that.piOptions.piSource + '?t=' + Date.parse(new Date()),  
                dataType : "jsonp",
                contentType: "application/x-javascript; charset=gbk",
                jsonpCallback: that.piOptions.piId, 
                success : function(data){
                    that.piData = data.itemData;
                    that.piHtml="";
                    that.loopData();

                }  
            }); 
        },


        init : function(){
            this.piOptions = null;
            this.piData = null;
            this.piHtml = '';
            this._setOptions();
            this.getPiData();
           
        }
    };

    // JQ
    $.fn.loadPI = function (options) {
        return this.each(function () {
            var $me = $(this),
                instance = $me.data('loadpi');
            if(!instance){
                instance = new LoadPI(this, options);
                $me.data('loadpi',instance );
            }else{
                instance.init();
            }
            if ($.type(options) === 'string') instance[options]();

        });
    };



    /**
     * 
     */
    $.fn.loadPI.defaults = {
        fillMode : 'fill',
        renderedCallback : null
    };
})(jQuery);





// /**
//  * 
//  */

// (function ($) {
//     function LoadCoss(element, options) {
//         this.ver = 1.0;
//         this.$element = $(element);
//         this.options = $.extend({}, $.fn.loadCoss.defaults,options);
//         this.init();
//     }
    
//     LoadCoss.prototype = {
//         cossOptions : null,
//         cossData : null,
//         cossHtml : '',

//         /*
//          * data-loadcoss
//          */        
//         _setOptions : function(){
//             var cossSource = this.$element.data('loadcoss-url');
//             var callbackName = this.getUrlParam(cossSource,'callback');
//             if(callbackName == ''){
//                 var randomNum = this.rd(0,100);
//                 cossSource = this.setUrlParam(cossSource,"callback","cossCallback_" + randomNum);
//                 callbackName = "cossCallback_" + randomNum;
//             }

//             this.cossOptions = {
//                 cossSource : cossSource,
//                 callbackName : callbackName,
//                 template : this.$element.data('loadcoss-tpl')
//             }
//         },
//         rd : function (n,m){
//             var c = m-n+1;  
//             return Math.floor(Math.random() * c + n);
//         },

//         getUrlParam : function(url,param){
            
//             var u, params, StrBack = '';
//             if (arguments[arguments.length - 1] == "#") 
//                 u = url.split("#");
//             else 
//                 u = url.split("?");
//             if (u.length == 1) 
//                 params = '';
//             else 
//                 params = u[1];
            
//             if (params != '') {
//                 gg = params.split("&");
//                 var MaxI = gg.length;
//                 str = arguments[1] + "=";
//                 for (i = 0; i < MaxI; i++) {
//                     if (gg[i].indexOf(str) == 0) {
//                         StrBack = gg[i].replace(str, "");
//                         break;
//                     }
//                 }
//             }
//             return StrBack;
//         },
//         setUrlParam : function (url, ref, value){
//             var str = "";
//             if (url.indexOf('?') != -1)
//                 str = url.substr(url.indexOf('?') + 1);
//             else
//                 return url + "?" + ref + "=" + value;
//             var returnurl = "";
//             var setparam = "";
//             var arr;
//             var modify = "0";
//             if (str.indexOf('&') != -1) {
//                 arr = str.split('&');
//                 for (i in arr) {
//                     if (arr[i].split('=')[0] == ref) {
//                         setparam = value;
//                         modify = "1";
//                     }
//                     else {
//                         setparam = arr[i].split('=')[1];
//                     }
//                     returnurl = returnurl + arr[i].split('=')[0] + "=" + setparam + "&";
//                 }
//                 returnurl = returnurl.substr(0, returnurl.length - 1);
//                 if (modify == "0")
//                     if (returnurl == str)
//                         returnurl = returnurl + "&" + ref + "=" + value;
//             }
//             else {
//                 if (str.indexOf('=') != -1) {
//                     arr = str.split('=');
//                     if (arr[0] == ref) {
//                         setparam = value;
//                         modify = "1";
//                     }
//                     else {
//                         setparam = arr[1];
//                     }
//                     returnurl = arr[0] + "=" + setparam;
//                     if (modify == "0")
//                         if (returnurl == str)
//                             returnurl = returnurl + "&" + ref + "=" + value;
//                 }
//                 else
//                     returnurl = ref + "=" + value;
//             }
//             return url.substr(0, url.indexOf('?')) + "?" + returnurl;
//         },

//         /*
//          * 
//          */
//         resetData: function(i){
//             var itemId = this.cossData[i].itemId;
//             var picUrlHead = '"http://img0.paipaiimg.com/756960cf/item-537C1B40-0A02C63D00000000040100003909A898.0.';
//             this.cossData[i].img60x60 = picUrlHead + '60x60.jpg';
//             this.cossData[i].img80x80 = picUrlHead + '80x80.jpg';
//             this.cossData[i].img120x120 = picUrlHead + '120x120.jpg';
//             this.cossData[i].img160x160 = picUrlHead + '160x160.jpg';
//             this.cossData[i].img300x300 = picUrlHead + '300x300.jpg';


//             var activePrice = parseInt(this.cossData[i].activePrice);
//             var marketPrice = parseInt(this.cossData[i].marketPrice);
//             var price = parseInt(this.cossData[i].price);
//             this.cossData[i].activePrice = (activePrice/100).toFixed(2);
//             this.cossData[i].marketPrice = (marketPrice/100).toFixed(2);
//             this.cossData[i].price = (price/100).toFixed(2);
//         },

//         /*
//          * 
//          */
//         renderTpl : function (tpl, data) {
//             tpl = tpl.replace(/{#([\w\-]+)\#}/g, function(match, key){
//                 return typeof data[key] !== undefined ? data[key] : '';
//             });
//             return tpl;
//         },

//         /*
//          * HTML
//          */
//         replaceTpl : function(i){
//             var template = this.cossOptions.template;
//             this.cossHtml  += this.renderTpl(this.cossOptions.template,this.cossData[i]);

//         },

//         /*
//          * html
//          */
//         fill : function(){
//             console.log(this.options.fillMode);
//             if(this.options.fillMode == 'append'){
//                 this.$element.append('<!--PAT:item-->' + this.cossHtml + '<!--/PAT:item-->');
//             }else if(this.options.fillMode == 'fill'){
//                 this.$element.html('<!--PAT:item-->' + this.cossHtml + '<!--/PAT:item-->');
//             }
//             if(this.options.renderedCallback !== null  &&  typeof this.options.renderedCallback === 'function'){
//                 this.options.renderedCallback();
//             }
//         },

//         /*
//          * 
//          */
//         loopData : function(){
//             for(var i in this.cossData){
//                 if(this.cossData[i] !== ''){
//                     this.resetData(i);
//                     this.replaceTpl(i);
//                 }else{
//                     this.cossData.splice(i,1);
//                     continue;                    
//                 }
//             }
//             console.log(this.cossData);
//             this.fill();
//         },


//         /*
//          * 
//          */
//         getCossData : function(){
//             var that = this;
//             $.ajax({  
//                 type : "GET", 
//                 url : that.cossOptions.cossSource + '&t=' + Date.parse(new Date()),  
//                 dataType : "jsonp",
//                 jsonpCallback: that.cossOptions.callbackName, 
//                 success : function(data){  
//                     if(that.options.getDataCallback !== null  &&  typeof that.options.getDataCallback === 'function'){
//                         that.options.getDataCallback(data.itemlist);
//                     }
//                     that.cossData =  data.itemlist;
//                     that.loopData();
//                 }  
//             }); 
//         },


//         init : function(){

//             this._setOptions();
//             this.getCossData();
           
//         }
//     };

//     // JQ
//     $.fn.loadCoss = function (options) {
//         return this.each(function () {
//             var $me = $(this),
//                 instance = $me.data('loadcoss');
//             if(!instance){
//                 instance = new LoadCoss(this, options);
//                 $me.data('loadcoss',instance );
//             }else{
//                 instance.init();
//             }
//             if ($.type(options) === 'string') instance[options]();

//         });
//     };



//     /**
//      * 
//      */
//     $.fn.loadCoss.defaults = {
//         fillMode : 'append',
//         renderedCallback : null,
//         getDataCallback : null
//     };
// })(jQuery);





/*
 * data-loadpi
 */
// $('[data-loadpi]').loadPI();




/**code end**/
  
  
}});

;define("jquery.pp.marketcpc",[], function() { return function(jQuery) {
  
/**code start**/


/**
 * 
 */

(function ($) {
    function MarketCpc(element, options) {
        this.ver = 1.0;
        this.$element = $(element);
        this.options = $.extend({}, $.fn.marketCpc.defaults,options);
        this.init();
    }
    
    MarketCpc.prototype = {

        /*
         * data-marketcpc
         */        
        _setOptions : function(){
            this.actId = this.$element.data('marketcpc-actid');
            this.areaId = this.$element.data('marketcpc-areaid');
            this.actPc = this.$element.data('marketcpc-pc') || '';
            this.ptag = this.$element.data('marketcpc-ptag') || '';
            this.actUrl =  this.$element.data('marketcpc-url') || window.location.href.split('?')[0];
            
            
        },

        /*
         * 
         */
        resetData: function(data){
            /*data.img60x60 = data.img120x120.replace('120x120','60x60');
            data.img80x60 = data.img120x120.replace('120x120','80x80');
            data.img300x300 = data.img120x120.replace('120x120','300x300');

            var activePrice = parseInt(data.activityPrice);
            var marketPrice = parseInt(data.oldPrice);
            var price = parseInt(data.newPrice);

            data.activePrice = (activePrice/100).toFixed(2);
            data.marketPrice = (marketPrice/100).toFixed(2);
            data.price = (price/100).toFixed(2);
            data.qq = data.uin;*/
            data.commFullName = data.sItemName;
            data.clickUrl = data.sClickUrl;

           /* data.img60x60 = data.sImg120x120.replace('120x120','60x60');
            data.img80x60 = data.sImg120x120.replace('120x120','80x80');
            data.img200x200 = data.sImg120x120.replace('120x120','200x200');
            data.img300x300 = data.sImg120x120.replace('120x120','300x300');*/
            data.img200x200 = data.sImg;

            var activePrice = parseInt(data.dwActMinPrice);
            var marketPrice = parseInt(data.dwMarketPrice);
            var price = parseInt(data.dwWeChatPrice);

            data.activePrice = ((activePrice/100)*100).toFixed(2);
            data.marketPrice = ((marketPrice/100)*100).toFixed(2);
            data.discount = (activePrice/marketPrice*10).toFixed(1);
            data.price = ((price/100)*100).toFixed(2);
            data.qq = data.uin;

        },

        /*
         * 
         */
        renderTpl : function (reg,tpl, data) {
            tpl = tpl.replace(reg, function(match, key){
                return typeof data[key] !== undefined ? data[key] : '';
            });
            return tpl;
        },


        /*
         * html
         */
        fill : function($areaElem,areaHtml){
            var areaFillMode = $areaElem.attr('data-marketcpc-fill-mode');
            if(this.options.fillMode == 'append'){
                if(!areaFillMode){
                    $areaElem.append('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }else if(areaFillMode == 'append'){
                    $areaElem.append('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }else if(areaFillMode == 'fill'){
                    $areaElem.html('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }
                
            }else if(this.options.fillMode == 'fill'){
                if(areaFillMode == undefined){
                    $areaElem.html('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }else if(areaFillMode == 'append'){
                    $areaElem.append('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }else if(areaFillMode == 'fill'){
                    $areaElem.html('<!--PAT:item-->' + areaHtml + '<!--/PAT:item-->');
                }
            }


        },


        loopTabs : function(loopTpl,data){
            var reg = new RegExp(/\[#([\w\-]+)\#\]/g);
            return this.renderTpl(reg,loopTpl,data);
        },

        loopAreaData : function(data){

            if(this.options.loopAreaBeginCallback !== null  &&  typeof this.options.loopAreaBeginCallback === 'function'){
                this.options.loopAreaBeginCallback(data);
                
            }

            $areaElem = $('[data-marketcpc-areaid="'+ data.areaId +'"]');
            var that = this;
                $areaElem.each(function(index, el) {

                    var $areaElem = $(el);
                    var areaTpl = $areaElem.attr('data-marketcpc-tpl');
                    console.log(areaTpl);
                   // console.log(areaTpl,data);
                    var reg = new RegExp(/{#([\w\-]+)\#}/g);
                    areaTpl =  that.renderTpl(reg,areaTpl,data);

                    var reg2 = new RegExp(/\{loop\}(.*?)\{\/loop\}/);  
                    console.log(areaTpl);
                    reg2Arr = areaTpl.match(reg2);
                    loopTpl = reg2Arr[1];

                    var tabsHtml = '';
                    for(var i in data.tabs){
                        that.resetData(data.tabs[i]);
                        if(that.options.loopTabsCallback !== null  &&  typeof that.options.loopTabsCallback === 'function'){
                            that.options.loopTabsCallback(data.tabs[i]);
                            
                        }
                        tabsHtml += that.loopTabs(loopTpl,data.tabs[i]);
                    }

                    areaHtml = areaTpl.replace(/\{loop\}.*?\{\/loop\}/,tabsHtml);
                    //$areaElem.html(areaTpl);
                    that.fill($areaElem,areaHtml);
                    if(that.options.loopAreaEndCallback !== null  &&  typeof that.options.loopAreaEndCallback === 'function'){
                        that.options.loopAreaEndCallback(data);
                        
                    }







                    
                });








        },

        /*
         * 
         */
        getMarketCpcData : function(){
            var that = this;
            $.ajax({  
                type : 'GET', 
                url : 'http://bases.wanggou.com/mcoss/mmart/show?actid=' + that.actId  + '&areaid=' + that.areaId + '&pc=' + that.actPc + '&ptag=' +that.ptag+ '&t=' + Date.parse(new Date()),
                //url : 'http://express.paipai.com/tws/martcpc/martcpcshow?actid=' + that.actId + '&url=' + encodeURIComponent(that.actUrl) + '&pc=' + that.actPc  + '&t=' + Date.parse(new Date()),  
                dataType : "jsonp", 
                success : function(data){  
                    if(data.errCode == 0){
                        var itemsData = data.data.list;
                        if(itemsData.length == 0) return;
                        var tabsHtml = '';
                        $areaElem = $('[data-marketcpc-areaid="'+ itemsData[0].dwAreaId +'"]');
                        var areaTpl = $areaElem.attr('data-marketcpc-tpl');
                        var reg2 = new RegExp(/\{loop\}(.*?)\{\/loop\}/);  
                        reg2Arr = areaTpl.match(reg2);
                        loopTpl = reg2Arr[1];

                        for(var i in itemsData){
                            that.resetData(itemsData[i]);
                            if(that.options.loopTabsCallback !== null  &&  typeof that.options.loopTabsCallback === 'function'){
                                that.options.loopTabsCallback(itemsData[i]);
                                
                            }
                            tabsHtml += that.loopTabs(loopTpl,itemsData[i]);

                        }
                        $areaElem.html(tabsHtml);
                        if(that.options.renderedCallback !== null  &&  typeof that.options.renderedCallback === 'function'){
                            that.options.renderedCallback();
                        }                        
                    }
                }  
            }); 
        },


        init : function(){

            this._setOptions();
            this.getMarketCpcData();
           
        }
    };

    // JQ
    $.fn.marketCpc = function (options) {
        return this.each(function () {
            var $me = $(this),
                instance = $me.data('marketcpc');
            if(!instance){
                instance = new MarketCpc(this, options);
                $me.data('marketcpc',instance );
            }else{
                instance.init();
            }
            if ($.type(options) === 'string') instance[options]();

        });
    };



    /**
     * 
     */
    $.fn.marketCpc.defaults = {
        fillMode : 'fill',
        renderedCallback : null,
        loopAreaBeginCallback : null,
        loopAreaEndCallback : null,
        loopTabsCallback : null
    };
})(jQuery);

// $('[data-marketcpc-list]').marketCpc({loopTabsCallback: function(data){
//     console.log(data);
// }});

}});;define("mmrp.mod.box.jsonp",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
    	RestApi = require('mmrp.rest');
    	//dataSource = require('./mmrp.mod.datasource');

    	//loadPI = require('./jquery.pp.2014.marketbase_v2');
    
   	require('jquery.ui')($);
   	// 
   	require('jquery.pp.loadpi')($);
   	// COSS-
   	require('jquery.pp.marketcpc')($);
   	var model = {
   		get_success:'#js_gui_suc',
   		mod_setting:"#js_mod_setting",	//
   		api_btn:"#js_api_btn",			//api 
		api_input:"#js_api_input",		//api item id
		api_url_input:'#js_api_url_input'//api url 
		
   	};
   	
   	var page_id = Fun.getUrlParam("page_id"),
		template_id = Fun.getUrlParam("template_id");
   	
   	/**
   	 *  
   	 */
   	var getDataSuccess = function(){
		$(model.get_success).addClass("shown");
		setTimeout(function(){
			$(model.get_success).removeClass("shown");
		}, 1000)
	};
	
	/**
	 * url,URL
	 */
	var changeUrl = function(url,type,mod_id){
		var real_url = parseInt($.trim(url),10) ,
			mod_id = mod_id,								//ID
			url_type = "";									//cgi
		//
		if( $.isNumeric(real_url) ){
			real_url = c.mod_data_api + url_type + "type="+ type +"&modid="+ mod_id +"&pageid="+ page_id +"&itemid="+ url;
		}else{
			real_url = url;
		}
		return real_url;
	};
	
	/**
	 * 
	 * @param {Object} url
	 */
	var getModApiData = function(url,$dom){
		var type = $dom.data("type"),
			data_type = $dom.data('data_type'),
			$box = $dom.find('.js_box:first'),
			mod_id = $box.attr("data-mod-id"),
			api_url = changeUrl(url,type,mod_id);
		
		console.info(api_url,data_type,"api");
		
		$.ajax({
			url:api_url,
			success:function(data){
				if(data){
					console.info('success',data);
					//
					getDataSuccess();
					//
					setModData(data,$dom);
					//api 
					setApiAttr($box,api_url);
					//JS
					LoadJs.loadApiJs($dom);
				};
			}
		});//ajax
	};//getModApiData
	
	
	/**
	 * 
	 * @param {Object} data
	 * @param {Object} $dom
	 * @param {Object} clone
	 */
	var setModData = function(data, $dom){
//		ulog.info(data,"setModData");
		var $box = $dom.find(".js_box:first"),
			id = $dom.attr("id"),							//ID
			mod_itemid = $dom.attr("data-mod-itemid"),		//ID
			tpl = $dom.data("html_template"),
			data_type = parseInt($dom.data("data_type"),10),
			c_html = data_type ?  data : Mustache.to_html(tpl, data);		//data_type0 html  json
		console.info(data_type,'data')
		//
    	//
		$style_input = mod_itemid ? $dom.find(".js_pri_m_"+ mod_itemid) : $dom.find("style.js_pri_"+ id);
        //
        $box.html(c_html);
        //
        $box.prepend($style_input);
		
	};
	
	/**
	 * api url 
	 */
	var setApiAttr = function($box,api_url){
		$box.attr({
			"data-mod-itemid":$(model.api_input).val(),
			"data-mod-api":api_url
		});
	};

	var winOpenByUrl = function(url){
		open(url, "", "toolbar=no,width=900,height=800, directories=no,menubar=no,scrollbars=yes");
	};	

	var randName = function (){
		var name = '_item_' + (new Date() - 0 + '').slice(-8),
			value = window.localStorage.getItem(name);
		if(value){
			return randName();
		}
		return name;
	}

	var handleHandle = function(url){
		//console.log(url);
		$('#js_api_url_input').val(url);
	}

	exports.showApiVal = function($dom){
		var $box = $dom.children(".js_box:first"),
			type = $dom.data('type'),
			pure_id = $dom.attr("id").replace("m_",""),
			item_id = $box.attr("data-mod-itemid") || pure_id,
			mod_id = $box.attr("data-mod-id"),
			mod_api = $box.attr("data-mod-api") || changeUrl(pure_id,type,mod_id);
			
			mod_data_api = $box.find('[data-loadpi-list]').eq(0).attr('data-loadpi-url');
		$(model.api_input).val(item_id);
		$(model.api_url_input).val(mod_data_api);
		console.log(mod_data_api);

		// 
		if($box.attr("data-style-select")){


			var selectedSourceType = $box.attr("data-source-select");
			var $sourceTypeSelect = $('#js_goodsData_type');
			if(selectedSourceType !== undefined){
				$('.js_dataPool_row,.js_dataPool_floor_row').hide();
				$('.js_marketCpc_row,.js_marketCpc_floor_row').show();
				var $marketCpcActInput = $('#js_marketCpc_actId_input'),
						$marketCpcAreaSelect = $('#js_marketCpc_floor_list'),
						$marketCpcNum = $('#js_marketCpc_num_input');;

				$marketCpcActInput.show();
				$marketCpcAreaSelect.show();
				$('#js_poolData_goto,#js_api_btn').hide();
				var selectedActId = $box.attr("data-actid-select");
				var selectedAreaId = $box.attr("data-areaid-select");
				var num = $box.attr('data-mcpc-select');
				$sourceTypeSelect.val(2);
				$marketCpcActInput.val(selectedActId);
				$marketCpcAreaSelect.val(selectedAreaId);
				$marketCpcNum.val(num);
				$('#js_set_18').removeClass('build_setting_item_fold');
			}else{
				$sourceTypeSelect.val(1);
				$('.js_dataPool_row,.js_dataPool_floor_row').show();
				$('.js_marketCpc_row,.js_marketCpc_floor_row').hide();
				$('#js_set_18').removeClass('build_setting_item_fold');				
			}


			var $styleSelect = $('#js_goods_style_select'),
					$fieldSelect = $('#js_goods_field_select');

			$fieldSelect.show();
			var selectedStyle = $box.attr("data-style-select");
			var selectedFieldArr = $box.attr("data-field-select").split(',');


			selectedStyleNode = $('#js_goods_style_select input[name="'+ selectedStyle +'"]');
			selectedStyleNode.parent().addClass('btn-success').siblings().removeClass('btn-success');;
			var chooseMode = selectedStyleNode.attr('data-choose-mode');
			var itemTplId = selectedStyleNode.attr('data-item-tpl-id');
			var choosableArr = selectedStyleNode.attr('data-field-choosable').split(',');

			$fieldSelect.find('input').parent().hide();
			for(var j = 0; j < choosableArr.length; j++){
				console.log(choosableArr[j]);
				var item = $fieldSelect.find('input[data-field-name="'+ choosableArr[j] +'"]');
				if(item.length > 0){
					item.parent().show();
				}
			}


			$fieldSelect.find('input').attr("checked", false);
			for(var i in selectedFieldArr){
				$fieldSelect.find('input[data-field-name="'+ selectedFieldArr[i] +'"]').prop("checked", true);
			}

			if(chooseMode == 'radio'){
				$fieldSelect.data('choose-mode',chooseMode);
			}else{
				$fieldSelect.data('choose-mode',chooseMode);
			}
			$fieldSelect.data('itemtpl-id',itemTplId);

		}










	};




	var Events = {
		/**
		 * url
		 */
		changeUrl:function(){
			$(model.mod_setting).on("input",model.api_input,function(){
				console.info('good')
				var $dom = BoxFun.hasSelect(),								//
					$box = $dom.children(".js_box:first"),					//
					mod_id = $box.attr("data-mod-id"),						//id
					val = $(this).val(),									//id
					type = $dom.data("type");								//

				$box.attr("data-mod-itemid",val);
				$(model.api_url_input).effect("highlight",1000).val( changeUrl(val,type,mod_id) );
			});
		},
		toSelectData : function(){
			$('#js_poolData_goto').on('click', function(event) {
				event.preventDefault();

				var _randName = randName();
			winOpenByUrl("//ppms.wq.jd.com/jdpat/dataPool/item_list.html?varName=" + _randName  );
			timer = setInterval(function(){
				var url = window.localStorage.getItem(_randName);
				if(url){
					clearInterval(timer);
					window.localStorage.removeItem(_randName);
					if(url != 'close'){
						handleHandle(url);
					}
				}
			},10)


			});



		},
		getModData:function(){
			$(model.mod_setting).on('click',model.api_btn,function(){
				var $dom = BoxFun.hasSelect(),
					url = $(model.api_url_input).val();
				$dom.find('[data-loadpi-list]').eq(0).attr('data-loadpi-url',url);
				$("[data-loadpi-list]").loadPI();
				$('[data-marketcpc-list]').marketCpc();
				//getModApiData(url,$dom);

			});
		},


		sourceSelect : function(){
			that = this;
			$('#js_goodsData_type').change(function(){

				var $dom = BoxFun.hasSelect();

				var sourceType = $(this).val();


				switch (sourceType){
					case '1':
						$('.js_marketCpc_row,.js_marketCpc_floor_row').hide();
						$('.js_dataPool_row,.js_dataPool_floor_row').show();


			        $.ajax({
			            type : 'GET',
			            url : '//ppms.wq.jd.com/jdpat/dataPool/php/api.php?act=getPoolPage&size=10&page=1'  + '&t=' + Date.parse(new Date()),
			            dataType : "json",
			            success : function(data){
			            	var data = data.data;
				            	for(var i  in data){
				            		poolOptionHtml = '<option value="'+ data[i].id +'">'+ data[i].name +'</option>';
				            		$('#js_dataPool_list').append(poolOptionHtml);
				            	}
			            	// var areaData = data.activity[0].area;
			            	// console.log(areaData);
			            	// if(areaData.length == 0){
			            	// 	$('#js_marketCpc_floor_list').html('<option value="0"></option>');
			            	// }else{
				            // 	var areaOptionHtml = '';
				            // 	for(var i  in areaData){
				            // 		areaOptionHtml += '<option value="'+ areaData[i].areaId +'">'+ areaData[i].areaName +'</option>';
				            // 	}
				            // 	$('#js_marketCpc_floor_list').html(areaOptionHtml);

				            // 	if($box.attr("data-areaid-select") !==undefined){
				            // 		$('#js_marketCpc_floor_list').val($box.attr("data-areaid-select"));
				            // 	}
			            	// }
			            }
			        });











						// var url = $(model.api_url_input).val();
						// $('#js_marketCpc_actId_input,#js_marketCpc_floor_list,#js_marketCpc_num_input').hide();
						// $('#js_poolData_goto,#js_api_btn').show();
						// var replaceResult = that.switchTpl('dataPool',1);
						// $dom.find('.js_box').eq(0).html(replaceResult.tpl);

						// $dom.find('[data-loadpi-list]').eq(0).attr('data-loadpi-url',url);
						// $("[data-loadpi-list]").loadPI();

						break;
					case '2':
						$('.js_marketCpc_row,.js_marketCpc_floor_row').show();
						$('.js_dataPool_row,.js_dataPool_floor_row').hide();
						var $tplDom = $($('#js_mod_goods_list_tpl_'+ 1).html());
						if($tplDom.attr('data-loadpi-list') !== undefined){
							that.$tplDomClone = $($('#js_mod_goods_list_tpl_'+ 1).html()).clone();
						}


							$('#js_marketCpc_actId_input,#js_marketCpc_floor_list,#js_marketCpc_num_input').show();
							$('#js_poolData_goto,#js_api_btn').hide();

						break;
				}








			});


			$('#js_dataPool_list').on('change', function(event) {
				var poolId = $(this).val();
		        $.ajax({
		            type : 'GET',
		            url : '//ppms.wq.jd.com/jdpat/dataPool/php/api.php?act=getItemsByPoolId&poolId=' + poolId  + '&t=' + Date.parse(new Date()),
		            dataType : "json",
		            success : function(data){
		            	var data = data.data;
			            	for(var i  in data){
			            		itemOptionHtml = '<option value="'+ data[i].url +'">'+ data[i].name +'</option>';
			            		$('#js_dataPool_floor_list').append(itemOptionHtml);
			            	}
		            }
		        });
			});

			$('#js_dataPool_floor_list').on('change', function(event) {
					var $dom = BoxFun.hasSelect(),								//
					$box = $dom.children(".js_box:first");
						var url = $(this).val();
						//$('#js_marketCpc_actId_input,#js_marketCpc_floor_list,#js_marketCpc_num_input').hide();
						//$('#js_poolData_goto,#js_api_btn').show();

						var $dom = BoxFun.hasSelect();
						var areaId = $(this).val();
						if(url !== 0){
							var replaceResult = that.switchTpl('dataPool',1);
							$dom.find('.js_box').attr('data-style-select','goods_list_style1');
							$dom.find('.js_box').attr('data-field-select',replaceResult.fieldSelectedArr.toString());

							// $dom.find('.js_box').attr('data-mcpc-select',$('#js_marketCpc_num_input').val());
							// $dom.find('.js_box').attr('data-source-select',$('#js_goodsData_type').val());
							// $dom.find('.js_box').attr('data-actid-select',$('#js_marketCpc_actId_input').val());
							// $dom.find('.js_box').attr('data-areaid-select',areaId);

							$dom.find('.js_box').eq(0).html(replaceResult.tpl);
						$dom.find('[data-loadpi-list]').eq(0).attr('data-loadpi-url',url);
						$('#js_api_url_input').val(url);
						$("[data-loadpi-list]").loadPI();
						$('#js_set_18').removeClass('build_setting_item_fold');
						}




			});

			this.getMarketCpcByActIdEvent();






		},

		getMarketCpcByActIdEvent : function(){




				$('#js_marketCpc_actId_input').on('blur',function(event) {

					var $dom = BoxFun.hasSelect();
					$box = $dom.children(".js_box:first");
					var actId = $(this).val() !== '' ? $(this).val() : $box.attr("data-actid-select") ;


	        $.ajax({
	            type : 'GET',
	            url : '//express.paipai.com/tws/martcpc/martcpcshow?actid=' + actId  + '&t=' + Date.parse(new Date()),
	            dataType : "jsonp",
	            success : function(data){
	            	console.log('uuuuuuu');
	            	var areaData = data.activity[0].area;
	            	console.log(areaData);
	            	if(areaData.length == 0){
	            		$('#js_marketCpc_floor_list').html('<option value="0"></option>');
	            	}else{
		            	var areaOptionHtml = '';
		            	for(var i  in areaData){
		            		areaOptionHtml += '<option value="'+ areaData[i].areaId +'">'+ areaData[i].areaName +'</option>';
		            	}
		            	$('#js_marketCpc_floor_list').html(areaOptionHtml);

		            	if($box.attr("data-areaid-select") !==undefined){
		            		$('#js_marketCpc_floor_list').val($box.attr("data-areaid-select"));
		            	}
	            	}
	            }
	        });
				});
				this.selectAreaEvent();








		},
		switchTpl : function(type,tplId,areaId){
			var $tplDom = $($('#js_mod_goods_list_tpl_'+ tplId).html());
			console.log($tplDom);
			switch(type){
				case 'dataPool':
					console.log(this.$tplDomClone);
					if(this.$tplDomClone !== undefined){
						console.log('aa');
						$('#js_mod_goods_list_tpl_'+ tplId).html(this.$tplDomClone[0].outerHTML);
					}else{
						console.log('bb',$tplDom);
						$('#js_mod_goods_list_tpl_'+ tplId).html($tplDom[0].outerHTML);
					}
				 	var replaceResult = that.replaceTpl(1,$('#js_api_url_input').val());
				 	return replaceResult;



					break;
				case 'marketCpc':
						console.log($tplDom);
						var $dom = BoxFun.hasSelect();




						if($tplDom.attr('data-loadpi-list') !== undefined){

							if($dom.find('[data-marketcpc-list]').length > 0){
								console.log('uuu');
								$tplDom.attr('data-marketcpc-list','true');
								$tplDom.attr('data-marketcpc-actid',$('#js_marketCpc_actId_input').val());
								$tplDom.attr('data-marketcpc-pc',$('#js_marketCpc_num_input').val());
							}

							if(  $('[data-marketcpc-list]').length < 1){
								$tplDom.attr('data-marketcpc-list','true');
								$tplDom.attr('data-marketcpc-actid',$('#js_marketCpc_actId_input').val());
								$tplDom.attr('data-marketcpc-pc',$('#js_marketCpc_num_input').val());
							}
							$tplDom.attr('data-marketcpc-tpl','{loop}' + $tplDom.attr('data-loadpi-tpl') + '{/loop}');
							$tplDom.removeAttr('data-loadpi-list');
							$tplDom.removeAttr('data-loadpi-url');


							$tplDom.removeAttr('data-loadpi-tpl');

						}else{
							if($('[data-marketcpc-list]').length < 1){
								$tplDom.attr('data-marketcpc-list','true');
								$tplDom.attr('data-marketcpc-actid',$('#js_marketCpc_actId_input').val());
								$tplDom.attr('data-marketcpc-pc',$('#js_marketCpc_num_input').val());
								$tplDom.attr('data-marketcpc-tpl','{loop}' + $tplDom.attr('data-loadpi-tpl') + '{/loop}');
							}

							if($dom.find('[data-marketcpc-list]').length > 0){
								$tplDom.attr('data-marketcpc-list','true');
								$tplDom.attr('data-marketcpc-pc',$('#js_marketCpc_num_input').val());
								$tplDom.attr('data-marketcpc-actid',$('#js_marketCpc_actId_input').val());
							}

						}


						$tplDom.attr('data-marketcpc-areaid',areaId);

						$('#js_mod_goods_list_tpl_'+ tplId).html($tplDom[0].outerHTML);
						var replaceResult = that.replaceTpl(1,areaId);
						piTpl = replaceResult.tpl;
						replaceResult.tpl = piTpl.replace(/\{\#/gi,'[#')
													.replace(/\#\}/gi,'#]')
													.replace(/recmdRegName/gi,'commFullName')
													.replace(/http:\/\/auction1\.paipai\.com\/\[\#id\#\]/gi,'[#clickUrl#]');
						console.log(replaceResult);
						return replaceResult;
					break;
			}



			var $tplDom = $($('#js_mod_goods_list_tpl_'+ tplId).html());
					if($tplDom.attr('data-loadpi-list') !== undefined){

					}


		},
		selectArea : function(tplId,areaId){
					console.log(areaId);
					var areaId = areaId || $('#js_marketCpc_floor_list').val();
					return this.switchTpl('marketCpc',1,areaId);


		},
		selectAreaEvent : function(){
			that = this;
			var that = this;
			$('#js_marketCpc_floor_list').on('change',function(){

				var $dom = BoxFun.hasSelect();
				var areaId = $(this).val();
				if(areaId !== 0){
					var replaceResult = that.selectArea(1,areaId);
					$dom.find('.js_box').attr('data-style-select','goods_list_style1');
					$dom.find('.js_box').attr('data-field-select',replaceResult.fieldSelectedArr.toString());

					$dom.find('.js_box').attr('data-mcpc-select',$('#js_marketCpc_num_input').val());
					$dom.find('.js_box').attr('data-source-select',$('#js_goodsData_type').val());
					$dom.find('.js_box').attr('data-actid-select',$('#js_marketCpc_actId_input').val());
					$dom.find('.js_box').attr('data-areaid-select',areaId);

					$dom.find('.js_box').eq(0).html(replaceResult.tpl);
					$('[data-marketcpc-list]').marketCpc();

				}
			});



		},



		getGoodsStyle : function (){
			var that = this;
			var $styleSelect = $('#js_goods_style_select'),
					$fieldSelect = $('#js_goods_field_select');

			$styleSelect.find('label').on('click',function(event){

				$fieldSelect.show();
				var $dom = BoxFun.hasSelect();


				var $target = $(this),
						$input = $target.find('input'),
						fieldType = $input.attr('data-field-type'),
						fieldDefault = $input.attr('data-field-default'),
						fieldChoosable = $input.attr('data-field-choosable'),
						chooseMode = $input.attr('data-choose-mode'),
						itemTplId = $input.attr('data-item-tpl-id'),
						fieldType = $input.attr('data-field-type'),
						selectedName = $input.attr('name');

					$target.addClass('btn-success').siblings().removeClass('btn-success');


					defaultArr = fieldDefault.split(',');
					choosableArr = fieldChoosable.split(',');


					$fieldSelect.find('input').parent().hide();

					// 
					for(var j in choosableArr){
						var item = $fieldSelect.find('input[data-field-name="'+ choosableArr[j] +'"]');
						if(item.length > 0){
							item.parent().show();
						}
					}

					// 
					$fieldSelect.find('input').attr("checked", false);
					for(var i in defaultArr){
						$fieldSelect.find('input[data-field-name="'+ defaultArr[i] +'"]').prop("checked", true);
					}

					$fieldSelect.data('choose-mode',chooseMode);

					// 
					$fieldSelect.data('itemtpl-id',itemTplId);



					var sourceType = $('#js_goodsData_type').val();
					switch(sourceType){
						case '1':

							var replaceResult = that.replaceTpl(itemTplId,$('#js_api_url_input').val());
							$dom.find('.js_box').eq(0).html(replaceResult.tpl);
							$("[data-loadpi-list]").loadPI();
							break;
						case '2':
							var replaceResult = that.selectArea(itemTplId);
							$dom.find('.js_box').eq(0).html(replaceResult.tpl);
							$('[data-marketcpc-list]').marketCpc({loopTabsCallback: function(data){console.log(data);}});

							break;

					}



					$dom.find('.js_box').attr('data-style-select',selectedName);
					$dom.find('.js_box').attr('data-field-select',replaceResult.fieldSelectedArr.toString());











			});



		},

		replaceTpl : function(itemTplId,sourceVal){
			var $dom = BoxFun.hasSelect();
			var $styleSelect = $('#js_goods_style_select'),
					$fieldSelect = $('#js_goods_field_select');
			var $allFieldSelector = $fieldSelect.find('input[type="checkbox"]');
			var tpl = $('#js_mod_goods_list_tpl_'+ itemTplId).html();
			console.log(tpl);
			tpl = tpl.replace('[data_source][/data_source]',sourceVal);
			var fieldSelectedArr = [];
			for(var k = 0; k < $allFieldSelector.length; k++){
				var search = $allFieldSelector.eq(k).attr('data-replace-searching');
				var replaceTpl = $allFieldSelector.eq(k).attr('data-replace-tpl').replace(/"/gi,"&quot;");
				if($allFieldSelector.eq(k).prop("checked")){
					tpl = tpl.replace(search,replaceTpl);
					fieldSelectedArr.push($allFieldSelector.eq(k).attr('data-field-name'));
				}else{
					tpl = tpl.replace(search,'');
				}
			}
			console.log(tpl);
			return {tpl:tpl,fieldSelectedArr:fieldSelectedArr};

		},

		selectField : function (){
			that = this;
			var $styleSelect = $('#js_goods_style_select'),
					$fieldSelect = $('#js_goods_field_select');

			$fieldSelect.on('click', function(event) {
				var $dom = BoxFun.hasSelect();
				if(event.target.nodeName == 'LABEL' || event.target.nodeName == 'INPUT'){
					var chooseMode = $(this).data('choose-mode');
					var itemTplId = $(this).data('itemtpl-id') || 1;


					if(event.target.nodeName == 'LABEL'){
						$targetInput =  $(event.target).find('input');
					}else if(event.target.nodeName == 'INPUT'){
						$targetInput =  $(event.target)
					}

					var $allFieldSelector = $(this).find('input[type="checkbox"]');

					if(chooseMode == 'radio'){
						$allFieldSelector.attr("checked", false);
						$targetInput.prop("checked", true);
					}


					var sourceType = $('#js_goodsData_type').val();
					switch(sourceType){
						case '1':
						console.log($('#js_dataPool_floor_list').val());
							var replaceResult = that.replaceTpl(itemTplId,$('#js_api_url_input').val());
							$dom.find('.js_box').eq(0).html(replaceResult.tpl);
							$("[data-loadpi-list]").loadPI();
							break;
						case '2':
							var replaceResult = that.selectArea(itemTplId);
							$dom.find('.js_box').eq(0).html(replaceResult.tpl);
							$('[data-marketcpc-list]').marketCpc({loopTabsCallback: function(data){console.log(data);}});

							break;

					}
					console.log(replaceResult);


					$dom.find('.js_box').attr('data-field-select',replaceResult.fieldSelectedArr.toString());









				}
			});



		},
		getModTitle : function(){
			console.log('haha');
		},




		init:function(){
			console.info('initBoxJSON');
			var that = this;
			$(document).on('show.cpanel',function(e,dom,type,data){
				console.log('sdfsddfjlgkjerlktj---------');
				$('#js_set_18,#js_set_10,#js_set_15,#js_set_11,#js_set_16').addClass('build_setting_item_fold');
				var $dom = BoxFun.hasSelect();
				exports.showApiVal($dom);
				that.changeUrl();
				that.getModData();
				that.sourceSelect();
				that.toSelectData();

				that.getGoodsStyle();
				that.selectField();

				that.getModTitle();

			})



		}
	};

	exports.init = function(){
		//Events.init();
		//dataSource.init();
	};
	
})  ;define("mmrp.module.cpanel",function (require, exports, module) {

    var $ = require('jquery'),
        Mustache = require('mustache'),
        BoxAttr = require('mmrp.mod.box.attr'),
        Fun = require('mmrp.func'),
        localStore = require('mmrp.localstore'),
        c = require('mmrp.config.user'),
        BoxJson = require('mmrp.mod.box.jsonp'),
        BoxFun = require('mmrp.mod.box.func');

    require('jquery.field')($);
    require('jquery.contenteditable')($);


    var _activity;

    var $doc = $(document);

    var model = {
        box_container: "#js_act_content",		//Box
        box_panel: "#js_pop_guide",		//
        mod_setting: ".js_mod_setting",	    //
        cancel_btn: "#js_close_panel",	    //
        sumbit_btn: "#js_size_sumbit",	    //
        mod_style: "#js_mod_style",		//
        mod_style_tmpl: '#js_mod_style_tmpl',	//
        box_sets: ".js_setting"			//class
    };

    /**
     * stylepx
     * @param style_obj
     * @param units
     * @returns {{}}
     */
    var addUnitsStyle = function (style_obj, units) {
        var units = (typeof(units) != 'undefined') ? units : "px";
        var new_style_obj = {};
        for (var st in style_obj) {
            //
            if ($.isNumeric(style_obj[st]) && style_obj[st] !== "") {
                new_style_obj[st] = style_obj[st] + units;
            } else {
                new_style_obj[st] = style_obj[st];
            }
        }
        return new_style_obj;
    };

    /**
     * 
     */
    exports.getInputValue = function () {
        var font_weight = $("#js_fontWeight").prop('checked') == true ? "bolder" : "normal",
            text_decoration = $("#js_txtUnderline").prop('checked') == true ? "underline" : "none";

        var style = {
                //
                width: $("#js_width").getValue(),
                height: $("#js_height").getValue(),
                left: $("#js_left_pos").getValue(),
                top: $("#js_top_pos").getValue(),
                overflow: $("input[name='js_txtOverflow']").getValue(),
                //
                color: $("#js_colorNum").val(),								//
                "font-size": $("#js_fontSize").val(),								//
                "line-height": $("#js_lineHeight").val(),								//
                "font-weight": font_weight,
                "font-family": $("#js_font_family").getValue(),						//
                "text-decoration": text_decoration,
                "text-align": $("input[name='js_txtAlign']").getValue(),

                position: "absolute"
            },
            json = {
                class_name: $("#js_class_name").getValue(),
                type: $("#js_type").getValue(),								//
                style: style,													//
                style_unite: addUnitsStyle(style),									//
                url: $.trim($("#js_goAddress").getValue()),							//
                title: $("#js_picUrl").getValue(),
                link_text: $("#js_link_text").getValue(),
                img_url: $("#js_img_url").getValue(),
                iframe_url: $("#js_iframe_url").getValue(),			//iframe url
                link_target: $("#js_link_target").getValue(),			//
                mod_name: $("#js_type_s").text()
            };
        return json;
    };


    /**
     * 
     * @param data
     */
    exports.setInputValue = function (data) {
        var line_height = data.style["line-height"] || "",
            link_target = data.link_target || "_self",
            font_size = data.style["font-size"] || "";

        $("#js_class_name").setValue(data.class_name);
        $("#js_class_name_s").text(data.class_name);
        $("#js_type_s").text(data.mod_name);
        $("#js_type").setValue(data.type);
        $("#js_width").setValue(data.style.width);
        $("#js_height").setValue(data.style.height);
        $("#js_left_pos").setValue(data.style.left);
        $("#js_top_pos").setValue(data.style.top);
        if (data.ismask) {
            $('#J_is_popMsk').prop('checked', true);
            $("#js_goAddress").attr('disabled', 'disabled');
        } else {
            $('#J_is_popMsk').prop('checked', false);
            $('#js_goAddress').removeAttr('disabled');
        }
        $("input[name='js_txtOverflow']").setValue(data.style.overflow);
        //
        $("#js_goAddress").setValue(data.url);
        $("#js_picUrl").setValue(data.title);
        $("#js_link_text").setValue(data.link_text);
        $("#js_link_target").setValue(link_target);
        //
        $("#js_img_url").setValue(data.img_url);
        //iframe
        $("#js_iframe_url").setValue(data.iframe_url);

        $("#js_fontSize").val(font_size);
        $("#js_font_family").setValue(data.style["font-family"]);
        $("#js_lineHeight").val(line_height);

        $("#js_fontWeight").setValue(data.style["font-weight"] || "normal");
        // ulog.info(data.style["font-weight"],'data.style["font-weight"]')
        if (data.style["font-weight"] === "bolder") {
            $("#js_fontWeight").prop("checked", true);
        }
        $("#js_txtUnderline").setValue(data.style["text-decoration"] || "none");
        if (data.style["text-decoration"] === "underline") {
            $("#js_txtUnderline").prop("checked", true);
        }
        $("#js_colorNum").setValue(data.style.color || "");
        $("input[name='js_txtAlign']").setValue(data.style["text-align"] || "inherit");
        //class
        Fun.setInputClass($("input[name='js_link_overflow']:checked"));
        Fun.setInputClass($("input[name='js_text_overflow']:checked"));
//		Fun.setInputClass($("input[name='js_link_target']:checked"));
        Fun.setInputClass($("input[name='js_play_icon']:checked"));
        Fun.setInputClass($("input[name='js_txtAlign']:checked"));
        Fun.setInputClass($("#js_fontWeight"));
        Fun.setInputClass($("#js_txtUnderline"));
    };

    /**
     * Box 
     */
    var boxPanelEvents = function () {
        $(":input", model.mod_setting).on("input.cpanel click.cpanel", function (e) {
            if ($(this).attr('disabled') || $(this).attr('readonly'))
                return;
            var $dom = BoxFun.hasSelect();
            if (!$dom.length) return;
            var jsondata = exports.getInputValue();
            jsondata.url = jsondata.url.replace('http://', '//');
            if(jsondata.url!=""&&jsondata.url.indexOf("//")<0){
                jsondata.url="//"+jsondata.url;
            }
            if(jsondata.url!=""&&Fun.is_pop_shop()){
                //http://item.jd.com/2099122.html
                var reg = /^\/\/(wq.jd.com\/item\/view\?sku=.*$|item.jd.com\/\d*\.html$|item.m.jd.com\/.*$)/i;
                if(reg.test(jsondata.url)) {

                    if (_activity != "" && Fun.toWDTab5.indexOf(_activity) === -1) {
                        alert("");
                        $("#js_goAddress").val("");
                        jsondata.url = "javascript:;";
                    }else{
                        //PCM
                        var regPC = /^\/\/item.jd.com\/\d*\.html$/i;
                        var regM = /^\/\/item.m.jd.com\/product\/\d*.html$/i;
                        if(regPC.test(jsondata.url)){//PC
                            var skuid = parseInt(jsondata.url.replace("//item.jd.com/",""));
                            jsondata.url = "//wq.jd.com/item/view?sku="+skuid;
                        }else if(regM.test(jsondata.url)){//M
                            jsondata.url = "//wq.jd.com/item/view?sku="+parseInt(jsondata.url.replace("//item.m.jd.com/product/",""));
                        }
                    }
                }
            }
            BoxAttr.setAttr($dom, jsondata);
            Fun.setInputClass($(e.target));
            //console.info('gggg')
        });
        $("#js_goAddress").on("blur",function(){
            var url = $("#js_goAddress").val().replace(/^http:/, '');
            if (url != null && url != "") {
                if(url.indexOf("//")<0){
                    url = "//"+url;
                }
                if(!Fun.is_JD_QQ_url(url)){
                    var _name = $("#js_class_name").val();
                    $("#"+_name+" > .js_box").attr("data-url","");
                    $("#"+_name+" > .js_box").children("a").attr("href","");
                    alert('Q');
                    $("#js_goAddress").val("");
                }
            }
        });
        //Box
//		$(model.box_panel).draggable();

        //
//		$(model.cancel_btn).on("click.cpanel",function(){
//			var $dom = BoxFun.hasSelect();
//			//$dom
//			BoxAttr.setAttr($dom, exports.getInputValue());
//			//
//			BoxFun.disabledEdit($dom);
//			//
//			exports.hidePanel();
//			//
//			replaceLink($dom);
//			return false;
//		});

    };


    /**
     * 
     * @param {JQ Object} $a:jq
     */
    var replaceLink = function ($dom) {
        if ($dom.data("type") === "base_p") {
            $("a[href^='javascript']", $dom).each(function () {
                var $a = $(this),
                    href = $a.attr("href"),
                    _link = href.match(/javascript:window.open\('([^']+)/)[1];
                $a.attr({
                    "href": _link,
                    "target": "_blank"
                });
            })
        }
    };


    /**
     * 
     */
    exports.hidePanel = function () {
        $(model.box_panel).removeClass('build_bar_open').trigger('hide');
        $doc.trigger('hide.cpanel')
    };

    /**
     * 
     * @param {Object} values
     */
    var setStyleData = function (values) {
        var tpl = $(model.mod_style_tmpl).html(),
            c_html = Mustache.to_html(tpl, values);
        $(model.mod_style).html(c_html);
    };

    var showSwitchClass = function (switch_data) {
        var data = JSON.parse(switch_data);
        if (data.data[0]['group'].length) {
            var tpl = $('#js_switch_template').html(),
                html = Mustache.to_html(tpl, data);
            $('#js_mod_switch').html(html);
        }
    };


    /**
     * 
     */
    var resetModStyleForm = function () {
        $(":input", model.mod_style).clearForm();
    };

    var getSettings = function (id) {
        if (id == 20) {
            var name = $('#js_class_name').val();
            var title = $('#' + name).find('.mod_title_l').html();
            var desc = $('#' + name).find('.mod_title_r').html();
            $('#js_marketCpc_actTitle').val(title);
            $('#js_marketCpc_actDec').val(desc);

            if ($('#' + name + ' .js_mod_title').hasClass('hasborder')) {

                $('#js_marketCpc_isunderline').prop("checked", true);
            } else {
                $('#js_marketCpc_isunderline').prop("checked", false);

            }

        }
        if (id == 23) {
            var name = $('#js_class_name').val();
            var offset = $('#' + name).offset();
            var left = parseInt($('#' + name).css('left'));
            var top = parseInt($('#' + name).css('top'));
            var width = $('#' + name).width();
            var height = $('#' + name).height();
            $('#J_wapper_width').val(width);
            $('#J_wapper_height').val(height);
            $('#J_wapper_left').val(left);
            $('#J_wapper_top').val(top);
        }
        if (id == 6) {
            var name = $('#js_class_name').val();
            var _val = $('#' + name + ' #J_mask b').html();
            $('#js_shareText').val(_val);
        }
    }

    /**
     * 
     */
    var showPanelSetting = function (setting_config, box_id) {
        var id_pix = 'js_set_';
        $(model.box_sets).hide();

        setting_config.forEach(function(v){
            var id = v.id,
                name = v.name,
                module = v.module,
                $panel = $('#' + id_pix + id);

            module && require.async('./' + module, function(Setting){
                Setting.init({"id": box_id});
            });
            name && $panel.find('legend').text(name);
            $panel.show();
            getSettings(id);
        });
    };

    /**
     * 
     * data:$dom 
     */
    var setPanelPosotion = function (data) {
        //TODO 
        //$(model.box_container)[0].opos || BoxFun.setParentOffset(true);
        var ops = $(model.box_container)[0].opos,			//
            page_width = $(document).width(),			//
            page_height = $(document).height(),			//
            pop_width = 620,							//
            box_width = data.style.width,				//box
            left = ops[0] + parseInt(data.style.left, 10) + parseInt(box_width, 10) + 20, 		  //
            top = ops[1] + parseInt(data.style.top, 10) - 250,									 //
            change = page_width - left;
        console.info(left, change, ops, data.style, box_width)
        //
        if (top < 0) {
            top = 100;
        }
        //
        if (change < pop_width) {
            left = ops[0] + parseInt(data.style.left, 10) - 650;
            if (left <= 0) {
                left = Math.abs(left);
            }
        }
        ;
        $(model.box_panel).css({left: left, top: top}).show();
    };

    /**
     * 
     * @param {Object} $dom
     */
    exports.showPanel = function ($dom) {
        if (!$dom) return;
        var dom_id = $dom.attr("id"),
            data = BoxAttr.getAttr($dom),
            $box = $dom.find(".js_box:first"),
            type = $dom.data("type"),
            mod_id = $box.attr("data-mod-id"),
            setting_config = JSON.parse($dom.data('mod_setting')),
            setting_switch = $dom.data('mod_switch_class'),
            style_class_name = $box.attr("data-pri-style") ? ("js_" + $box.attr("data-pri-style")) : ("js_pri_" + dom_id),
            style_josn = JSON.parse($(model.box_container).find("input." + style_class_name).val() || '{}');

        exports.setInputValue(data);
        //
//		setPanelPosotion(data);
        //
        style_josn && setStyleData(style_josn);
        //api
        BoxJson.showApiVal($dom);
        //
        setting_config && showPanelSetting(setting_config, data.class_name);
        //
        setSettingByType(type);
        //
        setting_switch && showSwitchClass(setting_switch);
        //show
        $(model.box_panel).addClass('build_bar_open');
        $doc.trigger('show.cpanel', [$dom, type, data]);
    };

    /***
     * 
     */
    var setSettingByType = function (type) {
        if(!_activity){
            try{
                _activity = localStore.getPageDataById(Fun.getUrlParam("id")).data.value.page_url_name;
            } catch(e){
                _activity = '';
            }
        }

        switch (type) {
            case 'base_poster':
                if ( _activity == "" || Fun.toWDTab5.indexOf(_activity) !== -1) {
                    //
                    $("#js_set_4").show();
                } else {
                    //
                    $("#js_set_4").hide();
                }
                break;
            case 'base_link':
                if(Fun.toWDTab3.indexOf(_activity) !== -1 || Fun.toWDTab5.indexOf(_activity) !== -1){
                    //
                    $("#J_is_popMsk").prop('checked', false).attr("disabled",true);
                }else{
                    $("#J_is_popMsk").attr("disabled",false);
                }
                break;
        }
    };

    /**
     * class
     * @param {Object} sclass : 
     * @param {Object} oldclass
     */
    var switchClass = function (addclass, removeclass) {
        var $dom = BoxFun.hasSelect(),
            $mod = $dom.children(".js_box").first().children(),
            aclass = addclass, rclass = removeclass;
        $mod.removeClass(rclass).addClass(aclass);
    };

    var Events = {
        imgTab: function () {
            /**
             * tabs
             */
            $("#js_set_5").on("click.tabs", 'a', function () {
                var $this = $(this),
                    id = $this.attr("href");
                $('.pic_selected_type').removeClass('selected');
                $this.addClass("selected");
                $(id).show().siblings(".js_u_tab").hide();
                return false;
            });
        },
        /**
         * Tab
         * //page
         */
        uploadImg: function () {
            var page_id = Fun.getUrlParam("id"),
                path = Fun.getUoloadsrc('img');
            if (page_id == '') return;
            $("#js_drop_img_bg input").on("change", function (e) {
                var file = e.currentTarget.files[0];
                if(file==null) return;
                var params = {};
                params.url = c.root + "php/wx_cut_img.php?g_tk="+Fun.$getToken();
                params.type = "post";
                params.dataType = "json";
                params.xhrFields = {withCredentials: true};
                params.processData = false;
                params.contentType = false;
                var formData = new FormData();
                formData.append("file", file);
                formData.append("folder",Fun.getUoloadsrc('img'));
                formData.append("filename",file.name);
                params.data = formData;
                params.success = function (data) {
                    if(data==null||data.data==null||data.data.length<0){
                        alert("");
                        return;
                    }
                    if(data.data[0].errorCode==10){
                        alert(data.data[0].errorMsg);
                        return;
                    }

                    var tpl = $("#js_upload_img_template").html();
                    var html = '<ul>';
                    var width=0,height=0;
                    for(var i=0;i<data.data.length;i++){
                        if(data.data[i].width>width){
                            width = data.data[i].width;
                        }
                        height+=data.data[i].height;
                        html+='<li style="height:'+data.data[i].height+'px;"><img src="'+data.data[i].filepath+'" style="width:100%;height:'+ data.data[i].height+ 'px;"></li>';
                    }
                    html+="</ul>";
                    var _name = $('#js_class_name').val();
                    $("#"+_name).css("width",width);
                    $("#"+_name).css("height",height);
                    $("#"+_name+" .mmrp_mod_poster").html(html);
                };
                params.error = function (ret) {
                    alert("");
                };
                $.ajax(params);
                $("#js_drop_img_bg input").val("");
            });
        },
        /**
         *   
         */
        appendRemoveDataEvent: function () {
            //
            $(model.box_panel).on('click.add', "#js_append_data_btn", function () {
                var $dom = BoxFun.hasSelect(),
                    $clone = $dom.find(".js_clone:first").length ? $dom.find(".js_clone:first") : $dom.find("li:first");
                $clone.after($clone.clone())
            });
            //
            $(model.box_panel).on('click.del', "#js_remove_data_btn", function () {
                var $dom = BoxFun.hasSelect(),
                    $clone = $dom.find(".js_clone:first").length ? $dom.find(".js_clone:first") : $dom.find("li:first");
                $clone.next().remove();
            });
        },

        /***
         * 
         */
        switchClassEvent: function () {
            $("#js_mod_switch").on("change.switchclass", 'input[type="radio"]', function (e) {
                var $this = $(this),
                    r_class = $this.attr("data-remove-class") || "",
                    a_class = $this.attr("data-add-class") || ""; //class
                switchClass(a_class, r_class);
                Fun.setInputClass($this);
            });
        },

        /**
         * panel
         */
        toggleBuildBar: function () {
            $('#J_buildBarBtn').on('click', function () {
                exports.hidePanel();
            })
        },

        /**
         * 
         */
        toggleModCnt: function () {
            $(model.box_panel).on('click', '.build_setting_tit', function () {
                $(this).closest('.build_setting_item').toggleClass('build_setting_item_fold')
            })
        },

        /**
         * tab
         */
        switchTab: function(){
            $(model.box_panel).on('click', '.build_setting_tab .item', function(){
                var activeClass = 'item_current';
                var $this = $(this);
                var $tab = $(this).closest('.build_setting_tab');
                var $tab_panel = $tab.next('.build_setting_tab_panel');
                var index = $this.index();

                $tab.find('.item').removeClass(activeClass);
                $this.addClass(activeClass);
                $tab_panel.find('.item')
                    .removeClass('item_current')
                    .eq(index).addClass(activeClass);
            });
        },

        /**
         * 
         */
        trigger: function () {
            $(document).on('remove.box', function () {
                exports.hidePanel();
            })
        },

        titleSettings: function () {
            $("#J_submit_subject").on('click', function (e) {
                var _tit = $("#js_marketCpc_actTitle").val();
                var _dsc = $("#js_marketCpc_actDec").val();
                var _id = $('#js_class_name').val();
                var $l_title = $('#' + _id).find('.mod_title_l');
                var $r_title = $('#' + _id).find('.mod_title_r');
                $l_title.html(_tit);
                $r_title.html(_dsc);
                exports.hidePanel();
            });

            $("#js_marketCpc_isunderline").on('change', function (e) {
                var _id = $('#js_class_name').val();
                var solid = '1px solid #ccc';
                if ($(this).is(":checked")) {
                    $('#' + _id).find('.js_mod_title').addClass('hasborder');
                } else {
                    $('#' + _id).find('.js_mod_title').removeClass('hasborder');
                }
            });

            $("#js_marketCpc_splitColor").on('change', function (e) {
                var _id = $('#js_class_name').val();
                //if(event.keyCode ==13){
                var color = $('#js_marketCpc_splitColor').val();
                $('#' + _id).find('.js_mod_split').css({'background-color': color});
                $('#' + _id).find('.js_mod_split').attr("data-color",color);
                //}
            })
        },
        weitiao: function () {
            var name = $('#js_class_name').val();
        },
        sharpSetting: function () {


        },
        changeUrl: function () {
            $('#js_img_url').on('change', function (e) {
                var _name = $('#js_class_name').val();
                $('#' + _name + ' .js_box .m_img').attr('src', $(this).val());
            });
        },
        init: function () {
            this.imgTab();

//			this.appendRemoveDataEvent();
            this.switchClassEvent();
            this.toggleBuildBar();
            this.toggleModCnt();
            this.switchTab();
            this.trigger();
            this.titleSettings();
            this.weitiao();
            this.sharpSetting();
            var self = this;
            setTimeout(function () {
                self.uploadImg();
            }, 2000);
            this.changeUrl();
        }

    };
    var goodsPrice = function(){
        var loading=false;
        $("#J_goodsPriceSave_id").on("click",function(){
            var skuid = $.trim($("#J_goodsQueryPriceSku_id").val());
            if(!skuid||loading) return;
            loading = true;
            var mid=$("#js_class_name").val();
            $("#"+mid).find(".goodsP").attr("data-skuid",skuid);
            $("#J_goodsPriceStyle").trigger("change");
            $("#J_goodsPriceFontSize").trigger("change");
            $("#J_goodsPriceFontColor").trigger("change");
            $.ajax({
                url:'//pe.3.cn/prices/pcpmgets',
                data:{skuids:skuid , origin:5 , source:"wxsq"},
                dataType:'jsonp',
                success:function(json){
                    loading = false;
                    if(json){
                        if(json&&json.length){
                            $("#"+mid).find(".goodsP").find("strong").html(json[0].p>0?parseFloat(json[0].p):"");
                            $("#"+mid).find(".goodsP")[0].className="goodsP goodsP-"+skuid;
                        }
                    }else{
                        console.error('',skuid);
                    }
                },
                error:function(){
                    loading = false;
                    console.error('error',skuid);
                }
            });
        });
        $("#J_goodsPriceStyle").on("change",function(){
            var style = $(this).val();
            $("#J_goodsPriceStyle").val(style);
            var mid=$("#js_class_name").val();
            var str = $("#"+mid).find("strong").html();
            if(style==1){
                $("#"+mid).find(".goodsP").html('<strong>'+str+'</strong>');
            }else if(style==2){
                $("#"+mid).find(".goodsP").html('<strong>'+str+'</strong>');
            }else if(style==3){
                $("#"+mid).find(".goodsP").html('<strong>'+str+'</strong>RMB');
            }else if(style==4){
                $("#"+mid).find(".goodsP").html('RMB<strong>'+str+'</strong>');
            }
            $("#"+mid).find(".goodsP").attr("data-style",style);
        });
        $("#J_goodsPriceFontSize").on("change",function(){
            var size = $(this).val();
            var mid=$("#js_class_name").val();
            $("#"+mid).find(".goodsP").css("font-size",size+"px");
            $("#"+mid).find(".goodsP").attr("data-size",size);
        });
        $("#J_goodsPriceFontColor").on("change",function(){
            var color = $(this).val();
            var mid=$("#js_class_name").val();
            $("#"+mid).find(".goodsP").css("color",color);
            $("#"+mid).find(".goodsP").attr("data-color",color);
        });
    }
    var initGoodsPrice = function(dom){
        var domId = $(dom).attr("id");
        var goodsprice = $('#' + domId+" .goodsP");
        var skuid = goodsprice.attr("data-skuid");
        var style = goodsprice.attr("data-style");
        var size = goodsprice.attr("data-size");
        var color = goodsprice.attr("data-color");

        skuid&&$("#J_goodsQueryPriceSku_id").val(skuid);
        style&&$("#J_goodsPriceStyle option[value="+style+"]").prop("selected",true);
        size&&$("#J_goodsPriceFontSize").val(size);
        color&&$("#J_goodsPriceFontColor").val(color);
    }

    var addListener = function(){
        $(document).on('show.cpanel', function (e, dom, type, data) {
            if (type == "mod_split") {
                var color = $(dom).find(".js_mod_split").eq(0).attr("data-color");
                if(color!=null)
                    $("#js_marketCpc_splitColor").val(color);
            }else if(type == "mod_goods_price"){
                initGoodsPrice(dom);
            }
        });

        $(document).on('setting.reset', function (e, event_type) {
            var Handler = {
                'layoutChange': function(){
                    //clear 
                    $(".activeArea").text('')
                        .removeAttr("data-area_busness")
                        .removeAttr("data-area_project")
                        .removeAttr("data-area_activity")
                        .removeAttr("data-area_area");
                },
                'activityChange': function(activity){
                    _activity = activity;
                }
            };

            Handler[event_type].apply(null, Array.prototype.slice.call(arguments, 2));
        });
    }
    /**
     * 
     */
    exports.init = function () {
        boxPanelEvents();
        Events.init();
        goodsPrice();
        addListener();
        //
        $("body").fresheditor();
    };

});;/**
 * @preserve jQuery DateTimePicker plugin v2.1.9
 * @homepage http://xdsoft.net/jqplugins/datetimepicker/
 * (c) 2014, Chupurnov Valeriy.
 */
(function( $ ) {
	'use strict'
	var default_options  = {
		i18n:{
			ru:{ // Russian
				months:[
					'','','','','','','','','','','',''
				],
				dayOfWeek:[
					"", "", "", "", "", "", ""
				]
			},
			en:{ // English
				months: [
					"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
				],
				dayOfWeek: [
					"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"
				]
			},
			de:{ // German
				months:[
					'Januar','Februar','Mrz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'
				],
				dayOfWeek:[
					"So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"
				]
			},
			nl:{ // Dutch
				months:[
					"januari", "februari", "maart", "april", "mei", "juni", "juli", "augustus", "september", "oktober", "november", "december"
				],
				dayOfWeek:[
					"zo", "ma", "di", "wo", "do", "vr", "za"
				]
			},
			tr:{ // Turkish
				months:[
					"Ocak", "ubat", "Mart", "Nisan", "Mays", "Haziran", "Temmuz", "Austos", "Eyll", "Ekim", "Kasm", "Aralk"
				],
				dayOfWeek:[
					"Paz", "Pts", "Sal", "ar", "Per", "Cum", "Cts"
				]
			},
			fr:{ //French
				months:[
			    "Janvier", "Fvrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Aot", "Septembre", "Octobre", "Novembre", "Dcembre"
				],
				dayOfWeek:[
					"Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"
				]
			},
			es:{ // Spanish
				months: [
					"Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
				],
				dayOfWeek: [
					"Dom", "Lun", "Mar", "Mi", "Jue", "Vie", "Sb"
				]
			},
			th:{ // Thai
				months:[
					'','','','','','','','','','','',''
				],
				dayOfWeek:[
					'.','.','.','.','.','.','.'
				]
			},
			pl:{ // Polish
				months: [
					"stycze", "luty", "marzec", "kwiecie", "maj", "czerwiec", "lipiec", "sierpie", "wrzesie", "padziernik", "listopad", "grudzie"
				],
				dayOfWeek: [
					"nd", "pn", "wt", "r", "cz", "pt", "sb"
				]
			},
			pt:{ // Portuguese
				months: [
					"Janeiro", "Fevereiro", "Maro", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
				],
				dayOfWeek: [
					"Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"
				]
			},
			ch:{ // Simplified Chinese
				months: [
					"","","","","","","","","","","",""
				],
				dayOfWeek: [
					"", "","","","","",""
				]
			},
			se:{ // Swedish
				months: [
					"Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September","Oktober", "November", "December"
				],
				dayOfWeek: [
					"Sn", "Mn", "Tis", "Ons", "Tor", "Fre", "Lr"
				]
			},
			kr:{ // Korean
				months: [
                    "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"
				],
				dayOfWeek: [
                    "", "", "", "", "", "", ""
				]
			},
			it:{ // Italian
				months: [
					"Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
				],
				dayOfWeek: [
					"Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"
				]
			}
		},
		value:'',
		lang:'en',
		format:'Y/m/d H:i',
		formatTime:'H:i',
		formatDate:'Y/m/d',
		step:60,
		closeOnDateSelect:0,
		closeOnWithoutClick:true,
		timepicker:true,
		datepicker:true,
		minDate:false,
		maxDate:false,
		minTime:false,
		maxTime:false,
		allowTimes:[],
		opened:false,
		inline:false,
		onSelectDate:function() {},
		onSelectTime:function() {},
		onChangeMonth:function() {},
		onChangeDateTime:function() {},
		onShow:function() {},
		onClose:function() {},
		onGenerate:function() {},
		withoutCopyright:true,
		inverseButton:false,
		hours12:false,
		next:	'xdsoft_next',
		prev : 'xdsoft_prev',
		dayOfWeekStart:0,
		timeHeightInTimePicker:25,
		timepickerScrollbar:true,
		todayButton:true, // 2.1.0
		defaultSelect:true, // 2.1.0
		scrollMonth:true,
		scrollTime:true,
		scrollInput:true,
		mask:false,
		validateOnBlur:true,
		allowBlank:false,
		yearStart:1950,
		yearEnd:2050,
		style:'',
		id:'',
		roundTime:'round', // ceil, floor
		className:'',
		weekends	: 	[],
		yearOffset:0
	};
	// fix for ie8
	if ( !Array.prototype.indexOf ) {
		Array.prototype.indexOf = function(obj, start) {
			 for (var i = (start || 0), j = this.length; i < j; i++) {
				 if (this[i] === obj) { return i; }
			 }
			 return -1;
		}
	};
	$.fn.xdsoftScroller = function( _percent ) {
		return this.each(function() {
			var timeboxparent = $(this);
			if( !$(this).hasClass('xdsoft_scroller_box') ) {
				var pointerEventToXY = function( e ) {
						var out = {x:0, y:0};
						if( e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel' ) {
							var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
							out.x = touch.pageX;
							out.y = touch.pageY;
						}else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover'|| e.type=='mouseout' || e.type=='mouseenter' || e.type=='mouseleave') {
							out.x = e.pageX;
							out.y = e.pageY;
						}
						return out;
					},
					move = 0,
					timebox = timeboxparent.children().eq(0),
					parentHeight = timeboxparent[0].clientHeight,
					height = timebox[0].offsetHeight,
					scrollbar = $('<div class="xdsoft_scrollbar"></div>'),
					scroller = $('<div class="xdsoft_scroller"></div>'),
					maximumOffset = 100,
					start = false;

				scrollbar.append(scroller);

				timeboxparent.addClass('xdsoft_scroller_box').append(scrollbar);
				scroller.on('mousedown.xdsoft_scroller',function ( event ) {
					if( !parentHeight )
						timeboxparent.trigger('resize_scroll.xdsoft_scroller',[_percent]);
					var pageY = event.pageY,
						top = parseInt(scroller.css('margin-top')),
						h1 = scrollbar[0].offsetHeight;
					$(document.body).addClass('xdsoft_noselect');
					$([document.body,window]).on('mouseup.xdsoft_scroller',function arguments_callee() {
						$([document.body,window]).off('mouseup.xdsoft_scroller',arguments_callee)
							.off('mousemove.xdsoft_scroller',move)
							.removeClass('xdsoft_noselect');
					});
					$(document.body).on('mousemove.xdsoft_scroller',move = function(event) {
						var offset = event.pageY-pageY+top;
						if( offset<0 )
							offset = 0;
						if( offset+scroller[0].offsetHeight>h1 )
							offset = h1-scroller[0].offsetHeight;
						timeboxparent.trigger('scroll_element.xdsoft_scroller',[maximumOffset?offset/maximumOffset:0]);
					});
				});

				timeboxparent
					.on('scroll_element.xdsoft_scroller',function( event,percent ) {
						if( !parentHeight )
							timeboxparent.trigger('resize_scroll.xdsoft_scroller',[percent,true]);
						percent = percent>1?1:(percent<0||isNaN(percent))?0:percent;
						scroller.css('margin-top',maximumOffset*percent);
						timebox.css('marginTop',-parseInt((height-parentHeight)*percent))
					})
					.on('resize_scroll.xdsoft_scroller',function( event,_percent,noTriggerScroll ) {
						parentHeight = timeboxparent[0].clientHeight;
						height = timebox[0].offsetHeight;
						var percent = parentHeight/height,
							sh = percent*scrollbar[0].offsetHeight;
						if( percent>1 )
							scroller.hide();
						else{
							scroller.show();
							scroller.css('height',parseInt(sh>10?sh:10));
							maximumOffset = scrollbar[0].offsetHeight-scroller[0].offsetHeight;
							if( noTriggerScroll!==true )
								timeboxparent.trigger('scroll_element.xdsoft_scroller',[_percent?_percent:Math.abs(parseInt(timebox.css('marginTop')))/(height-parentHeight)]);
						}
					});
				timeboxparent.mousewheel&&timeboxparent.mousewheel(function(event, delta, deltaX, deltaY) {
					var top = Math.abs(parseInt(timebox.css('marginTop')));
					timeboxparent.trigger('scroll_element.xdsoft_scroller',[(top-delta*20)/(height-parentHeight)]);
					event.stopPropagation();
					return false;
				});
				timeboxparent.on('touchstart',function( event ) {
					start = pointerEventToXY(event);
				});
				timeboxparent.on('touchmove',function( event ) {
					if( start ) {
						var coord = pointerEventToXY(event), top = Math.abs(parseInt(timebox.css('marginTop')));
						timeboxparent.trigger('scroll_element.xdsoft_scroller',[(top-(coord.y-start.y))/(height-parentHeight)]);
						event.stopPropagation();
						event.preventDefault();
					};
				});
				timeboxparent.on('touchend touchcancel',function( event ) {
					start = false;
				});
			}
			timeboxparent.trigger('resize_scroll.xdsoft_scroller',[_percent]);
		});
	};
	$.fn.datetimepicker = function( opt ) {
		var KEY0 = 48,
			KEY9 = 57,
			_KEY0 = 96,
			_KEY9 = 105,
			CTRLKEY = 17,
			DEL = 46,
			ENTER = 13,
			ESC = 27,
			BACKSPACE = 8,
			ARROWLEFT = 37,
			ARROWUP = 38,
			ARROWRIGHT = 39,
			ARROWDOWN = 40,
			TAB = 9,
			F5 = 116,
			AKEY = 65,
			CKEY = 67,
			VKEY = 86,
			ZKEY = 90,
			YKEY = 89,
			ctrlDown	=	false,
			options = ($.isPlainObject(opt)||!opt)?$.extend(true,{},default_options,opt):$.extend({},default_options),
			createDateTimePicker = function( input ) {
				var datetimepicker = $('<div '+(options.id?'id="'+options.id+'"':'')+' '+(options.style?'style="'+options.style+'"':'')+' class="xdsoft_datetimepicker xdsoft_noselect '+options.className+'"></div>'),
					xdsoft_copyright = $('<div class="xdsoft_copyright"><a target="_blank" href="http://xdsoft.net/jqplugins/datetimepicker/">xdsoft.net</a></div>'),
					datepicker = $('<div class="xdsoft_datepicker active"></div>'),
					mounth_picker = $('<div class="xdsoft_mounthpicker"><button type="button" class="xdsoft_prev"></button><button type="button" class="xdsoft_today_button"></button><div class="xdsoft_label xdsoft_month"><span></span></div><div class="xdsoft_label xdsoft_year"><span></span></div><button type="button" class="xdsoft_next"></button></div>'),
					calendar = $('<div class="xdsoft_calendar"></div>'),
					timepicker = $('<div class="xdsoft_timepicker active"><button type="button" class="xdsoft_prev"></button><div class="xdsoft_time_box"></div><button type="button" class="xdsoft_next"></button></div>'),
					timeboxparent = timepicker.find('.xdsoft_time_box').eq(0),
					timebox = $('<div class="xdsoft_time_variant"></div>'),
					scrollbar = $('<div class="xdsoft_scrollbar"></div>'),
					scroller = $('<div class="xdsoft_scroller"></div>'),
					monthselect =$('<div class="xdsoft_select xdsoft_monthselect"><div></div></div>'),
					yearselect =$('<div class="xdsoft_select xdsoft_yearselect"><div></div></div>');

				//constructor lego
				mounth_picker
					.find('.xdsoft_month span')
						.after(monthselect);
				mounth_picker
					.find('.xdsoft_year span')
						.after(yearselect);

				mounth_picker
					.find('.xdsoft_month,.xdsoft_year')
						.on('mousedown.xdsoft',function(event) {
							mounth_picker
								.find('.xdsoft_select')
									.hide();
							var select = $(this).find('.xdsoft_select').eq(0),
								val = 0,
								top = 0;

							if( _xdsoft_datetime.currentTime )
								val = _xdsoft_datetime.currentTime[$(this).hasClass('xdsoft_month')?'getMonth':'getFullYear']();

							select.show();
							for(var items = select.find('div.xdsoft_option'),i = 0;i<items.length;i++) {
								if( items.eq(i).data('value')==val ) {
									break;
								}else top+=items[0].offsetHeight;
							}

							select.xdsoftScroller(top/(select.children()[0].offsetHeight-(select[0].clientHeight)));
							event.stopPropagation();
							return false;
						});

				mounth_picker
					.find('.xdsoft_select')
						.xdsoftScroller()
						.on('mousedown.xdsoft',function( event ) {
							event.stopPropagation();
							event.preventDefault();
						})
						.on('mousedown.xdsoft','.xdsoft_option',function( event ) {
							if( _xdsoft_datetime&&_xdsoft_datetime.currentTime )
								_xdsoft_datetime.currentTime[$(this).parent().parent().hasClass('xdsoft_monthselect')?'setMonth':'setFullYear']($(this).data('value'));
							$(this).parent().parent().hide();
							datetimepicker.trigger('xchange.xdsoft');
							options.onChangeMonth&&options.onChangeMonth.call&&options.onChangeMonth.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						});


				// set options
				datetimepicker.setOptions = function( _options ) {
					options = $.extend(true,{},options,_options);
					if( (options.open||options.opened)&&(!options.inline) ) {
						input.trigger('open.xdsoft');
					}

					if( options.inline ) {
						datetimepicker.addClass('xdsoft_inline');
						input.after(datetimepicker).hide();
						datetimepicker.trigger('afterOpen.xdsoft');
					}

					if( options.inverseButton ) {
						options.next = 'xdsoft_prev';
						options.prev = 'xdsoft_next';
					}

					if( options.datepicker )
						datepicker.addClass('active');
					else
						datepicker.removeClass('active');
						
					if( options.timepicker )
						timepicker.addClass('active');
					else
						timepicker.removeClass('active');

					if( options.value ){
						input&&input.val&&input.val(options.value);
						_xdsoft_datetime.setCurrentTime(options.value);
					}

					if( isNaN(options.dayOfWeekStart)||parseInt(options.dayOfWeekStart)<0||parseInt(options.dayOfWeekStart)>6 )
						options.dayOfWeekStart = 0;
					else
						options.dayOfWeekStart = parseInt(options.dayOfWeekStart);

					if( !options.timepickerScrollbar )
						scrollbar.hide();

					var tmpDate = [],timeOffset;
					if( options.minDate && ( tmpDate = /^-(.*)$/.exec(options.minDate) ) && (tmpDate=Date.parseDate(tmpDate[1], options.formatDate)) ) {
						timeOffset = tmpDate.getTime()+-1*(tmpDate.getTimezoneOffset())*60000;
						options.minDate = new Date((_xdsoft_datetime.now()).getTime()-timeOffset).dateFormat( options.formatDate );
					}
					if( options.maxDate && ( tmpDate = /^\+(.*)$/.exec(options.maxDate) ) && (tmpDate=Date.parseDate(tmpDate[1], options.formatDate)) ) {
						timeOffset = tmpDate.getTime()+-1*(tmpDate.getTimezoneOffset())*60000;
						options.maxDate = new Date((_xdsoft_datetime.now()).getTime()+timeOffset).dateFormat( options.formatDate );
					}

					mounth_picker
						.find('.xdsoft_today_button')
							.css('visibility',!options.todayButton?'hidden':'visible');

					if( options.mask ) {
						var e,
							getCaretPos = function ( input ) {
								try{
									if ( document.selection && document.selection.createRange ) {
										var range = document.selection.createRange();
										return range.getBookmark().charCodeAt(2) - 2;
									}else
										if ( input.setSelectionRange )
											return input.selectionStart;
								}catch(e) {
									return 0;
								}
							},
							setCaretPos = function ( node,pos ) {
								var node = (typeof node == "string" || node instanceof String) ? document.getElementById(node) : node;
								if(!node) {
									return false;
								}else if(node.createTextRange) {
									var textRange = node.createTextRange();
									textRange.collapse(true);
									textRange.moveEnd(pos);
									textRange.moveStart(pos);
									textRange.select();
									return true;
								}else if(node.setSelectionRange) {
									node.setSelectionRange(pos,pos);
									return true;
								}
								return false;
							},
							isValidValue = function ( mask,value ) {
								var reg = mask
									.replace(/([\[\]\/\{\}\(\)\-\.\+]{1})/g,'\\$1')
									.replace(/_/g,'{digit+}')
									.replace(/([0-9]{1})/g,'{digit$1}')
									.replace(/\{digit([0-9]{1})\}/g,'[0-$1_]{1}')
									.replace(/\{digit[\+]\}/g,'[0-9_]{1}');
								return RegExp(reg).test(value);
							};
						input.off('keydown.xdsoft');
						switch(true) {
							case ( options.mask===true ):
								//options.mask = (new Date()).dateFormat( options.format );
								//options.mask = options.mask.replace(/[0-9]/g,'_');
								options.mask = options.format
									.replace(/Y/g,'9999')
									.replace(/F/g,'9999')
									.replace(/m/g,'19')
									.replace(/d/g,'39')
									.replace(/H/g,'29')
									.replace(/i/g,'59')
									.replace(/s/g,'59');
							case ( $.type(options.mask) == 'string' ):
								if( !isValidValue( options.mask,input.val() ) )
									input.val(options.mask.replace(/[0-9]/g,'_'));

								input.on('keydown.xdsoft',function( event ) {
									var val = this.value,
										key = event.which;
									switch(true) {
										case (( key>=KEY0&&key<=KEY9 )||( key>=_KEY0&&key<=_KEY9 ))||(key==BACKSPACE||key==DEL):
											var pos = getCaretPos(this),
												digit = ( key!=BACKSPACE&&key!=DEL )?String.fromCharCode((_KEY0 <= key && key <= _KEY9)? key-KEY0 : key):'_';
											if( (key==BACKSPACE||key==DEL)&&pos ) {
												pos--;
												digit='_';
											}
											while( /[^0-9_]/.test(options.mask.substr(pos,1))&&pos<options.mask.length&&pos>0 )
												pos+=( key==BACKSPACE||key==DEL )?-1:1;

											val = val.substr(0,pos)+digit+val.substr(pos+1);
											if( $.trim(val)=='' )
												val = options.mask.replace(/[0-9]/g,'_');
											else
												if( pos==options.mask.length )
													break;

											pos+=(key==BACKSPACE||key==DEL)?0:1;
											while( /[^0-9_]/.test(options.mask.substr(pos,1))&&pos<options.mask.length&&pos>0 )
												pos+=(key==BACKSPACE||key==DEL)?-1:1;
											if( isValidValue( options.mask,val ) ) {
												this.value = val;
												setCaretPos(this,pos);
											}else if( $.trim(val)=='' )
												this.value = options.mask.replace(/[0-9]/g,'_');
											else{
												input.trigger('error_input.xdsoft');
											}
										break;
										case ( !!~([AKEY,CKEY,VKEY,ZKEY,YKEY].indexOf(key))&&ctrlDown ):
										 case !!~([ESC,ARROWUP,ARROWDOWN,ARROWLEFT,ARROWRIGHT,F5,CTRLKEY,TAB,ENTER].indexOf(key)):
										return true;
									}
									event.preventDefault();
									return false;
								});
							break;
						}
					}
					if( options.validateOnBlur ) {
						input
							.off('blur.xdsoft')
							.on('blur.xdsoft', function() {
								if( options.allowBlank && !$.trim($(this).val()).length ) {
									$(this).val(null);
									datetimepicker.data('xdsoft_datetime').empty();
								}else if( !Date.parseDate( $(this).val(), options.format ) ) {
									$(this).val((_xdsoft_datetime.now()).dateFormat( options.format ));
									datetimepicker.data('xdsoft_datetime').setCurrentTime($(this).val());
								}
								else{
									datetimepicker.data('xdsoft_datetime').setCurrentTime($(this).val());
 								}
								datetimepicker.trigger('changedatetime.xdsoft');
							});
					}
					options.dayOfWeekStartPrev = (options.dayOfWeekStart==0)?6:options.dayOfWeekStart-1;
					datetimepicker
						.trigger('xchange.xdsoft');
				};

				datetimepicker
					.data('options',options)
					.on('mousedown.xdsoft',function( event ) {
						event.stopPropagation();
						event.preventDefault();
						yearselect.hide();
						monthselect.hide();
						return false;
					});

				var scroll_element = timepicker.find('.xdsoft_time_box');
				scroll_element.append(timebox);
				scroll_element.xdsoftScroller();
				datetimepicker.on('afterOpen.xdsoft',function() {
					scroll_element.xdsoftScroller();
				});

				datetimepicker
					.append(datepicker)
					.append(timepicker);

				if( options.withoutCopyright!==true )
					datetimepicker
						.append(xdsoft_copyright);

				datepicker
					.append(mounth_picker)
					.append(calendar);

				$('body').append(datetimepicker);

				var _xdsoft_datetime = new function() {
					var _this = this;
					_this.now = function() {
						var d = new Date();
						if( options.yearOffset )
							d.setFullYear(d.getFullYear()+options.yearOffset);
						return d;
					};

					_this.currentTime = this.now();
					_this.isValidDate = function (d) {
						if ( Object.prototype.toString.call(d) !== "[object Date]" )
							return false;
						return !isNaN(d.getTime());
					};

					_this.setCurrentTime = function( dTime) {
						_this.currentTime = (typeof dTime == 'string')? _this.strtodatetime(dTime) : _this.isValidDate(dTime) ? dTime: _this.now();
						datetimepicker.trigger('xchange.xdsoft');
					};

					_this.empty = function() {
						_this.currentTime = null;
					};

					_this.getCurrentTime = function( dTime) {
						return _this.currentTime;
					};

					_this.nextMonth = function() {
						var month = _this.currentTime.getMonth()+1;
						if( month==12 ) {
							_this.currentTime.setFullYear(_this.currentTime.getFullYear()+1);
							month = 0;
						}
						_this.currentTime.setDate(
							Math.min(
								Date.daysInMonth[month],
								_this.currentTime.getDate()
							)
						)
						_this.currentTime.setMonth(month);
						options.onChangeMonth&&options.onChangeMonth.call&&options.onChangeMonth.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						datetimepicker.trigger('xchange.xdsoft');
						return month;
					};

					_this.prevMonth = function() {
						var month = _this.currentTime.getMonth()-1;
						if( month==-1 ) {
							_this.currentTime.setFullYear(_this.currentTime.getFullYear()-1);
							month = 11;
						}
						_this.currentTime.setDate(
							Math.min(
								Date.daysInMonth[month],
								_this.currentTime.getDate()
							)
						)
						_this.currentTime.setMonth(month);
						options.onChangeMonth&&options.onChangeMonth.call&&options.onChangeMonth.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						datetimepicker.trigger('xchange.xdsoft');
						return month;
					};

					_this.strtodatetime = function( sDateTime ) {
						var currentTime = sDateTime?Date.parseDate(sDateTime, options.format):_this.now();
						if( !_this.isValidDate(currentTime) )
							currentTime = _this.now();
						return currentTime;
					};

					_this.strtodate = function( sDate ) {
						var currentTime = sDate?Date.parseDate(sDate, options.formatDate):_this.now();
						if( !_this.isValidDate(currentTime) )
							currentTime = _this.now();
						return currentTime;
					};

					_this.strtotime = function( sTime ) {
						var currentTime = sTime?Date.parseDate(sTime, options.formatTime):_this.now();
						if( !_this.isValidDate(currentTime) )
							currentTime = _this.now();
						return currentTime;
					};

					_this.str = function() {
						return _this.currentTime.dateFormat(options.format);
					};
				};
				mounth_picker
					.find('.xdsoft_today_button')
						.on('mousedown.xdsoft',function() {
							datetimepicker.data('changed',true);
							_xdsoft_datetime.setCurrentTime(0);
							datetimepicker.trigger('afterOpen.xdsoft');
						}).on('dblclick.xdsoft',function(){
							input.val( _xdsoft_datetime.str() );
							datetimepicker.trigger('close.xdsoft');
						});
				mounth_picker
					.find('.xdsoft_prev,.xdsoft_next')
						.on('mousedown.xdsoft',function() {
							var $this = $(this),
								timer = 0,
								stop = false;

							(function arguments_callee1(v) {
								var month =  _xdsoft_datetime.currentTime.getMonth();
								if( $this.hasClass( options.next ) ) {
									_xdsoft_datetime.nextMonth();
								}else if( $this.hasClass( options.prev ) ) {
									_xdsoft_datetime.prevMonth();
								}
								!stop&&(timer = setTimeout(arguments_callee1,v?v:100));
							})(500);

							$([document.body,window]).on('mouseup.xdsoft',function arguments_callee2() {
								clearTimeout(timer);
								stop = true;
								$([document.body,window]).off('mouseup.xdsoft',arguments_callee2);
							});
						});

				timepicker
					.find('.xdsoft_prev,.xdsoft_next')
						.on('mousedown.xdsoft',function() {
							var $this = $(this),
								timer = 0,
								stop = false,
								period = 110;
							(function arguments_callee4(v) {
								var pheight = timeboxparent[0].clientHeight,
									height = timebox[0].offsetHeight,
									top = Math.abs(parseInt(timebox.css('marginTop')));
								if( $this.hasClass(options.next) && (height-pheight)- options.timeHeightInTimePicker>=top ) {
									timebox.css('marginTop','-'+(top+options.timeHeightInTimePicker)+'px')
								}else if( $this.hasClass(options.prev) && top-options.timeHeightInTimePicker>=0  ) {
									timebox.css('marginTop','-'+(top-options.timeHeightInTimePicker)+'px')
								}
								timeboxparent.trigger('scroll_element.xdsoft_scroller',[Math.abs(parseInt(timebox.css('marginTop'))/(height-pheight))]);
								period= ( period>10 )?10:period-10;
								!stop&&(timer = setTimeout(arguments_callee4,v?v:period));
							})(500);
							$([document.body,window]).on('mouseup.xdsoft',function arguments_callee5() {
								clearTimeout(timer);
								stop = true;
								$([document.body,window])
									.off('mouseup.xdsoft',arguments_callee5);
							});
						});

				// base handler - generating a calendar and timepicker
				datetimepicker
					.on('xchange.xdsoft',function( event ) {
						var table 	=	'',
							start	= new Date(_xdsoft_datetime.currentTime.getFullYear(),_xdsoft_datetime.currentTime.getMonth(),1, 12, 0, 0),
							i = 0,
							today = _xdsoft_datetime.now();
						while( start.getDay()!=options.dayOfWeekStart )
							start.setDate(start.getDate()-1);

						//generate calendar
						table+='<table><thead><tr>';

						// days
						for(var j = 0; j<7; j++) {
							table+='<th>'+options.i18n[options.lang].dayOfWeek[(j+options.dayOfWeekStart)>6?0:j+options.dayOfWeekStart]+'</th>';
						}

						table+='</tr></thead>';
						table+='<tbody><tr>';
						var maxDate = false, minDate = false;
						if( options.maxDate!==false ) {
							maxDate = _xdsoft_datetime.strtodate(options.maxDate);
							maxDate = new Date(maxDate.getFullYear(),maxDate.getMonth(),maxDate.getDate(),23,59,59,999);
						}
						if( options.minDate!==false ) {
							minDate = _xdsoft_datetime.strtodate(options.minDate);
							minDate = new Date(minDate.getFullYear(),minDate.getMonth(),minDate.getDate());
						}
						var d,y,m,classes = [];
						while( i<_xdsoft_datetime.currentTime.getDaysInMonth()||start.getDay()!=options.dayOfWeekStart||_xdsoft_datetime.currentTime.getMonth()==start.getMonth() ) {
							classes = [];
							i++;

							d = start.getDate(); y = start.getFullYear(); m = start.getMonth();

							classes.push('xdsoft_date');

							if( ( maxDate!==false && start > maxDate )||(  minDate!==false && start < minDate ) ){
								classes.push('xdsoft_disabled');
							}

							if( _xdsoft_datetime.currentTime.getMonth()!=m ) classes.push('xdsoft_other_month');

							if( (options.defaultSelect||datetimepicker.data('changed')) && _xdsoft_datetime.currentTime.dateFormat('d.m.Y')==start.dateFormat('d.m.Y') ) {
								classes.push('xdsoft_current');
							}

							if( today.dateFormat('d.m.Y')==start.dateFormat('d.m.Y') ) {
								classes.push('xdsoft_today');
							}

							if( start.getDay()==0||start.getDay()==6||~options.weekends.indexOf(start.dateFormat('d.m.Y')) ) {
								classes.push('xdsoft_weekend');
							}

							table+='<td data-date="'+d+'" data-month="'+m+'" data-year="'+y+'"'+' class="xdsoft_date xdsoft_day_of_week'+start.getDay()+' '+ classes.join(' ')+'">'+
										'<div>'+d+'</div>'+
									'</td>';

							if( start.getDay()==options.dayOfWeekStartPrev ) {
								table+='</tr>';
							}

							start.setDate(d+1);
						}
						table+='</tbody></table>';

						calendar.html(table);

						mounth_picker.find('.xdsoft_label span').eq(0).text(options.i18n[options.lang].months[_xdsoft_datetime.currentTime.getMonth()]);
						mounth_picker.find('.xdsoft_label span').eq(1).text(_xdsoft_datetime.currentTime.getFullYear());

						// generate timebox
						var time = '',
							h = '',
							m ='',
							line_time = function line_time( h,m ) {
								var now = _xdsoft_datetime.now();
								now.setHours(h);
								h = parseInt(now.getHours());
								now.setMinutes(m);
								m = parseInt(now.getMinutes());

								classes = [];
								if( (options.maxTime!==false&&_xdsoft_datetime.strtotime(options.maxTime).getTime()<now.getTime())||(options.minTime!==false&&_xdsoft_datetime.strtotime(options.minTime).getTime()>now.getTime()))
									classes.push('xdsoft_disabled');
								if( (options.defaultSelect||datetimepicker.data('changed')) && parseInt(_xdsoft_datetime.currentTime.getHours())==parseInt(h)&&(options.step>59||Math[options.roundTime](_xdsoft_datetime.currentTime.getMinutes()/options.step)*options.step==parseInt(m)))
									classes.push('xdsoft_current');
								if( parseInt(today.getHours())==parseInt(h)&&parseInt(today.getMinutes())==parseInt(m))
									classes.push('xdsoft_today');
								time+= '<div class="xdsoft_time '+classes.join(' ')+'" data-hour="'+h+'" data-minute="'+m+'">'+now.dateFormat(options.formatTime)+'</div>';
							};

						if( !options.allowTimes || !$.isArray(options.allowTimes) || !options.allowTimes.length ) {
							for( var i=0,j=0;i<(options.hours12?12:24);i++ ) {
								for( j=0;j<60;j+=options.step ) {
									h = (i<10?'0':'')+i;
									m = (j<10?'0':'')+j;
									line_time( h,m );
								}
							}
						}else{
							for( var i=0;i<options.allowTimes.length;i++ ) {
								h = _xdsoft_datetime.strtotime(options.allowTimes[i]).getHours();
								m = _xdsoft_datetime.strtotime(options.allowTimes[i]).getMinutes();
								line_time( h,m );
							}
						}

						timebox.html(time);

						var opt = '',
							i = 0;

						for( i = parseInt(options.yearStart,10)+options.yearOffset;i<= parseInt(options.yearEnd,10)+options.yearOffset;i++ ) {
							opt+='<div class="xdsoft_option '+(_xdsoft_datetime.currentTime.getFullYear()==i?'xdsoft_current':'')+'" data-value="'+i+'">'+i+'</div>';
						}
						yearselect.children().eq(0)
												.html(opt);

						for( i = 0,opt = '';i<= 11;i++ ) {
							opt+='<div class="xdsoft_option '+(_xdsoft_datetime.currentTime.getMonth()==i?'xdsoft_current':'')+'" data-value="'+i+'">'+options.i18n[options.lang].months[i]+'</div>';
						}
						monthselect.children().eq(0).html(opt);
						$(this).trigger('generate.xdsoft');
						event.stopPropagation();
					})
					.on('afterOpen.xdsoft',function() {
						if( options.timepicker && timebox.find('.xdsoft_current').length ) {
							var pheight = timeboxparent[0].clientHeight,
								height = timebox[0].offsetHeight,
								top = timebox.find('.xdsoft_current').index()*options.timeHeightInTimePicker+1;
							if( (height-pheight)<top )
								top = height-pheight;
							timebox.css('marginTop','-'+parseInt(top)+'px');
							timeboxparent.trigger('scroll_element.xdsoft_scroller',[parseInt(top)/(height-pheight)]);
						}
					});
				var timerclick = 0;
				calendar
					.on('click.xdsoft','td',function() {
						timerclick++;
						var $this = $(this),
							currentTime = _xdsoft_datetime.currentTime;
						if( $this.hasClass('xdsoft_disabled') )
							return false;

						currentTime.setFullYear( $this.data('year') );
						currentTime.setMonth( $this.data('month') );
						currentTime.setDate( $this.data('date') );
						datetimepicker.trigger('select.xdsoft',[currentTime]);

						input.val( _xdsoft_datetime.str() );
						if( (timerclick>1||(options.closeOnDateSelect===true||( options.closeOnDateSelect===0&&!options.timepicker )))&&!options.inline ) {
							datetimepicker.trigger('close.xdsoft');
						}

						if( options.onSelectDate &&	options.onSelectDate.call ) {
							options.onSelectDate.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						}

						datetimepicker.data('changed',true);
						datetimepicker.trigger('xchange.xdsoft');
						datetimepicker.trigger('changedatetime.xdsoft');
						setTimeout(function(){
							timerclick = 0;
						},200);
					});

				timebox
					.on('click.xdsoft','div',function() {
						var $this = $(this),
							currentTime = _xdsoft_datetime.currentTime;
						if( $this.hasClass('xdsoft_disabled') )
							return false;
						currentTime.setHours($this.data('hour'));
						currentTime.setMinutes($this.data('minute'));
						datetimepicker.trigger('select.xdsoft',[currentTime]);

						datetimepicker.data('input').val( _xdsoft_datetime.str() );

						!options.inline&&datetimepicker.trigger('close.xdsoft');

						if( options.onSelectTime&&options.onSelectTime.call ) {
							options.onSelectTime.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						}
						datetimepicker.data('changed',true);
						datetimepicker.trigger('xchange.xdsoft');
						datetimepicker.trigger('changedatetime.xdsoft');
					});

				datetimepicker.mousewheel&&datepicker.mousewheel(function(event, delta, deltaX, deltaY) {
					if( !options.scrollMonth )
						return true;
					if( delta<0 )
						_xdsoft_datetime.nextMonth();
					else
						_xdsoft_datetime.prevMonth();
					return false;
				});

				datetimepicker.mousewheel&&timeboxparent.unmousewheel().mousewheel(function(event, delta, deltaX, deltaY) {
					if( !options.scrollTime )
						return true;
					var pheight = timeboxparent[0].clientHeight,
						height = timebox[0].offsetHeight,
						top = Math.abs(parseInt(timebox.css('marginTop'))),
						fl = true;
					if( delta<0 && (height-pheight)-options.timeHeightInTimePicker>=top ) {
						timebox.css('marginTop','-'+(top+options.timeHeightInTimePicker)+'px');
						fl = false;
					}else if( delta>0&&top-options.timeHeightInTimePicker>=0 ) {
						timebox.css('marginTop','-'+(top-options.timeHeightInTimePicker)+'px');
						fl = false;
					}
					timeboxparent.trigger('scroll_element.xdsoft_scroller',[Math.abs(parseInt(timebox.css('marginTop'))/(height-pheight))]);
					event.stopPropagation();
					return fl;
				});

				datetimepicker
					.on('changedatetime.xdsoft',function() {
						if( options.onChangeDateTime&&options.onChangeDateTime.call )
							options.onChangeDateTime.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
					})
					.on('generate.xdsoft',function() {
						if( options.onGenerate&&options.onGenerate.call )
							options.onGenerate.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
					});

				var current_time_index = 0;
				input.mousewheel&&input.mousewheel(function( event, delta, deltaX, deltaY ) {
					if( !options.scrollInput )
						return true;
					if( !options.datepicker && options.timepicker ) {
						current_time_index = timebox.find('.xdsoft_current').length?timebox.find('.xdsoft_current').eq(0).index():0;
						if( current_time_index+delta>=0&&current_time_index+delta<timebox.children().length )
							current_time_index+=delta;
						timebox.children().eq(current_time_index).length&&timebox.children().eq(current_time_index).trigger('mousedown');
						return false;
					}else if( options.datepicker && !options.timepicker ) {
						datepicker.trigger( event, [delta, deltaX, deltaY]);
						input.val&&input.val( _xdsoft_datetime.str() );
						datetimepicker.trigger('changedatetime.xdsoft');
						return false;
					}
				});
				var setPos = function() {
					var offset = datetimepicker.data('input').offset(), top = offset.top+datetimepicker.data('input')[0].offsetHeight-1, left = offset.left;
					if( top+datetimepicker[0].offsetHeight>$(window).height()+$(window).scrollTop() )
						top = offset.top-datetimepicker[0].offsetHeight+1;
					if( left+datetimepicker[0].offsetWidth>$(window).width() )
						left = offset.left-datetimepicker[0].offsetWidth+datetimepicker.data('input')[0].offsetWidth;
					datetimepicker.css({
						left:left,
						top:top
					});
				};
				datetimepicker
					.on('open.xdsoft', function() {
						var onShow = true;
						if( options.onShow&&options.onShow.call) {
							onShow = options.onShow.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						}
						if( onShow!==false ) {
							datetimepicker.show();
							datetimepicker.trigger('afterOpen.xdsoft');
							setPos();
							$(window)
								.off('resize.xdsoft',setPos)
								.on('resize.xdsoft',setPos);

							if( options.closeOnWithoutClick ) {
								$([document.body,window]).on('mousedown.xdsoft',function arguments_callee6() {
									datetimepicker.trigger('close.xdsoft');
									$([document.body,window]).off('mousedown.xdsoft',arguments_callee6);
								});
							}
						}
					})
					.on('close.xdsoft', function( event ) {
						var onClose = true;
						if( options.onClose&&options.onClose.call ) {
							onClose=options.onClose.call(datetimepicker,_xdsoft_datetime.currentTime,datetimepicker.data('input'));
						}
						if( onClose!==false&&!options.opened&&!options.inline ) {
							datetimepicker.hide();
						}
						event.stopPropagation();
					})
					.data('input',input);

				var timer = 0,
					timer1 = 0;

				datetimepicker.data('xdsoft_datetime',_xdsoft_datetime);
				datetimepicker.setOptions(options);

				var ct = options.value?options.value:(input&&input.val&&input.val())?input.val():'';
				if( ct && _xdsoft_datetime.isValidDate(ct = Date.parseDate(ct, options.format)) ) {
					datetimepicker.data('changed',true);
				}else
					ct = '';

				_xdsoft_datetime.setCurrentTime( ct?ct:0 );

				datetimepicker.trigger('afterOpen.xdsoft');

				input
					.data( 'xdsoft_datetimepicker',datetimepicker )
					.on('open.xdsoft focusin.xdsoft mousedown.xdsoft',function(event) {
						if( input.is(':disabled')||input.is(':hidden')||!input.is(':visible') )
							return;
						clearTimeout(timer);
						timer = setTimeout(function() {
							if( input.is(':disabled')||input.is(':hidden')||!input.is(':visible') )
								return;
							_xdsoft_datetime.setCurrentTime((input&&input.val&&input.val())?input.val():0);
							datetimepicker.trigger('open.xdsoft');
						},100);
					})
					.on('keydown.xdsoft',function( event ) {
						var val = this.value,
							key = event.which;
						switch(true) {
							case !!~([ENTER].indexOf(key)):
								var elementSelector = $("input:visible,textarea:visible");
								datetimepicker.trigger('close.xdsoft');
								elementSelector.eq(elementSelector.index(this) + 1).focus();
							return false;
							case !!~[TAB].indexOf(key):
								datetimepicker.trigger('close.xdsoft');
							return true;
						}
					});
			},
			destroyDateTimePicker = function( input ) {
				var datetimepicker = input.data('xdsoft_datetimepicker');
				if( datetimepicker ) {
					datetimepicker.data('xdsoft_datetime',null);
					datetimepicker.remove();
					input
						.data( 'xdsoft_datetimepicker',null )
						.off( 'open.xdsoft focusin.xdsoft focusout.xdsoft mousedown.xdsoft blur.xdsoft keydown.xdsoft' );
					$(window).off('resize.xdsoft');
					$([window,document.body]).off('mousedown.xdsoft');
					input.unmousewheel&&input.unmousewheel();
				}
			};
		$(document)
			.off('keydown.xdsoftctrl keyup.xdsoftctrl')
			.on('keydown.xdsoftctrl',function(e) {
				if ( e.keyCode == CTRLKEY )
					ctrlDown = true;
			})
			.on('keyup.xdsoftctrl',function(e) {
				if ( e.keyCode == CTRLKEY )
					ctrlDown = false;
			});
		return this.each(function() {
			var datetimepicker;
			if( datetimepicker = $(this).data('xdsoft_datetimepicker') ) {
				if( $.type(opt) === 'string' ) {
					switch(opt) {
						case 'show':
							$(this).select().focus();
							datetimepicker.trigger( 'open.xdsoft' );
						break;
						case 'hide':
							datetimepicker.trigger('close.xdsoft');
						break;
						case 'destroy':
							destroyDateTimePicker($(this));
						break;
						case 'reset':
							this.value = this.defaultValue;
							if(!this.value || !datetimepicker.data('xdsoft_datetime').isValidDate(Date.parseDate(this.value, options.format)))
								datetimepicker.data('changed',false);
							datetimepicker.data('xdsoft_datetime').setCurrentTime(this.value);
						break;
					}
				}else{
					datetimepicker
						.setOptions(opt);
				}
				return 0;
			}else
				($.type(opt) !== 'string')&&createDateTimePicker($(this));
		});
	};
})( jQuery );

//http://www.xaprb.com/blog/2005/12/12/javascript-closures-for-runtime-efficiency/
/*
 * Copyright (C) 2004 Baron Schwartz <baron at sequent dot org>
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation, version 2.1.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
 * details.
 */
Date.parseFunctions={count:0};Date.parseRegexes=[];Date.formatFunctions={count:0};Date.prototype.dateFormat=function(format) {if(Date.formatFunctions[format]==null) {Date.createNewFormat(format)}var func=Date.formatFunctions[format];return this[func]()};Date.createNewFormat=function(format) {var funcName="format"+Date.formatFunctions.count++;Date.formatFunctions[format]=funcName;var code="Date.prototype."+funcName+" = function() {return ";var special=false;var ch='';for(var i=0;i<format.length;++i) {ch=format.charAt(i);if(!special&&ch=="\\") {special=true}else if(special) {special=false;code+="'"+String.escape(ch)+"' + "}else{code+=Date.getFormatCode(ch)}}eval(code.substring(0,code.length-3)+";}")};Date.getFormatCode=function(character) {switch(character) {case"d":return"String.leftPad(this.getDate(), 2, '0') + ";case"D":return"Date.dayNames[this.getDay()].substring(0, 3) + ";case"j":return"this.getDate() + ";case"l":return"Date.dayNames[this.getDay()] + ";case"S":return"this.getSuffix() + ";case"w":return"this.getDay() + ";case"z":return"this.getDayOfYear() + ";case"W":return"this.getWeekOfYear() + ";case"F":return"Date.monthNames[this.getMonth()] + ";case"m":return"String.leftPad(this.getMonth() + 1, 2, '0') + ";case"M":return"Date.monthNames[this.getMonth()].substring(0, 3) + ";case"n":return"(this.getMonth() + 1) + ";case"t":return"this.getDaysInMonth() + ";case"L":return"(this.isLeapYear() ? 1 : 0) + ";case"Y":return"this.getFullYear() + ";case"y":return"('' + this.getFullYear()).substring(2, 4) + ";case"a":return"(this.getHours() < 12 ? 'am' : 'pm') + ";case"A":return"(this.getHours() < 12 ? 'AM' : 'PM') + ";case"g":return"((this.getHours() %12) ? this.getHours() % 12 : 12) + ";case"G":return"this.getHours() + ";case"h":return"String.leftPad((this.getHours() %12) ? this.getHours() % 12 : 12, 2, '0') + ";case"H":return"String.leftPad(this.getHours(), 2, '0') + ";case"i":return"String.leftPad(this.getMinutes(), 2, '0') + ";case"s":return"String.leftPad(this.getSeconds(), 2, '0') + ";case"O":return"this.getGMTOffset() + ";case"T":return"this.getTimezone() + ";case"Z":return"(this.getTimezoneOffset() * -60) + ";default:return"'"+String.escape(character)+"' + "}};Date.parseDate=function(input,format) {if(Date.parseFunctions[format]==null) {Date.createParser(format)}var func=Date.parseFunctions[format];return Date[func](input)};Date.createParser=function(format) {var funcName="parse"+Date.parseFunctions.count++;var regexNum=Date.parseRegexes.length;var currentGroup=1;Date.parseFunctions[format]=funcName;var code="Date."+funcName+" = function(input) {\n"+"var y = -1, m = -1, d = -1, h = -1, i = -1, s = -1;\n"+"var d = new Date();\n"+"y = d.getFullYear();\n"+"m = d.getMonth();\n"+"d = d.getDate();\n"+"var results = input.match(Date.parseRegexes["+regexNum+"]);\n"+"if (results && results.length > 0) {";var regex="";var special=false;var ch='';for(var i=0;i<format.length;++i) {ch=format.charAt(i);if(!special&&ch=="\\") {special=true}else if(special) {special=false;regex+=String.escape(ch)}else{obj=Date.formatCodeToRegex(ch,currentGroup);currentGroup+=obj.g;regex+=obj.s;if(obj.g&&obj.c) {code+=obj.c}}}code+="if (y > 0 && m >= 0 && d > 0 && h >= 0 && i >= 0 && s >= 0)\n"+"{return new Date(y, m, d, h, i, s);}\n"+"else if (y > 0 && m >= 0 && d > 0 && h >= 0 && i >= 0)\n"+"{return new Date(y, m, d, h, i);}\n"+"else if (y > 0 && m >= 0 && d > 0 && h >= 0)\n"+"{return new Date(y, m, d, h);}\n"+"else if (y > 0 && m >= 0 && d > 0)\n"+"{return new Date(y, m, d);}\n"+"else if (y > 0 && m >= 0)\n"+"{return new Date(y, m);}\n"+"else if (y > 0)\n"+"{return new Date(y);}\n"+"}return null;}";Date.parseRegexes[regexNum]=new RegExp("^"+regex+"$");eval(code)};Date.formatCodeToRegex=function(character,currentGroup) {switch(character) {case"D":return{g:0,c:null,s:"(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)"};case"j":case"d":return{g:1,c:"d = parseInt(results["+currentGroup+"], 10);\n",s:"(\\d{1,2})"};case"l":return{g:0,c:null,s:"(?:"+Date.dayNames.join("|")+")"};case"S":return{g:0,c:null,s:"(?:st|nd|rd|th)"};case"w":return{g:0,c:null,s:"\\d"};case"z":return{g:0,c:null,s:"(?:\\d{1,3})"};case"W":return{g:0,c:null,s:"(?:\\d{2})"};case"F":return{g:1,c:"m = parseInt(Date.monthNumbers[results["+currentGroup+"].substring(0, 3)], 10);\n",s:"("+Date.monthNames.join("|")+")"};case"M":return{g:1,c:"m = parseInt(Date.monthNumbers[results["+currentGroup+"]], 10);\n",s:"(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)"};case"n":case"m":return{g:1,c:"m = parseInt(results["+currentGroup+"], 10) - 1;\n",s:"(\\d{1,2})"};case"t":return{g:0,c:null,s:"\\d{1,2}"};case"L":return{g:0,c:null,s:"(?:1|0)"};case"Y":return{g:1,c:"y = parseInt(results["+currentGroup+"], 10);\n",s:"(\\d{4})"};case"y":return{g:1,c:"var ty = parseInt(results["+currentGroup+"], 10);\n"+"y = ty > Date.y2kYear ? 1900 + ty : 2000 + ty;\n",s:"(\\d{1,2})"};case"a":return{g:1,c:"if (results["+currentGroup+"] == 'am') {\n"+"if (h == 12) { h = 0; }\n"+"} else { if (h < 12) { h += 12; }}",s:"(am|pm)"};case"A":return{g:1,c:"if (results["+currentGroup+"] == 'AM') {\n"+"if (h == 12) { h = 0; }\n"+"} else { if (h < 12) { h += 12; }}",s:"(AM|PM)"};case"g":case"G":case"h":case"H":return{g:1,c:"h = parseInt(results["+currentGroup+"], 10);\n",s:"(\\d{1,2})"};case"i":return{g:1,c:"i = parseInt(results["+currentGroup+"], 10);\n",s:"(\\d{2})"};case"s":return{g:1,c:"s = parseInt(results["+currentGroup+"], 10);\n",s:"(\\d{2})"};case"O":return{g:0,c:null,s:"[+-]\\d{4}"};case"T":return{g:0,c:null,s:"[A-Z]{3}"};case"Z":return{g:0,c:null,s:"[+-]\\d{1,5}"};default:return{g:0,c:null,s:String.escape(character)}}};Date.prototype.getTimezone=function() {return this.toString().replace(/^.*? ([A-Z]{3}) [0-9]{4}.*$/,"$1").replace(/^.*?\(([A-Z])[a-z]+ ([A-Z])[a-z]+ ([A-Z])[a-z]+\)$/,"$1$2$3")};Date.prototype.getGMTOffset=function() {return(this.getTimezoneOffset()>0?"-":"+")+String.leftPad(Math.floor(Math.abs(this.getTimezoneOffset())/60),2,"0")+String.leftPad(Math.abs(this.getTimezoneOffset())%60,2,"0")};Date.prototype.getDayOfYear=function() {var num=0;Date.daysInMonth[1]=this.isLeapYear()?29:28;for(var i=0;i<this.getMonth();++i) {num+=Date.daysInMonth[i]}return num+this.getDate()-1};Date.prototype.getWeekOfYear=function() {var now=this.getDayOfYear()+(4-this.getDay());var jan1=new Date(this.getFullYear(),0,1);var then=(7-jan1.getDay()+4);document.write(then);return String.leftPad(((now-then)/7)+1,2,"0")};Date.prototype.isLeapYear=function() {var year=this.getFullYear();return((year&3)==0&&(year%100||(year%400==0&&year)))};Date.prototype.getFirstDayOfMonth=function() {var day=(this.getDay()-(this.getDate()-1))%7;return(day<0)?(day+7):day};Date.prototype.getLastDayOfMonth=function() {var day=(this.getDay()+(Date.daysInMonth[this.getMonth()]-this.getDate()))%7;return(day<0)?(day+7):day};Date.prototype.getDaysInMonth=function() {Date.daysInMonth[1]=this.isLeapYear()?29:28;return Date.daysInMonth[this.getMonth()]};Date.prototype.getSuffix=function() {switch(this.getDate()) {case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}};String.escape=function(string) {return string.replace(/('|\\)/g,"\\$1")};String.leftPad=function(val,size,ch) {var result=new String(val);if(ch==null) {ch=" "}while(result.length<size) {result=ch+result}return result};Date.daysInMonth=[31,28,31,30,31,30,31,31,30,31,30,31];Date.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];Date.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];Date.y2kYear=50;Date.monthNumbers={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};Date.patterns={ISO8601LongPattern:"Y-m-d H:i:s",ISO8601ShortPattern:"Y-m-d",ShortDatePattern:"n/j/Y",LongDatePattern:"l, F d, Y",FullDateTimePattern:"l, F d, Y g:i:s A",MonthDayPattern:"F d",ShortTimePattern:"g:i A",LongTimePattern:"g:i:s A",SortableDateTimePattern:"Y-m-d\\TH:i:s",UniversalSortableDateTimePattern:"Y-m-d H:i:sO",YearMonthPattern:"F, Y"};

//https://github.com/brandonaaron/jquery-mousewheel/blob/master/jquery.mousewheel.js
/*
 * Copyright (c) 2013 Brandon Aaron (http://brandonaaron.net)
 *
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.1.3
 *
 * Requires: 1.2.2+
 */
(function(factory) {if(typeof define==='function'&&define.amd) {define("jquery.datetimepicker",['jquery'],factory)}else if(typeof exports==='object') {module.exports=factory}else{factory(jQuery)}}(function($) {var toFix=['wheel','mousewheel','DOMMouseScroll','MozMousePixelScroll'];var toBind='onwheel'in document||document.documentMode>=9?['wheel']:['mousewheel','DomMouseScroll','MozMousePixelScroll'];var lowestDelta,lowestDeltaXY;if($.event.fixHooks) {for(var i=toFix.length;i;) {$.event.fixHooks[toFix[--i]]=$.event.mouseHooks}}$.event.special.mousewheel={setup:function() {if(this.addEventListener) {for(var i=toBind.length;i;) {this.addEventListener(toBind[--i],handler,false)}}else{this.onmousewheel=handler}},teardown:function() {if(this.removeEventListener) {for(var i=toBind.length;i;) {this.removeEventListener(toBind[--i],handler,false)}}else{this.onmousewheel=null}}};$.fn.extend({mousewheel:function(fn) {return fn?this.bind("mousewheel",fn):this.trigger("mousewheel")},unmousewheel:function(fn) {return this.unbind("mousewheel",fn)}});function handler(event) {var orgEvent=event||window.event,args=[].slice.call(arguments,1),delta=0,deltaX=0,deltaY=0,absDelta=0,absDeltaXY=0,fn;event=$.event.fix(orgEvent);event.type="mousewheel";if(orgEvent.wheelDelta) {delta=orgEvent.wheelDelta}if(orgEvent.detail) {delta=orgEvent.detail*-1}if(orgEvent.deltaY) {deltaY=orgEvent.deltaY*-1;delta=deltaY}if(orgEvent.deltaX) {deltaX=orgEvent.deltaX;delta=deltaX*-1}if(orgEvent.wheelDeltaY!==undefined) {deltaY=orgEvent.wheelDeltaY}if(orgEvent.wheelDeltaX!==undefined) {deltaX=orgEvent.wheelDeltaX*-1}absDelta=Math.abs(delta);if(!lowestDelta||absDelta<lowestDelta) {lowestDelta=absDelta}absDeltaXY=Math.max(Math.abs(deltaY),Math.abs(deltaX));if(!lowestDeltaXY||absDeltaXY<lowestDeltaXY) {lowestDeltaXY=absDeltaXY}fn=delta>0?'floor':'ceil';delta=Math[fn](delta/lowestDelta);deltaX=Math[fn](deltaX/lowestDeltaXY);deltaY=Math[fn](deltaY/lowestDeltaXY);args.unshift(event,delta,deltaX,deltaY);return($.event.dispatch||$.event.handle).apply(this,args)}}));
;/**
 * 
 * @author luowenlin
 */
define("mmrp.mod.uploader2",function (require, exports, module) {

    var $ = require('jquery'),
        c = require('mmrp.config.user'),
        Fun = require('mmrp.func');
    exports.createUploader = function (id, callbck, maxsize, needWH) {
        $(id).on("change", function (e) {
            exports.uploadImage(e, callbck, maxsize, needWH);
            $(id).val("");
        });
        $(id).on("dragenter",function(){
            $(id).parent().addClass("pop_upload_drag_enter");
        }).on("dragleave",function(){
            $(id).parent().removeClass("pop_upload_drag_enter");
        });
    };
    /**
     * 
     */
    exports.uploadImage = function (e, callback, maxsize, needWH) {
        if (e == null) return;
        file = e.currentTarget.files[0];
        //
        if (!file) {
            return false;
        }
        var p_size = file.size;
        var p_type = file.type;
        maxsize = maxsize == null ? 10 : maxsize;
        if (p_size > maxsize * 1024) {
            alert("" + maxsize + "KB");
            return false;
        }
        if (p_type.indexOf("image/png") == -1 && p_type.indexOf("image/jpg") == -1 && p_type.indexOf("image/jpeg") == -1 && p_type.indexOf("image/bmp") == -1 && p_type.indexOf("image/gif") == -1) {
            //
            alert("jpgjpegpngbmpgif");
            return false;
        }
        var params = {}
        params.url = c.root + "php/upload_pic.php?g_tk="+Fun.$getToken();
        params.type = "post";
        params.xhrFields = {withCredentials: true};
        params.processData = false;
        params.contentType = false;
        var formData = new FormData();
        formData.append("file", file);
        params.data = formData;
        params.success = function (data) {
            var json = "";
            try{
                json = JSON.parse(data);
            }catch(e){
                callback && callback({retCode: 9, sErrMsg: ""});
                return;
            }
            json.size = parseFloat(p_size/1024).toFixed(2)+"KB";
            if (needWH && window.FileReader) {
                var fr = new FileReader();
                fr.onloadend = function (e) {
                    //
                    var img = document.createElement("img");
                    img.src = e.target.result;
                    json.width = img.width;
                    json.height = img.height;
                    callback && callback(json);
                    return;
                };
                fr.readAsDataURL(file);
            } else {
                callback && callback(json);
            }
        };
        params.error = function (ret) {
            callback && callback({retCode: 9, sErrMsg: ""});
        };
        $.ajax(params);
    };
});;define("mmrp_wx.page.setting",function (require, exports, module) {

    var $ = require('jquery'),
        datetimepicker = require('jquery.datetimepicker'),
        Mustache = require('mustache'),
        Fun = require('mmrp.func'),
        RestApi = require('mmrp.rest'),
        upload = require('mmrp.mod.uploader2');
    var model = {

        mod_container: "#js_mod_container",							//

        page_size: "page_size",									// 

        //
        mod_config: "#js_mod_config",								//
        page_config_cont: '#js_page_config',								//id
        width_input: "#js_width_input",								//
        height_input: "#js_height_input",							//
        config_sumbit_btn: "#js_edit_btn",							//
        config_close_btn: "#js_config_close",							//
        config_share_img: "#js_share_img",
        config_share_title: "#js_share_title",
        config_share_desc: "#js_share_desc",
        config_share_ptag: "#js_share_ptag",
        config_tmpl: '#js_page_config_tmpl',									//html
        act_bg: '#js_act_bg'
    };


    /**
     * 
     * @param page_width
     * @param page_height
     */
    exports.setPageSize = function (page_width, page_height) {
        //100%
        if (page_height == 800) {
            page_height = $(window).height() - 90;
        }

        $(model.width_input).setValue(page_width);
        $(model.height_input).setValue(page_height);
        //
        $(model.mod_container).css({width: page_width + 'px', height: page_height + 'px'});
    };

    /**
     * 
     * @param page_img
     * @param page_title
     * @param page_desc
     */
    exports.setShareConfig = function (page_img, page_title, page_desc, share_ptag) {
        $('#js_share_img').setValue(page_img);
        if (page_img != null)
            $('#target_img').attr('src', page_img + '?t=' + Date.parse(new Date()));
        $('#js_share_title').setValue(page_title);
        page_desc = page_desc || page_title;
        $('#js_share_desc').setValue(page_desc);
        $('#js_share_ptag').val(share_ptag);
    };
    /**
     * 
     */
    var getGlobalConfigValue = function () {
        var obj = {
            text_size: $("#js_g_text_size_input").val(),
            text_color: $("#js_g_text_color_input").val(),
            bg_color: $("#js_g_bg_color_input").val()
        };
        var sel_index = $("#js_g_font_family option[value='" + obj.font_family + "']").index();
        obj['sel' + sel_index] = true;
        return obj;
    };


    /**
     * 
     */
    var setGlobalConfig = function () {
        var obj = getGlobalConfigValue(),

            $style = $("#js_config_style"),			//style css
            $input = $("#js_config_style_input"),
            $container = $(model.mod_container),	//
            style = '', wrapper = '', wrapper_a = '', foot = '', foot_a = '';

        //css 
        obj.text_size && (wrapper += 'font-size:' + obj.text_size + 'px;');
        obj.text_color && (wrapper += 'color:' + obj.text_color + ';');
        obj.bg_color && (wrapper += 'background-color:' + obj.bg_color + ';');

        // 
        wrapper && (style += '.act_wrapper{' + wrapper + '}');

        //style
        if ($style.length) {
            $style.html(style).prependTo($container);
            $input.val(JSON.stringify(obj)).prependTo($container);
        }
        else {
            $("<style type='text/css' id='js_config_style' class='js_config_page' />").html(style).appendTo($container);
            $("<input type='hidden' id='js_config_style_input' class='js_config_page' />").val(JSON.stringify(obj)).appendTo($container);
        }
    };

    /**
     * 
     */
    var initGlobalConfig = function () {
        var style = $("#js_config_style").text(),			//css
            input = $("#js_config_style_input").val(),		//
            tpl = $(model.config_tmpl).html(),				//
            data = {},
            c_html;

        //test data
        input = '{"text_size":"22","text_color":"#ccc","link_size":"","link_color":"","foot_text_color":"","foot_link_color":"","foot_bg_color":"","font_family":"Tahoma"}';
        style = '.act_wrapper{font-size:22px;color:#ccc;font-family:Tahoma;}';

        if (input) {
            data = JSON.parse(input);
            $("#js_config_style").html(style);
        }
        ;
        c_html = Mustache.to_html(tpl, data);
        $(model.page_config_cont).html(c_html);
    };
    /**
     * 
     */
    var setBgcss = function () {
        var theme_bgcolor = $('#J_bg_color').val();
        //$('#js_body_container').css({'background-color':theme_bgcolor});

        /*
         var data = localStore.getPageDataById(theme_id);

         var obj = {
         data: {
         table: "tb_theme",
         value: {
         theme_css: new_css
         },
         where: "theme_id=" + theme_id
         }
         };
         localStore.setPageDataById(theme_id,obj);*/
    };
    var uploadImageShare = function () {
        upload.createUploader('#J_upload_img_for_share input', function (responseJSON) {
            if (responseJSON == null) {
                alert("");
                return;
            }
            if (responseJSON.retCode != 0 && responseJSON.retCode != 8888) {
                alert(responseJSON.sErrMsg);
                return;
            }

            var img_url = responseJSON.url;

            $("#js_share_img").val(img_url);
            setTimeout(function () {
                $('#target_img').attr('src', img_url);
            }, 1000);
        });
    }

    var Events = {
        /**
         * TODO 
         *   
         */
        modalInit: function () {
            var that = this;
            $('#J_morePageConfig').one('click', function () {
                initGlobalConfig();
                $(this).closest('tr').hide();
                $('#J_pageSizeSetting').removeClass('hide');
                //
                that.submitData();

                //
//				if( !$(model.page_config_cont).attr('data-first') ){
//					initGlobalConfig();
//					$(model.page_config_cont).attr('data-first',true);
//				}

            });

        },

        /**
         * 
         */
        submitData: function () {
            $(model.config_sumbit_btn).on('click.pagesetting', function () {
                $("#js_pop_guide").removeClass("build_bar_open");
            });
            $('#J_shareConfig').on('click', function () {
                $('#J_share_settings').toggle();
            });
            $('#js_showQRcode').on('click', function () {
                $('#js_QRcode').toggle();
            });
            $('#J_redirectionConfig').on('click', function () {
                $('#J_redirection_settings').toggle();
                if ($("#J_redirection_settings").is(":hidden")) {
                    $("#J_redirectionConfig_flag").html("");
                } else {
                    $("#J_redirectionConfig_flag").html("");
                }
            });
            $('#js_redirection_time').datetimepicker();

            $('#share_image_tab').on('click', '.pic_selected_type', function (e) {
                $('#share_image_tab .pic_selected_type').removeClass('selected');
                $(this).addClass('selected');
                var idx = $(this).data('idx');
                $('#share_image_tab .share_img_box').addClass('hide');
                $($('#share_image_tab .share_img_box').get(idx)).removeClass('hide');
            })

        },
        resetBg: function () {
            $("#js_resetbg_btn").on('click', function () {
                var theme_id = Fun.getUrlParam("theme_id") || 0;
                if (theme_id) {
                    //theme
                    var obj = {
                        data: {
                            table: "tb_theme",
                            value: {
                                theme_static: '',
                                theme_css: ''
                            },
                            where: "theme_id=" + theme_id
                        }
                    };
                    //theme
                    RestApi.postUpdata(obj);
                    //localStore.setPageDataById(theme_id,obj);
                    $('#js_upload_list ul').html('');
                    //window.location.reload();
                    $(model.act_bg).html('');
                }

            });
        },
        init: function () {
            //this.modalInit();
            this.submitData();
            this.resetBg();
            uploadImageShare();
        }
    };

    /**
     * 
     */
    exports.getConfigStyle = function () {
        var style = $("#js_config_style").text();
        return style;
    }


    exports.init = function () {
        Events.init();
    }

});
;define("mmrp.page.setting",function(require, exports, module) {  
	
	var $ = require('jquery'),
	 	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	RestApi = require('mmrp.rest');
	
	var model = {
		
		mod_container		:"#js_mod_container",							//
		
		page_size			:"page_size",									// 
		
		//
		mod_config			:"#js_mod_config",								//
		page_config_cont	:'#js_page_config',								//id
		width_input			:"#js_width_input",								//
		height_input		:"#js_height_input",							//
		config_sumbit_btn	:"#js_edit_btn",							//
		config_close_btn	:"#js_config_close",							//
		
		config_tmpl 		:'#js_page_config_tmpl'									//html
	};
	
	var theme_id = Fun.getUrlParam("theme_id") || 0;


    /**
     * 
     * @param page_width
     * @param page_height
     */
	exports.setPageSize = function(page_width,page_height){
        //100%
        if(page_height == 800){
            page_height = $(window).height() - 90;
        }

		$(model.width_input).setValue( page_width );
		$(model.height_input).setValue( page_height );
		//
		$(model.mod_container).css({width:page_width+ 'px' , height:page_height +'px'});
	};
	
	/**
	 * 
	 */
	var getGlobalConfigValue = function(){
		var obj = {
			text_size : $("#js_g_text_size_input").val(),
			text_color : $("#js_g_text_color_input").val(),
			link_size : $("#js_g_link_size_input").getValue(),
			link_color : $("#js_g_link_color_input").val(),
			foot_text_color : $("#js_g_foot_text_color_input").val(),
			foot_link_color : $("#js_g_foot_link_color_input").val(),
			foot_bg_color : $("#js_g_foot_bg_input").val(),
			font_family : $("#js_g_font_family").getValue()
		};
		var sel_index = $("#js_g_font_family option[value='"+ obj.font_family +"']").index();
		obj['sel'+sel_index] = true;
		return obj;
	};
	
	
	/**
	 * 
	 */
	var setGlobalConfig = function(){
		var obj = getGlobalConfigValue(),
			
			$style = $("#js_config_style"),			//style css
			$input = $("#js_config_style_input"),
			$container =  $(model.mod_container),	//
			style = '', wrapper = '', wrapper_a = '',foot = '',foot_a='';
		
		//css 
		obj.text_size && (wrapper += 'font-size:' + obj.text_size + 'px;');
		obj.text_color && (wrapper += 'color:' + obj.text_color + ';');
		obj.font_family && (wrapper += 'font-family:' + obj.font_family + ';');
		//
		obj.link_size && (wrapper_a += 'font-size:' + obj.link_size + 'px;');
		obj.link_color && (wrapper_a += 'color:' + obj.link_color + ';');
		//
		obj.foot_text_color && (foot += 'color:' + obj.foot_text_color + ';');
		obj.foot_bg_color && (foot += 'background:' + obj.foot_bg_color + ';');
		//
		obj.foot_link_color && (foot_a += 'color:' + obj.foot_link_color + ';');
		
		// 
		wrapper && (style += '.act_wrapper{'+ wrapper +'}');
		wrapper_a && (style += '.act_wrapper a{'+ wrapper_a +'}');
		foot && (style += '.mod_footer{'+ foot +'}') ;
		foot_a && (style += '.mod_footer a{'+ foot_a +'}');
		 
		//style
		if ($style.length) {
			$style.html(style).prependTo( $container );
			$input.val(JSON.stringify(obj)).prependTo( $container );
		}
		else {
			$("<style type='text/css' id='js_config_style' class='js_config_page' />").html(style).appendTo($container);
			$("<input type='hidden' id='js_config_style_input' class='js_config_page' />").val(JSON.stringify(obj)).appendTo($container);
		}
	};
	
	/**
	 * 
	 */
	var initGlobalConfig = function(){
		var style = $("#js_config_style").text(),			//css
			input = $("#js_config_style_input").val(),		//
			tpl = $(model.config_tmpl).html(),				//
			data = {},
			c_html;
		
		//test data
		// input = '{"text_size":"22","text_color":"#ccc","link_size":"","link_color":"","foot_text_color":"","foot_link_color":"","foot_bg_color":"","font_family":"Tahoma"}';
		// style = '.act_wrapper{font-size:22px;color:#ccc;font-family:Tahoma;}';
		
		if (input) {
			data = JSON.parse(input);
			$("#js_config_style").html(style);
		};
		c_html = Mustache.to_html(tpl, data);
		$(model.page_config_cont).html(c_html);
	};

	
	var Events = {
		/**
         * TODO 
		 *   
		 */
		modalInit:function(){
            var that = this;
			$('#J_morePageConfig').one('click', function () {
                initGlobalConfig();
                $(this).closest('tr').hide();
                $('#J_pageSizeSetting').removeClass('hide');
                //
                that.submitData();

				//
//				if( !$(model.page_config_cont).attr('data-first') ){
//					initGlobalConfig();
//					$(model.page_config_cont).attr('data-first',true);
//				}
			  
			});
		},
		
		/**
		 *  
		 */
		submitData:function(){
			$(model.config_sumbit_btn).on('click.pagesetting',function(){
                console.log('config_sumbit_btn');

				//
//				setGlobalConfig();
				//
				var page_width = $(model.width_input).val(),
					page_height= $(model.height_input).val();
				// 
				if(page_width && page_height){
					//						
					exports.setPageSize(page_width,page_height);
						// 
						if (theme_id) {
							//theme
							var obj = {
								data: {
									table: "tb_theme",
									value: {
										theme_width: page_width,
										theme_height: page_height
									},
									where: "theme_id=" + theme_id
								}
							};
							//theme
							RestApi.postUpdata(obj);
					}
				}//end if
				
//				$(model.config_close_btn).trigger("click");
			});
		},
		
		init:function(){
//			this.modalInit();
			this.submitData();
		}
	};
	
	/**
	 *  
	 */
	exports.getConfigStyle = function(){
		var style = $("#js_config_style").text();
		return style;
	}
	
	
	
	exports.init = function(){
		Events.init();
	}
	
});
;//JS
define("mmrp_wx.upload.bg.func",function(require, exports, module) {  
    var $ = require('jquery'),
    	c = require('mmrp.config.user'),
        Fun = require('mmrp.func');
    
    var model = {
    	bg_style			: "#js_bg_style",								//cssID
		act_bg				: "#js_act_bg",									//ID
		mod_container		: "#js_mod_container",							//
		share_img 			: "#js_share_img",								//
		share_title 		: "#js_share_title",							//
		share_desc 		: "#js_share_desc"								//

    };
    
    /***
	 * 
	 * return css and html
	 */
	exports.getThemeCode = function(img_attr){
		// console.info(img_attr,'img_attr')
		var	page_width = $("#js_width_input").val(), 					//
			page_height = 0,					//
			img_bg ="", 						//div 
			img_css = "/*S:*/", 						// css 
			img_idc_css = "/*S:idc*//*",
			mod_cont_css = "",					//
			bg_color = img_attr.bg_color, 		//
			bg_rp = img_attr.bg_rp.name, 			//
			img_arr = img_attr.bg_static;		//
		
		for(var i in img_arr){
			img_bg += '<div data-bg-idc="'+ img_arr[i]['idc'] +'" class="' + img_arr[i]['class_name'] +'"></div> ';
			img_css += '.' + img_arr[i]['class_name'] + '{background:url(none) 50% 0 no-repeat;height:'+ img_arr[i]['height'] +'px}';
			img_idc_css += '.' + img_arr[i]['class_name'] + '{background:url(none) 50% 0 no-repeat;height:'+ img_arr[i]['height'] +'px}';

			page_height += img_arr[i]['height'];
		}
		img_css += '/*E:*/';
		img_idc_css += '*//*E:idc*/';
		img_css += img_idc_css;
		//
		bg_color &&	(mod_cont_css += 'background-color:' + bg_color +';');
		//
		bg_rp && (mod_cont_css += 'background-image:url("' + bg_rp +'");background-repeat:repeat-x;');
		
		img_css += '.act_wrapper{'+ mod_cont_css +'}';
		
		//css  html
		var code = {
			style: img_css,
			body: img_bg,
			page_width: page_width,
			page_height:page_height
		};
		return code;
	};
	
	/***
	 * 
	 * @param {Object} data :API JSON
	 */
	exports.setBgToContainer = function(tb_theme){
		var data = tb_theme.data.value,
			bg_list_arr = [], 
			bg_css = data.theme_css,
			bg_length = 0,
			bg_code = '';
		//
		if (data.theme_static) {
			bg_list_arr = JSON.parse(data.theme_static);
			
		}//
		else if(data.theme_remote_url){
			bg_list_arr = JSON.parse(data.theme_remote_url);
		};
		//bg_list_arr = JSON.parse(data.theme_remote_url);
		
		bg_length =bg_list_arr.length;
		//
		if (bg_length) {
			for (var i = 1; i <= bg_length; i++) {
				bg_code += '<div data-lazy-bg="'+ bg_list_arr[i - 1].name +'" class="bg_' + i + '" style="background-image:url(' + bg_list_arr[i - 1].name + ')"></div>';
			}
			$(model.act_bg).html(bg_code);
//			bg_css = bg_css.replace(/\.act_wrapper\{.*\}$/,'.act_wrapper{background-color:' + data.theme_bgcolor + '}');
		}
		$(model.bg_style).html(bg_css);
		//$(model.mod_container).css({
		//	'width':data.theme_width,
		//	'height':data.theme_height
		//});
	};
	
	/**
	 *  object 
     * page_directory id
	 */
	exports.getImgPath = function(){
        var page_id = Fun.getUrlParam("id")
		return {
			// 
			absolute_path:c.root + "project/release_img/" + page_id +"/",
			// 
			relative_path:"project/release_img/" + page_id +"/"
			//
		};
	};
	
	/**
	 *  
	 */
	exports.getBgStyle = function(){
		var style = $(model.bg_style).text();
		var new_style_bg = $('#J_bg_color').val();
		style = style.replace(/\.act_wrapper\{.*\}$/,'.act_wrapper{background-color:' + new_style_bg + '}');
		if(!style){
			style = '.act_wrapper{background-color:' + new_style_bg + '}';
		}
		return style;
	};

	/**
	 * js
	 */

	exports.getShareConfig = function(){
		var _share_img = $(model.share_img).val(),
			_share_title = $(model.share_title).val(),
			_share_desc = $(model.share_desc).val(),
			_share_ptag = $('#js_share_ptag').val();
		var text_js = ''
		//var path = window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/[^\/]+$/,'');
		if(!_share_title){
			_share_title = $('#js_page_name').val();
		}
		if(!_share_desc){
			_share_desc = _share_title;
		}
		var text_js = {"img_url": _share_img ,"img_width": 80,"img_heigth": 80,"title": _share_title ,"desc": _share_desc};
		return text_js;
	};

});
;/**
 * 
 */
define("mmrp.make.file",function(require, exports, module) {  
	var $ = require('jquery'),
    	Mustache = require('mustache'),
    	
    	localStore = require('mmrp.localstore'),
    	
    	c = require('mmrp.config.user'),
    	Fun = require('mmrp.func'),
    	
    	RestApi = require('mmrp.rest'),
    	
    	PageSetting = require('mmrp.page.setting'),
    	LoadJs = require('mmrp.mod.loadjs'),
    	BgFun = require('mmrp_wx.upload.bg.func');

	/**
	 * layout  
	 */

	var model = {
		body_container		:"#js_body_container",							//
		drag_element	: 	'.js_drag_element',								//dom box
		act_content			:"#js_act_content",								//box
		act_bg				:"#js_act_bg",									//ID
		style_pre			:"mod_style_"									//
	}
	
	/***
	 * html
	 * @param {Object} data = {style:style//css ;body:body//}
	 */
	var setTemplate = function(){
        var layout_id = Fun.getUrlParam("layout_id");
        var template_id =  Fun.getUrlParam("template_id");
        var page_id = Fun.getUrlParam("id");
		var layout_data = localStore.getLayoutDataById(layout_id);			//tb_layout 
		var	page_info = localStore.getPageDataById(page_id).data.value;				//tb_page 
		var	source_data = exports.filterHtml();
		if(source_data==null) return null;
		//layout_data.layout_html = '<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><title>{{title}}</title>   <meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no" /><meta name="format-detection" content="email=no" /><meta name="format-detection" content="address=no" /><meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport"><! --#include virtual="/sinclude/common/head_inc.shtml"--><style type="text/css">{style}</style><style type="text/css" id="_zoom"></style>{head_zoom}</head><body class="page_{{page_id}}"><div id="J_loading" class="loader zoom"><div class="loader_graph"></div><div id="J_percent" class="loader_progress">0%</div></div><div id="J_wrapper" class="act_wrapper zoom hide">{{{body}}}  </div>{head_link}{javas_cript}<! --#include virtual="/sinclude/common/foot.shtml"--> <div class="mod_alert"><i class="icon"></i><p class="alert_cnt"></p><p class="btns"><a href="#" class="btn btn_1"></a></p></div><div class="mod_alert_mask"></div></body></html>';
		//layout_data.layout_css = '.act_wrapper{position:relative;z-index:1;margin:auto}.act_wrapper .act_inner{position:relative;z-index:2;margin:auto;width:720px}.act_wrapper .act_content{height:100%}.act_wrapper .bg_container{position:absolute;left:0;top:0;width:100%}.mod_link{width:100%;height:100%;display:block;background:url(about:blank)}body,h1,h2,h3,h4,h5,h6,hr,p,blockquote,dl,dt,dd,ul,ol,li,pre,form,fieldset,legend,button,input,textarea,th,td{margin:0;padding:0;vertical-align:baseline}img{border:0 none;vertical-align:top}i,em{font-style:normal}ol,ul{list-style:none}input,select,button,h1,h2,h3,h4,h5,h6{font-size:100%;font-family:inherit}table{border-collapse:collapse;border-spacing:0}a{text-decoration:none;color:#333}body{margin:0 auto;background:#FFF;font-size:27px;font-family:Helvetica,STHeiti STXihei,Microsoft JhengHei,Microsoft YaHei,Arial;line-height:1.5;color:#666;-webkit-text-size-adjust:100% !important;-webkit-user-select:none;user-select:none}.hide,.h{display:none !important}.show{display:block !important}#cacheProxyIfr{position:absolute;top:-500px;left:-500px}@-webkit-keyframes loading{0%{-webkit-transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg)}}@-moz-keyframes loading{0%{-moz-transform:rotate(0deg)}100%{-moz-transform:rotate(360deg)}}@-o-keyframes loading{0%{-o-transform:rotate(0deg)}100%{-o-transform:rotate(360deg)}}@-ms-keyframes loading{0%{-ms-transform:rotate(0deg)}100%{-ms-transform:rotate(360deg)}}@keyframes loading{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.loader{position:fixed;z-index:999;overflow:hidden;left:0;top:0;right:0;bottom:0;width:100%;height:100%;color:#fff;background-color:#2d3132}.loader_graph{overflow:hidden;position:absolute;left:50%;bottom:50%;width:120px;height:120px;margin:-60px 0 0 -60px}.loader_graph{color:transparent;text-align:center;border-top:15px solid rgba(255,255,255,0.2);border-right:15px solid rgba(255,255,255,0.2);border-bottom:15px solid rgba(255,255,255,0.2);border-left:15px solid #fff;border-radius:130px;-webkit-animation:loading .72s linear infinite;-o-animation:loading .72s linear infinite;animation:loading .72s linear infinite}.loader_progress{position:absolute;left:50%;width:120px;text-align:center;line-height:60px;font-size:40px;margin:-102px 0 0 -47px;top:50%}.mod_alert .btns{display:box;display:-ms-box;display:-webkit-box;display:flex;display:-ms-flexbox;display:-webkit-flex}.mod_alert .btns .btn{display:block;flex:1;-ms-flex:1;-webkit-flex:1;box-flex:1;-ms-box-flex:1;-webkit-box-flex:1}.mod_alert{width:240px;margin:20px auto 0;padding:15px 0;background:rgba(0,0,0,0.8);color:#fff;border-radius:3px;text-align:center;display:none}.mod_alert .icon{display:block;width:50px;height:50px;margin:0 auto;background:url(http://wq.360buyimg.com/fd/base/img/base/mod_alert.png);-webkit-background-size:50px 200px;background-size:50px 200px}.mod_alert .icon_fail{background-position:0 -50px}.mod_alert .icon_wait{background-position:0 -100px}.mod_alert .icon_success{background-position:0 -150px}.mod_alert p{margin:8px 0;padding:0 10px}.mod_alert p.small{font-size:12px}.mod_alert .btn{display:inline-block;width:100px;height:40px;margin:5px 2px 0;line-height:40px;background:#f3f3f3;color:#333;border-radius:3px}.mod_alert .btn.disabled{background:#666;color:#fff}.mod_alert .btn_1{background:#3985ff;color:#fff}.mod_alert .disabled span{margin-left:5px;color:red}.mod_alert.fixed{display:none;z-index:899;position:fixed;top:35%;left:50%;margin-left:-120px}.mod_alert .btns .btn{display:block}.mod_alert_loading{background:0}.mod_alert_large{width:290px}.mod_alert_large.fixed{margin-left:-145px}.mod_alert_mask{display:none;position:fixed;left:0;top:0;bottom:0;right:0;width:100%;height:100%;background:rgba(0,0,0,0);z-index:898}.mod_alert.show,.mod_alert_mask.show{display:block}.mod_alert{font-size:12px}.qq_footer,.wx_footer{display:none;}center,hr{display:none;}';
		var	html_tpl  = layout_data.layout_html;											//;javascript:layout_js,
		var	style_str = layout_data.layout_css + source_data.box_style + source_data.mod_style + source_data.bg_style ;								// css
		var	layout_js = source_data.body_share_js;
		layout_js['redirection_time'] = new Date(page_info['redirection_time']).getTime();
												//js
		layout_js['redirection_url'] = page_info['redirection_url'];
		layout_js = JSON.stringify(layout_js);
		var	must_data = $.extend({},page_info,layout_data,{body:source_data.body_clear,page_id:page_id,title:page_info.page_name});//
		var	html = Mustache.to_html(html_tpl, must_data);
		var	obj = {
				js:layout_js,
				html:html,
				html2:source_data.body_clear2,
				css:style_str
			};																	//html
				//console.log(source_data);	
			// console.info(must_data,html)
		return obj;
	};
	
	/**
	 * css
	 * @param {Object} arr_css
	 */
	var filterBoxCss = function(css_data){
		var regexp = /font-weight:\s*normal\s*;|text-align:\s*inherit\s*;|text-decoration:\s*none\s*;|overflow-x:\s*visible\s*;|overflow-y:\s*visible\s*;|overflow:\s*visible\s*;/g,
			_css_data = css_data.replace(regexp,"");
		return _css_data;
	};
	
	/***
	 * html
	 * @param clear    DB
	 */
	exports.filterHtml = function(_type){
		// clear = clear || false;
		var ptype = _type || '';
		var $container = $(model.body_container),
			data = $container.html(),
			$data = $("<div />").append(data),
			pri_style_css = '',											//
			mod_style ='',												//mod
			box_style = '';												//style
		
		//dom
		$("#js_bg_grid_view,#js_x_view,#js_y_view",$data).remove();


		//uidom
		$(".ui-resizable-handle",$data).remove();
		$(".js_mod_pos",$data).remove();

		var $data_clear = $data.clone();
		$(".mmrp_mod_poster img[src='img/jdlogosmall.png']",$data_clear).parent().parent().remove();
		if(_type!="save") {
			var d = $(".mod_goods_list",$data_clear);
			for(var i=0;i< d.length;i++){
				if(d.eq(i).css("display")=="none"){
					d.eq(i).remove();
				}
			}
			var d2 = $(".js_mod_product",$data_clear);
			for(var i=0;i< d2.length;i++){
				if(d2.eq(i).css("display")=="none"){
					d2.eq(i).remove();
				}
			}
			//
			$(".goods_list",$data_clear).html("");
			$(".mod_sku_addcart",$data_clear).html("");
			$(".mod_mart_addcart",$data_clear).html("");
			if($(".goodsFooter",$data_clear).length<=0){//
				var twoGoodsList = $(".twoGoodsList",$data_clear);
				if(twoGoodsList.length>0){
					var html = '<div class="goodsFooter" style="display:none;"><span class="goodsFL"> <div class="goodsFPrice"><b class="color_e4393c count">0.00</b></div><span class="reduce"></span></span><a href="javascript:;" class="goodsFB"></a></div><div class="add_cart_tip"><span></span></div>';
					$(html).appendTo($("#js_mod_container",$data_clear));
				}
			}
			//
			if($("#fixedtoptabs").is(":visible")){
				$("#fixedtoptabs",$data_clear).addClass("fixed");
				$("#fixedtableft",$data_clear).remove();
			}else{
				$("#fixedtableft",$data_clear).addClass("fixed");
				$("#fixedtableft .temp_nav_inner",$data_clear).hide();
				$("#fixedtoptabs",$data_clear).remove();
			}

			//
			$data_clear.find(".mod_collocation").find('img').each(function(){
					var $this = $(this);
					$this.attr('data-lazy', $this.attr("src"));
					$this.removeAttr('src');
			});
		}
		//clear
		$(model.act_content,$data_clear).removeClass("ui-droppable").removeAttr("id");
		$(model.act_bg,$data_clear).removeAttr("id");
		$(".js_config_page",$data_clear).remove();//
		//
		$(".mod_goods_link",$data_clear).parent();
		$(model.drag_element,$data_clear).each(function(i){
			var $this = $(this),
				$child = $this.children('.js_box').first(),
				id = $this.attr("id"),
				pri_style = $this.find("style").text(),			//
				style = $this.attr("style");					//dom  style
			
			if(id) {			
				box_style += '#' + id + '{' + style + '}';
				pri_style_css += pri_style;
			}
			
			//JS
			LoadJs.loadApiJs($this);
			//
			$('input[class^="js_pri"],style[class^="js_pri"],.js_iframe_t,.js_temp',$this).remove();
			//console.log($this);
			$child.removeAttr("data-id data-test data-mod-base-ids data-mod-id data-title data-url data-color data-img_url data-iframe_url data-mod-api data-mod-itemid data-link_target data-link_text data-pri-style contenteditable")
				  .removeClass('js_box');
				  
			// _self
			$child.find("a[target]").each(function(){
				var $this = $(this),
					target = $this.attr("target");
				if(target === "_self"){
					$this.removeAttr("target");
				}
			});
			
			$child.attr("id",id).unwrap();
		});
		
		//dom
		$(model.drag_element,$data).each(function(i){
			var $this = $(this),
				id = $this.attr("id");
			$this.children('.js_box').first().attr("id",id).unwrap();
		});

		//
		$('.js_mod_style',"head").each(function(){
			var id = $(this).attr("id");
			//
			if(id=="mod_pub_mkjc"){
				var d = $(".mod_goods_list[data-type=mod_goods_list_mkjc]:visible");
				d = d.length>0?d:$.grep($(".mod_goods_list[data-type=mod_goods_list_mkjc]"),function(item){if($(item).css("display")=='block') return true;});
				if(d.length>0){
					mod_style += $(this).text();
				}
			}else if(id=="mod_pub_jcmj"){//
				var d = $(".js_mod_product[data-type=mod_goodscx_jcmj]:visible");
				//tab
				d = d.length>0?d:$.grep($(".js_mod_product[data-type=mod_goodscx_jcmj]"),function(item){if($(item).css("display")=='block') return true;});
				if(d.length>0){
					mod_style += $(this).text();
				}
			}else if(id=="mod_pub_storelogo"){
				var d = $("[data-type=mod_store_logo]:visible");
				if(d.length>0){
					mod_style += $(this).text();
				}
			}else if(id=="mod_pub_fixedtableft"){
				var d = $("#fixedtableft:visible");
				if(d.length>0){
					mod_style += $(this).text();
				}
			}else{
				var type = $(this).attr("data-type");
				if(type=="goodcg_list"){//
					var d = $(".js_mod_product[data-type=mod_goodscx_list]:visible");
					d = d.length>0?d:$.grep($(".js_mod_product[data-type=mod_goodscx_list]"),function(item){if($(item).css("display")=='block') return true;});
					if(d.length>0){
						mod_style += $(this).text();
					}
				}else if(type=="goods_list"){//
					var d = $(".mod_goods_list[data-type=mod_goods_list]:visible");
					d = d.length>0?d:$.grep($(".mod_goods_list[data-type=mod_goods_list]"),function(item){if($(item).css("display")=='block') return true;});
					if(d.length>0){
						mod_style += $(this).text();
					}
				}else if(type=="store_entrance"){//
					if($(".store_entrance_a").length>0){
						mod_style += $(this).text();
					}
				}else if(type=="mod_fixedtoptabs"){
					if($("#fixedtoptabs:visible").length>0){
						mod_style += $(this).text();
					}
				}else{
					mod_style += $(this).text();
				}
			}
		});
		
		pri_style_css += PageSetting.getConfigStyle();

		//
		box_style = filterBoxCss(box_style);
		var temp_style = '';
		$data_clear.find('.bg_container>div').each(function(){
				temp_style = $(this).data('lazy-bg');
				$(this).removeAttr('data-lazy-bg');
				$(this).attr('data-lazy',temp_style);
				//$(this).attr('data-lazy','url(' + temp_style + ')');
				$(this).attr('style', 'background-image:none');
		});

		$data_clear.find('img').each(function(){
				temp_style = $(this).attr('src');
				$(this).attr('data-lazy',temp_style);
				$(this).removeAttr('src');
		});
		if(_type!="save"&&!validateHtml($data_clear)) return null;
		var $_outer = document.createElement('div');
		var $_outer = $($_outer).append($data_clear);


		var code = {
			box_style:box_style,					//box 
			mod_style:mod_style + pri_style_css,	// + 
			//pri_style:pri_style_css,				// 
			bg_style:BgFun.getBgStyle(),					//
			body:$data.html(),						//html
			body_clear:$_outer.html(),			//
			body_share_js: BgFun.getShareConfig()     //js
		}
		//if(page_info.page_url_name == "12"){
		if(_type!="save") {
			try {
				var page_info = localStore.getPageDataById(Fun.getUrlParam("id")).data.value;
				if (Fun.toWeidianArray.indexOf(page_info.page_url_name)>=0) {
					$("#js_mod_container", $data_clear).addClass("zoom").css("position", "relative").css("margin-bottom", "100px");
					$(".store_entrance_a", $data_clear).remove();
					$(".entry_h[data-type=mod_store_logo]", $data_clear).remove();
					$("#fixedtoptabs", $data_clear).css("position","relative");
					$("#fixedtableft", $data_clear).css("position","relative");
					$("#fixedtabs", $data_clear).parent().remove();

					var $_outer2 = document.createElement('div');
					var $_outer2 = $($_outer2).append($data_clear);
					code.body_clear2 = $_outer2.html();
				}
			}catch(e){};
		}
		//}
		return code;
	};
	//HTML
	var validateHtml = function(data){
		var	page_info = localStore.getPageDataById(Fun.getUrlParam("id"));
		if(page_info==null){
			alert("");
			return false;
		}
		var pageurlname = page_info.data.value.page_url_name;
		if(pageurlname==""||pageurlname==null){
			Fun.alert("");
			return false;
		}

		//Fun.toWDTab5urlname
		//if((pageurlname==""&&$(".mod_goods_list").length>0)||(pageurlname!=""&&Fun.is_pop_shop()&&$(".js_mod_product").length>0)){
		//	alert("");
		//	$("#J_infoedit").addClass("on");
		//	return false;
		//}

		var flag = true;
		var reg = /^\/\/(wq.jd.com\/item\/view\?sku=.*$|item.jd.com\/\d*\.html$|item.m.jd.com\/.*$)/i;
		if((pageurlname!="" && Fun.toWDTab5.indexOf(pageurlname) === -1) && Fun.is_pop_shop()) {
			$.each($(".mod_a_link"), function (i, item) {
				var url = $(item).attr("href").replace(/^http:/, '');
				if (reg.test(url)) {
					alert(":" + $(item).attr("href") + " \n");
					flag = false;
					return false;
				}
			});
			$.each($(".mmrp_mod_poster"),function(i,item){
				var url = $(item).attr("href").replace(/^http:/, '');
				if (reg.test(url)) {
					alert(":"+url+" \n");
					flag = false;
					return false;
				}
			});
		}
		if(flag) {
			$.each($(".mmrp_mod_poster"), function (i, item) {
				var url = $(item).attr("href");
				if (url != null && url.indexOf("//") >= 0 && !Fun.is_JD_QQ_url(url)) {
					alert(':' + url + ',\nQ');
					flag = false;
					return false;
				}
			});
		}
		if(flag) {
			$.each($(".mod_a_link"), function (i, item) {
				var url = $(item).attr("href");
				if (url != null && url.indexOf("//") >= 0 && !Fun.is_JD_QQ_url(url)) {
					alert(':' + url + ',\nQ');
					flag = false;
					return false;
				}
			});
		}
		return flag;
	}


	/**
	 * 
	 * @param {Object} folder_dir 
	 */
	exports.makeFile = function(folder){
		//
		//if($(".mod_goods_list[is-dirty=1]").length>0){
		//	$(".mod_goods_list[is-dirty=1]").eq(0).trigger("click");
		//	Fun.alertLoading("",1500);
		//	alert("");
		//	return;
		//}
		folder = folder ||  "release";
		_folder = folder;
        var layout_id = Fun.getUrlParam("layout_id"),
            template_id =  Fun.getUrlParam("template_id"),
            page_id = Fun.getUrlParam("id"),
		    page_info = localStore.getPageDataById(page_id),
			layout_data = localStore.getLayoutDataById(layout_id),
			//
			//img_src =  BgFun.getImgPath().absolute_path,
			//real_src = c.real_img + page_id + '/',
			
			//img_src1 =  img_src.replace(page_id + '/', ''),
			//real_src1 = real_src.replace(page_id + '/', ''),
			//replace_url = Fun.getUoloadsrc('root');
			file_data = setTemplate();
			if(file_data==null) return null;
			var js_data = file_data.js,
			html_data = file_data.html,
			css_data = file_data.css,
			folder_dir = Fun.getUoloadsrc('index');


		html_data = html_data.replace(/data-c-id/g, 'id');
		//
		var isIDC = 0;
		if(folder.indexOf("_temp") === -1){
			isIDC = 1;
		}
		//if(folder.indexOf("_temp") === -1){
			//console.log(html_data,img_src1,real_src1);
		//html_data = Fun.replaceAll(html_data,replace_url,'.');
		//};
		html_data = html_data.replace(/\<\! \-\-\#/gi, '<!--#');


		var mkq = $.post(c.root + "mk_file.php?g_tk="+Fun.$getToken(), {
			folder: folder_dir,
			page_id:page_id,
			venderid : Fun.getVenderId(),
			layout_id:layout_id,
			page_type : page_info.data.value.page_type,
			html: html_data,
			html2:file_data.html2,
			cssi:js_data,
			charset:layout_data.layout_charset,
			css:css_data,
			isIDC:isIDC
		});
		//console.info(layout_data,"code.bg_style")
		return mkq;
		
	};

	exports.init = function(){
	};
	
});
;/**
 * 
 */
define("mmrp.preview",function(require, exports, module) {  
	var $ = require('jquery'),
    	Fun = require('mmrp.func'),
    	Make = require('mmrp.make.file');
    	
	/**
	 * layout  
	 */
	var layout_id = Fun.getUrlParam("layout_id");

	
	var model = {
		preview_btn			:"#js_preview_btn"								//
	};
	
	/**
	 * layout localStore
	 */
	var setLayoutToCache = function(){
//			var layout_id = Fun.getUrlParam("layout_id");
//		var layout = localStore.getLayoutDataById(layout_id);
//		//
////        console.log('setLayoutToCache');
//
//		// !layout
//		if (!layout) {
//			// RestApi.getLayoutById(layout_id).success(function(data){
//				// localStore.setLayoutDataById(layout_id,data);
//			// });
//			RestApi.getLayout().success(function(data){
//				if(data && data.data){
//					localStore.setLayoutData(data);
//				}
//			});
//
//		};
	};
	
	
	var winOpenByUrl = function(url){
		open(url);
	};
	
	
	var Events = {
		/**
		 *  
		 */
		preview:function(){
			var clicking = false;
			$(model.preview_btn).on('click.pre',function(){
				$('#J_buildStep').trigger('alertToSaveInfo', function(){
					if(clicking) return;
					clicking = true;
					setTimeout(function(){
						clicking = false;
					},1000);
					$('#js_save_draft_btn').trigger('click.save');

					var mkq = Make.makeFile('release_temp');
					if(mkq==null) {
						return;
					}
					mkq.success(function(data){
						if(data.indexOf('disk') > -1){
							alert('!');
						}else if(data!=0){
							alert(data);
							return;
						}
						var access_url = './preview.html?page=' + Fun.getUoloadsrc('previewindex') + "/preview.shtml&v=" + new Date().getTime();
						winOpenByUrl(access_url);
					});
				});

			});
		},
		
		init:function(){
			this.preview();
		}
		
	};
	
	
	exports.init = function(){
		setLayoutToCache();
		Events.init();
	};
	
});
;/**
 *  localstroe  ajax  deferred 
 */
define("mmrp.deferred",function(require, exports) {

    var localStore = require('mmrp.localstore'),
        RestApi = require('mmrp.rest');

    var $ = require('$');

    /**
     * deferred
     * @param cacheData localstore
     * @returns {*}
     */
    var baseCacheDeferred = function(cacheData){
        var defer = $.Deferred();
        defer.resolve(cacheData);
        return $.when(defer.promise());
    };

    /**
     * layout
     * @returns {}
     */
    exports.getLayoutData = function(params){
        var data = localStore.getLayoutData(),
            def = data ? baseCacheDeferred(data) : RestApi.getLayout(params);
        def.done(function(data){
            localStore.setLayoutData(data);
        });
        return def;
    };


    /**
     * page
     * @param page_id
     * @returns {}
     */
    exports.getPageDataById = function(page_id){
        var data = localStore.getPageDataById(page_id),
            def = data ? baseCacheDeferred(data) : RestApi.getPageById(page_id);
        def.done(function(data){
            localStore.setPageDataById(page_id,data);
        });
        return def;
    };

    /**
     * 
     * @returns {promise}
     */
    exports.getModData = function(){
        var data = localStore.getModData(),
            def = data ? baseCacheDeferred(data) : RestApi.getModListByCate(-1);
        def.done(function(data){
            localStore.setModData(data);
        });
        return def;
    };


    /**
     * 
     * @param mod_id
     * @returns {*}
     */
    exports.getModDataById = function(mod_id){
        var data = localStore.getModDataById(mod_id);
        return data ? baseCacheDeferred(data) : RestApi.getModDataById(mod_id);
    };


    exports.getModBaseData = function(){
        var data = localStore.getModBaseData(),
            def = data ? baseCacheDeferred(data) : RestApi.getBaseModData();
        def.done(function(data){
            localStore.setModBaseData(data);
        });
        return def;
    };


    /**
     *  
     */
    exports.getModCateList = function(){
        var data = localStore.getModCateList(),
            def = data ? baseCacheDeferred(data) : RestApi.getCateList();
        def.done(function(data){
            localStore.setModCateList(data);
        });
        return def;
    };

    /**
     *  
     */
    exports.getPageUrls = function(params){
        var data = localStore.getPageUrls(),
            def = data ? baseCacheDeferred(data) : RestApi.getUrlList(params);
        def.done(function(data){
            localStore.setPageUrls(data);
        });
        return def;
    };
    /**
     *  
     */
    exports.getGoodModelPages = function(params){
        var def = RestApi.getGoodModelPages(params);
        return def;
    };
    /**
     * 
     * @param key    ID
     * @param local_key     _p,_a,_q
     * @returns {*}
     */
    exports.searchProjectListByBid = function(key,local_key){
        var data = localStore.getProjectListByBid(key+local_key),
            def = data ? baseCacheDeferred(data) : RestApi.getProjectListByBid(key,local_key);
        def.done(function(data){
            localStore.setProjectListByBid(key+local_key,data);
        });
        return def;
    };
});;/***
 * hugohua
 */
define("mmrp_wx.rest",function(require, exports, module) {
	var $ = require('jquery'),
		c = require('mmrp.config.user');

	var defaults = {
		dataType : "json"
	};
	var $ajax = $('#J_loading');
	if($ajax.length <= 0){
		var ajaxDom = '<div id="J_loading" class="ui_tips ui_tips_show"><div class="J_txt">...</div></div>';
    	$('body').append(ajaxDom);
	}
    $ajax = $('#J_loading');
    
    $(document).ajaxStart(function() {
        $ajax.show();
    }).ajaxComplete(function(){
        $ajax.hide();
    });
    function getCookie(c_name) {
	    if (document.cookie.length > 0) {
	        c_start = document.cookie.indexOf(c_name + "=");
	        if (c_start != -1) {
	            c_start = c_start + c_name.length + 1;
	            c_end = document.cookie.indexOf(";", c_start);
	            if (c_end == -1) c_end = document.cookie.length;
	            return unescape(document.cookie.substring(c_start, c_end));
	        }
	    }
	    return "";
	}

    function $getToken(){
    	var skey=getCookie('skey');
    		token=skey==null?"":$time33(skey);
    	return token;
    };


    function $time33(str){
        //time33
        for(var i = 0, len = str.length,hash = 5381; i < len; ++i){
           hash += (hash << 5) + str.charAt(i).charCodeAt();
        };
        return hash & 0x7fffffff;
    }
	/***
	 * api url
	 * @param {Object} api_name
	 */
	var getUrl = function(api_path) {
		if(api_path.indexOf('?') > -1){
			api_path += '&g_tk=' + $getToken();
		}else{
			api_path += '?g_tk=' + $getToken();
		}
		var url = c.root + api_path;
		return url;
	};
	/***
	 *
	 * @param {Object} params
	 * @param {Object} type GET/POST/PUT/DELETE
	 */
	var baseRest = function(params, type) {
		$.extend(params, defaults);
		params.type = type || "GET";
		var jxhr = $.ajax(params);
		return jxhr;
	};
	//MMRP
	
	/**
	 * 
	 * @param {Object} params
	 */
	exports.getModListByCate = function(cate_id, params) {
		params = params || {};
		//			params.url = getUrl("json_data/tb_mod.txt");
		params.url = getUrl("php/hander.php?act=getModByCategory&category=" + cate_id);
		return baseRest(params);
	};
	/**
	 * ID
	 * @param {Object} mod_id
	 * @param {Object} params
	 */
	exports.getBaseModDataById = function(mod_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getBaseStyleById&id=" + mod_id);
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getBaseModData = function(params) {
		params = params || {};

		params.url = getUrl("php/hander.php?act=getBaseStyleList");
		//			params.url = getUrl("json_data/tb_mod_base_style.txt");
		return baseRest(params);
	};
	/**
	 * ID
	 * @param {Object} id
	 */
	exports.getModDataById = function(id, params) {
        console.trace()
		params = params || {};
		params.url = getUrl("php/hander.php?act=getModById&id=" + id);
		//			params.url = getUrl("json_data/tb_mod_by_id_"+ id +".txt");
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.delModById = function(mod_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=delModById&id=" + mod_id);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.delLayoutById = function(layout_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=delLayoutById&id=" + layout_id);
		return baseRest(params);
	};
	/**
	 * IDtheme
	 * @param {Object} theme_id
	 * @param {Object} params
	 */
	exports.getThemeById = function(theme_id, params) {
		params = params || {};
		//			params.url = getUrl("json_data/tb_theme_by_id_"+ theme_id +".txt");
		params.url = getUrl("php/hander.php?act=getThemeById&id=" + theme_id);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.getPageList = function(start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageList" + "&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.getPageListPage = function(start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListPage" + "&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * IDpage
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.getPageById = function(page_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageById&id=" + page_id);
		//			params.url = getUrl("json_data/tb_page_by_id_"+ page_id +".txt");
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_id
	 * @param {Object} params
	 */
	exports.delPageById = function(page_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=delPageById&id=" + page_id);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_user
	 * @param {Object} params
	 */
	exports.getPageListByNotUser = function(page_user, start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListByNotUser&user=" + page_user + "&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_user
	 * @param {Object} params
	 */
	exports.getPageListByAuthorize = function(page_user, start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListByAuthorize&user=" + page_user + "&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * page
	 * @param {Object} page_user
	 * @param {Object} params
	 */
	exports.getPageByUser = function(page_user, start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageByUser&user=" + page_user + "&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * page
	 */
	exports.getPageListByState = function(state, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListByState&state=" + state);
		return baseRest(params);
	};
	/**
	 * path
	 */
	exports.testPath = function(data, cb) {
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=testPath"),
			success : function(t_data){
				cb && cb(t_data);
			}
		};
		return baseRest(params, 'POST');
	};
	/**
	 * 
	 */
	exports.getPageListByWeek = function(start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListByWeek&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getPageListByMonth = function(start, num, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageListByMonth&start=" + start + "&num=" + num);
		return baseRest(params);
	};
	/**
	 * page  
	 * @param {Object} page_user
	 * @param {Object} params
	 */
	exports.getPageByDraft = function(page_user, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageByDraft&user=" + page_user);
		return baseRest(params);
	};
	/**
	 *  
	 * @param {Object} user_name
	 * @param {Object} params
	 */
	exports.getUserByName = function(user_name, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUserByName&user=" + user_name);
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getUserList = function(params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUserList");
		return baseRest(params);
	};


	/**
	 * 
	 */
	exports.insertUser = function(user_name,params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=insertUser&user=" + user_name);
		return baseRest(params);
	};


	/**
	 * 
	 @ @param {int} power
	 * @param {Object} params
	 */
	exports.getUserListByPower = function(power,params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUserListByPower&power=" + power);
		return baseRest(params);
	};

	/**
	 * 
	 * @param {string} user_id
	 * @param {string} power
	 * @param {Object} params
	 */
	exports.setUserPower = function(user_id,power,params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=setUserPower&user_id="+user_id+"&power="+power);
		return baseRest(params);
	};

	/**
	 *   
	 * @param {string} type
	 * @param {string} user
	 * @param {Object} params
	 */
	exports.getPageCountByType = function(type, user, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageCountByType&type=" + type + "&user=" + user);
		return baseRest(params);
	};
	/**
	 * IDTmplate
	 * @param {Object} Tmplate_id
	 * @param {Object} params
	 */
	exports.getTemplateById = function(tmplate_id, params) {
		params = params || {};
		//			params.url = getUrl("json_data/tb_tmplate_by_id_"+ tmplate_id +".txt");
		params.url = getUrl("php/hander.php?act=getTemplateById&id=" + tmplate_id);
		return baseRest(params);
	};
	/**
	 * 5
	 * @param {Object} tmplate_id
	 * @param {Object} params
	 */
	exports.delTemplateDraft = function(tmplate_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=delTemplateDraft&id=" + tmplate_id);
		return baseRest(params);
	};
	/**
	 * JSON
	 * @param {Object} url
	 */
	exports.getJson = function(url, data) {
		data = data || {};
		var req = $.getJSON(url, data);
		return req;
	};
	/**
	 * 
	 * @param {Object} data
	 */
	exports.postAddData = function(data) {
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=insert"),
			success : function(t_data){
				if(t_data.error){
					alert(t_data.message);
				}
			}
		};
		return baseRest(params, "POST");
	};
	/**
	 * 
	 * @param {Object} data
	 */
	exports.postUpdata = function(data) {
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=update"),
			success : function(t_data){
				if (t_data.errorCode) {
					alert(t_data.errorMsg);
				}
			}
		};
		return baseRest(params, "POST");
	};
	/**
	 * 
	 * @param {Object} them	url
	 * @param {Object} page_id Id
	 */
	exports.updatePageThumbnailById = function(thum, page_id, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=updatePageThumbnail&id=" + page_id + "&thum=" + thum);
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getUserPower = function(params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUserPower");
		return baseRest(params);
	};
	/**
	 * $mod_id : Id
	 *  -1   11
	 *
	 */
	exports.updateModFrequency = function(mod_id, state, params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=modFrequency&mod_id=" + mod_id + "&state=" + state);
		return baseRest(params);
	};
	/***
	 * RTX
	 * data = {
	 *		title:"RTX",
	 *		receiver:"",
	 *		msginfo:""
	 *	}
	 */
	exports.sendRtxMsg = function(data) {
		var params = {
			data : {
				data : data
			},
			url : getUrl("inc/send_msg.php?act=sendrtx")
		};
		return baseRest(params, "POST");
	};
	/***
	 * Email
	 * data = {
	 *		subject:"subject",
	 *		receiver:"receiver",
	 *		msg:"msg"
	 *	}
	 */
	exports.sendEmail = function(data) {
		var params = {
			data : {
				data : data
			},
			url : getUrl("inc/send_msg.php?act=sendemail")
		};
		return baseRest(params, "POST");
	};
	/**
	 * 
	 */
	exports.getUserCountPage = function(params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUserCountPage");
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getPageCountByData = function(params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getPageCountByData");
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.getModFrequency = function(params) {
		params = params || {};
		params.url = getUrl("php/hander.php?act=getModFrequency");
		return baseRest(params);
	};
	/**
	 * 
	 */
	exports.checkLoginUser = function(data) {
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=checkLoginUser")
		};
		return baseRest(params, "POST");
	};
	
	/**
	 *  
	 */
	exports.createPage = function(data){
		var params = {
			data: data,
			url : getUrl("php/hander.php?act=wx_createPage")
		};
		return baseRest(params, "POST");
	};
	
	/**
	 *  
	 */
	exports.clonePage = function(data){
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=clonePage")
		};
		return baseRest(params, "POST");
	};
	
	/**
	 * layout id  
	 */
	exports.getLayoutById = function(layout_id,params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=getLayoutById&id=" + layout_id);
		return baseRest(params);
	};
	
	/**
	 *  
 	 * @param {Object} page_id
 	 * @param {Object} data
	 */
	exports.saveDraft = function(page_id,data){
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=saveDraft&id=" + page_id)
		};
		return baseRest(params, "POST");
	};
	
	/**
	 *  
 	 * @param {Object} page_id
 	 * @param {Object} template_id
 	 * @param {Object} data
	 */
	exports.publishPage = function(page_id,template_id,data){
		var params = {
			data : data,
			url : getUrl("php/hander.php?act=publishPage&page_id=" + page_id + "&template_id=" + template_id)
		};
		return baseRest(params, "POST");
	};
	
	/**
	 * layout id  
	 */
	exports.getLayout = function(params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=getLayout");
		return baseRest(params);
	};
	
	/**
	 *  
	 */
	exports.getCateList = function(params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=getCateList");
		return baseRest(params);
	};
	
	/**
	 *  
	 */
	exports.getUrlList = function(params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=getUrlList");
		return baseRest(params);
	};
	
	/**
	 *  
	 */
	exports.delCateById = function(cate_id,params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=delCateById&id=" + cate_id)
		return baseRest(params);
	};
	
	/**
	 *  
	 */
	exports.delUrlById = function(url_id,params){
		params = params || {};
		params.url = getUrl("php/hander.php?act=delUrlById&id=" + url_id)
		return baseRest(params);
	};
	
	/**
	 *  
	 */
	exports.updateLocalStore = function(key,params){
		params = params || {};
		params.url = getUrl("php/edit_config.php?act=localstore&key=" + key)
		return baseRest(params);
	};

    /* ============= import ================= */
    exports.unzip = function(zipFile,params){
        params = params || {};
        params.url = getUrl("unzip/" + zipFile);
        return baseRest(params);
    };

    exports.getPat = function(params){
        params = params || {};
        params.url = getUrl("jdpat");
        return baseRest(params);
    };

    exports.getPatById = function(id,params){
        params = params || {};
        params.url = getUrl("jdpat/" + id);
        return baseRest(params);
    };

    exports.getPatByUser = function(user,params){
        params = params || {};
        params.url = getUrl("jdpat/user/" + user);
        return baseRest(params);
    };

    exports.putPatById = function(data){
        var params = {
            data:data,
            url:getUrl("jdpat/"+data.jdpat.jdpat_id)
        };
        return baseRest(params,'PUT');
    };

    exports.delPatById = function(id,params){
        params = params || {};
        params.url = getUrl("jdpat/" + id);
        return baseRest(params,'DELETE');
    };

    exports.getUrl = function(params){
        params = params || {};
        params.url = getUrl("url");
        return baseRest(params);
    }
});;/**
 *  
 *
 */
define("mmrp_wx.mod.base",function (require, exports) {

    var $ = require('jquery'),
        Mustache = require('mustache'),
        localStore = require('mmrp.localstore'),
        Deferred = require('mmrp.deferred'),
        Fun = require('mmrp.func'),
        RestApi = require('mmrp_wx.rest');


    var $doc = $(document);

    var msg = {
        create_error: ',',
        cancel_warn: '',
        validate: '',
        save_error: ''
    };

    var model = {
        tpl_id: '#js_one_template',
        temp_container: '#js_item_list',
        clone_btn: '.js_clone_btn',
        new_btn: '.js_new_template_btn',
        del_btn: '.js_del_btn',
        edit_btn: '#js_edit_btn',                         //
        layout_tmpl: '#js_layout_tmpl',
        form: '#js_form',
        page_type: '#js_page_type',
        page_filename: '#js_page_filename',
        $devicePc: $('#J_devicePc'),
        $deviceMb: $('#J_deviceMobile'),
        share_title: '#js_share_title',
        share_img: '#js_share_img',
        share_desc: '#js_share_desc',
        share_ptag: '#js_share_ptag'

//        base_pop        :   $('#J_mod_baseinfo')
    };

    var page_config = {
        'theme_width': $('#js_width_input').val(),
        'theme_height': $("#js_height_input").val(),
        'layout_id': 1
        //'layout_id' : 11
    };
    var baimingdan = ["11468", "113630", "117964", "86348", "11215884629", "88952", "76427", "73015", "44269", "21157"];
    //  
    var selectorInfo = {
        bid: 1,
        bname: '',
        projectid: '',
        activeid: '',
        positionid: ''
    };
    var materiaId = null;


    /**
     * json 
     * @param {Object} data
     */
    var handTemplate = function (data) {
        var data = data;
        for (var n in data.value) {
            data.value[n].page_thumbnail = data.value[n].page_thumbnail || "img/tp_item.png";
        }
        return data;
    };


    var getUrlList = function () {
        return Deferred.getPageUrls({venderid: Fun.getVenderId()}).done(function (data) {
            if (data && data.data) {
                var tpl = $('#js_type_tmpl').html(),
                    html = Mustache.to_html(tpl, data.data);

                $('#js_page_type').append(html);
            }
        });

    };


    /**
     * layout
     */
    var getLayout = function () {
        return Deferred.getLayoutData({venderid: Fun.getVenderId()}).done(function (data) {
            if (data && data.data) {
                var data = handTemplate(data.data),
                    tpl = $(model.layout_tmpl).html();
                var listHtml = Mustache.to_html(tpl, data);
                $(model.temp_container).html(listHtml);
            }
        });
    };
    /**
     * selectorInfo
     */
    var resetSelectInfo = function () {
        var text = $(model.temp_container).find("option:selected").text().substr(0, 2);
        var bid = text == "" ? 1 : 2;
        selectorInfo = {
            bid: bid,
            bname: text,
            projectid: '',
            activeid: '',
            positionid: ''
        };
        $(".area_busness").text(selectorInfo.bname || '');
        $(".area_busness").attr("data-area_busness", selectorInfo.bid || '');

        $(".area_project").text(selectorInfo.projectname || '');
        $(".area_project").attr("data-area_project", selectorInfo.projectid || '');

        $(".area_activity").text(selectorInfo.activename || '');
        $(".area_activity").attr("data-area_activity", selectorInfo.activeid || '');

        $(".area_area").text(selectorInfo.positionname || '');
        $(".area_area").attr("data-area_area", selectorInfo.positionid || '');
        $("#commodList1_3").html("");
    };
    /**
     * 
     * @param page_width
     * @param page_height
     */
    exports.setPageSize = function (page_width, page_height) {
        //100%
        if (page_height == 800) {
            page_height = $(window).height() - 90;
        }

        $("#js_width_input").setValue(page_width);
        $("#js_height_input").setValue(page_height);
        //
        $("#js_mod_container").css({width: page_width + 'px', height: page_height + 'px'});
    };
    var setGlobalJS = function () {
        var _share_img = $(model.share_img).val(),
            _share_title = $.trim($(model.share_title).val()),
            _share_desc = $.trim($(model.share_desc).val()),
            _share_ptag = $(model.share_ptag).val();

        var share_config = {'img': _share_img, 'title': _share_title, 'desc': _share_desc, 'ptag': _share_ptag};
        share_config = JSON.stringify(share_config);
        $js = $('#js_config_input');
        $share = $('#share_input');
        var temp = '';
        var path = window.location.protocol + "//" + window.location.host + window.location.pathname.replace(/[^\/]+$/, '');
        var _share_js_ = ['halo.shareConfig = {',
            'img_url: "//www.paipai.com/promote/2014/ppgcpar/img/share.jpg"',
            'img_width: 80,',
            'img_heigth: 80,',
            'link: ' + path + '"index.html",',
            'title: "' + _share_title + '",',
            'desc: "' + _share_desc + '",',
            '};'].join('');
        $share.val(share_config);
        $js.val(temp + _share_js_);
    };
    /**
     * theme
     */
    var saveTheme = function (theme_id) {
        //js
        setGlobalJS();
        //
        var page_width = $("#js_width_input").val(),
            page_height = $("#js_height_input").val(),
        //area_busness = $(".area_busness:eq(0)").attr("data-area_busness") || '',
        //bname = $(".area_busness:eq(0)").text() || '',
        //area_project = $(".area_project:eq(0)").attr("data-area_project") || '',
        //pname = $(".area_project:eq(0)").text() || '',
        //area_activity = $(".area_activity:eq(0)").attr("data-area_activity") || '',
        //aname = $(".area_activity:eq(0)").text() || '',
        //area_area = $(".area_area:eq(0)").attr("data-area_area") || '',
        //areaname = $(".area_area:eq(0)").text() || '',
            page_js = $('#js_config_input').val(),
            page_share = $('#share_input').val(),
            theme_bgcolor = $('#J_bg_color').val();
        //var theme_area = '[{"class":"area_busness","id":"' + area_busness + '","name":"' + bname + '"},{"class":"area_project","id":"' + area_project + '","name":"' + pname + '"},{"class":"area_activity","id":"' + area_activity + '","name":"' + aname + '"},{"class":"area_area","id":"' + area_area + '","name":"' + areaname + '"}]';
        //$('#target_img').attr('src', $('#js_share_img').val());
        // 
        if (page_width && page_height) {
            //
            exports.setPageSize(page_width, page_height);
            // 
            if (theme_id && !isNaN(theme_id) && theme_id != 0) {
                //theme
                var obj = {
                    data: {
                        table: "theme",
                        value: {
                            theme_width: page_width,
                            theme_height: page_height,
                            theme_js: page_js,
                            theme_share: page_share,
                            theme_bgcolor: theme_bgcolor
                            //theme_area: theme_area
                        },
                        where: theme_id
                    }
                };
                //theme
                RestApi.postUpdata(obj);
            } else {
                Fun.alert(msg.save_error);
            }
        }//end if
    };
    var showLayoutStatus = function (type) {
        if (type != '1') {
            model.$devicePc.hide();
            model.$deviceMb.show();
        } else {
            model.$devicePc.show();
            model.$deviceMb.hide();
        }
    };


    /**
     * 
     * @param data
     */
    var createPageSuccess = function (data) {
        Fun.setUrlParam('id', data.page_id);
        Fun.setUrlParam('theme_id', data.theme_id);
        Fun.setUrlParam('template_id', data.template_id);
        Fun.setUrlParam('layout_id', page_config.layout_id);
        $(model.page_type).trigger("change", ['init']);
    };

    var testPath = function (url, cb) {
        var s_url = url.replace('//mm.wanggou.com/', '');
        var base_url = '/usr/local/c2c/html/newforward/mm/' + s_url;
        RestApi.testPath({path: base_url}).done(function (data) {
            cb && cb(data);
        });
    }

    var getPageInfo2 = function (saleid) {
        var _page_type = $(model.page_type).val();
        var page_obj = Fun.getDbData(model.form);
        var page_fragment = $('#J_page_fragment').val();
        page_obj.page_fragment = page_fragment;

        delete page_obj.share_title;
        delete page_obj.share_img;
        delete page_obj.share_desc;

        if ($.trim($("#js_page_name").val()) == '') {
            Fun.alert("");
            return null;
        }
        if (_page_type == ''||_page_type==null) {
            Fun.alert('');
            return null;
        }

        var img_url = $.trim($(model.share_img).val());
        if ('' == img_url) {
            Fun.alert('');
            return null;
        }

        if('' == $.trim($(model.share_title).val())){
            Fun.alert('');
            return null;
        }

        if('' == $.trim($("#js_share_desc").val())){
            Fun.alert('');
            return null;
        }

        if(!/^https?:\/\/(.*)\.(?:png|jpg|gif)/.test(img_url)){
            Fun.alert('');
            return null;
        }


        // if(_page_type.charAt(_page_type.length - 1) !='/'){
        //     _page_type = _page_type + '/' + ;
        // }        
        var venderid = Fun.getVenderId();
        if(venderid==null){
            Fun.alert('id');
            return null;
        }

        if(!isNaN(parseInt(materiaId))){
            page_obj.page_materiaid = materiaId;
        }

        page_obj.page_type = _page_type + "new/" + (venderid % 1000) + '/' + venderid + '/' + saleid + '/index.shtml';

        var obj = {
            data: {
                table: "page",
                value: page_obj,
                where: saleid
            }
        };
        return obj;
    }

    var setPageInfo = function (data) {
        if (!data) return;
        Fun.setDbData(data);
        var id = Fun.getUrlParam('id');
        var uin = Fun.getUserUin() - 10000000000;
        var filename = uin + '_' + id;
        $('#js_page_filename').val(filename);

    };
    /**
     * 
     */
    var changeActivityByLayout = function () {
        //
        var text = $("#js_item_list").find("option:selected").text().substr(0, 2);
        var opt = $("#js_page_type").children("option");
        opt.each(function(){
            var $this = $(this);
            var name = $this.text();
            if (name.indexOf(text) > -1 || name == "") {
                $this.show();
            } else {
                $this.hide();
            }
        });

        $doc.trigger('setting.reset', ['layoutChange']);
    };

    /**
     * 
     * @returns {boolean}
     */
    var checkHasBg = function () {
        return !!$('#js_act_bg').children().length;
    };

    /**
     * 
     */
    exports.openUploadBg = function () {
        $('#J_bgedit').addClass('on');
        $doc.trigger('show.bgedit', true);
    };

    /**
     * 
     */
    exports.openOther = function () {
        $('#J_other').addClass('on');
        $doc.trigger('show.infoedit', true);
    };

    /**
     * 
     */
    exports.openInfoEdit = function () {
        $('#J_infoedit').addClass('on');
        $doc.trigger('show.infoedit', true);
    };

    var Events = {

        getGoodModel:function(){
            if(Fun.is_pop_shop()) {
                Deferred.getGoodModelPages().done(function (data) {
                    if (data && data.length > 0) {
                        var tpl = $('#js_goodmodel_tmpl').html();
                        var options = {value: data};
                        var html = Mustache.to_html(tpl, options);

                        $('#select_goodmodel').append(html);
                    }
                });
            }
            $("#select_goodmodel").on("change",function(){
                var val = $(this).val();
                if(!+val) return;
                Fun.confirm2('<div class="publish_cnt"></div>', {
                    ok: function () {
                        var page_info = localStore.getPageDataById(Fun.getUrlParam("id"));
                        if(page_info){
                            var options={};
                            options.notNeedAlert = true;
                            options.goodModel=val;
                            $("#js_save_draft_btn").trigger("click",options);
                        }else{
                            Fun.useGoodModel(val);
                        }

                    },
                    cancel: function () {
                        $("#select_goodmodel option:eq(0)").prop("selected", true);
                    }
                });
            });
        },
        showModal: function () {
            //pageId
            var page_id = Fun.getUrlParam('id') || Fun.getUrlParam("pageId"),
                layout_id = Fun.getUrlParam('layout_id');

            //pageid 
            if (!page_id) {
                exports.openInfoEdit();
            } else{
                var data = localStore.getPageDataById(page_id);
                if (data && data.data && data.data.value) {
                    setPageInfo(data.data.value);
                    setActivityInfo();
                } else {
                   exports.openInfoEdit();
                }
            }

            changeActivityByLayout();
            $(model.page_type).trigger("change", ['init']);

            if (layout_id) {
                showLayoutStatus(layout_id);
            }
            //pop
            $doc.on({
                'show.infoedit': function (e, open) {
                    //
                    $("#J_infoedit .build_step_pop").css("max-height", window.screen.availHeight - 200);
                },

                'show.bgedit': function (e, open) {
                    if (!open) return;
                    var tips = !checkHasBg() ? 'JPGPNG' : '';
                    $('#J_uploadTips').text(tips)
                }
            });
        },


        /**
         * 
         */
        editPage: function () {
            $(model.edit_btn).on("click.newjs", function () {
                var rurl = $('#js_redirection_url').val();
                var rtime = $('#js_redirection_time').val();
                var $this = $(this),
                    page_id = Fun.getUrlParam('id'),
                    theme_id = Fun.getUrlParam("theme_id"),
                    validate = Fun.validate(model.form);

                if($this.text() === "..."){
                    return;
                } else {
                    $this.text("");
                }

                if ($("#J_redirection_settings").is(":hidden")) {
                    rurl = '';
                    $('#js_redirection_url').val("");
                    rtime = '';
                    $('#js_redirection_time').val("");
                }

                if ($.trim(rurl) != '' && rtime != '') {
                    if (!Fun.is_JD_QQ_url(rurl)) {
                        Fun.alert('Q');
                        $this.text("");
                        return false;
                    }
                }

                var saveInfo = function(ids){
                    var info_obj = getPageInfo2(ids.page_id);
                    saveTheme(ids.theme_id);
                    RestApi.postUpdata(info_obj).success(function (data) {
                        var options={};

                        if (data.success) {
                            localStore.setPageDataById(ids.page_id, info_obj);
                            window.__materiaid = materiaId || window.__materiaid;
                            materiaId = null;
                            options.notNeedAlert = true;
                            $("#js_save_draft_btn").trigger("click",options);

                            $('#J_infoedit').removeClass('on');
                            $this.text("");
                            Fun.alert('!');

                        }
                    });
                };

                if(getPageInfo2(page_id) == null){
                    $this.text("");
                    return;
                }

                if (validate) {
                    if (!page_id) {
                        page_config.materia_id = window.__materiaid;
                        RestApi.createPage(
                            page_config
                        ).done(function(data){
                                if (data && data.page_id && data.theme_id) {
                                    createPageSuccess(data);
                                    saveInfo(data);

                                } else {
                                    if(data.errorCode == -17){
                                        Fun.alert(data.errorMsg);
                                    } else {
                                        Fun.alert(msg.create_error);
                                    }
                                }

                            })
                            .fail(function(){
                                Fun.alert("",1500);
                                $('#J_infoedit').removeClass('on');
                                $this.text("");
                            });
                    } else {
                        saveInfo({"page_id": page_id, "theme_id": theme_id});
                    }
                } else {
                    Fun.alert(msg.validate);
                    $this.text("");
                }

                return false;
            });
        },
        /**
         * urljs_page_dir,js_page_url_name
         * @param url
         * @param text
         */
        handleChangeUrl: function (url, text) {
            var oldurlname = $("#js_page_url_name").val();

            $doc.trigger('mod_list.reset', [text]);
            $doc.trigger('edit_area.reset', [text, oldurlname]);
            $doc.trigger('setting.reset', ['activityChange', text]);

            if(Fun.getUrlParam('layout_id') == 16){
                $('#js_page_type').closest('tr').hide();

                return;
            }

            $('#js_page_type').closest('tr').show();
            $('#js_page_dir').val(url);
            $("#js_page_url_name").val(text);
        },
        /**
         * 
         * type="init" trigger,
         */
        changeUrl: function () {
            var self = this;

            $(model.page_type).on("change", function (e, type) {
                var val = $(this).val();
                var text = $(this).find("option:selected").text();

                if (type == "init") {
                    self.handleChangeUrl(val, text);
                    return;
                }

                Fun.confirm2('<div class="publish_cnt">,,</div>', {
                    ok: function () {
                        self.handleChangeUrl(val, text);
                        //
                        if (text != "" && Fun.is_pop_shop()) {
                            var htmls = "", index = null;
                            if (text.indexOf("") > -1) {
                                htmls = '<div class="selector_item on" data-tag="business" data-id="1" title="" id="business_wx"> <div class="selector_name"></div> <i></i></div>';
                            } else if (text.indexOf("Q") > -1) {
                                htmls = '<div class="selector_item" data-tag="business" data-id="2" title="Q" id="business_sq"> <div class="selector_name">Q</div> <i></i></div>';
                                index = 2;
                            }
                            $("#selector_business").html(htmls);
                        }
                        //
                        $("#js_pop_guide").removeClass("build_bar_open");
                    },
                    cancel: function () {
                        var url = $('#js_page_dir').val();
                        $("#js_page_type option[value='" + url + "']").prop("selected", true);
                    }
                });
            });
        },

        /**
         *  
         * @param target
         * @param source
         */
        cloneA: function (target, source) {
            for (var n in source) {
                target[n] = source[n];
            }
        },

        /**
         * 
         */
        bindActivityEvent: function () {
            var self = this;

            //
            $("#activityBtnFinish").on("click", function (e) {
                var index = $(e.target).data("index");
                if (index == "ok") {
                    if (selectorInfo.positionid == null || selectorInfo.positionid == "" || selectorInfo.activeid == "") {
                        Fun.alert("");
                        return;
                    }
                    if (selectorInfo.source == "goodslist") {
                        $("#activityBtnFinish_goodslist").trigger("click", selectorInfo);
                    } else if (selectorInfo.source == "goodsone") {
                        $("#activityBtnFinish_goodsone").trigger("click", selectorInfo);
                    }
                    //
                    //if ((selectorInfo.activeid != selectorInfoReal.activeid || selectorInfo.positionid != selectorInfoReal.positionid)) {
                    //    $("#js_pop_guide").removeClass("build_bar_open");
                    //    //
                    //    $(".mod_goods_link").parent().parent().remove();
                    //    $(".mod_goods_list").parent().parent().remove();
                    //}


                }
                $("#wdpat_activity_modal").hide();
            });

            //
            $("#wdpat_activity_modal").on("click", ".selector_item", function (e) {
                var tag = $(e.target).data("tag");
                if (tag == null) {
                    e = $(e.target).parent("div");
                }
                tag = $(e).data("tag");
                if (tag == null) return;
                $(this).addClass("on").siblings(".selector_item").removeClass("on");
                var id = $(e).data("id"),
                    _title = $(e).attr("title");

                if (tag == "business") {//
                    selectorInfo.bname = _title;
                    self.chooseProject(id);
                } else if (tag == "project") {//
                    selectorInfo.projectname = _title;
                    self.chooseActivity(id);
                } else if (tag == "activity") {//
                    selectorInfo.activename = _title;
                    self.choosePosition(id);
                } else if (tag == "position") {//
                    selectorInfo.positionname = _title;
                    selectorInfo.positionid = id;
                }
            });

            //keyup  blur
            $("#wdpat_activity_modal input[type='search']").on("keyup blur", function (e) {
                var value = $(this).val();
                var a = $(this).parent().next("div").children("div");
                $.each(a, function (i) {
                    var htmls = a.eq(i);
                    if (htmls.text().indexOf(value) >= 0) {
                        htmls.show();
                    } else {
                        htmls.hide();
                    }
                });
            });
            //
            $("#area_update_btn_edit").on("click", function (e, infomation) {
                //if ($("#wdpat_activity_modal").is(":visible")) return;
                //if (selectorInfo.positionid == null || selectorInfo.positionid == "") {
                selectorInfo.bid = infomation.bid;

                selectorInfo.projectid = infomation.projectid;

                selectorInfo.activeid = infomation.activeid;

                selectorInfo.positionid = infomation.positionid;
                selectorInfo.source = infomation.source;
                //}
                self.chooseProject();
                $("#wdpat_activity_modal").show();

            });
        },
        /**
         * 
         * @param index 
         */
        clearPageHtml: function (index) {
            if (index == 1) {
                selectorInfo.projectid = 0;
                selectorInfo.activeid = 0;
                selectorInfo.positionid = 0;
                $('#selector_position').html("");
                $('#selector_activity').html("");
                $('#selector_project').html("");
            } else if (index == 2) {
                selectorInfo.activeid = 0;
                selectorInfo.positionid = 0;
                $('#selector_position').html("");
                $('#selector_activity').html("");
            } else if (index == 3) {
                $('#selector_position').html("");
                selectorInfo.positionid = 0;
            }
        },
        /**
         * 
         * @param id
         */
        choosePosition: function (id) {
            var selected = false;
            if (id != null) {
                if (selectorInfo.activeid == id) return;
                selectorInfo.activeid = id;
                this.clearPageHtml(3);
            } else {
                id = selectorInfo.activeid;
                selected = true;
            }
            $("#J_loading").show();
            $("#selector_position").prev("div").find("input[type='search']").val("").trigger("blur");
            Deferred.searchProjectListByBid(id, "_q").done(function (data) {
                var tpl = $('#js_position_tmpl').html(),
                    html = Mustache.to_html(tpl, data.data);
                $('#selector_position').html(html);
                $("#J_loading").hide();
                //selected id
                if (selected && selectorInfo.positionid != null && selectorInfo.positionid != "") {
                    window.setTimeout(function() {
                        $("#selector_position > div[data-id='" + selectorInfo.positionid + "']").addClass("on").get(0).scrollIntoView(false);
                    },10);
                }
            });
        },

        /**
         * 
         * @param id
         */
        chooseActivity: function (id) {
            var selected = false;
            if (id != null) {
                if (selectorInfo.projectid == id) return;
                selectorInfo.projectid = id;
                this.clearPageHtml(2);
            } else {
                id = selectorInfo.projectid;
                selected = true;
            }
            $("#J_loading").show();
            var self = this;
            $("#selector_activity").prev("div").find("input[type='search']").val("").trigger("blur");
            Deferred.searchProjectListByBid(id, "_a").done(function (data) {
                if(!data||data.errCode!=0){
                    JD.report.umpBiz({bizid: '65', operation: 2, result: 1, source: '0', message: ""});
                }else{
                    JD.report.umpBiz({bizid: '65', operation: 2, result: 0, source: '0', message: ""});
                }
                var tpl = $('#js_activity_tmpl').html(),
                    html = Mustache.to_html(tpl, data.data);
                $('#selector_activity').html(html);
                $("#J_loading").hide();
                if (selected && selectorInfo.activeid != null && selectorInfo.activeid != "") {
                    window.setTimeout(function() {
                        $("#selector_activity > div[data-id='" + selectorInfo.activeid + "']").addClass("on").get(0).scrollIntoView(false);
                    },10);
                    self.choosePosition();
                } else {
                    self.clearPageHtml(3);
                }
            });
        },

        /**
         * 
         * @param bid ID
         */
        chooseProject: function (id) {
            if (id != null) {
                //if (selectorInfo.bid == id) return;
                selectorInfo.bid = id;
                this.clearPageHtml(1);
            } else {
                id = selectorInfo.bid;
            }
            //
            $("#selector_business").prev("div").find("input[type='search']").val("").trigger("blur");
            var self = this;
            Deferred.getPageDataById(Fun.getUrlParam("id")).done(function (pagedata) {
                if (pagedata == null) return;
                var text = pagedata.data.value.page_url_name, htmls = "";
                if (text.indexOf("") > -1) {
                    htmls = '<div class="selector_item on" data-tag="business" data-id="1" title="" id="business_wx"> <div class="selector_name"></div> <i></i></div>';
                    id = 1;
                    selectorInfo.bname = "";
                } else if (text.indexOf("Q") > -1) {
                    htmls = '<div class="selector_item on" data-tag="business" data-id="2" title="Q" id="business_sq"> <div class="selector_name">Q</div> <i></i></div>';
                    id = 2;
                    selectorInfo.bname = "Q";
                }else if (text.indexOf("") > -1) {
                    htmls = '<div class="selector_item on" data-tag="business" data-id="3" title="" id="business_sq"> <div class="selector_name"></div> <i></i></div>';
                    id = 3;
                    selectorInfo.bname = "";
                }
                //
                if(selectorInfo.bid!=""&&selectorInfo.bid!=id){
                    self.clearPageHtml(1);
                }
                selectorInfo.bid = id;
                $("#selector_business").html(htmls);
                $("#J_loading").show();
                Deferred.searchProjectListByBid(id, "_p").done(function (data) {
                    var text = $("#js_page_url_name").val();
                    if (text == "") {
                        text = pagedata.data.value.page_url_name;
                    }
                    if(!data||data.errCode!=0){
                        JD.report.umpBiz({bizid: '65', operation: 2, result: 1, source: '0', message: ""});
                    }else{
                        JD.report.umpBiz({bizid: '65', operation: 2, result: 0, source: '0', message: ""});
                    }
                    self.handleChooseProject(data.data.projectList, text);
                });
            });
        },
        handleChooseProject: function (data, text) {
            var self = this;
            var array = {};
            //if (text != null) {
            //    array = $.grep(data, function (value, index) {
            //        if (text.indexOf(value.name) > -1) {
            //            selectorInfo.projectid = value.id;
            //            selectorInfo.projectname = value.name;
            //            return true;
            //        }
            //    });
            //} else {
            //    array = data;
            //}
            array = data;
            var tpl = $('#js_project_tmpl').html(),
                html = Mustache.to_html(tpl, {projectList: array});
            $('#selector_project').html(html);
            $("#selector_project").prev("div").find("input[type='search']").val("").trigger("blur");
            $("#J_loading").hide();
            //
            if (selectorInfo.projectid != null && selectorInfo.projectid != "") {
                window.setTimeout(function(){
                    $("#selector_project > div[data-id='" + selectorInfo.projectid + "']").addClass("on").get(0).scrollIntoView(false);
                },10);
                self.chooseActivity();
            }else {
                self.clearPageHtml(2);
            }
        },
        /**
         * 
         */
        createPageEvent: function () {
            var $itemList = $(model.temp_container),
                $cnotainer = $('#js_mod_container'),
                $width = $('#js_width_input');
            var self = this;

            $itemList.on("change", function (e) {
                var $this = $(this),
                    layout = $this.val();

                var layout_id = $(model.temp_container).val();
                Fun.confirm2('<div class="publish_cnt"></div>', {
                    ok: function () {
                        $("#js_pop_guide").removeClass("build_bar_open");
                        resetSelectInfo();
                        Fun.setUrlParam('layout_id', layout);
                        $("#js_item_list_filename").val(layout_id);
                        $("#js_page_type").get(0).selectedIndex = 0;
                        $(model.page_type).trigger("change", "init");
                        changeActivityByLayout();

                    },
                    cancel: function () {
                        $(model.temp_container).val($("#js_item_list_filename").val());
                    }
                });

                return false;
            });

            //trigger 
            //$itemList.on("change.size",function(e){
            //    var $this = $(this),
            //        layout = $this.val();
            //    //PC
            //    if(layout == 1){
            //        $width.val(995);
            //        $cnotainer.css('width',995 + 'px');
            //
            //    }else if(layout == 3){ //mobile
            //        $width.val(720)
            //        $cnotainer.css('width',720 + 'px');
            //    }
            //    showLayoutStatus(layout);
            //})
        },

        /**
         * hash
         */
        hashStatus: function () {
            var open = Fun.getUrlParam('open');
            //open
            if (open === 'bg') {
                exports.openUploadBg();
            }
        },

        init: function () {
            this.editPage();
            this.changeUrl();
            this.createPageEvent();
            this.showModal();
            this.hashStatus();
            this.bindActivityEvent();
            this.getGoodModel();
        }
    };

    //
    //todo 
    function setActivityInfo(){
        var bizType = Fun.getUrlParam('bizType');
        var materiaName = Fun.getUrlParam('materiaName');
        var layout;
        var pageType;
        materiaId = Fun.getUrlParam('materiaId');
        if(!isNaN(parseInt(bizType)) && !isNaN(parseInt(materiaId)) && materiaName.replace(/\s+/, '') != ''){
            layout = [1, 9, 10][bizType - 1];
            pageType = {
                1: 'http://wqs.jd.com/event/seller/brand/',
                9: 'http://wqs.jd.com/event/seller/bigbrand/',
                10: 'http://wqs.jd.com/event/seller/wqappbrand_detail/'
            }[layout];
            $('#js_item_list').val(layout).prop('disabled', true);
            $('#js_page_name').val(decodeURIComponent(materiaName));
            $("#js_page_type").val(pageType).prop('disabled', true);
        }
    }


    exports.init = function () {
        $.when(getLayout(), getUrlList()).done(function(){
            setActivityInfo();
            Events.init();
        });
    }


})  ;define("mmrp.mod.template",function(require, exports, module) {  
	
	var $ = require('jquery'),
	 	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	RestApi = require('mmrp.rest'),
    	
    	localStore = require('mmrp.localstore'),
    	
    	Make = require('mmrp.make.file');
	
	

	/**
	 * tb template 
	 * @param {Object} draft 01
	 */
	exports.getTemplateData = function(draft){
		draft = draft || 0;
		var	template_parent_id = 0,
            page_id = Fun.getUrlParam("id"),
            template_id =  Fun.getUrlParam("template_id"),
			page_info = localStore.getPageDataById(parseInt(page_id));
		if(page_info==null){
			$("#J_infoedit").addClass("on");//
			Fun.alert("");
			return;
		}
		var	template_name = page_info.data.value.page_name,
			code = Make.filterHtml('save');
		if(code==null) return null;
		//parent id  tmplate_id
		draft || (template_parent_id = template_id);
		
		var obj = {
			data:{
				table:"template",
				value:{
					template_parent_id:template_parent_id,
					template_name:template_name,
					template_html:code.body,
					template_css:code.box_style,						// style
					template_modstyle:code.mod_style ,					//
					template_status:draft,								//01
					template_creator: Fun.getVenderId(),
					template_date: Fun.getNowTime()
				},
				where: template_id
			}
		};
		// ulog.info(obj,"test-2011-7-27");
		return obj;
	};
	
	/**
	 * 
	 */
	var saveDataToDb = function(draft){
		draft = draft || 0;
		var template_id =  Fun.getUrlParam("template_id"),
            template_data = getTemplateData(draft),
			req;
		//
		if (template_id && draft) {
			//
			req = RestApi.postUpdata(template_data).success(function(data){
				ulog.info(tmplate_data,tmplate_id);
			});
		}else{
			// parant id0
			tmplate_data.data.value.template_parent_id = 0;
			//
			RestApi.postUpdata(tmplate_data);
			
			var draftData = tmplate_data,
				template_parent_id = parseInt(tmplate_id);
				
			draftData.data.value.template_parent_id = template_parent_id;
			//
			req = RestApi.postAddData(draftData);
			
		}
		ulog.info(Fun.getNowTime(),draft,tmplate_data);
		return req;
	};
	
	
	exports.init = function(){
		Events.init();
	}
	
});
;/**
 * 
 */
define("mmrp.save.draft",function(require, exports, module) {  
	var $ = require('jquery'),
    	Fun = require('mmrp.func'),
    	base = require('mmrp_wx.mod.base'),
    	RestApi = require('mmrp.rest'),
    	Template = require('mmrp.mod.template');

	var model = {
		drop_list			:'#js_drop_list',
		save_draft_btn		:"#js_save_draft_btn"							//
	};
	
	var msg = {
		save_success : '',
		success:''
	};
	
	var Events = {
		/**
		 * 
		 */
		dropDownEvent:function(){
			$(".arrow",model.drop_list).on("click.drop",function(){
				$(this).next().toggleClass("mod_nav_child_open");
			    return false;
			});
			
			$("a",model.drop_list).click(function() {
				$("ul",model.drop_list).removeClass('mod_nav_child_open');
			});
		},
		
		/**
		 *  
		 */
		saveDraft:function(){
			$(model.save_draft_btn).on('click.save',function(e,option){
				var template_data = Template.getTemplateData();
				if(template_data==null){
					return;
				}
				var template_id = Fun.getUrlParam("template_id");
				if(template_id==""||isNaN(template_id)){
					alert("");
					return;
				}
				if(!option||!option.notNeedAlert)
					Fun.testHeight();
				RestApi.saveDraft(template_id,template_data).success(function(data){

					//! 
					if(option&&option.notNeedAlert&&!option.goodModel) return;
					if(data.errorCode==0){
						Fun.alert(msg.save_success);
						if(option&&option.goodModel){
							Fun.useGoodModel(option.goodModel);
						}
					}else{
						Fun.alert(data.errorMsg);
					}

				});
			});
		},
		
		init:function(){
//			this.dropDownEvent();
			this.saveDraft();
		}
		
	};
	
	
	
	
	
	exports.init = function(){
		Events.init();
	};
	
});
;/**
 * 
 */
define("mmrp.mod.publish",function (require, exports, module) {
    var $ = require('jquery'),
        c = require('mmrp.config.user'),
        Fun = require('mmrp.func'),
        RestApi = require('mmrp.rest'),
        Template = require('mmrp.mod.template'),
        Make = require('mmrp.make.file'),
        localStore = require('mmrp.localstore'),
        PopUp = require('mmrp.popup');

    /**
     * layout 
     */
    var page_id = Fun.getUrlParam("id"),
        template_id = Fun.getUrlParam('template_id'),
        layout_id = Fun.getUrlParam("layout_id"),
        materiaid;

    var model = {
        publish_btn: "#js_publish_btn",								//
        pub_dialog: '#js_pub_dialog',								//
        pub_link: '#js_pub_link',									//url
        page_inter_url: '#js_page_inter_url',
        dowm_zip: '#js_down_btn',
        code: '#js_code'
    };

    var msg = {
        confirm: '',
        save_success: '',
        power: "!"
    };


    /***
     * 
     */
    var alertSuccessDialog = function (data) {
        var page_id = Fun.getUrlParam("id");
        //var tag = '?venderid='+Fun.getVenderId()+'&WDSTAG=5.' + (Fun.getUserUin() - 10000000000 + '') + '.0.' + (page_id + '');
        $(model.pub_link).attr("href", data.page_url).text(data.page_url);
        if (c.root.indexOf("wq.jd.com") < 0) {
            data.page_url = data.page_url.replace("wqs.jd.com", window.location.host);
        }
        var url = data.page_url;
        try{
            var s = url.match(/\/(\d+)(\/\d+\/\d+\/index.shtml)/);
            if(s&& s.length==3){
                url = url.replace(s[0],"/"+parseInt(Math.random()*1000)+s[2]);
            }
        }catch(e){
            console.log(e);
            url = data.page_url;
        }
        $("#js_code_url").attr("href",url);
        $(model.code).attr('src', 'http://2.net.co/qr/?qrstr=' + url);
        $(model.page_inter_url).attr('href', c.root + data.page_inter_url).text(c.root + data.page_inter_url);
        $(model.dowm_zip).attr("href", c.root + "inc/zip_api.php?action=createzip&html_dir=release/" + data.page_directory + '&img_dir=release_img/' + data.page_directory + '&file_name=' + data.page_directory);
        new PopUp({
            title: '',
            content: '#js_pub_dialog',
            contentType: 'selector',
            width: 600,
            height: 238,
            mask: true,
            buttons: [
                {
                    text: '',
                    className: 'ui_btn_c',
                    focus: true
                }
            ]
        })
    };


    /**
     * MMRP RTX
     * users = []
     */
    var sendSuccessRtxMsg = function (users, pub_url) {
        var extra_info = '',
            receivers = Fun.clearSort($.merge(users, c.rtx_users)).join(';');// 

        //
        if (users[0] !== users[1]) {
            extra_info = "" + users[1] + "" + users[0] + ""
        }
        ;

        RestApi.sendRtxMsg({
            title: "MMRP",
            receiver: receivers,
            msginfo: extra_info + "" + users[0] + ":[" + pub_url + "|" + pub_url + "](1--2)"
        });
    };

    /**
     * APi
     */
    var sysFile = function (data) {
        var s_data = $.extend({}, data, {
            page_id: Fun.getUrlParam("id"),
            template_id: Fun.getUrlParam('template_id'),
            layout_id: Fun.getUrlParam("layout_id")
        });

        var sys_api = c.synHtml(s_data);
        return $.get(sys_api);
    };

    var sycn = function (cb) {
        var URL = '//wq.jd.com/weidian/weixin/QueryJdcReleaseTask?saleid=' + Fun.getUrlParam('id');

        $.ajax({
            url: URL,
            type: 'GET',
            dataType: 'jsonp',
            jsonp: 'callback',
            jsonpCallback: 'issynfile',
            success: function (result) {
                cb && cb(result);
            },
            error: function (msg) {
                cb && cb(0);
            }
        });
    }

    /**
     *  DB
     */
    var makeFileSaveDb = function () {
        var page_id = Fun.getUrlParam("id"),
            template_id = Fun.getUrlParam('template_id');
         var   template_data = Template.getTemplateData(1);
        if(template_data==null) return;
        var mkq = Make.makeFile();	//
        if(mkq==null) return;
        mkq.done(function (data) {
            if(data.indexOf('disk') > -1){
                Fun.alert('!');
            }else if(data!=0){
                Fun.alert(data);
                return;
            }
            //tb_template   tb_page
            var req = RestApi.publishPage(page_id, template_id, template_data);
            req.done(function (r) {
                if (r.errorCode != 0) {
                    Fun.confirm(r.errorMsg);
                    return;
                }
                if(!materiaid){
                    alertSuccessDialog(r);
                } else {
                    location.href = '//wq.jd.com/martweb/brand/jdcStep3.xhtml?materiaId=' + window.__materiaid + '&venderId=' + Fun.getVenderId();
                }
            });

        });
    };

    var updatePblBtn = function(){
        var $btn;
        var btnText;

        if(materiaid){
            $btn = $(model.publish_btn);
            btnText = $btn.html();
            $(model.publish_btn).html(btnText.replace('', ''));
        }
    };

    var Events = {

        /**
         * 
         */
        publish: function () {
            $(model.publish_btn).on('click.pub', function () {

                $('#J_buildStep').trigger('alertToSaveInfo', function(){
                    var submitting = false;
                    Fun.confirm('<div class="publish_cnt">' + (isNaN(materiaid) ? '' : '') + '</div>', function () {
                        var page_id = Fun.getUrlParam("id"),
                            template_id = Fun.getUrlParam('template_id'),
                            layout_id = Fun.getUrlParam("layout_id"),
                            submitActInfo = function(){
                                var collectInfo = function(){
                                    var data = [];
                                    ['.mod_goods_link', '[data-type="mod_goods_list"]'].forEach(function(v, k){
                                        $(v, '#js_act_content').each(function(){
                                            var $this = $(this);
                                            var areaid = parseInt($this.data('areaid'));
                                            var actid = parseInt($this.data('actid'));
                                            var comment = $this.data('note');

                                            data.push({
                                                "anchor": $this.closest('.js_drag_element').attr('id'),
                                                "moduleType": k + 1,
                                                "moduleComment": comment || "",
                                                "areaId": isNaN(areaid) ? 0 : areaid
                                            });
                                        });
                                    });

                                    return data;
                                };
                                var info = collectInfo();
                                if(info.length == 0){
                                    Fun.alert('');
                                    return;
                                }

                                var pageInfo = localStore.getPageDataById(page_id)['data']['value'];
                                var page_url = pageInfo['page_type'] + '?venderid=' + Fun.getVenderId() + '&WDSTAG=5.' + Fun.getVenderId() + '.0.' + page_id + (pageInfo['page_layout'] == 10 ? '&jzycwt=1' : '');
                                $.ajax({
                                    url: '//wq.jd.com/martweb/brand/saveJdcArea.jsonp?venderId=' + Fun.getVenderId() + '&materiaId=' + window.__materiaid + '&url=' + encodeURIComponent(page_url),
                                    type: 'POST',
                                    dataType: "json",
                                    contentType: "application/json",
                                    data:JSON.stringify(info)
                                }).done(function(data){
                                    if(data.status == 0 && data.data.areaArray){
                                        bindActId(data.data.areaArray);
                                        createPage();
                                    } else{
                                        Fun.alert('' + data.errMsg);
                                    }

                                }).fail(function(){
                                    Fun.alert('');
                                }).always(function(){
                                    submitting = false;
                                });
                            },
                            bindActId = function(data){
                                $.each(data, function(k, v){
                                    var id = v.areaName && v.areaName.split(':')[1];
                                    var $target;

                                    if(id){
                                        $target = $('#' + id).find('.js_box').children().first();
                                        $target.attr({
                                            'data-actid': v.actId,
                                            'data-areaid': v.areaId
                                        });
                                    }
                                });
                            },
                            createPage = function(){
                                if (page_id && template_id && layout_id) {
                                    RestApi.getUserPower().success(function (p_data) {
                                        var user_power = parseInt(p_data.user_power, 10),		//power 20 
                                            login_name = p_data.login_name,
                                            user_name = Fun.getVenderId();
                                        //, && power 20 
                                        if((user_power == 10 && login_name == user_name) || (user_power ==20)){
                                            //
                                            makeFileSaveDb();
                                        }else{
                                            Fun.alert(msg.power);
                                        }
                                    });
                                }
                            };
                        if(materiaid){
                            //
                            if(submitting){
                                return;
                            } else {
                                submitting = true;
                                submitActInfo(bindActId);
                            }
                        } else {
                            createPage();
                        }

                    });
                });
            });
        },

        init: function () {
            this.publish();
        }

    };

    exports.init = function () {
        materiaid = window.__materiaid;
        Events.init();
        updatePblBtn();
    };

});
;define("jquery.colorpicker",[], function() { return function(jQuery) {
  
/**code start**/
/**
 *
 * Color picker
 * Author: Stefan Petre www.eyecon.ro
 * 
 * Dual licensed under the MIT and GPL licenses
 * 
 */
(function ($) {
	var ColorPicker = function () {
		var
			ids = {},
			inAction,
			charMin = 65,
			visible,
			tpl = '<div class="colorpicker"><div class="colorpicker_color"><div><div></div></div></div><div class="colorpicker_hue"><div></div></div><div class="colorpicker_new_color"></div><div class="colorpicker_current_color"></div><div class="colorpicker_hex"><input type="text" maxlength="6" size="6" /></div><div class="colorpicker_rgb_r colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_g colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_rgb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_h colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_s colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_hsb_b colorpicker_field"><input type="text" maxlength="3" size="3" /><span></span></div><div class="colorpicker_submit"></div></div>',
			defaults = {
				eventName: 'click',
				onShow: function () {},
				onBeforeShow: function(){},
				onHide: function () {},
				onChange: function () {},
				onSubmit: function () {},
				color: 'ff0000',
				livePreview: true,
				flat: false
			},
			fillRGBFields = function  (hsb, cal) {
				var rgb = HSBToRGB(hsb);
				$(cal).data('colorpicker').fields
					.eq(1).val(rgb.r).end()
					.eq(2).val(rgb.g).end()
					.eq(3).val(rgb.b).end();
			},
			fillHSBFields = function  (hsb, cal) {
				$(cal).data('colorpicker').fields
					.eq(4).val(hsb.h).end()
					.eq(5).val(hsb.s).end()
					.eq(6).val(hsb.b).end();
			},
			fillHexFields = function (hsb, cal) {
				$(cal).data('colorpicker').fields
					.eq(0).val(HSBToHex(hsb)).end();
			},
			setSelector = function (hsb, cal) {
				$(cal).data('colorpicker').selector.css('backgroundColor', '#' + HSBToHex({h: hsb.h, s: 100, b: 100}));
				$(cal).data('colorpicker').selectorIndic.css({
					left: parseInt(150 * hsb.s/100, 10),
					top: parseInt(150 * (100-hsb.b)/100, 10)
				});
			},
			setHue = function (hsb, cal) {
				$(cal).data('colorpicker').hue.css('top', parseInt(150 - 150 * hsb.h/360, 10));
			},
			setCurrentColor = function (hsb, cal) {
				$(cal).data('colorpicker').currentColor.css('backgroundColor', '#' + HSBToHex(hsb));
			},
			setNewColor = function (hsb, cal) {
				$(cal).data('colorpicker').newColor.css('backgroundColor', '#' + HSBToHex(hsb));
			},
			keyDown = function (ev) {
				var pressedKey = ev.charCode || ev.keyCode || -1;
				if ((pressedKey > charMin && pressedKey <= 90) || pressedKey == 32) {
					return false;
				}
				var cal = $(this).parent().parent();
				if (cal.data('colorpicker').livePreview === true) {
					change.apply(this);
				}
			},
			change = function (ev) {
				var cal = $(this).parent().parent(), col;
				if (this.parentNode.className.indexOf('_hex') > 0) {
					cal.data('colorpicker').color = col = HexToHSB(fixHex(this.value));
				} else if (this.parentNode.className.indexOf('_hsb') > 0) {
					cal.data('colorpicker').color = col = fixHSB({
						h: parseInt(cal.data('colorpicker').fields.eq(4).val(), 10),
						s: parseInt(cal.data('colorpicker').fields.eq(5).val(), 10),
						b: parseInt(cal.data('colorpicker').fields.eq(6).val(), 10)
					});
				} else {
					cal.data('colorpicker').color = col = RGBToHSB(fixRGB({
						r: parseInt(cal.data('colorpicker').fields.eq(1).val(), 10),
						g: parseInt(cal.data('colorpicker').fields.eq(2).val(), 10),
						b: parseInt(cal.data('colorpicker').fields.eq(3).val(), 10)
					}));
				}
				if (ev) {
					fillRGBFields(col, cal.get(0));
					fillHexFields(col, cal.get(0));
					fillHSBFields(col, cal.get(0));
				}
				setSelector(col, cal.get(0));
				setHue(col, cal.get(0));
				setNewColor(col, cal.get(0));
				cal.data('colorpicker').onChange.apply(cal, [col, HSBToHex(col), HSBToRGB(col)]);
			},
			blur = function (ev) {
				var cal = $(this).parent().parent();
				cal.data('colorpicker').fields.parent().removeClass('colorpicker_focus');
			},
			focus = function () {
				charMin = this.parentNode.className.indexOf('_hex') > 0 ? 70 : 65;
				$(this).parent().parent().data('colorpicker').fields.parent().removeClass('colorpicker_focus');
				$(this).parent().addClass('colorpicker_focus');
			},
			downIncrement = function (ev) {
				var field = $(this).parent().find('input').focus();
				var current = {
					el: $(this).parent().addClass('colorpicker_slider'),
					max: this.parentNode.className.indexOf('_hsb_h') > 0 ? 360 : (this.parentNode.className.indexOf('_hsb') > 0 ? 100 : 255),
					y: ev.pageY,
					field: field,
					val: parseInt(field.val(), 10),
					preview: $(this).parent().parent().data('colorpicker').livePreview					
				};
				$(document).bind('mouseup', current, upIncrement);
				$(document).bind('mousemove', current, moveIncrement);
			},
			moveIncrement = function (ev) {
				ev.data.field.val(Math.max(0, Math.min(ev.data.max, parseInt(ev.data.val + ev.pageY - ev.data.y, 10))));
				if (ev.data.preview) {
					change.apply(ev.data.field.get(0), [true]);
				}
				return false;
			},
			upIncrement = function (ev) {
				change.apply(ev.data.field.get(0), [true]);
				ev.data.el.removeClass('colorpicker_slider').find('input').focus();
				$(document).unbind('mouseup', upIncrement);
				$(document).unbind('mousemove', moveIncrement);
				return false;
			},
			downHue = function (ev) {
				var current = {
					cal: $(this).parent(),
					y: $(this).offset().top
				};
				current.preview = current.cal.data('colorpicker').livePreview;
				$(document).bind('mouseup', current, upHue);
				$(document).bind('mousemove', current, moveHue);
			},
			moveHue = function (ev) {
				change.apply(
					ev.data.cal.data('colorpicker')
						.fields
						.eq(4)
						.val(parseInt(360*(150 - Math.max(0,Math.min(150,(ev.pageY - ev.data.y))))/150, 10))
						.get(0),
					[ev.data.preview]
				);
				return false;
			},
			upHue = function (ev) {
				fillRGBFields(ev.data.cal.data('colorpicker').color, ev.data.cal.get(0));
				fillHexFields(ev.data.cal.data('colorpicker').color, ev.data.cal.get(0));
				$(document).unbind('mouseup', upHue);
				$(document).unbind('mousemove', moveHue);
				return false;
			},
			downSelector = function (ev) {
				var current = {
					cal: $(this).parent(),
					pos: $(this).offset()
				};
				current.preview = current.cal.data('colorpicker').livePreview;
				$(document).bind('mouseup', current, upSelector);
				$(document).bind('mousemove', current, moveSelector);
			},
			moveSelector = function (ev) {
				change.apply(
					ev.data.cal.data('colorpicker')
						.fields
						.eq(6)
						.val(parseInt(100*(150 - Math.max(0,Math.min(150,(ev.pageY - ev.data.pos.top))))/150, 10))
						.end()
						.eq(5)
						.val(parseInt(100*(Math.max(0,Math.min(150,(ev.pageX - ev.data.pos.left))))/150, 10))
						.get(0),
					[ev.data.preview]
				);
				return false;
			},
			upSelector = function (ev) {
				fillRGBFields(ev.data.cal.data('colorpicker').color, ev.data.cal.get(0));
				fillHexFields(ev.data.cal.data('colorpicker').color, ev.data.cal.get(0));
				$(document).unbind('mouseup', upSelector);
				$(document).unbind('mousemove', moveSelector);
				return false;
			},
			enterSubmit = function (ev) {
				$(this).addClass('colorpicker_focus');
			},
			leaveSubmit = function (ev) {
				$(this).removeClass('colorpicker_focus');
			},
			clickSubmit = function (ev) {
				var cal = $(this).parent();
				var col = cal.data('colorpicker').color;
				cal.data('colorpicker').origColor = col;
				setCurrentColor(col, cal.get(0));
				cal.data('colorpicker').onSubmit(col, HSBToHex(col), HSBToRGB(col), cal.data('colorpicker').el);
			},
			show = function (ev) {
				var cal = $('#' + $(this).data('colorpickerId'));
				cal.data('colorpicker').onBeforeShow.apply(this, [cal.get(0)]);
				var pos = $(this).offset();
				var viewPort = getViewport();
				var top = pos.top + this.offsetHeight;
				var left = pos.left;
				if (top + 176 > viewPort.t + viewPort.h) {
					top -= this.offsetHeight + 176;
				}
				if (left + 356 > viewPort.l + viewPort.w) {
					left -= 356;
				}
				cal.css({left: left + 'px', top: top + 'px'});
				if (cal.data('colorpicker').onShow.apply(this, [cal.get(0)]) != false) {
					cal.show();
				}
				$(document).bind('mousedown', {cal: cal}, hide);
				return false;
			},
			hide = function (ev) {
				if (!isChildOf(ev.data.cal.get(0), ev.target, ev.data.cal.get(0))) {
					if (ev.data.cal.data('colorpicker').onHide.apply(this, [ev.data.cal.get(0)]) != false) {
						ev.data.cal.hide();
					}
					$(document).unbind('mousedown', hide);
				}
			},
			isChildOf = function(parentEl, el, container) {
				if (parentEl == el) {
					return true;
				}
				if (parentEl.contains) {
					return parentEl.contains(el);
				}
				if ( parentEl.compareDocumentPosition ) {
					return !!(parentEl.compareDocumentPosition(el) & 16);
				}
				var prEl = el.parentNode;
				while(prEl && prEl != container) {
					if (prEl == parentEl)
						return true;
					prEl = prEl.parentNode;
				}
				return false;
			},
			getViewport = function () {
				var m = document.compatMode == 'CSS1Compat';
				return {
					l : window.pageXOffset || (m ? document.documentElement.scrollLeft : document.body.scrollLeft),
					t : window.pageYOffset || (m ? document.documentElement.scrollTop : document.body.scrollTop),
					w : window.innerWidth || (m ? document.documentElement.clientWidth : document.body.clientWidth),
					h : window.innerHeight || (m ? document.documentElement.clientHeight : document.body.clientHeight)
				};
			},
			fixHSB = function (hsb) {
				return {
					h: Math.min(360, Math.max(0, hsb.h)),
					s: Math.min(100, Math.max(0, hsb.s)),
					b: Math.min(100, Math.max(0, hsb.b))
				};
			}, 
			fixRGB = function (rgb) {
				return {
					r: Math.min(255, Math.max(0, rgb.r)),
					g: Math.min(255, Math.max(0, rgb.g)),
					b: Math.min(255, Math.max(0, rgb.b))
				};
			},
			fixHex = function (hex) {
				var len = 6 - hex.length;
				if (len > 0) {
					var o = [];
					for (var i=0; i<len; i++) {
						o.push('0');
					}
					o.push(hex);
					hex = o.join('');
				}
				return hex;
			}, 
			HexToRGB = function (hex) {
				var hex = parseInt(((hex.indexOf('#') > -1) ? hex.substring(1) : hex), 16);
				return {r: hex >> 16, g: (hex & 0x00FF00) >> 8, b: (hex & 0x0000FF)};
			},
			HexToHSB = function (hex) {
				return RGBToHSB(HexToRGB(hex));
			},
			RGBToHSB = function (rgb) {
				var hsb = {
					h: 0,
					s: 0,
					b: 0
				};
				var min = Math.min(rgb.r, rgb.g, rgb.b);
				var max = Math.max(rgb.r, rgb.g, rgb.b);
				var delta = max - min;
				hsb.b = max;
				if (max != 0) {
					
				}
				hsb.s = max != 0 ? 255 * delta / max : 0;
				if (hsb.s != 0) {
					if (rgb.r == max) {
						hsb.h = (rgb.g - rgb.b) / delta;
					} else if (rgb.g == max) {
						hsb.h = 2 + (rgb.b - rgb.r) / delta;
					} else {
						hsb.h = 4 + (rgb.r - rgb.g) / delta;
					}
				} else {
					hsb.h = -1;
				}
				hsb.h *= 60;
				if (hsb.h < 0) {
					hsb.h += 360;
				}
				hsb.s *= 100/255;
				hsb.b *= 100/255;
				return hsb;
			},
			HSBToRGB = function (hsb) {
				var rgb = {};
				var h = Math.round(hsb.h);
				var s = Math.round(hsb.s*255/100);
				var v = Math.round(hsb.b*255/100);
				if(s == 0) {
					rgb.r = rgb.g = rgb.b = v;
				} else {
					var t1 = v;
					var t2 = (255-s)*v/255;
					var t3 = (t1-t2)*(h%60)/60;
					if(h==360) h = 0;
					if(h<60) {rgb.r=t1;	rgb.b=t2; rgb.g=t2+t3}
					else if(h<120) {rgb.g=t1; rgb.b=t2;	rgb.r=t1-t3}
					else if(h<180) {rgb.g=t1; rgb.r=t2;	rgb.b=t2+t3}
					else if(h<240) {rgb.b=t1; rgb.r=t2;	rgb.g=t1-t3}
					else if(h<300) {rgb.b=t1; rgb.g=t2;	rgb.r=t2+t3}
					else if(h<360) {rgb.r=t1; rgb.g=t2;	rgb.b=t1-t3}
					else {rgb.r=0; rgb.g=0;	rgb.b=0}
				}
				return {r:Math.round(rgb.r), g:Math.round(rgb.g), b:Math.round(rgb.b)};
			},
			RGBToHex = function (rgb) {
				var hex = [
					rgb.r.toString(16),
					rgb.g.toString(16),
					rgb.b.toString(16)
				];
				$.each(hex, function (nr, val) {
					if (val.length == 1) {
						hex[nr] = '0' + val;
					}
				});
				return hex.join('');
			},
			HSBToHex = function (hsb) {
				return RGBToHex(HSBToRGB(hsb));
			},
			restoreOriginal = function () {
				var cal = $(this).parent();
				var col = cal.data('colorpicker').origColor;
				cal.data('colorpicker').color = col;
				fillRGBFields(col, cal.get(0));
				fillHexFields(col, cal.get(0));
				fillHSBFields(col, cal.get(0));
				setSelector(col, cal.get(0));
				setHue(col, cal.get(0));
				setNewColor(col, cal.get(0));
			};
		return {
			init: function (opt) {
				opt = $.extend({}, defaults, opt||{});
				if (typeof opt.color == 'string') {
					opt.color = HexToHSB(opt.color);
				} else if (opt.color.r != undefined && opt.color.g != undefined && opt.color.b != undefined) {
					opt.color = RGBToHSB(opt.color);
				} else if (opt.color.h != undefined && opt.color.s != undefined && opt.color.b != undefined) {
					opt.color = fixHSB(opt.color);
				} else {
					return this;
				}
				return this.each(function () {
					if (!$(this).data('colorpickerId')) {
						var options = $.extend({}, opt);
						options.origColor = opt.color;
						var id = 'collorpicker_' + parseInt(Math.random() * 1000);
						$(this).data('colorpickerId', id);
						var cal = $(tpl).attr('id', id);
						if (options.flat) {
							cal.appendTo(this).show();
						} else {
							cal.appendTo(document.body);
						}
						options.fields = cal
											.find('input')
												.bind('keyup', keyDown)
												.bind('change', change)
												.bind('blur', blur)
												.bind('focus', focus);
						cal
							.find('span').bind('mousedown', downIncrement).end()
							.find('>div.colorpicker_current_color').bind('click', restoreOriginal);
						options.selector = cal.find('div.colorpicker_color').bind('mousedown', downSelector);
						options.selectorIndic = options.selector.find('div div');
						options.el = this;
						options.hue = cal.find('div.colorpicker_hue div');
						cal.find('div.colorpicker_hue').bind('mousedown', downHue);
						options.newColor = cal.find('div.colorpicker_new_color');
						options.currentColor = cal.find('div.colorpicker_current_color');
						cal.data('colorpicker', options);
						cal.find('div.colorpicker_submit')
							.bind('mouseenter', enterSubmit)
							.bind('mouseleave', leaveSubmit)
							.bind('click', clickSubmit);
						fillRGBFields(options.color, cal.get(0));
						fillHSBFields(options.color, cal.get(0));
						fillHexFields(options.color, cal.get(0));
						setHue(options.color, cal.get(0));
						setSelector(options.color, cal.get(0));
						setCurrentColor(options.color, cal.get(0));
						setNewColor(options.color, cal.get(0));
						if (options.flat) {
							cal.css({
								position: 'relative',
								display: 'block'
							});
						} else {
							$(this).bind(options.eventName, show);
						}
					}
				});
			},
			showPicker: function() {
				return this.each( function () {
					if ($(this).data('colorpickerId')) {
						show.apply(this);
					}
				});
			},
			hidePicker: function() {
				return this.each( function () {
					if ($(this).data('colorpickerId')) {
						$('#' + $(this).data('colorpickerId')).hide();
					}
				});
			},
			setColor: function(col) {
				if (typeof col == 'string') {
					col = HexToHSB(col);
				} else if (col.r != undefined && col.g != undefined && col.b != undefined) {
					col = RGBToHSB(col);
				} else if (col.h != undefined && col.s != undefined && col.b != undefined) {
					col = fixHSB(col);
				} else {
					return this;
				}
				return this.each(function(){
					if ($(this).data('colorpickerId')) {
						var cal = $('#' + $(this).data('colorpickerId'));
						cal.data('colorpicker').color = col;
						cal.data('colorpicker').origColor = col;
						fillRGBFields(col, cal.get(0));
						fillHSBFields(col, cal.get(0));
						fillHexFields(col, cal.get(0));
						setHue(col, cal.get(0));
						setSelector(col, cal.get(0));
						setCurrentColor(col, cal.get(0));
						setNewColor(col, cal.get(0));
					}
				});
			}
		};
	}();
	$.fn.extend({
		ColorPicker: ColorPicker.init,
		ColorPickerHide: ColorPicker.hidePicker,
		ColorPickerShow: ColorPicker.showPicker,
		ColorPickerSetColor: ColorPicker.setColor
	});
})(jQuery)

/**code end**/
  
  
}});


;define("mmrp.colorpicker",function(require, exports, module) {  
    
    var $ = require('jquery');
    
    require('jquery.colorpicker')($);
   	
	/**
	 * 
	 */
	exports.colorPicker = function($id){
		$id.ColorPicker({
			//
			onSubmit: function(hsb, hex, rgb, el) {
				$(el).val("#"+hex).ColorPickerHide();
			}, 
			//
			onChange: function(hsb, hex, rgb){
				$id.css('backgroundColor', '#' + hex).setValue('#' + hex);
			},
			onBeforeShow: function () {
				$(this).ColorPickerSetColor(this.value);
			}
		})
		.bind('keyup', function() {
			$(this).ColorPickerSetColor("#"+this.value);
		});
	};
    
})  ;//JS
define("mmrp_wx.upload.bg.local",function (require, exports, module) {

    var $ = require('jquery'),
        Mustache = require('mustache'),
        localStore = require('localStore'),
        Fun = require('mmrp.func'),
        c = require('mmrp.config.user'),
        RestApi = require('mmrp.rest'),
        upload = require('mmrp.mod.uploader2'),
        cp = require('mmrp.colorpicker'),
        BgFun = require('mmrp_wx.upload.bg.func');

    require('jquery.ui')($);

    var model = {
        //
        //upload_container 	:"#js_mod_upload",								//
        file_uploader: "js_drop_bg",									//
        file_uploader_online: 'js_online_bg',								//
        upload_list: "#js_upload_list",								//
        upload_bg: "#js_upload_bg",								//
        colorpicker: "#js_colorpicker",								//
        act_bg_color: "#js_act_bg_color",							//
        bg_color: "#J_bg_color",							//
        upload_sumit: "#js_upload_sumit",							//
        upload_close: '#js_upload_close',							//
        li_upload_tmpl: '#js_upload_tmpl',								// li

        //
        bg_list_container: ".js_bg_list",									//list
        drag_bg_ul: ".js_drag_bg",									//ul
        del_img: ".js_del_img",									//

        bg_style: "#js_bg_style",								//cssID
        act_bg: "#js_act_bg"									//ID


    };

    var msg = {
        edit_img_succ: ''

    };

    /**
     * img  
     */
    var getImgsAttr = function () {

        var arr = [],
            bg_rp = {},

            db_arr = [],											// DB
            db_rp = [],
            $rp_img = $("img:last", model.upload_bg),				//
            $bg_img = $("img", model.upload_list);					//

        if ($bg_img.length) {
            $bg_img.each(function (i) {
                var $this = $(this),
                    src = $this.attr("src"),
                    idcUrl = $this.attr("data-idc-url"),			    //
                //name = $this.attr("data-name"),						//
                    name = $this.attr("src"),
                    size = $this.attr("data-size"),						//
                    width = parseInt($this.attr("data-width"), 10),		//
                    height = parseInt($this.attr("data-height"), 10),	//
                    sheight = parseInt($this.attr("data-sheight"), 10),	//
                    swidth = parseInt($this.attr("data-swidth"), 10);	//
                //css html
                arr.push({
                    name: src,
                    idc: idcUrl,
                    width: width,
                    height: height,
                    sheight: sheight,
                    swidth: swidth,
                    class_name: "bg_" + ( i + 1)
                });
                //db theme_static 
                db_arr.push({
                    name: name,
                    idc: idcUrl,
                    width: width,
                    height: height,
                    size: size,
                    sheight: sheight,
                    swidth: swidth
                });

            });//each
        }//if


        if ($rp_img.length) {
            //  css html
            bg_rp = {
                name: $rp_img.attr("src"),
                width: parseInt($rp_img.attr("data-width"), 10),
                height: parseInt($rp_img.attr("data-height"), 10)
            };

            //db theme_static 
            db_rp = [{
                name: $rp_img.attr("data-name"),
                width: parseInt($rp_img.attr("data-width"), 10),
                height: parseInt($rp_img.attr("data-height"), 10)
            }]
        }//if


        return {
            bg_color: $(model.bg_color).val(),		//
            bg_rp: bg_rp,								//arr
            bg_static: arr,							//arr
            bg_static_db: JSON.stringify(db_arr),		//db string
            bg_rp_db: JSON.stringify(db_rp)				//db string
        };
    };

    /**
     * 
     * @param {Object} filename : 
     * $container 
     */
    var appendImgToList = function (data, $container,swidth,sheight) {
        // 
        $container = $container || model.upload_list;
        $(model.bg_list_container).show();
        $('.js_upload_tips1').hide();
        var tpl = $(model.li_upload_tmpl).html(),
            d, listHtml;
        //success 
        if (data.success) {
            d = {
                value: {
                    name: data.filename,
                    width: data.width,
                    height: data.height,
                    url: data.filepath,
                    size: data.size,
                    idc: data.idc,
                    swidth:swidth,
                    sheight:sheight
                }
            }
        } else {
            //
            d = {value: data}
        }
        //
        listHtml = Mustache.to_html(tpl, d);
        $("ul", $container).append(listHtml);
    };


    var calculationImage = function (responseJSON) {
        responseJSON = responseJSON || {};
        var _size = responseJSON.size;
        var _height = parseFloat(responseJSON.height);
        if (_size.indexOf('MB') > -1) {
            _size = parseFloat(_size) * 1000;
        }
        console.log(_size, _height);
        if (_size > Math.floor(_height * 0.15)) {
            alert('' + _height + '' + (_height * 0.00015).toFixed(1) + 'M');
            return false;
        }
        return true;
    }

    /***
     * 
     * return : tb_theme
     */
    var getThemeData = function () {
        var img_attr = getImgsAttr(),
            bg_code = BgFun.getThemeCode(img_attr),
            theme_id = Fun.getUrlParam("theme_id") || 0;
        if(theme_id==0){
            alert("");
            return null;
        }
        var obj = {
            data: {
                table: "tb_theme",
                value: {
                    theme_bgcolor: img_attr.bg_color,
                    theme_repeat: img_attr.bg_rp_db,//getBgList($(model.upload_bg),true),//
                    theme_static: img_attr.bg_static_db,//getBgList($(model.upload_list)),
                    theme_css: bg_code.style,
                    theme_width: bg_code.page_width || 640,
                    theme_height: $("#js_height_input").val() || 800,
                    theme_remote_url: '',
                    theme_date: Fun.getNowTime()
                },
                where: "theme_id=" + theme_id
            }
        };
        return obj;
    };

    /**
     * 
     */

    /**
     * db
     *  URL DB
     */
    var changeDBdata = function (data) {
        var path = BgFun.getImgPath().absolute_path;		//
        for (var d in data) {
            data[d]['url'] = /^http/.test(data[d]['name']) ? data[d]['name'] : (path + data[d]['name']);
        }
        ;
        return data;
    };


    /***
     * 
     * @param {Object} data
     */
    exports.setBgList = function (tb_theme) {
        var data = tb_theme.data.value;
        if (data && data.theme_static) {
            var bg_list = JSON.parse(data.theme_static);	//
            //
            appendImgToList(changeDBdata(bg_list), model.upload_list);
        }
        ;

        //
        if (data && data.theme_repeat && data.theme_repeat !== '[]') {
            var bg_rp = JSON.parse(data.theme_repeat);//
            console.info(bg_rp)
            //
            if (bg_rp[0]['name'].indexOf("http://") === -1) {
                appendImgToList(changeDBdata(bg_rp), model.upload_bg);
            }
            ;
        }
    };


    var Events = {

        /**
         * 
         */
        sortable: function () {
            $(model.drag_bg_ul).sortable({
                placeholder: "ui-state-highlight",
                connectWith: model.drag_bg_ul
            });
        },

        /**
         * 
         */
        delImg: function () {
            $(model.upload_list).on('click.del', model.del_img, function () {
                $(this).closest("li").remove();
            });
        },

        /**
         * 
         */
        colorPicker: function () {
            cp.colorPicker($(model.act_bg_color));
        },

        /**
         * 
         */
        //createUploader: function () {
        //    var path = BgFun.getImgPath().relative_path;
        //    upload.createUploader(model.file_uploader, path, function (responseJSON) {
        //        if (!responseJSON.error) {
        //            $.post(c.root + "php/pics_upload.php?act=copyToDevAndPublish", {
        //                "filename": responseJSON.filename,
        //                "folder": '../' + responseJSON.directory
        //            }, function (data) {
        //                if (data.error == 1) {
        //                    $('.js_upload_tips2').html(data.errorInfo).show();
        //                    responseJSON.idcurl = '';
        //                } else {
        //                    data = data.data;
        //                    responseJSON.idcurl = data.data[0].url;
        //                }
        //                appendImgToList(responseJSON);
        //            }, "json");
        //
        //
        //            //console.info(responseJSON);
        //
        //        }
        //        ;
        //    })
        //},

        /**
         * 
         */
        createUploaderForOnline: function () {
            $("#js_online_bg input").on("change", function (e) {
               var file = e.currentTarget.files[0];
                if(file==null) return;
                var params = {};
                params.url = c.root + "php/wx_cut_img.php?g_tk="+Fun.$getToken();
                params.type = "post";
                params.dataType = "json";
                params.xhrFields = {withCredentials: true};
                params.processData = false;
                params.contentType = false;
                var formData = new FormData();
                formData.append("file", file);
                formData.append("folder",Fun.getUoloadsrc('img'));
                formData.append("filename",file.name);
                params.data = formData;
                params.success = function (data) {
                    if(data==null||data.data==null||data.data.length<0){
                        alert("");
                        return;
                    }
                    if(data.data[0].errorCode==10){
                        alert(data.data[0].errorMsg);
                        return;
                    }
                    $(model.drag_bg_ul).html('');
                    var swidth=30,sheight=30;
                    for(var d = 0,len = data.data.length;d<len;d++){
                        if(d==0){
                            swidth = 30/(data.data[d].height==0?1:data.data[d].height)*data.data[d].width;
                        }
                        if(len-d==1){
                            sheight=swidth/(data.data[d].width==0?1:data.data[d].width)*data.data[d].height;
                            sheight = sheight<16?16:sheight;
                        }
                        appendImgToList(data.data[d],null,swidth,sheight);
                        if(len - d === 1){
                            //
                            $(model.upload_sumit).trigger('click');
                        }
                    }
                };
                params.error = function (ret) {
                    alert("");
                };
                $.ajax(params);
                $("#js_online_bg input").val("");
            });
        },

        /**
         * 
         */
        submitData: function () {
            $(model.upload_sumit).on("click.uploadbg", function () {

                var page_id = Fun.getUrlParam("id") || 0,
                    $this = $(this),
                    obj = getThemeData();
                if(obj==null) return;
                //
                RestApi.postUpdata(obj).success(function (t_data) {
                    if (t_data.errorCode==0) {
                        BgFun.setBgToContainer(obj);
                        Fun.alert(msg.edit_img_succ);
                        //
                        $this.closest('li.on').removeClass('on');
                        //
                        var img_url = $("img:first", $(model.upload_list)).attr("src");
                        img_url && RestApi.updatePageThumbnailById(img_url, page_id);
                        $('#js_edit_btn').trigger('click.pagesetting');
                    } else {
                        Fun.alert(t_data.errorMsg);
                    }
                })


            });
            /**
             * 
             */
            $("#js_resetbg_btn").on("click", function () {
                $("#J_bg_color").val("#ffffff");
                $("#js_act_bg").html("");
                $("#js_bg_style").html("");
            });
        },


        /**
         * 
         */
        init: function () {
            this.sortable();
            this.delImg();
            this.colorPicker();
//			this.createUploader(),
            this.createUploaderForOnline();
            this.submitData();
        }

    };//events


    exports.init = function () {
        //
        Events.init();
    };

});
;//JS
define("mmrp_wx.upload.bg",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	Fun = require('mmrp.func'),
    	RestApi = require('mmrp.rest'),
    	ModConfig = require('mmrp_wx.page.setting'),
    	BgFun = require('mmrp_wx.upload.bg.func'),
    	ImgLocal = require('mmrp_wx.upload.bg.local');
//    	ImgNetwork = require('./mmrp.upload.bg.network');
    
    require('jquery.colorpicker')($);

    var $doc = $(document);
    
    var model = {
    	act_bg_color		:"#js_act_bg_color"							//
    };
    
    /**
	 * 
	 * @param {Object} theme_id
	 * @param {Object} tb_theme
	 */
	var _successGetThemeData = function(tb_theme){

        var page_width = tb_theme.data.value.theme_width,
            page_height = tb_theme.data.value.theme_height;

        var papge_share_config = JSON.parse(tb_theme.data.value.theme_share || '{}');
        
        var page_img = papge_share_config.img,
        	page_title = papge_share_config.title,
        	page_desc = papge_share_config.desc,
        	page_share_ptag = papge_share_config.ptag,
        	page_color = tb_theme.data.value.theme_bgcolor;


        // 
        ModConfig.setPageSize(page_width,page_height);

        ModConfig.setShareConfig(page_img, page_title, page_desc, page_share_ptag);
        if(!page_color){
        	page_color = '#ffffff';
        }
        $("#J_bg_color").val(page_color);
        //
		$(model.act_bg_color).val(page_color);
//		$('#js_mod_container').css('background-color',page_color);
		if(tb_theme.data.value.theme_static !== null){
			//
			ImgLocal.setBgList(tb_theme);
			//
//			ImgNetwork.setBgList(tb_theme);
			//
			BgFun.setBgToContainer(tb_theme);
		}else{
			$('a[href="#js_mod_upload"]').trigger("click");

		}
		if(!tb_theme.data.value.theme_area) return;

		var setnum = JSON.parse(tb_theme.data.value.theme_area);

		//var theme_area = '[{"class":"area_busness","id":'+area_busness+',"name":"'+bname+'"},{"class":"area_project","id":'+area_project+',"name":"'+pname+'"}{"class":"area_activity","id":'+area_activity+',"name":"'+aname+'"},{"class":"area_area","id":'+area_area+',"name":"'+areaname+'"}]';
		for(var i in setnum){
			var id = setnum[i]['id'],
				classs=setnum[i]['class'],
				name = setnum[i]['name'];
			$("."+classs).attr("data-"+classs,id);
			$("."+classs).text(name);
		}

	}

	/**
	 * 
	 */
	var setBgUpload = function(){

		var theme_id = Fun.getUrlParam("theme_id");			//theme id
		//theme id 
		if(theme_id && $.isNumeric(theme_id)){
			
			RestApi.getThemeById(theme_id).success(function(tb_theme){
				if (tb_theme && tb_theme.data && tb_theme.data.value) {
					_successGetThemeData(tb_theme);
				}
			})
			
		}else{
			$("#J_bg_color").val('#ffffff');
		};
	};
	
	var Events = {
		/**
		 * 
		 */
		submitBtnToggle:function(){
			$('#js_upload_tabs a').on('click.tab',function(){
				var $this = $(this),
					id = $this.attr('data-show');

				var type = $this.attr('data-type');
				if(type == 'upload_auto_cut'){
					$('.js_cut_height_form').show();
				}else{
					$('.js_cut_height_form').hide();
				}


				// 	
				$('#'+id).show().siblings().hide();

				//tab
				id === 'js_remote_sumit' ? $('#js_locals').hide() : $('#js_locals').show();
			});
		},
		init:function(){
			this.submitBtnToggle();
		}
	};
	
	var initUploadEvents = function(){
        $doc.one('show.bgedit',function(){
            ImgLocal.init();
        })
	};
	
	/**
	 * page   
	 */
	exports.init = function(){
//		console.info('upload bg init');
		setBgUpload();
		initUploadEvents();
	};

});
;define("mmrp_wx.module.step",function(require, exports) {

    var $ = require('jquery'),
        PageSetting = require('mmrp_wx.page.setting'),
        Preview = require('mmrp.preview'),
        Draft = require('mmrp.save.draft'),
//        SaveTmpl = require('./mmrp.save.template'),
        Publish = require('mmrp.mod.publish'),
        UploadBg = require('mmrp_wx.upload.bg'),
        Fun = require('mmrp.func'),
        localStore = require('mmrp.localstore'),
        BaseInfo = require('mmrp_wx.mod.base');

    var $doc = $(document);
    require('jquery.clickout')($);
    /**
     * 
     */
    var initBuildOption = function(){
        var $step = $('#J_buildStep');

        $step.on('alertToSaveInfo', function(e, cb){
                var page_info = localStore.getPageDataById(parseInt(Fun.getUrlParam("id")));
                if(page_info == null){
                    Fun.alert("");
                    $('#J_infoedit').addClass('on');
                    return;
                }

                cb &&cb();
            });

        $step.find('.J_buildStep_lk').on('click',function(){
            var $this = $(this),
                triggerType = $this.attr('data-type'),
                $li = $this.closest('li'),
                checked = $li.hasClass('on');

                callback = function(){
                    $doc.trigger(triggerType, checked);
                    !checked ? $li.addClass('on') : $li.removeClass('on');
                };

             $li.siblings('li.on').removeClass('on');
            if(triggerType !== 'show.infoedit'){
                $step.trigger('alertToSaveInfo', callback);
            } else {
                callback();
            }

        });
        $('body').on('esc',function(){
                $step.find('li.on').removeClass('on');
        });
        //$('#js_edit_btn').on('click', function(){
        //    $('#J_infoedit').removeClass('on');
        //})
        /*$('#J_other').on('click', function(){
            $(this).removeClass('on');
        })*/
        /*$('#J_infoedit,#J_bgedit').on('clickoutside',function(){
            $(this).removeClass('on');
        })*/
        
    };
    /**
     * 
     * */
    var initActivityModel = function(){
        //$("#wdpat_activity_modal").draggable({
        //    containment:'document',
        //    handle:"#modal_title",
        //    cursor: 'move'
        //});
    }

    exports.init = function(){
        //
        BaseInfo.init();
        //  
        PageSetting.init();
        //
        UploadBg.init();
        //
        Draft.init();
        //
        //SaveTmpl.init();
        //
        Preview.init();
        //
        Publish.init();

        initBuildOption();

        initActivityModel();
    }

});;/**
 * 
 */
define("mmrp.module.tablist",function (require, exports) {

    var $ = require('jquery'),
        localStore = require('mmrp.localstore'),
        Mustache = require('mustache'),
        c = require('mmrp.config.user'),
        RestApi = require('mmrp.rest'),
        Fun = require('mmrp.func'),
        Deferred = require('mmrp.deferred');

    require('jquery.ui')($);

    var $doc = $(document);

    var model = {
        mod_base_pub: 'mod_base_pub_',//
        mod_pub: 'mod_pub_',//

        //
        drag_container: "#js_draggable",
        style_pre: "m_",//
        act_content: "#js_act_content",	//box
        drag_element: ".js_drag_element",//Boxclass
        $edit_content: $('#edit_frame'),//

        /**
         * 
         */
        boxcss: {
            position: "absolute",
            overflow: "visible"
        },
        basecss: {
            width: "200px",
            height: "100px"
        },
        mask: {
            width: '100px',
            height: '50px',
            left: '0px',
            top: '0px'
        }
    };

    //var user_name = Fun.getUserName();
    // window._targetCont = 'content';

    /**
     * cate
     */
    var getCateList = function () {
        $("#js_mod_add_container").css("max-height", window.screen.availHeight - 160);
        Deferred.getModCateList().done(function (data) {
            if (data && data.data) {
                data.data.value[0].cate_1 = true;
                renderCate(data.data);
                getModList();
            }
        });
    };


    /**
     * cate
     * @param data
     */
    var renderCate = function (data) {
        var tpl = $('#js_cate_tmpl').html(),
            html = Mustache.to_html(tpl, data);
        $('#js_tabs_sidebar').prepend(html);

        var tpl2 = $('#js_cate_tmpl_2').html(),
            html2 = Mustache.to_html(tpl2, data);
        $('#js_tabs_sidebar2').html(html2);
    };

    /**
     * 
     */
    var getModList = function () {
        /**
         *  
         */
        Deferred.getModData().done(function (data) {
            var data = data.data.value;
            var isPopShop = Fun.is_pop_shop();
            for (var i in data) {
                var $li, type = data[i].mod_type;
                //if('nobody' != data[i].mod_creator){
                if (type == 'mod_coupons_jd' && isPopShop) {

                } else if (type == 'mod_coupons_pop' && !isPopShop) {

                } else {
                    $li = modLiData(data[i]);
                    addEvent($li);
                }
                //}
            }

            resetModList();
        });
    };

    /**
     * 
     * @param activity 
     */
    var resetModList = function(activity){
        var $modList = $('#js_draggable_1');

        function clearMods(filter){
            filter.forEach(function(v){
                $modList.find('[data-type=' + v + ']').hide();
            });
        }


        $modList.find('.js_drag').show();

        if(!activity){
            var pagedata = localStore.getPageDataById(Fun.getUrlParam('id'));
            try{
                activity = pagedata.data.value.page_url_name;
            } catch(e){}
        }

        if(70277 != Fun.getVenderId()){
            clearMods(Fun.MOD_FILTER['TEST']);
        }

        if(Fun.is_pop_shop()){
            if (activity != "" && Fun.toWDTab5.indexOf(activity) === -1) {
                clearMods(Fun.MOD_FILTER['POP-FZZ']);
                if(Fun.toWDTab3.indexOf(activity) !== -1){
                    clearMods(Fun.MOD_FILTER['1212']);
                }

            } else {
                clearMods(Fun.MOD_FILTER['POP-ZZ']);
                if(Fun.toWDTab5.indexOf(activity) !== -1){
                    clearMods(Fun.MOD_FILTER['618']);
                }
            }
        } else{
            clearMods(Fun.MOD_FILTER['ZY']);
        }
    }

    /**
     *  
     */
    var getModBaseList = function () {
        Deferred.getModBaseData();
    };

    /**
     * Li
     * 
     */
    var modLiData = function (li_data) {
        var data = li_data,
            img_data = data.mod_thumbnail || "http://tacs.oa.com/img.php?150x80",
            img_path = c.root,			//
            img_url = img_path + img_data,
            type = data.mod_type,
            str = '<span>' + data.mod_name + '</span>';

        if (img_data.indexOf('http://') !== -1) {
            img_url = img_data;
        }
        if (data.mod_name == '') {
            data.mod_name = '()';
        }
        var $li = $("<li />", {
            "class": "js_drag",
            "data-img": img_url,
            "data-type": type,
            "title": data.mod_name
        }).css("background-image", "url(" + img_url + ")")
          .data("data", data)//css
          .append(str)
          .appendTo(model.drag_container + '_' + data.mod_category);

        return $li;
    };
    /**
     * Li
     * @param {Object} $li
     */
    var addEvent = function ($li) {
        $li.draggable({
            revert: 'invalid', // when not dropped, the item will revert back to its initial position
            helper: function (event) {
                var img = $(this).attr("data-img");
                return $('<img />', {
                    src: img
                });
            },
            cursor: 'move'
        });
    };

    /**
     * 
     */
    var addModToContent = function (ui) {
        var $li = $(ui.draggable),
            $cnt = $(model.act_content),
        //$cnt = $('.mod_tab_contitem'),
            data = $li.data("data"),
            mod_id = model.mod_pub + data.mod_id,
            type = data.mod_type,
            mod_base_ids = data.mod_base_style_ids,
            sTop = $(model.$edit_content).scrollTop(),
            html_code = data.mod_html;
        //1
//        BoxFun.setCount();
        $doc.trigger('beforeadd.box', type);

        //
//		BoxFun.setParentOffset(true);
        //html
        if (type === "mod_share_mask" && $('#J_mask').length > 0)
            return;
        if (type === "mod_fixedtab" && $('.fixed_tabs').length > 0) {
            alert('');
            return;
        }
        if(type=="mod_fixedtoptabs"&&$("#fixedtoptabs").length>0){
            alert('');
            return;
        }
        if(type=="mod_countdown"&&$(".mod_countdown").length>0){
            alert('');
            return;
        }

        var _left =ui.position.left - $cnt[0].opos[0];
        if(_left<0) _left = 0;
        var _top = ui.position.top + sTop;
        if(_top<0) _top = 0;
        var $div = $("<div />", {
//            id:model.style_pre + BoxFun.getCount(),
            title: '',
            'class': 'edit_area js_drag_element'
        })//.data("type",type)
            //.data("mod_name",data.mod_name)
            //.data("html_template",html_template)
//            .attr('title','')
//            .addClass("edit_area js_drag_element")
            .css({
                "left": _left,
                "top": _top
            }).css(model.boxcss)
            .append('<div class="js_box" data-mod_type="' + data.mod_type + '"  data-mod-id="' + data.mod_id + '" data-mod-base-ids="' + mod_base_ids + '">' + html_code + '</div>')
            .appendTo($cnt);


        //iframe div 
        if (type == "base_iframe") {
            $div.css(model.basecss).find("iframe").before("<div class='js_iframe_t'></div>");
        } else if (type === "base_link" || type === "base_img" || type === "mod_coupons_pop" || type === "mod_coupons_jd" || type == "goods_link"|| type=="mod_actAppointment") {
            $div.css(model.basecss);
        } else if (type === "mod_share_mask") {
            $div.css(model.mask);
        }else if(type=="store_entrance"){
            $div.find(".store_entrance_a").attr("href","//wq.jd.com/mshop/gethomepage?venderId="+Fun.getVenderId()+"&ptag=");
        }else if(type=="mod_title"){
            $div.css("font-size","36px");
            $div.css("line-height","45px");
        }else if(type=="mod_fixedtoptabs"){
            $div.css("z-index",99);
        }
        var _width = parseInt($div.css('width'));
        var maxwh = $("#js_width_input").val();
        if(_left + _width > maxwh){
            _left = maxwh - _width;
        }
        $div.css({'left':_left + 'px'});
        //
        if (mod_base_ids !== "0" && mod_base_ids !== "" && mod_base_ids) {
            //ID arr
            var mod_base = mod_base_ids.split(",");
            for (var m in mod_base) {
                exports.setModBaseToHead(mod_base[m], $div);
            }
        }
        //
        exports.setModToHead(data.mod_id, $div);
        //exports.setModJsToBody(data.mod_id,$div);
        //
        //RestApi.updateModFrequency(data.mod_id,1);
        $doc.trigger('add.box', [$div, model.style_pre, type]);
        return $div;
    };

    exports.addModToTab = function (ui) {
        var $li = $(ui.draggable),
            $cnt = $('#J_edit_tab'),
            data = $li.data("data"),
            mod_id = model.mod_pub + data.mod_id,
            type = data.mod_type,
            mod_base_ids = data.mod_base_style_ids,
            sTop = $(model.$edit_content).scrollTop(),
            html_code = data.mod_html;
        var _temp_pos = $cnt.offset();
        $cnt[0].opos = [_temp_pos.left, _temp_pos.top];
        $doc.trigger('beforeadd.box', type);

        var $div = $("<div data-target=" + _activeTab + " />", {
            title: ''
        }).addClass("edit_area js_drag_element");
        $div.css({
            "left": ui.position.left - $cnt[0].opos[0],
            "top": ui.position.top - $cnt[0].opos[1]
        });
        $div.css(model.boxcss).append('<div class="js_box" data-mod-id="' + data.mod_id + '" data-mod-base-ids="' + mod_base_ids + '">' + html_code + '</div>');
        $cnt.append($div);


        if (type == "base_iframe") {
            $div.css(model.basecss).find("iframe").before("<div class='js_iframe_t'></div>");
        } else if (type === "base_link" || type === "base_p" || type === "base_img") {
            $div.css(model.basecss);
        } else if (type === "mod_share_mask") {
            $div.css(model.mask);
        }

        //
        if (mod_base_ids !== "0" && mod_base_ids !== "" && mod_base_ids) {
            //ID arr
            var mod_base = mod_base_ids.split(",");
            for (var m in mod_base) {
                exports.setModBaseToHead(mod_base[m], $div);
            }
        }
        //
        exports.setModToHead(data.mod_id, $div);

        $doc.trigger('add.box', [$div, model.style_pre, type]);
        return $div;
        //console.info($li, mod_id, type, mod_base_ids, sTop, html_code);
    }
    /**
     * IDhead
     */
    exports.setModToHead = function (mod_id, $dom) {
        var mod_pre_id = model.mod_pub + mod_id;
//        console.info(mod_pre_id,mod_id,"setModToHead",model.mod_pub,$dom.data('type'),mod_id,data);
        //DB
        Deferred.getModDataById(mod_id).done(function (data_ajax) {
            var data = data_ajax.data ? data_ajax.data.value : data_ajax;
            addModStyleToHead({
                mod_id: mod_pre_id,
                css_code: data.mod_css,
                type:data.mod_type
            });
            $($dom).data({
                "type": data.mod_type,
                "html_template": data.mod_html_template,
                "mod_name": data.mod_name,
                "mod_setting": data.mod_setting,
                "mod_switch_class": data.mod_switch_class
            })
        });
    };

    /**
     * IDhead
     */
    exports.setModBaseToHead = function (mod_id, $dom) {
        var mod_pre_id = model.mod_base_pub + mod_id;
        Deferred.getBaseModDataById(mod_id).done(function (data_ajax) {
            var data = data_ajax.data ? data_ajax.data.value : data_ajax;
            addModStyleToHead({
                mod_id: mod_pre_id,
                css_code: data.mod_style_base,
                mod_style: 'js_mod_style'
            });
        });
    };


    /**
     * IDhead
     * @param {Object} {mod_id,css_code}
     */
    var addModStyleToHead = function (obj) {
        var obj = obj;
        //head
        var $style = $("#" + obj.mod_id);
        //
        if (!$style.length) {
            $("<style />", {
                id: obj.mod_id,
                "class": 'js_mod_style',
                "data-type":obj.type,
                "data-num": 1
            }).append(obj.css_code).appendTo("head");
        } else {
            //
            $doc.trigger('add.modcss', obj.mod_id)
//            BoxFun.updateStyleNum(obj.mod_id)
        }
        ;
    };

    //_targetCont = 'tab';
    var addEventForContainer = function () {
        $(model.act_content).droppable({
            accept: '.js_drag',
            greedy: true,
//			activeClass: 'ui-state-highlight',
            drop: function (ev, ui) {
                //if(_targetCont == 'content'){
                if (!inDraggleTab)
                    addModToContent(ui);
                /*}else if(_targetCont == 'tab'){
                 addModToTab(ui);
                 }else{
                 addModToContent(ui);
                 }*/


//                BoxEvent.addEvents($div);
            }
        });
    };

    var addModEvent = function ($div) {
        //
        $div.draggable({
            containment: $(model.act_content)
        });
        $div.bind({
            mousedown: function () {
                return false;
            }
        })
    };

    /**
     * ,
     */
    var sidebarEvent = function () {
        var $tabs = $("#js_tabs_sidebar");
        $tabs.on("click.sidebar", '.btn_tab', function () {
            $("#js_mod_add_container").toggleClass('open');
        })
            .on("click.sidebar", 'li:not(:last-child)', function () {
                var $this = $(this),
                    id = $this.attr("data-id");
                $this.addClass("on").siblings().removeClass("on");
                $('#' + id).show().siblings().hide();
                $("#js_mod_add_container").removeClass('open');
                return false;

            });
    };

    /**
     * IDhead
     */
    exports.setModJsToBody = function (mod_id, $dom) {
        var mod_pre_id = model.mod_pub + mod_id,
            data = localStore.getModDataById(mod_id);
        //DB
        if (data) {
            //console.log(data.mod_js);
            //$("[data-loadpi-list]").loadPI();
            //$('<script>' + data.mod_js + '</script>').appendTo('body');
            // 	(new Function(data.mod_js))();


        }
        else {
            RestApi.getModDataById(mod_id).success(function (data_ajax) {

                var data = data_ajax.data.value;
                (new Function(data.mod_js))();
            });

        }
    };


    exports.init = function () {
        var pagedata = localStore.getPageDataById(Fun.getUrlParam('id'));
        var activity = "";

        getCateList();
        getModBaseList();
        addEventForContainer();
        try{
            activity = pagedata.data.value.page_url_name;
        } catch(e){}
        resetModList(activity);
        $doc.on('mod_list.reset', function(e, activity){
            resetModList(activity);
        });
    };
});;define("mmrp.mod.box.undo",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	localStore = require('localStore'),
    	BoxFun = require('mmrp.mod.box.func'),
    	shortcut = require('shortcut');
    
   	
   	var model = {
   		//
		music_action		:"music_action",								//
		music_action_num	:"music_action_num",							//
   	}
   	
   	/**********************************/
	
	/**
	 *  cache
	 */
	exports.saveRepealBox = function($dom,action){
		var $dom = $dom,
			box = {
				id		:		$dom.attr("id"),
				style	:		$dom.attr("style"),
				html	:		$dom.html(),
				action	:		action
			},
			music_action = localStore.getItem(model.music_action) || [],
			music_action_num = localStore.getItem(model.music_action_num) || 1;
		
		//
		if(music_action_num !=1){
			music_action.splice( (music_action.length - music_action_num + 1),music_action.length,box);
		}else{
			music_action.push(box);		
		}
		
		
		//
		localStore.setItem(model.music_action,music_action,1);
		//
		localStore.setItem(model.music_action_num,1,1);
		//console.info(music_action.length,localStore.getItem(model.music_action_num),localStore.getItem(model.music_action),"dd");
	};
	
	/**
	 * 
	 */
	exports.repealBox = function(action_num){
		var music_action = localStore.getItem(model.music_action) || [],
			length = music_action.length,
			action_num = localStore.getItem(model.music_action_num);
			
		if(length>0){
			var dom_obj = music_action[length-action_num],
				action = dom_obj.action,
				$dom = $("#"+dom_obj.id),
				dom_obj_pre , $dom_pre;
				//object
				
			// ulog.info(length,action_num,dom_obj)	
			switch(action){
				//
				case "move":
				case "resize":
				$dom.attr("style",dom_obj.style);
				break;
				
				//
				case "create":
				BoxFun.remove($dom);
				break;
				
				
			};
		};
	};
	
	/**
	 * 
	 */
	model.repealBoxEvent = function(){
		//
		localStore.removeItem(model.music_action_num);
		localStore.removeItem(model.music_action);
		
		shortcut.add("ctrl+z",function(){
			
			var a_num = localStore.getItem(model.music_action_num) || 1,
				length = (localStore.getItem(model.music_action) || []).length;
			if(a_num <= length)	{
				repealBox(a_num);
				localStore.setItem(model.music_action_num,(a_num+1),1);
			}else{
				//
				console.info("last ctrl + z")
				//
				// a_num = 1;
				// localStore.setItem(model.music_action_num,1,1);
				// repealBox(a_num);
			}
			
			
			return false;
		}, { 'type': 'keydown', 'propagate': false,'disable_in_input':true });
	};
	
	/**********************************/
    
    
})  ;define("mmrp.mod.source.edit",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	BoxAttr = require('mmrp.mod.box.attr'),
    	BoxFun = require('mmrp.mod.box.func');
    
   	require('jquery.ui')($);
   	
   	var model = {
		source_edit_pop:"#js_source_edit_pop",//
		source_input:"#js_source_input"// 
   	}
   	
   	/**
	 * 
	 * @param {Object} $dom
	 */
	exports.sourceEdit = function($dom){
		var $box = $dom.children(model.box),
			source = $box.html();
			
		$(model.source_edit_pop).show();
		$(model.source_input).val(source);		
	};
	
	/**
	 * 
	 */
	var sourceEditEvent = function(){
		
		var _evt = function(){
			var $dom = BoxFun.hasSelect(),
				$box = $dom.children(".js_box").first(),
				source = $("#js_source_input").val();
			$box.html(source);
		};
		
		//
		$(model.source_edit_pop).draggable();
		
		//
		$("#js_source_com_btn").on("click.boxact",function(){
			_evt();
			$(model.source_edit_pop).hide();
			//return false;	
		});
		//
		$("#js_source_pri_btn").on("click.boxact",function(){
			_evt();
			//return false;	
		});
		//
		$('.close',model.source_edit_pop).on('click.close',function(){
			exports.hide();
		})
		
		//
		$("#js_source_edit_btn").on("click.boxact",function(){
			var $dom = BoxFun.hasSelect();
			exports.sourceEdit($dom)
			return false;
		});
	};
	
	exports.init = function(){
		sourceEditEvent();
	};
	
	exports.hide = function(){
		$(model.source_edit_pop).hide();
	};
	
	exports.init();
   	
    
})  ;define("jquery.contextMenu",[], function() { return function(jQuery) {


/**code start**/
// jQuery Context Menu Plugin
//
// Version 1.01
//
// Cory S.N. LaViska
// A Beautiful Site (http://abeautifulsite.net/)
//
// More info: http://abeautifulsite.net/2008/09/jquery-context-menu-plugin/
//
// Terms of Use
//
// This plugin is dual-licensed under the GNU General Public License
//   and the MIT License and is copyright A Beautiful Site, LLC.
//
;(function($){
	$.extend($.fn, {
		contextMenu: function(o, callback){
			// Defaults
			if (o.menu == undefined) 
				return false;
			if (o.inSpeed == undefined) 
				o.inSpeed = 150;
			if (o.outSpeed == undefined) 
				o.outSpeed = 75;
			// 0 needs to be -1 for expected results (no fade)
			if (o.inSpeed == 0) 
				o.inSpeed = -1;
			if (o.outSpeed == 0) 
				o.outSpeed = -1;
			// Loop each context menu
			$(this).each(function(){
				var el = $(this);
				var offset = $(el).offset();
				// Add contextMenu class
				$('#' + o.menu).addClass('mouse_right_click');
				// Simulate a true right click
				$(this).mousedown(function(e){
					var evt = e;
					evt.stopPropagation();
					$(this).mouseup(function(e){
						//draggable
						//e.stopPropagation();
						var srcElement = $(this);
						$(this).unbind('mouseup');
						if (evt.button == 2) {
							// Hide context menus that may be showing
							$(".mouse_right_click").hide();
							// Get this context menu
							var menu = $('#' + o.menu);
							
							if ($(el).hasClass('disabled')) 
								return false;
							
							// Detect mouse position
							var d = {}, x, y;
							if (self.innerHeight) {
								d.pageYOffset = self.pageYOffset;
								d.pageXOffset = self.pageXOffset;
								d.innerHeight = self.innerHeight;
								d.innerWidth = self.innerWidth;
							}
							else 
								if (document.documentElement &&
								document.documentElement.clientHeight) {
									d.pageYOffset = document.documentElement.scrollTop;
									d.pageXOffset = document.documentElement.scrollLeft;
									d.innerHeight = document.documentElement.clientHeight;
									d.innerWidth = document.documentElement.clientWidth;
								}
								else 
									if (document.body) {
										d.pageYOffset = document.body.scrollTop;
										d.pageXOffset = document.body.scrollLeft;
										d.innerHeight = document.body.clientHeight;
										d.innerWidth = document.body.clientWidth;
									}
							(e.pageX) ? x = e.pageX : x = e.clientX + d.scrollLeft;
							(e.pageY) ? y = e.pageY : y = e.clientY + d.scrollTop;
							
							// Show the menu
							$(document).unbind('click');
							$(menu).css({
								top: y,
								left: x
							}).fadeIn(o.inSpeed);
							//hugo add
							$(srcElement).addClass("editing_area").siblings().removeClass("editing_area");
							
							var $menu = $('#' + o.menu);
							//
							if($(srcElement).hasClass("ui-multidraggable")){
								//
								$menu.enableContextMenuItems('#cancel_select,#a_left,#a_top').disableContextMenuItems('#select');
							}else{
								$menu.enableContextMenuItems('#select').disableContextMenuItems('#cancel_select,#a_left,#a_top');
							}
							
							// When items are selected
							$('#' + o.menu).find('A').unbind('click');
							$('#' + o.menu).find('LI:not(.disabled) A').click(function(){
								$(document).unbind('click').unbind('keypress');
								$(".mouse_right_click").hide();
								// Callback
								if (callback) 
									callback($(this).attr('href').substr(1), $(srcElement), {
										x: x - offset.left,
										y: y - offset.top,
										docX: x,
										docY: y
									});
								return false;
							});
							
							// Hide bindings
							setTimeout(function(){ // Delay for Mozilla
								$(document).click(function(){
									$(document).unbind('click').unbind('keypress');
									$(menu).fadeOut(o.outSpeed);
									return false;
								});
							}, 0);
						}
					});
				});
				
				// Disable text selection
				if ($.browser.mozilla) {
					$('#' + o.menu).each(function(){
						$(this).css({
							'MozUserSelect': 'none'
						});
					});
				}
				else 
					if ($.browser.msie) {
						$('#' + o.menu).each(function(){
							$(this).bind('selectstart.disableTextSelect', function(){
								return false;
							});
						});
					}
					else {
						$('#' + o.menu).each(function(){
							$(this).bind('mousedown.disableTextSelect', function(){
								return false;
							});
						});
					}
				// Disable browser context menu (requires both selectors to work in IE/Safari + FF/Chrome)
			
			
			});
			return $(this);
		},
		disableContextMenuItems: function(o) {
			if( o == undefined ) {
				// Disable all
				$(this).find('LI').addClass('disabled');
				return( $(this) );
			}
			$(this).each( function() {
				if( o != undefined ) {
					var d = o.split(',');
					for( var i = 0; i < d.length; i++ ) {
						$(this).find('A[href="' + d[i] + '"]').parent().addClass('disabled');
						
					}
				}
			});
			return( $(this) );
		},
		
		// Enable context menu items on the fly
		enableContextMenuItems: function(o) {
			if( o == undefined ) {
				// Enable all
				$(this).find('LI.disabled').removeClass('disabled');
				return( $(this) );
			}
			$(this).each( function() {
				if( o != undefined ) {
					var d = o.split(',');
					for( var i = 0; i < d.length; i++ ) {
						$(this).find('A[href="' + d[i] + '"]').parent().removeClass('disabled');
						
					}
				}
			});
			return( $(this) );
		}
	});
})(jQuery);

/**code end**/
  
  
}});


;define("mmrp.context.menu",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	BoxSource = require('mmrp.mod.source.edit'),
    	BoxFun = require('mmrp.mod.box.func');
    
   	require('jquery.contextMenu')($);
   	
   	exports.contextMenu = function($dom){
   		$dom.contextMenu({
			menu: 'js_right_click'
		}, function(action, el, pos){
			//var $dom = el;
			//ulog.info($dom,"contment")
			switch (action) {
				case "copy":
					BoxFun.multiClone($dom);
					break;
				case "del":
					BoxFun.multiRemove($dom);
					break;
				case "select":
					BoxFun.multiSelect($dom);
					break;
				case "cancel_select":
					BoxFun.cancelMultiSelect($dom);
					break;			
				//
				case "a_left":
					BoxFun.alignmentEvent("left");
					break;
				case "a_top":
					BoxFun.alignmentEvent("top");
					break;		
				//	
				case "set":
					$dom.trigger('dblclick');
					break;
				//		
				case "source_edit":
					BoxSource.sourceEdit($dom);	
			};
		})
   	};
   	
   	/**
   	 *  
   	 */
   	exports.hideContextMenu = function(){
   		$("#js_right_click").fadeOut(200);
   	};
	
})  ;define("mmrp.mod.box.events",function(require, exports, module) {

    var $ = require('jquery'),
    	// shortcut = require('shortcut'),
    	BoxFun = require('mmrp.mod.box.func'),
    	BoxCpanel = require('mmrp.module.cpanel'),
    	BoxAttr = require('mmrp.mod.box.attr'),
    	BoxUndo = require('mmrp.mod.box.undo'),
    	BoxSource = require('mmrp.mod.source.edit'),
    	ContMenu = require('mmrp.context.menu');
    
    require('jquery.pubsub')($);

    var $doc = $(document);

   	var model = {
   		box_container : "#js_act_content",		//Box
		box_panel:"#js_pop_guide"				//box
   	};
   	
	/**
	 * Box
	 * @param {Object} $dom jquery
	 */
	exports.addEvents = function($dom){
		if($dom.length){
			var $container = $(model.box_container);

			//
			$dom.bind({
				click: function(){
					var $this = $(this);
					
					// box
					$this.addClass('editing_area').siblings().removeClass('editing_area');
					
					//  
					$this.siblings(".content_editable").each(function(){
						var $i = $(this);
						if($i.find(".js_box:first").attr("contenteditable")){
							BoxFun.disabledEdit($i);
						}
					});
					
					
					//  
					$(model.box_panel).is(":visible") && BoxCpanel.showPanel($dom);
					// chrome bug
					$(model.box_panel).find(':input').blur();
					
					//  
					$("#js_source_edit_pop").is(":visible") && BoxSource.sourceEdit($dom);
					//
					ContMenu.hideContextMenu();	
					return false;
				},
				
				dblclick:function(){
					BoxCpanel.showPanel($dom);
					BoxFun.disabledEdit($dom);
					var type = $dom.data("type");
					//
					if(type === "base_p"){
						BoxFun.enableEdit($dom);
					}
					return false;
				}
			});

			$dom.multidraggable({
					containment: $container,
					//
					start:function(){
						$dom.addClass("editing_area").siblings().removeClass("editing_area");
						//BoxUndo
						//var music_data = localStore.getItem(c.lstore.music_action) || [];
						BoxUndo.saveRepealBox($dom,"move");
						//
						ContMenu.hideContextMenu();	
					},
					//
					drag: function(event, ui){
						if ($(model.box_panel).is(":visible")) {
							BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
						}
					},
					//
					stop: function(event, ui){
						if ($(model.box_panel).is(":visible")) {
							BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
							var _left = parseInt($dom.css('left'));
							var _width = parseInt($dom.css('width'));
							var maxwh = $("#js_width_input").val();
							if(_left + _width > maxwh){
								_left = maxwh - _width;
							}
							$dom.css({'wdith':_width + 'px', 'left':_left + 'px'});
						};
						// saveRepealBox($dom,"move");
					}
				});
				var type = $dom.data('type');
				if(!type){
					type = $dom.find('[data-type]').data('type');
				}		
				if(type != 'mod_goods' && type != 'mod_title' && type != 'mod_share_mask' && type != 'mod_goods_list' && type != 'mod_ad_cpc'){
					$dom.resizable({
						containment: $container,
						start:function(){
							BoxUndo.saveRepealBox($dom,"resize");
							//
							ContMenu.hideContextMenu();	
						},
						resize: function(event, ui){
							if ($(model.box_panel).is(":visible")) {
								BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
							}
						}
						
					});
				}				
				//
				ContMenu.contextMenu($dom);
		};//end if
		
		
	};//end events
	
	/**
	 * Tab
	 * @param {Object} $dom jquery
	 */
	exports.addEventsTab = function($dom){
		if($dom.length){
			var $container = $('#J_edit_tab');

			//
			$dom.bind({
				click: function(){
					var $this = $(this);
					
					// box
					$this.addClass('editing_area').siblings().removeClass('editing_area');
					
					//  
					$this.siblings(".content_editable").each(function(){
						var $i = $(this);
						if($i.find(".js_box:first").attr("contenteditable")){
							BoxFun.disabledEdit($i);
						}
					});
					
					
					//  
					$(model.box_panel).is(":visible") && BoxCpanel.showPanel($dom);
					// chrome bug
					$(model.box_panel).find(':input').blur();
					
					//  
					$("#js_source_edit_pop").is(":visible") && BoxSource.sourceEdit($dom);
					//
					ContMenu.hideContextMenu();	
					return false;
				},
				
				dblclick:function(){
					BoxCpanel.showPanel($dom);
					BoxFun.disabledEdit($dom);
					var type = $dom.data("type");
					//
					if(type === "base_p"){
						BoxFun.enableEdit($dom);
					}
					return false;
				}
			});
			$dom.multidraggable({
					containment: $container,
					//
					start:function(){
						$dom.addClass("editing_area").siblings().removeClass("editing_area");
						//BoxUndo
						//var music_data = localStore.getItem(c.lstore.music_action) || [];
						BoxUndo.saveRepealBox($dom,"move");
						//
						ContMenu.hideContextMenu();	
					},
					//
					drag: function(event, ui){
						if ($(model.box_panel).is(":visible")) {
							BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
						}
					},
					//
					stop: function(event, ui){
						if ($(model.box_panel).is(":visible")) {
							BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
						};
						// saveRepealBox($dom,"move");
					}
				});
				var type = $dom.data('type');
				if(!type){
					type = $dom.find('[data-type]').data('type');
				}		
				if(type != 'mod_goods' && type != 'mod_title' && type != 'mod_share_mask'){
					$dom.resizable({
						containment: $container,
						start:function(){
							BoxUndo.saveRepealBox($dom,"resize");
							//
							ContMenu.hideContextMenu();	
						},
						resize: function(event, ui){
							if ($(model.box_panel).is(":visible")) {
								BoxCpanel.setInputValue(BoxAttr.getAttr($dom));
							}
						}
						
					});
				}				
				//
				ContMenu.contextMenu($dom);
		};//end if
		
		
	};


	var Events = {
		/**
	   	 * 
	   	 */
   		subscribe:function(){
   			$.subscribe('mod/addevent',function(topic,data){
				exports.addEvents(data);
			})
   		},
   		closePop:function(){
   			$('button[data-dismiss]',model.box_panel).on('click',function(){
   				$(model.box_panel).hide();
   			})
   		},
        trigger:function(){
            $doc.on({
                'beforeadd.box':function(e, type){
                    BoxFun.setCount();
                },
                'add.box':function(e,$dom,idPre){
                    $dom.attr('id',idPre + BoxFun.getCount());
                    if(!inDraggleTab)
                    	exports.addEvents($dom);
                	else
                		exports.addEventsTab($dom);
					var _left = parseInt($dom.css('left'));
					var _width = parseInt($dom.css('width'));
					var maxwh = $("#js_width_input").val();
					if(_left + _width > maxwh){
						_left = maxwh - _width;
					}
					$dom.css({'wdith':_width + 'px', 'left':_left + 'px'});
                },
                'add.modcss':function(e,modId){
                    BoxFun.updateStyleNum(modId);
                }
            });
        }
   };
   
    exports.init = function(){
        Events.trigger();
//	Events.closePop();
    }
})  ;define("mmrp.mod.box.shortcuts",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	shortcut = require('shortcut'),
        Fun = require('mmrp.func'),
    	BoxFun = require('mmrp.mod.box.func'),
    	BoxSource = require('mmrp.mod.source.edit'),
    	BoxCpanel = require('mmrp.module.cpanel');
    
   	require('jquery.ui')($);
   	
   	/**
	 * 
	 */
	var shortCuts = function(){
		var _setBox = function($dom,pos,num){
			var num = num || 1;
				// $dom = BoxFun.hasSelect();
			switch(pos) {
				case "height":
					$dom.css({
						height: function(index, value){
							return parseFloat(value) + num;
						}
					});
					break;
					
				case "width":
					$dom.css({
						width: function(index, value){
							return parseFloat(value) + num;
						}
					});
					break;
					
				case "top":
					$dom.css({
						top: function(index, value){
							return parseFloat(value) + num;
						}
					});
					break;
					
				case "left":
					$dom.css({
						left: function(index, value){
							return parseFloat(value) + num;
						}
					});
					break;
			}
//			BoxCpanel.setInputValue(BoxAct.getAttr($dom));
		};
		
		var _multiSetBox = function(pos,num){
			var $dom = BoxFun.hasSelect();
			if(!$dom.length) return;
			//
			if ($dom.hasClass("ui-multidraggable")) {
				$dom.siblings(".ui-multidraggable").each(function(){
					_setBox($(this),pos,num);
				});
			};
			//Box
			_setBox($dom,pos,num);
		};
		
		var short_cuts = [
			{key:"delete",method:function(){
				var $dom = BoxFun.hasSelect();
				BoxFun.multiRemove($dom);
			}},
			{key:"shift+v",method:function(){
				var $dom = BoxFun.hasSelect();
				BoxFun.multiClone($dom);
			}},
			{key:"shift+up",method:function(){
				_multiSetBox("height",-1);
			}},
			{key:"shift+down",method:function(){
				_multiSetBox("height",1);
			}},
			{key:"shift+left",method:function(){
				_multiSetBox("width",-1);
			}},
			{key:"shift+right",method:function(){
				_multiSetBox("width",1);
			}},
			{key:"shift+a",method:function(){
				//   box   
				$(".js_drag_element").removeClass('editing_area').addClass('ui-multidraggable').eq(0).addClass('editing_area');
			}},
			{key:"up",method:function(){
				_multiSetBox("top",-1);
			}},
			{key:"down",method:function(){
				_multiSetBox("top",1);
			}},
			{key:"left",method:function(){
				_multiSetBox("left",-1);
			}},
			{key:"right",method:function(){
				_multiSetBox("left",1);
			}},
			//
			{key:"shift+l",method:function(){
				BoxFun.alignmentEvent("left");
			}},
			{key:"shift+t",method:function(){
				BoxFun.alignmentEvent("top");
			}},
			{key:"shift+s",method:function(){
				$('#js_save_draft_btn').trigger('click');
			}},
			{key:"shift+b",method:function(){
				$('#js_shift_b').trigger('click');
			}},
            {key:"shift+i",method:function(){
                $('#js_shift_i').trigger('click');
            }},
			{key:"shift+e",method:function(){
				$('#js_shift_e').trigger('click');
			}},
			{key:"shift+q",method:function(){
				$('#js_preview_btn').trigger('click');
			}},
			//27
			{key:"esc",method:function(){
				var $dom = BoxFun.hasSelect();
				if ($dom.length) {
					BoxFun.disabledEdit($dom);
					BoxCpanel.hidePanel();
					BoxFun.cancelMultidraggable();
					BoxSource.hide();
				}
				hideShortCuts();
                //bodyesc
				$('body').trigger('esc');
			}}
		];
		
		$.each(short_cuts,function(index,elem){
			shortcut.add(elem.key, function () {
				elem.method();
				return false;
			}, { 'type': 'keydown', 'propagate': false,'disable_in_input':true });
		});
	};
	
	
	/**
	 * 
	 */
	var alignmentShortCuts = function(){
		var short_cuts = [
			{key:"Ctrl+l",method:function(){
				alignmentEvent("left");
			}},
			{key:"Ctrl+r",method:function(){
				alignmentEvent("right");
			}},
			{key:"Ctrl+b",method:function(){
				alignmentEvent("bottom");
			}},
			{key:"Ctrl+t",method:function(){
				alignmentEvent("top");
			}}
		];
		
		$.each(short_cuts,function(index,elem){
			shortcut.add(elem.key, function () {
				elem.method();
				return false;
			}, { 'type': 'keydown', 'propagate': false,'disable_in_input':true });
		});
	};
	
	var hideShortCuts = function(){
		$('#js_short_cuts').hide('fast');
	};
	
	var showShortCuts = function(){
		$('#js_short_cuts').show();
	};
	
	/***
	 *  
	 */
	var shortCutsPop = function(){
		//
		$('#js_short_cuts').draggable();
		//
		$('#js_short_cuts button[data-dismiss]').on('click',function(){
			$(this).closest('.modal').hide('fast');
		});
	};
	
	exports.init = function(){
		shortCuts();
		shortCutsPop();
	}
    
    
})  ;define("mmrp.mod.box.style",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	Fun = require('mmrp.func'),
    	BoxFun = require('mmrp.mod.box.func'),
    	RestApi = require('mmrp.rest');
    
   	var model = {
   		style_cont : '#js_mod_style',				//
   		act_content			:"#js_act_content",								//box
   		act_btn_center : '#J_go_center',
   		update_share : '#J_update_share'
   	};
   	
   	/**
	 * obj
	 * $style_container : 
	 */
	var getModStyle = function($style_container){
		var values = {},style = '',classes = $style_container.attr('data-class');
		
		$(':input',$style_container).each(function(index) {
			var $this = $(this),
				type = $this.attr('type'),
				tag = this.tagName.toLowerCase(),
				//css
				cssname = $this.attr('data-css'),
				id = $this.attr('id'),
				val = $this.getValue(),
				unit = '',				//
				other = ';';				//   !important;
				//
			// px
			if( tag === 'input' && type === 'number' ){
				unit = 'px';
			}
			// 0
			if(val && val !== 0){
				style += cssname + ':' + val + unit + other;
				values[id] = val;
			}
		});
		return {
			style:style,
			values:values,
			classes:classes
		};
	};
	
	/**
	 * dom 
	 */
	var AddStyleToDom = function(style,$dom){
		var style = style,
			$box = $dom.children(".js_box:first"),
			_pri_style = $box.attr("data-pri-style"),			//
			style_class_name;									//style
			
			if(_pri_style){
				style_class_name = "js_" + _pri_style;
			}else{
				style_class_name = "js_pri_" + $dom.attr("id");
			}
		var _content = model.act_content;
		if(inDraggleTab){
			_content = '#J_edit_tab';
		}
		if ($(_content).find("style." + style_class_name).length) {
			$("style." + style_class_name).html(style);
		}
		else {
			$("<style type='text/css' />").addClass(style_class_name).html(style).prependTo($box);
		}
	};
	
	/**
	 * jsonDom
	 * @param {Object} json
	 * @param {Object} $dom
	 */
	var AddStyleJsonToDom = function(json,$dom){
		var json = json,
			$box = $dom.children(".js_box:first"),
			_pri_style = $box.attr("data-pri-style"),
			style_class_name;
			
			if(_pri_style){
				style_class_name = "js_" + _pri_style;
			}else{
				style_class_name = "js_pri_" + $dom.attr("id");
			}
		var _content = model.act_content;
		if(inDraggleTab){
			_content = '#J_edit_tab';
		}
		if ($(_content).find("input." + style_class_name).length) {
			$("input." + style_class_name).val(json);
		}
		else {
			$("<input type='hidden' />").addClass(style_class_name).val(json).prependTo($box);
		}
	};
	
	/**
	 *  
	 */
	var setModStyle = function($dom){
		var type = $dom.data("type"),
			$box = $dom.children(".js_box:first"),
			_pri_style = $box.attr("data-pri-style"),			// 
			id = $dom.attr("id"),								//id
			class_name,										//
			classes,
			mod_setting = JSON.parse($dom.data('mod_setting')),		//
			style = '',
			values = {};
		//    
		if(_pri_style){
			class_name = "." + _pri_style;
			classes = _pri_style;
		}else{
			class_name =  ".pri_" + id;
			classes =  "pri_" + id;
			$box.attr("data-pri-style","pri_" + id);
		};
		
		$box.addClass(classes);
		
		for(var i in mod_setting){
			var id = '#js_set_' + mod_setting[i]['id'],
				$container = $(id,'#js_mod_style');
			if($container.length){
				var obj = getModStyle($container);
				obj.style && (style += class_name + ' .'+ obj.classes +'{' + obj.style + '}');
				$.extend(values, obj.values);
			};//if
		};//for
		
		console.info(style,values,'111');
		//dom
		 AddStyleToDom(style,$dom);
		 AddStyleJsonToDom(  JSON.stringify(values) ,$dom );
	};
	
	var updateStyle = function($dom){
		var left = $('#J_wapper_left').val(),
			top = $('#J_wapper_top').val(),
			width = $('#J_wapper_width').val(),
			height = $('#J_wapper_height').val();
		$dom.css({
			'left': left + 'px',
			'top': top + 'px',
			'width': width + 'px',
			'height': height + 'px'
		});

	}

	var setModStyleInTab = function($dom){
		
	}

	var setCenter = function($dom){
		var _width = $("#js_width_input").val(),
			width = $('#J_wapper_width').val(),
			height = $('#J_wapper_height').val();
		var left = (_width - width) / 2;
		$('#J_wapper_left').val(left);
		$dom.css({'left': left + 'px'});
	}

	var Events = {
		/**
		 *  
		 */
		styleEvent:function(){
			$(model.style_cont).on('input.panel change.panel',':input',function(e){
				var $dom = BoxFun.hasSelect();
				
				/*if(inDraggleTab){
					setModStyleInTab($dom);
					return;
				}*/
				if($(this).data('mod-type') && $(this).data('mod-type') == 'weitiao'){
					updateStyle($dom);
				}else{
					setModStyle($dom);
				}
				
			});

			$(model.style_cont).on('click', model.act_btn_center, function(e){
				var $dom = BoxFun.hasSelect();
				setCenter($dom);
			});
			$('#js_mod_setting').on('click', model.update_share, function(e){
				var _val = $('#js_shareText').val();
				var _name = $('#js_class_name').val();
				$('#J_mask b').html(_val);
			});
			$('#js_mod_setting').on('click', '#J_is_popMsk', function(e){
				var _name = $('#js_class_name').val();
				if($(this).is(':checked')){
					$('#js_goAddress').val('javascript:;');
					$('#js_goAddress').attr('disabled', 'disabled');
					$('#' + _name + '>.js_box').attr('data-mask', '1');
					$('#' + _name + ' .base_link').attr('href', 'javascript:;');
					$('#' + _name + '>.js_box').attr('data-url', '');
				}else{
					$('#js_goAddress').val('');
					$('#js_goAddress').removeAttr('disabled');
					$('#' + _name + '>.js_box').removeAttr('data-mask');
				}
			});
		},
		
		init:function(){
			this.styleEvent();
		}
		
	};
	
	exports.init = function(){
		Events.init();
	}; 
	
})  ;define("jquery.browser",[], function() { return function(jQuery) {
  
/**code start**/
    /*!
     * jQuery Browser Plugin v0.0.6
     * https://github.com/gabceb/jquery-browser-plugin
     *
     * Original jquery-browser code Copyright 2005, 2013 jQuery Foundation, Inc. and other contributors
     * http://jquery.org/license
     *
     * Modifications Copyright 2013 Gabriel Cebrian
     * https://github.com/gabceb
     *
     * Released under the MIT license
     *
     * Date: 2013-07-29T17:23:27-07:00
     */

    (function( jQuery, window, undefined ) {
        "use strict";

        var matched, browser;

        jQuery.uaMatch = function( ua ) {
            ua = ua.toLowerCase();

            var match = /(opr)[\/]([\w.]+)/.exec( ua ) ||
                /(chrome)[ \/]([\w.]+)/.exec( ua ) ||
                /(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec( ua ) ||
                /(webkit)[ \/]([\w.]+)/.exec( ua ) ||
                /(opera)(?:.*version|)[ \/]([\w.]+)/.exec( ua ) ||
                /(msie) ([\w.]+)/.exec( ua ) ||
                ua.indexOf("trident") >= 0 && /(rv)(?::| )([\w.]+)/.exec( ua ) ||
                ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec( ua ) ||
                [];

            var platform_match = /(ipad)/.exec( ua ) ||
                /(iphone)/.exec( ua ) ||
                /(android)/.exec( ua ) ||
                /(windows phone)/.exec( ua ) ||
                /(win)/.exec( ua ) ||
                /(mac)/.exec( ua ) ||
                /(linux)/.exec( ua ) ||
                /(cros)/i.exec( ua ) ||
                [];

            return {
                browser: match[ 3 ] || match[ 1 ] || "",
                version: match[ 2 ] || "0",
                platform: platform_match[ 0 ] || ""
            };
        };

        matched = jQuery.uaMatch( window.navigator.userAgent );
        browser = {};

        if ( matched.browser ) {
            browser[ matched.browser ] = true;
            browser.version = matched.version;
            browser.versionNumber = parseInt(matched.version);
        }

        if ( matched.platform ) {
            browser[ matched.platform ] = true;
        }

        // These are all considered mobile platforms, meaning they run a mobile browser
        if ( browser.android || browser.ipad || browser.iphone || browser[ "windows phone" ] ) {
            browser.mobile = true;
        }

        // These are all considered desktop platforms, meaning they run a desktop browser
        if ( browser.cros || browser.mac || browser.linux || browser.win ) {
            browser.desktop = true;
        }

        // Chrome, Opera 15+ and Safari are webkit based browsers
        if ( browser.chrome || browser.opr || browser.safari ) {
            browser.webkit = true;
        }

        // IE11 has a new token so we will assign it msie to avoid breaking changes
        if ( browser.rv )
        {
            var ie = "msie";

            matched.browser = ie;
            browser[ie] = true;
        }

        // Opera 15+ are identified as opr
        if ( browser.opr )
        {
            var opera = "opera";

            matched.browser = opera;
            browser[opera] = true;
        }

        // Stock Android browsers are marked as Safari on Android.
        if ( browser.safari && browser.android )
        {
            var android = "android";

            matched.browser = android;
            browser[android] = true;
        }

        // Assign the name and platform variable
        browser.name = matched.browser;
        browser.platform = matched.platform;


        jQuery.browser = browser;
    })( jQuery, window );
/**code end**/
  
  
}});


;define("mmrp.module.build",function(require, exports, module) {

    var $ = require('jquery'),
        Fun = require('mmrp.func'),
        RestApi = require('mmrp.rest'),
        ModList = require('mmrp.module.tablist'),
        //Box 
        BoxFun = require('mmrp.mod.box.func'),
        BoxEvent = require('mmrp.mod.box.events'),
        BoxShort = require('mmrp.mod.box.shortcuts'),
        BoxStyle = require('mmrp.mod.box.style'),
        BoxJson = require('mmrp.mod.box.jsonp');

    require('jquery.contenteditable')($);
    require('jquery.browser')($);


    var model = {
        y_view              :   '#js_y_view',//
        x_view              :   '#js_x_view',

        box_container       :   "#js_act_content",		//Box
        mod_container		:   "#js_mod_container",							//
        act_content			:   "#js_act_content",								//box
        style_pre			:   "m_"									//



    };


    /**
     * 
     */
    var initTemplate = function(){
        var template_id = Fun.getUrlParam("template_id");
        if(template_id){
            RestApi.getTemplateById(template_id).success(function(data){
                if(data && data.data && data.data.value){
                    initTemplateData(data.data.value);
                }//if
            });
        }
    };

    /**
     * 
     */
    var resetTemplate = function(activity, old_activity){
        var $EditArea = $('#js_act_content');
        function clearContent(filters){
            filters.forEach(function(v){
                $EditArea.find('.js_box[data-mod_type=' + v + ']').closest('.edit_area').remove();
            });
        }

        if(Fun.is_pop_shop()){
            if (activity != "" && Fun.toWDTab5.indexOf(activity) === -1) {
                clearContent(Fun.MOD_FILTER['POP-FZZ']);
                if(Fun.toWDTab3.indexOf(activity) >= 0){
                    clearContent(Fun.MOD_FILTER['1212']);
                }

                if (old_activity == "") {
                    $EditArea.find(".mod_a_link ")
                        .attr("href", "javascript:void(0);")
                        .parent().attr("data-url","");
                }

                //
                $EditArea.find(".mmrp_mod_poster")
                    .attr("href", "javascript:void(0);")
                    .parent().removeAttr("data-url")
                    .removeAttr("data-mask");

            } else {
                clearContent(Fun.MOD_FILTER['POP-ZZ']);
                if(Fun.toWDTab5.indexOf(activity) >= 0){
                    clearContent(Fun.MOD_FILTER['618']);
                }
            }
        } else{
            clearContent(Fun.MOD_FILTER['ZY']);
        }
    };

    /**
     * 
     */
    var guideShow = function(){
        var $x = $(model.x_view),
            $y = $(model.y_view);
        $(model.box_container).on({
            mousemove:function(e){
                var me = this;
                rAF(function(){
                    BoxFun.setParentOffset();
                    $y.css('left', e.pageX - me.opos[0]);
                    $x.css('top', e.pageY - me.opos[1]);
                })
            }
        })
    };

    /**
     * 
     */
    var assistEvent = function(){
        //
        var $line  = $("#js_x_view,#js_y_view"),
            $grid = $('#js_bg_grid_view');
        $("#js_show_assist").click(function(){
            var $this = $(this);
            if($this.hasClass('checked')){
                $this.removeClass("checked");
                $line.hide();
            }else{
                $this.addClass("checked");
                $line.show();
            }
        });

        //
        $('#js_show_line').click(function(){
            var $this = $(this);
            if($this.hasClass('checked')){
                $this.removeClass("checked");
                $grid.hide();
            }else{
                $this.addClass("checked");
                $grid.show();
            }
        });

        $('#js_show_cuts_link').on('click',function(){
            $('#js_short_cuts').show();
        })
    };


    /***
     *
     * JsonBox
     * @param {Object} data
     */
    var initTemplateData = function(ajax_data){

        var box_style = ajax_data.template_css; //css
        var clearMateriaInfo = function(){
            var data = [];
            ['.mod_goods_link', '[data-type="mod_goods_list"]'].forEach(function(v, k){
                $(v, $box).each(function(){
                    var $this = $(this);
                    $this.attr('data-areaid', '');
                    $this.attr('data-actid', '');
                });
            });

            return data;
        };

        //
        if (box_style) {
            var box_data = ajax_data.template_html, //html
                $box = $("<div />").append(box_data), 			//jquery html
                box_style_arr = box_style.split("}"); //"}"
//				ulog.info($box,box_data,"box")
            // 
            $(".js_config_page",$box).appendTo($(model.mod_container));
            //$("#js_config_style",$box).appendTo($(model.mod_container));
            $(".js_tab", $box).each(function(i){
                mod_id = $(this).attr("data-mod-id");
                mod_id && ModList.setModToHead(mod_id,{});
            });
            if($(".js_mod_product",$box).length>0){
                Fun.addJCMJHeadStyle();
            }
            if($(".mod_goods_list",$box).length>0){
                Fun.addMKJCHeadStyle();
            }
            if($("[data-type=mod_store_logo]",$box).length>0){
                Fun.addStoreLogo();
            }
            if($("#fixedtableft",$box).length>0){
                Fun.addFixedTabLeft();
            }

            //
            if(!isNaN(parseInt(Fun.getUrlParam('pageId')) && Fun.getUrlParam('id') === "")){
                clearMateriaInfo();
            }

            $(".js_box", $box).each(function(i){
                var id = box_style_arr[i].match(/\#([^{]+)/)[1], 				//   id
                style = box_style_arr[i].match(/\{([^\}]+)/)[1], 			//
                $this = $(this),
                num = parseInt(id.replace(model.style_pre, ""), 10), 		//class id
                mod_id = $this.attr("data-mod-id"),							//config.ids.mod_pre +
                mod_base_ids = $this.attr("data-mod-base-ids");

                var $div = $("<div>", {
                    id: id,
                    "class": "edit_area js_drag_element",
                    style: style
                }).append($this).appendTo($(model.act_content));

                if (mod_base_ids !== "0" && mod_base_ids != "" && mod_base_ids) {
                    var mod_base = mod_base_ids.split(",");
                    for (var m in mod_base) {
                        ModList.setModBaseToHead(mod_base[m], $div);
                    };//for
                };//if

                mod_id && ModList.setModToHead(mod_id,$div);

                $this.removeAttr('id');

                BoxEvent.addEvents($div);
                //
                BoxFun.addCount(num);
                //1
                BoxFun.setCount();
            });
            //
            //$(document).trigger("show.infoedit");
            
        }
    };






    /**
     * 
     */
    var initEvent = function(){
        guideShow();
//        assistEvent();
    };



    exports.init = function(){
//		showPageCtrl();
        initTemplate();
        //
        BoxShort.init();
        //css
        BoxStyle.init();
        BoxJson.init();
        initEvent();

        BoxEvent.init();

        //
        $('body').bind('contextmenu', function(){
            return false;
        })

        $(document).on('edit_area.reset', function(e, activity, old_activity, type){
            resetTemplate(activity, old_activity, type);
        });
    };

});;define("mmrp.mod.tab",function(require, exports, module) {  


    var $ = require('jquery'),
    	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
        ModList = require('mmrp.module.tablist'),
    	RestApi = require('mmrp.rest'),
        tablist = require('mmrp.module.tablist'),
        BoxEvent = require('mmrp.mod.box.events');
    	//loadPI = require('./jquery.pp.2014.marketbase_v2');
    require('jquery.cookie')($);
   	require('jquery.ui')($);


    var Data = {

    }

    var addTabs = function(ui){
        console.dir(ui);
    }
    window.inDraggleTab = false;
    var View = {
        initDialog : function(){
            var dialog = document.createElement('div');
            var $dialog = $(dialog);
            $dialog.attr('id', 'J_edit_tab').css({
                background:'#fff',
                border:'1px solid #ccc'
            }).addClass('hide').text('hallo').appendTo('body');

            $dialog.droppable({
                accept: '.js_drag',
                greedy: true,
                drop: function(ev, ui){
                    tablist.addModToTab(ui);
                    ev.preventDefault();
                    ev.stopPropagation();
                }
            });
        },
        rest : function(dom){
            dom[0].style.left="0px";
            var _h = $(dom).find('.mod_tab_content').css('height');
            _h = parseInt(_h);
            $('#J_tab_h').val(_h);
        }
    }


    var _tabsArray = {};
    var _actTab;
    window._activeTab = '';

   	var Event = {
        selectTab : function(){
            $('#J_tabs_i').on('click', function(e){
                var _t = e.target;
                $('#J_tabs_i .btn').removeClass('btn-danger');
                $(_t).closest('.btn').addClass('btn-danger');
                var _tab = $(_t).closest('.btn').data('id');
                $('#' + _tab).parent('.mod_tab_content').find('.mod_tab_contitem').addClass('hide');
                $('#' + _tab).removeClass('hide');
                var _name = $('#js_class_name').val();
                $('#' + _name + ' .mod_tab_item.on').removeClass('on');
                $('#' + _name + ' [data-id="' + _tab + '"]').addClass('on');
                _actTab = _tab;
                /*_activeTab = _tab;
                _targetCont = 'tab';*/
            });
        },
        editTab : function(){
            var _html = '';
            var _maxH = $('#J_tab_h').val();

            $('#J_tab_edit').on('click', function(e){
                var _name = $('#js_class_name').val();
                if(_actTab){
                    //$('#J_edit_tab').removeClass('hide');
                    var _h = $('#J_tab_h').val();
                    inDraggleTab = true;
                    var tab_t = $('#J_tabs_i label[data-id="' + _actTab + '"]').text();
                    $('#J_edit_tab').dialog({ 
                        width:$("#js_width_input").val(),
                        height:640,
                        top:'90px',
                        zIndex:90,
                        overlay: { 
                            opacity: 0.5, 
                            background: "black" 
                        },
                        beforeclose: function(event, ui) { inDraggleTab = false; },
                        title: '<input type="text" data-id="' + _actTab + '" id="J_edit_tit" value="' + tab_t + '" placeholder="tab" />',
                        buttons: [{
                              text: "tab",
                              click: function() {
                                document.getElementById('J_edit_tab').scrollTop = '10000000000';
                                var _tit = $('#J_edit_tit').val();
                                var _html = $('#J_edit_tab').html();
                                _html = _html.replace(/js_box/g, 'js_tab');
                                //_html = _html.replace(/id=m\_[0-9]+/g, '');
                                //_html = _html.replace(/id=\"m\_[0-9]+\"/g, '')
                                _html = _html.replace(/ id=\"/g, ' data-c-id="');
                                var _id = $('#J_tabs_i .btn-danger').data('id');
                                $('[data-id="' + _actTab + '"]').text(_tit);
                                $('#' + _id).html(_html);
                                $('.editing_area').removeClass('editing_area');
                                var _h = parseInt($(this).css('height'));
                                var _st = parseInt($( this ).attr('scrolltop'));
                                var self = this;
                                setTimeout(function(){
                                    _st = parseInt($( self ).attr('scrolltop'));
                                    $( self ).dialog( "close" );
                                }, 200);
                                if(_h + _st > _maxH ){
                                    _maxH = _h + _st;
                                    setTimeout(function(){                                        
                                        $('#J_tab_h').val(_maxH);                         
                                        $('#' + _name + ' .mod_tab_content').css({'height': _maxH + 'px'});
                                    }, 300);
                                }


                              }
                            }
                          ]
                    });
                    setTimeout(function(){
                        $('#J_edit_tab').css({'background':'url(//ppms.wq.jd.com/wxpat/img/reticle.png) repeat 0 0','height': _h + 'px'});
                    },500);
                    _html = $('#' + _actTab).html();
                    _html = _html.replace(/js_tab/g, 'js_box');
                    _html = _html.replace(/ data-c-id="/g, 'id="');
                    var _id = $('#J_tabs_i .btn-danger').data('id');
                    $('#J_edit_tab').html(_html);
                    $('#J_edit_tab .edit_area').each(function(idx, el){
                        var mod_id = $(el).find('.js_box').attr('data-mod-id');
                        mod_id && ModList.setModToHead(mod_id,$(el));

                        //$(el).removeAttr('id');

                        BoxEvent.addEventsTab($(el));
                    });
                     
                }
            });
            $('#J_tab_h').on('change', function(e){
                var _name = $('#js_class_name').val();
                var $mod_tab_content = $('#' + _name + ' .mod_tab_content');
                $mod_tab_content.css({
                    height:$(this).val()
                });
            });
            $('#J_tab_del').on('click', function(e){
                if(_actTab){
                    $('#' + _actTab).remove();
                    $('[data-id="' + _actTab + '"]').remove();
                }
            });
            $('#J_tab_add').on('click', function(e){
                var rand = parseInt(1000*Math.random());
                var _name = $('#js_class_name').val();
                $('#' + _name + ' .mod_tab').append('<a href="javascript:;" data-id="m_3_tab_' +rand+ '" class="mod_tab_item on"></a>');
                $('#' + _name + ' .mod_tab_content').append('<div id="m_3_tab_' +rand+ '" class="mod_tab_contitem hide"></div>');
                $('#J_tabs_i').append('<label data-id="m_3_tab_' +rand+ '" class="btn"><span></span></label>');
            })
        },
        resetTabs : function(){
           /* _activeTab = '';
            _targetCont = 'content';*/
            _actTab = '';
            var _name = $('#js_class_name').val();
            var _inner = $('#' + _name + ' .mod_tab').html();
            var _html = '';
            var _temp_id = '';
            $('#' + _name + ' .mod_tab_contitem').each(function(idx, el){
               _temp_id = $(el).attr('id');
               _temp_id = _temp_id.replace('m_1', _name);
               $(el).attr('id', _temp_id);
            });

            $('#' + _name + ' .mod_tab_item').each(function(idx, el){
                _temp_id = $(el).data('id');
                _temp_id = _temp_id.replace('m_1', _name);
                $(el).data('id', _temp_id);
                $(this).attr('data-id', _temp_id);
                _html += '<label data-id="' + _temp_id + '" class="btn"><span>' + $(el).text() + '</span></label>';
            })
            $('#J_tabs_i').html(_html);
            _html = '';
            //$('#J_tabs_i .btn').removeClass('btn-danger');
        },
   		init : function($box){
           this.$box = $box;
           this.resetTabs();
   		},
        initFun: function(){
            this.selectTab(); 
            this.editTab();
        }
   	}
	exports.init = function(){
        var _self = this;
        Event.initFun();
        View.initDialog();
        $(document).on('show.cpanel',function(e,dom,type,data){
            $box = dom.children(".js_box:first")
            if(data.type == 'mod_tab_menu'){
                View.rest(dom);
                Event.init($box);
                /*Data.getBoxSelectedData(); 
                View.cpanelOpen($box);
                
                Event.init($box);*/
            }


        })
	};





}) ;define("mmrp.mod.fixedtab",function(require, exports, module) {  


    var $ = require('jquery'),
    	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
        ModList = require('mmrp.module.tablist'),
    	RestApi = require('mmrp.rest'),
        tablist = require('mmrp.module.tablist'),
        BoxEvent = require('mmrp.mod.box.events');
    	//loadPI = require('./jquery.pp.2014.marketbase_v2');
    require('jquery.cookie')($);
   	require('jquery.ui')($);


    var _actTab = 0;
    var UI = {
        reset: function(dom){
            var _h =  $('#js_act_content').height();
            dom[0].style.left="0px";
            dom[0].style.bottom='0px';
            dom[0].style.top='auto';
            var _name = $('#js_class_name').val();
            var _temp_id = '';
            var _html = '';
            $('#' + _name + ' .fixed_tabs_item').each(function(idx, el){              
               $(el).attr('id', _name + 'fixedtab_' + idx);
            });

            $('#' + _name + ' .fixed_tabs_item').each(function(idx, el){
                _temp_id = $(el).attr('id');
                $(el).data('id', _temp_id);
                _html += '<label data-id="' + _temp_id + '" class="btn"><span>' + $(el).text() + '</span></label>';
            })
            $('#J_fixedtabs_i').html(_html);
            var color = $('#' + _name + ' .fixed_tabs').attr('data-color');
            var bgcolor = $('#' + _name + ' .fixed_tabs').attr('data-bgcolor');

            $('#J_fixedtab_bg').val(bgcolor);
            $('#J_fixedtab_color').val(color);
        }

    }
    var checkAnchor=function(name){
        var r=0;
        if(name.substr(0,7)=='http://'||name.substr(0,8)=='https://'){return 1}
        try{if($(name).length){r=1}}catch(e){console.error('')}
        return r;
    };
   	var Event = {
        init:function(){
            var name,md;
            $('#J_fixedtabs_i').on('click', 'label', function(e){
                $('#J_fixedtabs_i label').removeClass('btn-success');
                $(this).addClass('btn-success');
                _actTab = $(this).data('id');
                $('#J_fixedtab_name').val($.trim($(this).text()));
                md = $('#' + _actTab + ' .fixed_tabs_a').attr('href');
                $('#J_fixedtab_md').val(md);
            });
            $('#J_fixedtab_del').on('click', function(e){
                if(_actTab){
                    $('#' + _actTab).remove();
                    $('[data-id="' + _actTab + '"]').remove();
                }
            });
            $('#J_fixedtab_add').on('click', function(e){
                var rand = parseInt(1000*Math.random());
                var _name = $('#js_class_name').val();
                $('#' + _name + ' .fixed_tabs').append('<li class="fixed_tabs_item" id="' + _name + 'fixedtab_' + rand + '"><a class="fixed_tabs_a" href="#"><span></span></a></li>');
                $('#J_fixedtabs_i').append('<label data-id="' + _name + 'fixedtab_' +rand+ '" class="btn"><span></span></label>');
            });

            $('#J_complete_fixedtab').on('click', function(){
                var _name = $('#js_class_name').val();
                if(_actTab){
                    name = $('#J_fixedtab_name').val();
                    md = $('#J_fixedtab_md').val();
                    if(!checkAnchor(md)){alert(''+md+'');return;}
                    $('[data-id="' + _actTab + '"]').text(name);
                    $('.fixed_tabs_a').removeClass('active');
                    $('#' + _actTab).find('.fixed_tabs_a').text(name).attr('href',md)/*.addClass('active')*/;
                    Fun.alert('');
                    
                }
                var bgcolor = $('#J_fixedtab_bg').val();
                var color = $('#J_fixedtab_color').val();
                $('#' + _name + ' .fixed_tabs').attr('data-color', color).attr('data-bgcolor', bgcolor);
                var active = $('#J_fixedtab_activecolor').val();
                $('#fixedtabs').css('background-color',bgcolor);
                //$('#fixedtabs .fixed_tabs_a').css('color',color);
                var css = $('#js_config_style').html();
                if(css.indexOf('.fixed_tabs') > -1){
                    css = css.replace(/\.fixed_tabs a\{.*\}/, '.fixed_tabs a{color:' + color + '}');
                    $('#js_config_style').html(css);
                }else{
                    $('#js_config_style').append('.fixed_tabs a{color:' + color + '}');
                }
                if(css.indexOf('.fixed_tabs .active') > -1){
                    css = css.replace(/\.fixed_tabs \.active\{.*\}/, '.fixed_tabs .active{color:' + active + '}');
                    $('#js_config_style').html(css);
                }else{
                    $('#js_config_style').append('.fixed_tabs .active{color:' +active+ '}');
                }

            });

        }
    };

	exports.init = function(){
        var _self = this;
       Event.init();
        $(document).on('show.cpanel',function(e,dom,type,data){
            $box = dom.children(".js_box:first");
            if(data.type == 'mod_fixedtab'){
                UI.reset(dom);
            }


        })
	};





}) ;/**
 * Created by luowenlin1 on 2015/11/20.
 */
define("mmrp.mod.fixtabtop",function(require, exports, module) {
    var $ = require('jquery'),
        Mustache = require('mustache'),
        Fun = require('mmrp.func'),
        c = require('mmrp.config.user'),
        tablist = require('mmrp.module.tablist');
    require('jquery.cookie')($);
    require('jquery.ui')($);

    var _actTab = 0,curEditTabItem=null,currentDOM,
        com99InputItemName=$('#com99InputItemName'),com99InputItemHref=$('#com99InputItemHref'),
        J_fixedtabs_top=$('#J_fixedtabs_top'),fixtopStyle=$('#fixtopStyle');
var self = this;
    function initEdit(dom){
        dom[0].style.top='0px';
        dom[0].style.bottom='auto';
        var _name = $('#js_class_name').val();
        var _temp_id = '';
        var _html = '';
        var tabstyle = $(dom).find("#fixedtoptabs").attr("data-style")||1;
        $("#fixedtoptabtype label[data-style='"+tabstyle+"']").addClass("btn-success").siblings().removeClass("btn-success");
        if(tabstyle==2){
            $(".fixedtabtopcls").hide();
            $(".fixedtableftcls").show();
            initColor();
        }else{
            $(".fixedtableftcls").hide();
            $(".fixedtabtopcls").show();
        }
        var flag = true;
        $('#' + _name + ' .fixedTopTab nav a').each(function(idx, el){
            _temp_id = _name + 'fixedtab_' + idx;
            $(el).attr('data-id', _temp_id);
            _html += '<label data-id="' + _temp_id + '" class="btn" edittabname="'+$(el).text()+'" edittabhref="'+$(el).attr('href')+'">' +
                '<span>' + $(el).text() + '</span>' +
                '</label>';
            flag = false;
        });
        $('#' + _name + ' #fixedtableft nav a').each(function(idx, el){
            _temp_id = _name + 'fixedtab_' + idx;
            $(el).attr('data-id', _temp_id);
            if(flag) {
                _html += '<label data-id="' + _temp_id + '" class="btn" edittabname="' + $(el).text() + '" edittabhref="' + $(el).attr('href') + '">' +
                    '<span>' + $(el).text() + '</span>' +
                    '</label>';
            }
        });
        J_fixedtabs_top.html(_html);
        fixtopStyle.val($('#fixedtoptabs',dom).attr('class'));
    }
    function initColor(){
        var color = $(".temp_side_fix span").css("color");
        $("#fixedtableft_ztcolor").val(rgb2hex(color));
        var b = $(".temp_side_fix .nav_btn_panel").css("background-color");
        b = rgb2rgba(b,0,true);
        $("#fixedtableft_dhlcolor").val(rgb2hex(b[0]));
        b = $(".temp_side_fix .item").eq(0).css("background-color");
        b = rgb2rgba(b,0,true);
        var b1 = rgb2hex(b[0]);
        if(b1!="#000000"){
            self._bg_color_ = true;
        }
        $("#fixedtableft_dhcolor").val(b1);

        $("#fixedtableft_tmd").val(b[1]*100);
        $("#fixedtableft_zt").val($(".nav_btn_panel span").html());
    }
    var checkAnchor=function(name){
        var r=0;
        if(!name) return 0;
        var r=0;
        if($("#fixedtableft").is(":visible")){
            if(name.substr(0,3)!="#m_"){
                name = name.replace(/^http:\/\//, '');
                if(name.indexOf(/^\/\//)  === -1){
                    name = "//" + name;
                }
                if(!Fun.is_JD_QQ_url(name)){
                    Fun.alertLoading("Q");
                    return r;
                }else{
                    $('#J_fixedtabtop_md').val(name);
                    return 1;
                }
            }
        }
        try{if($(name).length){r=1}}catch(e){console.error('')}
        return r;
    };
    function bindEvent(){
        var name,md;
        var inputEditTabName=$('#J_fixedtabtop_name'),J_fixedtabtop_md=$('#J_fixedtabtop_md');
        J_fixedtabs_top.on('click', 'label', function(e){
            J_fixedtabs_top.find('label').removeClass('btn-success');
            $(this).addClass('btn-success');
            _actTab = $(this).data('id');
            inputEditTabName.val($.trim($(this).text()));
            var v = $('[data-id="' + _actTab + '"]').attr('href');
            v = v=="javascript:;"?"#":v;
            J_fixedtabtop_md.val(v);
        });
        $('#J_fixedtabtop_del').on('click', function(e){
            if(_actTab){
                var _name = $('#js_class_name').val();
                $("#js_pop_guide").find('[data-id="' + _actTab + '"]').remove();
                $("#"+_name).find('[data-id="' + _actTab + '"]').remove();
            }
        });
        $('#J_fixedtabtop_add').on('click', function(e){
            var _name = $('#js_class_name').val();
            var rand=0;
            $.each($('#' + _name + ' nav').children("a"),function(i,item){
                var index = Number($(item).data("id").replace( _name + 'fixedtab_',""));
                if(index>rand){
                    rand = index;
                }
            });
            rand++;
            $('#' + _name + ' nav').append('<a data-id="' + _name + 'fixedtab_' + rand + '" href="#" class="item"></a>');
            //tab
            J_fixedtabs_top.append('<label data-id="' + _name + 'fixedtab_' +rand+ '" class="btn"><span></span></label>');
            //label,
            //tab
            $("#fixedtableft_ztcolor").trigger("change");
            self._bg_color_&&$("#fixedtableft_dhcolor").trigger("change");
        });
        fixtopStyle.on('change',function(e){
            $('#fixedtoptabs').attr('class',null).attr('class',this.value);
        });

        $('#J_complete_fixedtabtop').on('click', function(){
            if(_actTab){
                name = inputEditTabName.val();
                md = J_fixedtabtop_md.val();
                if(!checkAnchor(md)){alert(''+md+'');return;}
                md = J_fixedtabtop_md.val();
                $('[data-id="' + _actTab + '"]').text(name);//tab
                $('[data-id="' + _actTab + '"]').text(name).attr('href',md);//tab
                Fun.alert('');
            }
        });
        //
        $("#fixedtoptabtype").on("click","label",function(){
            $(this).addClass('btn-success').siblings().removeClass("btn-success");
            var _style = $(this).attr("data-style");
            var _name = $('#js_class_name').val();
            if(_style==1){//
                $("#fixedtableft").hide();
                $("#fixedtoptabs").show();
                $("#fixedtoptabs").attr("data-style","1");
                $("#fixedtableft").attr("data-style","1");
                $("#fixedtableft").parents(".edit_area").css("margin-top","0px");
                $(".fixedtableftcls").hide();
                $(".fixedtabtopcls").show();
                $("#"+_name).css("max-width","100%");
            }else{
                Fun.addFixedTabLeft();
                $("#fixedtoptabs").hide();
                $("#fixedtableft").show();
                $("#"+_name).css("max-width","50%");
                $("#fixedtoptabs").attr("data-style","2");
                $("#fixedtableft").attr("data-style","2");
                $("#fixedtableft").parents(".edit_area").css("margin-top","50px");
                $(".fixedtabtopcls").hide();
                $(".fixedtableftcls").show();
                initColor();
            }
        });
        $("#fixedtableft_zt").on("input",function(){
            $(".nav_btn_panel span").html($(this).val());
        });
        $("#fixedtableft_ztcolor").on("change",function(){
            $(".temp_side_fix span").css("color",$(this).val());
            $(".temp_side_fix a").css("color",$(this).val());
        });
        $("#fixedtableft_dhlcolor").on("change",function(){
            $(".temp_side_fix .nav_btn_panel").css("background",$(this).val());
            $("#fixedtableft_tmd").trigger("input");
        });
        $("#fixedtableft_dhcolor").on("change",function(){
            $(".temp_side_fix .item").css("background",$(this).val());
            $("#fixedtableft_tmd").trigger("input");
            self._bg_color_ = true;
        });
        $("#fixedtableft_tmd").on("input",function(){
            var r = $(this).val();
            var b = $(".temp_side_fix .nav_btn_panel").css("background-color");
            b = rgb2rgba(b,r/100);
            $(".temp_side_fix .nav_btn_panel").css("background", b);
            b = $(".temp_side_fix .item").css("background-color");
            $(".temp_side_fix .item").css("background",rgb2rgba(b,r/100));
        });
    }
    function rgb2rgba(rgb,a,revers){
        if(rgb==null) return;
        if(revers){
            var array=[];
            if (rgb.indexOf("rgba(") >= 0) {
                var r = rgb.split(",");
                rgb = r[0].replace("rgba", "rgb");
                array[0] =rgb + "," + r[1] + "," + r[2] +")";
                array[1] = parseFloat(r[3]);
                return array;
            } else {
                array[0] =rgb;
                array[1] = 0;
                return array;
            }
        }else {
            if (rgb.indexOf("rgba(") >= 0) {
                var r = rgb.split(",");
                return r[0] + "," + r[1] + "," + r[2] + "," + a + ")";
            } else {
                rgb = rgb.replace(")", "," + a + ")");
                rgb = rgb.replace("rgb", "rgba");
                return rgb;
            }
        }
    }
    function rgb2hex(rgb) {
        rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        function hex(x) {
            return ("0" + parseInt(x).toString(16)).slice(-2);
        }
        return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
    }
    exports.init = function(){
        bindEvent();
        $(document).on('show.cpanel',function(e,dom,type,data){
            if(data.type == 'mod_fixedtoptabs'){
                initEdit(dom);
            }
        })
    };
}) ;;define("mmrp.goodscx.list",function(require, exports, module) { 
	var $ = require('jquery');
	var tpl4 = '<li sku="{#sku#}"><a href="//wq.jd.com/item/view?sku={#sku#}" class="twoGoodImg skuLink"><img src="//img30.360buyimg.com/n7/{#image#}"></a><label class="twoGoodInfo"><h2>{#name#}</h2><div class="oneGoodPrice"><b class="sku_{#sku#}"></b></div><input type="checkbox" class="oneGoodChk"></label><div class="label"></div><div class="saleoutMsk" style="display:none;"><div class="saleoutIco"><div class="saleoutText"><br>SALEOUT</div></div></div></li>';
	var tpl5 = '<li class="hproduct {#cls#}"><a class="mod_g_img200x200" href="{#sClickUrl#}" title="{#sItemName#}"><p class="cover"><img src="{#sImg#}" alt="{#sItemName#}">{#tag#}</p><p class="cont">{#sItemName#}</p><p class="fn">{#desc#}</p><p class="prices"><strong><em>&yen;{#dwActMinPrice#}</em></strong><del>&yen;{#dwMarketPrice#}</del><span class="discount">{#sdwDiscount#}</span></p><span class="btn_buy"></span><p class="comment">{#dwCommCnt#}</p></a></li>';
	var tpl6 = '<li class="hproduct {#cls#}"><a href="{#sClickUrl#}" class="url"><img class="photo" src="{#sImg#}" alt="{#sItemName#}">{#tag#}<span class="cont">{#sItemName#}</span><h3 class="fn">{#desc#}</h3><p class="disc"></p><p class="price"><strong>&yen;{#dwActMinPrice#}</strong><del>&yen;{#dwMarketPrice#}</del></p><p class="other"><span class="o1">{#dwCommCnt#}</span><span class="o2"></span><span class="o3"></span></p></a></li>';
	var tpl7 = '<li class="hproduct {#cls#}"><a class="mod_g_img200x200" href="{#sClickUrl#}" title="{#sItemName#}"><p class="cover"><img src="{#sImg#}" alt="{#sItemName#}">{#tag#}</p><p class="cont">{#sItemName#}</p><p class="fn">{#desc#}</p><p class="prices"><strong><em>&yen;{#dwActMinPrice#}</em></strong><del>&yen;{#dwMarketPrice#}</del><span class="discount">{#sdwDiscount#}</span></p><span class="btn_buy"></span><p class="comment">{#dwCommCnt#}</p></a></li>';
    var tpl1 = '<li class="hproduct {#cls#}"><a class="mod_g_img200x200" href="{#sUrl#}" title="{#sItemName#}"><p class="cover"><img src="{#sImg#}" alt="{#sItemName#}" /></p><p class="fn">{#sItemName#}</p><p class="prices"><strong><em>&yen;{#dwActMinPrice#}</em></strong></p><span class="btn_buy"></span></p></a></li>';
    var tpl2 = '<li data-test class="hproduct {#cls#}"><a href="{#sUrl#}" class="mod_g_img200x200"><p class="cover"><img src="{#sImg#}" alt="{#sItemName#}"></p><p class="fn">{#sItemName#}</p><p class="prices"style=""><strong><em>&yen;{#dwActMinPrice#}</em></strong></p></a></li>';
    var tpl3 = '<li class="hproduct {#cls#}"><a href="{#sUrl#}" class="url"><img class="photo" src="{#sImg#}" alt="{#sItemName#}"><h3 class="fn">{#sItemName#}</h3><p class="disc"></p><p class="price"><strong>&yen;{#dwActMinPrice#}</strong></p><p class="other"><span class="o3"></span></p></a></li>';
	var cgi={price:'//pe.3.cn/prices/pcpmgets',
			info:'//yx.3.cn/service/info.action',
			coupon:'//wq.jd.com/mshop/QueryCoupon'
		};
    var getMarketCpcData = function(skuids, area, type, cb){
    	//&callback=skuPrice
    	var url = '//pe.3.cn/prices/pcpmgets?skuids=' +skuids+ '&origin=' +type+ '&source=wxsq&t=' + Date.parse(new Date());

    	var url2 = '//yx.3.cn/service/info.action?ids=' +skuids + '&t=' + Date.parse(new Date());

    	var level = 2;
    	var _skuids = skuids.split(',');
    	var linkpre = '//wq.jd.com/item/view?sku=';
    	var _data = function(){
    		var arr = {};
    		var temp = {};
    		for (var i = 0,len = _skuids.length ; i < len; i++) {
    			arr[_skuids[i]] = {'sUrl': linkpre + _skuids[i], 'sSkuId':_skuids[i]};
    		};
    		return arr;
    	}();
    	var _currSort = function(_data){
		    var new_arr = [];
		    var arr = _skuids;
		    for (var i = 0,o=0; i < arr.length; i++) {
		        for (o = 0; o < _data.length; o++) {
		            if(arr[i] == _data[o].sSkuId){
		                new_arr.push(_data[o]);
		                o = _data.length;
		            }
		        };
		    };
		   return new_arr;
		}
    	var _cb = function(){
    		if(--level <= 0){
    			var arr = [];
    			for(var key in _data){
    				arr.push(_data[key]);
    			}
    			arr = _currSort(arr);
                console.info(arr);
    			cb(arr);
    		}
    	}

		$.ajax({ 
            type : 'GET', 
            url : url,
            dataType : "jsonp", 
            success : function(data){
            	for (var i = 0; i < data.length; i++) {
            		var dwMarketPrice = data[i]['m'];
            		var dwActMinPrice = data[i]['p'];
            		_data[data[i]['id']]['dwMarketPrice'] = dwMarketPrice;
            		_data[data[i]['id']]['dwActMinPrice'] = dwActMinPrice;
            		_data[data[i]['id']]['dwDiscount'] = parseInt( (dwActMinPrice / dwMarketPrice) * 100);
            	};
                _cb();
            }  
        });
		$.ajax({ 
            type : 'GET', 
            url : url2,
            dataType : "jsonp", 
            success : function(data2){
            	for(var key in data2){
            		_data[key]['sItemName'] = data2[key]['name'];
            		_data[key]['sImg'] = '//img10.360buyimg.com/n7/' + data2[key]['imagePath'];
            		_data[key]['ext2'] = '';
            	};
                _cb();
            }  
        });
	}
	var renderTpl = function(data, tpl){
		for(var attr in data){
			tpl = tpl.replace(new RegExp("{#"+attr+"#}","gm"), data[attr]);
		}
		console.log(tpl);
		return tpl;
	}
	var resetData = function(data){
		data.sdwDiscount = Math.round(data.dwDiscount) / 10;
		if(!data.sImg){
	      data.sImg = data.sImg200x200;
	    }

	    var _s = data.ext2.split('|'); 
        data.desc = _s[0];
        if(_s.length > 1){
            data.tag = '<span class="tag">' + _s[1] + '</span>';
        }else{
           data.tag = ''; 
        }
        data.cls = '';
	    if(~~data.dwSkuState){
	      //if(!isHide){
	        data.cls = 'soldout_end hide_discount';
	     /* }else{
	        data.cls = 'soldout_end hide';
	      }*/
	      
	    }
	    if(data.dwDiscount < 95){
        	data.cls = 'hide_discount';
        }
		return data;
	}
	function getInfo(sku,cb){
		$.ajax({
			type : 'GET',
			url : cgi.info,
			data:{ids:sku},
			jsonp:'callback',
			dataType : "jsonp",
			success :function(d){
				cb(d);
			}
		});
	}
	exports.render = function(obj, name){
		var style = obj.styletype;
		var html = '';
		var tpl = '';
		var pdata = {};
		if(style == 1){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemlist');		
			tpl = tpl1;
		}else if(style == 2){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemgrid');
			tpl = tpl2;
		}else if(style == 3){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_julist');
			tpl = tpl3;
		}else if(style == 4){
			tpl = tpl4;
		}else if(style == 5){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemgrid2');		
			tpl = tpl5;
		}else if(style == 6){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_julist2');
			tpl = tpl6;
		}else if(style == 7){
			$('#' + name).find('.goods_list').removeAttr('class').addClass('mod_julist');
			tpl = tpl7;
		}
		$('#' + name).css({'left':0});
		if(style==4){
			getInfo(obj.skuids,function(d){
				var html="";
				for(var k in d){
					html+=renderTpl({sku:k,name:d[k].name,image:d[k].imagePath}, tpl);
				}
				$('#' + name).find('.mod_sku_addcart').html(html);
				var priceParam={source:'wxsq',area:'1_72_2799',origin:4};
				priceParam.skuids=obj.skuids;
				$.ajax({
					type : 'GET',
					url : cgi.price,
					data:priceParam,
					jsonp:'callback',
					dataType : "jsonp",
					success :function(d){
						$.each(d,function(idx,obj){
							var el=$('#'+name+' .sku_'+ obj.id),li=el.parent().parent().parent(),label=li.find('div.label'),mask=li.find('div.saleoutMsk');
							el.html('&yen;'+ obj.p);li.attr('price',obj.p-0);
							if(obj.pcp&&obj.pcp-obj.p>0){
								var reduce=(obj.pcp-obj.p);
								if(reduce>=1){label.html('PC'+reduce.toFixed(1)+'').show()}else{label.hide()}
							}else{label.hide()}
							if(obj.p-0<0){mask.show()}
						})
					}
				});
			});
		}else {
			getMarketCpcData(obj.skuids, obj.area, obj.type, function (data) {
				for (var i = 0; i < data.length; i++) {
					pdata = resetData(data[i]);
					html += renderTpl(pdata, tpl);
				}
				$('#' + name).find('.goods_list').html(html);
			});
		}
	}


}) ;/**
 * pop
 */
define("mmrp_wx.mod.goods_list",function (require, exports, module) {

    var $ = require('jquery'),
        goodsTools = require('mmrp.goodscx.list'),
        Deferred = require('mmrp.deferred'),
        Fun = require('mmrp.func');

    var TPL1 = '';
    var TPL2 = '';
    var skuids = '', _area = '', type;


    var resetInputs = function (dom, type, data) {
        var $mod = $(dom).find('[data-type="mod_goodscx_list"]');

        var skuids = $mod.attr('data-skuids');
        var _area = $mod.attr('data-area');
        var type = $mod.attr('data-evtype');


        var _style = $mod.attr('data-style');
        var _name = $('#js_class_name').val();
        if (_style == '') {
            var $ul = $('#' + _name).find('[data-type="mod_goodscx_list"]');
            //_style = $ul.attr('data-style');
            $('#J_goodscx_style').val(_style);
        }

        $('#J_glistcg_type .btn').removeClass('btn-success');
        $('#J_glistcg_type').find('[data-style="' + _style + '"]').addClass('btn-success');

        $('#J_goodscx_radio').find('[data-v="' + type + '"]').click();

        $('#J_glistcg').val(skuids);
        //$('#J_glistcg_area').val(_area);
        g = Goods();
        if (!g.navHtml) {
            g.getCategory(function (data) {
                g._shopId = data[0].shopId;
                var html = '<li><a href="javacript:;" data-sid="' + data[0].shopId + '"></a></li>', temp;
                var i = 0, o = 0;
                for (i = 0; i < data.length; i++) {
                    html += '<li><a href="javascript:;" data-id="' + data[i].id + '" data-sid="' + data[i].shopId + '">' + data[i].name.split('/')[0] + '</a></li>';
                    if (!g._shopId)
                        g._shopId = data[i].shopId;
                    if (data[i].children.length > 0) {
                        for (o = 0; o < data[i].children.length - 1; o++) {
                            temp = data[i].children[o];
                            html += '<li><a href="javascript:;" data-id="' + temp.id + '" data-sid="' + temp.shopId + '">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + (temp ? temp['name'].split('/')[0] : 'no') + '</a></li>';
                        };

                    }
                }
                ;
                g.navHtml = html;
                $('#J_uiproduct_dropdown ul').html(html);
                g.getGoods('key', '', 0, function () {
                    g.renderList();
                });
            }, function (data) {
                alert('');
                return;
            });
        } else {
            $('#J_uiproduct_dropdown ul').html(g.navHtml);
        }
        g.initselectedGoods();

    }
    var tpl='<ul class="twoGoodsList mod_sku_addcart"><li><a href="javascript:;" class="twoGoodImg"><img src="//ppms.wq.jd.com/wxpat/img/img290x290.jpg"></a><label class="twoGoodInfo"><h2>14</h2><h3></h3><div class="oneGoodPrice"><b>&yen;0.00</b></div><input type="checkbox" class="oneGoodChk"></label></li><li><a href="javascript:;" class="twoGoodImg"><img src="//ppms.wq.jd.com/wxpat/img/img290x290.jpg"></a><label class="twoGoodInfo"><h2>14</h2><h3></h3><div class="oneGoodPrice"><b>&yen;0.00</b></div><input type="checkbox" class="oneGoodChk"></label></li></ul><div class="goodsFooter" style="display:none;"><span class="goodsFL"><div class="goodsFPrice"><b class="color_e4393c count">0.00</b></div><span class="coupon"><em></em></span><span class="reduce"><em class="count"></em><em class="reduce"></em></span></span><a href="javascript:;" class="goodsFB"></a></div><div class="add_cart_tip"><span></span></div>';
    var Event = {
        init: function () {
            $('#J_glistcg_submit').on('click', function () {
                var _name = $('#js_class_name').val();
                if(!Fun.is_pop_shop()){
                    skuids = $("#j_goodslistcx").val();
                    if(skuids==''){
                        alert("skuid");
                        $("#j_goodslistcx").focus();
                        return;
                    }
                    $('#' + _name + ' .js_mod_product').attr('data-skuids',skuids);
                }else{
                    skuids = $('#' + _name + ' .js_mod_product').attr('data-skuids');
                    if(skuids==null) return;
                    skuids = skuids.replace(//ig, ',');
                    skuids = skuids.replace(/\s/ig, '');
                }
                if($("#showGoodscgTop").is(':checked')){
                    $('#' + _name + ' .mod_filter').css("display","block");
                }else{
                    $('#' + _name + ' .mod_filter').css("display","none");
                }
                _area = '8_584_3268';// 
                Deferred.getPageDataById(Fun.getUrlParam("id")).done(function (data) {
                    if (data == null || data.data == null || data.data.value == null || data.data.value.page_layout == 1) {
                        type = 5;
                    } else {
                        type = 4;
                    }
                    var $ul = $('#' + _name).find('.js_mod_product');
                    $ul.attr('data-evtype', type);
                    $ul.attr('data-skuids', skuids);

                    $ul.attr('data-area', _area);
                    var style = $ul.attr('data-style');
                    if (!skuids) {
                        $('#' + _name + ' .goods_list').html('');
                    } else {
                        goodsTools.render({skuids: skuids, area: _area, styletype: style, type: type}, _name);
                    }

                    //setTimeout(function () {
                    //    var __h = $('#' + _name + ' .js_mod_product').height();
                    //    $('#' + _name).css({'height': __h + 'px'});
                    //}, 500);
                });
                //type = $('#J_goodscx_radio input[name="J_ltype"]:checked').val();
                // var isonline = $('#J_marketCpc_online').is(':checked');
            });

            $('#J_glistcg_type label').on('click', function () {
                $('#J_glistcg_type label').removeClass('btn-success');
                $(this).addClass('btn-success');
                var _name = $('#js_class_name').val();
                var style = $(this).data('style');
                var productjcmj = $('#' + _name).find('[data-type="mod_goodscx_jcmj"]');
                var product = $('#' + _name).find('[data-type="mod_goodscx_list"]');
                product.attr('data-style', style);
                productjcmj.attr('data-style', style);
                if(style==4){
                    product.hide();
                    productjcmj.show();
                    $(".forstyle4").show();
                    Fun.addJCMJHeadStyle();
                }else{
                    //Fun.deleJCMJHeadStyle();
                    $(".forstyle4").hide();
                    productjcmj.hide();
                    product.show();
                }
                //$('#J_goodscx_style').val($(this).data('style'));
            });

            $('#J_product_tab .uiproduct_tab_head').on('click', '.item', function () {
                var curr = '#' + $(this).attr('data-id');
                $('#J_product_tab .uiproduct_tab_panel .item').hide();
                $('#J_product_tab .item').removeClass('item_current');
                $(curr).show();
                $(this).addClass('item_current');
            });
            $('#J_products_class').on('click', function () {
                $('#J_uiproduct_dropdown').toggle();
            });
            $('#J_projectal').on('click', function () {
                g.renderList(1);
            });
            $('#J_product_search').on('click', function () {
                var key = $('.uiproduct_form_text').val();
                g.getGoods('key', key, 0, function () {
                    g.renderList();
                });
            });
            $('#J_uiproduct_dropdown').on('click', 'a', function () {
                var tit = $(this).text();
                $('.uiproduct_select .current').text(tit);
                $('#J_uiproduct_dropdown').toggle();
                var did = $(this).attr('data-id');
                var sid = $(this).attr('data-sid');
                g._shopId = sid;
                if (!did) {
                    g.getGoods('key', '', 0, function () {
                        g.renderList();
                    });
                    return;
                }
                g.getGoods('', did, 0, function () {
                    g.renderList();
                });

            });
            $('#commodList1').on('click', '.btns', function () {
                var id = $(this).attr('data-id');
                $(this).parent('li').remove();
                g.vardump();
                g.add(id);
                g.vardump();
            })
            $('#selectsList2').on('click', '.btn_delete', function () {
                var id = $(this).attr('data-id');
                $(this).parent('li').remove();
                g.del(id);
            });
            $('#selectsList2').on('click', '.setTop', function () {
                var $_el = $(this).closest('li');
                var id = $_el.attr('data-id');
                var $ul = $(this).closest('.uiproduct_list').prepend($_el);
                g.setTop(id);
            });

            $('.uiproduct_paginator .prev').on('click', function () {
                g.prev();
            })
            $('.uiproduct_paginator .next').on('click', function () {
                g.next();
            })

        }
    }
    var getMarketCpcData = function(skuids, area, type, cb){
        var url = '//pe.3.cn/prices/pcpmgets?skuids=' +skuids+ '&origin=' +type+ '&source=wxsq&t=' + Date.parse(new Date());

        var url2 = '//yx.3.cn/service/info.action?ids=' +skuids + '&t=' + Date.parse(new Date());

        var level = 2;
        var _skuids = skuids.split(',');
        var linkpre = '//wq.jd.com/item/view?sku=';
        var _data = function(){
            var arr = {};
            var temp = {};
            for (var i = 0,len = _skuids.length ; i < len; i++) {
                arr[_skuids[i]] = {'sUrl': linkpre + _skuids[i], 'id':_skuids[i]};
            };
            return arr;
        }();
        var _currSort = function(_data){
            var new_arr = [];
            var arr = _skuids;
            for (var i = 0,o=0; i < arr.length; i++) {
                for (o = 0; o < _data.length; o++) {
                    if(arr[i] == _data[o].id){
                        new_arr.push(_data[o]);
                        o = _data.length;
                    }
                };
            };
            return new_arr;
        }
        var _cb = function(){
            if(--level <= 0){
                var arr = [];
                for(var key in _data){
                    arr.push(_data[key]);
                }
                arr = _currSort(arr);
                cb(arr);
            }
        }

        $.ajax({
            type : 'GET',
            url : url,
            dataType : "jsonp",
            success : function(data){
                for (var i = 0; i < data.length; i++) {
                    var dwMarketPrice = data[i]['m'];
                    var dwActMinPrice = data[i]['p'];
                    _data[data[i]['id']]['price'] = dwActMinPrice;
                };
                _cb();
            }
        });
        $.ajax({
            type : 'GET',
            url : url2,
            dataType : "jsonp",
            success : function(data2){
                for(var key in data2){
                    _data[key]['name'] = data2[key]['name'];
                    _data[key]['imgUrl'] = '//img10.360buyimg.com/n7/' + data2[key]['imagePath'];
                };
                _cb();
            }
        });
    }
    var Goods = function () {
        var _venderId = Fun.getVenderId();
        //_venderId = 70277;
        this.lastCategory = $('.uiproduct_select .current').text();
        var _pageSize = 5;
        var _commods = [];//
        var _selects = [];
        var currPage = 0;
        var _totalSize = 0;
        var _condition = {};
        var tpl1 = '<li><a target="_blank" href="javascript:;"><img src="{#imgUrl#}" width="40" height="40" class="pic"><p class="name" title="{#name#}">{#name#}</p><p class="price">{#price#}</p></a><a data-tag="list1Btn" class="btns" data-id="{#id#}" href="javascript:;"></a></li>';
        var tpl2 = '<li data-id="{#id#}"><a target="_blank" href="javascript:;"><img src="{#imgUrl#}" width="40" height="40" class="pic"><p class="name" title="{#name#}">{#name#}</p><p class="price">{#price#}</p></a><a class="setTop" href="javascript:;"></a><a data-tag="list2Btn" class="btn btn_delete" data-id="{#id#}" href="javascript:;"></a></li>'

        var next = function () {
            pageshow();
            if (_totalSize - 1 <= currPage) {
                return;
            }
            currPage++;
            getGoods(_condition[0], _condition[1], currPage, function () {
                renderList();
            });
        }

        var prev = function () {
            pageshow();
            if (currPage < 1) return;
            currPage--;
            getGoods(_condition[0], _condition[1], currPage, function () {
                renderList();
            });
        }

        var pageshow = function () {
            $('.uiproduct_paginator a').removeClass('disabled');
            var flag = true;
            if (currPage < 1) {
                $('.uiproduct_paginator .prev').addClass('disabled');
                currPage = 0;
                flag = false;
            }
            if (_totalSize - 1 <= currPage) {
                $('.uiproduct_paginator .next').addClass('disabled');
                currPage = _totalSize - 1;
                flag = false;
            }
            return flag;

        }

        //
        var renderTpl = function (data, tpl) {
            for (var attr in data) {
                tpl = tpl.replace(new RegExp("{#" + attr + "#}", "gm"), data[attr]);
            }
            return tpl;
        }

        var renderList = function (type) {
            var _data = _commods;
            var _tpl = tpl1;
            var $query = $('#commodList1');
            if (type) {
                _data = _selects;
                _tpl = tpl2;
                $query = $('#selectsList2');

            }
            var html = '';
            for (var i = 0; i < _data.length; i++) {
                html += renderTpl(_data[i], _tpl);
            }
            ;
            $query.html(html);
            pageshow();
        }
        //
        var getCategory = function (callback, errorcallback) {

            var categoryCallback = function (data) {
                var categorys = [];
                var list = data.shopCategoryList;
                if (!list) {
                    alert('');
                    return;
                }
                var item = null, temp = [];
                //
                for (var i = 0, a = list.length; i < a; i++) {
                    item = list[i];
                    //1
                    if (item.status != 1)continue;
                    //
                    if (item.parentId == 0) {
                        categorys.push({
                            id: item.id,
                            shopId: item.shopId,
                            name: item.title,
                            children: []
                        });
                    } else {
                        temp.push(item);
                    }
                }

                //orderNo
                categorys.sort(function (a, b) {
                    var g = a.orderNo - b.orderNo;
                    return g > 0 ? 1 : g < 0 ? -1 : 0;
                });

                //
                for (var i = 0, a = temp.length; i < a; i++) {
                    item = temp[i];
                    //
                    for (var j = 0; j < categorys.length; j++) {
                        if (categorys[j].id == item.parentId) {
                            categorys[j].children.push({
                                id: item.id,
                                shopId: item.shopId,
                                name: item.title
                            })
                            break;
                        }
                    }
                }
                callback(categorys);
            }

            $.ajax({
                url: "//wq.jd.com/mshop/ShopCategoryData?venderId=" + _venderId,
                type: 'GET',
                dataType: 'jsonp',
                jsonp: 'callback',
                jsonpCallback: 'categoryCallback',
                success: categoryCallback,
                error: function (msg) {
                    alert('');
                }
            });
        }
        var vardump = function () {
            //console.info(_commods, _selects);
        }

        var _skuadd = function (id) {
            var _name = $('#js_class_name').val();
            var o = $('#' + _name + ' .js_mod_product').attr('data-skuids') || '';
            if (o.indexOf(id) > -1) {
                return;
            }
            o += ',' + id;
            o = o.replace(/^,|,$|/ig, '');
            $('#' + _name + ' .js_mod_product').attr('data-skuids', o);

        }

        var _skuunshift = function (id) {
            var _name = $('#js_class_name').val();
            var skuids = [];
            for (var i = 0; i < _selects.length; i++) {
                skuids.push(_selects[i].id);
            }
            ;
            var o = skuids.join(',');
            $('#' + _name + ' .js_mod_product').attr('data-skuids', o);
        }

        var _skudel = function (id) {
            var _name = $('#js_class_name').val();
            var o = $('#' + _name + ' .js_mod_product').attr('data-skuids') || '';
            if (o.indexOf(id) == -1) {
                return;
            }
            o = o.replace(id, '');
            o = o.replace(',,', ',');
            o = o.replace(/^,|,$|/ig, '');
            $('#' + _name + ' .js_mod_product').attr('data-skuids', o);

        }

        var add = function (id) {
            var obj = {};
            if(_selects.length>=100){
                alert("");
                return;
            }
            for (var i = 0, o = 0; i < _commods.length; i++) {
                if (_commods[i].id == id) {
                    obj = $.extend({}, _commods[i]);
                    for (o = 0; o < _selects.length; o++) {
                        if (_selects[o].id == id) {
                            alert('');
                            return;
                        }
                    }
                    ;
                    _selects.push(obj);
                    _skuadd(obj['id']);
                    _commods.splice(i, 1);

                    return;
                }
            }
            ;
            vardump();
        }
        var del = function (id) {
            var obj = {};
            for (var i = 0, o = 0; i < _selects.length; i++) {
                if (_selects[i].id == id) {
                    _skudel(_selects[i]['id']);
                    _selects.splice(i, 1);
                    return;
                }
            }
            ;
            vardump();
        }

        var unshift = function (id) {
            var topOne = {};
            for (var i = 0; i < _selects.length; i++) {
                if (_selects[i].id == id) {
                    topOne = _selects.splice(i, 1);
                    i = _selects.length;
                }
            }
            ;
            _selects.splice(0, 0, topOne[0]);
        }

        var setTop = function (id) {
            unshift(id);
            _skuunshift(id);
            vardump();
        }
        var _sortArr = function (obj, arr) {
            var newarr = [];
            arr = arr.split(',');
            for (var i = 0, o = 0; i < arr.length; i++) {
                for (o = 0; o < obj.length; o++) {
                    if (obj[o].id == arr[i]) {
                        newarr.push(obj[o]);
                        o = obj.length;
                    }
                }
                ;
            }
            ;
            return newarr;
        }
        var initselectedGoods = function (callback) {
            callback = callback || function () {
                };
            var _name = $('#js_class_name').val();
            var skuids = $('#' + _name + ' .js_mod_product').attr('data-skuids') || '';

            var loadCommodityCkb = function (datas) {
                var commodities = [], item = null;
                for (var key in datas) {
                    item = datas[key];
                    _selects.push({
                        id: key,
                        name: item.name,
                        imgUrl: '//img1' + (key % 5) + '.360buyimg.com/n5/' + item.imagePath,
                        price: '',
                        isList2: true
                    });
                }

                _selects = _sortArr(_selects, skuids);
                console.info(_selects, skuids);
                //sdfsfdsfdsdf
                callback();
            }
            if (!skuids.length) {
                callback();
                return true;
            }
            $.ajax({
                url: '//yx.3.cn/service/info.action?callback=loadCommodityCkb&ids=' + skuids + '&area=19_1607_4773',
                type: 'GET',
                dataType: 'jsonp',
                jsonp: 'callback',
                jsonpCallback: 'loadCommodityCkb',
                success: loadCommodityCkb,
                error: function (msg) {

                }
            });
        }

        var getGoods = function (searchType, keyword, page, callback) {
            _condition = [searchType, keyword];
            callback = callback || function () {
                };
            var goodsCallback = function (data) {
                //
                if (data.error) {
                    callback([]);
                    return false;
                }

                //
                _totalSize = data.Summary.Page.PageCount;

                //
                if (_totalSize == 0) {
                    callback([]);
                    return true;
                }

                var items = [];
                var itemsTemp = data.Product;
                var item;
                for (var i = 0; i < itemsTemp.length; i++) {
                    item = itemsTemp[i];
                    item = {
                        id: item.wareid,
                        name: item.Content.warename,
                        imgUrl: '//img1' + (item.wareid % 5) + '.360buyimg.com/n5/' + item.Content.imageurl,
                        price: item.dredisprice <= 0 ? 0 : parseFloat(item.dredisprice).toFixed(2),
                        soldnum: 0,
                        good: item.good,
                        isList1: true
                    };
                    //
                    // for(var j = 0; j < _selectedCommods.length; j++){
                    //     if(_selectedCommods[j].id == item.id){
                    //         item.selected = true;
                    //         break;
                    //     }
                    // }

                    items.push(item);
                }
                _commods = items;
                callback(items);
            }
            if (!keyword) {
                keyword = '';
            }else{
                if(searchType=="key") {
                    keyword = keyword.replace(//g, ",");
                    var temp = keyword.replace(/,/g, "");
                    if (!isNaN(temp) && page == 0) {
                        var kw = keyword.split(",");
                        if (kw.length > 5) {
                            alert("skuid,");
                            return;
                        }
                        //skuid
                        var venderid = Fun.getVenderId();
                        var kwlength = kw.length;
                        var skuSelf="";
                        var reqIndex = kwlength;
                        for (var i = 0; i < kwlength; i++) {
                            (function (index) {
                                $.ajax({
                                    url: 'http://wq.jd.com/item/view2?datatype=1&areaid=1_72_4139_0&u_source=qq&g_ty=ls',
                                    type: 'GET',
                                    dataType: 'jsonp',
                                    data: {sku: kw[index]},
                                    success: function (d) {
                                        if (!d || !d.item) {
                                            alert(kw[index]+":");
                                        }else if (d.item.venderID != venderid) {
                                            alert(kw[index] + ":sku~");
                                        }else{
                                            skuSelf = skuSelf==""?kw[index]:skuSelf+","+kw[index];
                                        }
                                        reqIndex--;
                                        if (reqIndex<=0&&skuSelf.length>0) {
                                            var _area = '8_584_3268';// 
                                            Deferred.getPageDataById(Fun.getUrlParam("id")).done(function (data) {
                                                if (data == null || data.data == null || data.data.value == null || data.data.value.page_layout == 1) {
                                                    type = 5;
                                                } else {
                                                    type = 4;
                                                }
                                                getMarketCpcData(skuSelf, _area, type, function (data) {
                                                    _commods = data;
                                                    callback(data);
                                                });
                                                return;

                                            });
                                        }
                                    }
                                });
                            })(i);
                        }
                        return;
                    }
                }
            }

            $.ajax({
                url: "//api-search.jd.com/?" + getSearchParam(searchType, keyword, page),
                type: 'GET',
                dataType: 'jsonp',
                jsonp: 'callback',
                jsonpCallback: 'goodsCallback',
                success: goodsCallback,
                error: function (msg) {

                }
            });
        }
        //
        function getSearchParam(searchType, keyword, page) {
            var url = "";
            //
            if (searchType != "key") {
                url = "key=shopcategoryids,," + keyword + "&filt_type=shop_id,L" + g._shopId + "M" + g._shopId;
            } else { //
                url = keyword ? "key=" + keyword + "&filt_type=shop_id,L" + g._shopId + "M" + g._shopId :
                "key=ids,," + g._shopId;
            }

            return url + "&merge_sku=yes&sort_type=sort_winsdate_desc&pagesize=" + _pageSize + "&page=" + page;
        }

        return {
            getCategory: getCategory,
            getGoods: getGoods,
            renderList: renderList,
            add: add,
            setTop: setTop,
            del: del,
            next: next,
            prev: prev,
            vardump: vardump,
            initselectedGoods: initselectedGoods
        }
    }
    var g = Goods();

    exports.init = function () {
        var _self = this;
        $(document).on('show.cpanel', function (e, dom, type, data) {
            if (type == "goodcg_list") {
                if(!Fun.is_pop_shop()){
                    $(".pop_products").hide();
                    $(".jd_products").show();
                    var $mod = $(dom).find('[data-type="mod_goodscx_list"]');
                    var skuids = $mod.attr('data-skuids');
                    $("#j_goodslistcx").val(skuids);
                    var _style = $mod.attr('data-style');
                    if (_style == '') {
                        $('#J_goodscx_style').val(_style);
                    }
                    $('#J_glistcg_type .btn').removeClass('btn-success');
                    $('#J_glistcg_type').find('[data-style="' + _style + '"]').addClass('btn-success');
                }else{
                    resetInputs(dom, type, data);
                }
                if($(dom).find(".mod_filter").is(":visible")){
                    $("#showGoodscgTop").prop("checked",'true');
                }else{
                    $("#showGoodscgTop").removeAttr("checked");
                }
            }
        });
        Event.init();
    };
});;/**
 * (pop)
 */
//todo 
define("mmrp_wx.mod.single_goods_pop_activity",function (require, exports, module) {
    var $ = require('jquery');
    var localStore = require('localStore');
    var Fun = require('mmrp.func');
    var pageInfo = {
        actid: '',
        areaid: '',
        goodsList: [],
        goodsListBackup: [],
        domId: '',
        load_finish: false
    };
    var box_id;
    var _is_searching = false,
        _currPage = 0,
        _pageSize = 5,
        _load_page_size = 100,
        _curr_load_page = 0,
        _maxPage = 0;
    var is_loading = false;
    var tpl1 = '<li data-all=\'{"skuid":{#sSkuId#}}\' class="sku_{#sSkuId#}"><span class=\'has_added\'></span><a  href=\'javascript:void(0);\' title=\'{#sItemName#}\'><img src=\'{#sImg#}\' width=\'40\' height=\'40\' class=\'pic\'><p class=\'name\'>{#sItemName#}</p><p class=\'price\'>{#price#}</p></a><a data-tag=\'list1Btn\' class=\'btns\' href=\'javascript:;\'></a></li>';
    var _userInfo = localStore.getItem('weidianpat_user');

    var $setting_panel = $('#js_set_35');
    var $setting_panel_for_act = $('#js_set_41');

    function $getToken(skey){
		var skey=skey?skey:$getCookie("wq_skey");
		 return skey?$time33(skey):"";
	}

    function $getCookie(name) {
		//COOKIE
		var reg = new RegExp("(^| )" + name + "(?:=([^;]*))?(;|$)"), val = document.cookie.match(reg);
		return val ? (val[2] ? unescape(val[2]) : "") : null;
	}

    function $time33(str){
		//time33
		for(var i = 0, len = str.length,hash = 5381; i < len; ++i){
		   hash += (hash << 5) + str.charAt(i).charCodeAt();
		};
		return hash & 0x7fffffff;
	}

    /**
     * 
     * @param dom
     * @param type
     * @param data
     */
    var resetInputs = function (dom, type, data) {
        pageInfo.domId = $(dom).attr("id");

        var goodsone = $('#' + pageInfo.domId + " .js_box");

        var actid = goodsone.attr("data-activity_i");
        var areaid = goodsone.attr("data-area_i");

        if(actid!="" && actid!=null && areaid!="" && areaid!=null) {
            $("#area_busness_one").attr("data-area_busness", goodsone.attr("data-busness_i") || '');
            $("#area_project_one").attr("data-area_project", goodsone.attr("data-project_i") || '');
            $("#area_activity_one").attr("data-area_activity", actid);
            $("#area_area_one").attr("data-area_area", areaid || '');
            $("#area_busness_one").text(goodsone.attr("data-busness_n") || '');
            $("#area_project_one").text(goodsone.attr("data-project_n") || '');
            $("#area_activity_one").text(goodsone.attr("data-activity_n") || '');
            $("#area_area_one").text(goodsone.attr("data-area_n") || '');
        }else{
            var hareaid = $("#area_area_one").attr("data-area_area");
            if(hareaid!=null&&hareaid!="") {//
                var hactid = $("#area_activity_one").attr("data-area_activity")||'';
                goodsone.attr("data-busness_i", $("#area_busness_one").attr("data-area_busness")||'');
                goodsone.attr("data-busness_n", $("#area_busness_one").text()||'');
                goodsone.attr("data-project_i", $("#area_project_one").attr("data-area_project")||'');
                goodsone.attr("data-project_n", $("#area_project_one").text()||'');
                goodsone.attr("data-activity_i", hactid);
                goodsone.attr("data-activity_n", $("#area_activity_one").text()||'');
                goodsone.attr("data-area_i", hareaid);
                goodsone.attr("data-area_n", $("#area_area_one").text());
                areaid = hareaid;
                actid = hactid;
            }
        }

        changeModPrice();
        g.renderAddedList();
		window.COSS_PRETIME=0;//pretime
		window.COSS_ACTID=0;
		window.COSS_AREAID=0;
		getProductList(actid, areaid, 1);
    };

    var resetInputsForActivity = function(dom){
        pageInfo.domId = $(dom).attr("id");
        var note = $('#' + pageInfo.domId + " .mod_goods_link").attr('data-note');
        $setting_panel_for_act.find('.note').val(note || "");
    }

    var getProductList = function (act_id, area_id, page_no) {

        var render = function(){
            //
            var $box = $("#" + pageInfo.domId).find('.js_box');
            var data = $box.data('goods');
            var skuidAdded;
            if(!data){
                skuidAdded = $box.attr('data-sskuid');
                for(var i = 0, l = pageInfo.goodsList.length; i < l; i++){
                    var v = pageInfo.goodsList[i];
                    if(skuidAdded && skuidAdded == v.sSkuId){
                        g.renderAddedList(v, i);
                        break;
                    }
                }
            }
            //eof

            g.renderList();
        };

        if (!area_id || !act_id){
            pageInfo.goodsList = [];
            pageInfo.goodsListBackup = [];
            render();
            return;
        }

        if(page_no === 1){
            _currPage = 0;
            _is_searching = false;
            $("#addStyle2_2 .uiproduct_form_text").val('');

            if(act_id == pageInfo.actid && area_id == pageInfo.areaid){
                pageInfo.goodsList = pageInfo.goodsListBackup;
                render();
                return;
            }

            pageInfo.goodsList = [];
            pageInfo.goodsListBackup = [];
            _curr_load_page = 1;
            pageInfo.load_finish = false;
        }

        var getGoodsList = function (data) {
            if (data.errCode != 0){
                JD.report.umpBiz({bizid: '65', operation: 3, result: '1', source: '0', message: ""+data.errCode});
                return;
            }
            JD.report.umpBiz({bizid: '65', operation: 3, result: 0, source: '0', message: ""});

            _curr_load_page = page_no;
            pageInfo.goodsList = pageInfo.goodsListBackup.concat(data.data.list);
            pageInfo.goodsListBackup = pageInfo.goodsList;
            pageInfo.actid = act_id;
            pageInfo.areaid = area_id;
            _maxPage = Math.ceil(pageInfo.goodsList.length / _pageSize) - 1;

            if(Math.ceil(data.data.total / _load_page_size) === _curr_load_page){
                pageInfo.load_finish = true;
            }

            render();
        };

        return PopActivityGoodsList.getData({
            "area_id": area_id,
            "act_id": act_id,
            "page_index": page_no,
            "load_page_size": _load_page_size
        }).then(getGoodsList);
    };

    var PopActivityGoodsList = (function(){
        var options = {
            load_page_size: 100,
            page_index: 1,
        };
        function setOptions(opts){
            options = $.extend(options, opts);
            if(!options.act_id || !options.area_id){
                throw "act_id or area_id is empty!";
            }
        }
        function getDataByPage(opts){
            setOptions(opts);
			if(0==window.COSS_PRETIME || options.act_id!=window.COSS_ACTID ||options.area_id!=window.COSS_AREAID ){
				//pretime
				$.ajax({
					url:"//wq.jd.com/martweb/mcoss/remoteSearchAreaListByActiveId.jsonp?g_tk="+$getToken()+"&activeid="+options.act_id+"&venderid="+_userInfo.venderid,
					success:function(d){
						if(d && d.data && d.data.areaList){
							for(var i=0,l=d.data.areaList.length;i<l;i++){
								if(options.area_id==d.data.areaList[i].areaId){
									window.COSS_PRETIME=d.data.areaList[i].beginTime; //pretime
									window.COSS_ACTID=options.act_id;
									window.COSS_AREAID=options.area_id;
									break;
								}
							}
						}
						
					},
					dataType:"jsonp",
					async:false
				});
			}
            return $.ajax({
                url: '//wq.jd.com/mcoss/mmart/show',
                type: 'GET',
                data: {
                    actid: options.act_id,
                    areaid: options.area_id,
                    pi: options.page_index,
                    pc: options.load_page_size,
                    venderid: _userInfo.venderid,
                    pretime:window.COSS_PRETIME?window.COSS_PRETIME:0
                },
                dataType: 'jsonp',
                jsonpCallback: 'getGoodsList',
                error: function () {
                    JD.report.umpBiz({bizid: '65', operation: 3, result: '1', source: '0', message: ""});
                    alert('');
                }
            });
        };
        return {
            getData: getDataByPage
        }
    }());

    /**
     * price ,Q
     */
    var changeModPrice = function () {
        //Q
        var styleModel = $("#js_item_list").find("option:selected").text();
        if (styleModel.indexOf("") >= 0) {
            tpl1 = tpl1.replace(new RegExp("{#price#}", "gm"), "{#dwWeChatPrice#}");
        } else if (styleModel.indexOf("Q") >= 0) {
            tpl1 = tpl1.replace(new RegExp("{#price#}", "gm"), "{#dwMQQPrice#}");
        }
    }

    var searchTimer;
    var Event = {
        init: function () {

            //tab
            $('#J_product_tab_2 .uiproduct_tab_head').on('click', '.item', function () {
                var $this = $(this),
                    curr = '#' + $(this).attr('data-id');

                if($this.hasClass('item_current')){
                    return;
                }

                $('#J_product_tab_2 .uiproduct_tab_panel .item').hide();
                $('#J_product_tab_2 .item').removeClass('item_current');
                $(curr).show();
                $this.addClass('item_current');
            });

            $('#commodList1_2').on('click', '.btns', function () {
                var sSkuId = $(this).data("sskuid");

                g.add(sSkuId, this);
            });

            /**
             * 
             */
            $("#addStyle2_2 .uiproduct_form_text").on("keyup", function () {
                var $this = $(this);
                var key = $this.val();
                pageInfo.goodsList = [];
                _currPage = 0;

                if (key == null || key == "") {
                    _is_searching = false;
                    pageInfo.goodsList = pageInfo.goodsListBackup;
                } else {
                    if(!is_loading){
                        _is_searching = true;
                        for (var i in pageInfo.goodsListBackup) {
                            if (pageInfo.goodsListBackup[i].sItemName.indexOf(key) >= 0 || pageInfo.goodsListBackup[i].sSkuId == key) {
                                pageInfo.goodsList.push(pageInfo.goodsListBackup[i]);
                            }
                        }

                        if(pageInfo.goodsList.length === 0 && !pageInfo.load_finish){
                            pageInfo.goodsList = pageInfo.goodsListBackup;
                            is_loading = true;
                            clearTimeout(searchTimer);
                            searchTimer = setTimeout(function(){
                                getProductList(pageInfo.actid, pageInfo.areaid, _curr_load_page + 1).then(function(){
                                    is_loading = false;
                                    $this.trigger('keyup');
                                }, function(){
                                    pageInfo.goodsList = [];
                                    is_loading = false;
                                });
                            }, 200);
                            return;
                        }
                    }
                }

                _maxPage = Math.ceil(pageInfo.goodsList.length / _pageSize) - 1;
                g.renderList();
            });

            $('#J_product_search_2').on('click', function(){
                $("#addStyle2_2 .uiproduct_form_text").trigger('keyup');
            });

            //
            $('#uiproduct_paginator .prev2').on('click', function () {
                if ($(this).hasClass("disabled") || $(this).parent().hasClass("disabled")) return;
                g.prev();
            });
            $('#uiproduct_paginator .next2').on('click', function () {
                if ($(this).hasClass("disabled") || $(this).parent().hasClass("disabled")) return;
                g.next();
            });
            /**
             * box,
             */
            $(document).on('remove.box', function (e, $dom) {
                var d = $($dom).find(".mod_goods_link");
                if (d != null) {//
                    var sskuid = $($dom).find(".js_box").eq(0).attr("data-sskuid");
                    if (!sskuid) return;//
                    var options={};
                    options.dsskuid = sskuid;
                    $("#exclude_goods_only").trigger("click",options);
                }
            });
            //
            $("#area_update_btn_one").on("click", function () {
                if ($("#wdpat_activity_modal").is(":visible")) return;
                var selectorInfo={};
                selectorInfo.bid = $("#area_busness_one").attr("data-area_busness");

                selectorInfo.projectid = $("#area_project_one").attr("data-area_project");

                selectorInfo.activeid = $("#area_activity_one").attr("data-area_activity");

                selectorInfo.positionid = $("#area_area_one").attr("data-area_area");

                selectorInfo.source = "goodsone";

                $("#area_update_btn_edit").trigger("click",selectorInfo);
            });
            //
            $("#activityBtnFinish_goodsone").on("click", function (e,selectorInfo) {

                $("#area_busness_one").text(selectorInfo.bname);
                $("#area_busness_one").attr("data-area_busness", selectorInfo.bid);

                $("#area_project_one").text(selectorInfo.projectname);
                $("#area_project_one").attr("data-area_project", selectorInfo.projectid);

                $("#area_activity_one").text(selectorInfo.activename);
                $("#area_activity_one").attr("data-area_activity", selectorInfo.activeid);

                $("#area_area_one").text(selectorInfo.positionname);
                $("#area_area_one").attr("data-area_area", selectorInfo.positionid);

                var _name = $('#js_class_name').val();
                var goodsone = $('#' + _name+" .js_box");
                goodsone.attr("data-busness_i", selectorInfo.bid);
                goodsone.attr("data-busness_n", selectorInfo.bname);
                goodsone.attr("data-project_i", selectorInfo.projectid);
                goodsone.attr("data-project_n", selectorInfo.projectname);
                goodsone.attr("data-activity_i", selectorInfo.activeid);
                goodsone.attr("data-activity_n", selectorInfo.activename);
                goodsone.attr("data-area_i", selectorInfo.positionid);
                goodsone.attr("data-area_n", selectorInfo.positionname);

                getProductList(selectorInfo.activeid, selectorInfo.positionid,1);//page_no1

            });
        },
        initForActivity: function(materiaid){
            $setting_panel_for_act.find('.goods_list_style').hide();
            $setting_panel_for_act.find('.goods_list_filter').hide();
            $setting_panel_for_act.find('.btn').off('click').on('click', function(){
                var note = $setting_panel_for_act.find('.note').val();
                if(note){
                    $('#' + pageInfo.domId + " .mod_goods_link").attr('data-note', note);
                    Fun.alert('!');
                } else {
                    Fun.alert('!');
                }
            });
        }
    }


    var Goods = function () {

        //
        var renderTpl = function (data, tpl) {
            if(!data.sImg) data.sImg = data.sImg200x200;
            for (var attr in data) {
                if(attr)
                tpl = tpl.replace(new RegExp("{#" + attr + "#}", "gm"), data[attr]);
            }
            return tpl;
        };
        /**
         * 
         * @param type   
         * @param direct
         */
        var renderList = function () {
            var _data = pageInfo.goodsList;
            var _tpl = tpl1;
            var $query = $('#commodList1_2');
            var html = '';
            var pageIndex = _currPage * _pageSize;
            for (var i = pageIndex, l = _data.length; i < l && i < pageIndex + _pageSize; i++) {
                html += renderTpl(_data[i], _tpl);
            }
            $query.html(html);

            //
            var $addedItem = $('#selectsList2_2').find('li');
            if($addedItem.length){
                var $item = $query.find('.sku_' + $addedItem.data('all').skuid);
                if($item.length){
                    $item.find('.btns').hide();
                    $item.find('.has_added').show();
                }
            }

            pageshow();
        };
        var renderAddedList = function(data, index){
            var $item;

            if(!data){
                data = $("#" + pageInfo.domId).find('.js_box').data('goods');
                data && (data.dwWeChatPrice = data.price);
                data && (data.dwMQQPrice = data.price);
            }


            if(data){
                $item = $(renderTpl(data, tpl1));
                $item.addClass('on');
                $item.find('.btns').hide();
                $item.find('.has_loaded').show();
                $('#selectsList2_2').html($item);
                $("#selectedItemSKU").show()
                    .find('span').eq(0).html(data.sSkuId);
            } else {
                $('#selectsList2_2').empty();
                $("#selectedItemSKU").hide()
                    .find('span').eq(0).html("");
            }
        }

        /**
         *  
         * @param sSkuId
         * @param self
         */
        var add = function (sSkuId, self) {
            var data, $this = $(self),
                $item = $this.closest('li'),
                $itemAdded = $item.clone(),
                $addedList = $('#selectsList2_2');

            $this.hide()
                .prev('.has_added').removeClass('hide');
            data = $item.data('all');
            $("#" + pageInfo.domId).find("a").attr("href", '//wq.jd.com/item/view?sku=' + data.skuid);
            $("#" + pageInfo.domId + " .js_box")
                .attr("data-goods", JSON.stringify({
                    'sSkuId': data.skuid,
                    'sImg': $item.find('.pic').attr('src'),
                    'price': $item.find('.price').text(),
                    'sItemName': $item.find('.name').text()
                }))
                //
                .attr('data-sskuid', data.skuid);

            var $prevAddedItem;
            try{
                $prevAddedItem = $('#commodList1_2').find('.sku_' + $addedList.find('li').data('all').skuid);
            }catch (e){
                $prevAddedItem = [];
            }

            if($prevAddedItem.length){
                $prevAddedItem.find('.has_added').hide();
                $prevAddedItem.find('.btns').show();
            }

            $itemAdded.addClass('on')
                .data('index', $item.index())
                .data('skuid', data.skuid)
                .find('.btns').remove();
            $addedList.html($itemAdded);
            $("#selectedItemSKU").show()
                .find('span').eq(0).html(data.skuid);

            Fun.alertLoading("");
        };
        /**
         * 
         */
        var next = function () {
            _currPage++;

            //
            if (!_is_searching && _currPage + 1 >= _maxPage && !pageInfo.load_finish) {
                getProductList(pageInfo.actid, pageInfo.areaid, _curr_load_page + 1).fail(renderList);
            } else {
                renderList();
            }
        };

        /**
         * 
         */
        var prev = function () {
            if(_currPage - 1 >= 0) {
                _currPage--
            }
            renderList();
        };

        /**
         * 
         */
        var pageshow = function () {
            $('#uiproduct_paginator a').removeClass('disabled');
            if (_currPage <= 0) {
                $('#uiproduct_paginator .prev2').addClass('disabled');
            }
            if (_currPage >= _maxPage && (pageInfo.load_finish || _is_searching)) {
                $('#uiproduct_paginator .next2').addClass('disabled');
            }
        };

        return {
            renderList: renderList,
            renderAddedList: renderAddedList,
            add: add,
            next: next,
            prev: prev
        }
    }
    var g = Goods();
    //
    var resetStoreEntrance = function(dom, type, data){
        var d = $('#' + $(dom).attr("id")+" .js_box");
        var store = d.attr("data-isself")=="1"?true:false;
        document.getElementById("store_self").checked=store;
        document.getElementById("store_logo").checked = d.attr("data-isstorestyle")=="1"?true:false;
        $("#store_logo").attr("disabled",store);
        $("#store_biaoyu").attr("disabled",store);
        $("#store_biaoyu").val(d.attr("data-biaoyu"));
    }
    var store_init=function(){
        $("#store_self_save").on("click",function(){
            var _name = $('#js_class_name').val();
            var storBox = $("#"+_name+" .js_box");
            $(storBox).attr("data-isself",$("#store_self").is(':checked')?"1":"0");
            var venderid = Fun.getVenderId();
            if(venderid==""){
                return;
            }
            var storeaddress = '//wq.jd.com/mshop/gethomepage?venderId=' + venderid+"ptag=17048.7.1";
            if($("#store_self").is(':checked')){//
                var width = storBox.width();
                var height = storBox.height();
                var htmls = '<a class="entry_ft_btn_b store_entrance_a" href="'+storeaddress+'"></a>';
                storBox.html(htmls);
                $(storBox).parent().css("width",width)
                                   .css("height",height);
                return;
            }
            if($("#store_logo").is(':checked')){//
                storBox.attr("data-isstorestyle","1");
                storBox.attr("data-biaoyu",$("#store_biaoyu").val());
                $.ajax({
                    type: 'GET',
                    url: "//rms.shop.jd.com/json/pop/shopInfo.action",
                    data: {ids:venderid},
                    jsonp: 'callback',
                    dataType: "jsonp",
                    success:function(d){
                        if(d!=null){
                            var image = "";
                            var name;
                            $.each(d,function(i,item){
                                if(item.venderId==venderid){
                                    image = item.logo;
                                    name = item.name;
                                    return false;
                                }
                            });
                            if(image!="") {
                                //LOGO
                                var htmls = '<div class="entry_h" data-type="mod_store_logo"><div class="entry_logo"><img src="' + image + '"></div><div class="entry_slogan"><span>' + name + '</span><br /><span class="entry_sub_slogan">' + $("#store_biaoyu").val() + '</span></div><a class="entry_btn" href="'+storeaddress+'"></a></div>';
                                Fun.addStoreLogo();
                                storBox.html(htmls);
                                return;
                            }
                        }
                        alert("logo");
                    },
                    error:function(){alert("logo");}
                });
                return;
            }
            //
            var htmls = '<a class="entry_ft_btn store_entrance_a" href="'+storeaddress+'"></a>';
            storBox.html(htmls);
            storBox.parent().width("");
            storBox.parent().height("");
        });
        $("#store_self").on("click",function(){
            var f = $(this).is(':checked');
            $("#store_logo").attr("disabled",f);
            $("#store_biaoyu").attr("disabled",f);
        });
    }
    exports.init = function () {
        var materiaid = window.__materiaid;

        $(document).on('show.cpanel', function (e, dom, type, data) {
            if (type == "goods_link") {
                box_id = data.class_name;

                if(!isNaN(materiaid)){
                    $setting_panel.hide();
                    $setting_panel_for_act.show();
                    resetInputsForActivity(dom);
                    Event.initForActivity(materiaid);
                    return;
                }

                resetInputs(dom, type, data);
            }else if(type=="store_entrance"){
                resetStoreEntrance(dom, type, data);
            }
        });

        if(isNaN(materiaid)) {
            Event.init();
        }

        store_init();
    };
});/**
 * pop
 */
define("mmrp_wx.mod.goods_list_pop_activity",function (require, exports, module) {
    window.JD = window.JD || {"report": {"umpBiz": function(){}}};

    var $ = require('jquery');
    var localStore = require('localStore');
    var Fun = require('mmrp.func');
    var pageInfo = {
        actid: '',
        areaid: '',
        goodsList: [],
        selectedList:[],
        domId: '',
        load_finish: false
    };
    var _is_searching = false, _currPage = 0, _maxPage = 0, _pageSize = 5, _curr_load_page = 1, _load_page_size = 100;
    //
    var tpl = '<li><span class="has_added {#show_has_added#}"></span><a target="_blank" href="javascript:;" title="{#sItemName#}"><img src="{#sImg#}" width="40" height="40" class="pic"><p class="name">{#sItemName#}</p><p class="price">{#price#}</p></a><a data-tag="list1Btn" class="btns {#display#}" data-sskuId="{#sSkuId#}" href="javascript:;" title=""></a></li>';
    var tpl_1 = '<li data-skuid="{#sSkuId#}"><a target="_blank" href="javascript:;"><img src="{#sImg#}" width="40" height="40" class="pic"><p class="name" style="max-width: 120px;" title="{#sItemName#}">{#sItemName#}</p><p class="price">{#price#}</p></a><a class="setTop" href="javascript:;" title=""></a><a data-tag="list2Btn" class="btn btn_delete" data-id="{#sSkuId#}" href="javascript:;" title=""></a></li>';
    //Q
    var isWX=1;
    var Style = {
        "single_col": 1,
        "double_col": 2,
        "privilege": 3,
        "add_car": 4
    }
    //
    var tpl1 = '<li class="hproduct {#cls#}" data-skuid="{#sSkuId#}"><a class="mod_g_img200x200" href="{#sUrl#}" title="{#sFullName#}"><p class="cover"><img src="{#sImg#}" alt="{#sFullName#}" /></p><p class="fn">{#sItemName#}</p><p class="prices"><strong><em>&yen;{#dwActMinPrice#}</em></strong></p><span class="btn_buy"></span></p></a></li>';
    var tpl2 = '<li data-test class="hproduct {#cls#}" data-skuid="{#sSkuId#}"><a href="{#sUrl#}" class="mod_g_img200x200"><p class="cover"><img src="{#sImg#}" alt="{#sFullName#}"></p><p class="fn">{#sItemName#}</p><p class="prices" style=""><strong><em>&yen;{#dwActMinPrice#}</em></strong></p></a></li>';
    var tpl3 = '<li class="hproduct {#cls#}" data-skuid="{#sSkuId#}"><a href="{#sUrl#}" class="url"><img class="photo" src="{#sImg#}" alt="{#sFullName#}"><h3 class="fn">{#sItemName#}</h3><p class="disc"></p><p class="prices price"><strong>&yen;{#dwActMinPrice#}</strong></p><p class="other"><span class="o3"></span></p></a></li>';
    var tpl4='<li><a href="{#sUrl#}" class="twoGoodImg" data-skuid="{#sSkuId#}"><img src="{#sImg#}"></a><label class="twoGoodInfo"><h2 class="fn">{#sItemName#}</h2><h3 class="ext2">{#ext2#}</h3><div class="prices oneGoodPrice oneGoodPriceMT38px"><b>&yen;{#dwActMinPrice#}</b></div><div class="oneGoodCart"></div></label><div class="label ext1">{#ext1#}</div><div class="saleoutMsk" style="display:{#outMask#};"><div class="saleoutIco"><div class="saleoutText"><br>SALEOUT</div></div></div></li>';
    var _userInfo = localStore.getItem('weidianpat_user');
    var isBISort=true;
    var $setting_panel = $('#js_set_36');
    //
    var $setting_panel_for_act = $('#js_set_41');

	function $getToken(skey){
		var skey=skey?skey:$getCookie("wq_skey");
		 return skey?$time33(skey):"";
	}

	function $getCookie(name) {
		//COOKIE
		var reg = new RegExp("(^| )" + name + "(?:=([^;]*))?(;|$)"), val = document.cookie.match(reg);
		return val ? (val[2] ? unescape(val[2]) : "") : null;
	}

	function $time33(str){
		//time33
		for(var i = 0, len = str.length,hash = 5381; i < len; ++i){
		   hash += (hash << 5) + str.charAt(i).charCodeAt();
		};
		return hash & 0x7fffffff;
	}
	
    /**
     * 
     * @param dom
     * @param type
     * @param data
     */
    var resetInputs = function (dom, type, data) {
        pageInfo.domId = $(dom).attr("id");
        var goodslist = $('#' + pageInfo.domId).find('[data-type="mod_goods_list"]');
        var actid = goodslist.attr("data-activity_i");
        var areaid = goodslist.attr("data-area_i");

        if(goodslist.attr("data-isSelf") == 1){
            selectHandle();
            $("input[name='selecttype']").get(1).checked=true;
        }else{
            selectBI();
            $("input[name='selecttype']").get(0).checked=true;
        }

        if(actid!=""&&actid!=null&&areaid!=""&&areaid!=null) {
            $("#area_busness_list").attr("data-area_busness", goodslist.attr("data-busness_i") || '');

            $("#area_project_list").attr("data-area_project", goodslist.attr("data-project_i") || '');

            $("#area_activity_list").attr("data-area_activity", actid || '');
            $("#area_area_list").attr("data-area_area", areaid || '');

            $("#area_busness_list").text(goodslist.attr("data-busness_n") || '');

            $("#area_project_list").text(goodslist.attr("data-project_n") || '');

            $("#area_activity_list").text(goodslist.attr("data-activity_n") || '');

            $("#area_area_list").text(goodslist.attr("data-area_n") || '');
        }else{
            var hareaid= $("#area_area_list").attr("data-area_area");
            if(hareaid!=null&&hareaid!=""){//
                var hactid = $("#area_activity_list").attr("data-area_activity")||'';
                goodslist.attr("data-busness_i", $("#area_busness_list").attr("data-area_busness")||'');
                goodslist.attr("data-busness_n", $("#area_busness_list").text()||'');
                goodslist.attr("data-project_i",  $("#area_project_list").attr("data-area_project")||'');
                goodslist.attr("data-project_n", $("#area_project_list").text()||'');
                goodslist.attr("data-activity_i", hactid);
                goodslist.attr("data-activity_n", $("#area_activity_list").text()||'');
                goodslist.attr("data-area_i", hareaid);
                goodslist.attr("data-area_n", $("#area_area_list").text()||'');
                areaid = hareaid;
                actid = hactid;
            }
        }

        $("#goods_shownumber").val(goodslist.attr("data-goodssize")||10);

        var style = goodslist.attr("data-style")||2;
        $("#J_glistcg_type_3 label").removeClass('btn-success');
        $("#J_glistcg_type_3 label[data-style="+style+"]").addClass('btn-success');

        $("#selectsList2_3").html("");
        $("#commodList1_3").html("");
		window.COSS_PRETIME=0;//pretime
		window.COSS_ACTID=0;
		window.COSS_AREAID=0;
        getProductList(actid, areaid, 1);
    };
    var resetInputsForActivity = function(dom){
        pageInfo.domId = $(dom).attr("id");

        var $goodList = $('#' + pageInfo.domId + " .mod_goods_list");
        var note = $goodList.attr('data-note');
        var style = $goodList.attr('data-style') || 2;
        $setting_panel_for_act.find('.note').val(note || "");
        $setting_panel_for_act.find('.goods_list_style').find('.list_style[value="' + style + '"]').trigger('click');
    }
    var getProductList = function (actid, areaid, page_no) {
        var render = function(){
            if(!isBISort){
                var s = $('#' + pageInfo.domId).find('[data-type="mod_goods_list"]').attr("data-skuids");

                pageInfo.goodsList.forEach(function(item){
                    delete item.is_added;
                });

                if(s && s.length > 0){
                    s = s.split(",");
                    pageInfo.selectedList = [];
                    s.forEach(function(item){
                        for(var i = 0, l = pageInfo.goodsList.length; i < l; i++){
                            var v = pageInfo.goodsList[i];
                            if(item == v.sSkuId){
                                v.is_added = true;
                                v.index = i;
                                pageInfo.selectedList.push(v);
                                return;
                            }
                        }

                        //dom
                        if(!pageInfo.load_finish){
                            $item = $('#' + pageInfo.domId).find('[data-skuid='+ item +']');
                            if($item.length){
                                var price = $item.find('.prices').text().replace(/[^0-9.]/g, '');
                                pageInfo.selectedList.push({
                                    "sSkuId": item,
                                    "sImg": $item.find('img').attr('src'),
                                    "sItemName": $item.find('.fn').text(),
                                    "price": price,
                                    "dwWeChatPrice": price,
                                    "dwMQQPrice": price,
                                    "ext1": $item.find('.ext1').text(),
                                    "ext2": $item.find('.ext2').text()
                                });
                            }
                        }
                    });
                }
            }

            _maxPage = Math.ceil(pageInfo.goodsList.length / _pageSize) - 1;
            g.renderList();
            !isBISort && g.renderList2();
        };

        if (areaid == "" || areaid == null || actid == "" || actid == null) {
            pageInfo.goodsList = [];
            render();
            return;
        }

        if(page_no === 1){
            _currPage = 0;
            _is_searching = false;
            pageInfo.selectedList = [];
            $("#addStyle2_3 .uiproduct_form_text").val('');

            if(actid == pageInfo.actid && areaid == pageInfo.areaid){
                pageInfo.goodsList = pageInfo.goodsListBackup;
                render();
                return;
            }

            pageInfo.goodsList = [];
            _curr_load_page = 1;
            pageInfo.load_finish = false;
        }

        tpl = changeModPrice(tpl, "price");
        tpl_1 = changeModPrice(tpl_1, "price");

        var getGoodsList = function (data) {
            if (data.errCode != 0){
                JD.report.umpBiz({bizid: '65', operation: 3, result: '1', source: '0', message: ""+data.errCode});
                return;
            }
            JD.report.umpBiz({bizid: '65', operation: 3, result: 0, source: '0', message: ""});


            _curr_load_page = page_no;
            pageInfo.goodsListBackup = pageInfo.goodsList = pageInfo.goodsList.concat(data.data.list);
            pageInfo.areaid = areaid;
            pageInfo.actid = actid;

            if(Math.ceil(data.data.total / _load_page_size) === _curr_load_page){
                pageInfo.load_finish = true;
            }

            render();
        };

        var getDataByPage = function(index, callback){
			if(0==window.COSS_PRETIME || actid!=window.COSS_ACTID ||areaid!=window.COSS_AREAID ){
				//pretime
				$.ajax({
					url:"//wq.jd.com/martweb/mcoss/remoteSearchAreaListByActiveId.jsonp?g_tk="+$getToken()+"&activeid="+actid+"&venderid="+_userInfo.venderid,
					success:function(d){
						if(d && d.data && d.data.areaList){
							for(var i=0,l=d.data.areaList.length;i<l;i++){
								if(areaid==d.data.areaList[i].areaId){
									window.COSS_PRETIME=d.data.areaList[i].beginTime; //pretime
									window.COSS_ACTID=actid;
									window.COSS_AREAID=areaid;
									break;
								}
							}
						}
						
					},
					dataType:"jsonp",
					async:false
				});
			}
            return $.ajax({
                url: '//wq.jd.com/mcoss/mmart/show',
                type: 'GET',
                data: {
                    actid: actid,
                    areaid: areaid,
                    pi: index,
                    pc: _load_page_size,
                    venderid: _userInfo.venderid,
                    pretime:window.COSS_PRETIME?window.COSS_PRETIME:0
                },
                dataType: 'jsonp',
                jsonpCallback: 'getGoodsList',
                success: callback,
                error: function () {
                    JD.report.umpBiz({bizid: '65', operation: 3, result: '1', source: '0', message: ""});
                    alert('');
                }
            });
        };

        return getDataByPage(page_no, getGoodsList);
    };

    /**
     * price ,Q
     */
    var changeModPrice = function (_tpl,key) {
        //Q
        var styleModel = $("#js_item_list").find("option:selected").text();
        if (styleModel.indexOf("") >= 0) {
            _tpl = _tpl.replace(new RegExp("{#"+key+"#}", "gm"), "{#dwWeChatPrice#}");
            isWX = 1;
        } else {
            _tpl = _tpl.replace(new RegExp("{#"+key+"#}", "gm"), "{#dwMQQPrice#}");
            isWX = 2;
        }
        return _tpl;
    }
    var Event = {
        init: function () {
            //tab
            $('#J_product_tab_3 .uiproduct_tab_head').on('click', '.item', function () {
                var $this = $(this);
                var curr = '#' + $this.attr('data-id');

                if(isBISort) {
                    return;
                }

                if($this.hasClass('item_current') && $this.attr('data-id') != "addStyle1_3"){
                    return;
                }

                $('#J_product_tab_3 .uiproduct_tab_panel .item').hide();
                $('#J_product_tab_3 .item').removeClass('item_current');
                $(curr).show();
                $this.addClass('item_current');
                g.renderList2();
            });

            $('#commodList1_3').on('click', '.btns', function () {
                var sSkuId = $(this).data("sskuid");
                g.add(sSkuId, this);
            });
            /**
             * 
             */
            $("#addStyle2_3 .uiproduct_form_text").on("keyup", function () {
                var key = $(this).val();
                pageInfo.goodsList = [];
                _currPage = 0;
                if (!key || key == "") {
                    _is_searching = false;
                    pageInfo.goodsList = pageInfo.goodsListBackup;
                } else {
                    _is_searching = true;
                    pageInfo.goodsListBackup.forEach(function(item){
                        if (item.sItemName.indexOf(key) >= 0 || item.sSkuId == key) {
                            pageInfo.goodsList.push(item);
                        }
                    });
                }
                _maxPage = Math.ceil(pageInfo.goodsList.length / _pageSize) - 1;
                g.renderList();
            });

            $('#J_product_search_3').on('click', function(){
                $("#addStyle2_3 .uiproduct_form_text").trigger('keyup');
            });

            $('#selectsList2_3').on('click', '.btn_delete', function () {
                var id = $(this).attr('data-id');
                $(this).parent('li').remove();
                g.del(id);
            });
            $('#selectsList2_3').on('click', '.setTop', function () {
                var id = $(this).next("a").attr('data-id');
                var $_el = $(this).closest("li");
                var $ul = $(this).closest('.uiproduct_list').prepend($_el);
                g.setTop(id);
                return false;
            });
            $("#selectsList2_3").on("click","li",function(){
                $(this).addClass("selectLI").siblings().removeClass("selectLI");
            });
            $("#selectsList2_3").on("blur","li",function(){
                $("#selectsList2_3").children("li").removeClass("selectLI");
            });
            $("#selectsList2_3").keydown(function(event){
                if(event.which==38){//
                    var self = $(event.target).closest("li");
                    var up = self.prev();
                    if(up!=null){
                        var index = getIndexFromSelected(up.attr("data-skuid"));
                        self.insertBefore(up);
                        var t = pageInfo.selectedList.splice(+index+1, 1);
                        pageInfo.selectedList.splice(index, 0,t[0]);
                    }
                }else if(event.which==40){//
                    var self = $(event.target).closest("li");
                    var down = self.next();
                    if(down!=null){
                        var index = getIndexFromSelected(self.attr("data-skuid"));
                        self.insertAfter(down);
                        var t = pageInfo.selectedList.splice(index, 1);
                        pageInfo.selectedList.splice(+index+1, 0,t[0]);
                    }
                }
                return false;
            });
            $("input[name='selecttype']").on("change",function(){
                var id=$(this).attr("id");
                if(id=="goodslistBiSort"){
                    $("#commodList1_3").html("");
                    selectBI();
                }else if(id="goodslistHandle"){
                    selectHandle();
                }

                getProductList($("#area_activity_list").attr("data-area_activity"),$("#area_area_list").attr("data-area_area"), 1);
            });
            //
            $('#uiproduct_paginator3 .prev3').on('click', function () {
                if ($(this).hasClass("disabled") || $(this).parent().hasClass("disabled")) return;
                g.prev();
            })
            $('#uiproduct_paginator3 .next3').on('click', function () {
                if ($(this).hasClass("disabled") || $(this).parent().hasClass("disabled")) return;
                g.next();
            })

            //
            $('#J_glistcg_type_3 label').on('click', function () {
                $('#J_glistcg_type_3 label').removeClass('btn-success');
                $(this).addClass('btn-success');
            });

            //
            $("#J_glistcg_submit_3").on("click", function () {

                var _name = $('#js_class_name').val();
                var style = $('#J_glistcg_type_3 .btn-success').attr("data-style");

                var goodslist = $('#' + _name).find('.mod_goods_list');
                goodslist.attr('data-style', style);
                if($("#showGoodslistTop").is(':checked')){
                    $(goodslist).find('.mod_filter').css("display","block");
                }else{
                    $(goodslist).find('.mod_filter').css("display","none");
                }
                var _tpl = tpl1;
                var modgoodslist = $('#' + _name+" div[data-type='mod_goods_list']");
                if (style == Style.single_col) {
                    $(modgoodslist).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemlist').empty();
                    _tpl = tpl1;
                } else if (style == Style.double_col) {
                    $(modgoodslist).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemgrid').empty();
                    _tpl = tpl2;
                } else if (style == Style.privilege) {
                    $(modgoodslist).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_julist').empty();
                    _tpl = tpl3;
                }else if(style==Style.add_car){
                    _tpl = tpl4;
                }
                _tpl = changeModPrice(_tpl,"dwActMinPrice");

                goodslist.attr("data-actid",pageInfo.actid);
                goodslist.attr("data-areaid",pageInfo.areaid);
                goodslist.attr("data-venderid",_userInfo.venderid);
                goodslist.attr("data-wq",isWX);
                //goodslist.removeAttr("is-dirty");

                var htmls = "";
                var arrList =[];
                var render = function (){
                    for (var i = 0; i < arrList.length && i < goodsSize; i++) {
                        g.resetData(arrList[i]);
                        htmls += g.renderTpl(arrList[i], _tpl);
                    }
                    if(style==4){
                        goodslist.eq(0).hide();
                        goodslist.eq(1).show();
                        Fun.addMKJCHeadStyle();
                        $('#' + _name+ " div[data-type='mod_goods_list_mkjc']").find('.goods_list').html(htmls);
                    }else{
                        goodslist.eq(1).hide();
                        goodslist.eq(0).show();
                        $(modgoodslist).find('.goods_list').html(htmls);
                    }
                    setTimeout(function(){
                        goodslist.attr("data-sheight",$('#' + _name+" .mod_goods_list:visible").find('.goods_list').height());
                    },100);
                };
                if($("input[name='selecttype']:checked").attr("data-index")==1){//BI
                    arrList = pageInfo.goodsList;
                    goodslist.removeAttr("data-isSelf");
                    goodslist.removeAttr("data-skuids");
                    var goodsSize = $("#goods_shownumber").val();

                    if (isNaN(goodsSize))
                        goodsSize = 10;
                    goodsSize = parseInt(goodsSize);
                    if (goodsSize < 1)
                        goodsSize = 10;
                    else if (goodsSize > 200)
                        goodsSize = 200;
                    if(goodsSize > pageInfo.goodsList.length){
                        //Fun.alertLoading("")
                        if (!pageInfo.load_finish) {
                            var xhr = getProductList(pageInfo.actid, pageInfo.areaid, _curr_load_page + 1);
                            xhr && xhr.done(function(){
                                arrList = pageInfo.goodsList;
                                goodsSize = arrList.length;
                                $("#goods_shownumber").val(goodsSize);
                                goodslist.attr("data-goodssize", goodsSize);
                                render();

                            });
                            return;
                        } else {
                            goodsSize = pageInfo.goodsList.length;
                        }
                    }
                    $("#goods_shownumber").val(goodsSize);
                    goodslist.attr("data-goodssize", goodsSize);
                }else{
                    arrList = pageInfo.selectedList;
                    goodslist.attr("data-isSelf",1);
                    var skuids = "";
                    for(var i=0;i<arrList.length;i++){
                        skuids +=","+arrList[i].sSkuId;
                    }
                    goodslist.attr("data-skuids", skuids.length > 0 ? skuids.substr(1,skuids.length) : "");
                    goodsSize = arrList.length;
                }

                render();
            });
            //
            $("#area_update_btn_list").on("click", function () {
                if ($("#wdpat_activity_modal").is(":visible")) return;
                var selectorInfo={};
                selectorInfo.bid = $("#area_busness_list").attr("data-area_busness");

                selectorInfo.projectid = $("#area_project_list").attr("data-area_project");

                selectorInfo.activeid = $("#area_activity_list").attr("data-area_activity");

                selectorInfo.positionid = $("#area_area_list").attr("data-area_area");

                selectorInfo.source = "goodslist";

                $("#area_update_btn_edit").trigger("click",selectorInfo);
            });
            //
            $("#activityBtnFinish_goodslist").on("click", function (e,selectorInfo) {

                $("#area_busness_list").text(selectorInfo.bname);
                $("#area_busness_list").attr("data-area_busness", selectorInfo.bid);

                $("#area_project_list").text(selectorInfo.projectname);
                $("#area_project_list").attr("data-area_project", selectorInfo.projectid);

                $("#area_activity_list").text(selectorInfo.activename);
                $("#area_activity_list").attr("data-area_activity", selectorInfo.activeid);

                $("#area_area_list").text(selectorInfo.positionname);
                $("#area_area_list").attr("data-area_area", selectorInfo.positionid);

                var _name = $('#js_class_name').val();
                var goodslist = $('#' + _name).find('[data-type="mod_goods_list"]');
                goodslist.attr("data-busness_i", selectorInfo.bid);
                goodslist.attr("data-busness_n", selectorInfo.bname);
                goodslist.attr("data-project_i", selectorInfo.projectid);
                goodslist.attr("data-project_n", selectorInfo.projectname);
                goodslist.attr("data-activity_i", selectorInfo.activeid);
                goodslist.attr("data-activity_n", selectorInfo.activename);
                goodslist.attr("data-area_i", selectorInfo.positionid);
                goodslist.attr("data-area_n", selectorInfo.positionname);

                getProductList(selectorInfo.activeid, selectorInfo.positionid, 1);

            });
        },
        initForActivity: function(materiaid){
            $setting_panel_for_act.find('.btn').off('click').on('click', function(){
                var note = $setting_panel_for_act.find('.note').val();
                if(note){
                    $('#' + pageInfo.domId + " .mod_goods_list").attr('data-note', note);
                    Fun.alert('!');
                } else {
                    Fun.alert('!');
                }
            });

            $setting_panel_for_act.find('.goods_list_style').show().off('click').on('click', function(e){
                var style = e.target.value,
                    sheight = 0, //
                    $goodsList = $('#' + pageInfo.domId + " .mod_goods_list"),
                    tpl = [
                        '<li class="hproduct "><a class="mod_g_img200x200" href="#" title=""><p class="cover"><img src="//ppms.wq.jd.com/wxpat/img/img290x290.jpg"></p><p class="fn"></p><p class="prices"><strong><em></em></strong></p><span class="btn_buy"></span><p></p></a></li>',
                        '<li data-test="" class="hproduct "><a href="#" class="mod_g_img200x200"><p class="cover"><img src="//ppms.wq.jd.com/wxpat/img/img290x290.jpg"></p><p class="fn"></p><p class="prices" style=""><strong><em></em></strong></p></a></li>',
                        '<li class="hproduct "><a href="#" class="url"><img class="photo" src="//ppms.wq.jd.com/wxpat/img/img290x290.jpg"><h3 class="fn"></h3><p class="disc"></p><p class="price"><strong></strong></p><p class="other"><span class="o3"></span></p></a></li>',
                    ];

                $goodsList.attr('data-style', style);
                if(style==Style.add_car){
                    $goodsList.eq(0).hide();
                    $goodsList.eq(1).show();
                    Fun.addMKJCHeadStyle();
                    sheight = $goodsList.height();
                    $setting_panel_for_act.find('.show_filter').attr('disabled', 'true');
                } else {
                   $goodsList.eq(1).hide();
                   $goodsList.eq(0).show();
                    $('#mod_pub_mkjc').remove();
                    $setting_panel_for_act.find('.show_filter').removeAttr('disabled');
                    if (style == Style.single_col) {
                       $goodsList.eq(0).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemlist').html(tpl[style - 1]);
                    } else if (style == Style.double_col) {
                       $goodsList.eq(0).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_itemgrid').html(tpl[style - 1] +tpl[style - 1]);
                    } else if (style == Style.privilege) {
                       $goodsList.eq(0).find('.goods_list').removeAttr('class').addClass('goods_list clear mod_julist').html(tpl[style - 1]);
                    }
                    sheight = $goodsList.eq(0).find('.goods_list').height();
                }

                $goodsList.attr('data-sheight', sheight);

            });
            $setting_panel_for_act.find('.goods_list_filter').show();
            $setting_panel_for_act.find('.show_filter').off('click').on('click', function(){
                var goodslist = $('#' + pageInfo.domId).find('.mod_goods_list').eq(0);
                if($(this).is(':checked')){
                    goodslist.find('.mod_filter').css("display","block");
                }else{
                    goodslist.find('.mod_filter').css("display","none");
                }
            });
        }
    }
    //
    var selectHandle = function(){
        isBISort = false;
        $("#addStyle1_3_1").show();
        $("#addStyle1_3").hide();
        $("#addStyle2_3").show();
        $("#addStyle1_3_1").removeClass("item_current");
        $("#addStyle1_3_2").addClass("item_current");
        $("#addStyle1_3_2").css("width","50%");
        $("#addStyle2_3 .uiproduct_form_search").show();
        $("#goods_shownumber").attr("disabled",true);
    }
    var selectBI = function(){
        isBISort = true;
        $("#addStyle1_3_1").hide();
        $("#addStyle1_3_2").removeClass("item_current");
        $("#addStyle1_3_2").css("width","100%");
        $("#addStyle1_3").hide();
        //$("#selectsList2_3").hide();
        //$("#commodList1_3").show();
        $("#addStyle2_3 .uiproduct_form_search").hide();
        $("#addStyle2_3").show();
        $("#goods_shownumber").removeAttr("disabled");
    }
    var getIndexFromSelected = function(skuids){
        if(skuids==null) return;
        for(var i in pageInfo.selectedList){
            if(skuids==pageInfo.selectedList[i].sSkuId){
                return i;
            }
        }
        return -1;
    }

    var Goods = function () {
        /**
         * 
         * @param data
         */
        var resetData = function (data) {
            //
            if (!data.isCal) {
                data.dwDiscount = Math.round(data.dwDiscount) / 10;
                data.isCal = true;
            }

            //  dwSkuState=1 0   class="hide_discount"
            if (~~data.dwSkuState) {
                data.cls = 'soldout_end hide_discount';
                data.outMask = "block";
            } else {
                data.cls = 'hide_discount';
                data.outMask = "none";
            }
        };
        //
        var renderTpl = function (data, tpl) {
            if(!data.sImg) data.sImg = data.sImg200x200;
            for (var attr in data) {
                tpl = tpl.replace(new RegExp("{#" + attr + "#}", "gm"), data[attr]);
            }
            var display="show";
            if(isBISort || data.is_added){
                display = "hide";
            }
            tpl = tpl.replace(new RegExp("{#display#}", "g"), display);
            tpl = tpl.replace(new RegExp("{#show_has_added#}", "g"), data.is_added && !isBISort ? "" : "hide");
            return tpl;
        };
        /**
         * 
         * @param type [string]
         */
        var renderList = function () {
            var _data = pageInfo.goodsList;
            var $query = $('#commodList1_3');
            var html = '';
            var pageIndex = _currPage * _pageSize;

            for (var i = pageIndex; i < _data.length && i < pageIndex + _pageSize; i++) {
                html += renderTpl(_data[i], tpl);
            }
            $query.html(html);
            pageshow();
        };
        /**
         * 
         */
        var renderList2=function(){
            var _data = pageInfo.selectedList;
            var html = '';
            for (var i = 0; i < _data.length; i++) {
                html +=  renderTpl(_data[i], tpl_1);
            }
            $('#selectsList2_3')
                .show()
                .html(html)
                    .find(".setTop").eq(0)
                        .html("")
                        .addClass("words");
        }
        /**
         * 
         */
        var next = function () {
            _currPage++;

            //
            if (!_is_searching && _currPage + 1 >= _maxPage && !pageInfo.load_finish) {
                getProductList(pageInfo.actid, pageInfo.areaid, _curr_load_page + 1).fail(renderList);
            } else {
                if (_currPage > _maxPage) {
                    _currPage = _maxPage;
                }
                renderList();
            }
        };

        /**
         * 
         */
        var prev = function () {
            if(_currPage - 1 >= 0) {
                _currPage--;
            }
            renderList();
        };

        /**
         * 
         */
        var pageshow = function () {
            $('#uiproduct_paginator3 a').removeClass('disabled');
            if (_currPage <= 0) {
                $('#uiproduct_paginator3 .prev3').addClass('disabled');
            }
            if (_currPage >= _maxPage && (pageInfo.load_finish || _is_searching)) {
                $('#uiproduct_paginator3 .next3').addClass('disabled');
            }
        };
        /**
         *  
         * @param sSkuId
         * @param self
         */
        var add = function (sSkuId, self) {
            for(var i = 0, l = pageInfo.goodsList.length; i < l; i++){
                var item = pageInfo.goodsList[i];
                if (item.sSkuId == sSkuId) {
                    item.index = i;
                    item.is_added = true;
                    self && $(self).hide()
                                   .prevAll('.has_added').removeClass('hide');
                    pageInfo.selectedList.push(item);

                    Fun.alertLoading("");
                    return;
                }
            }
        };
        var del = function (id) {
            for(var i = 0, l = pageInfo.selectedList.length; i < l; i++){
                var item = pageInfo.selectedList[i];
                if (item.sSkuId == id) {
                    var goods = pageInfo.goodsList[item.index];
                     goods && delete goods.is_added;
                    pageInfo.selectedList.splice(i, 1);

                    var $item = $('#commodList1_3').find('[data-sskuid=' + id + ']');
                    if($item.length){
                        $item .show()
                            .prevAll('.has_added').addClass('hide');
                    }

                    return;
                }
            }
        };
        var setTop = function (id) {
            var topOne = null;
            for (var i = 0; i < pageInfo.selectedList.length; i++) {
                if (pageInfo.selectedList[i].sSkuId == id) {
                    topOne = pageInfo.selectedList.splice(i, 1);
                }
            }
            topOne&&pageInfo.selectedList.unshift(topOne[0]);
            $("#selectsList2_3").find(".setTop").html("");
            $("#selectsList2_3").find(".setTop").removeClass("words");
            $("#selectsList2_3").find(".setTop").eq(0).addClass("words");
            $("#selectsList2_3").find(".setTop").eq(0).html("");
        }
        return {
            renderList: renderList,
            renderList2: renderList2,
            renderTpl: renderTpl,
            add:add,
            del:del,
            setTop:setTop,
            resetData: resetData,
            next: next,
            prev: prev
        }
    }
    var g = Goods();

    exports.init = function () {
        var materiaid = window.__materiaid;

        $(document).on('show.cpanel', function (e, dom, type, data) {
            if (type == "goods_list") {
                if(!isNaN(materiaid)) {
                    $setting_panel.hide();
                    $setting_panel_for_act.show();
                    Event.initForActivity(materiaid);
                    resetInputsForActivity(dom);
                    return;
                }
                resetInputs(dom, type, data);
                if($(dom).find(".mod_filter").is(":visible")){
                    $("#showGoodslistTop").prop("checked",'true');
                }else{
                    $("#showGoodslistTop").removeAttr("checked");
                }
            }
        });

        if(isNaN(materiaid)){
            Event.init();
        }
    };
});;define("fileuploader",function(require, exports, module) {
/**
 * http://github.com/valums/file-uploader
 * 
 * Multiple file upload component with progress-bar, drag-and-drop. 
 *  2010 Andrew Valums ( andrew(at)valums.com ) 
 * 
 * Licensed under GNU GPL 2 or later, see license.txt.
 */    

//
// Helper functions
//

var qq = qq || {};

/**
 * Adds all missing properties from second obj to first obj
 */ 
qq.extend = function(first, second){
    for (var prop in second){
        first[prop] = second[prop];
    }
};  

/**
 * Searches for a given element in the array, returns -1 if it is not present.
 * @param {Number} [from] The index at which to begin the search
 */
qq.indexOf = function(arr, elt, from){
    if (arr.indexOf) return arr.indexOf(elt, from);
    
    from = from || 0;
    var len = arr.length;    
    
    if (from < 0) from += len;  

    for (; from < len; from++){  
        if (from in arr && arr[from] === elt){  
            return from;
        }
    }  
    return -1;  
}; 
    
qq.getUniqueId = (function(){
    var id = 0;
    return function(){ return id++; };
})();

//
// Events

qq.attach = function(element, type, fn){
    if (element.addEventListener){
        element.addEventListener(type, fn, false);
    } else if (element.attachEvent){
        element.attachEvent('on' + type, fn);
    }
};
qq.detach = function(element, type, fn){
    if (element.removeEventListener){
        element.removeEventListener(type, fn, false);
    } else if (element.attachEvent){
        element.detachEvent('on' + type, fn);
    }
};

qq.preventDefault = function(e){
    if (e.preventDefault){
        e.preventDefault();
    } else{
        e.returnValue = false;
    }
};

//
// Node manipulations

/**
 * Insert node a before node b.
 */
qq.insertBefore = function(a, b){
    b.parentNode.insertBefore(a, b);
};
qq.remove = function(element){
    element.parentNode.removeChild(element);
};

qq.contains = function(parent, descendant){       
    // compareposition returns false in this case
    if (parent == descendant) return true;
    
    if (parent.contains){
        return parent.contains(descendant);
    } else {
        return !!(descendant.compareDocumentPosition(parent) & 8);
    }
};

/**
 * Creates and returns element from html string
 * Uses innerHTML to create an element
 */
qq.toElement = (function(){
    var div = document.createElement('div');
    return function(html){
        div.innerHTML = html;
        var element = div.firstChild;
        div.removeChild(element);
        return element;
    };
})();

//
// Node properties and attributes

/**
 * Sets styles for an element.
 * Fixes opacity in IE6-8.
 */
qq.css = function(element, styles){
    if (styles.opacity != null){
        if (typeof element.style.opacity != 'string' && typeof(element.filters) != 'undefined'){
            styles.filter = 'alpha(opacity=' + Math.round(100 * styles.opacity) + ')';
        }
    }
    qq.extend(element.style, styles);
};
qq.hasClass = function(element, name){
    var re = new RegExp('(^| )' + name + '( |$)');
    return re.test(element.className);
};
qq.addClass = function(element, name){
    if (!qq.hasClass(element, name)){
        element.className += ' ' + name;
    }
};
qq.removeClass = function(element, name){
    var re = new RegExp('(^| )' + name + '( |$)');
    element.className = element.className.replace(re, ' ').replace(/^\s+|\s+$/g, "");
};
qq.setText = function(element, text){
    element.innerText = text;
    element.textContent = text;
};

//
// Selecting elements

qq.children = function(element){
    var children = [],
    child = element.firstChild;

    while (child){
        if (child.nodeType == 1){
            children.push(child);
        }
        child = child.nextSibling;
    }

    return children;
};

qq.getByClass = function(element, className){
    if (element.querySelectorAll){
        return element.querySelectorAll('.' + className);
    }

    var result = [];
    var candidates = element.getElementsByTagName("*");
    var len = candidates.length;

    for (var i = 0; i < len; i++){
        if (qq.hasClass(candidates[i], className)){
            result.push(candidates[i]);
        }
    }
    return result;
};

/**
 * obj2url() takes a json-object as argument and generates
 * a querystring. pretty much like jQuery.param()
 * 
 * how to use:
 *
 *    `qq.obj2url({a:'b',c:'d'},'http://any.url/upload?otherParam=value');`
 *
 * will result in:
 *
 *    `http://any.url/upload?otherParam=value&a=b&c=d`
 *
 * @param  Object JSON-Object
 * @param  String current querystring-part
 * @return String encoded querystring
 */
qq.obj2url = function(obj, temp, prefixDone){
    var uristrings = [],
        prefix = '&',
        add = function(nextObj, i){
            var nextTemp = temp 
                ? (/\[\]$/.test(temp)) // prevent double-encoding
                   ? temp
                   : temp+'['+i+']'
                : i;
            if ((nextTemp != 'undefined') && (i != 'undefined')) {  
                uristrings.push(
                    (typeof nextObj === 'object') 
                        ? qq.obj2url(nextObj, nextTemp, true)
                        : (Object.prototype.toString.call(nextObj) === '[object Function]')
                            ? encodeURIComponent(nextTemp) + '=' + encodeURIComponent(nextObj())
                            : encodeURIComponent(nextTemp) + '=' + encodeURIComponent(nextObj)                                                          
                );
            }
        }; 

    if (!prefixDone && temp) {
      prefix = (/\?/.test(temp)) ? (/\?$/.test(temp)) ? '' : '&' : '?';
      uristrings.push(temp);
      uristrings.push(qq.obj2url(obj));
    } else if ((Object.prototype.toString.call(obj) === '[object Array]') && (typeof obj != 'undefined') ) {
        // we wont use a for-in-loop on an array (performance)
        for (var i = 0, len = obj.length; i < len; ++i){
            add(obj[i], i);
        }
    } else if ((typeof obj != 'undefined') && (obj !== null) && (typeof obj === "object")){
        // for anything else but a scalar, we will use for-in-loop
        for (var i in obj){
            add(obj[i], i);
        }
    } else {
        uristrings.push(encodeURIComponent(temp) + '=' + encodeURIComponent(obj));
    }

    return uristrings.join(prefix)
                     .replace(/^&/, '')
                     .replace(/%20/g, '+'); 
};

//
//
// Uploader Classes
//
//

var qq = qq || {};
    
/**
 * Creates upload button, validates upload, but doesn't create file list or dd. 
 */
qq.FileUploaderBasic = function(o){
    this._options = {
        // set to true to see the server response
        debug: false,
        action: '/server/upload',
        params: {},
        button: null,
        multiple: true,
        maxConnections: 3,
        // validation        
        allowedExtensions: [],               
        sizeLimit: 0,   
        minSizeLimit: 0,                             
        // events
        // return false to cancel submit
        onSubmit: function(id, fileName){},
        onProgress: function(id, fileName, loaded, total){},
        onComplete: function(id, fileName, responseJSON){},
        onCancel: function(id, fileName){},
        // messages                
        messages: {
            typeError: "{file} .  {extensions} .",
            sizeError: "{file} , {sizeLimit} !.",
            minSizeError: "{file} ,  {minSizeLimit}.",
            emptyError: "{file} , .",
            onLeave: ", ."            
        },
        showMessage: function(message){
            alert(message);
        }               
    };
    qq.extend(this._options, o);
        
    // number of files being uploaded
    this._filesInProgress = 0;
    this._handler = this._createUploadHandler(); 
    
    if (this._options.button){ 
        this._button = this._createUploadButton(this._options.button);
    }
                        
    this._preventLeaveInProgress();         
};
   
qq.FileUploaderBasic.prototype = {
    setParams: function(params){
        this._options.params = params;
    },
    getInProgress: function(){
        return this._filesInProgress;         
    },
    _createUploadButton: function(element){
        var self = this;
        
        return new qq.UploadButton({
            element: element,
            multiple: this._options.multiple && qq.UploadHandlerXhr.isSupported(),
            onChange: function(input){
                self._onInputChange(input);
            }        
        });           
    },    
    _createUploadHandler: function(){
        var self = this,
            handlerClass;        
        
        if(qq.UploadHandlerXhr.isSupported()){           
            handlerClass = 'UploadHandlerXhr';                        
        } else {
            handlerClass = 'UploadHandlerForm';
        }

        var handler = new qq[handlerClass]({
            debug: this._options.debug,
            action: this._options.action,         
            maxConnections: this._options.maxConnections,   
            onProgress: function(id, fileName, loaded, total){                
                self._onProgress(id, fileName, loaded, total);
                self._options.onProgress(id, fileName, loaded, total);                    
            },            
            onComplete: function(id, fileName, result){
                self._onComplete(id, fileName, result);
                self._options.onComplete(id, fileName, result);
            },
            onCancel: function(id, fileName){
                self._onCancel(id, fileName);
                self._options.onCancel(id, fileName);
            }
        });

        return handler;
    },    
    _preventLeaveInProgress: function(){
        var self = this;
        
        qq.attach(window, 'beforeunload', function(e){
            if (!self._filesInProgress){return;}
            
            var e = e || window.event;
            // for ie, ff
            e.returnValue = self._options.messages.onLeave;
            // for webkit
            return self._options.messages.onLeave;             
        });        
    },    
    _onSubmit: function(id, fileName){
        this._filesInProgress++;  
    },
    _onProgress: function(id, fileName, loaded, total){        
    },
    _onComplete: function(id, fileName, result){
        this._filesInProgress--;                 
        if (result.error){
            this._options.showMessage(result.error);
        }             
    },
    _onCancel: function(id, fileName){
        this._filesInProgress--;        
    },
    _onInputChange: function(input){
        if (this._handler instanceof qq.UploadHandlerXhr){                
            this._uploadFileList(input.files);                   
        } else {             
            if (this._validateFile(input)){                
                this._uploadFile(input);                                    
            }                      
        }               
        this._button.reset();   
    },  
    _uploadFileList: function(files){
        for (var i=0; i<files.length; i++){
            if ( !this._validateFile(files[i])){
                return;
            }            
        }
        
        for (var i=0; i<files.length; i++){
            this._uploadFile(files[i]);        
        }        
    },       
    _uploadFile: function(fileContainer){      
        var id = this._handler.add(fileContainer);
        var fileName = this._handler.getName(id);
        
        if (this._options.onSubmit(id, fileName) !== false){
            this._onSubmit(id, fileName);
            this._handler.upload(id, this._options.params);
        }
    },      
    _validateFile: function(file){
        var name, size;
        
        if (file.value){
            // it is a file input            
            // get input value and remove path to normalize
            name = file.value.replace(/.*(\/|\\)/, "");
        } else {
            // fix missing properties in Safari
            name = file.fileName != null ? file.fileName : file.name;
            size = file.fileSize != null ? file.fileSize : file.size;
        }
                    
        if (! this._isAllowedExtension(name)){            
            this._error('typeError', name);
            return false;
            
        } else if (size === 0){            
            this._error('emptyError', name);
            return false;
                                                     
        } else if (size && this._options.sizeLimit && size > this._options.sizeLimit){            
            this._error('sizeError', name);
            return false;
                        
        } else if (size && size < this._options.minSizeLimit){
            this._error('minSizeError', name);
            return false;            
        }
        
        return true;                
    },
    _error: function(code, fileName){
        var message = this._options.messages[code];        
        function r(name, replacement){ message = message.replace(name, replacement); }
        
        r('{file}', this._formatFileName(fileName));        
        r('{extensions}', this._options.allowedExtensions.join(', '));
        r('{sizeLimit}', this._formatSize(this._options.sizeLimit));
        r('{minSizeLimit}', this._formatSize(this._options.minSizeLimit));
        
        this._options.showMessage(message);                
    },
    _formatFileName: function(name){
        if (name.length > 33){
            name = name.slice(0, 19) + '...' + name.slice(-13);    
        }
        return name;
    },
    _isAllowedExtension: function(fileName){
        var ext = (-1 !== fileName.indexOf('.')) ? fileName.replace(/.*[.]/, '').toLowerCase() : '';
        var allowed = this._options.allowedExtensions;
        
        if (!allowed.length){return true;}        
        
        for (var i=0; i<allowed.length; i++){
            if (allowed[i].toLowerCase() == ext){ return true;}    
        }
        
        return false;
    },    
    _formatSize: function(bytes){
        var i = -1;                                    
        do {
            bytes = bytes / 1024;
            i++;  
        } while (bytes > 99);
        
        return Math.max(bytes, 0.1).toFixed(1) + ['kB', 'MB', 'GB', 'TB', 'PB', 'EB'][i];          
    }
};
    
       
/**
 * Class that creates upload widget with drag-and-drop and file list
 * @inherits qq.FileUploaderBasic
 */
qq.FileUploader = function(o){
    // call parent constructor
    qq.FileUploaderBasic.apply(this, arguments);
    
    // additional options    
    qq.extend(this._options, {
        element: null,
        // if set, will be used instead of qq-upload-list in template
        listElement: null,
                
        template: '<div class="qq-uploader">' + 
                '<div class="qq-upload-drop-area"><span></span></div>' +
                '<div class="qq-upload-button"></div>' +
                '<ul class="qq-upload-list"></ul>' + 
             '</div>',

        // template for one item in file list
        fileTemplate: '<li>' +
                '<span class="qq-upload-file"></span>' +
                '<span class="qq-upload-spinner"></span>' +
                '<span class="qq-upload-size"></span>' +
                '<a class="qq-upload-cancel" href="#"></a>' +
                '<span class="qq-upload-failed-text"></span>' +
            '</li>',        
        
        classes: {
            // used to get elements from templates
            button: 'qq-upload-button',
            drop: 'qq-upload-drop-area',
            dropActive: 'qq-upload-drop-area-active',
            list: 'qq-upload-list',
                        
            file: 'qq-upload-file',
            spinner: 'qq-upload-spinner',
            size: 'qq-upload-size',
            cancel: 'qq-upload-cancel',

            // added to list item when upload completes
            // used in css to hide progress spinner
            success: 'qq-upload-success',
            fail: 'qq-upload-fail'
        }
    });
    // overwrite options with user supplied    
    qq.extend(this._options, o);       

    this._element = this._options.element;
    this._element.innerHTML = this._options.template;        
    this._listElement = this._options.listElement || this._find(this._element, 'list');
    
    this._classes = this._options.classes;
        
    this._button = this._createUploadButton(this._find(this._element, 'button'));        
    
    this._bindCancelEvent();
    this._setupDragDrop();
};

// inherit from Basic Uploader
qq.extend(qq.FileUploader.prototype, qq.FileUploaderBasic.prototype);

qq.extend(qq.FileUploader.prototype, {
    /**
     * Gets one of the elements listed in this._options.classes
     **/
    _find: function(parent, type){                                
        var element = qq.getByClass(parent, this._options.classes[type])[0];        
        if (!element){
            throw new Error('element not found ' + type);
        }
        
        return element;
    },
    _setupDragDrop: function(){
        var self = this,
            dropArea = this._find(this._element, 'drop');                        

        var dz = new qq.UploadDropZone({
            element: dropArea,
            onEnter: function(e){
                qq.addClass(dropArea, self._classes.dropActive);
                e.stopPropagation();
            },
            onLeave: function(e){
                e.stopPropagation();
            },
            onLeaveNotDescendants: function(e){
                qq.removeClass(dropArea, self._classes.dropActive);  
            },
            onDrop: function(e){
                dropArea.style.display = 'none';
                qq.removeClass(dropArea, self._classes.dropActive);
                self._uploadFileList(e.dataTransfer.files);    
            }
        });
                
        dropArea.style.display = 'none';

        qq.attach(document, 'dragenter', function(e){     
            if (!dz._isValidFileDrag(e)) return; 
            
            dropArea.style.display = 'block';            
        });                 
        qq.attach(document, 'dragleave', function(e){
            if (!dz._isValidFileDrag(e)) return;            
            
            var relatedTarget = document.elementFromPoint(e.clientX, e.clientY);
            // only fire when leaving document out
            if ( ! relatedTarget || relatedTarget.nodeName == "HTML"){               
                dropArea.style.display = 'none';                                            
            }
        });                
    },
    _onSubmit: function(id, fileName){
        qq.FileUploaderBasic.prototype._onSubmit.apply(this, arguments);
        this._addToList(id, fileName);  
    },
    _onProgress: function(id, fileName, loaded, total){
        qq.FileUploaderBasic.prototype._onProgress.apply(this, arguments);

        var item = this._getItemByFileId(id);
        var size = this._find(item, 'size');
        size.style.display = 'inline';
        
        var text; 
        if (loaded != total){
            text = Math.round(loaded / total * 100) + '% from ' + this._formatSize(total);
        } else {                                   
            text = this._formatSize(total);
        }          
        
        qq.setText(size, text);         
    },
    _onComplete: function(id, fileName, result){
        qq.FileUploaderBasic.prototype._onComplete.apply(this, arguments);

        // mark completed
        var item = this._getItemByFileId(id);                
        qq.remove(this._find(item, 'cancel'));
        qq.remove(this._find(item, 'spinner'));
        
        if (result.success){
            qq.addClass(item, this._classes.success);    
        } else {
            qq.addClass(item, this._classes.fail);
        }         
    },
    _addToList: function(id, fileName){
        var item = qq.toElement(this._options.fileTemplate);                
        item.qqFileId = id;

        var fileElement = this._find(item, 'file');        
        qq.setText(fileElement, this._formatFileName(fileName));
        this._find(item, 'size').style.display = 'none';        

        this._listElement.appendChild(item);
    },
    _getItemByFileId: function(id){
        var item = this._listElement.firstChild;        
        
        // there can't be txt nodes in dynamically created list
        // and we can  use nextSibling
        while (item){            
            if (item.qqFileId == id) return item;            
            item = item.nextSibling;
        }          
    },
    /**
     * delegate click event for cancel link 
     **/
    _bindCancelEvent: function(){
        var self = this,
            list = this._listElement;            
        
        qq.attach(list, 'click', function(e){            
            e = e || window.event;
            var target = e.target || e.srcElement;
            
            if (qq.hasClass(target, self._classes.cancel)){                
                qq.preventDefault(e);
               
                var item = target.parentNode;
                self._handler.cancel(item.qqFileId);
                qq.remove(item);
            }
        });
    }    
});
    
qq.UploadDropZone = function(o){
    this._options = {
        element: null,  
        onEnter: function(e){},
        onLeave: function(e){},  
        // is not fired when leaving element by hovering descendants   
        onLeaveNotDescendants: function(e){},   
        onDrop: function(e){}                       
    };
    qq.extend(this._options, o); 
    
    this._element = this._options.element;
    
    this._disableDropOutside();
    this._attachEvents();   
};

qq.UploadDropZone.prototype = {
    _disableDropOutside: function(e){
        // run only once for all instances
        if (!qq.UploadDropZone.dropOutsideDisabled ){

            qq.attach(document, 'dragover', function(e){
                if (e.dataTransfer){
                    e.dataTransfer.dropEffect = 'none';
                    e.preventDefault(); 
                }           
            });
            
            qq.UploadDropZone.dropOutsideDisabled = true; 
        }        
    },
    _attachEvents: function(){
        var self = this;              
                  
        qq.attach(self._element, 'dragover', function(e){
            if (!self._isValidFileDrag(e)) return;
            
            var effect = e.dataTransfer.effectAllowed;
            if (effect == 'move' || effect == 'linkMove'){
                e.dataTransfer.dropEffect = 'move'; // for FF (only move allowed)    
            } else {                    
                e.dataTransfer.dropEffect = 'copy'; // for Chrome
            }
                                                     
            e.stopPropagation();
            e.preventDefault();                                                                    
        });
        
        qq.attach(self._element, 'dragenter', function(e){
            if (!self._isValidFileDrag(e)) return;
                        
            self._options.onEnter(e);
        });
        
        qq.attach(self._element, 'dragleave', function(e){
            if (!self._isValidFileDrag(e)) return;
            
            self._options.onLeave(e);
            
            var relatedTarget = document.elementFromPoint(e.clientX, e.clientY);                      
            // do not fire when moving a mouse over a descendant
            if (qq.contains(this, relatedTarget)) return;
                        
            self._options.onLeaveNotDescendants(e); 
        });
                
        qq.attach(self._element, 'drop', function(e){
            if (!self._isValidFileDrag(e)) return;
            
            e.preventDefault();
            self._options.onDrop(e);
        });          
    },
    _isValidFileDrag: function(e){
        var dt = e.dataTransfer,
            // do not check dt.types.contains in webkit, because it crashes safari 4            
            isWebkit = navigator.userAgent.indexOf("AppleWebKit") > -1;                        

        // dt.effectAllowed is none in Safari 5
        // dt.types.contains check is for firefox            
        return dt && dt.effectAllowed != 'none' && 
            (dt.files || (!isWebkit && dt.types.contains && dt.types.contains('Files')));
        
    }        
}; 

qq.UploadButton = function(o){
    this._options = {
        element: null,  
        // if set to true adds multiple attribute to file input      
        multiple: false,
        // name attribute of file input
        name: 'file',
        onChange: function(input){},
        hoverClass: 'qq-upload-button-hover',
        focusClass: 'qq-upload-button-focus'                       
    };
    
    qq.extend(this._options, o);
        
    this._element = this._options.element;
    
    // make button suitable container for input
    qq.css(this._element, {
        position: 'relative',
        overflow: 'hidden',
        // Make sure browse button is in the right side
        // in Internet Explorer
        direction: 'ltr'
    });   
    
    this._input = this._createInput();
};

qq.UploadButton.prototype = {
    /* returns file input element */    
    getInput: function(){
        return this._input;
    },
    /* cleans/recreates the file input */
    reset: function(){
        if (this._input.parentNode){
            qq.remove(this._input);    
        }                
        
        qq.removeClass(this._element, this._options.focusClass);
        this._input = this._createInput();
    },    
    _createInput: function(){                
        var input = document.createElement("input");
        
        if (this._options.multiple){
            input.setAttribute("multiple", "multiple");
        }
                
        input.setAttribute("type", "file");
        input.setAttribute("name", this._options.name);
        
        qq.css(input, {
            position: 'absolute',
            // in Opera only 'browse' button
            // is clickable and it is located at
            // the right side of the input
            right: 0,
            top: 0,
            fontFamily: 'Arial',
            // 4 persons reported this, the max values that worked for them were 243, 236, 236, 118
            fontSize: '118px',
            margin: 0,
            padding: 0,
            cursor: 'pointer',
            opacity: 0
        });
        
        this._element.appendChild(input);

        var self = this;
        qq.attach(input, 'change', function(){
            self._options.onChange(input);
        });
                
        qq.attach(input, 'mouseover', function(){
            qq.addClass(self._element, self._options.hoverClass);
        });
        qq.attach(input, 'mouseout', function(){
            qq.removeClass(self._element, self._options.hoverClass);
        });
        qq.attach(input, 'focus', function(){
            qq.addClass(self._element, self._options.focusClass);
        });
        qq.attach(input, 'blur', function(){
            qq.removeClass(self._element, self._options.focusClass);
        });

        // IE and Opera, unfortunately have 2 tab stops on file input
        // which is unacceptable in our case, disable keyboard access
        if (window.attachEvent){
            // it is IE or Opera
            input.setAttribute('tabIndex', "-1");
        }

        return input;            
    }        
};

/**
 * Class for uploading files, uploading itself is handled by child classes
 */
qq.UploadHandlerAbstract = function(o){
    this._options = {
        debug: false,
        action: '/upload.php',
        // maximum number of concurrent uploads        
        maxConnections: 999,
        onProgress: function(id, fileName, loaded, total){},
        onComplete: function(id, fileName, response){},
        onCancel: function(id, fileName){}
    };
    qq.extend(this._options, o);    
    
    this._queue = [];
    // params for files in queue
    this._params = [];
};
qq.UploadHandlerAbstract.prototype = {
    log: function(str){
        if (this._options.debug && window.console) console.log('[uploader] ' + str);        
    },
    /**
     * Adds file or file input to the queue
     * @returns id
     **/    
    add: function(file){},
    /**
     * Sends the file identified by id and additional query params to the server
     */
    upload: function(id, params){
        var len = this._queue.push(id);

        var copy = {};        
        qq.extend(copy, params);
        this._params[id] = copy;        
                
        // if too many active uploads, wait...
        if (len <= this._options.maxConnections){               
            this._upload(id, this._params[id]);
        }
    },
    /**
     * Cancels file upload by id
     */
    cancel: function(id){
        this._cancel(id);
        this._dequeue(id);
    },
    /**
     * Cancells all uploads
     */
    cancelAll: function(){
        for (var i=0; i<this._queue.length; i++){
            this._cancel(this._queue[i]);
        }
        this._queue = [];
    },
    /**
     * Returns name of the file identified by id
     */
    getName: function(id){},
    /**
     * Returns size of the file identified by id
     */          
    getSize: function(id){},
    /**
     * Returns id of files being uploaded or
     * waiting for their turn
     */
    getQueue: function(){
        return this._queue;
    },
    /**
     * Actual upload method
     */
    _upload: function(id){},
    /**
     * Actual cancel method
     */
    _cancel: function(id){},     
    /**
     * Removes element from queue, starts upload of next
     */
    _dequeue: function(id){
        var i = qq.indexOf(this._queue, id);
        this._queue.splice(i, 1);
                
        var max = this._options.maxConnections;
        
        if (this._queue.length >= max && i < max){
            var nextId = this._queue[max-1];
            this._upload(nextId, this._params[nextId]);
        }
    }        
};

/**
 * Class for uploading files using form and iframe
 * @inherits qq.UploadHandlerAbstract
 */
qq.UploadHandlerForm = function(o){
    qq.UploadHandlerAbstract.apply(this, arguments);
       
    this._inputs = {};
};
// @inherits qq.UploadHandlerAbstract
qq.extend(qq.UploadHandlerForm.prototype, qq.UploadHandlerAbstract.prototype);

qq.extend(qq.UploadHandlerForm.prototype, {
    add: function(fileInput){
        fileInput.setAttribute('name', 'qqfile');
        var id = 'qq-upload-handler-iframe' + qq.getUniqueId();       
        
        this._inputs[id] = fileInput;
        
        // remove file input from DOM
        if (fileInput.parentNode){
            qq.remove(fileInput);
        }
                
        return id;
    },
    getName: function(id){
        // get input value and remove path to normalize
        return this._inputs[id].value.replace(/.*(\/|\\)/, "");
    },    
    _cancel: function(id){
        this._options.onCancel(id, this.getName(id));
        
        delete this._inputs[id];        

        var iframe = document.getElementById(id);
        if (iframe){
            // to cancel request set src to something else
            // we use src="javascript:false;" because it doesn't
            // trigger ie6 prompt on https
            iframe.setAttribute('src', 'javascript:false;');

            qq.remove(iframe);
        }
    },     
    _upload: function(id, params){                        
        var input = this._inputs[id];
        
        if (!input){
            throw new Error('file with passed id was not added, or already uploaded or cancelled');
        }                

        var fileName = this.getName(id);
                
        var iframe = this._createIframe(id);
        var form = this._createForm(iframe, params);
        form.appendChild(input);

        var self = this;
        this._attachLoadEvent(iframe, function(){                                 
            self.log('iframe loaded');
            
            var response = self._getIframeContentJSON(iframe);

            self._options.onComplete(id, fileName, response);
            self._dequeue(id);
            
            delete self._inputs[id];
            // timeout added to fix busy state in FF3.6
            setTimeout(function(){
                qq.remove(iframe);
            }, 1);
        });

        form.submit();        
        qq.remove(form);        
        
        return id;
    }, 
    _attachLoadEvent: function(iframe, callback){
        qq.attach(iframe, 'load', function(){
            // when we remove iframe from dom
            // the request stops, but in IE load
            // event fires
            if (!iframe.parentNode){
                return;
            }

            // fixing Opera 10.53
            if (iframe.contentDocument &&
                iframe.contentDocument.body &&
                iframe.contentDocument.body.innerHTML == "false"){
                // In Opera event is fired second time
                // when body.innerHTML changed from false
                // to server response approx. after 1 sec
                // when we upload file with iframe
                return;
            }

            callback();
        });
    },
    /**
     * Returns json object received by iframe from server.
     */
    _getIframeContentJSON: function(iframe){
        // iframe.contentWindow.document - for IE<7
        var doc = iframe.contentDocument ? iframe.contentDocument: iframe.contentWindow.document,
            response;
        
        this.log("converting iframe's innerHTML to JSON");
        this.log("innerHTML = " + doc.body.innerHTML);
                        
        try {
            response = eval("(" + doc.body.innerHTML + ")");
        } catch(err){
            response = {};
        }        

        return response;
    },
    /**
     * Creates iframe with unique name
     */
    _createIframe: function(id){
        // We can't use following code as the name attribute
        // won't be properly registered in IE6, and new window
        // on form submit will open
        // var iframe = document.createElement('iframe');
        // iframe.setAttribute('name', id);

        var iframe = qq.toElement('<iframe src="javascript:false;" name="' + id + '" />');
        // src="javascript:false;" removes ie6 prompt on https

        iframe.setAttribute('id', id);

        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        return iframe;
    },
    /**
     * Creates form, that will be submitted to iframe
     */
    _createForm: function(iframe, params){
        // We can't use the following code in IE6
        // var form = document.createElement('form');
        // form.setAttribute('method', 'post');
        // form.setAttribute('enctype', 'multipart/form-data');
        // Because in this case file won't be attached to request
        var form = qq.toElement('<form method="post" enctype="multipart/form-data"></form>');

        var queryString = qq.obj2url(params, this._options.action);

        form.setAttribute('action', queryString);
        form.setAttribute('target', iframe.name);
        form.style.display = 'none';
        document.body.appendChild(form);

        return form;
    }
});

/**
 * Class for uploading files using xhr
 * @inherits qq.UploadHandlerAbstract
 */
qq.UploadHandlerXhr = function(o){
    qq.UploadHandlerAbstract.apply(this, arguments);

    this._files = [];
    this._xhrs = [];
    
    // current loaded size in bytes for each file 
    this._loaded = [];
};

// static method
qq.UploadHandlerXhr.isSupported = function(){
    var input = document.createElement('input');
    input.type = 'file';        
    
    return (
        'multiple' in input &&
        typeof File != "undefined" &&
        typeof (new XMLHttpRequest()).upload != "undefined" );       
};

// @inherits qq.UploadHandlerAbstract
qq.extend(qq.UploadHandlerXhr.prototype, qq.UploadHandlerAbstract.prototype)

qq.extend(qq.UploadHandlerXhr.prototype, {
    /**
     * Adds file to the queue
     * Returns id to use with upload, cancel
     **/    
    add: function(file){
        if (!(file instanceof File)){
            throw new Error('Passed obj in not a File (in qq.UploadHandlerXhr)');
        }
                
        return this._files.push(file) - 1;        
    },
    getName: function(id){        
        var file = this._files[id];
        // fix missing name in Safari 4
        return file.fileName != null ? file.fileName : file.name;       
    },
    getSize: function(id){
        var file = this._files[id];
        return file.fileSize != null ? file.fileSize : file.size;
    },    
    /**
     * Returns uploaded bytes for file identified by id 
     */    
    getLoaded: function(id){
        return this._loaded[id] || 0; 
    },
    /**
     * Sends the file identified by id and additional query params to the server
     * @param {Object} params name-value string pairs
     */    
    _upload: function(id, params){
        var file = this._files[id],
            name = this.getName(id),
            size = this.getSize(id);
                
        this._loaded[id] = 0;
                                
        var xhr = this._xhrs[id] = new XMLHttpRequest();
        var self = this;
                                        
        xhr.upload.onprogress = function(e){
            if (e.lengthComputable){
                self._loaded[id] = e.loaded;
                self._options.onProgress(id, name, e.loaded, e.total);
            }
        };

        xhr.onreadystatechange = function(){            
            if (xhr.readyState == 4){
                self._onComplete(id, xhr);                    
            }
        };

        // build query string
        params = params || {};
        params['qqfile'] = name;
        var queryString = qq.obj2url(params, this._options.action);

        xhr.open("POST", queryString, true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.setRequestHeader("X-File-Name", encodeURIComponent(name));
        xhr.setRequestHeader("Content-Type", "application/octet-stream");
        xhr.send(file);
    },
    _onComplete: function(id, xhr){
        // the request was aborted/cancelled
        if (!this._files[id]) return;
        
        var name = this.getName(id);
        var size = this.getSize(id);
        
        this._options.onProgress(id, name, size, size);
                
        if (xhr.status == 200){
            this.log("xhr - server response received");
            this.log("responseText = " + xhr.responseText);
                        
            var response;
                    
            try {
                response = eval("(" + xhr.responseText + ")");
            } catch(err){
                response = {};
            }
            
            this._options.onComplete(id, name, response);
                        
        } else {                   
            this._options.onComplete(id, name, {});
        }
                
        this._files[id] = null;
        this._xhrs[id] = null;    
        this._dequeue(id);                    
    },
    _cancel: function(id){
        this._options.onCancel(id, this.getName(id));
        
        this._files[id] = null;
        
        if (this._xhrs[id]){
            this._xhrs[id].abort();
            this._xhrs[id] = null;                                   
        }
    }
});
	return qq;
});;define("mmrp.mod.uploader",function(require, exports, module) {  
    
    var $ = require('jquery'),
    	c = require('mmrp.config.user'),
    	Fun = require('mmrp.func'),
    	qq = require('fileuploader');
    
   	
   	/**
	 * 
	 * ID
	 * 
	 * 
	 */
	exports.createUploader = function(id,path,callback){
		var uploader = new qq.FileUploader({
			element: document.getElementById(id),
			action: c.root +'fileuploader.php?g_tk='+Fun.$getToken(),
			allowedExtensions: ['jpg', 'jpeg', 'png', 'gif', 'swf'],
            template: '<div class="qq-uploader">' +
                '<div class="qq-content"><div class="qq-upload-drop-area"><div class="qq-upload-button"></div></div></div>' +
                // '' +
                '<ul class="qq-upload-list"></ul>' +
                '</div>',
			params:{
				folder:path,
				newname:true
			},
			onComplete: function(id, fileName, responseJSON){
				if (callback && typeof(callback) === "function") {  
			        callback(responseJSON);  
			    };
			}
		});
        return uploader;
	};
   	
    
})  ;define("mmrp.mod.coupons",function(require, exports, module) {  


    var $ = require('jquery'),
    	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
        ModList = require('mmrp.module.tablist'),
    	RestApi = require('mmrp.rest'),
        tablist = require('mmrp.module.tablist'),
        BoxEvent = require('mmrp.mod.box.events'),
        upload = require('mmrp.mod.uploader');
    	//loadPI = require('./jquery.pp.2014.marketbase_v2');
    require('jquery.cookie')($);
   	require('jquery.ui')($);

    var act_id = '';
    var actinfo_id = '';
    var id = '';
    var __prizedata = {};
    var _level = 0;

    var View = {
        initDialog: function(){

        },
        rest: function(){
            $('#J_coupons_info').html('');
            id = $('#js_class_name').val();
            var url = $('#' + id + ' .coupons_jd').attr('data-quanUrl');
            var coupons_id = $('#' + id + ' .coupons_jd').attr('data-couponsid');
            var coupons_level = $('#' + id + ' .coupons_jd').attr('data-level');
            var coupons_key = $('#' + id + ' .coupons_jd').attr('data-quankey');
            $('#J_coupons_id').val(coupons_id);
            $('#J_coupons_level').val(coupons_level);
            $('#J_coupons_url').val(url);
            $('#J_coupons_key').val(coupons_key);
            if(coupons_key){
                $('#J_Couponsgetinfo').trigger('click');
            }
        }
    }

    var Event = {
        init: function(){
            
        },
        initFunction: function(){
            $('#J_coupons_url').on('change', function(){
                var url = $(this).val();

                var key = Fun.getParam(url, 'key');
                var roleid = Fun.getParam(url,'roleId');
                $('#J_coupons_id').val(roleid);
                $('#J_coupons_level').val(key);
            });
            $('#J_saveCoupons').on('click', function(e){
                var id = $('#js_class_name').val();
                var coupons_id = $('#J_coupons_id').val();
                var coupons_level = $('#J_coupons_level').val();
                var coupons_key = $('#J_coupons_key').val();
                var url = $('#J_coupons_url').val();
                if(!coupons_id || !coupons_level){
                    alert('url');
                    return;
                }
                $('#' + id + ' .coupons_jd').attr('data-couponsid', coupons_id).attr('data-level', coupons_level).attr('data-quanUrl', url).attr('data-quankey', coupons_key);
                Fun.alert('');
            });
            $('#J_Couponsgetinfo').on('click', function(e){
                var key = $('#J_coupons_key').val();
                var url = '//wq.jd.com/mshop/QueryZyShopCoupon?batchkey=' + key + '&callback=checkZyCounponCbk&_t=' + Math.random()+"&g_tk="+Fun.$getToken();
                window.checkZyCounponCbk = function(data){
                    if(data.errcode == 0){
                        var info = data.data[0];
                        var html = info.name+"<br/>"+ info.quota + '' + info.discount+ "<br/>" + info.num + '<br />:<br />' + Fun.unix_to_datetime(info.beginTime,true) + '<br /><br />' + Fun.unix_to_datetime(info.endTime,true) + '<br />' + info.desc;
                        $('#J_coupons_info').html(html);
                    }else{
                        alert('');
                    }
                }

                $.ajax({
                    url:url,
                    type:'GET',
                    dataType:'jsonp',
                    success:function(data){
                        console.info(data);
                    }
                });
            });
        }
    }

	exports.init = function(){
        var _self = this;
        Event.initFunction();
       // View.initDialog();
        $(document).on('show.cpanel',function(e,dom,type,data){
            $box = dom.children(".js_box:first")
            if(data.type == 'mod_coupons_jd'){
                View.rest(dom);
                Event.init($box);
                /*Data.getBoxSelectedData(); 
                View.cpanelOpen($box);
                
                Event.init($box);*/
            }


        })
	};





}) ;define("mmrp.mod.couponspop",function(require, exports, module) {  


    var $ = require('jquery'),
    	Mustache = require('mustache'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
        ModList = require('mmrp.module.tablist'),
    	RestApi = require('mmrp.rest'),
        tablist = require('mmrp.module.tablist'),
        BoxEvent = require('mmrp.mod.box.events'),
        upload = require('mmrp.mod.uploader');
    require('jquery.cookie')($);
   	require('jquery.ui')($);

    var act_id = '';
    var actinfo_id = '';
    var id = '';
    var __prizedata = {};
    var _level = 0;
    var quanlist = [];
    var View = {
        initDialog: function(){

        },
        rest: function(){
            var id = $('#js_class_name').val();
            var info = $('#' + id + ' .coupons_pop').attr('data-couponshtml');

            if(info){
                $('#J_popquan_bindinfo').html(info); 
            }else{
                $('#J_popquan_bindinfo').html('');
            }
            $('#J_popquan_info').html('');
            var url = '//wq.jd.com/lottery/php/cgi/query_shop_coupon.php?g_tk='+Fun.$getToken();
            $.ajax({
                url:url,
                type:'GET',
                dataType:'jsonp',
                success:function(data){
                    var html = '';
                    if(data.retCode == 0){
                        var list = data.coupon_info;
                        quanlist = list;
                        if(list.length == 0){
                            alert('shop.jd.com!');
                            return;
                        }
                        for (var i = 0; i < list.length; i++) {
                            if($('.coupons_pop[data-couponsid="' +list[i].coupon_id+ '"]').length == 0){
                                html += '<option value="' + i + '">' + list[i].coupon_name + '</option>';
                            }
                        };
                        $('#J_popquan').html('<option value="-1"></option>' + html);
                    }else{
                        alert('');
                    }
                }
            });
        }
    }

    var Event = {
        init: function(){
           
        },
        initFunction: function(){
            $('#J_popquan').on('change', function(){
                var idx = $(this).val();
                var info = quanlist[idx];
                var html = ''+info.coupon_name+"<br/>"+ info.coupon_discount + "%<br/>" + info.coupon_amount + '<br />:<br />' + Fun.unix_to_datetime(info.take_coupon_begin_time) + '<br />:<br />' + Fun.unix_to_datetime(info.take_coupon_end_time);
                $('#J_popquan_info').html(html);

            });
            $('#J_bind_popquan').on('click', function(){
                var idx = $('#J_popquan').val();
                if(idx == -1){
                    alert('');
                    return;
                }
                var info = quanlist[idx];
                var id = $('#js_class_name').val();
                console.info(info);
                if(window.confirm('')){
                    $('#' + id + ' .coupons_pop').attr('data-couponsid',info.coupon_id);
                    $('#' + id + ' .coupons_pop').attr('data-couponshtml', $('#J_popquan_info').html());
                    $('#' + id + ' .coupons_pop').attr('data-venderid', info.vender_id);
                    $('#J_popquan_bindinfo').html($('#J_popquan_info').html());
                }
                
            });
        }
    }

	exports.init = function(){
        var _self = this;
        Event.initFunction();
       // View.initDialog();
        $(document).on('show.cpanel',function(e,dom,type,data){
            $box = dom.children(".js_box:first")
            if(data.type == 'mod_coupons_pop'){
                View.rest(dom);
                /*Data.getBoxSelectedData(); 
                View.cpanelOpen($box);
                
                Event.init($box);*/
            }


        })
	};





}) ;define("mmrp.mod.countdown",function(require, exports, module) {  


    var $ = require('jquery'),

    	Mustache = require('mustache'),
        datetimepicker = require('jquery.datetimepicker'),
    	Fun = require('mmrp.func'),
    	c = require('mmrp.config.user'),
    	BoxFun = require('mmrp.mod.box.func'),
    	LoadJs = require('mmrp.mod.loadjs'),
        ModList = require('mmrp.module.tablist'),
    	RestApi = require('mmrp.rest'),
        tablist = require('mmrp.module.tablist'),
        BoxEvent = require('mmrp.mod.box.events'),
        upload = require('mmrp.mod.uploader');
    	//loadPI = require('./jquery.pp.2014.marketbase_v2');
    require('jquery.cookie')($);
   	require('jquery.ui')($);

    var View = {
        initDialog: function(){

        },
        rest: function(){ 
            var _id = $('#js_class_name').val();
            var _date = $('#' + _id + ' .mod_countdown').attr('data-time');
            $('#J_countdown_time').val(_date);
        }
    }
    var Event = {
        init: function(){
            
        },
        initFunction: function(){
            $('#J_countdown_time').datetimepicker();
            $('#J_save_countdown_time').on('click', function(){
                var date = $('#J_countdown_time').val();
                var _id = $('#js_class_name').val();
                $('#' + _id + ' .mod_countdown').attr('data-time', date);
                Fun.alert('');
            });
        }
    }

	exports.init = function(){
        var _self = this;
        Event.initFunction();
       // View.initDialog();
        $(document).on('show.cpanel',function(e,dom,type,data){
            $box = dom.children(".js_box:first")
            if(data.type == 'mod_countdown'){
                View.rest(dom);
                Event.init($box);
                /*Data.getBoxSelectedData(); 
                View.cpanelOpen($box);
                
                Event.init($box);*/
            }


        })
	};





}) ;define("mmrp.mod.yuyue",function(require, exports, module) {  

    var $ = require('jquery');
    var Fun = require("mmrp.func");
    var Event = {
        init: function(){
            $('#J_saveyuyue').on('click', function(){
                    var id = $('#js_class_name').val();
                    var yuyue_id = $('#J_yuyue_id').val();
                    var success_info = $('#J_yuyue_successinfo').val();
                    if(!yuyue_id || !/^[0-9]+$/.test(yuyue_id)) {
                        Fun.alertLoading("",1500);
                        return;
                    }
                    if(!success_info){
                        Fun.alertLoading("",1500);
                        return;
                    }

                    $('#' + id + ' .mod_act_yuyue').attr('data-actid',yuyue_id).attr('data-success_info',success_info);
                    Fun.alert('');
            });
        },
        resetInfo:function(dom){
            $('#J_yuyue_id').val($(dom).find(".mod_act_yuyue").attr("data-actid")||'');
            $('#J_yuyue_successinfo').val($(dom).find(".mod_act_yuyue").attr("data-success_info")||'');
        }
    }

	exports.init = function(){
        Event.init();
        $(document).on('show.cpanel',function(e,dom,type,data){
            if(type == 'mod_actAppointment'){
                Event.resetInfo(dom);
            }
        })
	};

});define("jquery.pp.2014.marketbase",[], function() { return function(jQuery) {
  

(function ($) {
    function LoadTjw(element, options) {
        this.ver = 1.0;
        this.$element = $(element);
        this.options = $.extend({}, $.fn.loadTjw.defaults,options);
        this.init();
    }
    
    LoadTjw.prototype = {
        tjwOptions : null,
        tjwData : null,
        tjwHtml : '',

        /*
         * data-loadtjw
         */        
        _setOptions : function(){
            var tjwSource = this.$element.data('loadtjw-url');
            var tjwId = tjwSource.substring(tjwSource.lastIndexOf('/') + 1,tjwSource.indexOf('.js'));

            this.tjwOptions = {
                tjwSource : tjwSource,
                tjwId : tjwId,
                template : this.$element.data('loadtjw-tpl')
            }
        },

        /*
         * 
         */
        resetPPimgSize: function(i){
            this.tjwData[i].img60x60 = this.tjwData[i].image.replace('200x200','60x60');
            this.tjwData[i].img80x80 = this.tjwData[i].image.replace('200x200','80x80');
            this.tjwData[i].img120x120 = this.tjwData[i].img120x120.replace('200x200','120x120');
            this.tjwData[i].img160x160 = this.tjwData[i].img160x160.replace('200x200','160x160');
            this.tjwData[i].img300x300 = this.tjwData[i].image.replace('200x200','300x300');
        },

        /*
         * 
         */
        renderTpl : function (tpl, data) {
            tpl = tpl.replace(/{#([\w\-]+)\#}/g, function(match, key){
                return typeof data[key] !== undefined ? data[key] : '';
            });
            return tpl;
        },

        /*
         * HTML
         */
        replaceTpl : function(i){
            var template = this.tjwOptions.template;
            this.tjwHtml  += this.renderTpl(this.tjwOptions.template,this.tjwData[i]);

        },

        /*
         * html
         */
        fill : function(){
            if(this.options.fillMode == 'append'){
                this.$element.append(this.tjwHtml);
            }else if(this.options.fillMode == 'fill'){
                this.$element.html(this.tjwHtml);
            }
            if(this.options.renderedCallback !== null  &&  typeof this.options.renderedCallback === 'function'){
                this.options.renderedCallback();
            }
        },

        /*
         * 
         */
        loopData : function(){
            for(var i in this.tjwData){
                if(this.tjwData[i] !== ''){
                    this.resetPPimgSize(i);
                    this.replaceTpl(i);
                }else{
                    this.tjwData.splice(i,1);
                    continue;                    
                }
            }
            this.fill();
        },


        /*
         * 
         */
        getTjwData : function(){
            var that = this;
            $.ajax({  
                type : "GET", 
                url : that.tjwOptions.tjwSource + '?t=' + Date.parse(new Date()),  
                dataType : "jsonp",
                jsonpCallback: that.tjwOptions.tjwId, 
                success : function(data){  
                    that.tjwData = data.data.adList;
                    that.loopData();
                }  
            }); 
        },


        init : function(){

            this._setOptions();
            this.getTjwData();
           
        }
    };

    // JQ
    $.fn.loadTjw = function (options) {
        return this.each(function () {
            var $me = $(this),
                instance = $me.data('loadtjw');
            if(!instance){
                instance = new LoadTjw(this, options);
                $me.data('loadtjw',instance );
            }else{
                instance.init();
            }
            if ($.type(options) === 'string') instance[options]();

        });
    };



    /**
     * 
     */
    $.fn.loadTjw.defaults = {
        fillMode : 'append',
        renderedCallback : null
    };
})(jQuery);


return 'dddd';

/*
 * data-loadtjw
 */
 //$('[data-loadtjw]').loadTjw();



// var lazyLoader = $(document).lazyloader({
//     imgLazyAttr: '_src',
//     moduleLazyAttr: 'data-lazy-mod',
//     threshold: 0,
//     moduleLoadCallback: function(index,$elem){
//         $elem.loadTjw({
//             renderedCallback : function(){
//                 lazyLoader.load();
//             }
//         });
//     }
// }).data('Lazyloader');
    





}});
;define("mmrp_wx.operate",function (require, exports, module) {

    var $ = require('jquery'),
        Fun = require('mmrp.func'),
        localStore = require('mmrp.localstore'),
        RestApi = require('mmrp.rest'),

        //
        BoxCpanel = require('mmrp.module.cpanel'),
        BuildStep = require('mmrp_wx.module.step'),
        ModList = require('mmrp.module.tablist'),
        BoxBuild = require('mmrp.module.build'),

        //
        tab = require('mmrp.mod.tab'),
        tab2 = require('mmrp.mod.fixedtab'),
        fixtabtop = require('mmrp.mod.fixtabtop'),
        goods_list = require('mmrp_wx.mod.goods_list'),
        single_goods = require('mmrp_wx.mod.single_goods_pop_activity'),
        goodslist2 = require('mmrp_wx.mod.goods_list_pop_activity'),
        coupons = require('mmrp.mod.coupons'),
        couponspop = require('mmrp.mod.couponspop'),
        countdown = require('mmrp.mod.countdown'),
        yuyue = require('mmrp.mod.yuyue');

    require('jquery.pp.2014.marketbase')($);
    require('jquery.browser')($);


    var msg = {
        power_error_edit: '',
        'retry': ''
    };


    /**
     * page
     */
    var initPage = function () {
        var page_id = Fun.getUrlParam("id") || Fun.getUrlParam("pageId");
        if (page_id) {
            $.when(Fun.init(),
                RestApi.getPageById(page_id).success(function (data) {
                    if (data.errorCode == 3) {
                        alert(msg.power_error_edit);
                        window.location.href = "//wqs.jd.com/weidian/index.shtml";
                        return;
                    }else if(data.errorCode==1){
                        alert(data.errorMsg);
                        window.location.href = "//wqs.jd.com/weidian/index.shtml";
                        return;
                    } else if(data.errorCode){
                        alert(msg.retry);
                        return;
                    } else if(data.data.value.page_state==2){
                        alert("");
                        setTimeout(function(){
                            Fun.alertLoading("",15000);
                        },2000);
                    }

                    var value = data.data.value;
                    if(value.page_name){
                        localStore.setPageDataById(page_id, data);
                    }

                    Fun.setUrlParam('theme_id', data.data.value.page_theme);
                    Fun.setUrlParam('template_id', data.data.value.page_template);
                    Fun.setUrlParam('layout_id', data.data.value.page_layout);
                    window.__materiaid = parseInt(Fun.getUrlParam('materiaId')) || parseInt(data.data.value.page_materiaid);
                    //
                    checkEditPower(data.data.value.page_creator, data.data.value.page_authorizer);
                })
            ).done(initOther);
        }else{
            Fun.init().done(initOther);
            window.__materiaid = parseInt(Fun.getUrlParam('materiaId'));
        }
    };

    /**
     * 
     * page_user_name:
     */
    var checkEditPower = function (page_user_name, page_authorizer) {
        var req = Fun.checkPower();
        req.success(function (p_data) {
            var user_power = parseInt(p_data.user_power, 10),
                login_name = p_data.login_name,
                c_author = Fun.checkAuthorizer(page_authorizer);
            //    
//      console.info(user_power,login_name,page_user_name,c_author)
            if (user_power <= 10 && login_name != page_user_name && !c_author) {
                alert(msg.power_error_edit);
                window.location.href = "great_tp.htm";
            }//if


        });//getUserPower
    };

    /**
     * 
     */
    var initOther = function(){
        //()
        BuildStep.init();
        //
        ModList.init();
        //
        BoxCpanel.init();
        // 
        BoxBuild.init();


        countdown.init();
        //
        tab.init();
        tab2.init();
        fixtabtop.init();

        goods_list.init();
        goodslist2.init();
        single_goods.init();
        coupons.init();
        couponspop.init();
        yuyue.init();
    }

    exports.init = function () {

        //Fun.initGlobal();
        initPage();
        JD.report.umpBiz({bizid: '65', operation: 4, result: '0', source: '0', message: "JDCJS"});
        window.onerror=function(){
            //Fun.alertLoading("very sorry, some error happened");
        }
    };
})